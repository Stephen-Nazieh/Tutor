;!function(){try { var e="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof global?global:"undefined"!=typeof window?window:"undefined"!=typeof self?self:{},n=(new e.Error).stack;n&&((e._debugIds|| (e._debugIds={}))[n]="891c1b1a-2a4d-7757-1bea-f1d7b454a9b2")}catch(e){}}();
module.exports=[687416,e=>e.a(async(t,r)=>{try{var n=e.i(620971),a=e.i(384030),i=e.i(738597);e.i(688768);var l=e.i(257357),s=e.i(909105),u=e.i(997103),o=e.i(841195),c=e.i(75835),d=t([a,i]);[a,i]=d.then?(await d)():d;let p=o.z.enum(["LESSON","CLINIC","CONSULTATION","BREAK","PERSONAL","OTHER"]);o.z.enum(["CONFIRMED","TENTATIVE","CANCELLED"]);let h=o.z.object({title:o.z.string().min(1),description:o.z.string().optional(),type:p.default("LESSON"),startTime:o.z.string().datetime(),endTime:o.z.string().datetime(),timezone:o.z.string().default("Asia/Shanghai"),isAllDay:o.z.boolean().default(!1),location:o.z.string().optional(),meetingUrl:o.z.string().optional(),isVirtual:o.z.boolean().default(!1),curriculumId:o.z.string().optional(),batchId:o.z.string().optional(),studentId:o.z.string().optional(),maxAttendees:o.z.number().min(1).default(1),attendees:o.z.array(o.z.object({userId:o.z.string().optional(),email:o.z.string(),name:o.z.string(),status:o.z.enum(["pending","accepted","declined"]).default("pending")})).default([]),reminders:o.z.array(o.z.object({minutes:o.z.number(),type:o.z.enum(["email","push","sms"])})).default([{minutes:15,type:"email"}]),color:o.z.string().optional(),recurrenceRule:o.z.string().optional()}),v=(0,a.withAuth)(async(e,t)=>{let r=t.user.id,{searchParams:a}=new URL(e.url),o=a.get("start"),c=a.get("end"),d=a.get("type"),m="true"===a.get("includeCancelled"),p=parseInt(a.get("limit")||"100",10);if(!o||!c)return n.NextResponse.json({error:"Start and end dates are required"},{status:400});let h=new Date(o),v=new Date(c);if(isNaN(h.getTime())||isNaN(v.getTime()))return n.NextResponse.json({error:"Invalid date format"},{status:400});try{let e=(0,s.or)((0,s.and)((0,s.gte)(l.calendarEvent.startTime,h),(0,s.lte)(l.calendarEvent.startTime,v)),(0,s.and)((0,s.gte)(l.calendarEvent.endTime,h),(0,s.lte)(l.calendarEvent.endTime,v)),(0,s.and)((0,s.lte)(l.calendarEvent.startTime,h),(0,s.gte)(l.calendarEvent.endTime,v))),t=[(0,s.eq)(l.calendarEvent.tutorId,r),(0,s.isNull)(l.calendarEvent.deletedAt),e];m||t.push((0,s.eq)(l.calendarEvent.isCancelled,!1)),d&&t.push((0,s.eq)(l.calendarEvent.type,d));let a=(await i.drizzleDb.select({event:l.calendarEvent,curriculumId:l.curriculum.id,curriculumName:l.curriculum.name,curriculumSubject:l.curriculum.subject,batchId:l.courseBatch.id,batchName:l.courseBatch.name}).from(l.calendarEvent).leftJoin(l.curriculum,(0,s.eq)(l.calendarEvent.curriculumId,l.curriculum.id)).leftJoin(l.courseBatch,(0,s.eq)(l.calendarEvent.batchId,l.courseBatch.id)).where((0,s.and)(...t)).orderBy((0,u.asc)(l.calendarEvent.startTime)).limit(p)).map(e=>({...e.event,curriculum:e.curriculumId?{id:e.curriculumId,name:e.curriculumName,subject:e.curriculumSubject}:null,batch:e.batchId?{id:e.batchId,name:e.batchName}:null})),g=function(e,t,r){let n=[];for(let a of e){if(!a.recurrenceRule||a.recurringEventId){n.push(a);continue}let e=function(e,t){let r={};return e.split(";").forEach(e=>{let[t,n]=e.split("=");t&&n&&(r[t]=n)}),{freq:r.FREQ||"DAILY",interval:parseInt(r.INTERVAL||"1",10),until:r.UNTIL?new Date(r.UNTIL):null,count:r.COUNT?parseInt(r.COUNT,10):null,byday:r.BYDAY?.split(","),dtstart:t}}(a.recurrenceRule,a.startTime),i=function(e,t,r,n){let a=[],i=new Date(e.dtstart),l=0,s=e.count||365;for(;i<=n&&l<s;){if(i>=r){let e=new Date(t.endTime).getTime()-new Date(t.startTime).getTime(),r=new Date(i.getTime()+e);a.push({...t,id:`${t.id}-${i.toISOString()}`,startTime:i,endTime:r,isOccurrence:!0,recurringEventId:t.id})}if(i=function(e,t,r){let n=new Date(e);switch(t){case"DAILY":default:n.setDate(n.getDate()+r);break;case"WEEKLY":n.setDate(n.getDate()+7*r);break;case"MONTHLY":n.setMonth(n.getMonth()+r)}return n}(i,e.freq,e.interval),l++,e.until&&i>e.until)break}return a}(e,a,t,r);n.push(...i)}return n}(a,h,v);return n.NextResponse.json({events:g,count:g.length,range:{start:o,end:c}})}catch(e){return console.error("Fetch calendar events error:",e),n.NextResponse.json({error:"Failed to fetch events"},{status:500})}},{role:"TUTOR"}),g=(0,a.withAuth)(async(e,t)=>{let r=t.user.id;try{let t=await e.json(),a=h.safeParse(t);if(!a.success)return n.NextResponse.json({error:"Invalid request",details:a.error.format()},{status:400});let u=a.data,o=new Date(u.startTime),d=new Date(u.endTime);if(d<=o)return n.NextResponse.json({error:"End time must be after start time"},{status:400});if("PERSONAL"!==u.type){let e=await i.drizzleDb.select().from(l.calendarEvent).where((0,s.and)((0,s.eq)(l.calendarEvent.tutorId,r),(0,s.isNull)(l.calendarEvent.deletedAt),(0,s.eq)(l.calendarEvent.isCancelled,!1),(0,s.lt)(l.calendarEvent.startTime,d),(0,s.gt)(l.calendarEvent.endTime,o)));if(e.length>0)return n.NextResponse.json({error:"Schedule conflict detected",conflicts:e.map(e=>({id:e.id,title:e.title,startTime:e.startTime,endTime:e.endTime}))},{status:409})}let[p]=await i.drizzleDb.insert(l.calendarEvent).values({id:(0,c.nanoid)(),tutorId:r,title:u.title,description:u.description,type:u.type,status:"CONFIRMED",startTime:o,endTime:d,timezone:u.timezone,isAllDay:u.isAllDay,location:u.location,meetingUrl:u.meetingUrl,isVirtual:u.isVirtual,curriculumId:u.curriculumId,batchId:u.batchId,studentId:u.studentId,maxAttendees:u.maxAttendees,attendees:u.attendees,reminders:u.reminders,color:u.color,recurrenceRule:u.recurrenceRule,isRecurring:!!u.recurrenceRule,createdBy:"manual",isCancelled:!1}).returning();p.id;let[v]=u.curriculumId?await i.drizzleDb.select({id:l.curriculum.id,name:l.curriculum.name,subject:l.curriculum.subject}).from(l.curriculum).where((0,s.eq)(l.curriculum.id,u.curriculumId)).limit(1):[null],[g]=u.batchId?await i.drizzleDb.select({id:l.courseBatch.id,name:l.courseBatch.name}).from(l.courseBatch).where((0,s.eq)(l.courseBatch.id,u.batchId)).limit(1):[null],R={...p,curriculum:v?{id:v.id,name:v.name,subject:v.subject}:null,batch:g?{id:g.id,name:g.name}:null};return m({...R,reminders:R.reminders??[]},r).catch(console.error),n.NextResponse.json({event:R},{status:201})}catch(e){return console.error("Create calendar event error:",e),n.NextResponse.json({error:"Failed to create event"},{status:500})}},{role:"TUTOR"});async function m(e,t){for(let r of e.reminders||[]){let n=new Date(e.startTime.getTime()-6e4*r.minutes);n>new Date&&await i.drizzleDb.insert(l.notification).values({id:(0,c.nanoid)(),userId:t,type:"reminder",title:`Reminder: ${e.title}`,message:`Starting in ${r.minutes} minutes`,actionUrl:`/tutor/calendar?event=${e.id}`,data:{eventId:e.id,reminderMinutes:r.minutes,scheduledFor:n.toISOString()},read:!1})}}e.s(["GET",0,v,"POST",0,g]),r()}catch(e){r(e)}},!1),508508,e=>e.a(async(t,r)=>{try{var n=e.i(78315),a=e.i(586961),i=e.i(196657),l=e.i(899733),s=e.i(233979),u=e.i(631683),o=e.i(840960),c=e.i(711373),d=e.i(699699),m=e.i(521140),p=e.i(205260),h=e.i(500249),v=e.i(431740),g=e.i(82608),R=e.i(635207),f=e.i(193695);e.i(708038);var E=e.i(447430),T=e.i(687416),w=t([T]);[T]=w.then?(await w)():w;let N=new n.AppRouteRouteModule({definition:{kind:a.RouteKind.APP_ROUTE,page:"/api/tutor/calendar/events/route",pathname:"/api/tutor/calendar/events",filename:"route",bundlePath:""},distDir:".next",relativeProjectDir:"",resolvedPagePath:"[project]/ADK_WORKSPACE/TutorMekimi/tutorme-app/src/app/api/tutor/calendar/events/route.ts",nextConfigOutput:"",userland:T}),{workAsyncStorage:y,workUnitAsyncStorage:A,serverHooks:C}=N;function I(){return(0,i.patchFetch)({workAsyncStorage:y,workUnitAsyncStorage:A})}async function b(e,t,r){N.isDev&&(0,l.addRequestMeta)(e,"devRequestTimingInternalsEnd",process.hrtime.bigint());let n="/api/tutor/calendar/events/route";n=n.replace(/\/index$/,"")||"/";let i=await N.prepare(e,t,{srcPage:n,multiZoneDraftMode:!1});if(!i)return t.statusCode=400,t.end("Bad Request"),null==r.waitUntil||r.waitUntil.call(r,Promise.resolve()),null;let{buildId:T,params:w,nextConfig:I,parsedUrl:b,isDraftMode:y,prerenderManifest:A,routerServerContext:C,isOnDemandRevalidate:D,revalidateOnlyGenerated:z,resolvedPathname:x,clientReferenceManifest:O,serverActionsManifest:S}=i,j=(0,o.normalizeAppPath)(n),P=!!(A.dynamicRoutes[j]||A.routes[x]),U=async()=>((null==C?void 0:C.render404)?await C.render404(e,t,b,!1):t.end("This page could not be found"),null);if(P&&!y){let e=!!A.routes[x],t=A.dynamicRoutes[j];if(t&&!1===t.fallback&&!e){if(I.experimental.adapterPath)return await U();throw new f.NoFallbackError}}let q=null;!P||N.isDev||y||(q=x,q="/index"===q?"/":q);let L=!0===N.isDev||!P,_=P&&!L;S&&O&&(0,u.setManifestsSingleton)({page:n,clientReferenceManifest:O,serverActionsManifest:S});let H=e.method||"GET",M=(0,s.getTracer)(),k=M.getActiveScopeSpan(),B={params:w,prerenderManifest:A,renderOpts:{experimental:{authInterrupts:!!I.experimental.authInterrupts},cacheComponents:!!I.cacheComponents,supportsDynamicResponse:L,incrementalCache:(0,l.getRequestMeta)(e,"incrementalCache"),cacheLifeProfiles:I.cacheLife,waitUntil:r.waitUntil,onClose:e=>{t.on("close",e)},onAfterTaskError:void 0,onInstrumentationRequestError:(t,r,n,a)=>N.onRequestError(e,t,n,a,C)},sharedContext:{buildId:T}},F=new c.NodeNextRequest(e),$=new c.NodeNextResponse(t),K=d.NextRequestAdapter.fromNodeNextRequest(F,(0,d.signalFromNodeResponse)(t));try{let i=async e=>N.handle(K,B).finally(()=>{if(!e)return;e.setAttributes({"http.status_code":t.statusCode,"next.rsc":!1});let r=M.getRootSpanAttributes();if(!r)return;if(r.get("next.span_type")!==m.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${r.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let a=r.get("next.route");if(a){let t=`${H} ${a}`;e.setAttributes({"next.route":a,"http.route":a,"next.span_name":t}),e.updateName(t)}else e.updateName(`${H} ${n}`)}),u=!!(0,l.getRequestMeta)(e,"minimalMode"),o=async l=>{var s,o;let c=async({previousCacheEntry:a})=>{try{if(!u&&D&&z&&!a)return t.statusCode=404,t.setHeader("x-nextjs-cache","REVALIDATED"),t.end("This page could not be found"),null;let n=await i(l);e.fetchMetrics=B.renderOpts.fetchMetrics;let s=B.renderOpts.pendingWaitUntil;s&&r.waitUntil&&(r.waitUntil(s),s=void 0);let o=B.renderOpts.collectedTags;if(!P)return await (0,h.sendResponse)(F,$,n,B.renderOpts.pendingWaitUntil),null;{let e=await n.blob(),t=(0,v.toNodeOutgoingHttpHeaders)(n.headers);o&&(t[R.NEXT_CACHE_TAGS_HEADER]=o),!t["content-type"]&&e.type&&(t["content-type"]=e.type);let r=void 0!==B.renderOpts.collectedRevalidate&&!(B.renderOpts.collectedRevalidate>=R.INFINITE_CACHE)&&B.renderOpts.collectedRevalidate,a=void 0===B.renderOpts.collectedExpire||B.renderOpts.collectedExpire>=R.INFINITE_CACHE?void 0:B.renderOpts.collectedExpire;return{value:{kind:E.CachedRouteKind.APP_ROUTE,status:n.status,body:Buffer.from(await e.arrayBuffer()),headers:t},cacheControl:{revalidate:r,expire:a}}}}catch(t){throw(null==a?void 0:a.isStale)&&await N.onRequestError(e,t,{routerKind:"App Router",routePath:n,routeType:"route",revalidateReason:(0,p.getRevalidateReason)({isStaticGeneration:_,isOnDemandRevalidate:D})},!1,C),t}},d=await N.handleResponse({req:e,nextConfig:I,cacheKey:q,routeKind:a.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:A,isRoutePPREnabled:!1,isOnDemandRevalidate:D,revalidateOnlyGenerated:z,responseGenerator:c,waitUntil:r.waitUntil,isMinimalMode:u});if(!P)return null;if((null==d||null==(s=d.value)?void 0:s.kind)!==E.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==d||null==(o=d.value)?void 0:o.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});u||t.setHeader("x-nextjs-cache",D?"REVALIDATED":d.isMiss?"MISS":d.isStale?"STALE":"HIT"),y&&t.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let m=(0,v.fromNodeOutgoingHttpHeaders)(d.value.headers);return u&&P||m.delete(R.NEXT_CACHE_TAGS_HEADER),!d.cacheControl||t.getHeader("Cache-Control")||m.get("Cache-Control")||m.set("Cache-Control",(0,g.getCacheControlHeader)(d.cacheControl)),await (0,h.sendResponse)(F,$,new Response(d.value.body,{headers:m,status:d.value.status||200})),null};k?await o(k):await M.withPropagatedContext(e.headers,()=>M.trace(m.BaseServerSpan.handleRequest,{spanName:`${H} ${n}`,kind:s.SpanKind.SERVER,attributes:{"http.method":H,"http.target":e.url}},o))}catch(t){if(t instanceof f.NoFallbackError||await N.onRequestError(e,t,{routerKind:"App Router",routePath:j,routeType:"route",revalidateReason:(0,p.getRevalidateReason)({isStaticGeneration:_,isOnDemandRevalidate:D})},!1,C),P)throw t;return await (0,h.sendResponse)(F,$,new Response(null,{status:500})),null}}e.s(["handler",()=>b,"patchFetch",()=>I,"routeModule",()=>N,"serverHooks",()=>C,"workAsyncStorage",()=>y,"workUnitAsyncStorage",()=>A]),r()}catch(e){r(e)}},!1)];

//# debugId=891c1b1a-2a4d-7757-1bea-f1d7b454a9b2
//# sourceMappingURL=ADK_WORKSPACE_TutorMekimi_tutorme-app_7ecf789f._.js.map