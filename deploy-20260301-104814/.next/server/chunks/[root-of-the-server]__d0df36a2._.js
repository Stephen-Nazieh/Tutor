;!function(){try { var e="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof global?global:"undefined"!=typeof window?window:"undefined"!=typeof self?self:{},n=(new e.Error).stack;n&&((e._debugIds|| (e._debugIds={}))[n]="f28a53e3-ecf3-79ca-d3fd-ebee0b3ab353")}catch(e){}}();
module.exports=[329308,e=>e.a(async(t,i)=>{try{var r=e.i(254799),a=e.i(738597);e.i(688768);var s=e.i(257357),n=t([a]);async function o(e,t,i){try{await a.drizzleDb.insert(s.userActivityLog).values({id:r.default.randomUUID(),userId:e,action:t,metadata:i??{}})}catch(e){console.error("Failed to log activity:",e)}}[a]=n.then?(await n)():n,e.s(["logActivity",()=>o]),i()}catch(e){i(e)}},!1),505589,e=>{"use strict";e.s(["XP_LEVELS",0,{1:0,2:200,3:500,4:1e3,5:1800,6:3e3,7:4600,8:6600,9:9100,10:12100,11:15600,12:19600,13:24100,14:29100,15:34600,16:40600,17:47100,18:54100,19:61600,20:69600},"XP_REWARDS",0,{COMPLETE_MISSION:50,PERFECT_QUIZ:20,DAILY_LOGIN:10,STREAK_3_DAYS:50,STREAK_7_DAYS:150,STREAK_30_DAYS:500,SPEAKING_PRACTICE:30,AI_CONVERSATION:40,COMPLETE_LESSON:40,FIRST_MISSION:100}])},977762,e=>e.a(async(t,i)=>{try{var r=e.i(254799),a=e.i(909105),s=e.i(738597);e.i(688768);var n=e.i(257357),o=e.i(329308),l=e.i(505589),c=t([s,o]);async function d(e){let[t]=await s.drizzleDb.select().from(n.userGamification).where((0,a.eq)(n.userGamification.userId,e)).limit(1);if(t)return t;let[i]=await s.drizzleDb.insert(n.userGamification).values({id:r.default.randomUUID(),userId:e,level:1,xp:0,streakDays:0,longestStreak:0,totalStudyMinutes:0,grammarScore:0,vocabularyScore:0,speakingScore:0,listeningScore:0,confidenceScore:0,fluencyScore:0,unlockedWorlds:[]}).returning();if(!i)throw Error("Failed to create user gamification");return i}async function u(e,t,i,r){let c=await d(e),u=c.xp+t,m=function(e){let t=1;for(let i=1;i<=20;i++)if(e>=l.XP_LEVELS[i])t=i;else break;return t}(u),p=m>c.level,[f]=await s.drizzleDb.update(n.userGamification).set({xp:u,level:m}).where((0,a.eq)(n.userGamification.userId,e)).returning();if(!f)throw Error("Failed to update gamification");return await (0,o.logActivity)(e,"XP_EARNED",{amount:t,source:i,newTotal:u,leveledUp:p,...r}),{...f,xpEarned:t,leveledUp:p,previousLevel:c.level}}async function m(e){let t=await d(e),i=new Date;i.setHours(0,0,0,0);let r=t.lastActiveDate?new Date(t.lastActiveDate):null,c=t.streakDays,u=0,m=!1,p=!1;if(r){r.setHours(0,0,0,0);let e=Math.floor((i.getTime()-r.getTime())/864e5);1===e?(c+=1,m=!0,3===c?u=l.XP_REWARDS.STREAK_3_DAYS:7===c?u=l.XP_REWARDS.STREAK_7_DAYS:30===c&&(u=l.XP_REWARDS.STREAK_30_DAYS)):0===e?m=!0:(p=!0,c=1)}else c=1;let f=Math.max(t.longestStreak,c),[g]=await s.drizzleDb.update(n.userGamification).set({streakDays:c,longestStreak:f,lastActiveDate:i}).where((0,a.eq)(n.userGamification.userId,e)).returning();if(!g)throw Error("Failed to update streak");return await (0,o.logActivity)(e,p?"STREAK_BROKEN":"STREAK_UPDATED",{streakDays:c,previousStreak:t.streakDays,streakBroken:p,streakContinued:m}),{...g,streakBonus:u,streakContinued:m,streakBroken:p}}async function p(e){let t=await d(e),i=new Date;i.setHours(0,0,0,0);let r=t.lastActiveDate?new Date(t.lastActiveDate):null;if(!r||r.getTime()!==i.getTime()){let t=await m(e),i=await u(e,l.XP_REWARDS.DAILY_LOGIN,"daily_login");return{firstLoginToday:!0,xpEarned:i.xpEarned+t.streakBonus,streakBonus:t.streakBonus,streakDays:t.streakDays,leveledUp:i.leveledUp}}return{firstLoginToday:!1,streakDays:t.streakDays}}async function f(e,t){let i=await d(e),r=(e,t)=>void 0===t?e:Math.round(.7*e+.3*t),[l]=await s.drizzleDb.update(n.userGamification).set({grammarScore:r(i.grammarScore,t.grammar),vocabularyScore:r(i.vocabularyScore,t.vocabulary),speakingScore:r(i.speakingScore,t.speaking),listeningScore:r(i.listeningScore,t.listening),confidenceScore:r(i.confidenceScore,t.confidence),fluencyScore:r(i.fluencyScore,t.fluency)}).where((0,a.eq)(n.userGamification.userId,e)).returning();if(!l)throw Error("Failed to update skill scores");return t.confidence&&t.confidence>i.confidenceScore+5&&await (0,o.logActivity)(e,"CONFIDENCE_MILESTONE",{previousScore:i.confidenceScore,newScore:l.confidenceScore,delta:l.confidenceScore-i.confidenceScore}),l}async function g(e){var t,i,r;let a,s,n=await d(e),o=(t=n.level,l.XP_LEVELS[t+1]||2*l.XP_LEVELS[20]),c=l.XP_LEVELS[n.level],u=(i=n.xp,r=n.level,a=l.XP_LEVELS[r],s=l.XP_LEVELS[r+1]||2*l.XP_LEVELS[20],Math.min(100,Math.round((i-a)/(s-a)*100)));return{level:n.level,xp:n.xp,nextLevelXp:o,currentLevelXp:c,progress:u,xpToNextLevel:o-n.xp,streakDays:n.streakDays,longestStreak:n.longestStreak,skills:{grammar:n.grammarScore,vocabulary:n.vocabularyScore,speaking:n.speakingScore,listening:n.listeningScore,confidence:n.confidenceScore,fluency:n.fluencyScore},unlockedWorlds:n.unlockedWorlds}}async function v(e,t){return(await d(e)).level>=t}[s,o]=c.then?(await c)():c,e.s(["awardXp",()=>u,"canAccessWorld",()=>v,"checkDailyLogin",()=>p,"getGamificationSummary",()=>g,"getOrCreateGamification",()=>d,"updateSkillScores",()=>f]),i()}catch(e){i(e)}},!1),521552,e=>e.a(async(t,i)=>{try{var r=e.i(254799),a=e.i(909105),s=e.i(320947),n=e.i(738597);e.i(688768);var o=e.i(257357),l=e.i(977762),c=e.i(505589),d=e.i(329308),u=t([n,l,d]);[n,l,d]=u.then?(await u)():u;let w=[{id:"survival",name:"Survival World",emoji:"ðŸŒ",description:"Master everyday English for real-life situations",storyArc:"You have arrived in an English-speaking country. Learn to navigate daily life, from ordering food to asking for directions.",unlockLevel:1,difficultyLevel:1},{id:"workplace",name:"Workplace World",emoji:"ðŸ’¼",description:"Professional English for career advancement",storyArc:"You have started a new job. Navigate meetings, emails, and professional conversations with confidence.",unlockLevel:3,difficultyLevel:2},{id:"daily_life",name:"Daily Life World",emoji:"ðŸ ",description:"Conversations with friends, family, and neighbors",storyArc:"Build relationships and connect with people around you through natural everyday conversations.",unlockLevel:2,difficultyLevel:1},{id:"academic",name:"Academic World",emoji:"ðŸ§ ",description:"Study skills and academic English",storyArc:"Prepare for academic success with essay writing, presentations, and research skills.",unlockLevel:4,difficultyLevel:3},{id:"social",name:"Social & Relationships",emoji:"â¤ï¸",description:"Make friends and build connections",storyArc:"Navigate social situations, from casual hangouts to meaningful conversations and dating.",unlockLevel:3,difficultyLevel:2},{id:"public_speaking",name:"Public Speaking Arena",emoji:"ðŸŽ¤",description:"Speak confidently in front of others",storyArc:"Face your fears and master the art of presenting to groups, large and small.",unlockLevel:5,difficultyLevel:3},{id:"debate",name:"Debate Arena",emoji:"ðŸ†",description:"Advanced argumentation and persuasion",storyArc:"Enter the arena of ideas. Defend your positions and respectfully challenge others.",unlockLevel:8,difficultyLevel:4}];async function m(e){let t=await (0,l.getOrCreateGamification)(e),i=t.unlockedWorlds??[];return w.map(e=>({...e,isUnlocked:i.includes(e.id)||t.level>=e.unlockLevel,canAccess:t.level>=e.unlockLevel,progress:0}))}async function p(e,t){let i=w.find(t=>t.id===e);if(!i)return null;let r=await (0,l.getOrCreateGamification)(t),a=(r.unlockedWorlds??[]).includes(i.id)||r.level>=i.unlockLevel;return{...i,isUnlocked:a,canAccess:r.level>=i.unlockLevel,missions:[]}}async function f(e,t){let[i]=await n.drizzleDb.select().from(o.mission).where((0,a.eq)(o.mission.id,t)).limit(1);if(!i)throw Error("Mission not found");if(!await (0,l.canAccessWorld)(e,1))throw Error("World not unlocked yet");let[s]=await n.drizzleDb.select().from(o.missionProgress).where((0,a.and)((0,a.eq)(o.missionProgress.missionId,t),(0,a.eq)(o.missionProgress.studentId,e))).limit(1);if(s)return s.completed||await (0,d.logActivity)(e,"MISSION_START",{missionId:t}),s;let[c]=await n.drizzleDb.insert(o.missionProgress).values({id:r.default.randomUUID(),missionId:t,studentId:e,progress:0,completed:!1}).returning();if(!c)throw Error("Failed to create mission progress");return await (0,d.logActivity)(e,"MISSION_START",{missionId:t}),c}async function g(e,t,i,s=0){let[u]=await n.drizzleDb.select().from(o.mission).where((0,a.eq)(o.mission.id,t)).limit(1);if(!u)throw Error("Mission not found");let m=u.xpReward;i>=90&&(m+=c.XP_REWARDS.PERFECT_QUIZ);let[p]=await n.drizzleDb.select().from(o.missionProgress).where((0,a.and)((0,a.eq)(o.missionProgress.missionId,t),(0,a.eq)(o.missionProgress.studentId,e))).limit(1);p&&p.completed||(m+=c.XP_REWARDS.FIRST_MISSION);let f=Math.round(i),v=new Date;if(p){let[r]=await n.drizzleDb.update(o.missionProgress).set({progress:f,completed:!0,completedAt:v}).where((0,a.eq)(o.missionProgress.id,p.id)).returning();if(!r)throw Error("Failed to update mission progress");return await (0,l.awardXp)(e,m,"mission_complete",{missionId:t,score:i}),await (0,d.logActivity)(e,"MISSION_COMPLETE",{missionId:t,score:i,xpEarned:m}),{progress:r,xpEarned:m}}let[h]=await n.drizzleDb.insert(o.missionProgress).values({id:r.default.randomUUID(),missionId:t,studentId:e,progress:f,completed:!0,completedAt:v}).returning();if(!h)throw Error("Failed to create mission progress");return await (0,l.awardXp)(e,m,"mission_complete",{missionId:t,score:i}),await (0,d.logActivity)(e,"MISSION_COMPLETE",{missionId:t,score:i,xpEarned:m}),{progress:h,xpEarned:m}}async function v(e){let[t]=await n.drizzleDb.select({count:s.sql`count(*)::int`}).from(o.mission).where((0,a.eq)(o.mission.isActive,!0)),i=t?.count??0,[r]=await n.drizzleDb.select({count:s.sql`count(*)::int`}).from(o.missionProgress).where((0,a.and)((0,a.eq)(o.missionProgress.studentId,e),(0,a.eq)(o.missionProgress.completed,!0))),l=r?.count??0,[c]=await n.drizzleDb.select({count:s.sql`count(*)::int`}).from(o.missionProgress).where((0,a.and)((0,a.eq)(o.missionProgress.studentId,e),(0,a.eq)(o.missionProgress.completed,!1))),d=c?.count??0,u=Math.max(0,i-l-d),m=await n.drizzleDb.select().from(o.missionProgress).where((0,a.eq)(o.missionProgress.studentId,e)),p=50*m.length;return{total:i,completed:l,inProgress:d,notStarted:u,totalXpEarned:p,completionRate:i>0?Math.round(l/i*100):0}}async function h(e){let[t]=await n.drizzleDb.select({mId:o.mission.id,mTitle:o.mission.title,mDescription:o.mission.description,mType:o.mission.type,mXpReward:o.mission.xpReward,mRequirement:o.mission.requirement,mIsActive:o.mission.isActive}).from(o.missionProgress).innerJoin(o.mission,(0,a.eq)(o.mission.id,o.missionProgress.missionId)).where((0,a.and)((0,a.eq)(o.missionProgress.studentId,e),(0,a.eq)(o.missionProgress.completed,!1))).limit(1);if(t)return{id:t.mId,title:t.mTitle,description:t.mDescription,type:t.mType,xpReward:t.mXpReward,requirement:t.mRequirement,isActive:t.mIsActive};let i=(await n.drizzleDb.select({missionId:o.missionProgress.missionId}).from(o.missionProgress).where((0,a.and)((0,a.eq)(o.missionProgress.studentId,e),(0,a.eq)(o.missionProgress.completed,!0)))).map(e=>e.missionId);if(i.length>0){let[e]=await n.drizzleDb.select().from(o.mission).where((0,a.and)((0,a.eq)(o.mission.isActive,!0),(0,a.notInArray)(o.mission.id,i))).limit(1);return e??null}let[r]=await n.drizzleDb.select().from(o.mission).where((0,a.eq)(o.mission.isActive,!0)).limit(1);return r??null}e.s(["completeMission",()=>g,"getMissionSummary",()=>v,"getRecommendedMission",()=>h,"getWorldWithMissions",()=>p,"getWorldsWithStatus",()=>m,"startMission",()=>f]),i()}catch(e){i(e)}},!1),220700,e=>e.a(async(t,i)=>{try{var r=e.i(620971),a=e.i(384030),s=e.i(521552),n=t([a,s]);[a,s]=n.then?(await n)():n;let o=(0,a.withAuth)(async(e,t)=>{let{searchParams:i}=new URL(e.url),a=i.get("id");if(a){let e=await (0,s.getWorldWithMissions)(a,t.user.id);return e?r.NextResponse.json({success:!0,data:e}):r.NextResponse.json({error:"World not found"},{status:404})}let n=await (0,s.getWorldsWithStatus)(t.user.id);return r.NextResponse.json({success:!0,data:n})},{role:"STUDENT"});e.s(["GET",0,o]),i()}catch(e){i(e)}},!1),233672,e=>e.a(async(t,i)=>{try{var r=e.i(78315),a=e.i(586961),s=e.i(196657),n=e.i(899733),o=e.i(233979),l=e.i(631683),c=e.i(840960),d=e.i(711373),u=e.i(699699),m=e.i(521140),p=e.i(205260),f=e.i(500249),g=e.i(431740),v=e.i(82608),h=e.i(635207),w=e.i(193695);e.i(708038);var y=e.i(447430),S=e.i(220700),E=t([S]);[S]=E.then?(await E)():E;let _=new r.AppRouteRouteModule({definition:{kind:a.RouteKind.APP_ROUTE,page:"/api/gamification/worlds/route",pathname:"/api/gamification/worlds",filename:"route",bundlePath:""},distDir:".next",relativeProjectDir:"",resolvedPagePath:"[project]/ADK_WORKSPACE/TutorMekimi/tutorme-app/src/app/api/gamification/worlds/route.ts",nextConfigOutput:"",userland:S}),{workAsyncStorage:D,workUnitAsyncStorage:P,serverHooks:k}=_;function R(){return(0,s.patchFetch)({workAsyncStorage:D,workUnitAsyncStorage:P})}async function A(e,t,i){_.isDev&&(0,n.addRequestMeta)(e,"devRequestTimingInternalsEnd",process.hrtime.bigint());let r="/api/gamification/worlds/route";r=r.replace(/\/index$/,"")||"/";let s=await _.prepare(e,t,{srcPage:r,multiZoneDraftMode:!1});if(!s)return t.statusCode=400,t.end("Bad Request"),null==i.waitUntil||i.waitUntil.call(i,Promise.resolve()),null;let{buildId:S,params:E,nextConfig:R,parsedUrl:A,isDraftMode:D,prerenderManifest:P,routerServerContext:k,isOnDemandRevalidate:I,revalidateOnlyGenerated:T,resolvedPathname:b,clientReferenceManifest:L,serverActionsManifest:x}=s,C=(0,c.normalizeAppPath)(r),N=!!(P.dynamicRoutes[C]||P.routes[b]),M=async()=>((null==k?void 0:k.render404)?await k.render404(e,t,A,!1):t.end("This page could not be found"),null);if(N&&!D){let e=!!P.routes[b],t=P.dynamicRoutes[C];if(t&&!1===t.fallback&&!e){if(R.experimental.adapterPath)return await M();throw new w.NoFallbackError}}let q=null;!N||_.isDev||D||(q=b,q="/index"===q?"/":q);let O=!0===_.isDev||!N,z=N&&!O;x&&L&&(0,l.setManifestsSingleton)({page:r,clientReferenceManifest:L,serverActionsManifest:x});let W=e.method||"GET",U=(0,o.getTracer)(),X=U.getActiveScopeSpan(),F={params:E,prerenderManifest:P,renderOpts:{experimental:{authInterrupts:!!R.experimental.authInterrupts},cacheComponents:!!R.cacheComponents,supportsDynamicResponse:O,incrementalCache:(0,n.getRequestMeta)(e,"incrementalCache"),cacheLifeProfiles:R.cacheLife,waitUntil:i.waitUntil,onClose:e=>{t.on("close",e)},onAfterTaskError:void 0,onInstrumentationRequestError:(t,i,r,a)=>_.onRequestError(e,t,r,a,k)},sharedContext:{buildId:S}},K=new d.NodeNextRequest(e),j=new d.NodeNextResponse(t),G=u.NextRequestAdapter.fromNodeNextRequest(K,(0,u.signalFromNodeResponse)(t));try{let s=async e=>_.handle(G,F).finally(()=>{if(!e)return;e.setAttributes({"http.status_code":t.statusCode,"next.rsc":!1});let i=U.getRootSpanAttributes();if(!i)return;if(i.get("next.span_type")!==m.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${i.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let a=i.get("next.route");if(a){let t=`${W} ${a}`;e.setAttributes({"next.route":a,"http.route":a,"next.span_name":t}),e.updateName(t)}else e.updateName(`${W} ${r}`)}),l=!!(0,n.getRequestMeta)(e,"minimalMode"),c=async n=>{var o,c;let d=async({previousCacheEntry:a})=>{try{if(!l&&I&&T&&!a)return t.statusCode=404,t.setHeader("x-nextjs-cache","REVALIDATED"),t.end("This page could not be found"),null;let r=await s(n);e.fetchMetrics=F.renderOpts.fetchMetrics;let o=F.renderOpts.pendingWaitUntil;o&&i.waitUntil&&(i.waitUntil(o),o=void 0);let c=F.renderOpts.collectedTags;if(!N)return await (0,f.sendResponse)(K,j,r,F.renderOpts.pendingWaitUntil),null;{let e=await r.blob(),t=(0,g.toNodeOutgoingHttpHeaders)(r.headers);c&&(t[h.NEXT_CACHE_TAGS_HEADER]=c),!t["content-type"]&&e.type&&(t["content-type"]=e.type);let i=void 0!==F.renderOpts.collectedRevalidate&&!(F.renderOpts.collectedRevalidate>=h.INFINITE_CACHE)&&F.renderOpts.collectedRevalidate,a=void 0===F.renderOpts.collectedExpire||F.renderOpts.collectedExpire>=h.INFINITE_CACHE?void 0:F.renderOpts.collectedExpire;return{value:{kind:y.CachedRouteKind.APP_ROUTE,status:r.status,body:Buffer.from(await e.arrayBuffer()),headers:t},cacheControl:{revalidate:i,expire:a}}}}catch(t){throw(null==a?void 0:a.isStale)&&await _.onRequestError(e,t,{routerKind:"App Router",routePath:r,routeType:"route",revalidateReason:(0,p.getRevalidateReason)({isStaticGeneration:z,isOnDemandRevalidate:I})},!1,k),t}},u=await _.handleResponse({req:e,nextConfig:R,cacheKey:q,routeKind:a.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:P,isRoutePPREnabled:!1,isOnDemandRevalidate:I,revalidateOnlyGenerated:T,responseGenerator:d,waitUntil:i.waitUntil,isMinimalMode:l});if(!N)return null;if((null==u||null==(o=u.value)?void 0:o.kind)!==y.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==u||null==(c=u.value)?void 0:c.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});l||t.setHeader("x-nextjs-cache",I?"REVALIDATED":u.isMiss?"MISS":u.isStale?"STALE":"HIT"),D&&t.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let m=(0,g.fromNodeOutgoingHttpHeaders)(u.value.headers);return l&&N||m.delete(h.NEXT_CACHE_TAGS_HEADER),!u.cacheControl||t.getHeader("Cache-Control")||m.get("Cache-Control")||m.set("Cache-Control",(0,v.getCacheControlHeader)(u.cacheControl)),await (0,f.sendResponse)(K,j,new Response(u.value.body,{headers:m,status:u.value.status||200})),null};X?await c(X):await U.withPropagatedContext(e.headers,()=>U.trace(m.BaseServerSpan.handleRequest,{spanName:`${W} ${r}`,kind:o.SpanKind.SERVER,attributes:{"http.method":W,"http.target":e.url}},c))}catch(t){if(t instanceof w.NoFallbackError||await _.onRequestError(e,t,{routerKind:"App Router",routePath:C,routeType:"route",revalidateReason:(0,p.getRevalidateReason)({isStaticGeneration:z,isOnDemandRevalidate:I})},!1,k),N)throw t;return await (0,f.sendResponse)(K,j,new Response(null,{status:500})),null}}e.s(["handler",()=>A,"patchFetch",()=>R,"routeModule",()=>_,"serverHooks",()=>k,"workAsyncStorage",()=>D,"workUnitAsyncStorage",()=>P]),i()}catch(e){i(e)}},!1),412171,e=>{e.v(t=>Promise.all(["server/chunks/b1c00_TutorMekimi_tutorme-app_src_lib_security_suspicious-activity_ts_7865686f._.js"].map(t=>e.l(t))).then(()=>t(145830)))},443460,e=>{e.v(t=>Promise.all(["server/chunks/[externals]_ioredis_c74819ca._.js"].map(t=>e.l(t))).then(()=>t(693545)))},571363,e=>{e.v(t=>Promise.all(["server/chunks/ADK_WORKSPACE_TutorMekimi_tutorme-app_src_lib_security_api-key_ts_45091e81._.js"].map(t=>e.l(t))).then(()=>t(175922)))}];

//# debugId=f28a53e3-ecf3-79ca-d3fd-ebee0b3ab353
//# sourceMappingURL=%5Broot-of-the-server%5D__d0df36a2._.js.map