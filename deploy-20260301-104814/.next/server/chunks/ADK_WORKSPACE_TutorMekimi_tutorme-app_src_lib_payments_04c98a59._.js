;!function(){try { var e="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof global?global:"undefined"!=typeof window?window:"undefined"!=typeof self?self:{},n=(new e.Error).stack;n&&((e._debugIds|| (e._debugIds={}))[n]="7df8ee69-dfa9-a504-8c63-3622aa7a4260")}catch(e){}}();
module.exports=[775002,e=>{"use strict";process.env.UNIONPAY_DOMAIN,process.env.UNIONPAY_MERCHANT_ID;let t={WECHAT_PAY_INVALID_CONFIG:"微信支付配置错误，请联系客服",WECHAT_PAY_SIGN_FAILED:"微信支付签名验证失败",WECHAT_PAY_ORDER_FAILED:"微信支付下单失败，请稍后重试",WECHAT_PAY_QR_EXPIRED:"支付二维码已过期，请刷新后重试",WECHAT_PAY_USER_CANCEL:"用户已取消支付",ALIPAY_INVALID_CONFIG:"支付宝配置错误，请联系客服",ALIPAY_SIGN_FAILED:"支付宝签名验证失败",ALIPAY_ORDER_FAILED:"支付宝下单失败，请稍后重试",ALIPAY_USER_CANCEL:"用户已取消支付",UNIONPAY_INVALID_CONFIG:"银联支付配置错误，请联系客服",UNIONPAY_ORDER_FAILED:"银联支付下单失败，请稍后重试",BANK_TRANSFER_INVALID:"银行转账信息无效",BANK_TRANSFER_PENDING:"银行转账处理中，请等待到账",PAYMENT_TIMEOUT:"支付超时，请重试",PAYMENT_AMOUNT_INVALID:"支付金额无效",PAYMENT_NETWORK_ERROR:"网络异常，请检查网络后重试",PAYMENT_SYSTEM_ERROR:"支付系统繁忙，请稍后重试",FRAUD_DETECTION:"交易存在风险，请联系客服核实",MFA_REQUIRED:"需要二次验证以完成支付"};function r(e,r){return t[e]??r??t.PAYMENT_SYSTEM_ERROR}function n(e){return"number"==typeof e&&e>=.01&&e<1e6}function a(e){return Math.round(100*e)}function s(e){return e.toFixed(2)}e.s(["CHINESE_CURRENCY",0,"CNY","CHINESE_TIMEZONE",0,"Asia/Shanghai","cnyToFen",()=>a,"formatAlipayAmount",()=>s,"getChineseErrorMessage",()=>r,"isValidChineseAmount",()=>n])},232868,e=>{"use strict";var t=e.i(254799),r=e.i(775002);let n={APP_ID:process.env.WECHAT_APP_ID,MCH_ID:process.env.WECHAT_MCH_ID,DOMAIN:"https://api.mch.weixin.qq.com",SANDBOX_DOMAIN:"https://api.mch.weixin.qq.com",CURRENCY:"CNY",COUNTRY:"CN"};function a(){return"sandbox"===(process.env.WECHAT_PAY_ENV||"production")?n.SANDBOX_DOMAIN:n.DOMAIN}function s(){let e=process.env.WECHAT_PAY_PRIVATE_KEY;if(!e)throw Error((0,r.getChineseErrorMessage)("WECHAT_PAY_INVALID_CONFIG"));return e.replace(/\\n/g,"\n")}function o(e,r,a,s){let o=Math.floor(Date.now()/1e3).toString(),i=t.default.randomBytes(16).toString("hex"),u=`${e}
${r}
${o}
${i}
${a}
`,c=t.default.createSign("RSA-SHA256").update(u).sign(s,"base64");return`WECHATPAY2-SHA256-RSA2048 mchid="${n.MCH_ID}",nonce_str="${i}",timestamp="${o}",signature="${c}"`}class i{async createPayment(e){let t=n.APP_ID,i=n.MCH_ID;if(!t||!i)throw Error((0,r.getChineseErrorMessage)("WECHAT_PAY_INVALID_CONFIG"));let u=e.amount;if(!(0,r.isValidChineseAmount)(u))throw Error((0,r.getChineseErrorMessage)("PAYMENT_AMOUNT_INVALID"));let c=`T${Date.now()}${Math.random().toString(36).slice(2,9)}`,d=process.env.WECHAT_PAY_NOTIFY_URL||"http://localhost:3003/api/payments/webhooks/wechat-pay",l={appid:t,mchid:i,description:e.description.slice(0,127),out_trade_no:c,notify_url:d,amount:{total:(0,r.cnyToFen)(u),currency:e.currency||r.CHINESE_CURRENCY}},p="/v3/pay/transactions/native",_=`${a()}${p}`,A=JSON.stringify(l),E=o("POST",p,A,s()),f=Date.now(),I=await fetch(_,{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json","User-Agent":"TutorMe-WeChatPay/1.0",Authorization:E},body:A});if(Date.now()-f>2e3)throw Error((0,r.getChineseErrorMessage)("PAYMENT_TIMEOUT"));let y=await I.json();if(!I.ok||y.errcode||y.error_code){let e=y.errmsg||y.errcode||`HTTP ${I.status}`;throw Error((0,r.getChineseErrorMessage)("WECHAT_PAY_ORDER_FAILED",e))}let h=y.code_url;if(!h)throw Error((0,r.getChineseErrorMessage)("WECHAT_PAY_ORDER_FAILED"));return{paymentId:c,checkoutUrl:h,status:"CREATED"}}verifyWebhook(e,r){let n="object"==typeof e&&null!==e&&"headers"in e?e.headers:null,a="object"==typeof e&&null!==e&&"rawBody"in e?e.rawBody:"string"==typeof e?e:JSON.stringify(e),s=n?.["wechatpay-signature"]??r;n?.["wechatpay-timestamp"],n?.["wechatpay-nonce"];let o=s.match(/timestamp="([^"]+)",nonce="([^"]+)",signature="([^"]+)"/);if(!o)return!1;let[,i,u,c]=o,d=process.env.WECHAT_PAY_PLATFORM_PUBLIC_KEY;if(!d)return!0;let l=d.replace(/\\n/g,"\n"),p=`${i}
${u}
${a}
`;try{return t.default.createVerify("RSA-SHA256").update(p).verify(l,c,"base64")}catch{return!1}}async processWebhook(e){let n=e?.event_type||"unknown",a=e?.resource;if(!a?.ciphertext)return{success:!1,eventType:n,error:(0,r.getChineseErrorMessage)("WECHAT_PAY_SIGN_FAILED")};try{var s,o,i;let e,u,c,d,l,p,_=(s=a.ciphertext,o=a.nonce||"",i=a.associated_data||"",e=function(){let e=process.env.WECHAT_PAY_API_V3_KEY;if(!e)throw Error((0,r.getChineseErrorMessage)("WECHAT_PAY_INVALID_CONFIG"));return e}(),u=Buffer.from(e,"utf8"),c=Buffer.from(o,"utf8"),d=Buffer.from(s.slice(-24),"base64"),l=Buffer.from(s.slice(0,-24),"base64"),(p=t.default.createDecipheriv("aes-256-gcm",u,c,{authTagLength:16})).setAuthTag(d),p.setAAD(Buffer.from(i,"utf8")),p.update(l)+p.final("utf8")),A=JSON.parse(_),E=A.out_trade_no,f=A.trade_state;return{success:!0,paymentId:E||"",eventType:n,status:f?({SUCCESS:"completed",REFUND:"refunded",NOTPAY:"pending",CLOSED:"cancelled",REVOKED:"cancelled",USERPAYING:"processing",PAYERROR:"failed"})[f]||f:"unknown"}}catch{return{success:!1,eventType:n,error:(0,r.getChineseErrorMessage)("WECHAT_PAY_SIGN_FAILED")}}}async refundPayment(e,t){if(!n.MCH_ID)return{refundId:"",status:"failed",error:(0,r.getChineseErrorMessage)("WECHAT_PAY_INVALID_CONFIG")};let i=`R${Date.now()}${Math.random().toString(36).slice(2,9)}`,u={out_trade_no:e,out_refund_no:i,reason:"用户申请退款",amount:{refund:null!=t?(0,r.cnyToFen)(t):void 0,total:null!=t?(0,r.cnyToFen)(t):void 0,currency:r.CHINESE_CURRENCY}},c="/v3/refund/domestic/refunds",d=`${a()}${c}`,l=JSON.stringify(u),p=o("POST",c,l,s()),_=await fetch(d,{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json",Authorization:p},body:l}),A=await _.json();return!_.ok||A.errcode?{refundId:"",status:"failed",error:A.errmsg||(0,r.getChineseErrorMessage)("WECHAT_PAY_ORDER_FAILED")}:{refundId:A.refund_id||i,status:A.status||"PROCESSING",amountRefunded:t}}}e.s(["WeChatPayClient",()=>i])},557220,e=>{"use strict";var t=e.i(254799),r=e.i(775002);let n={APP_ID:process.env.ALIPAY_APP_ID,DOMAIN:"https://openapi.alipay.com",SANDBOX_DOMAIN:"https://openapi-sandbox.dl.alipaydev.com",CURRENCY:r.CHINESE_CURRENCY,TIMEZONE:r.CHINESE_TIMEZONE};function a(){return"sandbox"===(process.env.ALIPAY_ENV||"production")?n.SANDBOX_DOMAIN:n.DOMAIN}function s(){let e=process.env.ALIPAY_PRIVATE_KEY;if(!e)throw Error((0,r.getChineseErrorMessage)("ALIPAY_INVALID_CONFIG"));return e.replace(/\\n/g,"\n")}function o(e,r){let n=Object.keys(e).sort().filter(t=>""!==e[t]&&null!=e[t]).map(t=>`${t}=${e[t]}`).join("&");return t.default.createSign("RSA-SHA256").update(n).sign(r,"base64")}class i{async createPayment(e){let t=n.APP_ID;if(!t)throw Error((0,r.getChineseErrorMessage)("ALIPAY_INVALID_CONFIG"));let i=e.amount;if(!(0,r.isValidChineseAmount)(i))throw Error((0,r.getChineseErrorMessage)("PAYMENT_AMOUNT_INVALID"));let u=`A${Date.now()}${Math.random().toString(36).slice(2,9)}`,c="http://localhost:3003",d=e.successUrl??`${c}/payment/success`,l=process.env.ALIPAY_NOTIFY_URL||`${c}/api/payments/webhooks/alipay`,p={out_trade_no:u,total_amount:(0,r.formatAlipayAmount)(i),subject:e.description.slice(0,256),product_code:"FAST_INSTANT_TRADE_PAY"},_={app_id:t,method:"alipay.trade.page.pay",format:"JSON",charset:"utf-8",sign_type:"RSA2",timestamp:new Date().toISOString().replace(/\\.\d{3}Z$/,"Z"),version:"1.0",return_url:d,notify_url:l,biz_content:JSON.stringify(p)},A=o(_,s());_.sign=A;let E=`${a()}/gateway.do`,f=Object.entries(_).map(([e,t])=>`${encodeURIComponent(e)}=${encodeURIComponent(t)}`).join("&");return{paymentId:u,checkoutUrl:`${E}?${f}`,status:"WAIT_BUYER_PAY"}}verifyWebhook(e,r){let n="object"==typeof e&&null!==e?e:{},a=n.sign??r,s=process.env.ALIPAY_PUBLIC_KEY;if(!s)return!1;var o=s.replace(/\\n/g,"\n");if("RSA2"!==(n.sign_type||"RSA2"))return!1;let i=Object.keys(n).filter(e=>"sign"!==e&&"sign_type"!==e).sort().filter(e=>""!==n[e]&&null!=n[e]).map(e=>`${e}=${n[e]}`).join("&");try{return t.default.createVerify("RSA-SHA256").update(i).verify(o,a,"base64")}catch{return!1}}async processWebhook(e){let t=e.trade_status,n=e.out_trade_no;return n?{success:!0,paymentId:n,eventType:"trade.notify",status:t?({WAIT_BUYER_PAY:"pending",TRADE_CLOSED:"cancelled",TRADE_SUCCESS:"completed",TRADE_FINISHED:"completed"})[t]||t:"unknown"}:{success:!1,eventType:"notify",error:(0,r.getChineseErrorMessage)("ALIPAY_SIGN_FAILED")}}async refundPayment(e,t){let i=n.APP_ID;if(!i)return{refundId:"",status:"failed",error:(0,r.getChineseErrorMessage)("ALIPAY_INVALID_CONFIG")};let u=`R${Date.now()}${Math.random().toString(36).slice(2,9)}`,c={out_trade_no:e,refund_amount:null!=t?(0,r.formatAlipayAmount)(t):"0",out_request_no:u},d={app_id:i,method:"alipay.trade.refund",format:"JSON",charset:"utf-8",sign_type:"RSA2",timestamp:new Date().toISOString().replace(/\\.\d{3}Z$/,"Z"),version:"1.0",biz_content:JSON.stringify(c)},l=o(d,s());d.sign=l;let p=`${a()}/gateway.do`,_=Object.entries(d).map(([e,t])=>`${encodeURIComponent(e)}=${encodeURIComponent(t)}`).join("&"),A=Date.now(),E=await fetch(p,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:_});if(Date.now()-A>2e3)return{refundId:"",status:"failed",error:(0,r.getChineseErrorMessage)("PAYMENT_TIMEOUT")};let f=(await E.json()).alipay_trade_refund_response;return f&&"10000"===f.code?{refundId:u,status:"completed",amountRefunded:t}:{refundId:"",status:"failed",error:f?.sub_code||f?.msg||(0,r.getChineseErrorMessage)("ALIPAY_ORDER_FAILED")}}}e.s(["AlipayClient",()=>i])},886986,e=>{"use strict";var t=e.i(254799);let r=null;function n(){return"production"===(process.env.AIRWALLEX_ENV||"sandbox")?"https://api.airwallex.com":"https://api-demo.airwallex.com"}async function a(){let e=Date.now();if(r&&r.expiresAt>e+6e4)return r.token;let t=process.env.AIRWALLEX_CLIENT_ID,a=process.env.AIRWALLEX_API_KEY;if(!t||!a)throw Error("Airwallex: AIRWALLEX_CLIENT_ID and AIRWALLEX_API_KEY are required");let s=n(),o=await fetch(`${s}/api/v1/authentication/login`,{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json","x-client-id":t,"x-api-key":a}});if(!o.ok){let e=await o.text();throw Error(`Airwallex auth failed: ${o.status} ${e}`)}let i=await o.json(),u=i.token,c=i.expires_at;if(!u)throw Error("Airwallex: no token in auth response");return r={token:u,expiresAt:c?new Date(c).getTime():Date.now()+15e5},u}class s{async createPayment(e){let t=await a(),r=n(),s=`req_${Date.now()}_${Math.random().toString(36).slice(2,9)}`,o=process.env.PAYMENT_SUCCESS_URL||"http://localhost:3003/payment/success",i=e.successUrl??o,u={request_id:s,amount:e.amount,currency:e.currency.toUpperCase(),merchant_order_id:e.bookingId??(e.curriculumId?`course:${e.curriculumId}`:"payment"),return_url:i},c=await fetch(`${r}/api/v1/pa/payment_intents/create`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${t}`,"x-client-id":process.env.AIRWALLEX_CLIENT_ID},body:JSON.stringify(u)});if(!c.ok){let e=await c.text();throw Error(`Airwallex create payment intent failed: ${c.status} ${e}`)}let d=await c.json(),l=d.id;if(!l)throw Error("Airwallex: no payment intent id in response");let p=d.url||`http://localhost:3003/payment/checkout?intent_id=${l}&client_secret=${encodeURIComponent(d.client_secret||"")}`;return{paymentId:l,checkoutUrl:p,status:d.status||"REQUIRES_PAYMENT_METHOD"}}verifyWebhook(e,r){let n=process.env.AIRWALLEX_WEBHOOK_SECRET;if(!n)return!1;let a=function(e){if(e&&"object"==typeof e&&"rawBody"in e&&"timestamp"in e){let t=e.rawBody,r=e.timestamp;if("string"==typeof t&&"string"==typeof r)return{rawBody:t,timestamp:r}}return null}(e);if(!a)return!1;let{rawBody:s,timestamp:o}=a,i=`${o}${s}`,u=t.default.createHmac("sha256",n).update(i).digest("hex");return t.default.timingSafeEqual(Buffer.from(u,"hex"),Buffer.from(r,"hex"))}async processWebhook(e){let t=e?.name||"",r=e?.data;if(!r)return{success:!1,eventType:t,error:"Missing event data"};let n=r.id,a=r.status;return"payment_intent.succeeded"===t?{success:!0,paymentId:n,eventType:t,status:a||"succeeded"}:"payment_intent.cancelled"===t||"payment_intent.failed"===t?{success:!0,paymentId:n,eventType:t,status:a||"cancelled"}:{success:!0,paymentId:n,eventType:t,status:a}}async refundPayment(e,t){let r=await a(),s=n(),o=`refund_${Date.now()}_${Math.random().toString(36).slice(2,9)}`,i={payment_attempt_id:e,reason:"customer_requested",request_id:o};null!=t&&t>0&&(i.amount=t);let u=await fetch(`${s}/api/v1/pa/refunds/create`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${r}`,"x-client-id":process.env.AIRWALLEX_CLIENT_ID},body:JSON.stringify(i)});if(!u.ok){let e=await u.text();return{refundId:"",status:"failed",error:`Airwallex refund failed: ${u.status} ${e}`}}let c=await u.json();return{refundId:c.id||o,status:c.status||"RECEIVED",amountRefunded:c.amount}}}e.s(["AirwallexGateway",()=>s])},501047,e=>{"use strict";var t=e.i(254799);function r(){return"production"===(process.env.HITPAY_ENV||"sandbox")?"https://api.hit-pay.com":"https://api.sandbox.hit-pay.com"}class n{async createPayment(e){let t=process.env.HITPAY_API_KEY;if(!t)throw Error("Hitpay: HITPAY_API_KEY is required");let n=r(),a=process.env.PAYMENT_SUCCESS_URL||"http://localhost:3003/payment/success",s=e.successUrl??a,o=process.env.HITPAY_WEBHOOK_URL||"http://localhost:3003/api/payments/webhooks/hitpay",i={amount:e.amount,currency:e.currency.toLowerCase(),email:e.studentEmail,purpose:e.description,reference_number:e.bookingId??(e.curriculumId?`course:${e.curriculumId}`:"payment"),redirect_url:s,webhook:o},u=await fetch(`${n}/v1/payment-requests`,{method:"POST",headers:{"Content-Type":"application/json","X-BUSINESS-API-KEY":t},body:JSON.stringify(i)});if(!u.ok){let e=await u.text();throw Error(`Hitpay create payment failed: ${u.status} ${e}`)}let c=await u.json(),d=c.id;if(!d)throw Error("Hitpay: no payment request id in response");return{paymentId:d,checkoutUrl:c.url||"",status:c.status||"pending"}}verifyWebhook(e,r){let n=process.env.HITPAY_SALT;if(!n)return!1;let a="string"==typeof e?e:JSON.stringify(e),s=t.default.createHmac("sha256",n).update(a).digest("hex");return s.length===r.length&&t.default.timingSafeEqual(Buffer.from(s,"hex"),Buffer.from(r,"hex"))}async processWebhook(e){let t=e?.id||e?.payment_request_id,r=e?.status;return t?{success:!0,paymentId:t,eventType:"payment_request.completed",status:r?({succeeded:"succeeded",completed:"completed",paid:"completed",pending:"pending",failed:"failed",expired:"expired",canceled:"cancelled",cancelled:"cancelled",partially_refunded:"partially_refunded",refunded:"refunded"})[r.toLowerCase()]||r:"unknown"}:{success:!1,eventType:"unknown",error:"Missing payment id in webhook"}}async refundPayment(e,t){let n=process.env.HITPAY_API_KEY;if(!n)return{refundId:"",status:"failed",error:"Hitpay: HITPAY_API_KEY is required"};let a=r(),s={payment_id:e};null!=t&&t>0&&(s.amount=t);let o=await fetch(`${a}/v1/refund`,{method:"POST",headers:{"Content-Type":"application/json","X-BUSINESS-API-KEY":n},body:JSON.stringify(s)});if(!o.ok){let e=await o.text();return{refundId:"",status:"failed",error:`Hitpay refund failed: ${o.status} ${e}`}}let i=await o.json();return{refundId:i.id||"",status:i.status||"succeeded",amountRefunded:i.amount_refunded}}}e.s(["HitpayGateway",()=>n])},819316,e=>{"use strict";var t=e.i(886986),r=e.i(501047);function n(e){switch(e){case"AIRWALLEX":return new t.AirwallexGateway;case"HITPAY":return new r.HitpayGateway;default:throw Error(`Unsupported payment gateway: ${e}`)}}e.s(["getPaymentGateway",()=>n])},160373,e=>{"use strict";e.i(886986),e.i(501047),e.i(819316),e.i(775002),e.i(232868),e.i(557220),e.s([],160373)}];

//# debugId=7df8ee69-dfa9-a504-8c63-3622aa7a4260
//# sourceMappingURL=ADK_WORKSPACE_TutorMekimi_tutorme-app_src_lib_payments_04c98a59._.js.map