;!function(){try { var e="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof global?global:"undefined"!=typeof window?window:"undefined"!=typeof self?self:{},n=(new e.Error).stack;n&&((e._debugIds|| (e._debugIds={}))[n]="e528c900-34c6-68f1-4f40-7c797cefbe33")}catch(e){}}();
module.exports=[908286,e=>{"use strict";async function t(e,t){var r=e instanceof Promise?await e:e;if(!r||"object"!=typeof r)return;let a=r[t];return null!=a?Array.isArray(a)?a[0]:a:void 0}e.s(["getParamAsync",()=>t])},891820,e=>e.a(async(t,r)=>{try{var a=e.i(909105),s=e.i(997103),n=e.i(320947),i=e.i(738597);e.i(688768);var o=e.i(257357),l=t([i]);async function c(e,t){let r=await i.drizzleDb.select().from(o.taskSubmission).where((0,a.eq)(o.taskSubmission.studentId,e));if(0===r.length)return{averageScore:0,completionRate:0,engagementScore:0,attendanceRate:0,participationRate:0};let s=r.reduce((e,t)=>e+(Number(t.score)||0),0)/r.length,l=r.filter(e=>"graded"===e.status).length/r.length*100,c=r.reduce((e,t)=>e+(t.timeSpent||0),0)/r.length,u=r.reduce((e,t)=>e+(t.attempts||1),0)/r.length,d=Math.min(100,c/300*50+1/u*50),p=await i.drizzleDb.select({sessionId:o.sessionParticipant.sessionId,joinedAt:o.sessionParticipant.joinedAt}).from(o.sessionParticipant).where((0,a.eq)(o.sessionParticipant.studentId,e)),m=new Set(p.map(e=>e.sessionId)),f=new Set(p.filter(e=>null!=e.joinedAt).map(e=>e.sessionId)),h=m.size,g=f.size,[w]=await i.drizzleDb.select({count:n.sql`count(*)::int`}).from(o.message).where((0,a.eq)(o.message.userId,e)),R=w?.count??0,A=Math.min(100,5*R);return{averageScore:Math.round(10*s)/10,completionRate:Math.round(10*l)/10,engagementScore:Math.round(10*d)/10,attendanceRate:Math.round(10*(h>0?g/h*100:0))/10,participationRate:Math.round(10*A)/10}}async function u(e){let t={},r=await i.drizzleDb.select().from(o.taskSubmission).where((0,a.eq)(o.taskSubmission.studentId,e));for(let e of r){let r=e.answers;for(let a of r?.subjects||r?.topics||["general"])t[a]||(t[a]=[]),t[a].push(e.score||0)}let s={};for(let e of r){let t=e.questionResults;if(Array.isArray(t))for(let e of t){let t=e.questionId??"unknown";s[t]||(s[t]={correct:0,total:0}),s[t].total++,e.correct&&s[t].correct++}}for(let t of(await i.drizzleDb.select().from(o.quizAttempt).where((0,a.and)((0,a.eq)(o.quizAttempt.studentId,e),(0,a.isNotNull)(o.quizAttempt.questionResults))).limit(50))){let e=t.questionResults;if(Array.isArray(e))for(let t of e){let e=t.questionId??"unknown";s[e]||(s[e]={correct:0,total:0}),s[e].total++,t.correct&&s[e].correct++}}for(let[e,r]of Object.entries(s)){if(0===r.total)continue;let a=r.correct/r.total*100,s=`Q:${e}`;a>=80?(t[s]||(t[s]=[]),t[s].push(a)):a<50&&(t[s]||(t[s]=[]),t[s].push(a))}let n=[],l=[];for(let[e,r]of Object.entries(t)){let t=r.reduce((e,t)=>e+t,0)/r.length;t>=80?n.push(e):t<60&&l.push(e)}return{strengths:n,weaknesses:l}}async function d(e){let t=await i.drizzleDb.select().from(o.taskSubmission).where((0,a.eq)(o.taskSubmission.studentId,e)).orderBy((0,s.desc)(o.taskSubmission.submittedAt)).limit(50),r={},n=(e,t)=>{r[e]||(r[e]={count:0,lastAt:t}),r[e].count++,t>r[e].lastAt&&(r[e].lastAt=t)};for(let e of t){let t=e.answers;if(t?.mistakes)for(let r of t.mistakes)n(r.type||"general",e.submittedAt)}for(let e of t){let t=e.questionResults;if(Array.isArray(t))for(let r of t){if(r.correct)continue;let t=r.selectedAnswer?`Q:${r.questionId}: chose ${String(r.selectedAnswer).slice(0,40)}`:`Q:${r.questionId}: incorrect`;n(t,e.submittedAt)}}for(let t of(await i.drizzleDb.select().from(o.quizAttempt).where((0,a.and)((0,a.eq)(o.quizAttempt.studentId,e),(0,a.isNotNull)(o.quizAttempt.questionResults))).orderBy((0,s.desc)(o.quizAttempt.completedAt)).limit(50))){let e=t.questionResults;if(Array.isArray(e))for(let r of e){if(r.correct)continue;let e=r.selectedAnswer?`Q:${r.questionId}: chose ${String(r.selectedAnswer).slice(0,40)}`:`Q:${r.questionId}: incorrect`;n(e,t.completedAt)}}return Object.entries(r).map(([e,t])=>({type:e,frequency:t.count,lastOccurred:t.lastAt})).sort((e,t)=>t.frequency-e.frequency).slice(0,10)}async function p(e){let t=[],r=[],n=0,l=0;for(let c of(await i.drizzleDb.select().from(o.quizAttempt).where((0,a.and)((0,a.eq)(o.quizAttempt.studentId,e),(0,a.isNotNull)(o.quizAttempt.questionResults))).orderBy((0,s.desc)(o.quizAttempt.completedAt)).limit(50))){let e=c.questionResults;if(!Array.isArray(e)||0===e.length)continue;let a=e.map(e=>({sourceType:"quiz",sourceId:c.quizId,questionId:e.questionId,correct:e.correct??(void 0!==e.pointsEarned&&void 0!==e.pointsMax&&e.pointsEarned>=.7*e.pointsMax),pointsEarned:e.pointsEarned??0,pointsMax:e.pointsMax??100,selectedAnswer:e.selectedAnswer,completedAt:c.completedAt}));for(let e of a)l++,e.correct?n++:r.push(e.questionId);t.push({sourceType:"quiz",sourceId:c.quizId,completedAt:c.completedAt,questions:a})}for(let c of(await i.drizzleDb.select().from(o.taskSubmission).where((0,a.and)((0,a.eq)(o.taskSubmission.studentId,e),(0,a.isNotNull)(o.taskSubmission.questionResults))).orderBy((0,s.desc)(o.taskSubmission.submittedAt)).limit(50))){let e=c.questionResults;if(!Array.isArray(e)||0===e.length)continue;let a=e.map(e=>({sourceType:"task",sourceId:c.taskId,questionId:e.questionId,correct:e.correct??(void 0!==e.pointsEarned&&void 0!==e.pointsMax&&e.pointsEarned>=.7*e.pointsMax),pointsEarned:e.pointsEarned??0,pointsMax:e.pointsMax??100,selectedAnswer:e.selectedAnswer,completedAt:c.submittedAt}));for(let e of a)l++,e.correct?n++:r.push(e.questionId);t.push({sourceType:"task",sourceId:c.taskId,completedAt:c.submittedAt,questions:a})}return{bySource:t,weakQuestionIds:[...new Set(r)],totalCorrect:n,totalQuestions:l}}async function m(e,t){let r,n=await c(e,t),{strengths:l,weaknesses:p}=await u(e);if(t){let n=await i.drizzleDb.select({id:o.courseBatch.id}).from(o.courseBatch).where((0,a.eq)(o.courseBatch.curriculumId,t)),l=n.length>0?(await i.drizzleDb.select({id:o.generatedTask.id}).from(o.generatedTask).where((0,a.inArray)(o.generatedTask.batchId,n.map(e=>e.id)))).map(e=>e.id):[];r=l.length>0?await i.drizzleDb.select().from(o.taskSubmission).where((0,a.and)((0,a.eq)(o.taskSubmission.studentId,e),(0,a.inArray)(o.taskSubmission.taskId,l))).orderBy((0,s.desc)(o.taskSubmission.submittedAt)).limit(20):await i.drizzleDb.select().from(o.taskSubmission).where((0,a.eq)(o.taskSubmission.studentId,e)).orderBy((0,s.desc)(o.taskSubmission.submittedAt)).limit(20)}else r=await i.drizzleDb.select().from(o.taskSubmission).where((0,a.eq)(o.taskSubmission.studentId,e)).orderBy((0,s.desc)(o.taskSubmission.submittedAt)).limit(20);let m=r.map(e=>{let t=e.answers;return{taskId:e.taskId,score:e.score||0,timeSpent:e.timeSpent||0,attempts:e.attempts||1,completedAt:e.submittedAt,strengths:t?.strengthsDemonstrated||[],weaknesses:t?.areasForImprovement||[]}}),f=await d(e),h=function(e){if(e.length<3)return"normal";let t=e.reduce((e,t)=>e+t.timeSpent,0)/e.length,r=e.reduce((e,t)=>e+t.attempts,0)/e.length;return t<180&&r<1.5?"fast":t>600||r>2.5?"slow":"normal"}(m),g=n.averageScore>=80&&n.completionRate>=80&&n.engagementScore>=70?"advanced":n.averageScore<60||n.completionRate<50||n.engagementScore<40?"struggling":"intermediate",w=r.filter(e=>{let t=e.answers;return t?.taskType==="visual"}).length>r.length/2?"visual":"mixed";return{studentId:e,overallMetrics:n,subjectStrengths:l,subjectWeaknesses:p,learningStyle:w,pace:h,taskHistory:m,commonMistakes:f,performanceCluster:g}}async function f(e){let t=await i.drizzleDb.select({studentId:o.curriculumEnrollment.studentId}).from(o.curriculumEnrollment).where((0,a.eq)(o.curriculumEnrollment.curriculumId,e)),r=await Promise.all(t.map(async t=>{let[r]=await i.drizzleDb.select({name:o.profile.name}).from(o.profile).where((0,a.eq)(o.profile.userId,t.studentId)).limit(1);return{id:t.studentId,name:r?.name??"Unknown",performance:await m(t.studentId,e)}})),s={advanced:0,intermediate:0,struggling:0},n=0,l=[];for(let e of r)s[e.performance.performanceCluster]++,n+=e.performance.overallMetrics.averageScore,"struggling"===e.performance.performanceCluster&&l.push({id:e.id,name:e.name,reason:`Low performance: ${e.performance.overallMetrics.averageScore.toFixed(0)}% avg`});let c=r.sort((e,t)=>t.performance.overallMetrics.averageScore-e.performance.overallMetrics.averageScore).slice(0,5).map(e=>({id:e.id,name:e.name,score:e.performance.overallMetrics.averageScore}));return{totalStudents:t.length,averageScore:t.length>0?n/t.length:0,clusterDistribution:s,topStudents:c,studentsNeedingAttention:l}}async function h(e,t){let r=await m(e,t),[s]=await i.drizzleDb.select().from(o.studentPerformance).where((0,a.eq)(o.studentPerformance.studentId,e)).limit(1),n={studentId:e,cluster:r.performanceCluster,strengths:r.subjectStrengths,weaknesses:r.subjectWeaknesses,commonMistakes:r.commonMistakes.map(e=>({type:e.type,frequency:e.frequency})),learningStyle:r.learningStyle??"mixed",averageScore:r.overallMetrics.averageScore,completionRate:r.overallMetrics.completionRate,engagementScore:r.overallMetrics.engagementScore,attendanceRate:r.overallMetrics.attendanceRate,participationRate:r.overallMetrics.participationRate,pace:r.pace};s?await i.drizzleDb.update(o.studentPerformance).set({cluster:n.cluster,strengths:n.strengths,weaknesses:n.weaknesses,commonMistakes:n.commonMistakes,learningStyle:n.learningStyle,averageScore:n.averageScore,completionRate:n.completionRate,engagementScore:n.engagementScore,attendanceRate:n.attendanceRate,participationRate:n.participationRate,pace:n.pace,curriculumId:t??null}).where((0,a.eq)(o.studentPerformance.id,s.id)):await i.drizzleDb.insert(o.studentPerformance).values({id:crypto.randomUUID(),studentId:n.studentId,curriculumId:t??null,cluster:n.cluster,strengths:n.strengths,weaknesses:n.weaknesses,commonMistakes:n.commonMistakes,learningStyle:n.learningStyle,averageScore:n.averageScore,completionRate:n.completionRate,engagementScore:n.engagementScore,attendanceRate:n.attendanceRate,participationRate:n.participationRate,pace:n.pace,taskHistory:[],skillBreakdown:{},recommendedPeers:[],updatedAt:new Date})}[i]=l.then?(await l)():l,e.s(["getClassPerformanceSummary",()=>f,"getQuestionLevelBreakdown",()=>p,"getStudentPerformance",()=>m,"updateStudentPerformanceRecord",()=>h]),r()}catch(e){r(e)}},!1),520107,e=>e.a(async(t,r)=>{try{var a=e.i(620971),s=e.i(384030),n=e.i(908286),i=e.i(891820),o=t([s,i]);[s,i]=o.then?(await o)():o;let l=(0,s.withAuth)(async(e,t,r)=>{let s=await (0,n.getParamAsync)(r?.params,"studentId");if(!s)return a.NextResponse.json({error:"Student ID required"},{status:400});let{searchParams:o}=new URL(e.url),l=o.get("curriculumId")||void 0;t.user.id,t.user.role;let c=await (0,i.getStudentPerformance)(s,l);return a.NextResponse.json({success:!0,data:c})},{role:"TUTOR"});e.s(["GET",0,l]),r()}catch(e){r(e)}},!1),840588,e=>e.a(async(t,r)=>{try{var a=e.i(78315),s=e.i(586961),n=e.i(196657),i=e.i(899733),o=e.i(233979),l=e.i(631683),c=e.i(840960),u=e.i(711373),d=e.i(699699),p=e.i(521140),m=e.i(205260),f=e.i(500249),h=e.i(431740),g=e.i(82608),w=e.i(635207),R=e.i(193695);e.i(708038);var A=e.i(447430),y=e.i(520107),v=t([y]);[y]=v.then?(await v)():v;let I=new a.AppRouteRouteModule({definition:{kind:s.RouteKind.APP_ROUTE,page:"/api/analytics/students/[studentId]/route",pathname:"/api/analytics/students/[studentId]",filename:"route",bundlePath:""},distDir:".next",relativeProjectDir:"",resolvedPagePath:"[project]/ADK_WORKSPACE/TutorMekimi/tutorme-app/src/app/api/analytics/students/[studentId]/route.ts",nextConfigOutput:"",userland:y}),{workAsyncStorage:q,workUnitAsyncStorage:k,serverHooks:z}=I;function S(){return(0,n.patchFetch)({workAsyncStorage:q,workUnitAsyncStorage:k})}async function b(e,t,r){I.isDev&&(0,i.addRequestMeta)(e,"devRequestTimingInternalsEnd",process.hrtime.bigint());let a="/api/analytics/students/[studentId]/route";a=a.replace(/\/index$/,"")||"/";let n=await I.prepare(e,t,{srcPage:a,multiZoneDraftMode:!1});if(!n)return t.statusCode=400,t.end("Bad Request"),null==r.waitUntil||r.waitUntil.call(r,Promise.resolve()),null;let{buildId:y,params:v,nextConfig:S,parsedUrl:b,isDraftMode:q,prerenderManifest:k,routerServerContext:z,isOnDemandRevalidate:E,revalidateOnlyGenerated:M,resolvedPathname:P,clientReferenceManifest:x,serverActionsManifest:_}=n,C=(0,c.normalizeAppPath)(a),D=!!(k.dynamicRoutes[C]||k.routes[P]),T=async()=>((null==z?void 0:z.render404)?await z.render404(e,t,b,!1):t.end("This page could not be found"),null);if(D&&!q){let e=!!k.routes[P],t=k.dynamicRoutes[C];if(t&&!1===t.fallback&&!e){if(S.experimental.adapterPath)return await T();throw new R.NoFallbackError}}let N=null;!D||I.isDev||q||(N=P,N="/index"===N?"/":N);let O=!0===I.isDev||!D,j=D&&!O;_&&x&&(0,l.setManifestsSingleton)({page:a,clientReferenceManifest:x,serverActionsManifest:_});let U=e.method||"GET",H=(0,o.getTracer)(),B=H.getActiveScopeSpan(),$={params:v,prerenderManifest:k,renderOpts:{experimental:{authInterrupts:!!S.experimental.authInterrupts},cacheComponents:!!S.cacheComponents,supportsDynamicResponse:O,incrementalCache:(0,i.getRequestMeta)(e,"incrementalCache"),cacheLifeProfiles:S.cacheLife,waitUntil:r.waitUntil,onClose:e=>{t.on("close",e)},onAfterTaskError:void 0,onInstrumentationRequestError:(t,r,a,s)=>I.onRequestError(e,t,a,s,z)},sharedContext:{buildId:y}},K=new u.NodeNextRequest(e),F=new u.NodeNextResponse(t),L=d.NextRequestAdapter.fromNodeNextRequest(K,(0,d.signalFromNodeResponse)(t));try{let n=async e=>I.handle(L,$).finally(()=>{if(!e)return;e.setAttributes({"http.status_code":t.statusCode,"next.rsc":!1});let r=H.getRootSpanAttributes();if(!r)return;if(r.get("next.span_type")!==p.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${r.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let s=r.get("next.route");if(s){let t=`${U} ${s}`;e.setAttributes({"next.route":s,"http.route":s,"next.span_name":t}),e.updateName(t)}else e.updateName(`${U} ${a}`)}),l=!!(0,i.getRequestMeta)(e,"minimalMode"),c=async i=>{var o,c;let u=async({previousCacheEntry:s})=>{try{if(!l&&E&&M&&!s)return t.statusCode=404,t.setHeader("x-nextjs-cache","REVALIDATED"),t.end("This page could not be found"),null;let a=await n(i);e.fetchMetrics=$.renderOpts.fetchMetrics;let o=$.renderOpts.pendingWaitUntil;o&&r.waitUntil&&(r.waitUntil(o),o=void 0);let c=$.renderOpts.collectedTags;if(!D)return await (0,f.sendResponse)(K,F,a,$.renderOpts.pendingWaitUntil),null;{let e=await a.blob(),t=(0,h.toNodeOutgoingHttpHeaders)(a.headers);c&&(t[w.NEXT_CACHE_TAGS_HEADER]=c),!t["content-type"]&&e.type&&(t["content-type"]=e.type);let r=void 0!==$.renderOpts.collectedRevalidate&&!($.renderOpts.collectedRevalidate>=w.INFINITE_CACHE)&&$.renderOpts.collectedRevalidate,s=void 0===$.renderOpts.collectedExpire||$.renderOpts.collectedExpire>=w.INFINITE_CACHE?void 0:$.renderOpts.collectedExpire;return{value:{kind:A.CachedRouteKind.APP_ROUTE,status:a.status,body:Buffer.from(await e.arrayBuffer()),headers:t},cacheControl:{revalidate:r,expire:s}}}}catch(t){throw(null==s?void 0:s.isStale)&&await I.onRequestError(e,t,{routerKind:"App Router",routePath:a,routeType:"route",revalidateReason:(0,m.getRevalidateReason)({isStaticGeneration:j,isOnDemandRevalidate:E})},!1,z),t}},d=await I.handleResponse({req:e,nextConfig:S,cacheKey:N,routeKind:s.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:k,isRoutePPREnabled:!1,isOnDemandRevalidate:E,revalidateOnlyGenerated:M,responseGenerator:u,waitUntil:r.waitUntil,isMinimalMode:l});if(!D)return null;if((null==d||null==(o=d.value)?void 0:o.kind)!==A.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==d||null==(c=d.value)?void 0:c.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});l||t.setHeader("x-nextjs-cache",E?"REVALIDATED":d.isMiss?"MISS":d.isStale?"STALE":"HIT"),q&&t.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let p=(0,h.fromNodeOutgoingHttpHeaders)(d.value.headers);return l&&D||p.delete(w.NEXT_CACHE_TAGS_HEADER),!d.cacheControl||t.getHeader("Cache-Control")||p.get("Cache-Control")||p.set("Cache-Control",(0,g.getCacheControlHeader)(d.cacheControl)),await (0,f.sendResponse)(K,F,new Response(d.value.body,{headers:p,status:d.value.status||200})),null};B?await c(B):await H.withPropagatedContext(e.headers,()=>H.trace(p.BaseServerSpan.handleRequest,{spanName:`${U} ${a}`,kind:o.SpanKind.SERVER,attributes:{"http.method":U,"http.target":e.url}},c))}catch(t){if(t instanceof R.NoFallbackError||await I.onRequestError(e,t,{routerKind:"App Router",routePath:C,routeType:"route",revalidateReason:(0,m.getRevalidateReason)({isStaticGeneration:j,isOnDemandRevalidate:E})},!1,z),D)throw t;return await (0,f.sendResponse)(K,F,new Response(null,{status:500})),null}}e.s(["handler",()=>b,"patchFetch",()=>S,"routeModule",()=>I,"serverHooks",()=>z,"workAsyncStorage",()=>q,"workUnitAsyncStorage",()=>k]),r()}catch(e){r(e)}},!1),412171,e=>{e.v(t=>Promise.all(["server/chunks/b1c00_TutorMekimi_tutorme-app_src_lib_security_suspicious-activity_ts_7865686f._.js"].map(t=>e.l(t))).then(()=>t(145830)))},443460,e=>{e.v(t=>Promise.all(["server/chunks/[externals]_ioredis_c74819ca._.js"].map(t=>e.l(t))).then(()=>t(693545)))},571363,e=>{e.v(t=>Promise.all(["server/chunks/ADK_WORKSPACE_TutorMekimi_tutorme-app_src_lib_security_api-key_ts_45091e81._.js"].map(t=>e.l(t))).then(()=>t(175922)))}];

//# debugId=e528c900-34c6-68f1-4f40-7c797cefbe33
//# sourceMappingURL=%5Broot-of-the-server%5D__5ab42017._.js.map