;!function(){try { var e="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof global?global:"undefined"!=typeof window?window:"undefined"!=typeof self?self:{},n=(new e.Error).stack;n&&((e._debugIds|| (e._debugIds={}))[n]="2259726d-27fc-5b7c-fd24-f21178cbe24a")}catch(e){}}();
module.exports=[644669,e=>e.a(async(t,r)=>{try{var a=e.i(620971),i=e.i(384030),n=e.i(908286),s=e.i(738597);e.i(688768);var o=e.i(257357),d=e.i(909105),l=e.i(997103),c=e.i(420447),u=t([i,s]);[i,s]=u.then?(await u)():u;let p=(0,i.withAuth)(async(e,t,r)=>{let u,p=await (0,n.getParamAsync)(r?.params,"id");if(!p)return a.NextResponse.json({error:"Conversation ID required"},{status:400});let m=t.user.id,{searchParams:h}=new URL(e.url),v=h.get("cursor"),w=(0,i.parseBoundedInt)(h.get("limit"),50,{min:1,max:100}),[f]=await s.drizzleDb.select({id:o.conversation.id,participant1Id:o.conversation.participant1Id,participant2Id:o.conversation.participant2Id}).from(o.conversation).where((0,d.and)((0,d.eq)(o.conversation.id,p),(0,d.or)((0,d.eq)(o.conversation.participant1Id,m),(0,d.eq)(o.conversation.participant2Id,m)))).limit(1);if(!f)return a.NextResponse.json({error:"Conversation not found"},{status:404});let[g,R]=await Promise.all([s.drizzleDb.select({role:o.user.role}).from(o.user).where((0,d.eq)(o.user.id,f.participant1Id)).limit(1),s.drizzleDb.select({role:o.user.role}).from(o.user).where((0,d.eq)(o.user.id,f.participant2Id)).limit(1)]);if(!g[0]||!R[0]||!(0,c.isConversationAllowedByRoles)(g[0].role,R[0].role))return a.NextResponse.json({error:"Conversation not found"},{status:404});if(v){let[e]=await s.drizzleDb.select().from(o.directMessage).where((0,d.and)((0,d.eq)(o.directMessage.conversationId,p),(0,d.eq)(o.directMessage.id,v))).limit(1),t=e?.createdAt;u=t?await s.drizzleDb.select().from(o.directMessage).where((0,d.and)((0,d.eq)(o.directMessage.conversationId,p),(0,d.lt)(o.directMessage.createdAt,t))).orderBy((0,l.desc)(o.directMessage.createdAt)).limit(w):await s.drizzleDb.select().from(o.directMessage).where((0,d.eq)(o.directMessage.conversationId,p)).orderBy((0,l.desc)(o.directMessage.createdAt)).limit(w)}else u=await s.drizzleDb.select().from(o.directMessage).where((0,d.eq)(o.directMessage.conversationId,p)).orderBy((0,l.desc)(o.directMessage.createdAt)).limit(w);await s.drizzleDb.update(o.directMessage).set({read:!0,readAt:new Date}).where((0,d.and)((0,d.eq)(o.directMessage.conversationId,p),(0,d.ne)(o.directMessage.senderId,m),(0,d.eq)(o.directMessage.read,!1)));let I=[...new Set(u.map(e=>e.senderId))],y=await s.drizzleDb.select().from(o.user).where((0,d.inArray)(o.user.id,I)),A=await s.drizzleDb.select().from(o.profile).where((0,d.inArray)(o.profile.userId,I)),C=Object.fromEntries(A.map(e=>[e.userId,e])),x=Object.fromEntries(y.map(e=>[e.id,e])),E=u.map(e=>({...e,sender:x[e.senderId]?{id:x[e.senderId].id,profile:C[e.senderId]?{name:C[e.senderId].name,avatarUrl:C[e.senderId].avatarUrl}:null}:null}));return a.NextResponse.json({messages:E.reverse(),nextCursor:u.length===w?u[u.length-1]?.id:null})}),m=(0,i.withAuth)(async(e,t,r)=>{let i=await (0,n.getParamAsync)(r?.params,"id");if(!i)return a.NextResponse.json({error:"Conversation ID required"},{status:400});let l=t.user.id;try{let{content:t,type:r="text",attachmentUrl:n}=await e.json();if(!t&&!n)return a.NextResponse.json({error:"Content or attachment is required"},{status:400});let[u]=await s.drizzleDb.select().from(o.conversation).where((0,d.and)((0,d.eq)(o.conversation.id,i),(0,d.or)((0,d.eq)(o.conversation.participant1Id,l),(0,d.eq)(o.conversation.participant2Id,l)))).limit(1);if(!u)return a.NextResponse.json({error:"Conversation not found"},{status:404});let[p,m]=await Promise.all([s.drizzleDb.select({role:o.user.role}).from(o.user).where((0,d.eq)(o.user.id,u.participant1Id)).limit(1),s.drizzleDb.select({role:o.user.role}).from(o.user).where((0,d.eq)(o.user.id,u.participant2Id)).limit(1)]);if(!p[0]||!m[0]||!(0,c.isConversationAllowedByRoles)(p[0].role,m[0].role))return a.NextResponse.json({error:"Conversation not found"},{status:404});let h=crypto.randomUUID();await s.drizzleDb.insert(o.directMessage).values({id:h,conversationId:i,senderId:l,content:t??"",type:r,attachmentUrl:n??null,read:!1}),await s.drizzleDb.update(o.conversation).set({updatedAt:new Date}).where((0,d.eq)(o.conversation.id,i));let v=u.participant1Id===l?u.participant2Id:u.participant1Id,w=u.participant1Id===l?m[0].role:p[0].role;await s.drizzleDb.insert(o.notification).values({id:crypto.randomUUID(),userId:v,type:"message",title:"New Message",message:t?.slice(0,100)||"You received a new message",actionUrl:(0,c.getInboxPathByRole)(w),read:!1});let[f]=await s.drizzleDb.select().from(o.directMessage).where((0,d.eq)(o.directMessage.id,h)),[g]=await s.drizzleDb.select().from(o.user).where((0,d.eq)(o.user.id,l)),[R]=await s.drizzleDb.select().from(o.profile).where((0,d.eq)(o.profile.userId,l)),I=f?{...f,sender:g?{id:g.id,profile:R?{name:R.name,avatarUrl:R.avatarUrl}:null}:null}:null;return a.NextResponse.json({message:I},{status:201})}catch(e){return console.error("Send message error:",e),a.NextResponse.json({error:"Failed to send message"},{status:500})}});e.s(["GET",0,p,"POST",0,m]),r()}catch(e){r(e)}},!1),507472,e=>e.a(async(t,r)=>{try{var a=e.i(78315),i=e.i(586961),n=e.i(196657),s=e.i(899733),o=e.i(233979),d=e.i(631683),l=e.i(840960),c=e.i(711373),u=e.i(699699),p=e.i(521140),m=e.i(205260),h=e.i(500249),v=e.i(431740),w=e.i(82608),f=e.i(635207),g=e.i(193695);e.i(708038);var R=e.i(447430),I=e.i(644669),y=t([I]);[I]=y.then?(await y)():y;let x=new a.AppRouteRouteModule({definition:{kind:i.RouteKind.APP_ROUTE,page:"/api/conversations/[id]/messages/route",pathname:"/api/conversations/[id]/messages",filename:"route",bundlePath:""},distDir:".next",relativeProjectDir:"",resolvedPagePath:"[project]/ADK_WORKSPACE/TutorMekimi/tutorme-app/src/app/api/conversations/[id]/messages/route.ts",nextConfigOutput:"",userland:I}),{workAsyncStorage:E,workUnitAsyncStorage:b,serverHooks:z}=x;function A(){return(0,n.patchFetch)({workAsyncStorage:E,workUnitAsyncStorage:b})}async function C(e,t,r){x.isDev&&(0,s.addRequestMeta)(e,"devRequestTimingInternalsEnd",process.hrtime.bigint());let a="/api/conversations/[id]/messages/route";a=a.replace(/\/index$/,"")||"/";let n=await x.prepare(e,t,{srcPage:a,multiZoneDraftMode:!1});if(!n)return t.statusCode=400,t.end("Bad Request"),null==r.waitUntil||r.waitUntil.call(r,Promise.resolve()),null;let{buildId:I,params:y,nextConfig:A,parsedUrl:C,isDraftMode:E,prerenderManifest:b,routerServerContext:z,isOnDemandRevalidate:D,revalidateOnlyGenerated:q,resolvedPathname:M,clientReferenceManifest:N,serverActionsManifest:P}=n,T=(0,l.normalizeAppPath)(a),U=!!(b.dynamicRoutes[T]||b.routes[M]),O=async()=>((null==z?void 0:z.render404)?await z.render404(e,t,C,!1):t.end("This page could not be found"),null);if(U&&!E){let e=!!b.routes[M],t=b.dynamicRoutes[T];if(t&&!1===t.fallback&&!e){if(A.experimental.adapterPath)return await O();throw new g.NoFallbackError}}let S=null;!U||x.isDev||E||(S=M,S="/index"===S?"/":S);let _=!0===x.isDev||!U,j=U&&!_;P&&N&&(0,d.setManifestsSingleton)({page:a,clientReferenceManifest:N,serverActionsManifest:P});let H=e.method||"GET",k=(0,o.getTracer)(),B=k.getActiveScopeSpan(),K={params:y,prerenderManifest:b,renderOpts:{experimental:{authInterrupts:!!A.experimental.authInterrupts},cacheComponents:!!A.cacheComponents,supportsDynamicResponse:_,incrementalCache:(0,s.getRequestMeta)(e,"incrementalCache"),cacheLifeProfiles:A.cacheLife,waitUntil:r.waitUntil,onClose:e=>{t.on("close",e)},onAfterTaskError:void 0,onInstrumentationRequestError:(t,r,a,i)=>x.onRequestError(e,t,a,i,z)},sharedContext:{buildId:I}},F=new c.NodeNextRequest(e),$=new c.NodeNextResponse(t),L=u.NextRequestAdapter.fromNodeNextRequest(F,(0,u.signalFromNodeResponse)(t));try{let n=async e=>x.handle(L,K).finally(()=>{if(!e)return;e.setAttributes({"http.status_code":t.statusCode,"next.rsc":!1});let r=k.getRootSpanAttributes();if(!r)return;if(r.get("next.span_type")!==p.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${r.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let i=r.get("next.route");if(i){let t=`${H} ${i}`;e.setAttributes({"next.route":i,"http.route":i,"next.span_name":t}),e.updateName(t)}else e.updateName(`${H} ${a}`)}),d=!!(0,s.getRequestMeta)(e,"minimalMode"),l=async s=>{var o,l;let c=async({previousCacheEntry:i})=>{try{if(!d&&D&&q&&!i)return t.statusCode=404,t.setHeader("x-nextjs-cache","REVALIDATED"),t.end("This page could not be found"),null;let a=await n(s);e.fetchMetrics=K.renderOpts.fetchMetrics;let o=K.renderOpts.pendingWaitUntil;o&&r.waitUntil&&(r.waitUntil(o),o=void 0);let l=K.renderOpts.collectedTags;if(!U)return await (0,h.sendResponse)(F,$,a,K.renderOpts.pendingWaitUntil),null;{let e=await a.blob(),t=(0,v.toNodeOutgoingHttpHeaders)(a.headers);l&&(t[f.NEXT_CACHE_TAGS_HEADER]=l),!t["content-type"]&&e.type&&(t["content-type"]=e.type);let r=void 0!==K.renderOpts.collectedRevalidate&&!(K.renderOpts.collectedRevalidate>=f.INFINITE_CACHE)&&K.renderOpts.collectedRevalidate,i=void 0===K.renderOpts.collectedExpire||K.renderOpts.collectedExpire>=f.INFINITE_CACHE?void 0:K.renderOpts.collectedExpire;return{value:{kind:R.CachedRouteKind.APP_ROUTE,status:a.status,body:Buffer.from(await e.arrayBuffer()),headers:t},cacheControl:{revalidate:r,expire:i}}}}catch(t){throw(null==i?void 0:i.isStale)&&await x.onRequestError(e,t,{routerKind:"App Router",routePath:a,routeType:"route",revalidateReason:(0,m.getRevalidateReason)({isStaticGeneration:j,isOnDemandRevalidate:D})},!1,z),t}},u=await x.handleResponse({req:e,nextConfig:A,cacheKey:S,routeKind:i.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:b,isRoutePPREnabled:!1,isOnDemandRevalidate:D,revalidateOnlyGenerated:q,responseGenerator:c,waitUntil:r.waitUntil,isMinimalMode:d});if(!U)return null;if((null==u||null==(o=u.value)?void 0:o.kind)!==R.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==u||null==(l=u.value)?void 0:l.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});d||t.setHeader("x-nextjs-cache",D?"REVALIDATED":u.isMiss?"MISS":u.isStale?"STALE":"HIT"),E&&t.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let p=(0,v.fromNodeOutgoingHttpHeaders)(u.value.headers);return d&&U||p.delete(f.NEXT_CACHE_TAGS_HEADER),!u.cacheControl||t.getHeader("Cache-Control")||p.get("Cache-Control")||p.set("Cache-Control",(0,w.getCacheControlHeader)(u.cacheControl)),await (0,h.sendResponse)(F,$,new Response(u.value.body,{headers:p,status:u.value.status||200})),null};B?await l(B):await k.withPropagatedContext(e.headers,()=>k.trace(p.BaseServerSpan.handleRequest,{spanName:`${H} ${a}`,kind:o.SpanKind.SERVER,attributes:{"http.method":H,"http.target":e.url}},l))}catch(t){if(t instanceof g.NoFallbackError||await x.onRequestError(e,t,{routerKind:"App Router",routePath:T,routeType:"route",revalidateReason:(0,m.getRevalidateReason)({isStaticGeneration:j,isOnDemandRevalidate:D})},!1,z),U)throw t;return await (0,h.sendResponse)(F,$,new Response(null,{status:500})),null}}e.s(["handler",()=>C,"patchFetch",()=>A,"routeModule",()=>x,"serverHooks",()=>z,"workAsyncStorage",()=>E,"workUnitAsyncStorage",()=>b]),r()}catch(e){r(e)}},!1)];

//# debugId=2259726d-27fc-5b7c-fd24-f21178cbe24a
//# sourceMappingURL=ADK_WORKSPACE_TutorMekimi_tutorme-app_3a07dd4a._.js.map