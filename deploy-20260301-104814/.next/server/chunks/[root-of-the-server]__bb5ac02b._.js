;!function(){try { var e="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof global?global:"undefined"!=typeof window?window:"undefined"!=typeof self?self:{},n=(new e.Error).stack;n&&((e._debugIds|| (e._debugIds={}))[n]="33f37069-9d51-6949-4602-a5ca57c368f6")}catch(e){}}();
module.exports=[917126,e=>{"use strict";let t=/<script\b[^<]*(?:(?!<\/script>)<[^<]*)*<\/script>/gi,a=/\s*on\w+\s*=\s*["'][^"']*["']/gi,r=/javascript\s*:/gi,i=/data\s*:\s*[^,]*\s*,/gi,n=/<(?:iframe|object|embed|form|meta|link)\b[^>]*>/gi;function s(e){return"string"!=typeof e?"":e.replace(t,"").replace(n,"").replace(a,"").replace(r,"").replace(i,"")}function o(e,t=5e4){let a=s(e);return a.length<=t?a:a.slice(0,t)}e.s(["sanitizeHtml",()=>s,"sanitizeHtmlWithMax",()=>o])},444339,e=>{"use strict";var t=e.i(841195);let a=t.z.object({childEmail:t.z.string().email().optional(),childUniqueId:t.z.string().min(8,"Unique ID must be at least 8 characters").optional(),verificationMethod:t.z.enum(["email","id","both"]).optional(),name:t.z.string().min(1).max(100).optional(),grade:t.z.string().optional(),subjects:t.z.array(t.z.string()).optional()}).refine(e=>!!e.childEmail||!!e.childUniqueId,{message:"For security, you must provide either child email or unique ID to link students properly"});t.z.object({children:t.z.array(a).min(1,"You must link at least one child for parent registration"),parentEmail:t.z.string().email("Valid parent email is required"),tosAccepted:t.z.literal(!0,{message:"You must accept the Terms of Service"})});let r=t.z.object({education:t.z.string().max(500,"Education must be less than 500 characters").optional(),experience:t.z.string().max(50,"Experience must be less than 50 characters").optional(),subjects:t.z.array(t.z.string()).min(1,"Please select at least one subject"),gradeLevels:t.z.array(t.z.string()).optional(),hourlyRate:t.z.number().min(0).max(1e4).optional()});t.z.object({phoneNumber:t.z.string().regex(/^\+?[\d\s\-\(\)]{10,}$/,"Valid phone number required").optional(),bio:t.z.string().max(2e3,"Bio must be less than 2000 characters").optional(),timezone:t.z.string().default("Asia/Shanghai"),preferredLanguage:t.z.enum(["zh-CN","en"]).default("zh-CN")}),t.z.object({name:t.z.string().min(1,"Child name is required"),email:t.z.union([t.z.string().email(),t.z.literal("")]).optional(),grade:t.z.string().optional(),subjects:t.z.array(t.z.string()).optional()});let i=t.z.object({name:t.z.string().min(1,"Contact name is required"),relationship:t.z.string().min(1,"Relationship is required"),phone:t.z.string().regex(/^\+?[\d\s\-\(\)]{10,}$/,"Valid phone number required")}),n=t.z.object({email:t.z.boolean().optional(),sms:t.z.boolean().optional(),app:t.z.boolean().optional(),weeklyReports:t.z.boolean().optional(),paymentNotifications:t.z.boolean().optional(),emergencyContacts:t.z.boolean().optional()});t.z.object({phoneNumber:t.z.string().regex(/^\+?[\d\s\-\(\)]{10,}$/,"Valid phone number required"),relationship:t.z.enum(["parent","guardian","step-parent","grandparent","other"]),timezone:t.z.string().default("Asia/Shanghai"),preferredLanguage:t.z.enum(["zh-CN","en"]).default("zh-CN")});let s=t.z.object({name:t.z.string(),relationship:t.z.string(),phone:t.z.string()}),o=t.z.object({students:t.z.array(a).optional().default([]),emergencyContacts:t.z.array(s).max(3).optional(),notificationPreferences:n.optional()}),l=t.z.array(t.z.enum(["user_management","content_management","financial_access","system_settings","analytics"]));t.z.object({phoneNumber:t.z.string().regex(/^\+?[\d\s\-\(\)]{10,}$/,"Valid phone number required"),organizationName:t.z.string().min(2,"Organization name must be at least 2 characters").max(200),organizationSlug:t.z.string().regex(/^[a-z0-9\-]+$/,"Slug: lowercase letters, numbers, hyphens only").optional(),adminLevel:t.z.enum(["super","standard","limited"]),jobTitle:t.z.string().max(100).optional(),department:t.z.string().max(100).optional()}),t.z.object({permissions:l.min(1,"Select at least one permission group"),mfaEnabled:t.z.boolean().default(!0),ipWhitelist:t.z.array(t.z.string().regex(/^(?:[0-9]{1,3}\.){3}[0-9]{1,3}$/,"Invalid IP address")).optional(),timezone:t.z.string().default("Asia/Shanghai"),preferredLanguage:t.z.enum(["zh-CN","en"]).default("zh-CN")});let d=t.z.object({email:t.z.string().email("Please enter a valid email address"),password:t.z.string().min(8,"Password must be at least 8 characters").max(128,"Password too long").regex(/^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)/,"Password must contain at least one uppercase letter, one lowercase letter, and one number"),confirmPassword:t.z.string(),firstName:t.z.string().min(1,"First name is required").max(50),lastName:t.z.string().min(1,"Last name is required").max(50),phoneNumber:t.z.string().regex(/^\+?[\d\s\-\(\)]{10,}$/,"Valid phone number required"),organizationName:t.z.string().min(2,"Organization name is required").max(200),organizationSlug:t.z.string().max(100).optional(),adminLevel:t.z.enum(["super","standard","limited"]),jobTitle:t.z.string().max(100).optional(),department:t.z.string().max(100).optional(),permissions:l.min(1,"Select at least one permission group"),mfaEnabled:t.z.boolean().default(!0),tosAccepted:t.z.boolean().refine(e=>!0===e,{message:"You must accept the Terms of Service"})}).refine(e=>e.password===e.confirmPassword,{message:"Passwords don't match",path:["confirmPassword"]});t.z.object({email:t.z.string().email("Please enter a valid email address"),password:t.z.string().min(8,"Password must be at least 8 characters").regex(/^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)/,"Password must contain at least one uppercase letter, one lowercase letter, and one number"),confirmPassword:t.z.string(),phoneNumber:t.z.string().regex(/^\+?[\d\s\-\(\)]{10,}$/,"Valid phone number required"),relationship:t.z.enum(["parent","guardian","step-parent","grandparent","other"]),timezone:t.z.string().default("Asia/Shanghai"),preferredLanguage:t.z.enum(["zh-CN","en"]).default("zh-CN"),students:t.z.array(a).optional().default([]),emergencyContacts:t.z.array(i).max(3).optional().default([]),notificationPreferences:n.optional().default({}),tosAccepted:t.z.boolean().refine(e=>!0===e,{message:"You must accept the Terms of Service"})}).refine(e=>e.password===e.confirmPassword,{message:"Passwords don't match",path:["confirmPassword"]}),e.s(["adminRegistrationSchema",0,d,"parentAdditionalDataSchema",0,o,"tutorAdditionalDataSchema",0,r],444339)},452242,e=>e.a(async(t,a)=>{try{var r=e.i(620971),i=e.i(323214),n=e.i(738597);e.i(688768);var s=e.i(257357),o=e.i(909105),l=e.i(444339),d=e.i(384030),u=e.i(917126),c=e.i(254799),m=e.i(320947),p=t([n,d]);async function g(e){try{let t,{response:a}=await (0,d.withRateLimitPreset)(e,"register");if(a)return a;try{t=await e.json()}catch{return r.NextResponse.json({error:"Invalid JSON in request body"},{status:400})}let p="true"===process.env.ADMIN_ALLOW_PUBLIC_REGISTRATION,[{count:g}]=await n.drizzleDb.select({count:m.sql`count(*)::int`}).from(s.user).where((0,o.eq)(s.user.role,"ADMIN"));if(g>0&&!p)return r.NextResponse.json({error:"Admin bootstrap is closed"},{status:400});let h=process.env.ADMIN_BOOTSTRAP_KEY;if(h){let t=e.headers.get("x-admin-bootstrap-key");if(!t||t!==h)return r.NextResponse.json({error:"Invalid bootstrap key"},{status:403})}let z=l.adminRegistrationSchema.safeParse(t);if(!z.success){let e=z.error.issues.map(e=>`${e.path.join(".")}: ${e.message}`).join(", ");return r.NextResponse.json({error:e},{status:400})}let f=z.data,b=(0,u.sanitizeHtml)(`${f.firstName} ${f.lastName}`).trim().slice(0,100)||"Admin",R=f.email.toLowerCase().trim(),[w]=await n.drizzleDb.select().from(s.user).where((0,o.eq)(s.user.email,R)).limit(1);if(w)return r.NextResponse.json({error:"Email already registered"},{status:400});let v=await i.default.hash(f.password,10),y=await n.drizzleDb.transaction(async e=>{let t=c.default.randomUUID(),a=c.default.randomUUID();await e.insert(s.user).values({id:t,email:R,password:v,role:"ADMIN",emailVerified:null}),await e.insert(s.profile).values({id:a,userId:t,name:b,tosAccepted:!0,tosAcceptedAt:new Date,organizationName:(0,u.sanitizeHtml)(f.organizationName).trim().slice(0,200)||null,timezone:"Asia/Shanghai",emailNotifications:!0,smsNotifications:!1,subjectsOfInterest:[],preferredLanguages:[],learningGoals:[],isOnboarded:!0,specialties:[],paidClassesEnabled:!1});let r="super"===f.adminLevel?"SUPER_ADMIN":"limited"===f.adminLevel?"MODERATOR":"ADMIN",[i]=await e.select().from(s.adminRole).where((0,o.eq)(s.adminRole.name,r)).limit(1),n=i?.id?i.id:(await e.select().from(s.adminRole).where((0,o.inArray)(s.adminRole.name,["ADMIN","SUPER_ADMIN"])).limit(1))[0]?.id;n&&await e.insert(s.adminAssignment).values({id:c.default.randomUUID(),userId:t,roleId:n,assignedBy:t,isActive:!0});let[l]=await e.select().from(s.user).where((0,o.eq)(s.user.id,t)).limit(1);return l});return r.NextResponse.json({success:!0,message:"Admin account created successfully",user:{id:y.id,name:b,email:y.email,role:y.role,tosAccepted:!0}},{status:201})}catch(e){if(console.error("Admin registration error:",e),e instanceof d.ValidationError||e?.name==="ValidationError")return r.NextResponse.json({error:e.message||"Validation error"},{status:400});if(e&&"object"==typeof e&&"code"in e&&"23505"===e.code)return r.NextResponse.json({error:"Email already registered"},{status:400});return r.NextResponse.json({error:"Internal server error. Please try again."},{status:500})}}[n,d]=p.then?(await p)():p,e.s(["POST",()=>g]),a()}catch(e){a(e)}},!1),392029,e=>e.a(async(t,a)=>{try{var r=e.i(78315),i=e.i(586961),n=e.i(196657),s=e.i(899733),o=e.i(233979),l=e.i(631683),d=e.i(840960),u=e.i(711373),c=e.i(699699),m=e.i(521140),p=e.i(205260),g=e.i(500249),h=e.i(431740),z=e.i(82608),f=e.i(635207),b=e.i(193695);e.i(708038);var R=e.i(447430),w=e.i(452242),v=t([w]);[w]=v.then?(await v)():v;let A=new r.AppRouteRouteModule({definition:{kind:i.RouteKind.APP_ROUTE,page:"/api/auth/register/admin/route",pathname:"/api/auth/register/admin",filename:"route",bundlePath:""},distDir:".next",relativeProjectDir:"",resolvedPagePath:"[project]/ADK_WORKSPACE/TutorMekimi/tutorme-app/src/app/api/auth/register/admin/route.ts",nextConfigOutput:"",userland:w}),{workAsyncStorage:N,workUnitAsyncStorage:E,serverHooks:P}=A;function y(){return(0,n.patchFetch)({workAsyncStorage:N,workUnitAsyncStorage:E})}async function x(e,t,a){A.isDev&&(0,s.addRequestMeta)(e,"devRequestTimingInternalsEnd",process.hrtime.bigint());let r="/api/auth/register/admin/route";r=r.replace(/\/index$/,"")||"/";let n=await A.prepare(e,t,{srcPage:r,multiZoneDraftMode:!1});if(!n)return t.statusCode=400,t.end("Bad Request"),null==a.waitUntil||a.waitUntil.call(a,Promise.resolve()),null;let{buildId:w,params:v,nextConfig:y,parsedUrl:x,isDraftMode:N,prerenderManifest:E,routerServerContext:P,isOnDemandRevalidate:_,revalidateOnlyGenerated:C,resolvedPathname:j,clientReferenceManifest:S,serverActionsManifest:I}=n,T=(0,d.normalizeAppPath)(r),q=!!(E.dynamicRoutes[T]||E.routes[j]),D=async()=>((null==P?void 0:P.render404)?await P.render404(e,t,x,!1):t.end("This page could not be found"),null);if(q&&!N){let e=!!E.routes[j],t=E.dynamicRoutes[T];if(t&&!1===t.fallback&&!e){if(y.experimental.adapterPath)return await D();throw new b.NoFallbackError}}let O=null;!q||A.isDev||N||(O=j,O="/index"===O?"/":O);let U=!0===A.isDev||!q,k=q&&!U;I&&S&&(0,l.setManifestsSingleton)({page:r,clientReferenceManifest:S,serverActionsManifest:I});let M=e.method||"GET",H=(0,o.getTracer)(),L=H.getActiveScopeSpan(),$={params:v,prerenderManifest:E,renderOpts:{experimental:{authInterrupts:!!y.experimental.authInterrupts},cacheComponents:!!y.cacheComponents,supportsDynamicResponse:U,incrementalCache:(0,s.getRequestMeta)(e,"incrementalCache"),cacheLifeProfiles:y.cacheLife,waitUntil:a.waitUntil,onClose:e=>{t.on("close",e)},onAfterTaskError:void 0,onInstrumentationRequestError:(t,a,r,i)=>A.onRequestError(e,t,r,i,P)},sharedContext:{buildId:w}},V=new u.NodeNextRequest(e),K=new u.NodeNextResponse(t),F=c.NextRequestAdapter.fromNodeNextRequest(V,(0,c.signalFromNodeResponse)(t));try{let n=async e=>A.handle(F,$).finally(()=>{if(!e)return;e.setAttributes({"http.status_code":t.statusCode,"next.rsc":!1});let a=H.getRootSpanAttributes();if(!a)return;if(a.get("next.span_type")!==m.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${a.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let i=a.get("next.route");if(i){let t=`${M} ${i}`;e.setAttributes({"next.route":i,"http.route":i,"next.span_name":t}),e.updateName(t)}else e.updateName(`${M} ${r}`)}),l=!!(0,s.getRequestMeta)(e,"minimalMode"),d=async s=>{var o,d;let u=async({previousCacheEntry:i})=>{try{if(!l&&_&&C&&!i)return t.statusCode=404,t.setHeader("x-nextjs-cache","REVALIDATED"),t.end("This page could not be found"),null;let r=await n(s);e.fetchMetrics=$.renderOpts.fetchMetrics;let o=$.renderOpts.pendingWaitUntil;o&&a.waitUntil&&(a.waitUntil(o),o=void 0);let d=$.renderOpts.collectedTags;if(!q)return await (0,g.sendResponse)(V,K,r,$.renderOpts.pendingWaitUntil),null;{let e=await r.blob(),t=(0,h.toNodeOutgoingHttpHeaders)(r.headers);d&&(t[f.NEXT_CACHE_TAGS_HEADER]=d),!t["content-type"]&&e.type&&(t["content-type"]=e.type);let a=void 0!==$.renderOpts.collectedRevalidate&&!($.renderOpts.collectedRevalidate>=f.INFINITE_CACHE)&&$.renderOpts.collectedRevalidate,i=void 0===$.renderOpts.collectedExpire||$.renderOpts.collectedExpire>=f.INFINITE_CACHE?void 0:$.renderOpts.collectedExpire;return{value:{kind:R.CachedRouteKind.APP_ROUTE,status:r.status,body:Buffer.from(await e.arrayBuffer()),headers:t},cacheControl:{revalidate:a,expire:i}}}}catch(t){throw(null==i?void 0:i.isStale)&&await A.onRequestError(e,t,{routerKind:"App Router",routePath:r,routeType:"route",revalidateReason:(0,p.getRevalidateReason)({isStaticGeneration:k,isOnDemandRevalidate:_})},!1,P),t}},c=await A.handleResponse({req:e,nextConfig:y,cacheKey:O,routeKind:i.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:E,isRoutePPREnabled:!1,isOnDemandRevalidate:_,revalidateOnlyGenerated:C,responseGenerator:u,waitUntil:a.waitUntil,isMinimalMode:l});if(!q)return null;if((null==c||null==(o=c.value)?void 0:o.kind)!==R.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==c||null==(d=c.value)?void 0:d.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});l||t.setHeader("x-nextjs-cache",_?"REVALIDATED":c.isMiss?"MISS":c.isStale?"STALE":"HIT"),N&&t.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let m=(0,h.fromNodeOutgoingHttpHeaders)(c.value.headers);return l&&q||m.delete(f.NEXT_CACHE_TAGS_HEADER),!c.cacheControl||t.getHeader("Cache-Control")||m.get("Cache-Control")||m.set("Cache-Control",(0,z.getCacheControlHeader)(c.cacheControl)),await (0,g.sendResponse)(V,K,new Response(c.value.body,{headers:m,status:c.value.status||200})),null};L?await d(L):await H.withPropagatedContext(e.headers,()=>H.trace(m.BaseServerSpan.handleRequest,{spanName:`${M} ${r}`,kind:o.SpanKind.SERVER,attributes:{"http.method":M,"http.target":e.url}},d))}catch(t){if(t instanceof b.NoFallbackError||await A.onRequestError(e,t,{routerKind:"App Router",routePath:T,routeType:"route",revalidateReason:(0,p.getRevalidateReason)({isStaticGeneration:k,isOnDemandRevalidate:_})},!1,P),q)throw t;return await (0,g.sendResponse)(V,K,new Response(null,{status:500})),null}}e.s(["handler",()=>x,"patchFetch",()=>y,"routeModule",()=>A,"serverHooks",()=>P,"workAsyncStorage",()=>N,"workUnitAsyncStorage",()=>E]),a()}catch(e){a(e)}},!1),412171,e=>{e.v(t=>Promise.all(["server/chunks/b1c00_TutorMekimi_tutorme-app_src_lib_security_suspicious-activity_ts_7865686f._.js"].map(t=>e.l(t))).then(()=>t(145830)))},443460,e=>{e.v(t=>Promise.all(["server/chunks/[externals]_ioredis_c74819ca._.js"].map(t=>e.l(t))).then(()=>t(693545)))},571363,e=>{e.v(t=>Promise.all(["server/chunks/ADK_WORKSPACE_TutorMekimi_tutorme-app_src_lib_security_api-key_ts_45091e81._.js"].map(t=>e.l(t))).then(()=>t(175922)))}];

//# debugId=33f37069-9d51-6949-4602-a5ca57c368f6
//# sourceMappingURL=%5Broot-of-the-server%5D__bb5ac02b._.js.map