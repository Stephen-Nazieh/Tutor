;!function(){try { var e="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof global?global:"undefined"!=typeof window?window:"undefined"!=typeof self?self:{},n=(new e.Error).stack;n&&((e._debugIds|| (e._debugIds={}))[n]="62ba70e8-7392-1edc-194a-3c68d8e2391e")}catch(e){}}();
module.exports=[800673,e=>e.a(async(t,r)=>{try{var a=e.i(620971),i=e.i(384030),n=e.i(6286),o=e.i(738597);e.i(688768);var l=e.i(257357);e.i(160373);var s=e.i(819316),c=e.i(909105),u=t([i,n,o]);[i,n,o]=u.then?(await u)():u;let d=(0,i.withCsrf)((0,i.withAuth)(async(e,t)=>{let r,{response:u}=await (0,i.withRateLimitPreset)(e,"paymentCreate");if(u)return u;let{bookingId:d,curriculumId:p,studentId:m,gateway:y}=await e.json(),h=t.user.id,w=(t.user.role||"").toUpperCase();if("PARENT"===w){if(!m||"string"!=typeof m)throw new i.ValidationError("studentId is required when parent creates payment");let e=await (0,n.getFamilyAccountForParent)(t);if(!e||!e.studentIds.includes(m))throw new i.ForbiddenError("You can only create payments for your linked children");h=m}else if("ADMIN"===w)m&&"string"==typeof m&&(h=m);else if("STUDENT"!==w)throw new i.ForbiddenError("Only students, parents, or admins can create payments");if(p){let e,[r]=await o.drizzleDb.select().from(l.curriculum).where((0,c.and)((0,c.eq)(l.curriculum.id,p),(0,c.eq)(l.curriculum.isPublished,!0))).limit(1);if(!r)throw new i.NotFoundError("Curriculum not found");let n=null!=r.price?Number(r.price):0;if(n<=0)throw new i.ValidationError("This course is free; use Enroll instead");let[u]=await o.drizzleDb.select().from(l.curriculumProgress).where((0,c.and)((0,c.eq)(l.curriculumProgress.studentId,h),(0,c.eq)(l.curriculumProgress.curriculumId,p))).limit(1);if(u)throw new i.ValidationError("You are already enrolled in this course");let[d]=await o.drizzleDb.select({email:l.user.email,paymentGatewayPreference:l.profile.paymentGatewayPreference}).from(l.user).leftJoin(l.profile,(0,c.eq)(l.profile.userId,l.user.id)).where((0,c.eq)(l.user.id,h)).limit(1),m=d?.email??"",w=r.currency||"SGD";e=y&&("HITPAY"===y||"AIRWALLEX"===y)?y:d?.paymentGatewayPreference?d.paymentGatewayPreference:process.env.PAYMENT_DEFAULT_GATEWAY||"HITPAY";let f=(0,s.getPaymentGateway)(e),g=(await o.drizzleDb.select().from(l.payment).where((0,c.and)((0,c.isNull)(l.payment.bookingId),(0,c.eq)(l.payment.status,"PENDING"),(0,c.eq)(l.payment.gateway,e))).limit(50)).find(e=>{let t=e.metadata;return t?.type==="course"&&t?.curriculumId===p&&t?.studentId===h});if(g?.gatewayCheckoutUrl)return a.NextResponse.json({checkoutUrl:g.gatewayCheckoutUrl,paymentId:g.id});let I="http://localhost:3003",R=await f.createPayment({amount:n,currency:w,curriculumId:p,studentEmail:m,description:`${r.name} (${r.subject})`,metadata:{type:"course",curriculumId:p,studentId:h,payerId:t.user.id,payerRole:t.user.role},successUrl:`${I}/payment/success?type=course&curriculumId=${encodeURIComponent(p)}`,cancelUrl:`${I}/payment/cancel?type=course&curriculumId=${encodeURIComponent(p)}`}),E=crypto.randomUUID();return await o.drizzleDb.insert(l.payment).values({id:E,bookingId:null,amount:n,currency:w,status:"PENDING",gateway:e,tutorId:r.creatorId??null,gatewayPaymentId:R.paymentId,gatewayCheckoutUrl:R.checkoutUrl,metadata:{type:"course",curriculumId:p,studentId:h,payerId:t.user.id,payerRole:t.user.role}}),a.NextResponse.json({checkoutUrl:R.checkoutUrl,paymentId:E})}if(!d)throw new i.ValidationError("bookingId or curriculumId is required");let[f]=await o.drizzleDb.select({booking:l.clinicBooking,clinic:l.clinic,tutorId:l.clinic.tutorId,clinicTitle:l.clinic.title,clinicSubject:l.clinic.subject,clinicDuration:l.clinic.duration,studentId:l.clinicBooking.studentId}).from(l.clinicBooking).innerJoin(l.clinic,(0,c.eq)(l.clinic.id,l.clinicBooking.clinicId)).where((0,c.eq)(l.clinicBooking.id,d)).limit(1);if(!f)throw new i.NotFoundError("Booking not found");let g=f.booking;if(g.studentId!==h)throw new i.ForbiddenError("You can only create payment for your own booking or your linked child booking");let[I]=await o.drizzleDb.select({userId:l.user.id,hourlyRate:l.profile.hourlyRate,currency:l.profile.currency,paymentGatewayPreference:l.profile.paymentGatewayPreference}).from(l.user).innerJoin(l.profile,(0,c.eq)(l.profile.userId,l.user.id)).where((0,c.eq)(l.user.id,f.tutorId)).limit(1),[R]=await o.drizzleDb.select().from(l.payment).where((0,c.eq)(l.payment.bookingId,d)).limit(1);if(R){if("COMPLETED"===R.status)throw new i.ValidationError("This booking is already paid");if("PENDING"===R.status&&R.gatewayCheckoutUrl)return a.NextResponse.json({checkoutUrl:R.gatewayCheckoutUrl,paymentId:R.id})}let E=I?.hourlyRate??0;if(E<=0)throw new i.ValidationError("This class has no payment amount set");let P=f.clinicDuration/60,b=Math.round(E*P*100)/100,k=I?.currency||"SGD",v=I?.paymentGatewayPreference,A="AIRWALLEX"===v||"HITPAY"===v?v:process.env.PAYMENT_DEFAULT_GATEWAY||"HITPAY",C=(0,s.getPaymentGateway)(A),[T]=await o.drizzleDb.select({email:l.user.email}).from(l.user).where((0,c.eq)(l.user.id,g.studentId)).limit(1),N="http://localhost:3003",U=await C.createPayment({amount:b,currency:k,bookingId:g.id,studentEmail:T?.email??"",description:`${f.clinicTitle} - ${f.clinicSubject}`,metadata:{clinicId:f.clinic.id,clinicTitle:f.clinicTitle},successUrl:`${N}/payment/success?type=booking`,cancelUrl:`${N}/payment/cancel?type=booking`});return R?(await o.drizzleDb.update(l.payment).set({tutorId:f.tutorId,gatewayPaymentId:U.paymentId,gatewayCheckoutUrl:U.checkoutUrl,status:"PENDING"}).where((0,c.eq)(l.payment.id,R.id)),r=R.id):(r=crypto.randomUUID(),await o.drizzleDb.insert(l.payment).values({id:r,bookingId:g.id,amount:b,currency:k,status:"PENDING",gateway:A,tutorId:f.tutorId,gatewayPaymentId:U.paymentId,gatewayCheckoutUrl:U.checkoutUrl})),a.NextResponse.json({checkoutUrl:U.checkoutUrl,paymentId:r})}));e.s(["POST",0,d]),r()}catch(e){r(e)}},!1),523370,e=>e.a(async(t,r)=>{try{var a=e.i(78315),i=e.i(586961),n=e.i(196657),o=e.i(899733),l=e.i(233979),s=e.i(631683),c=e.i(840960),u=e.i(711373),d=e.i(699699),p=e.i(521140),m=e.i(205260),y=e.i(500249),h=e.i(431740),w=e.i(82608),f=e.i(635207),g=e.i(193695);e.i(708038);var I=e.i(447430),R=e.i(800673),E=t([R]);[R]=E.then?(await E)():E;let k=new a.AppRouteRouteModule({definition:{kind:i.RouteKind.APP_ROUTE,page:"/api/payments/create/route",pathname:"/api/payments/create",filename:"route",bundlePath:""},distDir:".next",relativeProjectDir:"",resolvedPagePath:"[project]/ADK_WORKSPACE/TutorMekimi/tutorme-app/src/app/api/payments/create/route.ts",nextConfigOutput:"",userland:R}),{workAsyncStorage:v,workUnitAsyncStorage:A,serverHooks:C}=k;function P(){return(0,n.patchFetch)({workAsyncStorage:v,workUnitAsyncStorage:A})}async function b(e,t,r){k.isDev&&(0,o.addRequestMeta)(e,"devRequestTimingInternalsEnd",process.hrtime.bigint());let a="/api/payments/create/route";a=a.replace(/\/index$/,"")||"/";let n=await k.prepare(e,t,{srcPage:a,multiZoneDraftMode:!1});if(!n)return t.statusCode=400,t.end("Bad Request"),null==r.waitUntil||r.waitUntil.call(r,Promise.resolve()),null;let{buildId:R,params:E,nextConfig:P,parsedUrl:b,isDraftMode:v,prerenderManifest:A,routerServerContext:C,isOnDemandRevalidate:T,revalidateOnlyGenerated:N,resolvedPathname:U,clientReferenceManifest:D,serverActionsManifest:x}=n,q=(0,c.normalizeAppPath)(a),S=!!(A.dynamicRoutes[q]||A.routes[U]),O=async()=>((null==C?void 0:C.render404)?await C.render404(e,t,b,!1):t.end("This page could not be found"),null);if(S&&!v){let e=!!A.routes[U],t=A.dynamicRoutes[q];if(t&&!1===t.fallback&&!e){if(P.experimental.adapterPath)return await O();throw new g.NoFallbackError}}let _=null;!S||k.isDev||v||(_=U,_="/index"===_?"/":_);let z=!0===k.isDev||!S,G=S&&!z;x&&D&&(0,s.setManifestsSingleton)({page:a,clientReferenceManifest:D,serverActionsManifest:x});let H=e.method||"GET",$=(0,l.getTracer)(),M=$.getActiveScopeSpan(),F={params:E,prerenderManifest:A,renderOpts:{experimental:{authInterrupts:!!P.experimental.authInterrupts},cacheComponents:!!P.cacheComponents,supportsDynamicResponse:z,incrementalCache:(0,o.getRequestMeta)(e,"incrementalCache"),cacheLifeProfiles:P.cacheLife,waitUntil:r.waitUntil,onClose:e=>{t.on("close",e)},onAfterTaskError:void 0,onInstrumentationRequestError:(t,r,a,i)=>k.onRequestError(e,t,a,i,C)},sharedContext:{buildId:R}},j=new u.NodeNextRequest(e),L=new u.NodeNextResponse(t),B=d.NextRequestAdapter.fromNodeNextRequest(j,(0,d.signalFromNodeResponse)(t));try{let n=async e=>k.handle(B,F).finally(()=>{if(!e)return;e.setAttributes({"http.status_code":t.statusCode,"next.rsc":!1});let r=$.getRootSpanAttributes();if(!r)return;if(r.get("next.span_type")!==p.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${r.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let i=r.get("next.route");if(i){let t=`${H} ${i}`;e.setAttributes({"next.route":i,"http.route":i,"next.span_name":t}),e.updateName(t)}else e.updateName(`${H} ${a}`)}),s=!!(0,o.getRequestMeta)(e,"minimalMode"),c=async o=>{var l,c;let u=async({previousCacheEntry:i})=>{try{if(!s&&T&&N&&!i)return t.statusCode=404,t.setHeader("x-nextjs-cache","REVALIDATED"),t.end("This page could not be found"),null;let a=await n(o);e.fetchMetrics=F.renderOpts.fetchMetrics;let l=F.renderOpts.pendingWaitUntil;l&&r.waitUntil&&(r.waitUntil(l),l=void 0);let c=F.renderOpts.collectedTags;if(!S)return await (0,y.sendResponse)(j,L,a,F.renderOpts.pendingWaitUntil),null;{let e=await a.blob(),t=(0,h.toNodeOutgoingHttpHeaders)(a.headers);c&&(t[f.NEXT_CACHE_TAGS_HEADER]=c),!t["content-type"]&&e.type&&(t["content-type"]=e.type);let r=void 0!==F.renderOpts.collectedRevalidate&&!(F.renderOpts.collectedRevalidate>=f.INFINITE_CACHE)&&F.renderOpts.collectedRevalidate,i=void 0===F.renderOpts.collectedExpire||F.renderOpts.collectedExpire>=f.INFINITE_CACHE?void 0:F.renderOpts.collectedExpire;return{value:{kind:I.CachedRouteKind.APP_ROUTE,status:a.status,body:Buffer.from(await e.arrayBuffer()),headers:t},cacheControl:{revalidate:r,expire:i}}}}catch(t){throw(null==i?void 0:i.isStale)&&await k.onRequestError(e,t,{routerKind:"App Router",routePath:a,routeType:"route",revalidateReason:(0,m.getRevalidateReason)({isStaticGeneration:G,isOnDemandRevalidate:T})},!1,C),t}},d=await k.handleResponse({req:e,nextConfig:P,cacheKey:_,routeKind:i.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:A,isRoutePPREnabled:!1,isOnDemandRevalidate:T,revalidateOnlyGenerated:N,responseGenerator:u,waitUntil:r.waitUntil,isMinimalMode:s});if(!S)return null;if((null==d||null==(l=d.value)?void 0:l.kind)!==I.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==d||null==(c=d.value)?void 0:c.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});s||t.setHeader("x-nextjs-cache",T?"REVALIDATED":d.isMiss?"MISS":d.isStale?"STALE":"HIT"),v&&t.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let p=(0,h.fromNodeOutgoingHttpHeaders)(d.value.headers);return s&&S||p.delete(f.NEXT_CACHE_TAGS_HEADER),!d.cacheControl||t.getHeader("Cache-Control")||p.get("Cache-Control")||p.set("Cache-Control",(0,w.getCacheControlHeader)(d.cacheControl)),await (0,y.sendResponse)(j,L,new Response(d.value.body,{headers:p,status:d.value.status||200})),null};M?await c(M):await $.withPropagatedContext(e.headers,()=>$.trace(p.BaseServerSpan.handleRequest,{spanName:`${H} ${a}`,kind:l.SpanKind.SERVER,attributes:{"http.method":H,"http.target":e.url}},c))}catch(t){if(t instanceof g.NoFallbackError||await k.onRequestError(e,t,{routerKind:"App Router",routePath:q,routeType:"route",revalidateReason:(0,m.getRevalidateReason)({isStaticGeneration:G,isOnDemandRevalidate:T})},!1,C),S)throw t;return await (0,y.sendResponse)(j,L,new Response(null,{status:500})),null}}e.s(["handler",()=>b,"patchFetch",()=>P,"routeModule",()=>k,"serverHooks",()=>C,"workAsyncStorage",()=>v,"workUnitAsyncStorage",()=>A]),r()}catch(e){r(e)}},!1)];

//# debugId=62ba70e8-7392-1edc-194a-3c68d8e2391e
//# sourceMappingURL=ADK_WORKSPACE_TutorMekimi_tutorme-app_c7ec966d._.js.map