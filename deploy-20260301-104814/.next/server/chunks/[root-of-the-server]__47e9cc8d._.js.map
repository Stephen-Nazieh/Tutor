{
  "version": 3,
  "sources": [],
  "debugId": "b3f556c3-0de2-f982-0699-8725e17d4f05",
  "sections": [
    {"offset": {"line": 1, "column": 0}, "map": {"version":3,"sources":["../../../../../../ADK_WORKSPACE/TutorMekimi/tutorme-app/src/lib/db/index.ts","../../../../../../ADK_WORKSPACE/TutorMekimi/tutorme-app/src/lib/curriculum/lesson-controller.ts"],"sourcesContent":["/* eslint-disable @typescript-eslint/no-explicit-any */\n/* eslint-disable @typescript-eslint/no-require-imports */\n\n/**\n * Database Client with Connection Pooling\n * \n * Features:\n * - Connection pooling for high concurrency (100+ users)\n * - Query caching with Redis\n * - Read replica support for scaling\n * - N+1 query prevention with dataloaders\n * \n * Note: Redis is lazily initialized to avoid bundling issues\n */\n\n// Connection pool configuration\nconst POOL_CONFIG = {\n  // Connection pool settings for 100+ concurrent users\n  min: 5,                    // Minimum connections\n  max: 50,                   // Maximum connections (supports 100+ concurrent users)\n  idleTimeoutMillis: 30000,  // Close idle connections after 30s\n  connectionTimeoutMillis: 5000, // Connection timeout\n  allowExitOnIdle: false,    // Keep pool alive\n}\n\n// Query cache configuration\nconst CACHE_CONFIG = {\n  ttl: 60,                   // Default cache TTL in seconds\n  staleWhileRevalidate: 30,  // Serve stale data while refreshing\n  prefix: 'tutorme:query:',  // Cache key prefix\n}\n\nlet db: any\nlet redis: any | null = null\nlet queryCache: Map<string, { data: any; expires: number }> | null = null\nlet redisInitialized = false\n\n// Safe check for server-side environment (not Edge Runtime)\n// Edge Runtime (used by Next.js middleware) doesn't support Prisma Client\nconst isEdgeRuntime = typeof (globalThis as any).EdgeRuntime !== 'undefined' || \n  (typeof process !== 'undefined' && process.env.NEXT_RUNTIME === 'edge')\nconst isServer = typeof window === 'undefined' && !isEdgeRuntime\n\n// Initialize in-memory cache only on server\nfunction getQueryCache() {\n  if (!isServer) return null\n  if (!queryCache) {\n    queryCache = new Map()\n  }\n  return queryCache\n}\n\n// Initialize Redis client if available (server-side only)\nasync function initRedis() {\n  if (!isServer) return null\n  if (redisInitialized) return redis\n  \n  try {\n    const redisUrl = process.env.REDIS_URL\n    if (!redisUrl) {\n      console.log('[DB] Redis URL not configured, using in-memory cache')\n      redisInitialized = true\n      return null\n    }\n    \n    // Dynamic import to avoid bundling issues\n    const { Redis } = await import('ioredis')\n    redis = new Redis(redisUrl, {\n      retryStrategy: (times) => Math.min(times * 50, 2000),\n      maxRetriesPerRequest: 3,\n    })\n    \n    redis.on('error', (err: any) => {\n      console.error('[Redis] Connection error:', err)\n      redis = null\n    })\n    \n    console.log('[DB] Redis cache initialized')\n    redisInitialized = true\n    return redis\n  } catch (e) {\n    console.warn('[DB] Failed to initialize Redis, using in-memory cache')\n    redisInitialized = true\n    return null\n  }\n}\n\n// Use Drizzle as the default database (server-side only)\nif (isServer) {\n  try {\n    const { drizzleDb } = require('./drizzle')\n    db = drizzleDb\n    console.log('[DB] Drizzle client (default db) initialized')\n  } catch (e) {\n    console.error('[DB] Failed to initialize Drizzle:', e)\n    db = {\n      $connect: async () => {},\n      $disconnect: async () => {},\n    } as any\n  }\n} else {\n  db = {\n    $connect: async () => {},\n    $disconnect: async () => {},\n  } as any\n}\n\n/**\n * Cache utilities\n */\nexport const cache = {\n  /**\n   * Ensure Redis is initialized\n   */\n  async ensureRedis() {\n    if (!isServer) return null\n    if (!redisInitialized) {\n      await initRedis()\n    }\n    return redis\n  },\n\n  /**\n   * Get cached value\n   */\n  async get<T>(key: string): Promise<T | null> {\n    if (!isServer) return null\n    \n    const fullKey = CACHE_CONFIG.prefix + key\n    \n    // Try Redis first\n    const client = await this.ensureRedis()\n    if (client) {\n      try {\n        const value = await client.get(fullKey)\n        if (value) return JSON.parse(value)\n      } catch (e) {\n        console.error('[Cache] Redis get error:', e)\n      }\n    }\n    \n    // Fallback to in-memory cache\n    const cache = getQueryCache()\n    if (!cache) return null\n    \n    const cached = cache.get(fullKey)\n    if (cached && cached.expires > Date.now()) {\n      return cached.data\n    }\n    \n    cache.delete(fullKey)\n    return null\n  },\n  \n  /**\n   * Set cached value\n   */\n  async set<T>(key: string, value: T, ttlSeconds = CACHE_CONFIG.ttl): Promise<void> {\n    if (!isServer) return\n    \n    const fullKey = CACHE_CONFIG.prefix + key\n    \n    // Try Redis first\n    const client = await this.ensureRedis()\n    if (client) {\n      try {\n        await client.setex(fullKey, ttlSeconds, JSON.stringify(value))\n        return\n      } catch (e) {\n        console.error('[Cache] Redis set error:', e)\n      }\n    }\n    \n    // Fallback to in-memory cache\n    const cache = getQueryCache()\n    if (cache) {\n      cache.set(fullKey, {\n        data: value,\n        expires: Date.now() + ttlSeconds * 1000\n      })\n    }\n  },\n  \n  /**\n   * Delete cached value\n   */\n  async delete(key: string): Promise<void> {\n    if (!isServer) return\n    \n    const fullKey = CACHE_CONFIG.prefix + key\n    \n    const client = await this.ensureRedis()\n    if (client) {\n      try {\n        await client.del(fullKey)\n      } catch (e) {\n        console.error('[Cache] Redis del error:', e)\n      }\n    }\n    \n    const cache = getQueryCache()\n    if (cache) cache.delete(fullKey)\n  },\n  \n  /**\n   * Clear all cached values\n   */\n  async clear(): Promise<void> {\n    if (!isServer) return\n    \n    const client = await this.ensureRedis()\n    if (client) {\n      try {\n        const keys = await client.keys(CACHE_CONFIG.prefix + '*')\n        if (keys.length > 0) {\n          await client.del(...keys)\n        }\n      } catch (e) {\n        console.error('[Cache] Redis clear error:', e)\n      }\n    }\n    \n    const cache = getQueryCache()\n    if (cache) cache.clear()\n  },\n  \n  /**\n   * Get or set cached value\n   */\n  async getOrSet<T>(\n    key: string,\n    factory: () => Promise<T>,\n    ttlSeconds = CACHE_CONFIG.ttl\n  ): Promise<T> {\n    const cached = await this.get<T>(key)\n    if (cached !== null) return cached\n    \n    const value = await factory()\n    await this.set(key, value, ttlSeconds)\n    return value\n  },\n\n  /**\n   * Invalidate cache for a pattern\n   */\n  async invalidatePattern(pattern: string): Promise<void> {\n    if (!isServer) return\n    \n    const client = await this.ensureRedis()\n    if (client) {\n      try {\n        const keys = await client.keys(CACHE_CONFIG.prefix + pattern)\n        if (keys.length > 0) {\n          await client.del(...keys)\n        }\n      } catch (e) {\n        console.error('[Cache] Pattern invalidation error:', e)\n      }\n    }\n    \n    // Clear in-memory cache matching pattern\n    const cache = getQueryCache()\n    if (cache) {\n      const regex = new RegExp(CACHE_CONFIG.prefix + pattern.replace('*', '.*'))\n      for (const key of cache.keys()) {\n        if (regex.test(key)) cache.delete(key)\n      }\n    }\n  }\n}\n\n/**\n * Query optimization utilities\n */\nexport const queryOptimizer = {\n  /**\n   * Batch load function for N+1 prevention\n   */\n  async batchLoad<T>(\n    ids: string[],\n    fetchFn: (ids: string[]) => Promise<T[]>,\n    getId: (item: T) => string\n  ): Promise<(T | null)[]> {\n    if (!isServer) return ids.map(() => null)\n    if (ids.length === 0) return []\n    \n    // Deduplicate IDs\n    const uniqueIds = [...new Set(ids)]\n    \n    // Fetch all items in one query\n    const items = await fetchFn(uniqueIds)\n    \n    // Create lookup map\n    const itemMap = new Map(items.map(item => [getId(item), item]))\n    \n    // Return items in original order\n    return ids.map(id => itemMap.get(id) || null)\n  },\n  \n  /**\n   * Wrap a query with caching\n   */\n  async cachedQuery<T>(\n    cacheKey: string,\n    queryFn: () => Promise<T>,\n    ttlSeconds = CACHE_CONFIG.ttl\n  ): Promise<T> {\n    return cache.getOrSet(cacheKey, queryFn, ttlSeconds)\n  }\n}\n\n/**\n * Read replica support (for future scaling)\n */\nexport const readReplica = {\n  /**\n   * Check if read replicas are configured\n   */\n  isConfigured(): boolean {\n    return isServer && !!process.env.DATABASE_READ_REPLICA_URL\n  },\n  \n  /**\n   * Get read-only database client\n   * Falls back to primary if replicas not configured\n   */\n  getClient() {\n    // For now, return the same client\n    // In production, this would return a connection to the read replica\n    return db\n  }\n}\n\nexport { db }\n/** Alias for code that imports prisma from @/lib/db — now points to Drizzle */\nexport const prisma = db\n\n// Server-only code that needs Drizzle: import { drizzleDb } from '@/lib/db/drizzle'\n// Legacy Prisma (scripts, pipl-compliance): import { prismaLegacyClient } from '@/lib/db/prisma-legacy'\n","/**\n * Curriculum Lesson Controller\n * Manages structured lesson flow with AI tutor (Drizzle ORM)\n */\n\nimport { and, eq, inArray, sql } from 'drizzle-orm'\nimport { drizzleDb } from '@/lib/db/drizzle'\nimport {\n  curriculum,\n  curriculumLesson,\n  curriculumLessonProgress,\n  curriculumModule,\n  curriculumProgress,\n  lessonSession,\n} from '@/lib/db/schema'\nimport { chatWithFallback } from '@/lib/ai/orchestrator'\n\nexport type LessonSection = 'introduction' | 'concept' | 'example' | 'practice' | 'review'\n\nexport interface LessonSession {\n  id: string\n  lessonId: string\n  studentId: string\n  status: string\n  currentSection: LessonSection\n  conceptMastery: Record<string, number>\n  misconceptions: string[]\n  sessionContext: any\n  whiteboardItems: any[]\n  startedAt: Date\n  lastActivityAt: Date\n  completedAt?: Date\n}\n\nexport interface LessonAdvanceResult {\n  newSection: LessonSection\n  sectionComplete: boolean\n  lessonComplete: boolean\n}\n\nexport interface UnderstandingAssessment {\n  understandingLevel: number\n  masteredConcepts: string[]\n  strugglingConcepts: string[]\n  readyToAdvance: boolean\n  recommendedAction: 'continue' | 'advance' | 'remediate'\n}\n\nexport interface LessonContent {\n  id: string\n  title: string\n  description?: string\n  duration: number\n  difficulty: string\n  learningObjectives: string[]\n  teachingPoints: string[]\n  keyConcepts: string[]\n  examples: any[]\n  practiceProblems: any[]\n  commonMisconceptions: string[]\n}\n\nconst SECTIONS: LessonSection[] = ['introduction', 'concept', 'example', 'practice', 'review']\n\n/**\n * Start a new lesson session\n */\nexport async function startLesson(\n  studentId: string,\n  lessonId: string\n): Promise<LessonSession> {\n  const [lessonRow] = await drizzleDb\n    .select()\n    .from(curriculumLesson)\n    .where(eq(curriculumLesson.id, lessonId))\n    .limit(1)\n  if (!lessonRow) throw new Error('Lesson not found')\n\n  const [moduleRow] = await drizzleDb\n    .select()\n    .from(curriculumModule)\n    .where(eq(curriculumModule.id, lessonRow.moduleId))\n    .limit(1)\n  if (!moduleRow) throw new Error('Module not found')\n\n  const prerequisiteIds = lessonRow.prerequisiteLessonIds || []\n  if (prerequisiteIds.length > 0) {\n    const [countRow] = await drizzleDb\n      .select({ count: sql<number>`count(*)::int` })\n      .from(curriculumLessonProgress)\n      .where(\n        and(\n          eq(curriculumLessonProgress.studentId, studentId),\n          inArray(curriculumLessonProgress.lessonId, prerequisiteIds),\n          eq(curriculumLessonProgress.status, 'COMPLETED')\n        )\n      )\n    if ((countRow?.count ?? 0) < prerequisiteIds.length) {\n      throw new Error('Prerequisites not met')\n    }\n  }\n\n  const [existingSession] = await drizzleDb\n    .select()\n    .from(lessonSession)\n    .where(\n      and(\n        eq(lessonSession.studentId, studentId),\n        eq(lessonSession.lessonId, lessonId)\n      )\n    )\n    .limit(1)\n  if (existingSession && existingSession.status !== 'completed') {\n    return existingSession as LessonSession\n  }\n\n  await drizzleDb\n    .insert(curriculumLessonProgress)\n    .values({\n      id: crypto.randomUUID(),\n      lessonId,\n      studentId,\n      status: 'IN_PROGRESS',\n      currentSection: 'introduction',\n      updatedAt: new Date(),\n    })\n    .onConflictDoUpdate({\n      target: [\n        curriculumLessonProgress.lessonId,\n        curriculumLessonProgress.studentId,\n      ],\n      set: {\n        status: 'IN_PROGRESS',\n        currentSection: 'introduction',\n      },\n    })\n\n  const [session] = await drizzleDb\n    .insert(lessonSession)\n    .values({\n      id: crypto.randomUUID(),\n      studentId,\n      lessonId,\n      status: 'active',\n      currentSection: 'introduction',\n      conceptMastery: {},\n      misconceptions: [],\n      whiteboardItems: [],\n      sessionContext: {\n        messages: [],\n        currentStep: 0,\n        introductionDone: false,\n        conceptExplained: false,\n        exampleWalked: false,\n        practiceDone: false,\n        reviewDone: false,\n      },\n    })\n    .returning()\n  if (!session) throw new Error('Failed to create lesson session')\n  return session as LessonSession\n}\n\n/**\n * Advance lesson to next section based on student response\n */\nexport async function advanceLesson(\n  session: LessonSession,\n  studentResponse: string\n): Promise<LessonAdvanceResult> {\n  const currentIndex = SECTIONS.indexOf(session.currentSection)\n  \n  // Check if we're at the end\n  if (currentIndex >= SECTIONS.length - 1) {\n    // Mark as complete\n    await completeLesson(session.id)\n    return {\n      newSection: 'review',\n      sectionComplete: true,\n      lessonComplete: true\n    }\n  }\n\n  const nextSection = SECTIONS[currentIndex + 1]\n\n  // Update session context\n  const context = session.sessionContext || {}\n  context[`${session.currentSection}Done`] = true\n  context.currentStep = 0\n\n  await drizzleDb\n    .update(lessonSession)\n    .set({ currentSection: nextSection, sessionContext: context })\n    .where(eq(lessonSession.id, session.id))\n\n  await drizzleDb\n    .update(curriculumLessonProgress)\n    .set({ currentSection: nextSection })\n    .where(\n      and(\n        eq(curriculumLessonProgress.lessonId, session.lessonId),\n        eq(curriculumLessonProgress.studentId, session.studentId)\n      )\n    )\n\n  return {\n    newSection: nextSection,\n    sectionComplete: true,\n    lessonComplete: false\n  }\n}\n\n/**\n * Assess student understanding from conversation\n */\nexport async function assessUnderstanding(\n  conversation: Array<{ role: string; content: string }>,\n  objectives: string[]\n): Promise<UnderstandingAssessment> {\n  // Get recent student messages\n  const studentMessages = conversation\n    .filter(m => m.role === 'user')\n    .slice(-3)\n    .map(m => m.content.toLowerCase())\n    .join(' ')\n\n  // Understanding indicators\n  const positiveIndicators = [\n    'understand', 'got it', 'makes sense', 'clear', 'yes', 'okay', \n    'right', 'correct', '我知道了', '明白', '懂了', '对的', '正确'\n  ]\n  \n  const negativeIndicators = [\n    'confused', \"don't understand\", 'lost', 'difficult', 'hard', \n    'what?', \"don't get\", '不懂', '不明白', '困惑', '难', '不会'\n  ]\n\n  let understandingScore = 50 // baseline\n  \n  positiveIndicators.forEach(indicator => {\n    if (studentMessages.includes(indicator)) understandingScore += 15\n  })\n  \n  negativeIndicators.forEach(indicator => {\n    if (studentMessages.includes(indicator)) understandingScore -= 20\n  })\n\n  // Clamp score\n  understandingScore = Math.max(0, Math.min(100, understandingScore))\n\n  // Determine recommendation\n  let recommendedAction: 'continue' | 'advance' | 'remediate' = 'continue'\n  if (understandingScore >= 75) {\n    recommendedAction = 'advance'\n  } else if (understandingScore < 40) {\n    recommendedAction = 'remediate'\n  }\n\n  return {\n    understandingLevel: understandingScore,\n    masteredConcepts: understandingScore >= 70 ? objectives : [],\n    strugglingConcepts: understandingScore < 50 ? objectives : [],\n    readyToAdvance: understandingScore >= 75,\n    recommendedAction\n  }\n}\n\n/**\n * Build curriculum-aware prompt for AI\n */\nexport function buildCurriculumPrompt(\n  session: LessonSession,\n  lesson: any,\n  studentMessage: string\n): string {\n  const sectionInstructions: Record<LessonSection, string> = {\n    introduction: `\n【引入阶段】\n- 简要介绍本节课的重要性和应用场景（1-2句话）\n- 预览学生将要学习的内容\n- 与之前的知识建立联系（如果相关）\n- 保持简洁有趣，激发学习兴趣\n- 询问学生是否准备好开始学习`,\n\n    concept: `\n【概念教学阶段】\n- 清晰地讲解核心概念\n- 使用提供的教学要点\n- 定义关键术语\n- 提出检查理解的问题\n- 在学生表现出理解之前不要继续\n- 使用苏格拉底式提问引导学生思考`,\n\n    example: `\n【示例讲解阶段】\n- 逐步展示示例\n- 清晰地讲解每一步\n- 让学生预测下一步\n- 解释推理过程\n- 确保学生能跟上节奏`,\n\n    practice: `\n【练习阶段】\n- 给学生一道练习题\n- 先让他们自己尝试\n- 如果卡住了提供提示（不要立即给出答案）\n- 庆祝正确的尝试\n- 解决误解`,\n\n    review: `\n【回顾阶段】\n- 总结关键要点\n- 确认学习目标已达成\n- 预览接下来的内容\n- 祝贺学生完成学习\n- 询问是否还有疑问`\n  }\n\n  const currentSection = session.currentSection\n  const context = session.sessionContext || {}\n\n  return `你是 TutorMe 的 AI 导师，正在进行结构化课程教学。\n\n## 当前课程信息\n课程名称: ${lesson.title}\n课程描述: ${lesson.description || 'N/A'}\n难度级别: ${lesson.difficulty}\n预计时长: ${lesson.duration} 分钟\n\n## 学习目标\n${(lesson.learningObjectives || []).map((obj: string) => `- ${obj}`).join('\\n')}\n\n## 教学要点\n${(lesson.teachingPoints || []).map((point: string) => `- ${point}`).join('\\n')}\n\n## 关键概念\n${(lesson.keyConcepts || []).map((concept: string) => `- ${concept}`).join('\\n')}\n\n## 当前教学阶段\n${sectionInstructions[currentSection]}\n\n## 学习进度\n当前阶段: ${currentSection}\n引入完成: ${context.introductionDone ? '是' : '否'}\n概念讲解完成: ${context.conceptExplained ? '是' : '否'}\n示例讲解完成: ${context.exampleWalked ? '是' : '否'}\n练习完成: ${context.practiceDone ? '是' : '否'}\n回顾完成: ${context.reviewDone ? '是' : '否'}\n\n## 概念掌握度\n${Object.entries(session.conceptMastery || {})\n  .map(([concept, level]) => `- ${concept}: ${level}%`)\n  .join('\\n') || '暂无数据'}\n\n## 常见误解（需要留意）\n${(lesson.commonMisconceptions || []).map((m: string) => `- ${m}`).join('\\n')}\n\n## 教学原则\n1. 严格遵循当前阶段的教学指导\n2. 不要跳到后面的阶段\n3. 在继续之前检查学生的理解\n4. 当学生卡住时使用提示，不要直接给答案\n5. 保持回应集中和结构化\n6. 对公式、定义和步骤使用白板\n7. 使用苏格拉底式教学法，引导学生自己发现答案\n8. 用中文进行教学\n\n## 学生消息\n${studentMessage}\n\n请根据当前阶段指导提供回应。如果需要显示公式、代码或步骤，请在回应后用 JSON 格式提供白板内容。\n\n白板 JSON 格式示例:\n{\n  \"whiteboardItems\": [\n    {\"type\": \"formula\", \"content\": \"E = mc²\", \"caption\": \"质能方程\"},\n    {\"type\": \"code\", \"content\": \"x = 5 + 3\", \"caption\": \"示例代码\"}\n  ],\n  \"understandingLevel\": 80,\n  \"nextSection\": \"concept\"\n}`\n}\n\n/**\n * Get remediation path for struggling student\n */\nexport function getRemediationPath(\n  concept: string,\n  misconception: string\n): string {\n  const remediationStrategies: Record<string, string> = {\n    '基础概念不牢': '建议先复习相关前置知识，使用更简单的例子重新讲解',\n    '计算错误': '建议加强基础运算练习，强调计算步骤的重要性',\n    '理解偏差': '建议用类比和可视化方法重新解释概念',\n    '应用困难': '建议从更简单的应用题开始，逐步增加难度',\n    'default': '建议回顾相关知识点，多做练习巩固理解'\n  }\n\n  return remediationStrategies[misconception] || remediationStrategies['default']\n}\n\n/**\n * Complete a lesson session\n */\nexport async function completeLesson(sessionId: string): Promise<void> {\n  const [sessionRow] = await drizzleDb\n    .select()\n    .from(lessonSession)\n    .where(eq(lessonSession.id, sessionId))\n    .limit(1)\n  if (!sessionRow) return\n\n  const [lessonRow] = await drizzleDb\n    .select()\n    .from(curriculumLesson)\n    .where(eq(curriculumLesson.id, sessionRow.lessonId))\n    .limit(1)\n  if (!lessonRow) return\n\n  const [moduleRow] = await drizzleDb\n    .select()\n    .from(curriculumModule)\n    .where(eq(curriculumModule.id, lessonRow.moduleId))\n    .limit(1)\n  if (!moduleRow) return\n\n  const curriculumId = moduleRow.curriculumId\n  const mastery = (sessionRow.conceptMastery as Record<string, number>) || {}\n  const avgScore =\n    Object.keys(mastery).length > 0\n      ? Object.values(mastery).reduce((a, b) => a + b, 0) / Object.keys(mastery).length\n      : 0\n\n  await drizzleDb.transaction(async (tx) => {\n    await tx\n      .update(lessonSession)\n      .set({ status: 'completed', completedAt: new Date() })\n      .where(eq(lessonSession.id, sessionId))\n\n    await tx\n      .update(curriculumLessonProgress)\n      .set({\n        status: 'COMPLETED',\n        completedAt: new Date(),\n        score: Math.round(avgScore),\n      })\n      .where(\n        and(\n          eq(curriculumLessonProgress.lessonId, sessionRow.lessonId),\n          eq(curriculumLessonProgress.studentId, sessionRow.studentId)\n        )\n      )\n\n    const [totalRow] = await tx\n      .select({\n        count: sql<number>`count(*)::int`,\n      })\n      .from(curriculumLesson)\n      .innerJoin(\n        curriculumModule,\n        eq(curriculumModule.id, curriculumLesson.moduleId)\n      )\n      .where(eq(curriculumModule.curriculumId, curriculumId))\n    const totalLessons = totalRow?.count ?? 0\n\n    const [existing] = await tx\n      .select()\n      .from(curriculumProgress)\n      .where(\n        and(\n          eq(curriculumProgress.studentId, sessionRow.studentId),\n          eq(curriculumProgress.curriculumId, curriculumId)\n        )\n      )\n      .limit(1)\n\n    if (existing) {\n      await tx\n        .update(curriculumProgress)\n        .set({\n          lessonsCompleted: existing.lessonsCompleted + 1,\n          currentLessonId: sessionRow.lessonId,\n          averageScore: avgScore,\n        })\n        .where(\n          and(\n            eq(curriculumProgress.studentId, sessionRow.studentId),\n            eq(curriculumProgress.curriculumId, curriculumId)\n          )\n        )\n    } else {\n      await tx.insert(curriculumProgress).values({\n        id: crypto.randomUUID(),\n        studentId: sessionRow.studentId,\n        curriculumId,\n        lessonsCompleted: 1,\n        totalLessons,\n        currentLessonId: sessionRow.lessonId,\n        averageScore: avgScore,\n        isCompleted: false,\n      })\n    }\n  })\n\n  try {\n    const { onLessonComplete } = await import('@/lib/gamification/triggers')\n    await onLessonComplete(sessionRow.studentId, sessionRow.lessonId)\n  } catch (error) {\n    console.error('Failed to award lesson completion XP:', error)\n  }\n}\n\n/**\n * Get next lesson for student\n */\nexport async function getNextLesson(\n  studentId: string,\n  curriculumId: string\n): Promise<{ lessonId: string; title: string; moduleTitle: string } | null> {\n  const modules = await drizzleDb\n    .select()\n    .from(curriculumModule)\n    .where(eq(curriculumModule.curriculumId, curriculumId))\n    .orderBy(curriculumModule.order)\n\n  for (const mod of modules) {\n    const lessons = await drizzleDb\n      .select()\n      .from(curriculumLesson)\n      .where(eq(curriculumLesson.moduleId, mod.id))\n      .orderBy(curriculumLesson.order)\n\n    for (const lesson of lessons) {\n      const [progress] = await drizzleDb\n        .select()\n        .from(curriculumLessonProgress)\n        .where(\n          and(\n            eq(curriculumLessonProgress.lessonId, lesson.id),\n            eq(curriculumLessonProgress.studentId, studentId)\n          )\n        )\n        .limit(1)\n      if (progress?.status === 'COMPLETED') continue\n\n      const prereqs = lesson.prerequisiteLessonIds || []\n      if (prereqs.length > 0) {\n        const [countRow] = await drizzleDb\n          .select({ count: sql<number>`count(*)::int` })\n          .from(curriculumLessonProgress)\n          .where(\n            and(\n              eq(curriculumLessonProgress.studentId, studentId),\n              inArray(curriculumLessonProgress.lessonId, prereqs),\n              eq(curriculumLessonProgress.status, 'COMPLETED')\n            )\n          )\n        if ((countRow?.count ?? 0) < prereqs.length) continue\n      }\n\n      return {\n        lessonId: lesson.id,\n        title: lesson.title,\n        moduleTitle: mod.title,\n      }\n    }\n  }\n  return null\n}\n\n/**\n * Get student progress overview\n */\nexport async function getStudentProgress(\n  studentId: string,\n  curriculumId: string\n): Promise<{\n  totalLessons: number\n  completedLessons: number\n  currentModule: string\n  overallProgress: number\n}> {\n  const [curriculumRow] = await drizzleDb\n    .select()\n    .from(curriculum)\n    .where(eq(curriculum.id, curriculumId))\n    .limit(1)\n  if (!curriculumRow) throw new Error('Curriculum not found')\n\n  const modules = await drizzleDb\n    .select()\n    .from(curriculumModule)\n    .where(eq(curriculumModule.curriculumId, curriculumId))\n    .orderBy(curriculumModule.order)\n\n  let totalLessons = 0\n  let completedLessons = 0\n  let currentModule = ''\n\n  for (const mod of modules) {\n    const lessons = await drizzleDb\n      .select()\n      .from(curriculumLesson)\n      .where(eq(curriculumLesson.moduleId, mod.id))\n      .orderBy(curriculumLesson.order)\n\n    for (const lesson of lessons) {\n      totalLessons++\n      const [progress] = await drizzleDb\n        .select()\n        .from(curriculumLessonProgress)\n        .where(\n          and(\n            eq(curriculumLessonProgress.lessonId, lesson.id),\n            eq(curriculumLessonProgress.studentId, studentId)\n          )\n        )\n        .limit(1)\n      if (progress?.status === 'COMPLETED') {\n        completedLessons++\n      } else if (\n        !currentModule &&\n        progress?.status === 'IN_PROGRESS'\n      ) {\n        currentModule = mod.title\n      }\n    }\n  }\n\n  return {\n    totalLessons,\n    completedLessons,\n    currentModule:\n      currentModule || modules[0]?.title || '',\n    overallProgress:\n      totalLessons > 0\n        ? Math.round((completedLessons / totalLessons) * 100)\n        : 0,\n  }\n}\n\n/**\n * Get lesson content for teaching\n */\nexport async function getLessonContent(lessonId: string): Promise<LessonContent> {\n  const [lesson] = await drizzleDb\n    .select()\n    .from(curriculumLesson)\n    .where(eq(curriculumLesson.id, lessonId))\n    .limit(1)\n  if (!lesson) throw new Error('Lesson not found')\n\n  return {\n    id: lesson.id,\n    title: lesson.title,\n    description: lesson.description || undefined,\n    duration: lesson.duration,\n    difficulty: lesson.difficulty,\n    learningObjectives: lesson.learningObjectives || [],\n    teachingPoints: lesson.teachingPoints || [],\n    keyConcepts: lesson.keyConcepts || [],\n    examples: (lesson.examples as any[]) || [],\n    practiceProblems: (lesson.practiceProblems as any[]) || [],\n    commonMisconceptions: lesson.commonMisconceptions || [],\n  }\n}\n\n/**\n * Extract whiteboard items from AI response\n */\nexport function extractWhiteboardItems(content: string): Array<{ type: string; content: string; caption?: string }> {\n  const items: Array<{ type: string; content: string; caption?: string }> = []\n\n  // Extract formulas\n  const formulaMatches = content.match(/(?:Formula|公式):?\\s*[`$]?([^`$\\n]+)[`$]?/gi)\n  if (formulaMatches) {\n    formulaMatches.forEach(match => {\n      const clean = match.replace(/(?:Formula|公式):?\\s*[`$]?|[`$]?$/gi, '').trim()\n      if (clean) items.push({ type: 'formula', content: clean })\n    })\n  }\n\n  // Extract code blocks\n  const codeMatches = content.match(/```[\\s\\S]*?```/g)\n  if (codeMatches) {\n    codeMatches.forEach(match => {\n      const clean = match.replace(/```(\\w+)?\\n?/g, '').trim()\n      if (clean) items.push({ type: 'code', content: clean })\n    })\n  }\n\n  // Extract key definitions (simpler regex)\n  const definitionMatches = content.match(/(?:Definition|定义|Key Concept|关键概念):?\\s*([^\\n]+)/gi)\n  if (definitionMatches) {\n    definitionMatches.forEach(match => {\n      const clean = match.replace(/(?:Definition|定义|Key Concept|关键概念):?\\s*/gi, '').trim()\n      if (clean && clean.length < 200) {\n        items.push({ type: 'definition', content: clean })\n      }\n    })\n  }\n\n  return items.slice(0, 5)\n}\n"],"names":[],"mappings":"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"}}]
}