{
  "version": 3,
  "sources": [],
  "debugId": "1cad83f9-13b1-1167-eff9-4416693dcedd",
  "sections": [
    {"offset": {"line": 1, "column": 0}, "map": {"version":3,"sources":["../../../../../../ADK_WORKSPACE/TutorMekimi/tutorme-app/src/lib/security/api-key.ts"],"sourcesContent":["/**\n * API key management: create, verify, revoke.\n * Keys are hashed (SHA-256) before storage; plain key is returned only on create.\n * (Drizzle ORM)\n */\n\nimport crypto from 'crypto'\nimport { desc, eq } from 'drizzle-orm'\nimport { drizzleDb } from '@/lib/db/drizzle'\nimport { apiKey } from '@/lib/db/schema'\n\nconst HASH_ALGO = 'sha256'\nconst KEY_PREFIX = 'tm_'\nconst KEY_BYTES = 32\n\nfunction hashKey(plain: string): string {\n  return crypto.createHash(HASH_ALGO).update(plain).digest('hex')\n}\n\n/**\n * Generate a new API key. Returns { id, name, key } - store `key` securely; it cannot be retrieved again.\n */\nexport async function createApiKey(\n  name: string,\n  createdById?: string\n): Promise<{ id: string; name: string; key: string }> {\n  const raw = crypto.randomBytes(KEY_BYTES).toString('base64url')\n  const key = KEY_PREFIX + raw\n  const keyHash = hashKey(key)\n  const [record] = await drizzleDb\n    .insert(apiKey)\n    .values({ id: crypto.randomUUID(), name, keyHash, createdById })\n    .returning()\n  if (!record) throw new Error('Failed to create API key')\n  return { id: record.id, name: record.name, key }\n}\n\n/**\n * Verify Bearer token and return key record id if valid. Updates lastUsedAt.\n */\nexport async function verifyApiKey(bearerToken: string): Promise<{ id: string } | null> {\n  if (!bearerToken.startsWith(KEY_PREFIX)) return null\n  const keyHash = hashKey(bearerToken)\n  const [record] = await drizzleDb\n    .select()\n    .from(apiKey)\n    .where(eq(apiKey.keyHash, keyHash))\n    .limit(1)\n  if (!record) return null\n  await drizzleDb\n    .update(apiKey)\n    .set({ lastUsedAt: new Date() })\n    .where(eq(apiKey.id, record.id))\n  return { id: record.id }\n}\n\n/**\n * Revoke (delete) an API key by id.\n */\nexport async function revokeApiKey(id: string): Promise<boolean> {\n  const deleted = await drizzleDb\n    .delete(apiKey)\n    .where(eq(apiKey.id, id))\n    .returning({ id: apiKey.id })\n  return deleted.length > 0\n}\n\n/**\n * List API keys (without secret). Optional filter by createdById.\n */\nexport async function listApiKeys(createdById?: string) {\n  const base = drizzleDb\n    .select({\n      id: apiKey.id,\n      name: apiKey.name,\n      createdAt: apiKey.createdAt,\n      lastUsedAt: apiKey.lastUsedAt,\n    })\n    .from(apiKey)\n    .orderBy(desc(apiKey.createdAt))\n  return createdById\n    ? base.where(eq(apiKey.createdById, createdById))\n    : base\n}\n"],"names":[],"mappings":"+CAMA,IAAA,EAAA,EAAA,CAAA,CAAA,QACA,EAAA,EAAA,CAAA,CAAA,QAAA,EAAA,EAAA,CAAA,CAAA,QACA,EAAA,EAAA,CAAA,CAAA,QACA,EAAA,CAAA,CAAA,QAAA,IAAA,EAAA,EAAA,CAAA,CAAA,iBAMA,SAAS,EAAQ,CAAa,EAC5B,OAAO,EAAA,OAAM,CAAC,UAAU,CALR,AAKS,UAAW,MAAM,CAAC,GAAO,MAAM,CAAC,MAC3D,CAKO,eAAe,EACpB,CAAY,CACZ,CAAoB,EAEpB,IAAM,EAAM,EAAA,OAAM,CAAC,WAAW,CAAC,AAbf,IAa0B,QAAQ,CAAC,aAC7C,EAAM,MAAa,EACnB,EAAU,EAAQ,GAClB,CAAC,EAAO,CAAG,MAAM,EAAA,SAAS,CAC7B,MAAM,CAAC,EAAA,MAAM,EACb,MAAM,CAAC,CAAE,GAAI,EAAA,OAAM,CAAC,UAAU,GAAI,eAAM,cAAS,CAAY,GAC7D,SAAS,GACZ,GAAI,CAAC,EAAQ,MAAM,AAAI,MAAM,4BAC7B,MAAO,CAAE,GAAI,EAAO,EAAE,CAAE,KAAM,EAAO,IAAI,KAAE,CAAI,CACjD,CAKO,eAAe,EAAa,CAAmB,EACpD,GAAI,CAAC,EAAY,UAAU,CAAC,AA7BX,OA6BwB,OAAO,KAChD,IAAM,EAAU,EAAQ,GAClB,CAAC,EAAO,CAAG,MAAM,EAAA,SAAS,CAC7B,MAAM,GACN,IAAI,CAAC,EAAA,MAAM,EACX,KAAK,CAAC,CAAA,EAAA,EAAA,EAAA,AAAE,EAAC,EAAA,MAAM,CAAC,OAAO,CAAE,IACzB,KAAK,CAAC,UACT,AAAK,GACL,CADI,IAAS,CACP,EAAA,SAAS,CACZ,MAAM,CAAC,EAAA,MAAM,EACb,GAAG,CAAC,CAAE,WAAY,IAAI,IAAO,GAC7B,KAAK,CAAC,CAAA,EAAA,EAAA,EAAA,AAAE,EAAC,EAAA,MAAM,CAAC,EAAE,CAAE,EAAO,EAAE,GACzB,CAAE,GAAI,EAAO,EAAE,AAAC,GALH,IAMtB,CAKO,eAAe,EAAa,CAAU,EAK3C,MAJgB,AAIT,OAJe,EAAA,SAAS,CAC5B,MAAM,CAAC,EAAA,MAAM,EACb,KAAK,CAAC,CAAA,EAAA,EAAA,EAAA,AAAE,EAAC,EAAA,MAAM,CAAC,EAAE,CAAE,IACpB,SAAS,CAAC,CAAE,GAAI,EAAA,MAAM,CAAC,EAAE,AAAC,EAAA,EACd,MAAM,CAAG,CAC1B,CAKO,eAAe,EAAY,CAAoB,EACpD,IAAM,EAAO,EAAA,SAAS,CACnB,MAAM,CAAC,CACN,GAAI,EAAA,MAAM,CAAC,EAAE,CACb,KAAM,EAAA,MAAM,CAAC,IAAI,CACjB,UAAW,EAAA,MAAM,CAAC,SAAS,CAC3B,WAAY,EAAA,MAAM,CAAC,UAAU,AAC/B,GACC,IAAI,CAAC,EAAA,MAAM,EACX,OAAO,CAAC,CAAA,EAAA,EAAA,IAAA,AAAI,EAAC,EAAA,MAAM,CAAC,SAAS,GAChC,OAAO,EACH,EAAK,KAAK,CAAC,CAAA,EAAA,EAAA,EAAA,AAAE,EAAC,EAAA,MAAM,CAAC,WAAW,CAAE,IAClC,CACN"}}]
}