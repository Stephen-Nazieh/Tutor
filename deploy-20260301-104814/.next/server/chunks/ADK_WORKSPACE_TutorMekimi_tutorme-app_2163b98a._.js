;!function(){try { var e="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof global?global:"undefined"!=typeof window?window:"undefined"!=typeof self?self:{},n=(new e.Error).stack;n&&((e._debugIds|| (e._debugIds={}))[n]="a986d0bd-e5e7-2586-29de-1cc9cff3be49")}catch(e){}}();
module.exports=[467770,e=>e.a(async(t,s)=>{try{var a=e.i(620971),n=e.i(384030),i=e.i(738597);e.i(688768);var r=e.i(257357),o=e.i(909105),l=e.i(997103),d=e.i(748846),u=e.i(930140),c=e.i(254799),p=t([n,i,u]);[n,i,u]=p.then?(await p)():p;let g=(0,n.withAuth)(async(e,t)=>{let s=t.user.id,n=(await i.drizzleDb.select().from(r.aIAssistantSession).where((0,o.and)((0,o.eq)(r.aIAssistantSession.tutorId,s),(0,o.eq)(r.aIAssistantSession.status,"active"))).orderBy((0,l.desc)(r.aIAssistantSession.updatedAt)).limit(1))[0]??null;if(!n){let e=(0,c.randomUUID)();await i.drizzleDb.insert(r.aIAssistantSession).values({id:e,tutorId:s,title:"AI Teaching Assistant",status:"active"}),await i.drizzleDb.insert(r.aIAssistantMessage).values({id:(0,c.randomUUID)(),sessionId:e,role:"assistant",content:"Hello! I'm your AI Teaching Assistant. I can help you with:\n\n• Lesson plan ideas\n• Explaining complex topics\n• Analyzing student performance\n• Generating practice questions\n• Teaching strategies\n\nWhat would you like help with today?"});let[t]=await i.drizzleDb.select().from(r.aIAssistantSession).where((0,o.eq)(r.aIAssistantSession.id,e)).limit(1);n=t}let d=n.id,u=await i.drizzleDb.select().from(r.aIAssistantMessage).where((0,o.eq)(r.aIAssistantMessage.sessionId,d)).orderBy((0,l.asc)(r.aIAssistantMessage.createdAt)).limit(50),p=await i.drizzleDb.select().from(r.aIAssistantInsight).where((0,o.eq)(r.aIAssistantInsight.sessionId,d)).orderBy((0,l.desc)(r.aIAssistantInsight.createdAt)).limit(10),h={...n,messages:u,insights:p};return a.NextResponse.json({session:h})},{role:"TUTOR"}),A=(0,n.withAuth)(async(e,t)=>{let s=t.user.id;try{let{message:t,sessionId:n,context:p}=await e.json();if(!t)return a.NextResponse.json({error:"Message is required"},{status:400});let g=u.AISecurityManager.sanitizeAiInput(String(t));if(!g)return a.NextResponse.json({error:"Invalid or empty message after sanitization"},{status:400});let A=null;if(n&&(A=(await i.drizzleDb.select().from(r.aIAssistantSession).where((0,o.and)((0,o.eq)(r.aIAssistantSession.id,n),(0,o.eq)(r.aIAssistantSession.tutorId,s))).limit(1))[0]??null),!A){let e=(0,c.randomUUID)();await i.drizzleDb.insert(r.aIAssistantSession).values({id:e,tutorId:s,title:p?`Chat about ${p}`:"AI Teaching Assistant",context:p??null,status:"active"});let[t]=await i.drizzleDb.select().from(r.aIAssistantSession).where((0,o.eq)(r.aIAssistantSession.id,e)).limit(1);A=t}await i.drizzleDb.insert(r.aIAssistantMessage).values({id:(0,c.randomUUID)(),sessionId:A.id,role:"user",content:g});let I=(await i.drizzleDb.select().from(r.aIAssistantMessage).where((0,o.eq)(r.aIAssistantMessage.sessionId,A.id)).orderBy((0,l.desc)(r.aIAssistantMessage.createdAt)).limit(10)).reverse().map(e=>({role:e.role,content:"user"===e.role?u.AISecurityManager.sanitizeAiInput(e.content||""):e.content||""})),w=`You are an AI Teaching Assistant helping tutors improve their teaching. 
You can help with lesson planning, explaining concepts, student engagement strategies, and content creation.
Be concise, practical, and encouraging. Provide specific examples when possible.`,m=await (0,d.chatWithFallback)([{role:"system",content:w},...I]),R="string"==typeof m?m:m.content,y=await i.drizzleDb.insert(r.aIAssistantMessage).values({id:(0,c.randomUUID)(),sessionId:A.id,role:"assistant",content:R,metadata:{model:"fallback",timestamp:new Date().toISOString()}}).returning().then(e=>e[0]);await i.drizzleDb.update(r.aIAssistantSession).set({updatedAt:new Date}).where((0,o.eq)(r.aIAssistantSession.id,A.id));let f=await u.AISecurityManager.validateAiResponse(R);if(!f.isValid&&"CRITICAL"===f.severity)return a.NextResponse.json({error:"AI response failed security validation"},{status:500});return await h(A.id,s,g,R),a.NextResponse.json({message:y,session:A})}catch(e){return console.error("AI Assistant error:",e),a.NextResponse.json({error:"Failed to process message"},{status:500})}},{role:"TUTOR"});async function h(e,t,s,a){let n=s.toLowerCase();for(let t of[{type:"lesson_idea",keywords:["lesson","plan","teach","topic","subject"],title:"Lesson Plan Suggestion"},{type:"student_analysis",keywords:["student","struggling","difficulty","performance"],title:"Student Support Strategy"},{type:"content_suggestion",keywords:["material","content","resource","worksheet","quiz"],title:"Content Resource Idea"},{type:"engagement_tip",keywords:["engage","attention","participation","interactive"],title:"Engagement Tip"}])if(t.keywords.some(e=>n.includes(e))){let s=new Date(Date.now()-36e5);(await i.drizzleDb.select().from(r.aIAssistantInsight).where((0,o.and)((0,o.eq)(r.aIAssistantInsight.sessionId,e),(0,o.eq)(r.aIAssistantInsight.type,t.type),(0,o.gte)(r.aIAssistantInsight.createdAt,s))).limit(1)).length>0||await i.drizzleDb.insert(r.aIAssistantInsight).values({id:(0,c.randomUUID)(),sessionId:e,type:t.type,title:t.title,content:a.slice(0,500),applied:!1});break}}e.s(["GET",0,g,"POST",0,A]),s()}catch(e){s(e)}},!1),304093,e=>e.a(async(t,s)=>{try{var a=e.i(78315),n=e.i(586961),i=e.i(196657),r=e.i(899733),o=e.i(233979),l=e.i(631683),d=e.i(840960),u=e.i(711373),c=e.i(699699),p=e.i(521140),h=e.i(205260),g=e.i(500249),A=e.i(431740),I=e.i(82608),w=e.i(635207),m=e.i(193695);e.i(708038);var R=e.i(447430),y=e.i(467770),f=t([y]);[y]=f.then?(await f)():f;let E=new a.AppRouteRouteModule({definition:{kind:n.RouteKind.APP_ROUTE,page:"/api/tutor/ai-assistant/route",pathname:"/api/tutor/ai-assistant",filename:"route",bundlePath:""},distDir:".next",relativeProjectDir:"",resolvedPagePath:"[project]/ADK_WORKSPACE/TutorMekimi/tutorme-app/src/app/api/tutor/ai-assistant/route.ts",nextConfigOutput:"",userland:y}),{workAsyncStorage:b,workUnitAsyncStorage:x,serverHooks:C}=E;function v(){return(0,i.patchFetch)({workAsyncStorage:b,workUnitAsyncStorage:x})}async function S(e,t,s){E.isDev&&(0,r.addRequestMeta)(e,"devRequestTimingInternalsEnd",process.hrtime.bigint());let a="/api/tutor/ai-assistant/route";a=a.replace(/\/index$/,"")||"/";let i=await E.prepare(e,t,{srcPage:a,multiZoneDraftMode:!1});if(!i)return t.statusCode=400,t.end("Bad Request"),null==s.waitUntil||s.waitUntil.call(s,Promise.resolve()),null;let{buildId:y,params:f,nextConfig:v,parsedUrl:S,isDraftMode:b,prerenderManifest:x,routerServerContext:C,isOnDemandRevalidate:D,revalidateOnlyGenerated:T,resolvedPathname:z,clientReferenceManifest:U,serverActionsManifest:q}=i,N=(0,d.normalizeAppPath)(a),P=!!(x.dynamicRoutes[N]||x.routes[z]),M=async()=>((null==C?void 0:C.render404)?await C.render404(e,t,S,!1):t.end("This page could not be found"),null);if(P&&!b){let e=!!x.routes[z],t=x.dynamicRoutes[N];if(t&&!1===t.fallback&&!e){if(v.experimental.adapterPath)return await M();throw new m.NoFallbackError}}let O=null;!P||E.isDev||b||(O=z,O="/index"===O?"/":O);let _=!0===E.isDev||!P,k=P&&!_;q&&U&&(0,l.setManifestsSingleton)({page:a,clientReferenceManifest:U,serverActionsManifest:q});let H=e.method||"GET",j=(0,o.getTracer)(),B=j.getActiveScopeSpan(),F={params:f,prerenderManifest:x,renderOpts:{experimental:{authInterrupts:!!v.experimental.authInterrupts},cacheComponents:!!v.cacheComponents,supportsDynamicResponse:_,incrementalCache:(0,r.getRequestMeta)(e,"incrementalCache"),cacheLifeProfiles:v.cacheLife,waitUntil:s.waitUntil,onClose:e=>{t.on("close",e)},onAfterTaskError:void 0,onInstrumentationRequestError:(t,s,a,n)=>E.onRequestError(e,t,a,n,C)},sharedContext:{buildId:y}},K=new u.NodeNextRequest(e),$=new u.NodeNextResponse(t),L=c.NextRequestAdapter.fromNodeNextRequest(K,(0,c.signalFromNodeResponse)(t));try{let i=async e=>E.handle(L,F).finally(()=>{if(!e)return;e.setAttributes({"http.status_code":t.statusCode,"next.rsc":!1});let s=j.getRootSpanAttributes();if(!s)return;if(s.get("next.span_type")!==p.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${s.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let n=s.get("next.route");if(n){let t=`${H} ${n}`;e.setAttributes({"next.route":n,"http.route":n,"next.span_name":t}),e.updateName(t)}else e.updateName(`${H} ${a}`)}),l=!!(0,r.getRequestMeta)(e,"minimalMode"),d=async r=>{var o,d;let u=async({previousCacheEntry:n})=>{try{if(!l&&D&&T&&!n)return t.statusCode=404,t.setHeader("x-nextjs-cache","REVALIDATED"),t.end("This page could not be found"),null;let a=await i(r);e.fetchMetrics=F.renderOpts.fetchMetrics;let o=F.renderOpts.pendingWaitUntil;o&&s.waitUntil&&(s.waitUntil(o),o=void 0);let d=F.renderOpts.collectedTags;if(!P)return await (0,g.sendResponse)(K,$,a,F.renderOpts.pendingWaitUntil),null;{let e=await a.blob(),t=(0,A.toNodeOutgoingHttpHeaders)(a.headers);d&&(t[w.NEXT_CACHE_TAGS_HEADER]=d),!t["content-type"]&&e.type&&(t["content-type"]=e.type);let s=void 0!==F.renderOpts.collectedRevalidate&&!(F.renderOpts.collectedRevalidate>=w.INFINITE_CACHE)&&F.renderOpts.collectedRevalidate,n=void 0===F.renderOpts.collectedExpire||F.renderOpts.collectedExpire>=w.INFINITE_CACHE?void 0:F.renderOpts.collectedExpire;return{value:{kind:R.CachedRouteKind.APP_ROUTE,status:a.status,body:Buffer.from(await e.arrayBuffer()),headers:t},cacheControl:{revalidate:s,expire:n}}}}catch(t){throw(null==n?void 0:n.isStale)&&await E.onRequestError(e,t,{routerKind:"App Router",routePath:a,routeType:"route",revalidateReason:(0,h.getRevalidateReason)({isStaticGeneration:k,isOnDemandRevalidate:D})},!1,C),t}},c=await E.handleResponse({req:e,nextConfig:v,cacheKey:O,routeKind:n.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:x,isRoutePPREnabled:!1,isOnDemandRevalidate:D,revalidateOnlyGenerated:T,responseGenerator:u,waitUntil:s.waitUntil,isMinimalMode:l});if(!P)return null;if((null==c||null==(o=c.value)?void 0:o.kind)!==R.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==c||null==(d=c.value)?void 0:d.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});l||t.setHeader("x-nextjs-cache",D?"REVALIDATED":c.isMiss?"MISS":c.isStale?"STALE":"HIT"),b&&t.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let p=(0,A.fromNodeOutgoingHttpHeaders)(c.value.headers);return l&&P||p.delete(w.NEXT_CACHE_TAGS_HEADER),!c.cacheControl||t.getHeader("Cache-Control")||p.get("Cache-Control")||p.set("Cache-Control",(0,I.getCacheControlHeader)(c.cacheControl)),await (0,g.sendResponse)(K,$,new Response(c.value.body,{headers:p,status:c.value.status||200})),null};B?await d(B):await j.withPropagatedContext(e.headers,()=>j.trace(p.BaseServerSpan.handleRequest,{spanName:`${H} ${a}`,kind:o.SpanKind.SERVER,attributes:{"http.method":H,"http.target":e.url}},d))}catch(t){if(t instanceof m.NoFallbackError||await E.onRequestError(e,t,{routerKind:"App Router",routePath:N,routeType:"route",revalidateReason:(0,h.getRevalidateReason)({isStaticGeneration:k,isOnDemandRevalidate:D})},!1,C),P)throw t;return await (0,g.sendResponse)(K,$,new Response(null,{status:500})),null}}e.s(["handler",()=>S,"patchFetch",()=>v,"routeModule",()=>E,"serverHooks",()=>C,"workAsyncStorage",()=>b,"workUnitAsyncStorage",()=>x]),s()}catch(e){s(e)}},!1)];

//# debugId=a986d0bd-e5e7-2586-29de-1cc9cff3be49
//# sourceMappingURL=ADK_WORKSPACE_TutorMekimi_tutorme-app_2163b98a._.js.map