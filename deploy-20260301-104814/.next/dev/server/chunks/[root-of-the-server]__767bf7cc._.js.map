{
  "version": 3,
  "sources": [],
  "debugId": "902a1c8d-3812-1615-ede7-e8594ea9ff5c",
  "sections": [
    {"offset": {"line": 101, "column": 0}, "map": {"version":3,"sources":["file:///Users/nazy/ADK_WORKSPACE/TutorMekimi/tutorme-app/src/lib/db/index.ts"],"sourcesContent":["/* eslint-disable @typescript-eslint/no-explicit-any */\n/* eslint-disable @typescript-eslint/no-require-imports */\n\n/**\n * Database Client with Connection Pooling\n * \n * Features:\n * - Connection pooling for high concurrency (100+ users)\n * - Query caching with Redis\n * - Read replica support for scaling\n * - N+1 query prevention with dataloaders\n * \n * Note: Redis is lazily initialized to avoid bundling issues\n */\n\n// Connection pool configuration\nconst POOL_CONFIG = {\n  // Connection pool settings for 100+ concurrent users\n  min: 5,                    // Minimum connections\n  max: 50,                   // Maximum connections (supports 100+ concurrent users)\n  idleTimeoutMillis: 30000,  // Close idle connections after 30s\n  connectionTimeoutMillis: 5000, // Connection timeout\n  allowExitOnIdle: false,    // Keep pool alive\n}\n\n// Query cache configuration\nconst CACHE_CONFIG = {\n  ttl: 60,                   // Default cache TTL in seconds\n  staleWhileRevalidate: 30,  // Serve stale data while refreshing\n  prefix: 'tutorme:query:',  // Cache key prefix\n}\n\nlet db: any\nlet redis: any | null = null\nlet queryCache: Map<string, { data: any; expires: number }> | null = null\nlet redisInitialized = false\n\n// Safe check for server-side environment (not Edge Runtime)\n// Edge Runtime (used by Next.js middleware) doesn't support Prisma Client\nconst isEdgeRuntime = typeof (globalThis as any).EdgeRuntime !== 'undefined' || \n  (typeof process !== 'undefined' && process.env.NEXT_RUNTIME === 'edge')\nconst isServer = typeof window === 'undefined' && !isEdgeRuntime\n\n// Initialize in-memory cache only on server\nfunction getQueryCache() {\n  if (!isServer) return null\n  if (!queryCache) {\n    queryCache = new Map()\n  }\n  return queryCache\n}\n\n// Initialize Redis client if available (server-side only)\nasync function initRedis() {\n  if (!isServer) return null\n  if (redisInitialized) return redis\n  \n  try {\n    const redisUrl = process.env.REDIS_URL\n    if (!redisUrl) {\n      console.log('[DB] Redis URL not configured, using in-memory cache')\n      redisInitialized = true\n      return null\n    }\n    \n    // Dynamic import to avoid bundling issues\n    const { Redis } = await import('ioredis')\n    redis = new Redis(redisUrl, {\n      retryStrategy: (times) => Math.min(times * 50, 2000),\n      maxRetriesPerRequest: 3,\n    })\n    \n    redis.on('error', (err: any) => {\n      console.error('[Redis] Connection error:', err)\n      redis = null\n    })\n    \n    console.log('[DB] Redis cache initialized')\n    redisInitialized = true\n    return redis\n  } catch (e) {\n    console.warn('[DB] Failed to initialize Redis, using in-memory cache')\n    redisInitialized = true\n    return null\n  }\n}\n\n// Initialize Prisma Client with connection pooling (server-side only)\nif (isServer) {\n  try {\n    const { PrismaClient } = require('@prisma/client')\n    \n    const globalForPrisma = globalThis as unknown as {\n      prisma: typeof PrismaClient | undefined\n      redis: any | null\n      redisInitialized: boolean\n    }\n    \n    // Initialize Redis on first use (lazy initialization)\n    if (globalForPrisma.redisInitialized) {\n      redis = globalForPrisma.redis\n      redisInitialized = true\n    }\n    \n    if (process.env.NODE_ENV !== 'production') {\n      globalForPrisma.redis = redis\n      globalForPrisma.redisInitialized = redisInitialized\n    }\n    \n    // Initialize Prisma with connection pooling\n    if (globalForPrisma.prisma) {\n      db = globalForPrisma.prisma\n    } else {\n      db = new PrismaClient({\n        log: process.env.NODE_ENV === 'development' \n          ? ['query', 'error', 'warn'] \n          : ['error'],\n        \n        // Connection pooling configuration\n        datasources: {\n          db: {\n            url: process.env.DATABASE_URL,\n          },\n        },\n      })\n      \n      // Add connection pool monitoring\n      db.$on('query', (e: any) => {\n        if (process.env.NODE_ENV === 'development') {\n          console.log('[Prisma Query]', e.query, `${e.duration}ms`)\n        }\n      })\n      \n      if (process.env.NODE_ENV !== 'production') {\n        globalForPrisma.prisma = db\n      }\n    }\n    \n    console.log('[DB] Prisma Client initialized with connection pooling')\n  } catch (e) {\n    console.error('[DB] Failed to initialize Prisma:', e)\n    // Fallback for build time\n    db = {\n      $connect: async () => {},\n      $disconnect: async () => {},\n    }\n  }\n} else {\n  // Client-side mock\n  db = {\n    $connect: async () => {},\n    $disconnect: async () => {},\n  }\n}\n\n/**\n * Cache utilities\n */\nexport const cache = {\n  /**\n   * Ensure Redis is initialized\n   */\n  async ensureRedis() {\n    if (!isServer) return null\n    if (!redisInitialized) {\n      await initRedis()\n    }\n    return redis\n  },\n\n  /**\n   * Get cached value\n   */\n  async get<T>(key: string): Promise<T | null> {\n    if (!isServer) return null\n    \n    const fullKey = CACHE_CONFIG.prefix + key\n    \n    // Try Redis first\n    const client = await this.ensureRedis()\n    if (client) {\n      try {\n        const value = await client.get(fullKey)\n        if (value) return JSON.parse(value)\n      } catch (e) {\n        console.error('[Cache] Redis get error:', e)\n      }\n    }\n    \n    // Fallback to in-memory cache\n    const cache = getQueryCache()\n    if (!cache) return null\n    \n    const cached = cache.get(fullKey)\n    if (cached && cached.expires > Date.now()) {\n      return cached.data\n    }\n    \n    cache.delete(fullKey)\n    return null\n  },\n  \n  /**\n   * Set cached value\n   */\n  async set<T>(key: string, value: T, ttlSeconds = CACHE_CONFIG.ttl): Promise<void> {\n    if (!isServer) return\n    \n    const fullKey = CACHE_CONFIG.prefix + key\n    \n    // Try Redis first\n    const client = await this.ensureRedis()\n    if (client) {\n      try {\n        await client.setex(fullKey, ttlSeconds, JSON.stringify(value))\n        return\n      } catch (e) {\n        console.error('[Cache] Redis set error:', e)\n      }\n    }\n    \n    // Fallback to in-memory cache\n    const cache = getQueryCache()\n    if (cache) {\n      cache.set(fullKey, {\n        data: value,\n        expires: Date.now() + ttlSeconds * 1000\n      })\n    }\n  },\n  \n  /**\n   * Delete cached value\n   */\n  async delete(key: string): Promise<void> {\n    if (!isServer) return\n    \n    const fullKey = CACHE_CONFIG.prefix + key\n    \n    const client = await this.ensureRedis()\n    if (client) {\n      try {\n        await client.del(fullKey)\n      } catch (e) {\n        console.error('[Cache] Redis del error:', e)\n      }\n    }\n    \n    const cache = getQueryCache()\n    if (cache) cache.delete(fullKey)\n  },\n  \n  /**\n   * Clear all cached values\n   */\n  async clear(): Promise<void> {\n    if (!isServer) return\n    \n    const client = await this.ensureRedis()\n    if (client) {\n      try {\n        const keys = await client.keys(CACHE_CONFIG.prefix + '*')\n        if (keys.length > 0) {\n          await client.del(...keys)\n        }\n      } catch (e) {\n        console.error('[Cache] Redis clear error:', e)\n      }\n    }\n    \n    const cache = getQueryCache()\n    if (cache) cache.clear()\n  },\n  \n  /**\n   * Get or set cached value\n   */\n  async getOrSet<T>(\n    key: string,\n    factory: () => Promise<T>,\n    ttlSeconds = CACHE_CONFIG.ttl\n  ): Promise<T> {\n    const cached = await this.get<T>(key)\n    if (cached !== null) return cached\n    \n    const value = await factory()\n    await this.set(key, value, ttlSeconds)\n    return value\n  },\n\n  /**\n   * Invalidate cache for a pattern\n   */\n  async invalidatePattern(pattern: string): Promise<void> {\n    if (!isServer) return\n    \n    const client = await this.ensureRedis()\n    if (client) {\n      try {\n        const keys = await client.keys(CACHE_CONFIG.prefix + pattern)\n        if (keys.length > 0) {\n          await client.del(...keys)\n        }\n      } catch (e) {\n        console.error('[Cache] Pattern invalidation error:', e)\n      }\n    }\n    \n    // Clear in-memory cache matching pattern\n    const cache = getQueryCache()\n    if (cache) {\n      const regex = new RegExp(CACHE_CONFIG.prefix + pattern.replace('*', '.*'))\n      for (const key of cache.keys()) {\n        if (regex.test(key)) cache.delete(key)\n      }\n    }\n  }\n}\n\n/**\n * Query optimization utilities\n */\nexport const queryOptimizer = {\n  /**\n   * Batch load function for N+1 prevention\n   */\n  async batchLoad<T>(\n    ids: string[],\n    fetchFn: (ids: string[]) => Promise<T[]>,\n    getId: (item: T) => string\n  ): Promise<(T | null)[]> {\n    if (!isServer) return ids.map(() => null)\n    if (ids.length === 0) return []\n    \n    // Deduplicate IDs\n    const uniqueIds = [...new Set(ids)]\n    \n    // Fetch all items in one query\n    const items = await fetchFn(uniqueIds)\n    \n    // Create lookup map\n    const itemMap = new Map(items.map(item => [getId(item), item]))\n    \n    // Return items in original order\n    return ids.map(id => itemMap.get(id) || null)\n  },\n  \n  /**\n   * Wrap a query with caching\n   */\n  async cachedQuery<T>(\n    cacheKey: string,\n    queryFn: () => Promise<T>,\n    ttlSeconds = CACHE_CONFIG.ttl\n  ): Promise<T> {\n    return cache.getOrSet(cacheKey, queryFn, ttlSeconds)\n  }\n}\n\n/**\n * Read replica support (for future scaling)\n */\nexport const readReplica = {\n  /**\n   * Check if read replicas are configured\n   */\n  isConfigured(): boolean {\n    return isServer && !!process.env.DATABASE_READ_REPLICA_URL\n  },\n  \n  /**\n   * Get read-only database client\n   * Falls back to primary if replicas not configured\n   */\n  getClient() {\n    // For now, return the same client\n    // In production, this would return a connection to the read replica\n    return db\n  }\n}\n\nexport { db }\n/** Alias for code that imports prisma from @/lib/db */\nexport const prisma = db\n\n// Re-export Prisma types (will be empty on client)\nexport * from '@prisma/client'\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 418, "column": 0}, "map": {"version":3,"sources":["file:///Users/nazy/ADK_WORKSPACE/TutorMekimi/tutorme-app/src/lib/auth.ts"],"sourcesContent":["/**\n * NextAuth Configuration\n * Handles authentication for students, tutors, and admins\n */\n\nimport { NextAuthOptions } from 'next-auth'\nimport CredentialsProvider from 'next-auth/providers/credentials'\nimport { PrismaAdapter } from '@next-auth/prisma-adapter'\nimport { db } from '@/lib/db'\nimport bcrypt from 'bcryptjs'\n\nexport const authOptions: NextAuthOptions = {\n  adapter: PrismaAdapter(db),\n\n  providers: [\n    // Email/Password Login\n    CredentialsProvider({\n      name: 'credentials',\n      credentials: {\n        email: { label: 'Email', type: 'email' },\n        password: { label: 'Password', type: 'password' }\n      },\n      async authorize(credentials) {\n        if (!credentials?.email || !credentials?.password) {\n          return null\n        }\n\n        const normalizedEmail = credentials.email.trim().toLowerCase()\n\n        // Find user by email\n        const user = await db.user.findFirst({\n          where: { email: { equals: normalizedEmail, mode: 'insensitive' } },\n          include: { profile: true }\n        })\n\n        if (!user || !user.password) {\n          return null\n        }\n\n        // Verify password\n        const isValid = await bcrypt.compare(credentials.password, user.password)\n\n        if (!isValid) {\n          const { logFailedLogin } = await import('@/lib/security/suspicious-activity')\n          await logFailedLogin(null, normalizedEmail)\n          return null\n        }\n\n\n        // Check if onboarding is complete\n        const onboardingComplete = checkOnboardingComplete(user)\n        const tosAccepted = user.profile?.tosAccepted || false\n\n        return {\n          id: user.id,\n          email: user.email,\n          name: user.profile?.name || user.email,\n          role: user.role,\n          image: user.profile?.avatarUrl,\n          onboardingComplete,\n          tosAccepted\n        }\n      }\n    })\n  ],\n\n  // WeChat OAuth - To be added later\n  // WeChatProvider({\n  //   clientId: process.env.WECHAT_APP_ID!,\n  //   clientSecret: process.env.WECHAT_APP_SECRET!,\n  // })\n  // ], // This was an extra closing bracket for providers array, removed it.\n\n  callbacks: {\n    async jwt({ token, user, trigger, session }) {\n      if (user) {\n        token.role = user.role\n        token.id = user.id\n        token.onboardingComplete = user.onboardingComplete\n        token.tosAccepted = user.tosAccepted\n      }\n\n      // Handle session update (e.g., after onboarding completes)\n      if (trigger === 'update' && session) {\n        token.onboardingComplete = true\n      }\n\n      return token\n    },\n\n    async session({ session, token }) {\n      if (session.user) {\n        session.user.role = token.role as string\n        session.user.id = token.id as string\n        session.user.onboardingComplete = token.onboardingComplete as boolean\n        session.user.tosAccepted = token.tosAccepted as boolean\n      }\n      return session\n    }\n  },\n\n  pages: {\n    signIn: '/login',\n    error: '/login'\n  },\n\n  session: {\n    strategy: 'jwt',\n    maxAge: 30 * 24 * 60 * 60 // 30 days\n  },\n\n  secret: process.env.NEXTAUTH_SECRET\n}\n\n// Helper function to check if onboarding is complete\nfunction checkOnboardingComplete(user: { profile?: { isOnboarded?: boolean | null } | null }): boolean {\n  // Check if user profile exists and has completed onboarding\n  if (!user?.profile) {\n    return false\n  }\n  \n  // Profile exists but isOnboarded field is not set (null/undefined) - consider not onboarded\n  if (user.profile.isOnboarded === null || user.profile.isOnboarded === undefined) {\n    return false\n  }\n  \n  // Return the actual onboarding status\n  return user.profile.isOnboarded\n}\n\n// Helper function to hash passwords\nexport async function hashPassword(password: string): Promise<string> {\n  return bcrypt.hash(password, 12)\n}\n\n// Helper function to check if user is authorized\nexport function isAuthorized(userRole: string, allowedRoles: string[]): boolean {\n  return allowedRoles.includes(userRole)\n}\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 558, "column": 0}, "map": {"version":3,"sources":["file:///Users/nazy/ADK_WORKSPACE/TutorMekimi/tutorme-app/src/lib/security/csrf.ts"],"sourcesContent":["/**\n * CSRF protection for state-changing API requests.\n * Uses a double-submit cookie pattern: cookie set on session, validated on POST/PUT/DELETE/PATCH.\n */\n\nimport { cookies } from 'next/headers'\nimport crypto from 'crypto'\n\nconst CSRF_COOKIE_NAME = 'tutorme_csrf'\nconst CSRF_HEADER_NAME = 'x-csrf-token'\nconst SECRET = process.env.NEXTAUTH_SECRET || process.env.CSRF_SECRET || 'csrf-secret-change-in-production'\n\nfunction hash(value: string): string {\n  return crypto.createHmac('sha256', SECRET).update(value).digest('hex')\n}\n\n/**\n * Generate a CSRF token for the current request. Call from a route or pass to client.\n */\nexport async function getCsrfToken(): Promise<string> {\n  const value = crypto.randomBytes(24).toString('hex')\n  const token = `${value}.${hash(value)}`\n  const cookieStore = await cookies()\n  cookieStore.set(CSRF_COOKIE_NAME, token, {\n    httpOnly: true,\n    secure: process.env.NODE_ENV === 'production',\n    sameSite: 'lax',\n    maxAge: 60 * 60 * 24, // 24h\n    path: '/'\n  })\n  return token\n}\n\n/**\n * Verify CSRF token from request header against cookie. Returns true if valid.\n */\nexport async function verifyCsrfToken(req: Request): Promise<boolean> {\n  try {\n    const headerToken = req.headers.get(CSRF_HEADER_NAME)\n    const cookieStore = await cookies()\n    const cookieToken = cookieStore.get(CSRF_COOKIE_NAME)?.value\n    if (!headerToken || !cookieToken) return false\n    if (headerToken !== cookieToken) return false\n\n    const [value] = headerToken.split('.')\n    if (!value) return false\n\n    const expected = `${value}.${hash(value)}`\n    const headerBuffer = Buffer.from(headerToken)\n    const expectedBuffer = Buffer.from(expected)\n    if (headerBuffer.length !== expectedBuffer.length) return false\n\n    return crypto.timingSafeEqual(headerBuffer, expectedBuffer)\n  } catch {\n    return false\n  }\n}\n\nexport { CSRF_HEADER_NAME }\n"],"names":[],"mappings":";;;;;;;;AAAA;;;CAGC,GAED;AACA;;;AAEA,MAAM,mBAAmB;AACzB,MAAM,mBAAmB;AACzB,MAAM,SAAS,QAAQ,GAAG,CAAC,eAAe,IAAI,QAAQ,GAAG,CAAC,WAAW,IAAI;AAEzE,SAAS,KAAK,KAAa;IACzB,OAAO,gHAAM,CAAC,UAAU,CAAC,UAAU,QAAQ,MAAM,CAAC,OAAO,MAAM,CAAC;AAClE;AAKO,eAAe;IACpB,MAAM,QAAQ,gHAAM,CAAC,WAAW,CAAC,IAAI,QAAQ,CAAC;IAC9C,MAAM,QAAQ,GAAG,MAAM,CAAC,EAAE,KAAK,QAAQ;IACvC,MAAM,cAAc,MAAM,IAAA,8LAAO;IACjC,YAAY,GAAG,CAAC,kBAAkB,OAAO;QACvC,UAAU;QACV,QAAQ,oDAAyB;QACjC,UAAU;QACV,QAAQ,KAAK,KAAK;QAClB,MAAM;IACR;IACA,OAAO;AACT;AAKO,eAAe,gBAAgB,GAAY;IAChD,IAAI;QACF,MAAM,cAAc,IAAI,OAAO,CAAC,GAAG,CAAC;QACpC,MAAM,cAAc,MAAM,IAAA,8LAAO;QACjC,MAAM,cAAc,YAAY,GAAG,CAAC,mBAAmB;QACvD,IAAI,CAAC,eAAe,CAAC,aAAa,OAAO;QACzC,IAAI,gBAAgB,aAAa,OAAO;QAExC,MAAM,CAAC,MAAM,GAAG,YAAY,KAAK,CAAC;QAClC,IAAI,CAAC,OAAO,OAAO;QAEnB,MAAM,WAAW,GAAG,MAAM,CAAC,EAAE,KAAK,QAAQ;QAC1C,MAAM,eAAe,OAAO,IAAI,CAAC;QACjC,MAAM,iBAAiB,OAAO,IAAI,CAAC;QACnC,IAAI,aAAa,MAAM,KAAK,eAAe,MAAM,EAAE,OAAO;QAE1D,OAAO,gHAAM,CAAC,eAAe,CAAC,cAAc;IAC9C,EAAE,OAAM;QACN,OAAO;IACT;AACF"}},
    {"offset": {"line": 615, "column": 0}, "map": {"version":3,"sources":["file:///Users/nazy/ADK_WORKSPACE/TutorMekimi/tutorme-app/src/lib/security/rate-limit.ts"],"sourcesContent":["/**\n * Rate limiting for API routes.\n * Uses Redis when REDIS_URL is set (shared across instances); otherwise in-memory store.\n */\nconst DEFAULT_WINDOW_MS = 60 * 1000 // 1 minute\nconst DEFAULT_MAX = 100 // requests per window per key\nconst REDIS_PREFIX = 'ratelimit:'\n\ninterface Entry {\n  count: number\n  resetAt: number\n}\n\ninterface RateLimitOptions {\n  max: number\n  windowMs?: number\n}\n\ninterface RateLimitResult {\n  allowed: boolean\n  remaining: number\n  resetAt: number\n}\n\nconst memoryStore = new Map<string, Entry>()\n\nfunction prune(): void {\n  const now = Date.now()\n  for (const [key, entry] of memoryStore.entries()) {\n    if (entry.resetAt < now) memoryStore.delete(key)\n  }\n}\n\nfunction checkRateLimitMemory(\n  key: string,\n  options: RateLimitOptions\n): RateLimitResult {\n  const { windowMs, max } = options\n  const now = Date.now()\n  if (memoryStore.size > 10000) prune()\n  let entry = memoryStore.get(key)\n  if (!entry || entry.resetAt < now) {\n    entry = { count: 0, resetAt: now + windowMs }\n    memoryStore.set(key, entry)\n  }\n  entry.count += 1\n  const allowed = entry.count <= max\n  const remaining = Math.max(0, max - entry.count)\n  return { allowed, remaining, resetAt: entry.resetAt }\n}\n\nlet redisClient: import('ioredis').Redis | null = null\nlet redisInitPromise: Promise<import('ioredis').Redis | null> | null = null\n\nasync function getRedisClient(): Promise<import('ioredis').Redis | null> {\n  if (redisClient) return redisClient\n  if (typeof window !== 'undefined') return null // browser\n  const url = process.env.REDIS_URL\n  if (!url) return null\n  if (!redisInitPromise) {\n    redisInitPromise = (async () => {\n      try {\n        const { Redis } = await import('ioredis')\n        const client = new Redis(url, {\n          retryStrategy: (times) => Math.min(times * 50, 2000),\n          maxRetriesPerRequest: 3,\n        })\n        client.on('error', () => {})\n        redisClient = client\n        return client\n      } catch {\n        return null\n      }\n    })()\n  }\n  return redisInitPromise\n}\n\nasync function checkRateLimitRedis(\n  key: string,\n  options: RateLimitOptions\n): Promise<RateLimitResult> {\n  const redis = await getRedisClient()\n  if (!redis) return checkRateLimitMemory(key, options)\n\n  const { windowMs, max } = options\n  const now = Date.now()\n  const fullKey = REDIS_PREFIX + key\n  const ttlSeconds = Math.ceil(windowMs / 1000)\n\n  try {\n    // Atomic Lua: INCR + EXPIRE (when count=1) in single round-trip - no race conditions\n    const result = (await redis.eval(\n      `local c=redis.call('INCR',KEYS[1]) if c==1 then redis.call('EXPIRE',KEYS[1],ARGV[1]) end return {c,redis.call('PTTL',KEYS[1])}`,\n      1,\n      fullKey,\n      ttlSeconds\n    )) as [number, number]\n    const [newCount, pttl] = result\n    const resetAt = pttl > 0 ? now + pttl : now + windowMs\n\n    const allowed = newCount <= max\n    const remaining = Math.max(0, max - newCount)\n    return { allowed, remaining, resetAt }\n  } catch {\n    return checkRateLimitMemory(key, options)\n  }\n}\n\n/**\n * Check rate limit. Returns { allowed, remaining, resetAt }.\n * Uses Redis when REDIS_URL is set; otherwise in-memory (per instance).\n * key: typically prefix + IP (e.g. \"login:\" + getClientIdentifier(req))\n */\nexport async function checkRateLimit(\n  key: string,\n  maxOrOptions: number | RateLimitOptions = DEFAULT_MAX\n): Promise<RateLimitResult> {\n  const options: RateLimitOptions =\n    typeof maxOrOptions === 'number'\n      ? { max: maxOrOptions, windowMs: DEFAULT_WINDOW_MS }\n      : { windowMs: DEFAULT_WINDOW_MS, ...maxOrOptions }\n\n  if (process.env.REDIS_URL) {\n    return checkRateLimitRedis(key, options)\n  }\n  return checkRateLimitMemory(key, options)\n}\n\n/** Presets for sensitive routes (stricter limits) */\nexport const RATE_LIMIT_PRESETS = {\n  /** Login: 10 attempts per 15 minutes per IP */\n  login: { max: 10, windowMs: 15 * 60 * 1000 },\n  /** Signup/register: allow multi-step retries and multi-role onboarding in the same browser */\n  register: { max: 12, windowMs: 15 * 60 * 1000 },\n  /** Payment create: 20 per minute per IP */\n  paymentCreate: { max: 20, windowMs: 60 * 1000 },\n  /** Enroll (subject or curriculum): 30 per minute per IP */\n  enroll: { max: 30, windowMs: 60 * 1000 },\n  /** Class booking: 20 per minute per IP */\n  booking: { max: 20, windowMs: 60 * 1000 },\n  /** AI generation/chat: 12 per minute per client identifier */\n  aiGenerate: { max: 12, windowMs: 60 * 1000 },\n} as const\n\n/**\n * Check rate limit using a named preset. Key will be prefixed with the preset name.\n */\nexport async function checkRateLimitPreset(\n  req: Request,\n  preset: keyof typeof RATE_LIMIT_PRESETS\n): Promise<RateLimitResult> {\n  const ip = getClientIdentifier(req)\n  const key = `${preset}:${ip}`\n  const options = RATE_LIMIT_PRESETS[preset]\n  return checkRateLimit(key, options)\n}\n\n/**\n * Get client identifier for rate limiting (IP or x-forwarded-for).\n */\nexport function getClientIdentifier(req: Request): string {\n  const trustProxy = process.env.TRUST_PROXY === 'true'\n  const forwarded = req.headers.get('x-forwarded-for')\n  const realIp = req.headers.get('x-real-ip')\n  const cfIp = req.headers.get('cf-connecting-ip')\n\n  const firstForwarded = forwarded?.split(',')[0]?.trim()\n  const candidate = trustProxy ? (firstForwarded || realIp || cfIp) : (realIp || cfIp)\n  const ip = normalizeIp(candidate)\n  if (ip !== 'unknown') return ip\n\n  // Fallback identifier when no reliable IP is available (prevents all unknown clients sharing one bucket).\n  const ua = req.headers.get('user-agent') || 'unknown'\n  const lang = req.headers.get('accept-language') || 'unknown'\n  const fingerprint = simpleHash(`${ua}|${lang}`)\n  return `unknown:${fingerprint}`\n}\n\nfunction normalizeIp(ip: string | null | undefined): string {\n  if (!ip) return 'unknown'\n  const trimmed = ip.trim()\n  if (!trimmed) return 'unknown'\n  if (trimmed === '::1') return '127.0.0.1'\n  return trimmed\n}\n\nfunction simpleHash(input: string): string {\n  let hash = 2166136261\n  for (let i = 0; i < input.length; i += 1) {\n    hash ^= input.charCodeAt(i)\n    hash = Math.imul(hash, 16777619)\n  }\n  return (hash >>> 0).toString(16).padStart(8, '0')\n}\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 790, "column": 0}, "map": {"version":3,"sources":["file:///Users/nazy/ADK_WORKSPACE/TutorMekimi/tutorme-app/src/lib/security/rbac.ts"],"sourcesContent":["/**\n * Role-based access control: granular permissions per role.\n * Use requirePermission() in admin/sensitive routes.\n */\n\nimport type { Role } from '@prisma/client'\n\nexport const PERMISSIONS = {\n  // Admin\n  ADMIN_VIEW_PAYMENTS: 'admin:payments:read',\n  ADMIN_VIEW_WEBHOOKS: 'admin:webhooks:read',\n  ADMIN_MANAGE_API_KEYS: 'admin:api_keys',\n  ADMIN_VIEW_USERS: 'admin:users:read',\n  // Tutor\n  TUTOR_MANAGE_CLINICS: 'tutor:clinics',\n  TUTOR_VIEW_REPORTS: 'tutor:reports:read',\n  // Student\n  STUDENT_VIEW_OWN: 'student:own:read',\n  STUDENT_BOOK_CLASS: 'student:book'\n} as const\n\nexport type Permission = (typeof PERMISSIONS)[keyof typeof PERMISSIONS]\n\nconst ROLE_PERMISSIONS: Record<Role, Permission[]> = {\n  ADMIN: [\n    PERMISSIONS.ADMIN_VIEW_PAYMENTS,\n    PERMISSIONS.ADMIN_VIEW_WEBHOOKS,\n    PERMISSIONS.ADMIN_MANAGE_API_KEYS,\n    PERMISSIONS.ADMIN_VIEW_USERS,\n    PERMISSIONS.TUTOR_MANAGE_CLINICS,\n    PERMISSIONS.TUTOR_VIEW_REPORTS,\n    PERMISSIONS.STUDENT_VIEW_OWN,\n    PERMISSIONS.STUDENT_BOOK_CLASS\n  ],\n  TUTOR: [\n    PERMISSIONS.TUTOR_MANAGE_CLINICS,\n    PERMISSIONS.TUTOR_VIEW_REPORTS,\n    PERMISSIONS.STUDENT_VIEW_OWN,\n    PERMISSIONS.STUDENT_BOOK_CLASS\n  ],\n  STUDENT: [PERMISSIONS.STUDENT_VIEW_OWN, PERMISSIONS.STUDENT_BOOK_CLASS]\n}\n\nexport function hasPermission(role: Role, permission: Permission): boolean {\n  return ROLE_PERMISSIONS[role]?.includes(permission) ?? false\n}\n\nexport function getPermissionsForRole(role: Role): Permission[] {\n  return ROLE_PERMISSIONS[role] ?? []\n}\n"],"names":[],"mappings":"AAAA;;;CAGC;;;;;;;;AAIM,MAAM,cAAc;IACzB,QAAQ;IACR,qBAAqB;IACrB,qBAAqB;IACrB,uBAAuB;IACvB,kBAAkB;IAClB,QAAQ;IACR,sBAAsB;IACtB,oBAAoB;IACpB,UAAU;IACV,kBAAkB;IAClB,oBAAoB;AACtB;AAIA,MAAM,mBAA+C;IACnD,OAAO;QACL,YAAY,mBAAmB;QAC/B,YAAY,mBAAmB;QAC/B,YAAY,qBAAqB;QACjC,YAAY,gBAAgB;QAC5B,YAAY,oBAAoB;QAChC,YAAY,kBAAkB;QAC9B,YAAY,gBAAgB;QAC5B,YAAY,kBAAkB;KAC/B;IACD,OAAO;QACL,YAAY,oBAAoB;QAChC,YAAY,kBAAkB;QAC9B,YAAY,gBAAgB;QAC5B,YAAY,kBAAkB;KAC/B;IACD,SAAS;QAAC,YAAY,gBAAgB;QAAE,YAAY,kBAAkB;KAAC;AACzE;AAEO,SAAS,cAAc,IAAU,EAAE,UAAsB;IAC9D,OAAO,gBAAgB,CAAC,KAAK,EAAE,SAAS,eAAe;AACzD;AAEO,SAAS,sBAAsB,IAAU;IAC9C,OAAO,gBAAgB,CAAC,KAAK,IAAI,EAAE;AACrC"}},
    {"offset": {"line": 846, "column": 0}, "map": {"version":3,"sources":["file:///Users/nazy/ADK_WORKSPACE/TutorMekimi/tutorme-app/src/lib/security/admin-ip.ts"],"sourcesContent":["/**\n * Admin panel IP whitelist. When set, only listed IPs can access /admin and admin API routes.\n * Env: ADMIN_IP_WHITELIST (comma-separated IPs or CIDRs, e.g. \"1.2.3.4,10.0.0.0/8\")\n */\n\nfunction parseWhitelist(): string[] {\n  const raw = process.env.ADMIN_IP_WHITELIST\n  if (!raw?.trim()) return []\n  return raw.split(',').map((s) => s.trim()).filter(Boolean)\n}\n\nfunction ipToNum(ip: string): number {\n  const parts = ip.split('.').map(Number)\n  if (parts.length !== 4) return 0\n  return (parts[0]! << 24) | (parts[1]! << 16) | (parts[2]! << 8) | parts[3]!\n}\n\nfunction matchCidr(ip: string, cidr: string): boolean {\n  if (!cidr.includes('/')) return ip === cidr\n  const [net, bits] = cidr.split('/')\n  if (!net || bits === undefined) return false\n  const mask = ~((1 << (32 - parseInt(bits, 10))) - 1) >>> 0\n  return (ipToNum(ip) & mask) === (ipToNum(net) & mask)\n}\n\n/**\n * Returns true if admin access is allowed from this IP.\n * If whitelist is empty, all IPs are allowed.\n */\nexport function isAdminIpAllowed(clientIp: string): boolean {\n  const whitelist = parseWhitelist()\n  if (whitelist.length === 0) return true\n  return whitelist.some((entry) => matchCidr(clientIp, entry) || clientIp === entry)\n}\n\nexport function getClientIp(req: Request): string {\n  const forwarded = req.headers.get('x-forwarded-for')\n  const ip = forwarded ? forwarded.split(',')[0]?.trim() : null\n  return ip ?? req.headers.get('x-real-ip') ?? 'unknown'\n}\n"],"names":[],"mappings":";;;;;;AAAA;;;CAGC,GAED,SAAS;IACP,MAAM,MAAM,QAAQ,GAAG,CAAC,kBAAkB;IAC1C,IAAI,CAAC,KAAK,QAAQ,OAAO,EAAE;IAC3B,OAAO,IAAI,KAAK,CAAC,KAAK,GAAG,CAAC,CAAC,IAAM,EAAE,IAAI,IAAI,MAAM,CAAC;AACpD;AAEA,SAAS,QAAQ,EAAU;IACzB,MAAM,QAAQ,GAAG,KAAK,CAAC,KAAK,GAAG,CAAC;IAChC,IAAI,MAAM,MAAM,KAAK,GAAG,OAAO;IAC/B,OAAO,AAAC,KAAK,CAAC,EAAE,IAAK,KAAO,KAAK,CAAC,EAAE,IAAK,KAAO,KAAK,CAAC,EAAE,IAAK,IAAK,KAAK,CAAC,EAAE;AAC5E;AAEA,SAAS,UAAU,EAAU,EAAE,IAAY;IACzC,IAAI,CAAC,KAAK,QAAQ,CAAC,MAAM,OAAO,OAAO;IACvC,MAAM,CAAC,KAAK,KAAK,GAAG,KAAK,KAAK,CAAC;IAC/B,IAAI,CAAC,OAAO,SAAS,WAAW,OAAO;IACvC,MAAM,OAAO,CAAC,CAAC,CAAC,KAAM,KAAK,SAAS,MAAM,GAAI,IAAI,CAAC,MAAM;IACzD,OAAO,CAAC,QAAQ,MAAM,IAAI,MAAM,CAAC,QAAQ,OAAO,IAAI;AACtD;AAMO,SAAS,iBAAiB,QAAgB;IAC/C,MAAM,YAAY;IAClB,IAAI,UAAU,MAAM,KAAK,GAAG,OAAO;IACnC,OAAO,UAAU,IAAI,CAAC,CAAC,QAAU,UAAU,UAAU,UAAU,aAAa;AAC9E;AAEO,SAAS,YAAY,GAAY;IACtC,MAAM,YAAY,IAAI,OAAO,CAAC,GAAG,CAAC;IAClC,MAAM,KAAK,YAAY,UAAU,KAAK,CAAC,IAAI,CAAC,EAAE,EAAE,SAAS;IACzD,OAAO,MAAM,IAAI,OAAO,CAAC,GAAG,CAAC,gBAAgB;AAC/C"}},
    {"offset": {"line": 886, "column": 0}, "map": {"version":3,"sources":["file:///Users/nazy/ADK_WORKSPACE/TutorMekimi/tutorme-app/src/lib/api/middleware.ts"],"sourcesContent":["/**\n * API Route Middleware Utilities\n * Provides authentication, authorization, CSRF, rate limiting, and error handling for API routes\n */\n\nimport { NextRequest, NextResponse } from 'next/server'\nimport { getServerSession } from 'next-auth'\nimport { authOptions } from '@/lib/auth'\nimport type { Session } from 'next-auth'\nimport { verifyCsrfToken } from '@/lib/security/csrf'\nimport { checkRateLimit, checkRateLimitPreset, getClientIdentifier } from '@/lib/security/rate-limit'\nimport { hasPermission, type Permission } from '@/lib/security/rbac'\nimport { isAdminIpAllowed, getClientIp } from '@/lib/security/admin-ip'\n\n// Custom error classes\nexport class UnauthorizedError extends Error {\n    constructor(message = 'Unauthorized - Please log in') {\n        super(message)\n        this.name = 'UnauthorizedError'\n    }\n}\n\nexport class ForbiddenError extends Error {\n    constructor(message = 'Forbidden - Insufficient permissions') {\n        super(message)\n        this.name = 'ForbiddenError'\n    }\n}\n\nexport class ValidationError extends Error {\n    constructor(message: string) {\n        super(message)\n        this.name = 'ValidationError'\n    }\n}\n\nexport class NotFoundError extends Error {\n    constructor(message = 'Resource not found') {\n        super(message)\n        this.name = 'NotFoundError'\n    }\n}\n\n/**\n * Centralised API error logging and 500 response.\n * Use in route catch blocks for consistent logging and response shape.\n */\nexport function handleApiError(\n    error: unknown,\n    defaultMessage: string = 'Internal server error',\n    logLabel: string = 'API Error'\n): NextResponse {\n    console.error(`[${logLabel}]`, error)\n    const message = error instanceof Error ? error.message : defaultMessage\n    const isDev = process.env.NODE_ENV === 'development'\n    return NextResponse.json(\n        { error: isDev ? message : defaultMessage },\n        { status: 500 }\n    )\n}\n\n// Handler type (context is optional route params, e.g. { params: { id: string } })\ntype Handler = (\n    req: NextRequest,\n    session: Session,\n    context?: { params?: Promise<Record<string, string | string[]>> | Record<string, string | string[]> }\n) => Promise<Response> | Response\n\n// Middleware options\ninterface WithAuthOptions {\n    role?: 'TUTOR' | 'STUDENT' | 'ADMIN' | 'PARENT'\n    optional?: boolean\n}\n\nfunction normalizeRole(role: unknown): string {\n    if (typeof role !== 'string') return ''\n    return role.trim().toUpperCase()\n}\n\n/**\n * Authentication middleware wrapper\n * Automatically handles session validation, role checking, and error responses\n * \n * @example\n * export const GET = withAuth(async (req, session) => {\n *   // session is guaranteed to exist\n *   return NextResponse.json({ userId: session.user.id })\n * })\n * \n * @example with role requirement\n * export const POST = withAuth(async (req, session) => {\n *   // session.user.role === 'TUTOR' is guaranteed\n *   return NextResponse.json({})\n * }, { role: 'TUTOR' })\n */\nexport function withAuth(\n    handler: Handler,\n    options?: WithAuthOptions\n) {\n    return async (req: NextRequest, context?: { params?: Promise<Record<string, string | string[]>> | Record<string, string | string[]> }) => {\n        try {\n            const session = await getServerSession(authOptions)\n\n            // Check if user is authenticated\n            if (!session?.user?.id) {\n                if (options?.optional) {\n                    // Allow unauthenticated access\n                    return handler(req, session as Session, context)\n                }\n                throw new UnauthorizedError()\n            }\n\n            // Check role requirements\n            if (options?.role && normalizeRole(session.user.role) !== normalizeRole(options.role)) {\n                // Fallback: session role can be stale after account updates or seed resets.\n                const { db } = await import('@/lib/db')\n                const freshUser = await db.user.findUnique({\n                    where: { id: session.user.id },\n                    select: { role: true },\n                })\n                if (normalizeRole(freshUser?.role) !== normalizeRole(options.role)) {\n                    throw new ForbiddenError(`This endpoint requires ${options.role} role`)\n                }\n            }\n\n            // Call the actual handler\n            return await handler(req, session, context)\n\n        } catch (error) {\n            // Handle known error types\n            if (error instanceof UnauthorizedError) {\n                return NextResponse.json(\n                    { error: error.message },\n                    { status: 401 }\n                )\n            }\n\n            if (error instanceof ForbiddenError) {\n                return NextResponse.json(\n                    { error: error.message },\n                    { status: 403 }\n                )\n            }\n\n            if (error instanceof ValidationError) {\n                return NextResponse.json(\n                    { error: error.message },\n                    { status: 400 }\n                )\n            }\n\n            if (error instanceof NotFoundError) {\n                return NextResponse.json(\n                    { error: error.message },\n                    { status: 404 }\n                )\n            }\n\n            // Handle unknown errors\n            console.error('API Error:', error)\n\n            // Don't expose internal errors in production\n            const isDev = process.env.NODE_ENV === 'development'\n            return NextResponse.json(\n                {\n                    error: isDev\n                        ? (error instanceof Error ? error.message : 'Unknown error')\n                        : 'Internal server error'\n                },\n                { status: 500 }\n            )\n        }\n    }\n}\n\n/**\n * Get the current user session without throwing errors\n * Useful for optional authentication scenarios\n */\nexport async function getCurrentSession(): Promise<Session | null> {\n    try {\n        return await getServerSession(authOptions)\n    } catch (error) {\n        console.error('Error getting session:', error)\n        return null\n    }\n}\n\n/**\n * Require authentication - throws if not authenticated\n * Useful when you need the session inside a try/catch block\n */\nexport async function requireAuth(): Promise<Session> {\n    const session = await getServerSession(authOptions)\n    if (!session?.user?.id) {\n        throw new UnauthorizedError()\n    }\n    return session\n}\n\n/**\n * Require specific role - throws if wrong role\n */\nexport async function requireRole(role: 'TUTOR' | 'STUDENT' | 'ADMIN'): Promise<Session> {\n    const session = await requireAuth()\n    if (normalizeRole(session.user.role) !== normalizeRole(role)) {\n        throw new ForbiddenError(`This action requires ${role} role`)\n    }\n    return session\n}\n\n/** State-changing methods that require CSRF */\nconst CSRF_METHODS = new Set(['POST', 'PUT', 'PATCH', 'DELETE'])\n\n/** API path prefixes that skip CSRF (webhooks, auth, public) */\nconst CSRF_SKIP_PATHS = ['/api/auth', '/api/payments/webhooks', '/api/csrf', '/api/health']\n\n/**\n * Verify CSRF for state-changing requests. Call at the start of POST/PUT/PATCH/DELETE handlers\n * that are not webhooks or auth. Returns 403 response if invalid; otherwise returns null.\n */\nexport async function requireCsrf(req: NextRequest): Promise<NextResponse | null> {\n    if (!CSRF_METHODS.has(req.method)) return null\n    const path = req.nextUrl?.pathname ?? ''\n    if (CSRF_SKIP_PATHS.some((p) => path.startsWith(p))) return null\n    const valid = await verifyCsrfToken(req)\n    if (!valid) {\n        return NextResponse.json({ error: 'Invalid or missing CSRF token' }, { status: 403 })\n    }\n    return null\n}\n\ntype AnyHandler = (req: NextRequest, ...args: unknown[]) => Promise<Response> | Response\n\n/**\n * Wraps a state-changing handler to require a valid CSRF token (POST/PUT/PATCH/DELETE).\n * Use with withAuth: export const POST = withCsrf(withAuth(async (req, session) => ...))\n */\nexport function withCsrf(handler: AnyHandler): AnyHandler {\n    return async (req: NextRequest, ...args: unknown[]) => {\n        const csrfError = await requireCsrf(req)\n        if (csrfError) return csrfError\n        return handler(req, ...args)\n    }\n}\n\n/**\n * Apply rate limit by client IP (and optionally by userId when session exists).\n * Returns 429 response if over limit; otherwise returns null.\n */\nexport async function withRateLimit(\n    req: NextRequest,\n    max: number = 100\n): Promise<{ response: NextResponse | null; remaining: number }> {\n    const key = getClientIdentifier(req)\n    const { allowed, remaining } = await checkRateLimit(key, max)\n    if (!allowed) {\n        const res = NextResponse.json(\n            { error: 'Too many requests' },\n            { status: 429, headers: { 'Retry-After': '60' } }\n        )\n        return { response: res, remaining: 0 }\n    }\n    return { response: null, remaining }\n}\n\ntype RateLimitPreset = 'login' | 'register' | 'paymentCreate' | 'enroll' | 'booking' | 'aiGenerate'\n\n/**\n * Apply rate limit using a named preset (stricter limits for sensitive routes).\n * Returns 429 response if over limit; otherwise returns null.\n */\nexport async function withRateLimitPreset(\n    req: NextRequest,\n    preset: RateLimitPreset\n): Promise<{ response: NextResponse | null; remaining: number }> {\n    const { allowed, remaining, resetAt } = await checkRateLimitPreset(req as unknown as Request, preset)\n    if (!allowed) {\n        const retryAfter = Math.ceil((resetAt - Date.now()) / 1000)\n        const res = NextResponse.json(\n            { error: 'Too many requests. Please try again later.' },\n            { status: 429, headers: { 'Retry-After': String(Math.max(1, retryAfter)) } }\n        )\n        return { response: res, remaining: 0 }\n    }\n    return { response: null, remaining }\n}\n\n/**\n * Require a specific permission (RBAC). Call after withAuth.\n * Returns 403 if user's role does not have the permission.\n */\nexport function requirePermission(session: Session, permission: Permission): NextResponse | null {\n    const role = session?.user?.role as 'ADMIN' | 'TUTOR' | 'STUDENT' | undefined\n    if (!role || !hasPermission(role, permission)) {\n        return NextResponse.json({ error: 'Forbidden - Insufficient permissions' }, { status: 403 })\n    }\n    return null\n}\n\n/**\n * Require admin IP whitelist. When ADMIN_IP_WHITELIST is set, only listed IPs can access.\n * Returns 403 if client IP is not allowed.\n */\nexport function requireAdminIp(req: NextRequest): NextResponse | null {\n    const ip = getClientIp(req as unknown as Request)\n    if (!isAdminIpAllowed(ip)) {\n        return NextResponse.json({ error: 'Forbidden - Admin access not allowed from this IP' }, { status: 403 })\n    }\n    return null\n}\n\n/**\n * Get auth from session or API key (Bearer). Use for admin routes that support both browser and server-to-server.\n * Returns session if logged in, or { apiKey: keyId } if valid Bearer key, else null.\n */\nexport async function getSessionOrApiKey(req: NextRequest): Promise<\n    | { type: 'session'; session: Session }\n    | { type: 'apiKey'; keyId: string }\n    | null\n> {\n    const authHeader = req.headers.get('authorization')\n    if (authHeader?.startsWith('Bearer ')) {\n        const token = authHeader.slice(7)\n        if (token.startsWith('tm_')) {\n            const { verifyApiKey } = await import('@/lib/security/api-key')\n            const key = await verifyApiKey(token)\n            if (key) return { type: 'apiKey', keyId: key.id }\n        }\n    }\n    const session = await getServerSession(authOptions)\n    if (session?.user?.id) return { type: 'session', session }\n    return null\n}\n\n/**\n * Parse and clamp numeric query/body values to safe bounds.\n */\nexport function parseBoundedInt(\n    raw: string | null | undefined,\n    defaultValue: number,\n    options: { min?: number; max: number }\n): number {\n    const min = options.min ?? 0\n    const parsed = Number.parseInt(raw ?? '', 10)\n    if (!Number.isFinite(parsed)) return defaultValue\n    if (parsed < min) return min\n    if (parsed > options.max) return options.max\n    return parsed\n}\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 1202, "column": 0}, "map": {"version":3,"sources":["file:///Users/nazy/ADK_WORKSPACE/TutorMekimi/tutorme-app/src/lib/gamification/activity-log.ts"],"sourcesContent":["/**\n * Activity Log Service\n * \n * Tracks user activities for analytics and retention insights\n */\n\nimport { db } from '@/lib/db'\n\nexport const ACTIVITY_EVENTS = {\n  // XP & Leveling\n  XP_EARNED: 'xp_earned',\n  LEVEL_UP: 'level_up',\n  \n  // Streaks\n  STREAK_UPDATED: 'streak_updated',\n  STREAK_BROKEN: 'streak_broken',\n  \n  // Worlds & Missions\n  WORLD_UNLOCK: 'world_unlock',\n  MISSION_START: 'mission_start',\n  MISSION_COMPLETE: 'mission_complete',\n  MISSION_ABANDON: 'mission_abandon',\n  \n  // Skills\n  CONFIDENCE_MILESTONE: 'confidence_milestone',\n  SKILL_IMPROVEMENT: 'skill_improvement',\n  \n  // AI Tutor\n  AI_SESSION_START: 'ai_session_start',\n  AI_SESSION_END: 'ai_session_end',\n  PERSONALITY_SWITCH: 'personality_switch',\n  \n  // Learning\n  LESSON_COMPLETE: 'lesson_complete',\n  QUIZ_COMPLETE: 'quiz_complete',\n  \n  // Subscription\n  SUBSCRIPTION_UPGRADE: 'subscription_upgrade',\n  SUBSCRIPTION_DOWNGRADE: 'subscription_downgrade',\n  \n  // Engagement\n  DAILY_LOGIN: 'daily_login',\n  QUEST_COMPLETE: 'quest_complete',\n} as const\n\nexport type ActivityEvent = typeof ACTIVITY_EVENTS[keyof typeof ACTIVITY_EVENTS]\n\n/**\n * Log a user activity\n */\nexport async function logActivity(\n  userId: string,\n  eventType: ActivityEvent | string,\n  metadata?: Record<string, any>\n) {\n  try {\n    await db.userActivityLog.create({\n      data: {\n        userId,\n        eventType,\n        metadata: metadata || {},\n      },\n    })\n  } catch (error) {\n    console.error('Failed to log activity:', error)\n  }\n}\n\n/**\n * Get user's recent activities\n */\nexport async function getRecentActivities(\n  userId: string,\n  limit: number = 20,\n  eventTypes?: string[]\n) {\n  return db.userActivityLog.findMany({\n    where: {\n      userId,\n      ...(eventTypes && { eventType: { in: eventTypes } }),\n    },\n    orderBy: {\n      createdAt: 'desc',\n    },\n    take: limit,\n  })\n}\n\n/**\n * Get activity counts for analytics\n */\nexport async function getActivityCounts(\n  userId: string,\n  startDate: Date,\n  endDate: Date\n) {\n  const activities = await db.userActivityLog.groupBy({\n    by: ['eventType'],\n    where: {\n      userId,\n      createdAt: {\n        gte: startDate,\n        lte: endDate,\n      },\n    },\n    _count: {\n      eventType: true,\n    },\n  })\n\n  const result: Record<string, number> = {}\n  activities.forEach((item: any) => {\n    result[item.eventType] = item._count.eventType\n  })\n  return result\n}\n\n/**\n * Get user's learning streak history\n */\nexport async function getStreakHistory(userId: string, days: number = 30) {\n  const startDate = new Date()\n  startDate.setDate(startDate.getDate() - days)\n  \n  const activities = await db.userActivityLog.findMany({\n    where: {\n      userId,\n      eventType: {\n        in: ['daily_login', 'streak_updated', 'streak_broken'],\n      },\n      createdAt: {\n        gte: startDate,\n      },\n    },\n    orderBy: {\n      createdAt: 'asc',\n    },\n  })\n\n  return activities\n}\n\n/**\n * Calculate engagement score (0-100)\n */\nexport async function calculateEngagementScore(userId: string): Promise<number> {\n  const last7Days = new Date()\n  last7Days.setDate(last7Days.getDate() - 7)\n  \n  const activities = await getActivityCounts(userId, last7Days, new Date())\n  \n  // Simple scoring algorithm\n  let score = 0\n  \n  // Daily login (up to 30 points)\n  score += Math.min(30, (activities['daily_login'] || 0) * 5)\n  \n  // Mission completion (up to 40 points)\n  score += Math.min(40, (activities['mission_complete'] || 0) * 10)\n  \n  // AI sessions (up to 20 points)\n  score += Math.min(20, (activities['ai_session_end'] || 0) * 5)\n  \n  // Skill improvement (up to 10 points)\n  score += Math.min(10, (activities['skill_improvement'] || 0) * 2)\n  \n  return Math.min(100, score)\n}\n"],"names":[],"mappings":";;;;;;;;;;;;;;AAAA;;;;CAIC,GAED;;AAEO,MAAM,kBAAkB;IAC7B,gBAAgB;IAChB,WAAW;IACX,UAAU;IAEV,UAAU;IACV,gBAAgB;IAChB,eAAe;IAEf,oBAAoB;IACpB,cAAc;IACd,eAAe;IACf,kBAAkB;IAClB,iBAAiB;IAEjB,SAAS;IACT,sBAAsB;IACtB,mBAAmB;IAEnB,WAAW;IACX,kBAAkB;IAClB,gBAAgB;IAChB,oBAAoB;IAEpB,WAAW;IACX,iBAAiB;IACjB,eAAe;IAEf,eAAe;IACf,sBAAsB;IACtB,wBAAwB;IAExB,aAAa;IACb,aAAa;IACb,gBAAgB;AAClB;AAOO,eAAe,YACpB,MAAc,EACd,SAAiC,EACjC,QAA8B;IAE9B,IAAI;QACF,MAAM,mMAAE,CAAC,eAAe,CAAC,MAAM,CAAC;YAC9B,MAAM;gBACJ;gBACA;gBACA,UAAU,YAAY,CAAC;YACzB;QACF;IACF,EAAE,OAAO,OAAO;QACd,QAAQ,KAAK,CAAC,2BAA2B;IAC3C;AACF;AAKO,eAAe,oBACpB,MAAc,EACd,QAAgB,EAAE,EAClB,UAAqB;IAErB,OAAO,mMAAE,CAAC,eAAe,CAAC,QAAQ,CAAC;QACjC,OAAO;YACL;YACA,GAAI,cAAc;gBAAE,WAAW;oBAAE,IAAI;gBAAW;YAAE,CAAC;QACrD;QACA,SAAS;YACP,WAAW;QACb;QACA,MAAM;IACR;AACF;AAKO,eAAe,kBACpB,MAAc,EACd,SAAe,EACf,OAAa;IAEb,MAAM,aAAa,MAAM,mMAAE,CAAC,eAAe,CAAC,OAAO,CAAC;QAClD,IAAI;YAAC;SAAY;QACjB,OAAO;YACL;YACA,WAAW;gBACT,KAAK;gBACL,KAAK;YACP;QACF;QACA,QAAQ;YACN,WAAW;QACb;IACF;IAEA,MAAM,SAAiC,CAAC;IACxC,WAAW,OAAO,CAAC,CAAC;QAClB,MAAM,CAAC,KAAK,SAAS,CAAC,GAAG,KAAK,MAAM,CAAC,SAAS;IAChD;IACA,OAAO;AACT;AAKO,eAAe,iBAAiB,MAAc,EAAE,OAAe,EAAE;IACtE,MAAM,YAAY,IAAI;IACtB,UAAU,OAAO,CAAC,UAAU,OAAO,KAAK;IAExC,MAAM,aAAa,MAAM,mMAAE,CAAC,eAAe,CAAC,QAAQ,CAAC;QACnD,OAAO;YACL;YACA,WAAW;gBACT,IAAI;oBAAC;oBAAe;oBAAkB;iBAAgB;YACxD;YACA,WAAW;gBACT,KAAK;YACP;QACF;QACA,SAAS;YACP,WAAW;QACb;IACF;IAEA,OAAO;AACT;AAKO,eAAe,yBAAyB,MAAc;IAC3D,MAAM,YAAY,IAAI;IACtB,UAAU,OAAO,CAAC,UAAU,OAAO,KAAK;IAExC,MAAM,aAAa,MAAM,kBAAkB,QAAQ,WAAW,IAAI;IAElE,2BAA2B;IAC3B,IAAI,QAAQ;IAEZ,gCAAgC;IAChC,SAAS,KAAK,GAAG,CAAC,IAAI,CAAC,UAAU,CAAC,cAAc,IAAI,CAAC,IAAI;IAEzD,uCAAuC;IACvC,SAAS,KAAK,GAAG,CAAC,IAAI,CAAC,UAAU,CAAC,mBAAmB,IAAI,CAAC,IAAI;IAE9D,gCAAgC;IAChC,SAAS,KAAK,GAAG,CAAC,IAAI,CAAC,UAAU,CAAC,iBAAiB,IAAI,CAAC,IAAI;IAE5D,sCAAsC;IACtC,SAAS,KAAK,GAAG,CAAC,IAAI,CAAC,UAAU,CAAC,oBAAoB,IAAI,CAAC,IAAI;IAE/D,OAAO,KAAK,GAAG,CAAC,KAAK;AACvB"}},
    {"offset": {"line": 1345, "column": 0}, "map": {"version":3,"sources":["file:///Users/nazy/ADK_WORKSPACE/TutorMekimi/tutorme-app/src/lib/gamification/service.ts"],"sourcesContent":["/**\n * Gamification Service\n * \n * Handles XP, Level, Streak, and Skill Score calculations\n * Merged Socratic teaching with Gamified Avatar personalities\n */\n\nimport { db } from '@/lib/db'\nimport { logActivity } from './activity-log'\n\n// XP required for each level (exponential growth)\nconst XP_LEVELS: Record<number, number> = {\n  1: 0,\n  2: 200,\n  3: 500,\n  4: 1000,\n  5: 1800,\n  6: 3000,\n  7: 4600,\n  8: 6600,\n  9: 9100,\n  10: 12100,\n  11: 15600,\n  12: 19600,\n  13: 24100,\n  14: 29100,\n  15: 34600,\n  16: 40600,\n  17: 47100,\n  18: 54100,\n  19: 61600,\n  20: 69600,\n}\n\n// XP rewards for different actions\nexport const XP_REWARDS = {\n  COMPLETE_MISSION: 50,\n  PERFECT_QUIZ: 20,\n  DAILY_LOGIN: 10,\n  STREAK_3_DAYS: 50,\n  STREAK_7_DAYS: 150,\n  STREAK_30_DAYS: 500,\n  SPEAKING_PRACTICE: 30,\n  AI_CONVERSATION: 40,\n  COMPLETE_LESSON: 40,\n  FIRST_MISSION: 100,\n}\n\n// Avatar personalities with Socratic balance\nexport const AVATAR_PERSONALITIES = {\n  friendly_mentor: {\n    id: 'friendly_mentor',\n    name: 'Friendly Mentor',\n    description: 'Warm, supportive, and encouraging',\n    tone: 'warm and supportive',\n    usesEmojis: true,\n    correctionStyle: 'gentle',\n    encouragement: 'frequent',\n    socraticBalance: 0.6,\n    voiceStyle: 'encouraging',\n    examplePhrases: {\n      greeting: \"Hey there! I'm so excited to learn with you today!\",\n      correction: \"Almost perfect! Here's a slightly smoother way to say that:\",\n      encouragement: \"You're doing amazing! I can see your confidence growing!\",\n      socraticPrompt: \"That's a great start! What do you think would happen if...?\",\n    },\n  },\n  strict_coach: {\n    id: 'strict_coach',\n    name: 'Strict Coach',\n    description: 'Professional, direct, and disciplined',\n    tone: 'professional and direct',\n    usesEmojis: false,\n    correctionStyle: 'immediate',\n    encouragement: 'achievement-based',\n    socraticBalance: 0.4,\n    voiceStyle: 'authoritative',\n    examplePhrases: {\n      greeting: \"Let's begin. Today's focus is clear communication.\",\n      correction: \"Correction: Use present perfect with 'for' + duration.\",\n      encouragement: \"Good. Your accuracy improved by 15% this week.\",\n      socraticPrompt: \"Consider this: what is the core issue in your sentence?\",\n    },\n  },\n  corporate_trainer: {\n    id: 'corporate_trainer',\n    name: 'Corporate Trainer',\n    description: 'Business-focused and performance-oriented',\n    tone: 'business professional',\n    usesEmojis: false,\n    correctionStyle: 'constructive',\n    encouragement: 'performance-focused',\n    socraticBalance: 0.5,\n    voiceStyle: 'professional',\n    examplePhrases: {\n      greeting: \"Welcome. Let's work on your professional communication skills.\",\n      correction: \"In a business context, consider this phrasing instead:\",\n      encouragement: \"Your professional articulation is showing measurable improvement.\",\n      socraticPrompt: \"From a stakeholder perspective, how would you frame this?\",\n    },\n  },\n  funny_teacher: {\n    id: 'funny_teacher',\n    name: 'Funny Teacher',\n    description: 'Light, humorous, and engaging',\n    tone: 'light and humorous',\n    usesEmojis: true,\n    correctionStyle: 'playful',\n    encouragement: 'enthusiastic',\n    socraticBalance: 0.7,\n    voiceStyle: 'friendly',\n    examplePhrases: {\n      greeting: \"Ready to level up your English? Let's make some grammar magic!\",\n      correction: \"Oops! Let's give that sentence a little makeover!\",\n      encouragement: \"Boom! You're crushing it! High five!\",\n      socraticPrompt: \"Ooh, interesting! But what if we looked at it this way...?\",\n    },\n  },\n  calm_professor: {\n    id: 'calm_professor',\n    name: 'Calm Professor',\n    description: 'Patient, thoughtful, and explanatory',\n    tone: 'patient and thoughtful',\n    usesEmojis: false,\n    correctionStyle: 'explanatory',\n    encouragement: 'steady',\n    socraticBalance: 0.8,\n    voiceStyle: 'calm',\n    examplePhrases: {\n      greeting: \"Welcome. Take your time, and let's explore this together.\",\n      correction: \"I see your thought process. Let's refine it gently:\",\n      encouragement: \"Your progress is steady and meaningful. Well done.\",\n      socraticPrompt: \"That's an interesting approach. What led you to that conclusion?\",\n    },\n  },\n} as const\n\nexport type AvatarPersonality = keyof typeof AVATAR_PERSONALITIES\n\nexport async function getOrCreateGamification(userId: string) {\n  let gamification = await db.userGamification.findUnique({\n    where: { userId },\n  })\n\n  if (!gamification) {\n    gamification = await db.userGamification.create({\n      data: {\n        userId,\n        level: 1,\n        xp: 0,\n        streakDays: 0,\n        longestStreak: 0,\n      },\n    })\n  }\n\n  return gamification\n}\n\nexport function calculateLevel(xp: number): number {\n  let level = 1\n  for (let i = 1; i <= 20; i++) {\n    if (xp >= XP_LEVELS[i]) {\n      level = i\n    } else {\n      break\n    }\n  }\n  return level\n}\n\nexport function getXpForNextLevel(currentLevel: number): number {\n  return XP_LEVELS[currentLevel + 1] || XP_LEVELS[20] * 2\n}\n\nexport function getLevelProgress(xp: number, level: number): number {\n  const currentLevelXp = XP_LEVELS[level]\n  const nextLevelXp = XP_LEVELS[level + 1] || XP_LEVELS[20] * 2\n  const xpInLevel = xp - currentLevelXp\n  const xpNeeded = nextLevelXp - currentLevelXp\n  return Math.min(100, Math.round((xpInLevel / xpNeeded) * 100))\n}\n\nexport async function awardXp(\n  userId: string,\n  amount: number,\n  source: string,\n  metadata?: Record<string, any>\n) {\n  const gamification = await getOrCreateGamification(userId)\n  \n  const newXp = gamification.xp + amount\n  const newLevel = calculateLevel(newXp)\n  const leveledUp = newLevel > gamification.level\n\n  const updated = await db.userGamification.update({\n    where: { userId },\n    data: {\n      xp: newXp,\n      level: newLevel,\n    },\n  })\n\n  await logActivity(userId, 'XP_EARNED', {\n    amount,\n    source,\n    newTotal: newXp,\n    leveledUp,\n    ...metadata,\n  })\n\n  return {\n    ...updated,\n    xpEarned: amount,\n    leveledUp,\n    previousLevel: gamification.level,\n  }\n}\n\nexport async function updateStreak(userId: string) {\n  const gamification = await getOrCreateGamification(userId)\n  \n  const today = new Date()\n  today.setHours(0, 0, 0, 0)\n  \n  const lastActive = gamification.lastActiveDate\n    ? new Date(gamification.lastActiveDate)\n    : null\n  \n  let newStreak = gamification.streakDays\n  let streakBonus = 0\n  let streakContinued = false\n  let streakBroken = false\n\n  if (lastActive) {\n    lastActive.setHours(0, 0, 0, 0)\n    const diffDays = Math.floor((today.getTime() - lastActive.getTime()) / (1000 * 60 * 60 * 24))\n\n    if (diffDays === 1) {\n      newStreak += 1\n      streakContinued = true\n      \n      if (newStreak === 3) streakBonus = XP_REWARDS.STREAK_3_DAYS\n      else if (newStreak === 7) streakBonus = XP_REWARDS.STREAK_7_DAYS\n      else if (newStreak === 30) streakBonus = XP_REWARDS.STREAK_30_DAYS\n    } else if (diffDays === 0) {\n      streakContinued = true\n    } else {\n      streakBroken = true\n      newStreak = 1\n    }\n  } else {\n    newStreak = 1\n  }\n\n  const longestStreak = Math.max(gamification.longestStreak, newStreak)\n\n  const updated = await db.userGamification.update({\n    where: { userId },\n    data: {\n      streakDays: newStreak,\n      longestStreak,\n      lastActiveDate: today,\n    },\n  })\n\n  await logActivity(userId, streakBroken ? 'STREAK_BROKEN' : 'STREAK_UPDATED', {\n    streakDays: newStreak,\n    previousStreak: gamification.streakDays,\n    streakBroken,\n    streakContinued,\n  })\n\n  return {\n    ...updated,\n    streakBonus,\n    streakContinued,\n    streakBroken,\n  }\n}\n\nexport async function checkDailyLogin(userId: string) {\n  const gamification = await getOrCreateGamification(userId)\n  \n  const today = new Date()\n  today.setHours(0, 0, 0, 0)\n  \n  const lastActive = gamification.lastActiveDate\n    ? new Date(gamification.lastActiveDate)\n    : null\n  \n  if (!lastActive || lastActive.getTime() !== today.getTime()) {\n    const streakResult = await updateStreak(userId)\n    const xpResult = await awardXp(userId, XP_REWARDS.DAILY_LOGIN, 'daily_login')\n    \n    return {\n      firstLoginToday: true,\n      xpEarned: xpResult.xpEarned + streakResult.streakBonus,\n      streakBonus: streakResult.streakBonus,\n      streakDays: streakResult.streakDays,\n      leveledUp: xpResult.leveledUp,\n    }\n  }\n\n  return {\n    firstLoginToday: false,\n    streakDays: gamification.streakDays,\n  }\n}\n\nexport async function updateSkillScores(\n  userId: string,\n  scores: {\n    grammar?: number\n    vocabulary?: number\n    speaking?: number\n    listening?: number\n    confidence?: number\n    fluency?: number\n  }\n) {\n  const gamification = await getOrCreateGamification(userId)\n\n  const calculateScore = (existing: number, newScore?: number) => {\n    if (newScore === undefined) return existing\n    return Math.round(existing * 0.7 + newScore * 0.3)\n  }\n\n  const updated = await db.userGamification.update({\n    where: { userId },\n    data: {\n      grammarScore: calculateScore(gamification.grammarScore, scores.grammar),\n      vocabularyScore: calculateScore(gamification.vocabularyScore, scores.vocabulary),\n      speakingScore: calculateScore(gamification.speakingScore, scores.speaking),\n      listeningScore: calculateScore(gamification.listeningScore, scores.listening),\n      confidenceScore: calculateScore(gamification.confidenceScore, scores.confidence),\n      fluencyScore: calculateScore(gamification.fluencyScore, scores.fluency),\n    },\n  })\n\n  if (scores.confidence && scores.confidence > gamification.confidenceScore + 5) {\n    await logActivity(userId, 'CONFIDENCE_MILESTONE', {\n      previousScore: gamification.confidenceScore,\n      newScore: updated.confidenceScore,\n      delta: updated.confidenceScore - gamification.confidenceScore,\n    })\n  }\n\n  return updated\n}\n\nexport async function getGamificationSummary(userId: string) {\n  const gamification = await getOrCreateGamification(userId)\n  const nextLevelXp = getXpForNextLevel(gamification.level)\n  const currentLevelXp = XP_LEVELS[gamification.level]\n  const progress = getLevelProgress(gamification.xp, gamification.level)\n\n  return {\n    level: gamification.level,\n    xp: gamification.xp,\n    nextLevelXp,\n    currentLevelXp,\n    progress,\n    xpToNextLevel: nextLevelXp - gamification.xp,\n    streakDays: gamification.streakDays,\n    longestStreak: gamification.longestStreak,\n    skills: {\n      grammar: gamification.grammarScore,\n      vocabulary: gamification.vocabularyScore,\n      speaking: gamification.speakingScore,\n      listening: gamification.listeningScore,\n      confidence: gamification.confidenceScore,\n      fluency: gamification.fluencyScore,\n    },\n    unlockedWorlds: gamification.unlockedWorlds,\n  }\n}\n\nexport async function unlockWorld(userId: string, worldId: string) {\n  const gamification = await getOrCreateGamification(userId)\n  \n  const current = gamification.unlockedWorlds ?? []\n  if (!current.includes(worldId)) {\n    const updated = await db.userGamification.update({\n      where: { userId },\n      data: {\n        unlockedWorlds: [...current, worldId],\n      },\n    })\n\n    await logActivity(userId, 'WORLD_UNLOCK', { worldId })\n\n    return { unlocked: true, updated }\n  }\n\n  return { unlocked: false }\n}\n\nexport async function canAccessWorld(userId: string, requiredLevel: number) {\n  const gamification = await getOrCreateGamification(userId)\n  return gamification.level >= requiredLevel\n}\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 1732, "column": 0}, "map": {"version":3,"sources":["file:///Users/nazy/ADK_WORKSPACE/TutorMekimi/tutorme-app/src/lib/gamification/badges.ts"],"sourcesContent":["/**\n * Badge System\n * \n * Defines all badges, their requirements, and handles badge awarding\n */\n\nimport { db } from '@/lib/db'\nimport { awardXp, XP_REWARDS } from './service'\nimport { logActivity } from './activity-log'\n\nexport interface BadgeDefinition {\n  key: string\n  name: string\n  description: string\n  icon: string\n  color: string\n  category: 'general' | 'streak' | 'quiz' | 'social' | 'mastery'\n  rarity: 'common' | 'rare' | 'epic' | 'legendary'\n  xpBonus: number\n  requirement: {\n    type: string\n    count?: number\n    score?: number\n    days?: number\n    level?: number\n  }\n  isSecret?: boolean\n  order: number\n}\n\n// Badge definitions - all available badges in the system\nexport const BADGE_DEFINITIONS: BadgeDefinition[] = [\n  // === GENERAL BADGES ===\n  {\n    key: 'first_steps',\n    name: 'First Steps',\n    description: 'Complete your first lesson',\n    icon: 'footprints',\n    color: '#22c55e',\n    category: 'general',\n    rarity: 'common',\n    xpBonus: 50,\n    requirement: { type: 'complete_lessons', count: 1 },\n    order: 1,\n  },\n  {\n    key: 'quick_learner',\n    name: 'Quick Learner',\n    description: 'Complete 10 lessons',\n    icon: 'zap',\n    color: '#3b82f6',\n    category: 'general',\n    rarity: 'common',\n    xpBonus: 100,\n    requirement: { type: 'complete_lessons', count: 10 },\n    order: 2,\n  },\n  {\n    key: 'knowledge_seeker',\n    name: 'Knowledge Seeker',\n    description: 'Complete 50 lessons',\n    icon: 'book-open',\n    color: '#8b5cf6',\n    category: 'general',\n    rarity: 'rare',\n    xpBonus: 250,\n    requirement: { type: 'complete_lessons', count: 50 },\n    order: 3,\n  },\n  {\n    key: 'master_scholar',\n    name: 'Master Scholar',\n    description: 'Complete 100 lessons',\n    icon: 'graduation-cap',\n    color: '#f59e0b',\n    category: 'general',\n    rarity: 'epic',\n    xpBonus: 500,\n    requirement: { type: 'complete_lessons', count: 100 },\n    order: 4,\n  },\n  \n  // === STREAK BADGES ===\n  {\n    key: 'streak_3',\n    name: 'On Fire',\n    description: 'Maintain a 3-day learning streak',\n    icon: 'flame',\n    color: '#f97316',\n    category: 'streak',\n    rarity: 'common',\n    xpBonus: 100,\n    requirement: { type: 'streak_days', days: 3 },\n    order: 10,\n  },\n  {\n    key: 'streak_7',\n    name: 'Week Warrior',\n    description: 'Maintain a 7-day learning streak',\n    icon: 'flame',\n    color: '#ef4444',\n    category: 'streak',\n    rarity: 'rare',\n    xpBonus: 250,\n    requirement: { type: 'streak_days', days: 7 },\n    order: 11,\n  },\n  {\n    key: 'streak_30',\n    name: 'Monthly Master',\n    description: 'Maintain a 30-day learning streak',\n    icon: 'crown',\n    color: '#eab308',\n    category: 'streak',\n    rarity: 'epic',\n    xpBonus: 1000,\n    requirement: { type: 'streak_days', days: 30 },\n    order: 12,\n  },\n  {\n    key: 'streak_100',\n    name: 'Centurion',\n    description: 'Maintain a 100-day learning streak',\n    icon: 'medal',\n    color: '#6366f1',\n    category: 'streak',\n    rarity: 'legendary',\n    xpBonus: 5000,\n    requirement: { type: 'streak_days', days: 100 },\n    order: 13,\n  },\n  \n  // === QUIZ BADGES ===\n  {\n    key: 'first_quiz',\n    name: 'Quiz Taker',\n    description: 'Complete your first quiz',\n    icon: 'help-circle',\n    color: '#10b981',\n    category: 'quiz',\n    rarity: 'common',\n    xpBonus: 50,\n    requirement: { type: 'complete_quizzes', count: 1 },\n    order: 20,\n  },\n  {\n    key: 'quiz_pro',\n    name: 'Quiz Pro',\n    description: 'Complete 20 quizzes',\n    icon: 'check-circle',\n    color: '#3b82f6',\n    category: 'quiz',\n    rarity: 'common',\n    xpBonus: 150,\n    requirement: { type: 'complete_quizzes', count: 20 },\n    order: 21,\n  },\n  {\n    key: 'perfect_score',\n    name: 'Perfect Score',\n    description: 'Score 100% on a quiz',\n    icon: 'star',\n    color: '#f59e0b',\n    category: 'quiz',\n    rarity: 'rare',\n    xpBonus: 200,\n    requirement: { type: 'perfect_quiz', count: 1 },\n    order: 22,\n  },\n  {\n    key: 'quiz_master',\n    name: 'Quiz Master',\n    description: 'Complete 50 quizzes with 80%+ average',\n    icon: 'trophy',\n    color: '#8b5cf6',\n    category: 'quiz',\n    rarity: 'epic',\n    xpBonus: 500,\n    requirement: { type: 'complete_quizzes_expert', count: 50, score: 80 },\n    order: 23,\n  },\n  \n  // === SOCIAL BADGES ===\n  {\n    key: 'social_butterfly',\n    name: 'Social Butterfly',\n    description: 'Join 5 live sessions',\n    icon: 'users',\n    color: '#ec4899',\n    category: 'social',\n    rarity: 'common',\n    xpBonus: 100,\n    requirement: { type: 'join_sessions', count: 5 },\n    order: 30,\n  },\n  {\n    key: 'active_participant',\n    name: 'Active Participant',\n    description: 'Send 50 messages in live sessions',\n    icon: 'message-circle',\n    color: '#06b6d4',\n    category: 'social',\n    rarity: 'rare',\n    xpBonus: 200,\n    requirement: { type: 'send_messages', count: 50 },\n    order: 31,\n  },\n  {\n    key: 'study_group_hero',\n    name: 'Study Group Hero',\n    description: 'Join or create 3 study groups',\n    icon: 'users-round',\n    color: '#84cc16',\n    category: 'social',\n    rarity: 'rare',\n    xpBonus: 300,\n    requirement: { type: 'join_groups', count: 3 },\n    order: 32,\n  },\n  \n  // === MASTERY BADGES ===\n  {\n    key: 'level_5',\n    name: 'Rising Star',\n    description: 'Reach level 5',\n    icon: 'rocket',\n    color: '#f97316',\n    category: 'mastery',\n    rarity: 'common',\n    xpBonus: 200,\n    requirement: { type: 'reach_level', level: 5 },\n    order: 40,\n  },\n  {\n    key: 'level_10',\n    name: 'Expert Learner',\n    description: 'Reach level 10',\n    icon: 'award',\n    color: '#3b82f6',\n    category: 'mastery',\n    rarity: 'rare',\n    xpBonus: 500,\n    requirement: { type: 'reach_level', level: 10 },\n    order: 41,\n  },\n  {\n    key: 'level_20',\n    name: 'Grandmaster',\n    description: 'Reach level 20',\n    icon: 'crown',\n    color: '#eab308',\n    category: 'mastery',\n    rarity: 'epic',\n    xpBonus: 2000,\n    requirement: { type: 'reach_level', level: 20 },\n    order: 42,\n  },\n  {\n    key: 'xp_10000',\n    name: 'XP Hunter',\n    description: 'Earn 10,000 total XP',\n    icon: 'target',\n    color: '#8b5cf6',\n    category: 'mastery',\n    rarity: 'rare',\n    xpBonus: 500,\n    requirement: { type: 'earn_xp', count: 10000 },\n    order: 43,\n  },\n  \n  // === SECRET BADGES ===\n  {\n    key: 'night_owl',\n    name: 'Night Owl',\n    description: 'Complete a lesson between midnight and 5 AM',\n    icon: 'moon',\n    color: '#6366f1',\n    category: 'general',\n    rarity: 'rare',\n    xpBonus: 150,\n    requirement: { type: 'night_study' },\n    isSecret: true,\n    order: 50,\n  },\n  {\n    key: 'early_bird',\n    name: 'Early Bird',\n    description: 'Complete a lesson before 7 AM',\n    icon: 'sunrise',\n    color: '#f59e0b',\n    category: 'general',\n    rarity: 'rare',\n    xpBonus: 150,\n    requirement: { type: 'morning_study' },\n    isSecret: true,\n    order: 51,\n  },\n]\n\n/**\n * Initialize badges in the database\n * Call this on app startup or via admin endpoint\n */\nexport async function initializeBadges() {\n  for (const badge of BADGE_DEFINITIONS) {\n    await db.badge.upsert({\n      where: { key: badge.key },\n      update: {\n        name: badge.name,\n        description: badge.description,\n        icon: badge.icon,\n        color: badge.color,\n        category: badge.category,\n        rarity: badge.rarity,\n        xpBonus: badge.xpBonus,\n        requirement: badge.requirement,\n        isSecret: badge.isSecret ?? false,\n        order: badge.order,\n      },\n      create: {\n        key: badge.key,\n        name: badge.name,\n        description: badge.description,\n        icon: badge.icon,\n        color: badge.color,\n        category: badge.category,\n        rarity: badge.rarity,\n        xpBonus: badge.xpBonus,\n        requirement: badge.requirement,\n        isSecret: badge.isSecret ?? false,\n        order: badge.order,\n      },\n    })\n  }\n  \n  console.log(`[Badges] Initialized ${BADGE_DEFINITIONS.length} badges`)\n}\n\n/**\n * Award a badge to a user\n */\nexport async function awardBadge(userId: string, badgeKey: string) {\n  const badge = await db.badge.findUnique({\n    where: { key: badgeKey },\n  })\n  \n  if (!badge) {\n    throw new Error(`Badge not found: ${badgeKey}`)\n  }\n  \n  // Check if user already has this badge\n  const existing = await db.userBadge.findFirst({\n    where: {\n      userId,\n      badgeId: badge.id,\n    },\n  })\n  \n  if (existing) {\n    return { awarded: false, alreadyHad: true }\n  }\n  \n  // Award the badge\n  const userBadge = await db.userBadge.create({\n    data: {\n      userId,\n      badgeId: badge.id,\n      earnedAt: new Date(),\n    },\n    include: {\n      badge: true,\n    },\n  })\n  \n  // Award XP bonus\n  if (badge.xpBonus > 0) {\n    await awardXp(userId, badge.xpBonus, 'badge_earned', { badgeKey })\n  }\n  \n  // Log activity\n  await logActivity(userId, 'BADGE_EARNED', {\n    badgeKey,\n    badgeName: badge.name,\n    rarity: badge.rarity,\n    xpBonus: badge.xpBonus,\n  })\n  \n  return {\n    awarded: true,\n    badge: userBadge.badge,\n    xpBonus: badge.xpBonus,\n  }\n}\n\n/**\n * Get all badges for a user\n */\nexport async function getUserBadges(userId: string) {\n  const userBadges = await db.userBadge.findMany({\n    where: { userId },\n    include: { badge: true },\n    orderBy: { earnedAt: 'desc' },\n  })\n  \n  return userBadges.map(ub => ({\n    ...ub.badge,\n    earnedAt: ub.earnedAt,\n  }))\n}\n\n/**\n * Get all available badges with user's progress\n */\nexport async function getAllBadgesWithProgress(userId: string) {\n  const [allBadges, userBadges] = await Promise.all([\n    db.badge.findMany({ orderBy: { order: 'asc' } }),\n    db.userBadge.findMany({\n      where: { userId },\n      select: { badgeId: true, earnedAt: true, progress: true },\n    }),\n  ])\n  \n  const earnedBadgeIds = new Set(userBadges.map(ub => ub.badgeId))\n  const userBadgeMap = new Map(userBadges.map(ub => [ub.badgeId, ub]))\n  \n  return allBadges.map(badge => ({\n    ...badge,\n    earned: earnedBadgeIds.has(badge.id),\n    earnedAt: userBadgeMap.get(badge.id)?.earnedAt || null,\n    progress: userBadgeMap.get(badge.id)?.progress || 0,\n  }))\n}\n\n/**\n * Check and award badges based on user stats\n */\nexport async function checkAndAwardBadges(userId: string, stats: {\n  lessonsCompleted?: number\n  quizzesCompleted?: number\n  streakDays?: number\n  currentLevel?: number\n  totalXp?: number\n  sessionsJoined?: number\n  messagesSent?: number\n  perfectQuizzes?: number\n  quizAverage?: number\n}) {\n  const badgesToCheck: string[] = []\n  \n  // Check lesson badges\n  if (stats.lessonsCompleted !== undefined) {\n    if (stats.lessonsCompleted >= 1) badgesToCheck.push('first_steps')\n    if (stats.lessonsCompleted >= 10) badgesToCheck.push('quick_learner')\n    if (stats.lessonsCompleted >= 50) badgesToCheck.push('knowledge_seeker')\n    if (stats.lessonsCompleted >= 100) badgesToCheck.push('master_scholar')\n  }\n  \n  // Check streak badges\n  if (stats.streakDays !== undefined) {\n    if (stats.streakDays >= 3) badgesToCheck.push('streak_3')\n    if (stats.streakDays >= 7) badgesToCheck.push('streak_7')\n    if (stats.streakDays >= 30) badgesToCheck.push('streak_30')\n    if (stats.streakDays >= 100) badgesToCheck.push('streak_100')\n  }\n  \n  // Check quiz badges\n  if (stats.quizzesCompleted !== undefined) {\n    if (stats.quizzesCompleted >= 1) badgesToCheck.push('first_quiz')\n    if (stats.quizzesCompleted >= 20) badgesToCheck.push('quiz_pro')\n  }\n  \n  if (stats.perfectQuizzes && stats.perfectQuizzes >= 1) {\n    badgesToCheck.push('perfect_score')\n  }\n  \n  if (stats.quizzesCompleted && stats.quizAverage && \n      stats.quizzesCompleted >= 50 && stats.quizAverage >= 80) {\n    badgesToCheck.push('quiz_master')\n  }\n  \n  // Check social badges\n  if (stats.sessionsJoined !== undefined) {\n    if (stats.sessionsJoined >= 5) badgesToCheck.push('social_butterfly')\n  }\n  \n  if (stats.messagesSent !== undefined) {\n    if (stats.messagesSent >= 50) badgesToCheck.push('active_participant')\n  }\n  \n  // Check mastery badges\n  if (stats.currentLevel !== undefined) {\n    if (stats.currentLevel >= 5) badgesToCheck.push('level_5')\n    if (stats.currentLevel >= 10) badgesToCheck.push('level_10')\n    if (stats.currentLevel >= 20) badgesToCheck.push('level_20')\n  }\n  \n  if (stats.totalXp !== undefined) {\n    if (stats.totalXp >= 10000) badgesToCheck.push('xp_10000')\n  }\n  \n  // Award badges\n  const awarded: Array<{ badgeKey: string; badgeName: string; xpBonus: number }> = []\n  \n  for (const badgeKey of badgesToCheck) {\n    const result = await awardBadge(userId, badgeKey)\n    if (result.awarded && result.badge) {\n      awarded.push({\n        badgeKey,\n        badgeName: result.badge.name,\n        xpBonus: result.xpBonus,\n      })\n    }\n  }\n  \n  return awarded\n}\n\n/**\n * Get badge statistics for a user\n */\nexport async function getBadgeStats(userId: string) {\n  const [earnedBadges, allBadges] = await Promise.all([\n    db.userBadge.findMany({\n      where: { userId },\n      include: { badge: true },\n    }),\n    db.badge.findMany(),\n  ])\n  \n  const byRarity = {\n    common: earnedBadges.filter(b => b.badge.rarity === 'common').length,\n    rare: earnedBadges.filter(b => b.badge.rarity === 'rare').length,\n    epic: earnedBadges.filter(b => b.badge.rarity === 'epic').length,\n    legendary: earnedBadges.filter(b => b.badge.rarity === 'legendary').length,\n  }\n  \n  const byCategory = {\n    general: earnedBadges.filter(b => b.badge.category === 'general').length,\n    streak: earnedBadges.filter(b => b.badge.category === 'streak').length,\n    quiz: earnedBadges.filter(b => b.badge.category === 'quiz').length,\n    social: earnedBadges.filter(b => b.badge.category === 'social').length,\n    mastery: earnedBadges.filter(b => b.badge.category === 'mastery').length,\n  }\n  \n  return {\n    totalEarned: earnedBadges.length,\n    totalAvailable: allBadges.length,\n    completionPercentage: Math.round((earnedBadges.length / allBadges.length) * 100),\n    byRarity,\n    byCategory,\n    totalXpFromBadges: earnedBadges.reduce((sum, b) => sum + b.badge.xpBonus, 0),\n  }\n}\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 2311, "column": 0}, "map": {"version":3,"sources":["file:///Users/nazy/ADK_WORKSPACE/TutorMekimi/tutorme-app/src/lib/gamification/leaderboard.ts"],"sourcesContent":["/**\n * Leaderboard Service\n * \n * Manages global, weekly, and class-specific leaderboards\n */\n\nimport { db } from '@/lib/db'\n\nexport type LeaderboardType = 'global' | 'weekly' | 'monthly' | `class_${string}`\n\nexport interface LeaderboardEntry {\n  rank: number\n  userId: string\n  name: string\n  avatar?: string\n  level: number\n  xp: number\n  score: number // XP earned in the period\n  streakDays: number\n  badges: number\n}\n\nexport interface LeaderboardData {\n  type: LeaderboardType\n  periodStart?: Date\n  periodEnd?: Date\n  entries: LeaderboardEntry[]\n  userRank?: LeaderboardEntry\n  totalParticipants: number\n}\n\n/**\n * Get or create leaderboard entry for a user\n */\nexport async function updateLeaderboardEntry(\n  userId: string,\n  type: LeaderboardType,\n  xpEarned: number,\n  periodStart?: Date,\n  periodEnd?: Date\n) {\n  const where: any = { userId, type }\n  \n  if (periodStart) {\n    where.periodStart = periodStart\n  }\n  \n  const existing = await db.leaderboardEntry.findFirst({ where })\n  \n  if (existing) {\n    return await db.leaderboardEntry.update({\n      where: { id: existing.id },\n      data: {\n        score: { increment: xpEarned },\n      },\n    })\n  } else {\n    return await db.leaderboardEntry.create({\n      data: {\n        userId,\n        type,\n        score: xpEarned,\n        periodStart,\n        periodEnd,\n      },\n    })\n  }\n}\n\n/**\n * Get leaderboard with rankings\n */\nexport async function getLeaderboard(\n  type: LeaderboardType,\n  limit: number = 100,\n  userId?: string\n): Promise<LeaderboardData> {\n  const now = new Date()\n  let periodStart: Date | undefined\n  let periodEnd: Date | undefined\n  \n  // Calculate period for weekly/monthly leaderboards\n  if (type === 'weekly') {\n    const dayOfWeek = now.getDay()\n    periodStart = new Date(now)\n    periodStart.setDate(now.getDate() - dayOfWeek)\n    periodStart.setHours(0, 0, 0, 0)\n    periodEnd = new Date(periodStart)\n    periodEnd.setDate(periodEnd.getDate() + 6)\n    periodEnd.setHours(23, 59, 59, 999)\n  } else if (type === 'monthly') {\n    periodStart = new Date(now.getFullYear(), now.getMonth(), 1)\n    periodEnd = new Date(now.getFullYear(), now.getMonth() + 1, 0, 23, 59, 59, 999)\n  }\n  \n  // Build where clause\n  const where: any = { type }\n  if (periodStart) {\n    where.periodStart = { gte: periodStart }\n  }\n  \n  // Get entries with user info\n  const entries = await db.leaderboardEntry.findMany({\n    where,\n    orderBy: { score: 'desc' },\n    take: limit,\n    include: {\n      user: {\n        include: {\n          profile: true,\n          gamification: true,\n          _count: {\n            select: { badges: true },\n          },\n        },\n      },\n    },\n  })\n  \n  // Format entries with ranks\n  const formattedEntries: LeaderboardEntry[] = entries.map((entry, index) => ({\n    rank: index + 1,\n    userId: entry.userId,\n    name: entry.user.profile?.name || `Student ${entry.userId.slice(-6)}`,\n    avatar: entry.user.profile?.avatar || undefined,\n    level: entry.user.gamification?.level || 1,\n    xp: entry.user.gamification?.xp || 0,\n    score: entry.score,\n    streakDays: entry.user.gamification?.streakDays || 0,\n    badges: entry.user._count.badges,\n  }))\n  \n  // Get user's rank if not in top entries\n  let userRank: LeaderboardEntry | undefined\n  if (userId && !entries.find(e => e.userId === userId)) {\n    userRank = await getUserRank(userId, type, periodStart)\n  } else if (userId) {\n    userRank = formattedEntries.find(e => e.userId === userId)\n  }\n  \n  // Get total participants\n  const totalParticipants = await db.leaderboardEntry.count({ where })\n  \n  return {\n    type,\n    periodStart,\n    periodEnd,\n    entries: formattedEntries,\n    userRank,\n    totalParticipants,\n  }\n}\n\n/**\n * Get a specific user's rank\n */\nasync function getUserRank(\n  userId: string,\n  type: LeaderboardType,\n  periodStart?: Date\n): Promise<LeaderboardEntry | undefined> {\n  const where: any = { type }\n  if (periodStart) {\n    where.periodStart = { gte: periodStart }\n  }\n  \n  // Get user's entry\n  const userEntry = await db.leaderboardEntry.findFirst({\n    where: { ...where, userId },\n    include: {\n      user: {\n        include: {\n          profile: true,\n          gamification: true,\n          _count: {\n            select: { badges: true },\n          },\n        },\n      },\n    },\n  })\n  \n  if (!userEntry) return undefined\n  \n  // Count users with higher scores\n  const higherRankCount = await db.leaderboardEntry.count({\n    where: {\n      ...where,\n      score: { gt: userEntry.score },\n    },\n  })\n  \n  return {\n    rank: higherRankCount + 1,\n    userId: userEntry.userId,\n    name: userEntry.user.profile?.name || `Student ${userEntry.userId.slice(-6)}`,\n    avatar: userEntry.user.profile?.avatar || undefined,\n    level: userEntry.user.gamification?.level || 1,\n    xp: userEntry.user.gamification?.xp || 0,\n    score: userEntry.score,\n    streakDays: userEntry.user.gamification?.streakDays || 0,\n    badges: userEntry.user._count.badges,\n  }\n}\n\n/**\n * Get leaderboard around a user (for \"near me\" view)\n */\nexport async function getLeaderboardAroundUser(\n  userId: string,\n  type: LeaderboardType,\n  range: number = 5\n): Promise<LeaderboardEntry[]> {\n  const now = new Date()\n  let periodStart: Date | undefined\n  \n  if (type === 'weekly') {\n    const dayOfWeek = now.getDay()\n    periodStart = new Date(now)\n    periodStart.setDate(now.getDate() - dayOfWeek)\n    periodStart.setHours(0, 0, 0, 0)\n  } else if (type === 'monthly') {\n    periodStart = new Date(now.getFullYear(), now.getMonth(), 1)\n  }\n  \n  const where: any = { type }\n  if (periodStart) {\n    where.periodStart = { gte: periodStart }\n  }\n  \n  // Get user's entry\n  const userEntry = await db.leaderboardEntry.findFirst({\n    where: { ...where, userId },\n  })\n  \n  if (!userEntry) {\n    // User has no entry, return top entries\n    const leaderboard = await getLeaderboard(type, range * 2 + 1, userId)\n    return leaderboard.entries\n  }\n  \n  // Get users with higher scores (rank above)\n  const aboveEntries = await db.leaderboardEntry.findMany({\n    where: {\n      ...where,\n      score: { gte: userEntry.score },\n      userId: { not: userId },\n    },\n    orderBy: { score: 'asc' },\n    take: range,\n    include: {\n      user: {\n        include: {\n          profile: true,\n          gamification: true,\n          _count: {\n            select: { badges: true },\n          },\n        },\n      },\n    },\n  })\n  \n  // Get users with lower scores (rank below)\n  const belowEntries = await db.leaderboardEntry.findMany({\n    where: {\n      ...where,\n      score: { lt: userEntry.score },\n    },\n    orderBy: { score: 'desc' },\n    take: range,\n    include: {\n      user: {\n        include: {\n          profile: true,\n          gamification: true,\n          _count: {\n            select: { badges: true },\n          },\n        },\n      },\n    },\n  })\n  \n  // Combine and calculate ranks\n  const allEntries = [...aboveEntries.reverse(), userEntry, ...belowEntries]\n  \n  // Find user's rank\n  const userRank = await db.leaderboardEntry.count({\n    where: {\n      ...where,\n      score: { gt: userEntry.score },\n    },\n  })\n  \n  return allEntries.map((entry, index) => ({\n    rank: userRank - aboveEntries.length + index + 1,\n    userId: entry.userId,\n    name: entry.user.profile?.name || `Student ${entry.userId.slice(-6)}`,\n    avatar: entry.user.profile?.avatar || undefined,\n    level: entry.user.gamification?.level || 1,\n    xp: entry.user.gamification?.xp || 0,\n    score: entry.score,\n    streakDays: entry.user.gamification?.streakDays || 0,\n    badges: entry.user._count.badges,\n  }))\n}\n\n/**\n * Reset weekly leaderboard\n * Call this via cron job every Sunday at midnight\n */\nexport async function resetWeeklyLeaderboard() {\n  const now = new Date()\n  const weekAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000)\n  \n  // Archive old entries or just delete them\n  // For now, we'll keep them for historical tracking\n  \n  console.log('[Leaderboard] Weekly leaderboard period ended')\n}\n\n/**\n * Reset monthly leaderboard\n * Call this via cron job on the 1st of each month\n */\nexport async function resetMonthlyLeaderboard() {\n  console.log('[Leaderboard] Monthly leaderboard period ended')\n}\n\n/**\n * Get user's leaderboard stats\n */\nexport async function getUserLeaderboardStats(userId: string) {\n  const [globalEntry, weeklyEntry, monthlyEntry] = await Promise.all([\n    db.leaderboardEntry.findFirst({\n      where: { userId, type: 'global' },\n    }),\n    db.leaderboardEntry.findFirst({\n      where: { userId, type: 'weekly' },\n    }),\n    db.leaderboardEntry.findFirst({\n      where: { userId, type: 'monthly' },\n    }),\n  ])\n  \n  const globalRank = globalEntry \n    ? await db.leaderboardEntry.count({\n        where: { type: 'global', score: { gt: globalEntry.score } },\n      }) + 1\n    : null\n  \n  const weeklyRank = weeklyEntry\n    ? await db.leaderboardEntry.count({\n        where: { type: 'weekly', score: { gt: weeklyEntry.score } },\n      }) + 1\n    : null\n  \n  const monthlyRank = monthlyEntry\n    ? await db.leaderboardEntry.count({\n        where: { type: 'monthly', score: { gt: monthlyEntry.score } },\n      }) + 1\n    : null\n  \n  return {\n    global: {\n      rank: globalRank,\n      score: globalEntry?.score || 0,\n    },\n    weekly: {\n      rank: weeklyRank,\n      score: weeklyEntry?.score || 0,\n    },\n    monthly: {\n      rank: monthlyRank,\n      score: monthlyEntry?.score || 0,\n    },\n  }\n}\n\n/**\n * Initialize global leaderboard entry for a new user\n */\nexport async function initializeUserLeaderboard(userId: string) {\n  await db.leaderboardEntry.create({\n    data: {\n      userId,\n      type: 'global',\n      score: 0,\n    },\n  })\n}\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 2695, "column": 0}, "map": {"version":3,"sources":["file:///Users/nazy/ADK_WORKSPACE/TutorMekimi/tutorme-app/src/lib/gamification/triggers.ts"],"sourcesContent":["/**\n * Gamification Triggers\n * \n * Automatically triggers gamification events based on user actions\n * This should be called from various parts of the application\n */\n\nimport { db } from '@/lib/db'\nimport { awardXp, XP_REWARDS, getOrCreateGamification, checkDailyLogin } from './service'\nimport { checkAndAwardBadges, awardBadge } from './badges'\nimport { updateLeaderboardEntry } from './leaderboard'\n\n/**\n * Triggered when a user completes a lesson\n */\nexport async function onLessonComplete(userId: string, lessonId: string) {\n  const results: any = {\n    xpEarned: 0,\n    badgesEarned: [],\n    leveledUp: false,\n  }\n  \n  // Award XP\n  const xpResult = await awardXp(userId, XP_REWARDS.COMPLETE_LESSON, 'lesson_complete', { lessonId })\n  results.xpEarned = xpResult.xpEarned\n  results.leveledUp = xpResult.leveledUp\n  results.newLevel = xpResult.level\n  \n  // Update leaderboard\n  await updateLeaderboardEntry(userId, 'global', xpResult.xpEarned)\n  await updateLeaderboardEntry(userId, 'weekly', xpResult.xpEarned)\n  await updateLeaderboardEntry(userId, 'monthly', xpResult.xpEarned)\n  \n  // Check for badges\n  const gamification = await getOrCreateGamification(userId)\n  const completedLessons = await db.taskSubmission.count({\n    where: { studentId: userId },\n  })\n  \n  const badgeResults = await checkAndAwardBadges(userId, {\n    lessonsCompleted: completedLessons,\n    streakDays: gamification.streakDays,\n    currentLevel: gamification.level,\n    totalXp: gamification.xp,\n  })\n  \n  results.badgesEarned = badgeResults\n  \n  return results\n}\n\n/**\n * Triggered when a user completes a quiz\n */\nexport async function onQuizComplete(\n  userId: string, \n  quizId: string, \n  score: number,\n  isPerfect: boolean\n) {\n  const results: any = {\n    xpEarned: 0,\n    badgesEarned: [],\n    leveledUp: false,\n  }\n  \n  // Award XP based on score\n  const xpAmount = isPerfect ? XP_REWARDS.PERFECT_QUIZ : Math.round(XP_REWARDS.PERFECT_QUIZ * (score / 100))\n  const xpResult = await awardXp(userId, xpAmount, 'quiz_complete', { quizId, score, isPerfect })\n  \n  results.xpEarned = xpResult.xpEarned\n  results.leveledUp = xpResult.leveledUp\n  results.newLevel = xpResult.level\n  \n  // Update leaderboard\n  await updateLeaderboardEntry(userId, 'global', xpResult.xpEarned)\n  await updateLeaderboardEntry(userId, 'weekly', xpResult.xpEarned)\n  await updateLeaderboardEntry(userId, 'monthly', xpResult.xpEarned)\n  \n  // Check for badges\n  const gamification = await getOrCreateGamification(userId)\n  \n  // Get quiz stats\n  const quizAttempts = await db.quizAttempt.count({ where: { studentId: userId } })\n  const perfectQuizzes = await db.quizAttempt.count({\n    where: { studentId: userId, score: 100 },\n  })\n  const avgScore = await db.quizAttempt.aggregate({\n    where: { studentId: userId },\n    _avg: { score: true },\n  })\n  \n  const badgeResults = await checkAndAwardBadges(userId, {\n    quizzesCompleted: quizAttempts,\n    perfectQuizzes,\n    quizAverage: avgScore._avg.score || 0,\n    streakDays: gamification.streakDays,\n    currentLevel: gamification.level,\n    totalXp: gamification.xp,\n  })\n  \n  results.badgesEarned = badgeResults\n  \n  // Award perfect score badge immediately if applicable\n  if (isPerfect) {\n    const perfectBadge = await awardBadge(userId, 'perfect_score')\n    if (perfectBadge.awarded && perfectBadge.badge) {\n      results.badgesEarned.push({\n        badgeKey: 'perfect_score',\n        badgeName: perfectBadge.badge.name,\n        xpBonus: perfectBadge.xpBonus,\n      })\n    }\n  }\n  \n  return results\n}\n\n/**\n * Triggered when a user logs in (handles streaks)\n */\nexport async function onUserLogin(userId: string) {\n  const results: any = {\n    xpEarned: 0,\n    badgesEarned: [],\n    streakBonus: 0,\n    leveledUp: false,\n    firstLoginToday: false,\n  }\n  \n  // Check daily login\n  const loginResult = await checkDailyLogin(userId)\n  \n  results.firstLoginToday = loginResult.firstLoginToday\n  results.xpEarned = loginResult.xpEarned || 0\n  results.streakBonus = loginResult.streakBonus || 0\n  results.streakDays = loginResult.streakDays\n  results.leveledUp = loginResult.leveledUp\n  \n  if (loginResult.firstLoginToday) {\n    // Update leaderboard\n    await updateLeaderboardEntry(userId, 'global', loginResult.xpEarned || 0)\n    await updateLeaderboardEntry(userId, 'weekly', loginResult.xpEarned || 0)\n    await updateLeaderboardEntry(userId, 'monthly', loginResult.xpEarned || 0)\n    \n    // Check for streak badges\n    const gamification = await getOrCreateGamification(userId)\n    const badgeResults = await checkAndAwardBadges(userId, {\n      streakDays: gamification.streakDays,\n      currentLevel: gamification.level,\n      totalXp: gamification.xp,\n    })\n    \n    results.badgesEarned = badgeResults\n  }\n  \n  return results\n}\n\n/**\n * Triggered when a user joins a live session\n */\nexport async function onSessionJoin(userId: string, sessionId: string) {\n  const results: any = {\n    badgesEarned: [],\n  }\n  \n  // Check for social badges\n  const gamification = await getOrCreateGamification(userId)\n  const sessionsJoined = await db.sessionParticipant.count({\n    where: { studentId: userId },\n  })\n  \n  const badgeResults = await checkAndAwardBadges(userId, {\n    sessionsJoined,\n    streakDays: gamification.streakDays,\n    currentLevel: gamification.level,\n    totalXp: gamification.xp,\n  })\n  \n  results.badgesEarned = badgeResults\n  \n  return results\n}\n\n/**\n * Triggered when a user sends a message in a live session\n */\nexport async function onMessageSend(userId: string, sessionId: string) {\n  const results: any = {\n    badgesEarned: [],\n  }\n  \n  // Check for social badges\n  const gamification = await getOrCreateGamification(userId)\n  const messagesSent = await db.message.count({\n    where: { userId },\n  })\n  \n  const badgeResults = await checkAndAwardBadges(userId, {\n    messagesSent,\n    streakDays: gamification.streakDays,\n    currentLevel: gamification.level,\n    totalXp: gamification.xp,\n  })\n  \n  results.badgesEarned = badgeResults\n  \n  return results\n}\n\n/**\n * Triggered when a user levels up\n */\nexport async function onLevelUp(userId: string, newLevel: number) {\n  const results: any = {\n    badgesEarned: [],\n  }\n  \n  // Check for level-based badges\n  const gamification = await getOrCreateGamification(userId)\n  const badgeResults = await checkAndAwardBadges(userId, {\n    currentLevel: newLevel,\n    streakDays: gamification.streakDays,\n    totalXp: gamification.xp,\n  })\n  \n  results.badgesEarned = badgeResults\n  \n  return results\n}\n\n/**\n * Triggered when a user completes a mission\n */\nexport async function onMissionComplete(userId: string, missionId: string, xpReward: number) {\n  const results: any = {\n    xpEarned: xpReward,\n    badgesEarned: [],\n    leveledUp: false,\n  }\n  \n  // Award XP\n  const xpResult = await awardXp(userId, xpReward, 'mission_complete', { missionId })\n  results.leveledUp = xpResult.leveledUp\n  results.newLevel = xpResult.level\n  \n  // Update leaderboard\n  await updateLeaderboardEntry(userId, 'global', xpReward)\n  await updateLeaderboardEntry(userId, 'weekly', xpReward)\n  await updateLeaderboardEntry(userId, 'monthly', xpReward)\n  \n  return results\n}\n\n/**\n * Triggered when a user completes a speaking practice session\n */\nexport async function onSpeakingPractice(userId: string, duration: number, score?: number) {\n  const results: any = {\n    xpEarned: 0,\n    badgesEarned: [],\n    leveledUp: false,\n  }\n  \n  // Award XP based on duration (1 XP per minute, minimum 10)\n  const xpAmount = Math.max(10, Math.round(duration / 60))\n  const xpResult = await awardXp(userId, xpAmount, 'speaking_practice', { duration, score })\n  \n  results.xpEarned = xpResult.xpEarned\n  results.leveledUp = xpResult.leveledUp\n  \n  // Update leaderboard\n  await updateLeaderboardEntry(userId, 'global', xpResult.xpEarned)\n  await updateLeaderboardEntry(userId, 'weekly', xpResult.xpEarned)\n  await updateLeaderboardEntry(userId, 'monthly', xpResult.xpEarned)\n  \n  return results\n}\n\n/**\n * Triggered when a user has an AI conversation\n */\nexport async function onAIConversation(userId: string, messageCount: number) {\n  const results: any = {\n    xpEarned: 0,\n    badgesEarned: [],\n    leveledUp: false,\n  }\n  \n  // Award XP for AI conversation\n  const xpResult = await awardXp(userId, XP_REWARDS.AI_CONVERSATION, 'ai_conversation', { messageCount })\n  \n  results.xpEarned = xpResult.xpEarned\n  results.leveledUp = xpResult.leveledUp\n  \n  // Update leaderboard\n  await updateLeaderboardEntry(userId, 'global', xpResult.xpEarned)\n  await updateLeaderboardEntry(userId, 'weekly', xpResult.xpEarned)\n  await updateLeaderboardEntry(userId, 'monthly', xpResult.xpEarned)\n  \n  return results\n}\n\n/**\n * Check for time-based badges (night owl, early bird)\n */\nexport async function checkTimeBasedBadges(userId: string) {\n  const hour = new Date().getHours()\n  const results: any = {\n    badgesEarned: [],\n  }\n  \n  // Night Owl: midnight to 5 AM\n  if (hour >= 0 && hour < 5) {\n    const badge = await awardBadge(userId, 'night_owl')\n    if (badge.awarded && badge.badge) {\n      results.badgesEarned.push({\n        badgeKey: 'night_owl',\n        badgeName: badge.badge.name,\n        xpBonus: badge.xpBonus,\n      })\n    }\n  }\n  \n  // Early Bird: before 7 AM\n  if (hour >= 5 && hour < 7) {\n    const badge = await awardBadge(userId, 'early_bird')\n    if (badge.awarded && badge.badge) {\n      results.badgesEarned.push({\n        badgeKey: 'early_bird',\n        badgeName: badge.badge.name,\n        xpBonus: badge.xpBonus,\n      })\n    }\n  }\n  \n  return results\n}\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 3001, "column": 0}, "map": {"version":3,"sources":["file:///Users/nazy/ADK_WORKSPACE/TutorMekimi/tutorme-app/src/app/api/gamification/daily-login/route.ts"],"sourcesContent":["/**\n * Daily Login API\n * \n * POST /api/gamification/daily-login - Check daily login and award streak/XP\n */\n\nimport { NextResponse } from 'next/server'\nimport { withAuth, withCsrf } from '@/lib/api/middleware'\nimport { onUserLogin, checkTimeBasedBadges } from '@/lib/gamification/triggers'\n\nexport const POST = withCsrf(withAuth(async (req, session) => {\n  // Check daily login, streak, and award XP\n  const result = await onUserLogin(session.user.id)\n  \n  // Check for time-based badges (night owl, early bird)\n  const timeBadges = await checkTimeBasedBadges(session.user.id)\n  \n  return NextResponse.json({ \n    success: true, \n    data: {\n      ...result,\n      timeBasedBadges: timeBadges.badgesEarned,\n    } \n  })\n}, { role: 'STUDENT' }))\n"],"names":[],"mappings":";;;;AAAA;;;;CAIC,GAED;AACA;AACA;;;;AAEO,MAAM,OAAO,IAAA,+LAAQ,EAAC,IAAA,+LAAQ,EAAC,OAAO,KAAK;IAChD,0CAA0C;IAC1C,MAAM,SAAS,MAAM,IAAA,yMAAW,EAAC,QAAQ,IAAI,CAAC,EAAE;IAEhD,sDAAsD;IACtD,MAAM,aAAa,MAAM,IAAA,kNAAoB,EAAC,QAAQ,IAAI,CAAC,EAAE;IAE7D,OAAO,kMAAY,CAAC,IAAI,CAAC;QACvB,SAAS;QACT,MAAM;YACJ,GAAG,MAAM;YACT,iBAAiB,WAAW,YAAY;QAC1C;IACF;AACF,GAAG;IAAE,MAAM;AAAU"}}]
}