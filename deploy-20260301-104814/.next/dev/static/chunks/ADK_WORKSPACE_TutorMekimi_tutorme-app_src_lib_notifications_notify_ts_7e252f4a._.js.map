{
  "version": 3,
  "sources": [],
  "debugId": "8bf1b58a-24c2-fc2b-d2bb-35c01fc97ab4",
  "sections": [
    {"offset": {"line": 5, "column": 0}, "map": {"version":3,"sources":["file:///Users/nazy/ADK_WORKSPACE/TutorMekimi/tutorme-app/src/lib/notifications/notify.ts"],"sourcesContent":["/**\n * Central Notification Service\n *\n * Handles all three channels in one call:\n *  - In-app (DB record)\n *  - Email (via Resend API)\n *  - Real-time push (via SSE broadcast)\n *\n * Usage:\n *   import { notify, notifyMany } from '@/lib/notifications/notify'\n *   await notify({ userId, type: 'assignment', title, message, actionUrl })\n *   await notifyMany({ userIds: [...], type, title, message })\n */\n\nimport { db } from '@/lib/db'\n\n// ---- Types ----\n\nexport type NotificationType =\n    | 'assignment'\n    | 'class'\n    | 'message'\n    | 'enrollment'\n    | 'payment'\n    | 'system'\n    | 'reminder'\n    | 'achievement'\n    | 'grade'\n\ninterface NotifyParams {\n    userId: string\n    type: NotificationType\n    title: string\n    message: string\n    data?: Record<string, unknown>\n    actionUrl?: string\n    /** Skip checking preferences (for critical system notifications) */\n    force?: boolean\n}\n\ninterface NotifyManyParams {\n    userIds: string[]\n    type: NotificationType\n    title: string\n    message: string\n    data?: Record<string, unknown>\n    actionUrl?: string\n    force?: boolean\n}\n\n// ---- SSE Event Bus (in-memory) ----\n\ntype SSECallback = (notification: any) => void\nconst sseListeners = new Map<string, Set<SSECallback>>()\n\nexport function addSSEListener(userId: string, cb: SSECallback) {\n    if (!sseListeners.has(userId)) sseListeners.set(userId, new Set())\n    sseListeners.get(userId)!.add(cb)\n    return () => {\n        sseListeners.get(userId)?.delete(cb)\n        if (sseListeners.get(userId)?.size === 0) sseListeners.delete(userId)\n    }\n}\n\nfunction broadcastToUser(userId: string, notification: any) {\n    const listeners = sseListeners.get(userId)\n    if (listeners) {\n        for (const cb of listeners) {\n            try { cb(notification) } catch { /* ignore */ }\n        }\n    }\n}\n\n// ---- Preference Check ----\n\ninterface ChannelDecision {\n    inApp: boolean\n    email: boolean\n    push: boolean\n}\n\nasync function getChannelDecision(\n    userId: string,\n    type: NotificationType,\n    force: boolean\n): Promise<ChannelDecision> {\n    if (force) return { inApp: true, email: true, push: true }\n\n    const prefs = await db.notificationPreference.findUnique({\n        where: { userId },\n    })\n\n    if (!prefs) return { inApp: true, email: true, push: true } // defaults\n\n    // Start with global toggles\n    let decision: ChannelDecision = {\n        inApp: prefs.inAppEnabled,\n        email: prefs.emailEnabled,\n        push: prefs.pushEnabled,\n    }\n\n    // Apply per-type overrides\n    const overrides = prefs.channelOverrides as Record<string, any> | null\n    if (overrides && overrides[type]) {\n        const typeOverride = overrides[type]\n        if (typeof typeOverride.inApp === 'boolean') decision.inApp = typeOverride.inApp\n        if (typeof typeOverride.email === 'boolean') decision.email = typeOverride.email\n        if (typeof typeOverride.push === 'boolean') decision.push = typeOverride.push\n    }\n\n    // Check quiet hours for push/email\n    if (prefs.quietHoursStart && prefs.quietHoursEnd) {\n        const isQuiet = isInQuietHours(prefs.quietHoursStart, prefs.quietHoursEnd, prefs.timezone)\n        if (isQuiet) {\n            decision.push = false\n            // Email follows digest preference during quiet hours\n        }\n    }\n\n    // Email digest: if not \"instant\", skip immediate email\n    if (prefs.emailDigest !== 'instant') {\n        decision.email = false\n    }\n\n    return decision\n}\n\nfunction isInQuietHours(start: string, end: string, timezone: string): boolean {\n    try {\n        const now = new Date()\n        const formatter = new Intl.DateTimeFormat('en-US', {\n            timeZone: timezone,\n            hour: '2-digit',\n            minute: '2-digit',\n            hour12: false,\n        })\n        const currentTime = formatter.format(now) // \"HH:MM\"\n\n        // Simple string comparison works for HH:mm format\n        if (start <= end) {\n            return currentTime >= start && currentTime <= end\n        }\n        // Wraps midnight (e.g. 22:00 - 07:00)\n        return currentTime >= start || currentTime <= end\n    } catch {\n        return false\n    }\n}\n\n// ---- Email Sending ----\n\nasync function sendNotificationEmail(\n    userId: string,\n    type: NotificationType,\n    title: string,\n    message: string,\n    actionUrl?: string\n) {\n    const apiKey = process.env.RESEND_API_KEY\n    if (!apiKey) {\n        console.log(`[notify-email] (no RESEND_API_KEY) Would email user ${userId}: ${title}`)\n        return\n    }\n\n    // Fetch user email\n    const user = await db.user.findUnique({\n        where: { id: userId },\n        select: { email: true, name: true },\n    })\n    if (!user?.email) return\n\n    const from = process.env.NOTIFICATION_EMAIL_FROM || 'TutorMe <notifications@tutorme.com>'\n    const appUrl = process.env.NEXT_PUBLIC_APP_URL || 'http://localhost:3000'\n\n    const actionButton = actionUrl\n        ? `<p style=\"margin-top:16px\"><a href=\"${appUrl}${actionUrl}\" style=\"background:#3b82f6;color:white;padding:10px 20px;border-radius:6px;text-decoration:none;display:inline-block\">View Details</a></p>`\n        : ''\n\n    const html = `\n    <div style=\"max-width:480px;margin:0 auto;font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif\">\n      <div style=\"padding:24px;background:#f8fafc;border-radius:12px\">\n        <h2 style=\"margin:0 0 8px;color:#1e293b;font-size:18px\">${title}</h2>\n        <p style=\"margin:0;color:#475569;font-size:14px;line-height:1.6\">${message}</p>\n        ${actionButton}\n      </div>\n      <p style=\"text-align:center;color:#94a3b8;font-size:12px;margin-top:16px\">\n        You can <a href=\"${appUrl}/student/settings\" style=\"color:#3b82f6\">manage your notification preferences</a>.\n      </p>\n    </div>\n  `\n\n    try {\n        const res = await fetch('https://api.resend.com/emails', {\n            method: 'POST',\n            headers: {\n                'Content-Type': 'application/json',\n                Authorization: `Bearer ${apiKey}`,\n            },\n            body: JSON.stringify({\n                from,\n                to: user.email,\n                subject: `${title} â€“ TutorMe`,\n                html,\n            }),\n        })\n        if (!res.ok) {\n            const err = await res.text()\n            console.error(`[notify-email] Resend failed:`, res.status, err)\n        }\n    } catch (e) {\n        console.error(`[notify-email] Send failed:`, e)\n    }\n}\n\n// ---- Main Functions ----\n\n/**\n * Send a notification to a single user across all enabled channels.\n */\nexport async function notify(params: NotifyParams) {\n    const { userId, type, title, message, data, actionUrl, force = false } = params\n\n    const channels = await getChannelDecision(userId, type, force)\n\n    let notification = null\n\n    // 1. In-app notification (DB)\n    if (channels.inApp) {\n        notification = await db.notification.create({\n            data: {\n                userId,\n                type,\n                title,\n                message,\n                data: data ?? undefined,\n                actionUrl,\n            },\n        })\n    }\n\n    // 2. Real-time push via SSE\n    if (channels.push) {\n        broadcastToUser(userId, notification ?? { type, title, message, actionUrl, createdAt: new Date() })\n    }\n\n    // 3. Email\n    if (channels.email) {\n        // Fire-and-forget (don't block the response)\n        sendNotificationEmail(userId, type, title, message, actionUrl).catch((e) =>\n            console.error('[notify] Email send error:', e)\n        )\n    }\n\n    return notification\n}\n\n/**\n * Send a notification to multiple users at once.\n */\nexport async function notifyMany(params: NotifyManyParams) {\n    const { userIds, type, title, message, data, actionUrl, force = false } = params\n\n    const results = await Promise.allSettled(\n        userIds.map((userId) =>\n            notify({ userId, type, title, message, data, actionUrl, force })\n        )\n    )\n\n    const succeeded = results.filter((r) => r.status === 'fulfilled').length\n    const failed = results.filter((r) => r.status === 'rejected').length\n\n    return { sent: succeeded, failed, total: userIds.length }\n}\n"],"names":[],"mappings":"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"}}]
}