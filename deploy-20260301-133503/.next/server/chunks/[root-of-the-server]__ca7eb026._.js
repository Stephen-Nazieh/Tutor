;!function(){try { var e="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof global?global:"undefined"!=typeof window?window:"undefined"!=typeof self?self:{},n=(new e.Error).stack;n&&((e._debugIds|| (e._debugIds={}))[n]="03bf2f36-7b51-8928-f3eb-a4caa1961d63")}catch(e){}}();
module.exports=[491405,e=>{"use strict";let t;var r=e.i(841195),a=e.i(254799),s=e.i(406461),i=e.i(224361);let n=(0,i.promisify)(s.gzip),o=(0,i.promisify)(s.gunzip),c={PREFIX:"tutorme:cache:",TAG_PREFIX:"tutorme:tags:",METRIC_PREFIX:"tutorme:metrics:",COMPRESS_THRESHOLD:1024,ENCRYPTION_ALGORITHM:"aes-256-gcm",ENCRYPTION_KEY_LENGTH:32,CONNECTION_TIMEOUT:2e3,COMMAND_TIMEOUT:3e3,KEEP_ALIVE:3e4,MAX_RETRIES:5,RETRY_DELAY_BASE:100,HEALTH_CHECK_INTERVAL:3e4,MEMORY_CACHE_MAX_SIZE:1e3,MEMORY_CACHE_TTL:60,TTL_DEFAULT:parseInt(process.env.CACHE_TTL_DEFAULT||"60",10),TTL_USER:parseInt(process.env.CACHE_TTL_USER||"300",10),TTL_LEADERBOARD:parseInt(process.env.CACHE_TTL_LEADERBOARD||"300",10),TTL_CONTENT:parseInt(process.env.CACHE_TTL_CONTENT||"600",10)};r.z.object({value:r.z.unknown(),compressed:r.z.boolean().default(!1),encrypted:r.z.boolean().default(!1),tags:r.z.array(r.z.string()).default([]),createdAt:r.z.number(),ttl:r.z.number()});let l=r.z.object({hits:r.z.number().default(0),misses:r.z.number().default(0),sets:r.z.number().default(0),deletes:r.z.number().default(0),errors:r.z.number().default(0),totalLatencyMs:r.z.number().default(0),compressionRatio:r.z.number().default(0),memoryCacheHits:r.z.number().default(0),redisCacheHits:r.z.number().default(0)});class h{key;constructor(){const e=process.env.CACHE_ENCRYPTION_KEY;if(e){if(this.key=Buffer.from(e,"hex"),this.key.length!==c.ENCRYPTION_KEY_LENGTH)throw Error("CACHE_ENCRYPTION_KEY must be 64 hex characters (32 bytes)")}else{const e=process.env.NEXTAUTH_SECRET||"dev-secret-change-in-production";this.key=a.createHash("sha256").update(e).digest()}}encrypt(e){let t=a.randomBytes(16),r=a.createCipheriv(c.ENCRYPTION_ALGORITHM,this.key,t),s=r.update(e,"utf8","hex");s+=r.final("hex");let i=r.getAuthTag();return`${t.toString("hex")}:${i.toString("hex")}:${s}`}decrypt(e){let[t,r,s]=e.split(":");if(!t||!r||!s)throw Error("Invalid encrypted data format");let i=Buffer.from(t,"hex"),n=Buffer.from(r,"hex"),o=a.createDecipheriv(c.ENCRYPTION_ALGORITHM,this.key,i);o.setAuthTag(n);let l=o.update(s,"hex","utf8");return l+o.final("utf8")}}class d{cache;maxSize;constructor(e=c.MEMORY_CACHE_MAX_SIZE){this.cache=new Map,this.maxSize=e}get(e){let t=this.cache.get(e);return t?t.expires<Date.now()?(this.cache.delete(e),null):t.data.value:null}set(e,t,r){if(this.cache.size>=this.maxSize&&!this.cache.has(e)){let e=this.cache.keys().next().value;e&&this.cache.delete(e)}this.cache.set(e,{data:t,expires:Date.now()+1e3*r})}delete(e){this.cache.delete(e)}clear(){this.cache.clear()}size(){return this.cache.size}cleanup(){let e=Date.now(),t=0;for(let[r,a]of Array.from(this.cache.entries()))a.expires<e&&(this.cache.delete(r),t++);return t}}let u=globalThis;u.cacheManager||(u.cacheManager=new class{redis=null;memoryCache;encryption;metrics;performanceHook=null;healthCheckInterval=null;isHealthy=!1;initializationPromise=null;constructor(){this.memoryCache=new d,this.encryption=new h,this.metrics=l.parse({}),setInterval(()=>{this.memoryCache.cleanup()},6e4)}async initialize(){return this.initializationPromise||(this.initializationPromise=this._initialize()),this.initializationPromise}async _initialize(){let t=process.env.REDIS_URL;if(!t)return void console.warn("[CacheManager] REDIS_URL not configured, using in-memory cache only");try{let{Redis:r}=await e.A(443460);this.redis=new r(t,{connectTimeout:c.CONNECTION_TIMEOUT,commandTimeout:c.COMMAND_TIMEOUT,keepAlive:c.KEEP_ALIVE,lazyConnect:!1,retryStrategy:e=>{if(e>c.MAX_RETRIES)return console.error("[CacheManager] Max retries reached, giving up"),null;let t=Math.min(c.RETRY_DELAY_BASE*Math.pow(2,e-1),2e3);return console.warn(`[CacheManager] Retry attempt ${e} after ${t}ms`),t},maxRetriesPerRequest:3,enableReadyCheck:!0,enableOfflineQueue:!0,showFriendlyErrorStack:!1}),this.redis.on("connect",()=>{console.log("[CacheManager] Redis connected"),this.isHealthy=!0}),this.redis.on("ready",()=>{console.log("[CacheManager] Redis ready"),this.isHealthy=!0}),this.redis.on("error",e=>{console.error("[CacheManager] Redis error:",e.message),this.isHealthy=!1,this.metrics.errors++}),this.redis.on("close",()=>{console.warn("[CacheManager] Redis connection closed"),this.isHealthy=!1}),this.redis.on("reconnecting",e=>{console.log(`[CacheManager] Redis reconnecting in ${e}ms`)}),await this.redis.ping(),console.log("[CacheManager] Redis initialized successfully"),this.startHealthCheck()}catch(e){console.error("[CacheManager] Failed to initialize Redis:",e),this.redis=null,this.isHealthy=!1}}startHealthCheck(){this.healthCheckInterval||(this.healthCheckInterval=setInterval(async()=>{if(!this.redis){this.isHealthy=!1;return}try{await Promise.race([this.redis.ping(),new Promise((e,t)=>setTimeout(()=>t(Error("Health check timeout")),1e3))]),this.isHealthy=!0}catch(e){console.warn("[CacheManager] Health check failed:",e),this.isHealthy=!1}},c.HEALTH_CHECK_INTERVAL))}isCacheHealthy(){return this.isHealthy||null===this.redis}getRedisClient(){return this.redis}setPerformanceHook(e){this.performanceHook=e}recordMetrics(e,t,r,a="none"){r?"get"===e?(this.metrics.hits++,"memory"===a&&this.metrics.memoryCacheHits++,"redis"===a&&this.metrics.redisCacheHits++):"set"===e?this.metrics.sets++:"delete"===e&&this.metrics.deletes++:(this.metrics.misses++,"get"!==e&&this.metrics.errors++),this.metrics.totalLatencyMs+=t,this.performanceHook&&this.performanceHook(e,t,r)}getMetrics(){let e=this.metrics.hits+this.metrics.misses>0?this.metrics.hits/(this.metrics.hits+this.metrics.misses):0,t=this.metrics.hits+this.metrics.misses>0?this.metrics.totalLatencyMs/(this.metrics.hits+this.metrics.misses):0;return{...this.metrics,hitRate:e,avgLatencyMs:t}}resetMetrics(){this.metrics=l.parse({})}async get(e,t={}){let r=Date.now(),a=c.PREFIX+e;try{await this.initialize();let s=this.memoryCache.get(a);if(null!==s)return this.recordMetrics("get",Date.now()-r,!0,"memory"),s;if(this.redis&&this.isHealthy)try{let s=await this.redis.get(a);if(s){let i=await this.deserializeEntry(s),n=(Date.now()-i.createdAt)/1e3;if(n>=i.ttl)return await this.delete(e),this.recordMetrics("get",Date.now()-r,!1),null;if(this.memoryCache.set(a,i,i.ttl-n),t.schema){let e=t.schema.parse(i.value);return this.recordMetrics("get",Date.now()-r,!0,"redis"),e}return this.recordMetrics("get",Date.now()-r,!0,"redis"),i.value}}catch(e){console.error("[CacheManager] Redis get error:",e),this.isHealthy=!1}return this.recordMetrics("get",Date.now()-r,!1),null}catch(e){return console.error("[CacheManager] Get error:",e),this.recordMetrics("get",Date.now()-r,!1),null}}async set(e,t,r={}){let a=Date.now(),s=c.PREFIX+e,i=r.ttl||c.TTL_DEFAULT;try{await this.initialize();let e=t;r.schema&&(e=r.schema.parse(t));let n={value:e,compressed:!1,encrypted:!1,tags:r.tags||[],createdAt:Date.now(),ttl:i},o=await this.serializeEntry(n,r);if(this.memoryCache.set(s,n,i),this.redis&&this.isHealthy)try{return await this.redis.setex(s,i,o),n.tags.length>0&&await this.addTagsToKey(s,n.tags),this.recordMetrics("set",Date.now()-a,!0),!0}catch(e){return console.error("[CacheManager] Redis set error:",e),this.isHealthy=!1,this.recordMetrics("set",Date.now()-a,!0),!0}return this.recordMetrics("set",Date.now()-a,!0),!0}catch(e){return console.error("[CacheManager] Set error:",e),this.recordMetrics("set",Date.now()-a,!1),!1}}async delete(e){let t=Date.now(),r=c.PREFIX+e;try{if(this.memoryCache.delete(r),this.redis&&this.isHealthy)try{return await this.redis.del(r),await this.removeTagsFromKey(r),this.recordMetrics("delete",Date.now()-t,!0),!0}catch(e){return console.error("[CacheManager] Redis delete error:",e),this.isHealthy=!1,this.recordMetrics("delete",Date.now()-t,!0),!0}return this.recordMetrics("delete",Date.now()-t,!0),!0}catch(e){return console.error("[CacheManager] Delete error:",e),this.recordMetrics("delete",Date.now()-t,!1),!1}}async getOrSet(e,t,r={}){let a=await this.get(e,r);if(null!==a)return a;let s=await t();return await this.set(e,s,r),s}async clear(){let e=Date.now();try{if(this.memoryCache.clear(),this.redis&&this.isHealthy)try{let t=await this.redis.keys(c.PREFIX+"*");t.length>0&&await this.redis.del(...t);let r=await this.redis.keys(c.TAG_PREFIX+"*");return r.length>0&&await this.redis.del(...r),this.recordMetrics("delete",Date.now()-e,!0),!0}catch(t){return console.error("[CacheManager] Redis clear error:",t),this.isHealthy=!1,this.recordMetrics("delete",Date.now()-e,!0),!0}return this.recordMetrics("delete",Date.now()-e,!0),!0}catch(t){return console.error("[CacheManager] Clear error:",t),this.recordMetrics("delete",Date.now()-e,!1),!1}}async invalidateTag(e){let t=Date.now(),r=c.TAG_PREFIX+e;try{if(!this.redis||!this.isHealthy)return console.warn("[CacheManager] Tag invalidation requires Redis"),0;let e=await this.redis.smembers(r);if(0===e.length)return 0;let a=e.map(e=>c.PREFIX+e.replace(c.PREFIX,""));return a.forEach(e=>this.memoryCache.delete(e)),await this.redis.del(...a),await this.redis.del(r),this.recordMetrics("delete",Date.now()-t,!0),e.length}catch(e){return console.error("[CacheManager] Tag invalidation error:",e),this.recordMetrics("delete",Date.now()-t,!1),0}}async invalidateTags(e){let t=0;for(let r of e)t+=await this.invalidateTag(r);return t}async addTagsToKey(e,t){if(this.redis&&this.isHealthy&&0!==t.length)try{let r=this.redis.pipeline();for(let a of t){let t=c.TAG_PREFIX+a;r.sadd(t,e),r.expire(t,2*c.TTL_DEFAULT)}await r.exec()}catch(e){console.error("[CacheManager] Add tags error:",e)}}async removeTagsFromKey(e){if(this.redis&&this.isHealthy)try{let t=await this.redis.keys(c.TAG_PREFIX+"*");if(0===t.length)return;let r=this.redis.pipeline();for(let a of t)r.srem(a,e);await r.exec()}catch(e){console.error("[CacheManager] Remove tags error:",e)}}async serializeEntry(e,t){let r=JSON.stringify(e);return(void 0!==t.compress?t.compress:Buffer.byteLength(r,"utf8")>c.COMPRESS_THRESHOLD)&&(r=(await n(Buffer.from(r,"utf8"))).toString("base64"),e.compressed=!0),t.encrypt&&(r=this.encryption.encrypt(r),e.encrypted=!0),JSON.stringify({compressed:e.compressed,encrypted:e.encrypted,tags:e.tags,createdAt:e.createdAt,ttl:e.ttl,data:r})}async deserializeEntry(e){let t=JSON.parse(e),r=t.data;t.encrypted&&(r=this.encryption.decrypt(r)),t.compressed&&(r=(await o(Buffer.from(r,"base64"))).toString("utf8"));let a=JSON.parse(r);return a.compressed=t.compressed,a.encrypted=t.encrypted,a.tags=t.tags,a.createdAt=t.createdAt,a.ttl=t.ttl,a}async disconnect(){this.healthCheckInterval&&(clearInterval(this.healthCheckInterval),this.healthCheckInterval=null),this.redis&&(await this.redis.quit(),this.redis=null,this.isHealthy=!1),this.memoryCache.clear(),console.log("[CacheManager] Disconnected")}}),t=u.cacheManager,e.s(["default",0,t])},765770,e=>e.a(async(t,r)=>{try{var a=e.i(620971),s=e.i(909105),i=e.i(997103),n=e.i(320947),o=e.i(384030),c=e.i(738597);e.i(688768);var l=e.i(257357),h=e.i(491405),d=t([o,c]);[o,c]=d.then?(await d)():d;let u=(0,o.withAuth)(async(e,t)=>{let r=t.user?.id;if(!r)return a.NextResponse.json({error:"未授权"},{status:401});let o=`parent:messages:${r}`,d=await h.default.get(o);if(d)return a.NextResponse.json({success:!0,data:d});let u={conversations:(await c.drizzleDb.query.conversation.findMany({where:(0,s.or)((0,s.eq)(l.conversation.participant1Id,r),(0,s.eq)(l.conversation.participant2Id,r)),with:{participant1:{with:{profile:{columns:{name:!0}}},columns:{id:!0,email:!0}},participant2:{with:{profile:{columns:{name:!0}}},columns:{id:!0,email:!0}},messages:{orderBy:[(0,i.desc)(n.sql`createdAt`)],limit:20,with:{sender:{with:{profile:{columns:{name:!0}}},columns:{id:!0}}}}},orderBy:[(0,i.desc)(l.conversation.updatedAt)],limit:20})).map(e=>{let t=e.participant1Id===r?e.participant2:e.participant1;return{id:e.id,otherUser:{id:t.id,name:t.profile?.name??t.email,email:t.email},lastUpdated:e.updatedAt,messages:e.messages.map(e=>({id:e.id,content:e.content,senderId:e.senderId,senderName:e.sender.profile?.name??null,read:e.read,createdAt:e.createdAt})).reverse()}})};return await h.default.set(o,u,{ttl:60,tags:[`parent:${r}`]}),a.NextResponse.json({success:!0,data:u})},{role:"PARENT"});e.s(["GET",0,u]),r()}catch(e){r(e)}},!1),422850,e=>e.a(async(t,r)=>{try{var a=e.i(78315),s=e.i(586961),i=e.i(196657),n=e.i(899733),o=e.i(233979),c=e.i(631683),l=e.i(840960),h=e.i(711373),d=e.i(699699),u=e.i(521140),p=e.i(205260),m=e.i(500249),y=e.i(431740),g=e.i(82608),E=e.i(635207),f=e.i(193695);e.i(708038);var R=e.i(447430),C=e.i(765770),w=t([C]);[C]=w.then?(await w)():w;let v=new a.AppRouteRouteModule({definition:{kind:s.RouteKind.APP_ROUTE,page:"/api/parent/messages/route",pathname:"/api/parent/messages",filename:"route",bundlePath:""},distDir:".next",relativeProjectDir:"",resolvedPagePath:"[project]/ADK_WORKSPACE/TutorMekimi/tutorme-app/src/app/api/parent/messages/route.ts",nextConfigOutput:"",userland:C}),{workAsyncStorage:M,workUnitAsyncStorage:A,serverHooks:H}=v;function T(){return(0,i.patchFetch)({workAsyncStorage:M,workUnitAsyncStorage:A})}async function _(e,t,r){v.isDev&&(0,n.addRequestMeta)(e,"devRequestTimingInternalsEnd",process.hrtime.bigint());let a="/api/parent/messages/route";a=a.replace(/\/index$/,"")||"/";let i=await v.prepare(e,t,{srcPage:a,multiZoneDraftMode:!1});if(!i)return t.statusCode=400,t.end("Bad Request"),null==r.waitUntil||r.waitUntil.call(r,Promise.resolve()),null;let{buildId:C,params:w,nextConfig:T,parsedUrl:_,isDraftMode:M,prerenderManifest:A,routerServerContext:H,isOnDemandRevalidate:I,revalidateOnlyGenerated:D,resolvedPathname:N,clientReferenceManifest:P,serverActionsManifest:O}=i,x=(0,l.normalizeAppPath)(a),S=!!(A.dynamicRoutes[x]||A.routes[N]),b=async()=>((null==H?void 0:H.render404)?await H.render404(e,t,_,!1):t.end("This page could not be found"),null);if(S&&!M){let e=!!A.routes[N],t=A.dynamicRoutes[x];if(t&&!1===t.fallback&&!e){if(T.experimental.adapterPath)return await b();throw new f.NoFallbackError}}let k=null;!S||v.isDev||M||(k=N,k="/index"===k?"/":k);let z=!0===v.isDev||!S,L=S&&!z;O&&P&&(0,c.setManifestsSingleton)({page:a,clientReferenceManifest:P,serverActionsManifest:O});let U=e.method||"GET",F=(0,o.getTracer)(),K=F.getActiveScopeSpan(),q={params:w,prerenderManifest:A,renderOpts:{experimental:{authInterrupts:!!T.experimental.authInterrupts},cacheComponents:!!T.cacheComponents,supportsDynamicResponse:z,incrementalCache:(0,n.getRequestMeta)(e,"incrementalCache"),cacheLifeProfiles:T.cacheLife,waitUntil:r.waitUntil,onClose:e=>{t.on("close",e)},onAfterTaskError:void 0,onInstrumentationRequestError:(t,r,a,s)=>v.onRequestError(e,t,a,s,H)},sharedContext:{buildId:C}},X=new h.NodeNextRequest(e),B=new h.NodeNextResponse(t),Y=d.NextRequestAdapter.fromNodeNextRequest(X,(0,d.signalFromNodeResponse)(t));try{let i=async e=>v.handle(Y,q).finally(()=>{if(!e)return;e.setAttributes({"http.status_code":t.statusCode,"next.rsc":!1});let r=F.getRootSpanAttributes();if(!r)return;if(r.get("next.span_type")!==u.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${r.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let s=r.get("next.route");if(s){let t=`${U} ${s}`;e.setAttributes({"next.route":s,"http.route":s,"next.span_name":t}),e.updateName(t)}else e.updateName(`${U} ${a}`)}),c=!!(0,n.getRequestMeta)(e,"minimalMode"),l=async n=>{var o,l;let h=async({previousCacheEntry:s})=>{try{if(!c&&I&&D&&!s)return t.statusCode=404,t.setHeader("x-nextjs-cache","REVALIDATED"),t.end("This page could not be found"),null;let a=await i(n);e.fetchMetrics=q.renderOpts.fetchMetrics;let o=q.renderOpts.pendingWaitUntil;o&&r.waitUntil&&(r.waitUntil(o),o=void 0);let l=q.renderOpts.collectedTags;if(!S)return await (0,m.sendResponse)(X,B,a,q.renderOpts.pendingWaitUntil),null;{let e=await a.blob(),t=(0,y.toNodeOutgoingHttpHeaders)(a.headers);l&&(t[E.NEXT_CACHE_TAGS_HEADER]=l),!t["content-type"]&&e.type&&(t["content-type"]=e.type);let r=void 0!==q.renderOpts.collectedRevalidate&&!(q.renderOpts.collectedRevalidate>=E.INFINITE_CACHE)&&q.renderOpts.collectedRevalidate,s=void 0===q.renderOpts.collectedExpire||q.renderOpts.collectedExpire>=E.INFINITE_CACHE?void 0:q.renderOpts.collectedExpire;return{value:{kind:R.CachedRouteKind.APP_ROUTE,status:a.status,body:Buffer.from(await e.arrayBuffer()),headers:t},cacheControl:{revalidate:r,expire:s}}}}catch(t){throw(null==s?void 0:s.isStale)&&await v.onRequestError(e,t,{routerKind:"App Router",routePath:a,routeType:"route",revalidateReason:(0,p.getRevalidateReason)({isStaticGeneration:L,isOnDemandRevalidate:I})},!1,H),t}},d=await v.handleResponse({req:e,nextConfig:T,cacheKey:k,routeKind:s.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:A,isRoutePPREnabled:!1,isOnDemandRevalidate:I,revalidateOnlyGenerated:D,responseGenerator:h,waitUntil:r.waitUntil,isMinimalMode:c});if(!S)return null;if((null==d||null==(o=d.value)?void 0:o.kind)!==R.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==d||null==(l=d.value)?void 0:l.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});c||t.setHeader("x-nextjs-cache",I?"REVALIDATED":d.isMiss?"MISS":d.isStale?"STALE":"HIT"),M&&t.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let u=(0,y.fromNodeOutgoingHttpHeaders)(d.value.headers);return c&&S||u.delete(E.NEXT_CACHE_TAGS_HEADER),!d.cacheControl||t.getHeader("Cache-Control")||u.get("Cache-Control")||u.set("Cache-Control",(0,g.getCacheControlHeader)(d.cacheControl)),await (0,m.sendResponse)(X,B,new Response(d.value.body,{headers:u,status:d.value.status||200})),null};K?await l(K):await F.withPropagatedContext(e.headers,()=>F.trace(u.BaseServerSpan.handleRequest,{spanName:`${U} ${a}`,kind:o.SpanKind.SERVER,attributes:{"http.method":U,"http.target":e.url}},l))}catch(t){if(t instanceof f.NoFallbackError||await v.onRequestError(e,t,{routerKind:"App Router",routePath:x,routeType:"route",revalidateReason:(0,p.getRevalidateReason)({isStaticGeneration:L,isOnDemandRevalidate:I})},!1,H),S)throw t;return await (0,m.sendResponse)(X,B,new Response(null,{status:500})),null}}e.s(["handler",()=>_,"patchFetch",()=>T,"routeModule",()=>v,"serverHooks",()=>H,"workAsyncStorage",()=>M,"workUnitAsyncStorage",()=>A]),r()}catch(e){r(e)}},!1),412171,e=>{e.v(t=>Promise.all(["server/chunks/b1c00_TutorMekimi_tutorme-app_src_lib_security_suspicious-activity_ts_7865686f._.js"].map(t=>e.l(t))).then(()=>t(145830)))},443460,e=>{e.v(t=>Promise.all(["server/chunks/[externals]_ioredis_c74819ca._.js"].map(t=>e.l(t))).then(()=>t(693545)))},571363,e=>{e.v(t=>Promise.all(["server/chunks/ADK_WORKSPACE_TutorMekimi_tutorme-app_src_lib_security_api-key_ts_45091e81._.js"].map(t=>e.l(t))).then(()=>t(175922)))}];

//# debugId=03bf2f36-7b51-8928-f3eb-a4caa1961d63
//# sourceMappingURL=%5Broot-of-the-server%5D__ca7eb026._.js.map