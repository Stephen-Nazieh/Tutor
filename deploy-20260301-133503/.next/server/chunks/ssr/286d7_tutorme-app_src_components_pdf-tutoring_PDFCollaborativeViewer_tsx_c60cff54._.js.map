{
  "version": 3,
  "sources": [],
  "debugId": "8845e792-3e0e-dae7-c309-990c7621e1d6",
  "sections": [
    {"offset": {"line": 1, "column": 0}, "map": {"version":3,"sources":["../../../../../../../ADK_WORKSPACE/TutorMekimi/tutorme-app/src/components/pdf-tutoring/PDFCollaborativeViewer.tsx","../../../../../../../ADK_WORKSPACE/TutorMekimi/tutorme-app/src/hooks/use-simple-socket.ts","../../../../../../../ADK_WORKSPACE/TutorMekimi/tutorme-app/src/hooks/use-pdf-collab-socket.ts","../../../../../../../ADK_WORKSPACE/TutorMekimi/tutorme-app/src/lib/pdf-tutoring/coordinates.ts"],"sourcesContent":["/* eslint-disable @typescript-eslint/no-explicit-any */\n'use client'\n\nimport { useCallback, useEffect, useMemo, useRef, useState } from 'react'\nimport { useSession } from 'next-auth/react'\nimport { Button } from '@/components/ui/button'\nimport { Badge } from '@/components/ui/badge'\nimport { Tabs, TabsList, TabsTrigger } from '@/components/ui/tabs'\nimport { Input } from '@/components/ui/input'\nimport { Lock, Unlock, Upload, RefreshCw } from 'lucide-react'\nimport { usePdfCollabSocket } from '@/hooks/use-pdf-collab-socket'\nimport { percentToPx, pxToPercent } from '@/lib/pdf-tutoring/coordinates'\nimport type { PdfCanvasEventPayload, PdfViewMode, PercentFabricObject } from '@/lib/pdf-tutoring/types'\n\nasync function loadOptionalModule(moduleName: string): Promise<any | null> {\n  try {\n    const importer = new Function('name', 'return import(name)') as (name: string) => Promise<any>\n    return await importer(moduleName)\n  } catch {\n    return null\n  }\n}\n\ninterface PDFCollaborativeViewerProps {\n  roomId: string\n  role?: 'tutor' | 'student'\n  initialPdfUrl?: string\n  forceLocked?: boolean\n  showLockControl?: boolean\n  showCollabStatus?: boolean\n  showAiActions?: boolean\n  capabilities?: {\n    draw?: boolean\n    erase?: boolean\n    select?: boolean\n    text?: boolean\n    shapes?: boolean\n    clear?: boolean\n    flatten?: boolean\n  }\n}\n\nexport function PDFCollaborativeViewer({\n  roomId,\n  role = 'tutor',\n  initialPdfUrl,\n  forceLocked,\n  showLockControl,\n  showCollabStatus = true,\n  showAiActions = true,\n  capabilities,\n}: PDFCollaborativeViewerProps) {\n  const { data: session } = useSession()\n  const pdfCanvasRef = useRef<HTMLCanvasElement>(null)\n  const fabricCanvasElementRef = useRef<HTMLCanvasElement>(null)\n  const fabricInstanceRef = useRef<any>(null)\n  const renderTaskRef = useRef<any>(null)\n  const renderSeqRef = useRef(0)\n  const suppressBroadcastRef = useRef(false)\n\n  const [mode, setMode] = useState<PdfViewMode>('original')\n  const [pdfBytes, setPdfBytes] = useState<ArrayBuffer | null>(null)\n  const [pdfDoc, setPdfDoc] = useState<any>(null)\n  const [pageNum, setPageNum] = useState(1)\n  const [pageCount, setPageCount] = useState(1)\n  const [cleanedText, setCleanedText] = useState('')\n  const [markedFeedback, setMarkedFeedback] = useState('')\n  const [fabricReady, setFabricReady] = useState(false)\n  const [tool, setTool] = useState<'draw' | 'erase' | 'select'>('draw')\n  const [strokeColor, setStrokeColor] = useState('#ef4444')\n  const [strokeWidth, setStrokeWidth] = useState(2)\n\n  const userId = session?.user?.id\n  const userName = session?.user?.name || 'Tutor'\n  const effectiveCapabilities = useMemo(() => ({\n    draw: capabilities?.draw ?? true,\n    erase: capabilities?.erase ?? true,\n    select: capabilities?.select ?? true,\n    text: capabilities?.text ?? true,\n    shapes: capabilities?.shapes ?? true,\n    clear: capabilities?.clear ?? true,\n    flatten: capabilities?.flatten ?? true,\n  }), [capabilities])\n\n  const applyObjectPercentToPx = useCallback((object: PercentFabricObject, width: number, height: number) => {\n    const next: PercentFabricObject = {\n      ...object,\n      ...(typeof object.left === 'number' ? { left: percentToPx(object.left, width) } : {}),\n      ...(typeof object.top === 'number' ? { top: percentToPx(object.top, height) } : {}),\n      ...(typeof object.width === 'number' ? { width: percentToPx(object.width, width) } : {}),\n      ...(typeof object.height === 'number' ? { height: percentToPx(object.height, height) } : {}),\n      ...(typeof object.radius === 'number' ? { radius: percentToPx(object.radius, Math.min(width, height)) } : {}),\n      ...(typeof object.strokeWidth === 'number' ? { strokeWidth: percentToPx(object.strokeWidth, Math.min(width, height)) } : {}),\n      ...(typeof object.fontSize === 'number' ? { fontSize: percentToPx(object.fontSize, height) } : {}),\n    }\n\n    if (Array.isArray(next.points)) {\n      next.points = next.points.map((p) => ({\n        x: percentToPx(p.x, width),\n        y: percentToPx(p.y, height),\n      }))\n    }\n\n    if (Array.isArray(next.path)) {\n      next.path = next.path.map((segment) => {\n        if (!Array.isArray(segment) || segment.length < 3) return segment\n        const [cmd, ...nums] = segment\n        const converted: Array<string | number> = [String(cmd)]\n        for (let i = 0; i < nums.length; i += 2) {\n          const x = Number(nums[i])\n          const y = Number(nums[i + 1])\n          converted.push(percentToPx(x, width), percentToPx(y, height))\n        }\n        return converted\n      })\n    }\n\n    return next\n  }, [])\n\n  const serializeObjectToPercent = useCallback((obj: any, width: number, height: number): PercentFabricObject => {\n    const raw = obj.toObject([\n      'id', 'type', 'left', 'top', 'width', 'height', 'radius', 'scaleX', 'scaleY', 'strokeWidth',\n      'fontSize', 'angle', 'fill', 'stroke', 'text', 'path', 'points',\n    ]) as PercentFabricObject\n\n    const next: PercentFabricObject = {\n      ...raw,\n      id: raw.id || `${Date.now()}-${Math.random().toString(16).slice(2)}`,\n      ...(typeof raw.left === 'number' ? { left: pxToPercent(raw.left, width) } : {}),\n      ...(typeof raw.top === 'number' ? { top: pxToPercent(raw.top, height) } : {}),\n      ...(typeof raw.width === 'number' ? { width: pxToPercent(raw.width, width) } : {}),\n      ...(typeof raw.height === 'number' ? { height: pxToPercent(raw.height, height) } : {}),\n      ...(typeof raw.radius === 'number' ? { radius: pxToPercent(raw.radius, Math.min(width, height)) } : {}),\n      ...(typeof raw.strokeWidth === 'number' ? { strokeWidth: pxToPercent(raw.strokeWidth, Math.min(width, height)) } : {}),\n      ...(typeof raw.fontSize === 'number' ? { fontSize: pxToPercent(raw.fontSize, height) } : {}),\n    }\n\n    if (Array.isArray(next.points)) {\n      next.points = next.points.map((p) => ({\n        x: pxToPercent(p.x, width),\n        y: pxToPercent(p.y, height),\n      }))\n    }\n\n    if (Array.isArray(next.path)) {\n      next.path = next.path.map((segment) => {\n        if (!Array.isArray(segment) || segment.length < 3) return segment\n        const [cmd, ...nums] = segment\n        const converted: Array<string | number> = [String(cmd)]\n        for (let i = 0; i < nums.length; i += 2) {\n          const x = Number(nums[i])\n          const y = Number(nums[i + 1])\n          converted.push(pxToPercent(x, width), pxToPercent(y, height))\n        }\n        return converted\n      })\n    }\n\n    return next\n  }, [])\n\n  const onCanvasEvent = useCallback(async (payload: PdfCanvasEventPayload) => {\n    if (payload.page !== pageNum) return\n    const fabricCanvas = fabricInstanceRef.current\n    if (!fabricCanvas || payload.actorId === userId) return\n\n    suppressBroadcastRef.current = true\n    try {\n      if (payload.action === 'removed' && payload.objectId) {\n        const target = fabricCanvas.getObjects().find((obj: any) => obj.id === payload.objectId)\n        if (target) {\n          fabricCanvas.remove(target)\n          fabricCanvas.renderAll()\n        }\n        return\n      }\n\n      if (!payload.object) return\n      const width = fabricCanvas.getWidth()\n      const height = fabricCanvas.getHeight()\n      const objectData = applyObjectPercentToPx(payload.object, width, height)\n\n      if (!objectData.id) return\n      const existing = fabricCanvas.getObjects().find((obj: any) => obj.id === objectData.id)\n      if (existing) {\n        existing.set(objectData)\n        existing.setCoords()\n        fabricCanvas.renderAll()\n        return\n      }\n\n      const fabricMod = await loadOptionalModule('fabric')\n      const fabricApi = fabricMod?.fabric || fabricMod\n      const enliven = fabricApi?.util?.enlivenObjects\n      if (typeof enliven === 'function') {\n        enliven([objectData], (objects: any[]) => {\n          if (!objects?.[0]) return\n          fabricCanvas.add(objects[0])\n          fabricCanvas.renderAll()\n        })\n      }\n    } finally {\n      setTimeout(() => {\n        suppressBroadcastRef.current = false\n      }, 16)\n    }\n  }, [applyObjectPercentToPx, pageNum, userId])\n\n  const onCanvasState = useCallback(async (payload: { roomId: string; events: PdfCanvasEventPayload[] }) => {\n    const fabricCanvas = fabricInstanceRef.current\n    if (!fabricCanvas) return\n\n    // Rebuild last known state from event stream for late joiners.\n    const byId = new Map<string, PdfCanvasEventPayload>()\n    for (const evt of payload.events) {\n      if (evt.page !== pageNum || !evt.objectId) continue\n      if (evt.action === 'removed') {\n        byId.delete(evt.objectId)\n        continue\n      }\n      byId.set(evt.objectId, evt)\n    }\n\n    suppressBroadcastRef.current = true\n    try {\n      fabricCanvas.clear()\n      const width = fabricCanvas.getWidth()\n      const height = fabricCanvas.getHeight()\n      const fabricMod = await loadOptionalModule('fabric')\n      const fabricApi = fabricMod?.fabric || fabricMod\n      const enliven = fabricApi?.util?.enlivenObjects\n      if (typeof enliven !== 'function') return\n      const objects = Array.from(byId.values())\n        .map((evt) => evt.object)\n        .filter((obj): obj is PercentFabricObject => Boolean(obj))\n        .map((obj) => applyObjectPercentToPx(obj, width, height))\n      enliven(objects, (liveObjects: any[]) => {\n        liveObjects.forEach((obj) => fabricCanvas.add(obj))\n        fabricCanvas.renderAll()\n      })\n    } finally {\n      setTimeout(() => {\n        suppressBroadcastRef.current = false\n      }, 16)\n    }\n  }, [applyObjectPercentToPx, pageNum])\n\n  const { isConnected, isLocked, latencyMs, participants, emitCanvasEvent, setLock } = usePdfCollabSocket({\n    roomId,\n    userId,\n    name: userName,\n    role,\n    onCanvasEvent,\n    onCanvasState,\n  })\n  const effectiveLocked = typeof forceLocked === 'boolean' ? forceLocked : isLocked\n  const canDraw = effectiveCapabilities.draw && !effectiveLocked\n  const canErase = effectiveCapabilities.erase && !effectiveLocked\n  const canSelect = effectiveCapabilities.select && !effectiveLocked\n\n  useEffect(() => {\n    if (tool === 'draw' && !effectiveCapabilities.draw) {\n      setTool(effectiveCapabilities.erase ? 'erase' : 'select')\n      return\n    }\n    if (tool === 'erase' && !effectiveCapabilities.erase) {\n      setTool(effectiveCapabilities.draw ? 'draw' : 'select')\n      return\n    }\n    if (tool === 'select' && !effectiveCapabilities.select) {\n      setTool(effectiveCapabilities.draw ? 'draw' : 'erase')\n    }\n  }, [effectiveCapabilities.draw, effectiveCapabilities.erase, effectiveCapabilities.select, tool])\n\n  const renderPdfPage = useCallback(async (doc: any, pageIndex: number) => {\n    const canvas = pdfCanvasRef.current\n    if (!canvas || !doc) return\n    const renderToken = ++renderSeqRef.current\n    if (renderTaskRef.current) {\n      try {\n        renderTaskRef.current.cancel?.()\n      } catch {\n        // Ignore cancellation failures; we'll continue with latest render request.\n      }\n      renderTaskRef.current = null\n    }\n    const page = await doc.getPage(pageIndex)\n    const viewport = page.getViewport({ scale: 1.35 })\n    canvas.width = viewport.width\n    canvas.height = viewport.height\n\n    const ctx = canvas.getContext('2d')\n    if (!ctx) return\n    const task = page.render({ canvasContext: ctx, viewport })\n    renderTaskRef.current = task\n    try {\n      await task.promise\n    } catch (error) {\n      if ((error as { name?: string })?.name === 'RenderingCancelledException') return\n      throw error\n    } finally {\n      if (renderTaskRef.current === task) {\n        renderTaskRef.current = null\n      }\n    }\n    if (renderSeqRef.current !== renderToken) return\n\n    const overlay = fabricCanvasElementRef.current\n    if (overlay) {\n      overlay.width = viewport.width\n      overlay.height = viewport.height\n      overlay.style.width = `${viewport.width}px`\n      overlay.style.height = `${viewport.height}px`\n    }\n\n    if (fabricInstanceRef.current) {\n      fabricInstanceRef.current.setDimensions({ width: viewport.width, height: viewport.height })\n      fabricInstanceRef.current.renderAll()\n    }\n  }, [])\n\n  const initializeFabric = useCallback(async () => {\n    if (!fabricCanvasElementRef.current || fabricInstanceRef.current) return\n    try {\n      const fabricMod = await loadOptionalModule('fabric')\n      const fabricApi = fabricMod?.fabric || fabricMod\n      if (!fabricApi?.Canvas) {\n        console.error('[PDFCollaborativeViewer] fabric library not found. Please run: npm install fabric')\n        setFabricReady(false)\n        return\n      }\n\n      const fabricCanvas = new fabricApi.Canvas(fabricCanvasElementRef.current, {\n        isDrawingMode: true,\n        selection: true,\n      })\n\n      fabricCanvas.freeDrawingBrush.width = 2\n      fabricCanvas.freeDrawingBrush.color = '#ef4444'\n      fabricInstanceRef.current = fabricCanvas\n      setFabricReady(true)\n\n      const broadcast = (action: 'created' | 'modified' | 'removed', target?: any) => {\n        if (!target || suppressBroadcastRef.current) return\n        const width = fabricCanvas.getWidth()\n        const height = fabricCanvas.getHeight()\n        const objectData = serializeObjectToPercent(target, width, height)\n        target.id = objectData.id\n        emitCanvasEvent({\n          page: pageNum,\n          action,\n          object: objectData,\n          objectId: objectData.id,\n        })\n      }\n\n      fabricCanvas.on('path:created', (evt: any) => {\n        if (!evt?.path) return\n        broadcast('created', evt.path)\n      })\n      fabricCanvas.on('object:modified', (evt: any) => broadcast('modified', evt?.target))\n      fabricCanvas.on('object:removed', (evt: any) => broadcast('removed', evt?.target))\n\n      return () => {\n        fabricCanvas.dispose()\n        fabricInstanceRef.current = null\n        setFabricReady(false)\n      }\n    } catch (err) {\n      console.error('[PDFCollaborativeViewer] Error initializing fabric:', err)\n      setFabricReady(false)\n    }\n  }, [emitCanvasEvent, pageNum, serializeObjectToPercent])\n\n  useEffect(() => {\n    let dispose: (() => void) | undefined\n    initializeFabric().then((fn) => {\n      if (typeof fn === 'function') dispose = fn\n    }).catch(() => {\n      setFabricReady(false)\n    })\n    return () => {\n      if (renderTaskRef.current) {\n        try {\n          renderTaskRef.current.cancel?.()\n        } catch {\n          // no-op\n        }\n        renderTaskRef.current = null\n      }\n      dispose?.()\n    }\n  }, [initializeFabric])\n\n  useEffect(() => {\n    if (fabricInstanceRef.current) {\n      const canUseCurrentDrawTool = (tool === 'draw' && canDraw) || (tool === 'erase' && canErase)\n      fabricInstanceRef.current.isDrawingMode = canUseCurrentDrawTool\n      fabricInstanceRef.current.selection = canSelect\n      if (fabricInstanceRef.current.freeDrawingBrush) {\n        fabricInstanceRef.current.freeDrawingBrush.width = strokeWidth\n        fabricInstanceRef.current.freeDrawingBrush.color = tool === 'erase' ? '#ffffff' : strokeColor\n      }\n    }\n  }, [canDraw, canErase, canSelect, strokeColor, strokeWidth, tool])\n\n  useEffect(() => {\n    if (!pdfDoc) return\n    renderPdfPage(pdfDoc, pageNum)\n  }, [pdfDoc, pageNum, renderPdfPage])\n\n  const onFileSelected = async (event: React.ChangeEvent<HTMLInputElement>) => {\n    const file = event.target.files?.[0]\n    if (!file) return\n    const bytes = await file.arrayBuffer()\n    setPdfBytes(bytes)\n\n    const pdfjs = await import('pdfjs-dist')\n    const opts = (pdfjs as any).GlobalWorkerOptions\n    if (opts && !opts.workerSrc) opts.workerSrc = '/pdf.worker.min.mjs'\n\n    const doc = await (pdfjs as any).getDocument({ data: bytes }).promise\n    setPdfDoc(doc)\n    setPageCount(doc.numPages)\n    setPageNum(1)\n    await renderPdfPage(doc, 1)\n  }\n\n  useEffect(() => {\n    if (!initialPdfUrl) return\n    let cancelled = false\n    const loadInitialPdf = async () => {\n      try {\n        const res = await fetch(initialPdfUrl, { credentials: 'include' })\n        if (!res.ok) return\n        const bytes = await res.arrayBuffer()\n        if (cancelled) return\n        setPdfBytes(bytes)\n        const pdfjs = await import('pdfjs-dist')\n        const opts = (pdfjs as any).GlobalWorkerOptions\n        if (opts && !opts.workerSrc) opts.workerSrc = '/pdf.worker.min.mjs'\n        const doc = await (pdfjs as any).getDocument({ data: bytes }).promise\n        if (cancelled) return\n        setPdfDoc(doc)\n        setPageCount(doc.numPages)\n        setPageNum(1)\n        await renderPdfPage(doc, 1)\n      } catch {\n        // Keep component usable even if initial URL fails to load.\n      }\n    }\n    void loadInitialPdf()\n    return () => {\n      cancelled = true\n    }\n  }, [initialPdfUrl, renderPdfPage])\n\n  const callReadService = async () => {\n    const png = pdfCanvasRef.current?.toDataURL('image/png')\n    if (!png) return\n    const res = await fetch('/api/pdf-tutoring/read', {\n      method: 'POST',\n      headers: { 'Content-Type': 'application/json' },\n      body: JSON.stringify({ imageDataUrl: png }),\n    })\n    const data = await res.json()\n    setCleanedText(data.markdown || data.content || '')\n    setMode('cleaned')\n  }\n\n  const callMarkService = async () => {\n    const png = pdfCanvasRef.current?.toDataURL('image/png')\n    if (!png) return\n    const res = await fetch('/api/pdf-tutoring/mark', {\n      method: 'POST',\n      headers: { 'Content-Type': 'application/json' },\n      body: JSON.stringify({\n        imageDataUrl: png,\n        rubric: 'Award partial credit for correct setup and intermediate algebraic transformations.',\n      }),\n    })\n    const data = await res.json()\n    setMarkedFeedback(JSON.stringify(data.result || data, null, 2))\n    setMode('marked')\n  }\n\n  const applyAiErrorCircles = async () => {\n    const canvas = fabricInstanceRef.current\n    if (!canvas || !markedFeedback) return\n\n    let parsed: any = null\n    try {\n      parsed = JSON.parse(markedFeedback)\n    } catch {\n      return\n    }\n\n    const mistakes = Array.isArray(parsed?.mistakeLocations) ? parsed.mistakeLocations : []\n    if (mistakes.length === 0) return\n\n    const fabricMod = await loadOptionalModule('fabric')\n    const fabricApi = fabricMod?.fabric || fabricMod\n    if (!fabricApi?.Circle) return\n\n    const width = canvas.getWidth()\n    const height = canvas.getHeight()\n\n    mistakes.forEach((mistake: any, idx: number) => {\n      const rawX = typeof mistake?.x === 'number' ? mistake.x : 40 + idx * 30\n      const rawY = typeof mistake?.y === 'number' ? mistake.y : 40 + idx * 22\n      const x = rawX <= 100 ? percentToPx(rawX, width) : rawX\n      const y = rawY <= 100 ? percentToPx(rawY, height) : rawY\n\n      const circle = new fabricApi.Circle({\n        id: `ai-mistake-${Date.now()}-${idx}`,\n        left: Math.max(8, x - 18),\n        top: Math.max(8, y - 18),\n        radius: 18,\n        fill: 'rgba(239,68,68,0.06)',\n        stroke: '#ef4444',\n        strokeWidth: 2,\n        selectable: true,\n      })\n      canvas.add(circle)\n    })\n\n    canvas.renderAll()\n  }\n\n  const callFlattenService = async () => {\n    if (!pdfBytes || !fabricInstanceRef.current) return\n\n    const bytes = new Uint8Array(pdfBytes)\n    let binary = ''\n    for (let i = 0; i < bytes.length; i++) binary += String.fromCharCode(bytes[i])\n    const originalPdfBase64 = btoa(binary)\n    const canvas = fabricInstanceRef.current\n    const payload = {\n      originalPdfBase64,\n      fabric: {\n        page: pageNum,\n        width: canvas.getWidth(),\n        height: canvas.getHeight(),\n        objects: canvas.getObjects().map((obj: any) => serializeObjectToPercent(obj, canvas.getWidth(), canvas.getHeight())),\n      },\n    }\n\n    const res = await fetch('/api/pdf-tutoring/flatten', {\n      method: 'POST',\n      headers: { 'Content-Type': 'application/json' },\n      body: JSON.stringify(payload),\n    })\n\n    if (!res.ok) return\n    const blob = await res.blob()\n    const url = URL.createObjectURL(blob)\n    window.open(url, '_blank', 'noopener,noreferrer')\n  }\n\n  const addTextBox = async () => {\n    const canvas = fabricInstanceRef.current\n    if (!canvas || effectiveLocked || !effectiveCapabilities.text) return\n    const fabricMod = await loadOptionalModule('fabric')\n    const fabricApi = fabricMod?.fabric || fabricMod\n    if (!fabricApi?.IText) return\n    const text = new fabricApi.IText('Type here', {\n      id: `text-${Date.now()}`,\n      left: 48,\n      top: 48,\n      fill: '#ef4444',\n      fontSize: 20,\n      editable: true,\n    })\n    canvas.add(text)\n    canvas.setActiveObject(text)\n    text.enterEditing?.()\n    canvas.renderAll()\n  }\n\n  const addRectangle = async () => {\n    const canvas = fabricInstanceRef.current\n    if (!canvas || effectiveLocked || !effectiveCapabilities.shapes) return\n    const fabricMod = await loadOptionalModule('fabric')\n    const fabricApi = fabricMod?.fabric || fabricMod\n    if (!fabricApi?.Rect) return\n    const rect = new fabricApi.Rect({\n      id: `rect-${Date.now()}`,\n      left: 48,\n      top: 48,\n      width: 140,\n      height: 90,\n      fill: 'transparent',\n      stroke: strokeColor,\n      strokeWidth,\n    })\n    canvas.add(rect)\n    canvas.setActiveObject(rect)\n    canvas.renderAll()\n  }\n\n  const addCircle = async () => {\n    const canvas = fabricInstanceRef.current\n    if (!canvas || effectiveLocked || !effectiveCapabilities.shapes) return\n    const fabricMod = await loadOptionalModule('fabric')\n    const fabricApi = fabricMod?.fabric || fabricMod\n    if (!fabricApi?.Circle) return\n    const circle = new fabricApi.Circle({\n      id: `circle-${Date.now()}`,\n      left: 48,\n      top: 48,\n      radius: 55,\n      fill: 'transparent',\n      stroke: strokeColor,\n      strokeWidth,\n    })\n    canvas.add(circle)\n    canvas.setActiveObject(circle)\n    canvas.renderAll()\n  }\n\n  const clearCurrentPage = () => {\n    const canvas = fabricInstanceRef.current\n    if (!canvas || effectiveLocked || !effectiveCapabilities.clear) return\n    canvas.clear()\n    canvas.renderAll()\n  }\n\n  const saveSnapshot = useCallback(async () => {\n    const canvas = fabricInstanceRef.current\n    if (!canvas) return\n    await fetch('/api/pdf-tutoring/snapshots', {\n      method: 'POST',\n      headers: { 'Content-Type': 'application/json' },\n      body: JSON.stringify({\n        roomId,\n        page: pageNum,\n        width: canvas.getWidth(),\n        height: canvas.getHeight(),\n        objects: canvas.getObjects().map((obj: any) => serializeObjectToPercent(obj, canvas.getWidth(), canvas.getHeight())),\n      }),\n    })\n  }, [roomId, pageNum, serializeObjectToPercent])\n\n  useEffect(() => {\n    if (role !== 'tutor') return\n    const interval = setInterval(() => {\n      const canvas = fabricInstanceRef.current\n      if (!canvas) return\n      if ((canvas.getObjects?.() || []).length === 0) return\n      void saveSnapshot()\n    }, 60 * 1000)\n\n    return () => clearInterval(interval)\n  }, [role, saveSnapshot])\n\n  const loadLatestSnapshot = async () => {\n    const canvas = fabricInstanceRef.current\n    if (!canvas) return\n\n    const res = await fetch(`/api/pdf-tutoring/snapshots?roomId=${encodeURIComponent(roomId)}&limit=1`, {\n      credentials: 'include',\n    })\n    if (!res.ok) return\n    const data = await res.json()\n    const latest = data?.snapshots?.[0]\n    const payload = latest?.pages?.[0]\n    if (!payload?.objects || !Array.isArray(payload.objects)) return\n\n    canvas.clear()\n    const width = canvas.getWidth()\n    const height = canvas.getHeight()\n    const fabricMod = await loadOptionalModule('fabric')\n    const fabricApi = fabricMod?.fabric || fabricMod\n    const enliven = fabricApi?.util?.enlivenObjects\n    if (typeof enliven !== 'function') return\n\n    const mapped = payload.objects.map((obj: PercentFabricObject) => applyObjectPercentToPx(obj, width, height))\n    enliven(mapped, (objects: any[]) => {\n      objects.forEach((obj) => canvas.add(obj))\n      canvas.renderAll()\n    })\n  }\n\n  const connectionBadge = useMemo(() => {\n    if (!isConnected) return <Badge variant=\"destructive\">Offline</Badge>\n    if (latencyMs !== null && latencyMs > 50) return <Badge variant=\"secondary\">Sync {latencyMs}ms</Badge>\n    return <Badge variant=\"default\">Sync &lt;50ms</Badge>\n  }, [isConnected, latencyMs])\n  const participantSummary = useMemo(() => {\n    const total = participants.length\n    const tutors = participants.filter((participant) => participant.role === 'tutor').length\n    const students = total - tutors\n    return { total, tutors, students }\n  }, [participants])\n\n  return (\n    <div className=\"space-y-4\">\n      <div className=\"flex flex-wrap items-center gap-2\">\n        <Input type=\"file\" accept=\"application/pdf\" onChange={onFileSelected} className=\"max-w-sm\" />\n        {showCollabStatus && connectionBadge}\n        {showCollabStatus && (\n          <Badge variant=\"outline\">\n            Live: {participantSummary.total} ({participantSummary.tutors} tutor, {participantSummary.students} students)\n          </Badge>\n        )}\n        {showCollabStatus && (\n          <Badge variant={isLocked ? 'destructive' : 'secondary'}>\n            {effectiveLocked ? 'Canvas Locked' : 'Canvas Unlocked'}\n          </Badge>\n        )}\n        {(showLockControl ?? role === 'tutor') && (\n          <Button variant=\"outline\" size=\"sm\" onClick={() => setLock(!effectiveLocked)}>\n            {effectiveLocked ? <Unlock className=\"w-4 h-4 mr-2\" /> : <Lock className=\"w-4 h-4 mr-2\" />}\n            {effectiveLocked ? 'Unlock Canvas' : 'Lock Canvas'}\n          </Button>\n        )}\n        {showAiActions && (\n          <Button variant=\"outline\" size=\"sm\" onClick={callReadService}>\n            <RefreshCw className=\"w-4 h-4 mr-2\" />\n            AI Cleaned Text\n          </Button>\n        )}\n        {showAiActions && <Button variant=\"outline\" size=\"sm\" onClick={callMarkService}>Run AI Marking</Button>}\n        {showAiActions && <Button variant=\"outline\" size=\"sm\" onClick={applyAiErrorCircles}>Apply AI Error Circles</Button>}\n        {effectiveCapabilities.text && (\n          <Button variant=\"outline\" size=\"sm\" onClick={addTextBox} disabled={effectiveLocked}>\n            Add Text\n          </Button>\n        )}\n        {effectiveCapabilities.shapes && (\n          <>\n            <Button variant=\"outline\" size=\"sm\" onClick={addRectangle} disabled={effectiveLocked}>\n              Rectangle\n            </Button>\n            <Button variant=\"outline\" size=\"sm\" onClick={addCircle} disabled={effectiveLocked}>\n              Circle\n            </Button>\n          </>\n        )}\n        <Button variant={tool === 'draw' ? 'default' : 'outline'} size=\"sm\" onClick={() => setTool('draw')} disabled={!canDraw}>\n          Draw\n        </Button>\n        <Button variant={tool === 'erase' ? 'default' : 'outline'} size=\"sm\" onClick={() => setTool('erase')} disabled={!canErase}>\n          Erase\n        </Button>\n        <Button variant={tool === 'select' ? 'default' : 'outline'} size=\"sm\" onClick={() => setTool('select')} disabled={!canSelect}>\n          Select\n        </Button>\n        <label className=\"flex items-center gap-1 text-xs\">\n          Color\n          <input\n            type=\"color\"\n            value={strokeColor}\n            onChange={(e) => setStrokeColor(e.target.value)}\n            disabled={effectiveLocked || (!canDraw && !canErase)}\n            className=\"h-7 w-10 rounded border\"\n          />\n        </label>\n        <label className=\"flex items-center gap-1 text-xs\">\n          Width\n          <input\n            type=\"range\"\n            min={1}\n            max={10}\n            step={1}\n            value={strokeWidth}\n            onChange={(e) => setStrokeWidth(Number(e.target.value))}\n            disabled={effectiveLocked || (!canDraw && !canErase)}\n          />\n          <span>{strokeWidth}</span>\n        </label>\n        {effectiveCapabilities.clear && (\n          <Button variant=\"outline\" size=\"sm\" onClick={clearCurrentPage} disabled={effectiveLocked}>\n            Clear\n          </Button>\n        )}\n        {role === 'tutor' && (\n          <>\n            <Button variant=\"outline\" size=\"sm\" onClick={saveSnapshot}>Save Snapshot</Button>\n            <Button variant=\"outline\" size=\"sm\" onClick={loadLatestSnapshot}>Load Latest Snapshot</Button>\n          </>\n        )}\n        {effectiveCapabilities.flatten && <Button size=\"sm\" onClick={callFlattenService}>Flatten PDF</Button>}\n      </div>\n\n      <Tabs value={mode} onValueChange={(value) => setMode(value as PdfViewMode)}>\n        <TabsList>\n          <TabsTrigger value=\"original\">Original View</TabsTrigger>\n          {showAiActions && <TabsTrigger value=\"cleaned\">AI Cleaned Text</TabsTrigger>}\n          <TabsTrigger value=\"marked\">Marked Feedback</TabsTrigger>\n        </TabsList>\n      </Tabs>\n\n      <div className=\"flex items-center gap-2\">\n        <Button variant=\"outline\" size=\"sm\" disabled={pageNum <= 1} onClick={() => setPageNum((prev) => prev - 1)}>Prev</Button>\n        <span className=\"text-sm\">Page {pageNum} / {pageCount}</span>\n        <Button variant=\"outline\" size=\"sm\" disabled={pageNum >= pageCount} onClick={() => setPageNum((prev) => prev + 1)}>Next</Button>\n        {!fabricReady && <Badge variant=\"secondary\">Install `fabric` package to enable drawing sync</Badge>}\n      </div>\n\n      {mode === 'original' && (\n        <div className=\"relative inline-block border rounded-md overflow-hidden bg-white\">\n          <canvas ref={pdfCanvasRef} className=\"block\" />\n          <canvas ref={fabricCanvasElementRef} className=\"absolute inset-0\" />\n        </div>\n      )}\n\n      {mode === 'cleaned' && showAiActions && (\n        <pre className=\"rounded-md border bg-muted p-4 text-xs whitespace-pre-wrap\">{cleanedText || 'No cleaned text generated yet.'}</pre>\n      )}\n\n      {mode === 'marked' && (\n        <pre className=\"rounded-md border bg-muted p-4 text-xs whitespace-pre-wrap\">{markedFeedback || 'No marking feedback generated yet.'}</pre>\n      )}\n\n      <div className=\"text-xs text-muted-foreground flex items-center gap-2\">\n        <Upload className=\"w-3.5 h-3.5\" />\n        Coordinates are normalized as 0-100 percentages before sync for cross-device consistency.\n      </div>\n    </div>\n  )\n}\n","/**\n * Simple Socket.io Hook\n * \n * Provides a basic socket connection for room-based features.\n * Used by the Live Class Whiteboard system.\n */\n\nimport { useEffect, useRef, useState } from 'react'\nimport { io, Socket } from 'socket.io-client'\n\ninterface SimpleSocketOptions {\n  userId?: string\n  name?: string\n  role?: 'student' | 'tutor'\n}\n\nexport function useSimpleSocket(roomId: string, options: SimpleSocketOptions = {}) {\n  const socketRef = useRef<Socket | null>(null)\n  const [socketInstance, setSocketInstance] = useState<Socket | null>(null)\n  const [isConnected, setIsConnected] = useState(false)\n\n  useEffect(() => {\n    if (!roomId) return\n\n    const connect = async () => {\n      const token = await import('@/lib/socket-auth').then((m) => m.getSocketToken())\n      if (!token) return\n      const socket = io({\n        path: '/api/socket',\n        transports: ['websocket', 'polling'],\n        timeout: 20000,\n        reconnection: true,\n        reconnectionAttempts: 10,\n        reconnectionDelay: 500,\n        auth: { token },\n      })\n      socketRef.current = socket\n\n    socket.on('connect', () => {\n      setIsConnected(true)\n      setSocketInstance(socket)\n\n      if (roomId && options.userId && options.role) {\n        socket.emit('join_class', {\n          roomId,\n          userId: options.userId,\n          name: options.name || options.role,\n          role: options.role,\n        })\n      }\n    })\n\n    socket.on('disconnect', () => {\n      setIsConnected(false)\n      setSocketInstance(null)\n    })\n\n    socket.on('connect_error', (err) => {\n      console.warn('Socket connection error:', err?.message || err)\n      setIsConnected(false)\n    })\n    }\n    connect()\n    return () => {\n      socketRef.current?.disconnect()\n      socketRef.current = null\n    }\n  }, [roomId, options.name, options.role, options.userId])\n\n  return {\n    socket: socketInstance,\n    isConnected\n  }\n}\n","'use client'\n\nimport { useCallback, useEffect, useMemo, useState } from 'react'\nimport { useSimpleSocket } from './use-simple-socket'\nimport type { PdfCanvasEventPayload } from '@/lib/pdf-tutoring/types'\n\nexport interface PdfParticipant {\n  userId?: string\n  name: string\n  role: 'student' | 'tutor'\n  joinedAt: number\n}\n\ninterface UsePdfCollabSocketArgs {\n  roomId: string\n  userId?: string\n  name?: string\n  role?: 'student' | 'tutor'\n  onCanvasEvent?: (payload: PdfCanvasEventPayload) => void\n  onCanvasState?: (payload: { roomId: string; events: PdfCanvasEventPayload[] }) => void\n  onPresenceState?: (payload: { roomId: string; participants: PdfParticipant[] }) => void\n}\n\nexport function usePdfCollabSocket({ roomId, userId, name, role = 'tutor', onCanvasEvent, onCanvasState, onPresenceState }: UsePdfCollabSocketArgs) {\n  const { socket, isConnected } = useSimpleSocket(roomId, {\n    userId,\n    name,\n    role,\n  })\n  const [isLocked, setIsLocked] = useState(false)\n  const [latencyMs, setLatencyMs] = useState<number | null>(null)\n  const [participants, setParticipants] = useState<PdfParticipant[]>([])\n\n  useEffect(() => {\n    if (!socket || !roomId) return\n\n    socket.emit('pdf_join_room', {\n      roomId,\n      userId,\n      name,\n      role,\n    })\n\n    const handleCanvasEvent = (payload: PdfCanvasEventPayload) => {\n      if (typeof payload.sentAt === 'number') {\n        setLatencyMs(Math.max(0, Date.now() - payload.sentAt))\n      }\n      onCanvasEvent?.(payload)\n    }\n\n    const handleLockState = (data: { roomId: string; locked: boolean }) => {\n      if (data.roomId === roomId) setIsLocked(data.locked)\n    }\n\n    const handleCanvasState = (data: { roomId: string; events: PdfCanvasEventPayload[] }) => {\n      if (data.roomId !== roomId) return\n      onCanvasState?.(data)\n    }\n\n    const handlePresenceState = (data: { roomId: string; participants: PdfParticipant[] }) => {\n      if (data.roomId !== roomId) return\n      setParticipants(data.participants || [])\n      onPresenceState?.(data)\n    }\n\n    socket.on('pdf_canvas_event', handleCanvasEvent)\n    socket.on('pdf_lock_state', handleLockState)\n    socket.on('pdf_canvas_state', handleCanvasState)\n    socket.on('pdf_presence_state', handlePresenceState)\n\n    socket.emit('pdf_request_state', { roomId })\n\n    return () => {\n      socket.off('pdf_canvas_event', handleCanvasEvent)\n      socket.off('pdf_lock_state', handleLockState)\n      socket.off('pdf_canvas_state', handleCanvasState)\n      socket.off('pdf_presence_state', handlePresenceState)\n    }\n  }, [socket, roomId, userId, name, role, onCanvasEvent, onCanvasState, onPresenceState])\n\n  const emitCanvasEvent = useCallback(\n    (payload: Omit<PdfCanvasEventPayload, 'roomId' | 'sentAt' | 'actorId'>) => {\n      if (!socket || !roomId) return\n      socket.emit('pdf_canvas_event', {\n        roomId,\n        actorId: userId,\n        sentAt: Date.now(),\n        ...payload,\n      } satisfies PdfCanvasEventPayload)\n    },\n    [socket, roomId, userId]\n  )\n\n  const setLock = useCallback(\n    (locked: boolean) => {\n      if (!socket || !roomId) return\n      socket.emit('pdf_lock_toggle', { roomId, locked })\n    },\n    [socket, roomId]\n  )\n\n  return useMemo(\n    () => ({\n      socket,\n      isConnected,\n      isLocked,\n      latencyMs,\n      participants,\n      emitCanvasEvent,\n      setLock,\n    }),\n    [socket, isConnected, isLocked, latencyMs, participants, emitCanvasEvent, setLock]\n  )\n}\n","export interface PointPx {\n  x: number\n  y: number\n}\n\nexport interface PointPercent {\n  x: number\n  y: number\n}\n\nfunction clampPercent(value: number): number {\n  return Math.max(0, Math.min(100, value))\n}\n\nexport function pxToPercent(value: number, total: number): number {\n  if (!Number.isFinite(value) || !Number.isFinite(total) || total <= 0) return 0\n  return clampPercent((value / total) * 100)\n}\n\nexport function percentToPx(value: number, total: number): number {\n  if (!Number.isFinite(value) || !Number.isFinite(total) || total <= 0) return 0\n  return (value / 100) * total\n}\n\nexport function pointToPercent(point: PointPx, width: number, height: number): PointPercent {\n  return {\n    x: pxToPercent(point.x, width),\n    y: pxToPercent(point.y, height),\n  }\n}\n\nexport function pointToPx(point: PointPercent, width: number, height: number): PointPx {\n  return {\n    x: percentToPx(point.x, width),\n    y: percentToPx(point.y, height),\n  }\n}\n\nexport function rectToPercent<T extends { left?: number; top?: number; width?: number; height?: number }>(\n  rect: T,\n  width: number,\n  height: number\n): T {\n  return {\n    ...rect,\n    ...(typeof rect.left === 'number' ? { left: pxToPercent(rect.left, width) } : {}),\n    ...(typeof rect.top === 'number' ? { top: pxToPercent(rect.top, height) } : {}),\n    ...(typeof rect.width === 'number' ? { width: pxToPercent(rect.width, width) } : {}),\n    ...(typeof rect.height === 'number' ? { height: pxToPercent(rect.height, height) } : {}),\n  }\n}\n\nexport function rectToPx<T extends { left?: number; top?: number; width?: number; height?: number }>(\n  rect: T,\n  width: number,\n  height: number\n): T {\n  return {\n    ...rect,\n    ...(typeof rect.left === 'number' ? { left: percentToPx(rect.left, width) } : {}),\n    ...(typeof rect.top === 'number' ? { top: percentToPx(rect.top, height) } : {}),\n    ...(typeof rect.width === 'number' ? { width: percentToPx(rect.width, width) } : {}),\n    ...(typeof rect.height === 'number' ? { height: percentToPx(rect.height, height) } : {}),\n  }\n}\n"],"names":[],"mappings":"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"}}]
}