{
  "version": 3,
  "sources": [],
  "debugId": "82dbd81f-a16e-26c7-d666-1e331c4c3eff",
  "sections": [
    {"offset": {"line": 1, "column": 0}, "map": {"version":3,"sources":["../../../../../../ADK_WORKSPACE/TutorMekimi/tutorme-app/src/lib/enrollment.ts"],"sourcesContent":["/**\n * Server-side enrollment logic (curriculum).\n * Used by POST /api/curriculum/[id]/enroll and by payment webhooks for course purchases.\n * Drizzle ORM.\n */\n\nimport { eq, and, inArray, sql } from 'drizzle-orm'\nimport { drizzleDb } from '@/lib/db/drizzle'\nimport {\n  curriculum,\n  curriculumModule,\n  curriculumLesson,\n  curriculumProgress,\n  curriculumEnrollment,\n} from '@/lib/db/schema'\n\nexport async function enrollStudentInCurriculum(\n  studentId: string,\n  curriculumId: string\n): Promise<{ enrolled: boolean; progress?: { id: string } }> {\n  const [curriculumRow] = await drizzleDb.select().from(curriculum).where(eq(curriculum.id, curriculumId)).limit(1)\n  if (!curriculumRow) {\n    throw new Error('Curriculum not found')\n  }\n\n  const modules = await drizzleDb\n    .select()\n    .from(curriculumModule)\n    .where(eq(curriculumModule.curriculumId, curriculumId))\n  const moduleIds = modules.map((m) => m.id)\n  const totalLessonsResult =\n    moduleIds.length > 0\n      ? await drizzleDb\n          .select({ count: sql<number>`count(*)::int` })\n          .from(curriculumLesson)\n          .where(inArray(curriculumLesson.moduleId, moduleIds))\n      : [{ count: 0 }]\n  const totalLessons = totalLessonsResult[0]?.count ?? 0\n\n  const [existingProgress] = await drizzleDb\n    .select()\n    .from(curriculumProgress)\n    .where(and(eq(curriculumProgress.studentId, studentId), eq(curriculumProgress.curriculumId, curriculumId)))\n    .limit(1)\n  if (existingProgress) {\n    return { enrolled: false }\n  }\n\n  const [existingEnrollment] = await drizzleDb\n    .select()\n    .from(curriculumEnrollment)\n    .where(and(eq(curriculumEnrollment.studentId, studentId), eq(curriculumEnrollment.curriculumId, curriculumId)))\n    .limit(1)\n\n  if (existingEnrollment) {\n    await drizzleDb\n      .update(curriculumEnrollment)\n      .set({ enrollmentSource: 'signup' })\n      .where(eq(curriculumEnrollment.id, existingEnrollment.id))\n  } else {\n    await drizzleDb.insert(curriculumEnrollment).values({\n      id: crypto.randomUUID(),\n      studentId,\n      curriculumId,\n      lessonsCompleted: 0,\n      enrollmentSource: 'signup',\n    })\n  }\n\n  const inserted = await drizzleDb\n    .insert(curriculumProgress)\n    .values({\n      id: crypto.randomUUID(),\n      studentId,\n      curriculumId,\n      lessonsCompleted: 0,\n      totalLessons,\n      isCompleted: false,\n    })\n    .returning()\n\n  return { enrolled: true, progress: inserted[0] ? { id: inserted[0].id } : undefined }\n}\n"],"names":[],"mappings":"+CAMA,IAAA,EAAA,EAAA,CAAA,CAAA,QAAA,EAAA,EAAA,CAAA,CAAA,QACA,EAAA,EAAA,CAAA,CAAA,QACA,EAAA,CAAA,CAAA,QAAA,IAAA,EAAA,EAAA,CAAA,CAAA,iBAQO,eAAe,EACpB,CAAiB,CACjB,CAAoB,EAEpB,GAAM,CAAC,EAAc,CAAG,MAAM,EAAA,SAAS,CAAC,MAAM,GAAG,IAAI,CAAC,EAAA,UAAU,EAAE,KAAK,CAAC,CAAA,EAAA,EAAA,EAAA,AAAE,EAAC,EAAA,UAAU,CAAC,EAAE,CAAE,IAAe,KAAK,CAAC,GAC/G,GAAI,CAAC,EACH,MAAM,AAAI,MAAM,CADE,uBAQpB,IAAM,EAAY,CAJF,MAAM,EAAA,SAAS,CAC5B,MAAM,GACN,IAAI,CAAC,EAAA,gBAAgB,EACrB,KAAK,CAAC,CAAA,EAAA,EAAA,EAAA,AAAE,EAAC,EAAA,gBAAgB,CAAC,YAAY,CAAE,GAAA,EACjB,GAAG,CAAC,AAAC,GAAM,EAAE,EAAE,EACnC,EACJ,EAAU,MAAM,CAAG,EACf,MAAM,EAAA,SAAS,CACZ,MAAM,CAAC,CAAE,MAAO,EAAA,GAAW,CAAC,aAAa,CAAC,AAAC,GAC3C,IAAI,CAAC,EAAA,gBAAgB,EACrB,KAAK,CAAC,CAAA,EAAA,EAAA,OAAA,AAAO,EAAC,EAAA,gBAAgB,CAAC,QAAQ,CAAE,IAC5C,CAAC,CAAE,MAAO,CAAE,EAAE,CACd,EAAe,CAAkB,CAAC,EAAE,EAAE,OAAS,EAE/C,CAAC,EAAiB,CAAG,MAAM,EAAA,SAAS,CACvC,MAAM,GACN,IAAI,CAAC,EAAA,kBAAkB,EACvB,KAAK,CAAC,CAAA,EAAA,EAAA,GAAA,AAAG,EAAC,CAAA,EAAA,EAAA,EAAA,AAAE,EAAC,EAAA,kBAAkB,CAAC,SAAS,CAAE,GAAY,CAAA,EAAA,EAAA,EAAA,AAAE,EAAC,EAAA,kBAAkB,CAAC,YAAY,CAAE,KAC3F,KAAK,CAAC,GACT,GAAI,EACF,MAAO,CAAE,SADW,CACD,CAAM,EAG3B,GAAM,CAAC,EAAmB,CAAG,MAAM,EAAA,SAAS,CACzC,MAAM,GACN,IAAI,CAAC,EAAA,oBAAoB,EACzB,KAAK,CAAC,CAAA,EAAA,EAAA,GAAA,AAAG,EAAC,CAAA,EAAA,EAAA,EAAA,AAAE,EAAC,EAAA,oBAAoB,CAAC,SAAS,CAAE,GAAY,CAAA,EAAA,EAAA,EAAA,AAAE,EAAC,EAAA,oBAAoB,CAAC,YAAY,CAAE,KAC/F,KAAK,CAAC,GAEL,EACF,MAAM,EAAA,SAAS,CACZ,AAFmB,MAEb,CAAC,EAAA,oBAAoB,EAC3B,GAAG,CAAC,CAAE,iBAAkB,QAAS,GACjC,KAAK,CAAC,CAAA,EAAA,EAAA,EAAE,AAAF,EAAG,EAAA,oBAAoB,CAAC,EAAE,CAAE,EAAmB,EAAE,GAE1D,MAAM,EAAA,SAAS,CAAC,MAAM,CAAC,EAAA,oBAAoB,EAAE,MAAM,CAAC,CAClD,GAAI,OAAO,UAAU,aACrB,eACA,EACA,iBAAkB,EAClB,iBAAkB,QACpB,GAGF,IAAM,EAAW,MAAM,EAAA,SAAS,CAC7B,MAAM,CAAC,EAAA,kBAAkB,EACzB,MAAM,CAAC,CACN,GAAI,OAAO,UAAU,aACrB,eACA,EACA,iBAAkB,eAClB,EACA,aAAa,CACf,GACC,SAAS,GAEZ,MAAO,CAAE,UAAU,EAAM,SAAU,CAAQ,CAAC,EAAE,CAAG,CAAE,GAAI,CAAQ,CAAC,EAAE,CAAC,EAAE,AAAC,OAAI,CAAU,CACtF"}}]
}