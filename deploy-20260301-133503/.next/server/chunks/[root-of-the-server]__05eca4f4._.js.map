{
  "version": 3,
  "sources": [],
  "debugId": "5bc904a3-259c-6850-9b90-015b2c66dbeb",
  "sections": [
    {"offset": {"line": 1, "column": 0}, "map": {"version":3,"sources":["../../../../../../ADK_WORKSPACE/TutorMekimi/tutorme-app/src/lib/db/index.ts","../../../../../../ADK_WORKSPACE/TutorMekimi/tutorme-app/src/lib/security/sanitize.ts","../../../../../../ADK_WORKSPACE/TutorMekimi/tutorme-app/src/lib/security/audit.ts","../../../../../../ADK_WORKSPACE/TutorMekimi/tutorme-app/src/lib/security/security-audit.ts","../../../../../../ADK_WORKSPACE/TutorMekimi/tutorme-app/src/lib/security/logging.ts","../../../../../../ADK_WORKSPACE/TutorMekimi/tutorme-app/src/lib/security/ai-sanitization.ts","../../../../../../ADK_WORKSPACE/TutorMekimi/tutorme-app/src/lib/ai/memory-service.ts"],"sourcesContent":["/* eslint-disable @typescript-eslint/no-explicit-any */\n/* eslint-disable @typescript-eslint/no-require-imports */\n\n/**\n * Database Client with Connection Pooling\n * \n * Features:\n * - Connection pooling for high concurrency (100+ users)\n * - Query caching with Redis\n * - Read replica support for scaling\n * - N+1 query prevention with dataloaders\n * \n * Note: Redis is lazily initialized to avoid bundling issues\n */\n\n// Connection pool configuration\nconst POOL_CONFIG = {\n  // Connection pool settings for 100+ concurrent users\n  min: 5,                    // Minimum connections\n  max: 50,                   // Maximum connections (supports 100+ concurrent users)\n  idleTimeoutMillis: 30000,  // Close idle connections after 30s\n  connectionTimeoutMillis: 5000, // Connection timeout\n  allowExitOnIdle: false,    // Keep pool alive\n}\n\n// Query cache configuration\nconst CACHE_CONFIG = {\n  ttl: 60,                   // Default cache TTL in seconds\n  staleWhileRevalidate: 30,  // Serve stale data while refreshing\n  prefix: 'tutorme:query:',  // Cache key prefix\n}\n\nlet db: any\nlet redis: any | null = null\nlet queryCache: Map<string, { data: any; expires: number }> | null = null\nlet redisInitialized = false\n\n// Safe check for server-side environment (not Edge Runtime)\n// Edge Runtime (used by Next.js middleware) doesn't support Prisma Client\nconst isEdgeRuntime = typeof (globalThis as any).EdgeRuntime !== 'undefined' || \n  (typeof process !== 'undefined' && process.env.NEXT_RUNTIME === 'edge')\nconst isServer = typeof window === 'undefined' && !isEdgeRuntime\n\n// Initialize in-memory cache only on server\nfunction getQueryCache() {\n  if (!isServer) return null\n  if (!queryCache) {\n    queryCache = new Map()\n  }\n  return queryCache\n}\n\n// Initialize Redis client if available (server-side only)\nasync function initRedis() {\n  if (!isServer) return null\n  if (redisInitialized) return redis\n  \n  try {\n    const redisUrl = process.env.REDIS_URL\n    if (!redisUrl) {\n      console.log('[DB] Redis URL not configured, using in-memory cache')\n      redisInitialized = true\n      return null\n    }\n    \n    // Dynamic import to avoid bundling issues\n    const { Redis } = await import('ioredis')\n    redis = new Redis(redisUrl, {\n      retryStrategy: (times) => Math.min(times * 50, 2000),\n      maxRetriesPerRequest: 3,\n    })\n    \n    redis.on('error', (err: any) => {\n      console.error('[Redis] Connection error:', err)\n      redis = null\n    })\n    \n    console.log('[DB] Redis cache initialized')\n    redisInitialized = true\n    return redis\n  } catch (e) {\n    console.warn('[DB] Failed to initialize Redis, using in-memory cache')\n    redisInitialized = true\n    return null\n  }\n}\n\n// Use Drizzle as the default database (server-side only)\nif (isServer) {\n  try {\n    const { drizzleDb } = require('./drizzle')\n    db = drizzleDb\n    console.log('[DB] Drizzle client (default db) initialized')\n  } catch (e) {\n    console.error('[DB] Failed to initialize Drizzle:', e)\n    db = {\n      $connect: async () => {},\n      $disconnect: async () => {},\n    } as any\n  }\n} else {\n  db = {\n    $connect: async () => {},\n    $disconnect: async () => {},\n  } as any\n}\n\n/**\n * Cache utilities\n */\nexport const cache = {\n  /**\n   * Ensure Redis is initialized\n   */\n  async ensureRedis() {\n    if (!isServer) return null\n    if (!redisInitialized) {\n      await initRedis()\n    }\n    return redis\n  },\n\n  /**\n   * Get cached value\n   */\n  async get<T>(key: string): Promise<T | null> {\n    if (!isServer) return null\n    \n    const fullKey = CACHE_CONFIG.prefix + key\n    \n    // Try Redis first\n    const client = await this.ensureRedis()\n    if (client) {\n      try {\n        const value = await client.get(fullKey)\n        if (value) return JSON.parse(value)\n      } catch (e) {\n        console.error('[Cache] Redis get error:', e)\n      }\n    }\n    \n    // Fallback to in-memory cache\n    const cache = getQueryCache()\n    if (!cache) return null\n    \n    const cached = cache.get(fullKey)\n    if (cached && cached.expires > Date.now()) {\n      return cached.data\n    }\n    \n    cache.delete(fullKey)\n    return null\n  },\n  \n  /**\n   * Set cached value\n   */\n  async set<T>(key: string, value: T, ttlSeconds = CACHE_CONFIG.ttl): Promise<void> {\n    if (!isServer) return\n    \n    const fullKey = CACHE_CONFIG.prefix + key\n    \n    // Try Redis first\n    const client = await this.ensureRedis()\n    if (client) {\n      try {\n        await client.setex(fullKey, ttlSeconds, JSON.stringify(value))\n        return\n      } catch (e) {\n        console.error('[Cache] Redis set error:', e)\n      }\n    }\n    \n    // Fallback to in-memory cache\n    const cache = getQueryCache()\n    if (cache) {\n      cache.set(fullKey, {\n        data: value,\n        expires: Date.now() + ttlSeconds * 1000\n      })\n    }\n  },\n  \n  /**\n   * Delete cached value\n   */\n  async delete(key: string): Promise<void> {\n    if (!isServer) return\n    \n    const fullKey = CACHE_CONFIG.prefix + key\n    \n    const client = await this.ensureRedis()\n    if (client) {\n      try {\n        await client.del(fullKey)\n      } catch (e) {\n        console.error('[Cache] Redis del error:', e)\n      }\n    }\n    \n    const cache = getQueryCache()\n    if (cache) cache.delete(fullKey)\n  },\n  \n  /**\n   * Clear all cached values\n   */\n  async clear(): Promise<void> {\n    if (!isServer) return\n    \n    const client = await this.ensureRedis()\n    if (client) {\n      try {\n        const keys = await client.keys(CACHE_CONFIG.prefix + '*')\n        if (keys.length > 0) {\n          await client.del(...keys)\n        }\n      } catch (e) {\n        console.error('[Cache] Redis clear error:', e)\n      }\n    }\n    \n    const cache = getQueryCache()\n    if (cache) cache.clear()\n  },\n  \n  /**\n   * Get or set cached value\n   */\n  async getOrSet<T>(\n    key: string,\n    factory: () => Promise<T>,\n    ttlSeconds = CACHE_CONFIG.ttl\n  ): Promise<T> {\n    const cached = await this.get<T>(key)\n    if (cached !== null) return cached\n    \n    const value = await factory()\n    await this.set(key, value, ttlSeconds)\n    return value\n  },\n\n  /**\n   * Invalidate cache for a pattern\n   */\n  async invalidatePattern(pattern: string): Promise<void> {\n    if (!isServer) return\n    \n    const client = await this.ensureRedis()\n    if (client) {\n      try {\n        const keys = await client.keys(CACHE_CONFIG.prefix + pattern)\n        if (keys.length > 0) {\n          await client.del(...keys)\n        }\n      } catch (e) {\n        console.error('[Cache] Pattern invalidation error:', e)\n      }\n    }\n    \n    // Clear in-memory cache matching pattern\n    const cache = getQueryCache()\n    if (cache) {\n      const regex = new RegExp(CACHE_CONFIG.prefix + pattern.replace('*', '.*'))\n      for (const key of cache.keys()) {\n        if (regex.test(key)) cache.delete(key)\n      }\n    }\n  }\n}\n\n/**\n * Query optimization utilities\n */\nexport const queryOptimizer = {\n  /**\n   * Batch load function for N+1 prevention\n   */\n  async batchLoad<T>(\n    ids: string[],\n    fetchFn: (ids: string[]) => Promise<T[]>,\n    getId: (item: T) => string\n  ): Promise<(T | null)[]> {\n    if (!isServer) return ids.map(() => null)\n    if (ids.length === 0) return []\n    \n    // Deduplicate IDs\n    const uniqueIds = [...new Set(ids)]\n    \n    // Fetch all items in one query\n    const items = await fetchFn(uniqueIds)\n    \n    // Create lookup map\n    const itemMap = new Map(items.map(item => [getId(item), item]))\n    \n    // Return items in original order\n    return ids.map(id => itemMap.get(id) || null)\n  },\n  \n  /**\n   * Wrap a query with caching\n   */\n  async cachedQuery<T>(\n    cacheKey: string,\n    queryFn: () => Promise<T>,\n    ttlSeconds = CACHE_CONFIG.ttl\n  ): Promise<T> {\n    return cache.getOrSet(cacheKey, queryFn, ttlSeconds)\n  }\n}\n\n/**\n * Read replica support (for future scaling)\n */\nexport const readReplica = {\n  /**\n   * Check if read replicas are configured\n   */\n  isConfigured(): boolean {\n    return isServer && !!process.env.DATABASE_READ_REPLICA_URL\n  },\n  \n  /**\n   * Get read-only database client\n   * Falls back to primary if replicas not configured\n   */\n  getClient() {\n    // For now, return the same client\n    // In production, this would return a connection to the read replica\n    return db\n  }\n}\n\nexport { db }\n/** Alias for code that imports prisma from @/lib/db â€” now points to Drizzle */\nexport const prisma = db\n\n// Server-only code that needs Drizzle: import { drizzleDb } from '@/lib/db/drizzle'\n// Legacy Prisma (scripts, pipl-compliance): import { prismaLegacyClient } from '@/lib/db/prisma-legacy'\n","/**\n * XSS prevention: sanitize user input before rendering or storing.\n * Use for display and for any user-generated content that may be shown as HTML.\n */\n\nconst SCRIPT_REGEX = /<script\\b[^<]*(?:(?!<\\/script>)<[^<]*)*<\\/script>/gi\nconst ON_EVENT_REGEX = /\\s*on\\w+\\s*=\\s*[\"'][^\"']*[\"']/gi\nconst JAVASCRIPT_URL_REGEX = /javascript\\s*:/gi\nconst DATA_URL_REGEX = /data\\s*:\\s*[^,]*\\s*,/gi\n// Strip dangerous tags (iframe, object, embed, form, meta with refresh, link with import)\nconst DANGEROUS_TAGS_REGEX = /<(?:iframe|object|embed|form|meta|link)\\b[^>]*>/gi\n\n/**\n * Strip script tags, event handlers, javascript: URLs, data: URLs, and dangerous tags.\n * Safe for inserting into text content or plain HTML contexts.\n */\nexport function sanitizeHtml(input: string): string {\n  if (typeof input !== 'string') return ''\n  return input\n    .replace(SCRIPT_REGEX, '')\n    .replace(DANGEROUS_TAGS_REGEX, '')\n    .replace(ON_EVENT_REGEX, '')\n    .replace(JAVASCRIPT_URL_REGEX, '')\n    .replace(DATA_URL_REGEX, '')\n}\n\n/**\n * Sanitize and optionally truncate to a max length (for DB/store).\n */\nexport function sanitizeHtmlWithMax(input: string, maxLength: number = 50_000): string {\n  const s = sanitizeHtml(input)\n  if (s.length <= maxLength) return s\n  return s.slice(0, maxLength)\n}\n\n/**\n * Escape HTML entities so the string is safe for use in text nodes or attributes.\n */\nexport function escapeHtml(input: string): string {\n  if (typeof input !== 'string') return ''\n  const map: Record<string, string> = {\n    '&': '&amp;',\n    '<': '&lt;',\n    '>': '&gt;',\n    '\"': '&quot;',\n    \"'\": '&#39;',\n    '/': '&#x2F;'\n  }\n  return input.replace(/[&<>\"'/]/g, (c) => map[c] ?? c)\n}\n\n/**\n * Sanitize for display in a context where only safe text is allowed (e.g. profile name, bio).\n * Prefer escapeHtml when rendering in React (React escapes by default); use this for legacy or raw HTML.\n */\nexport function sanitizeForDisplay(input: string): string {\n  return escapeHtml(sanitizeHtml(input))\n}\n","/**\n * Audit logging for data access and sensitive actions.\n * Writes to UserActivityLog for compliance and security review (Drizzle ORM).\n */\n\nimport { drizzleDb } from '@/lib/db/drizzle'\nimport { userActivityLog } from '@/lib/db/schema'\n\nexport const AUDIT_ACTIONS = {\n  PROFILE_VIEW: 'audit_profile_view',\n  PROFILE_UPDATE: 'audit_profile_update',\n  DATA_EXPORT: 'audit_data_export',\n  DATA_DELETE: 'audit_data_delete',\n  PAYMENT_CREATE: 'audit_payment_create',\n  PAYMENT_REFUND: 'audit_payment_refund',\n  PAYMENT_ALERT: 'audit_payment_alert',\n  COURSE_SHARE: 'audit_course_share',\n  ADMIN_ACCESS: 'audit_admin_access',\n  SENSITIVE_ACCESS: 'audit_sensitive_access'\n} as const\n\nexport type AuditAction = (typeof AUDIT_ACTIONS)[keyof typeof AUDIT_ACTIONS]\n\nexport interface AuditMetadata {\n  resource?: string\n  resourceId?: string\n  ip?: string\n  userAgent?: string\n  [key: string]: unknown\n}\n\n/**\n * Log an audit event (data access or sensitive action).\n * Fire-and-forget; does not throw.\n */\nexport async function logAudit(\n  userId: string,\n  action: AuditAction | string,\n  metadata?: AuditMetadata\n): Promise<void> {\n  try {\n    await drizzleDb.insert(userActivityLog).values({\n      id: crypto.randomUUID(),\n      userId,\n      action,\n      metadata: (metadata ?? {}) as object,\n    })\n  } catch (error) {\n    console.error('Audit log failed:', error)\n  }\n}\n","/**\n * Enterprise Security Audit System\n *\n * Audit logging for all security events with:\n * - Audit logging: all security events logged with context\n * - Compliance reporting: weekly security reports\n * - Incident tracking: security incident management\n * - Global coverage: multi-region, multi-language support\n * - Real-time alerting: critical security threshold breaches\n *\n * Integrates with: UserActivityLog, SecurityEvent, PerformanceAlert\n */\n\nimport crypto from 'crypto'\nimport { gte } from 'drizzle-orm'\nimport { drizzleDb } from '@/lib/db/drizzle'\nimport { securityEvent } from '@/lib/db/schema'\nimport { logAudit, AUDIT_ACTIONS, type AuditMetadata } from './audit'\n\n// =============================================================================\n// Types\n// =============================================================================\n\nexport type SecurityEventType =\n  | 'role_violation'\n  | 'payment_alert'\n  | 'access_attempt'\n  | 'access_denied'\n  | 'suspicious_activity'\n  | 'rate_limit_exceeded'\n  | 'csrf_failure'\n  | 'auth_failure'\n  | 'sensitive_data_access'\n  | 'cross_border_transfer'\n\nexport interface SecurityEventMetadata {\n  requiredRole?: string\n  attemptedResource?: string\n  curriculumId?: string\n  familyAccountId?: string\n  roomId?: string\n  success?: boolean\n  reason?: string\n  ip?: string\n  userAgent?: string\n  [key: string]: unknown\n}\n\nexport interface SecurityIncident {\n  id: string\n  eventType: SecurityEventType\n  severity: 'critical' | 'warning' | 'info'\n  userId?: string\n  metadata: SecurityEventMetadata\n  timestamp: Date\n  resolved?: boolean\n  resolvedAt?: Date\n}\n\n// =============================================================================\n// Security Event Logging\n// =============================================================================\n\n/**\n * Log a security event to UserActivityLog and SecurityEvent tables.\n * Fire-and-forget; does not throw.\n */\nexport async function logSecurityEvent(\n  eventType: SecurityEventType | string,\n  userId?: string,\n  metadata?: SecurityEventMetadata\n): Promise<void> {\n  try {\n    const meta: AuditMetadata = metadata ?? {}\n\n    if (userId) {\n      await logAudit(userId, `security_${eventType}`, meta)\n    }\n\n    await drizzleDb.insert(securityEvent).values({\n      id: crypto.randomUUID(),\n      eventType: `security_${eventType}`,\n      metadata: meta,\n    })\n  } catch (error) {\n    console.error('[SecurityAudit] logSecurityEvent failed:', error)\n  }\n}\n\n/**\n * Log role violation attempt (e.g. STUDENT accessing PARENT-only resource).\n */\nexport function logRoleViolation(\n  userId: string,\n  requiredRole: string,\n  resource: string,\n  metadata?: SecurityEventMetadata\n): void {\n  logSecurityEvent('role_violation', userId, {\n    requiredRole,\n    attemptedResource: resource,\n    ...metadata,\n  })\n}\n\n/**\n * Log payment alert (student attempted to join paid course without payment).\n */\nexport function logPaymentAlert(\n  studentId: string,\n  courseId: string,\n  roomId: string,\n  metadata?: SecurityEventMetadata\n): void {\n  logAudit(studentId, AUDIT_ACTIONS.PAYMENT_ALERT, {\n    resource: 'payment-alert',\n    resourceId: courseId,\n    roomId,\n    curriculumId: courseId,\n    ...metadata,\n  })\n  logSecurityEvent('payment_alert', studentId, {\n    curriculumId: courseId,\n    roomId,\n    ...metadata,\n  })\n}\n\n/**\n * Log access attempt (success or failure).\n */\nexport function logAccessAttempt(\n  userId: string,\n  resource: string,\n  metadata?: SecurityEventMetadata\n): void {\n  logSecurityEvent(\n    metadata?.success ? 'access_attempt' : 'access_denied',\n    userId,\n    { attemptedResource: resource, ...metadata }\n  )\n}\n\n/**\n * Log suspicious activity for threat detection.\n */\nexport function logSuspiciousActivity(\n  userId: string | undefined,\n  metadata: SecurityEventMetadata\n): void {\n  logSecurityEvent('suspicious_activity', userId, metadata)\n}\n\n// =============================================================================\n// Compliance Reporting\n// =============================================================================\n\nexport interface WeeklySecurityReport {\n  periodStart: Date\n  periodEnd: Date\n  totalEvents: number\n  byType: Record<string, number>\n  criticalIncidents: number\n  roleViolations: number\n  paymentAlerts: number\n  accessDenials: number\n}\n\n/**\n * Generate weekly security report for compliance.\n */\nexport async function generateWeeklySecurityReport(): Promise<WeeklySecurityReport> {\n  const now = new Date()\n  const weekAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000)\n\n  const events = await drizzleDb\n    .select({ eventType: securityEvent.eventType })\n    .from(securityEvent)\n    .where(gte(securityEvent.createdAt, weekAgo))\n\n  const byType: Record<string, number> = {}\n  let criticalIncidents = 0\n  let roleViolations = 0\n  let paymentAlerts = 0\n  let accessDenials = 0\n\n  for (const e of events) {\n    byType[e.eventType] = (byType[e.eventType] ?? 0) + 1\n    if (e.eventType.includes('role_violation')) roleViolations++\n    if (e.eventType.includes('payment_alert')) paymentAlerts++\n    if (e.eventType.includes('access_denied')) accessDenials++\n  }\n\n  return {\n    periodStart: weekAgo,\n    periodEnd: now,\n    totalEvents: events.length,\n    byType,\n    criticalIncidents,\n    roleViolations,\n    paymentAlerts,\n    accessDenials,\n  }\n}\n\n// =============================================================================\n// Incident Tracking\n// =============================================================================\n\nconst activeIncidents = new Map<string, SecurityIncident>()\n\n/**\n * Track a security incident for follow-up.\n */\nexport function trackIncident(\n  eventType: SecurityEventType,\n  severity: 'critical' | 'warning' | 'info',\n  metadata: SecurityEventMetadata,\n  userId?: string\n): string {\n  const id = `inc_${Date.now()}_${Math.random().toString(36).slice(2, 9)}`\n  const incident: SecurityIncident = {\n    id,\n    eventType,\n    severity,\n    userId,\n    metadata,\n    timestamp: new Date(),\n  }\n  activeIncidents.set(id, incident)\n\n  if (severity === 'critical') {\n    logSecurityEvent(eventType, userId, { ...metadata, incidentId: id })\n  }\n\n  return id\n}\n\n/**\n * Resolve a tracked incident.\n */\nexport function resolveIncident(incidentId: string): void {\n  const incident = activeIncidents.get(incidentId)\n  if (incident) {\n    incident.resolved = true\n    incident.resolvedAt = new Date()\n  }\n}\n\n// =============================================================================\n// Exports\n// =============================================================================\n\nexport const securityAudit = {\n  logSecurityEvent,\n  logRoleViolation,\n  logPaymentAlert,\n  logAccessAttempt,\n  logSuspiciousActivity,\n  generateWeeklySecurityReport,\n  trackIncident,\n  resolveIncident,\n}\n","/**\n * Security Logger\n * Centralized security event logging for AI, payments, and other security-sensitive modules.\n */\n\nimport { logSecurityEvent } from './security-audit'\n\nexport interface SecurityLogEvent {\n  eventType: string\n  description: string\n  severity?: 'LOW' | 'MEDIUM' | 'HIGH' | 'CRITICAL'\n  metadata?: Record<string, unknown>\n}\n\nexport const securityLogger = {\n  logEvent(event: SecurityLogEvent): void {\n    const severity = event.severity ?? 'LOW'\n    logSecurityEvent(event.eventType, undefined, {\n      description: event.description,\n      severity,\n      ...event.metadata,\n    }).catch((err) => console.error('Security log failed:', err))\n  },\n}\n","// @ts-nocheck\n/**\n * AI Input/Output Sanitization\n * Advanced AI security measures for input sanitization and response validation\n * Extends basic sanitization with AI-specific security measures\n */\n\nimport { sanitizeHtml } from '@/lib/security/sanitize'\nimport crypto from 'crypto'\nimport { securityLogger } from '@/lib/security/logging'\n\n/**\n * Student ID anonymization for AI contexts\n * Creates consistent anonymous identifiers for AI interactions\n */\nexport class AISecurityManager {\n  /**\n   * Sanitize AI input with advanced AI security measures\n   * Prevents prompt injection, escapes AI jailbreaks, removes PII\n   */\n  static sanitizeAiInput(input: string): string {\n    // Basic sanity check\n    if (!input || typeof input !== 'string') {\n      return ''\n    }\n\n    try {\n      // Normalize input\n      let sanitized = input.trim()\n\n      // Critical: Remove system prompt injection attempts\n      const systemPrompts = [\n        /ignore.*all.*previous.*instructions/gi,\n        /forget.*everything.*above/gi,\n        /disregard.*above/gi,\n        /you are now.*admin/gi,\n        /your role is now.*system/gi,\n        /from now on.*you are.*developer/gi,\n        /new instructions.*ignore.*previous/gi,\n        /system prompt.*override/gi,\n        /override.*all.*security.*rules/gi\n      ]\n\n      for (const pattern of systemPrompts) {\n        sanitized = sanitized.replace(pattern, '[REMOVED]')\n      }\n\n      // Remove AI assistant impersonation attempts\n      const jailbreakPatterns = [\n        /assistant.*you.*are.*now/gi,\n        /you.*are.*now.*assistant.*system/gi,\n        /mode.*system.*administrator/gi,\n        /bypass.*all.*restrictions/gi,\n        /unlock.*all.*capabilities/gi\n      ]\n\n      for (const pattern of jailbreakPatterns) {\n        sanitized = sanitized.replace(pattern, '[REMOVED]')\n      }\n\n      // Remove command injection attempts\n      const commandInjection = [\n        /exec\\s*\\(/gi,\n        /system\\s*\\(/gi,\n        /shell\\s*\\(/gi,\n        /exec\\s+/gi,\n        /system\\s+/gi,\n        /shell\\s+/gi,\n        /bash\\.*execute/gi,\n        /powershell\\.*run/gi\n      ]\n\n      for (const pattern of commandInjection) {\n        sanitized = sanitized.replace(pattern, '[REMOVED]')\n      }\n\n      // Remove dangerous code patterns\n      const dangerousCode = [\n        /<script.*?>/gi,\n        /javascript:\\.*\\(/gi,\n        /vbscript:\\.*\\(/gi,\n        /onload\\s*=/gi,\n        /onerror\\s*=/gi,\n        /onclick\\s*=/gi,\n        /eval\\s*\\(/gi\n      ]\n\n      for (const pattern of dangerousCode) {\n        sanitized = sanitized.replace(pattern, '[REMOVED]')\n      }\n\n      // Remove system control attempts\n      const systemControl = [\n        /sudo/gi,\n        /admin/gi,\n        /system.*override/gi,\n        /override.*security.*settings/gi,\n        /disable.*all.*protections/gi\n      ]\n\n      for (const pattern of systemControl) {\n        sanitized = sanitized.replace(pattern, '[REMOVED]')\n      }\n\n      // Apply enhanced HTML sanitization\n      sanitized = sanitizeHtml(sanitized)\n\n      // Apply length limits to prevent overflow attacks\n      const MAX_INPUT_LENGTH = 3000\n      if (sanitized.length > MAX_INPUT_LENGTH) {\n        sanitized = sanitized.substring(0, MAX_INPUT_LENGTH) + ' [TRUNCATED FOR SECURITY]'\n      }\n\n      // Log security sanitization\n      securityLogger.logEvent({\n        eventType: 'AI_INPUT_SANITIZED',\n        description: 'AI input underwent security sanitization',\n        metadata: {\n          originalLength: input.length,\n          sanitizedLength: sanitized.length,\n          patternsRemoved: systemPrompts.length + jailbreakPatterns.length + commandInjection.length\n        }\n      })\n\n      return sanitized.trim()\n\n    } catch (error) {\n      securityLogger.logEvent({\n        eventType: 'AI_SECURITY_ERROR',\n        description: 'AI input sanitization error occurred',\n        severity: 'MEDIUM',\n        metadata: {\n          error: error.message\n        }\n      })\n      \n      // Return safe, empty response on sanitization error\n      return ''\n    }\n  }\n\n  /**\n   * Create student identifier hash for anonymity in AI context\n   * Consistent hashing for same student across sessions\n   */\n  static createStudentHash(studentId: string): string {\n    if (!studentId || typeof studentId !== 'string') {\n      return 'anonymous_student'\n    }\n\n    try {\n      // Use student's unique ID + system secret for consistent hashing\n      const secret = process.env.NEXTAUTH_SECRET || 'default_secret'\n      \n      // Create deterministic hash for consistent anonymization\n      return crypto\n        .createHash('sha256')\n        .update(studentId)\n        .update(secret)\n        .digest('hex')\n        .substring(0, 16) // 16-character anonymized ID\n\n    } catch (error) {\n      securityLogger.logEvent({\n        eventType: 'STUDENT_HASH_ERROR',\n        description: 'Student hash creation failed',\n        severity: 'LOW',\n        metadata: {\n          error: error.message\n        }\n      })\n      \n      // Fallback to generic anonymous identifier\n      return 'anonymous_student'\n    }\n  }\n\n  /**\n   * Validate AI response for safety and appropriateness\n   * Checks for inappropriate content, system leakage, PII exposure\n   */\n  static async validateAiResponse(response: string): Promise<{\n    isValid: boolean\n    issues: string[]\n    severity: 'LOW' | 'MEDIUM' | 'HIGH' | 'CRITICAL'\n  }> {\n    const issues: string[] = []\n    let severity: 'LOW' | 'MEDIUM' | 'HIGH' | 'CRITICAL' = 'LOW'\n\n    if (!response || typeof response !== 'string') {\n      return {\n        isValid: false,\n        issues: ['AI response is invalid'],\n        severity: 'HIGH'\n      }\n    }\n\n    // Check for inappropriate content\n    const inappropriatePatterns = [\n      /suicide(\\.*|\\s+)+support/gi,\n      /self.?harm(\\.*|\\s+)+advice/gi,\n      /violence(\\.*|\\s+)+instructions/gi,\n      /how.?to.?harm.+yourself/gi,\n      /end.?it.?all/gi\n    ]\n\n    for (const pattern of inappropriatePatterns) {\n      if (pattern.test(response)) {\n        issues.push('AI response contains inappropriate or harmful content')\n        severity = 'CRITICAL'\n        break\n      }\n    }\n\n    // Check for PII leakage\n    const piiPatterns = [\n      /\\b[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\\.[A-Za-z]{2,}\\b/i,\n      /\\b\\d{3}[-.\\s]?\\d{3}[-.\\s]?\\d{4}\\b/g,\n      /\\b\\d{3}-\\d{2}-\\d{4}\\b/g\n    ]\n\n    for (const pattern of piiPatterns) {\n      if (pattern.test(response)) {\n        issues.push('AI response contains potential personal information')\n        severity = severity === 'CRITICAL' ? 'CRITICAL' : 'HIGH'\n      }\n    }\n\n    // Check for system leakage\n    if (response.includes('System:') || response.includes('Instruction:')) {\n      issues.push('AI response may contain system instruction leakage')\n      severity = severity === 'CRITICAL' ? 'CRITICAL' : 'HIGH'\n    }\n\n    // Check for malicious content\n    const maliciousContent = [\n      /eval\\s*\\(/gi,\n      /system\\s*\\(/gi,\n      /download.*malicious/gi,\n      /install.*virus/gi\n    ]\n\n    for (const pattern of maliciousContent) {\n      if (pattern.test(response)) {\n        issues.push('AI response contains potentially malicious content')\n        severity = 'CRITICAL'\n      }\n    }\n\n    // Check response length limits\n    const MAX_RESPONSE_LENGTH = 5000\n    if (response.length > MAX_RESPONSE_LENGTH) {\n      issues.push('AI response exceeds safe length limits')\n      severity = severity === 'CRITICAL' ? 'CRITICAL' : 'HIGH'\n    }\n\n    // Log validation results\n    if (issues.length > 0) {\n      securityLogger.logEvent({\n        eventType: 'AI_RESPONSE_VALIDATION',\n        description: 'AI response failed security validation',\n        severity: severity,\n        metadata: {\n          issues: issues,\n          responseLength: response.length\n        }\n      })\n    }\n\n    return {\n      isValid: issues.length === 0,\n      issues,\n      severity\n    }\n  }\n\n  /**\n   * Create safe tutoring prompt for AI with built-in protections\n   */\n  static createSafeTutoringPrompt(\n    studentId: string,\n    subject: string,\n    gradeLevel: string,\n    question: string\n  ): { systemPrompt: string; userPrompt: string } {\n    // Anonymize student identifier\n    const studentHash = this.createStudentHash(studentId)\n    \n    // Sanitize the question\n    const sanitizedQuestion = this.sanitizeAiInput(question)\n    \n    if (sanitizedQuestion.length === 0) {\n      return {\n        systemPrompt: this.createProtectedSystemPrompt(subject, gradeLevel),\n        userPrompt: 'Student provided invalid input - please redirect to proper input format'\n      }\n    }\n\n    return {\n      systemPrompt: this.createProtectedSystemPrompt(subject, gradeLevel, studentHash),\n      userPrompt: `Student ${studentHash} asks: \"${sanitizedQuestion}\"`\n    }\n  }\n\n  /**\n   * Create protected system prompt with safety guidelines\n   */\n  private static createProtectedSystemPrompt(\n    subject: string,\n    gradeLevel: string,\n    studentHash?: string\n  ): string {\n    return `\nYou are an AI tutor specializing in ${subject} for ${gradeLevel} level students.\n\nSAFETY RULES STRICTLY ENFORCED:\n1. **NEVER** provide direct answers - use Socratic method (guiding questions)\n2. **NEVER** give private information or personal data\n3. **NEVER** provide medical, legal, or financial advice\n4. **NEVER** generate harmful or inappropriate content\n5. **NEVER** give instructions for self-harm or dangerous activities\n6. **ALWAYS** maintain educational focus and age-appropriate language\n7. **ALWAYS** escalate concerning content to human supervision\n8. **ALWAYS** encourage students to discover solutions through guided learning\n\nRESPONSE GUIDELINES:\n- Use only educational, age-appropriate language\n- Ask questions to guide discovery\n- Provide examples when helpful\n- Adapt to student${studentHash ? ` ${studentHash}` : ''}'s responses\n- Never complete assignments for students\n- Always check for understanding\n\nCURRENT CONTEXT:\n- Subject: ${subject}\n- Level: ${gradeLevel}\n- Anonymized Student ID: ${studentHash || 'anonymous'}\n- Current Date: ${new Date().toISOString()}\n`.trim()\n  }\n}\n\nexport default AISecurityManager","/**\n * Memory Service\n * The \"Shared Brain\" for AI Agents\n * Manages context persistence and retrieval\n */\n\nimport { StudentContext, StudentProfile, LearningState, AgentSignal } from './types/context'\n\n// Mock Database (In-Memory for now)\nconst profiles = new Map<string, StudentProfile>()\nconst states = new Map<string, LearningState>()\nconst signals = new Map<string, AgentSignal[]>()\nconst roomTranscripts = new Map<string, any[]>()\n\n// Initialize with some mock data for testing\nconst MOCK_STUDENT_ID = 'student-1'\nprofiles.set(MOCK_STUDENT_ID, {\n    id: MOCK_STUDENT_ID,\n    name: 'Sarah Chen',\n    age: 16,\n    level: 'B1',\n    learningStyle: 'visual',\n    interests: ['music', 'technology', 'travel'],\n    goals: ['improve_pronunciation', 'vocabulary_expansion'],\n    preferredVoice: { gender: 'female', accent: 'us' }\n})\n\nstates.set(MOCK_STUDENT_ID, {\n    currentMood: 'neutral',\n    energyLevel: 80,\n    recentStruggles: [],\n    masteredTopics: ['present_perfect', 'basic_greetings'],\n    activeTopics: ['conditionals', 'phrasal_verbs']\n})\n\nsignals.set(MOCK_STUDENT_ID, [])\n\nexport class MemoryService {\n    /**\n     * Get the full context for a student\n     * Aggregates Profile + State + Signals\n     */\n    static async getStudentContext(studentId: string): Promise<StudentContext | null> {\n        const profile = profiles.get(studentId)\n        if (!profile) return null\n\n        const state = states.get(studentId) || this.getInitialState()\n        const studentSignals = signals.get(studentId) || []\n\n        // Filter out expired signals\n        const activeSignals = studentSignals.filter(s => !s.expiresAt || s.expiresAt > Date.now())\n\n        return {\n            profile,\n            state,\n            signals: activeSignals\n        }\n    }\n\n    /**\n     * Transcript Management\n     */\n    static appendTranscript(roomId: string, entry: any) {\n        const current = roomTranscripts.get(roomId) || []\n        roomTranscripts.set(roomId, [...current, entry])\n    }\n\n    static getTranscript(roomId: string): any[] {\n        return roomTranscripts.get(roomId) || []\n    }\n\n    /**\n     * Record a new signal from an agent\n     */\n    static async recordSignal(studentId: string, signal: Omit<AgentSignal, 'id' | 'timestamp'>) {\n        const newSignal: AgentSignal = {\n            ...signal,\n            id: Math.random().toString(36).substring(7),\n            timestamp: Date.now()\n        }\n\n        const currentSignals = signals.get(studentId) || []\n        signals.set(studentId, [...currentSignals, newSignal])\n\n        // Auto-update state based on signals\n        if (signal.type === 'struggle_detected') {\n            await this.updateState(studentId, (state) => {\n                state.recentStruggles.push({\n                    topic: signal.context?.topic || 'unknown',\n                    errorType: signal.context?.errorType || 'general',\n                    severity: signal.context?.severity || 5,\n                    detectedAt: Date.now()\n                })\n                // Keep only last 5 struggles\n                if (state.recentStruggles.length > 5) state.recentStruggles.shift()\n                return state\n            })\n        }\n    }\n\n    /**\n     * Update the dynamic learning state\n     */\n    static async updateState(studentId: string, updateFn: (state: LearningState) => LearningState) {\n        const currentState = states.get(studentId) || this.getInitialState()\n        const newState = updateFn({ ...currentState })\n        states.set(studentId, newState)\n    }\n\n    /**\n     * Get initial state for new students\n     */\n    private static getInitialState(): LearningState {\n        return {\n            currentMood: 'neutral',\n            energyLevel: 100,\n            recentStruggles: [],\n            masteredTopics: [],\n            activeTopics: []\n        }\n    }\n\n    /**\n     * Analyze Transcript Summary and update context\n     * This is the bridge from Classroom TA to Personal Tutor\n     */\n    static async processClassSummary(studentId: string, summaryJson: any) {\n        // 1. Record the summary signal\n        await this.recordSignal(studentId, {\n            source: 'classroom_ta',\n            type: 'topic_requested', // Or a new type 'class_summary'\n            content: `Completed class on ${summaryJson.topic}. Status: ${summaryJson.status}`,\n            context: summaryJson\n        })\n\n        // 2. Update state based on summary\n        await this.updateState(studentId, (state) => {\n            // Add struggles\n            if (summaryJson.struggles && Array.isArray(summaryJson.struggles)) {\n                summaryJson.struggles.forEach((s: string) => {\n                    state.recentStruggles.push({\n                        topic: s,\n                        errorType: 'general',\n                        severity: 7,\n                        detectedAt: Date.now()\n                    })\n                })\n            }\n\n            // Update active topics\n            if (summaryJson.topic) {\n                if (!state.activeTopics.includes(summaryJson.topic)) {\n                    state.activeTopics.push(summaryJson.topic)\n                }\n            }\n\n            return state\n        })\n    }\n\n    /**\n     * Record Quiz Result and Update Context\n     * Updates student context based on quiz performance\n     */\n    static async recordQuizResult(studentId: string, result: {\n        topic: string\n        score: number\n        maxScore: number\n        questionTypes: string[]\n    }) {\n        const percentage = result.score / result.maxScore\n\n        // Record signal\n        await this.recordSignal(studentId, {\n            source: 'personal_tutor',\n            type: percentage >= 0.7 ? 'mastery_achieved' : 'struggle_detected',\n            content: `Quiz on ${result.topic}: ${result.score}/${result.maxScore} (${Math.round(percentage * 100)}%)`,\n            context: result\n        })\n\n        // Update state based on performance\n        await this.updateState(studentId, (state) => {\n            if (percentage < 0.7) {\n                // Poor performance - add to struggles\n                const existingStruggle = state.recentStruggles.find(s => s.topic === result.topic)\n                if (!existingStruggle) {\n                    state.recentStruggles.push({\n                        topic: result.topic,\n                        errorType: 'general',\n                        severity: Math.round((1 - percentage) * 10), // Higher severity for lower scores\n                        detectedAt: Date.now()\n                    })\n                    // Keep only last 10 struggles\n                    if (state.recentStruggles.length > 10) {\n                        state.recentStruggles.shift()\n                    }\n                }\n\n                // Add to active topics if not already there\n                if (!state.activeTopics.includes(result.topic)) {\n                    state.activeTopics.push(result.topic)\n                }\n            } else if (percentage >= 0.85) {\n                // Excellent performance - add to mastered topics\n                if (!state.masteredTopics.includes(result.topic)) {\n                    state.masteredTopics.push(result.topic)\n                }\n\n                // Remove from struggles if present\n                state.recentStruggles = state.recentStruggles.filter(s => s.topic !== result.topic)\n            }\n\n            return state\n        })\n    }\n}\n"],"names":[],"mappings":"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"}}]
}