;!function(){try { var e="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof global?global:"undefined"!=typeof window?window:"undefined"!=typeof self?self:{},n=(new e.Error).stack;n&&((e._debugIds|| (e._debugIds={}))[n]="1957c0e2-2217-1220-6c47-00366b81d271")}catch(e){}}();
module.exports=[418130,e=>{"use strict";var t=e.i(614512),i=e.i(122442),r=e.i(685438),n=e.i(253786);async function a(e,t,a,o){let s=await (0,n.getSigKey)(e,t,"verify");(0,r.checkKeyLength)(e,s);let d=(0,i.subtleAlgorithm)(e,s.algorithm);try{return await crypto.subtle.verify(d,s,a,o)}catch{return!1}}var o=e.i(180294),s=e.i(264463),d=e.i(501702),l=e.i(742767),E=e.i(364240),c=e.i(159361),A=e.i(996640);async function S(e,i,r){let n,S;if(!(0,l.isObject)(e))throw new o.JWSInvalid("Flattened JWS must be an object");if(void 0===e.protected&&void 0===e.header)throw new o.JWSInvalid('Flattened JWS must have either of the "protected" or "header" members');if(void 0!==e.protected&&"string"!=typeof e.protected)throw new o.JWSInvalid("JWS Protected Header incorrect type");if(void 0===e.payload)throw new o.JWSInvalid("JWS Payload missing");if("string"!=typeof e.signature)throw new o.JWSInvalid("JWS Signature missing or incorrect type");if(void 0!==e.header&&!(0,l.isObject)(e.header))throw new o.JWSInvalid("JWS Unprotected Header incorrect type");let T={};if(e.protected)try{let i=(0,t.decode)(e.protected);T=JSON.parse(s.decoder.decode(i))}catch{throw new o.JWSInvalid("JWS Protected Header is invalid")}if(!(0,d.isDisjoint)(T,e.header))throw new o.JWSInvalid("JWS Protected and JWS Unprotected Header Parameter names must be disjoint");let u={...T,...e.header},R=(0,c.validateCrit)(o.JWSInvalid,new Map([["b64",!0]]),r?.crit,T,u),p=!0;if(R.has("b64")&&"boolean"!=typeof(p=T.b64))throw new o.JWSInvalid('The "b64" (base64url-encode payload) Header Parameter must be a boolean');let{alg:w}=u;if("string"!=typeof w||!w)throw new o.JWSInvalid('JWS "alg" (Algorithm) Header Parameter missing or invalid');let y=r&&function(e,t){if(void 0!==t&&(!Array.isArray(t)||t.some(e=>"string"!=typeof e)))throw TypeError(`"${e}" option must be an array of strings`);if(t)return new Set(t)}("algorithms",r.algorithms);if(y&&!y.has(w))throw new o.JOSEAlgNotAllowed('"alg" (Algorithm) Header Parameter value not allowed');if(p){if("string"!=typeof e.payload)throw new o.JWSInvalid("JWS Payload must be a string")}else if("string"!=typeof e.payload&&!(e.payload instanceof Uint8Array))throw new o.JWSInvalid("JWS Payload must be a string or an Uint8Array instance");let m=!1;"function"==typeof i&&(i=await i(T,e),m=!0),(0,E.checkKeyType)(w,i,"verify");let _=(0,s.concat)(void 0!==e.protected?(0,s.encode)(e.protected):new Uint8Array,(0,s.encode)("."),"string"==typeof e.payload?p?(0,s.encode)(e.payload):s.encoder.encode(e.payload):e.payload);try{n=(0,t.decode)(e.signature)}catch{throw new o.JWSInvalid("Failed to base64url decode the signature")}let I=await (0,A.normalizeKey)(i,w);if(!await a(w,I,n,_))throw new o.JWSSignatureVerificationFailed;if(p)try{S=(0,t.decode)(e.payload)}catch{throw new o.JWSInvalid("Failed to base64url decode the payload")}else S="string"==typeof e.payload?s.encoder.encode(e.payload):e.payload;let f={payload:S};return(void 0!==e.protected&&(f.protectedHeader=T),void 0!==e.header&&(f.unprotectedHeader=e.header),m)?{...f,key:I}:f}async function T(e,t,i){if(e instanceof Uint8Array&&(e=s.decoder.decode(e)),"string"!=typeof e)throw new o.JWSInvalid("Compact JWS must be a string or Uint8Array");let{0:r,1:n,2:a,length:d}=e.split(".");if(3!==d)throw new o.JWSInvalid("Invalid Compact JWS");let l=await S({payload:n,protected:r,signature:a},t,i),E={payload:l.payload,protectedHeader:l.protectedHeader};return"function"==typeof t?{...E,key:l.key}:E}var u=e.i(66443);async function R(e,t,i){let r=await T(e,t,i);if(r.protectedHeader.crit?.includes("b64")&&!1===r.protectedHeader.b64)throw new o.JWTInvalid("JWTs MUST NOT use unencoded payload");let n={payload:(0,u.validateClaimsSet)(r.protectedHeader,r.payload,i),protectedHeader:r.protectedHeader};return"function"==typeof t?{...n,key:r.key}:n}e.s(["jwtVerify",()=>R],418130)},979651,e=>{"use strict";let t={USERS_READ:"users:read",USERS_WRITE:"users:write",USERS_DELETE:"users:delete",USERS_IMPERSONATE:"users:impersonate",USERS_BAN:"users:ban",FEATURES_READ:"features:read",FEATURES_WRITE:"features:write",FEATURES_DELETE:"features:delete",LLM_READ:"llm:read",LLM_WRITE:"llm:write",LLM_DELETE:"llm:delete",SETTINGS_READ:"settings:read",SETTINGS_WRITE:"settings:write",ANALYTICS_READ:"analytics:read",ANALYTICS_EXPORT:"analytics:export",AUDIT_READ:"audit:read",CONTENT_READ:"content:read",CONTENT_WRITE:"content:write",CONTENT_DELETE:"content:delete",CONTENT_MODERATE:"content:moderate",SECURITY_READ:"security:read",SECURITY_WRITE:"security:write",ADMINS_READ:"admins:read",ADMINS_WRITE:"admins:write",ADMINS_DELETE:"admins:delete",SYSTEM_READ:"system:read",SYSTEM_MAINTENANCE:"system:maintenance",ALL:"*"},i={SUPER_ADMIN:[t.ALL],ADMIN:[t.USERS_READ,t.USERS_WRITE,t.USERS_BAN,t.FEATURES_READ,t.FEATURES_WRITE,t.LLM_READ,t.LLM_WRITE,t.SETTINGS_READ,t.SETTINGS_WRITE,t.ANALYTICS_READ,t.ANALYTICS_EXPORT,t.AUDIT_READ,t.CONTENT_READ,t.CONTENT_WRITE,t.CONTENT_MODERATE,t.SECURITY_READ,t.SECURITY_WRITE,t.ADMINS_READ,t.SYSTEM_READ],MODERATOR:[t.USERS_READ,t.FEATURES_READ,t.CONTENT_READ,t.CONTENT_WRITE,t.CONTENT_MODERATE,t.AUDIT_READ],SUPPORT:[t.USERS_READ,t.USERS_IMPERSONATE,t.CONTENT_READ,t.AUDIT_READ]};function r(e,i){if(e.includes(t.ALL)||e.includes(i))return!0;let[r,n]=i.split(":"),a=`${r}:*`;return!!e.includes(a)}function n(e){return i[e]||[]}t.USERS_READ,t.USERS_WRITE,t.USERS_DELETE,t.USERS_IMPERSONATE,t.USERS_BAN,t.FEATURES_READ,t.FEATURES_WRITE,t.FEATURES_DELETE,t.LLM_READ,t.LLM_WRITE,t.LLM_DELETE,t.SETTINGS_READ,t.SETTINGS_WRITE,t.ANALYTICS_READ,t.ANALYTICS_EXPORT,t.CONTENT_READ,t.CONTENT_WRITE,t.CONTENT_DELETE,t.CONTENT_MODERATE,t.SECURITY_READ,t.SECURITY_WRITE,t.ADMINS_READ,t.ADMINS_WRITE,t.ADMINS_DELETE,t.SYSTEM_READ,t.SYSTEM_MAINTENANCE,t.AUDIT_READ,e.s(["Permissions",0,t,"getRolePermissions",()=>n,"hasPermission",()=>r])},569773,e=>e.a(async(t,i)=>{try{var r=e.i(359498),n=e.i(620971),a=e.i(909105),o=e.i(738597);e.i(688768);var s=e.i(257357),d=e.i(323214),l=e.i(597747),E=e.i(418130),c=e.i(75835),A=e.i(254799),S=e.i(979651),T=t([o]);[o]=T.then?(await T)():T;let h="admin_session",N=function(){let e=process.env.ADMIN_JWT_SECRET||process.env.NEXTAUTH_SECRET||"";if(!e||"default-secret"===e)throw Error("Missing secure ADMIN_JWT_SECRET or NEXTAUTH_SECRET in production");return new TextEncoder().encode(e||"dev-admin-secret")}();async function u(e){return(0,d.hash)(e,12)}async function R(e,t){return(0,d.compare)(e,t)}async function p(e,t,i){let r=(0,c.nanoid)(32),n=new Date(Date.now()+288e5);return await o.drizzleDb.insert(s.adminSession).values({id:A.default.randomUUID(),adminId:e,token:r,ipAddress:t||null,userAgent:i||null,expiresAt:n,startedAt:new Date,lastActiveAt:new Date,isRevoked:!1}),await new l.SignJWT({sessionId:r,adminId:e}).setProtectedHeader({alg:"HS256"}).setIssuedAt().setExpirationTime(n).sign(N)}async function w(e){try{return(await (0,E.jwtVerify)(e,N)).payload}catch{return null}}async function y(e){try{let t;if(e)t=e.cookies.get(h)?.value;else{let e=await (0,r.cookies)();t=e.get(h)?.value}if(!t)return null;let i=await w(t);if(!i)return null;let n=await o.drizzleDb.query.adminSession.findFirst({where:(0,a.eq)(s.adminSession.token,i.sessionId),with:{admin:{with:{adminAssignments:{where:(0,a.eq)(s.adminAssignment.isActive,!0),with:{role:!0}},profile:!0}}}});if(!n||n.isRevoked||n.expiresAt<new Date)return null;await o.drizzleDb.update(s.adminSession).set({lastActiveAt:new Date}).where((0,a.eq)(s.adminSession.id,n.id));let d=n.admin.adminAssignments.map(e=>e.role.name),l=new Set;return n.admin.adminAssignments.forEach(e=>{(0,S.getRolePermissions)(e.role.name).forEach(e=>l.add(e))}),{id:n.id,adminId:n.adminId,email:n.admin.email,name:n.admin.profile?.name||null,permissions:Array.from(l),roles:d,ipAddress:n.ipAddress||void 0,userAgent:n.userAgent||void 0,createdAt:n.startedAt,expiresAt:n.expiresAt}}catch(e){return console.error("Error getting admin session:",e),null}}async function m(){(await (0,r.cookies)()).delete({name:h,path:"/"})}async function _(e,t){let i=await y(e);return i?t&&!(i&&(0,S.hasPermission)(i.permissions,t))?{session:null,response:n.NextResponse.json({error:"Forbidden"},{status:403})}:{session:i}:{session:null,response:n.NextResponse.json({error:"Unauthorized"},{status:401})}}async function I(e,t,i){try{await o.drizzleDb.insert(s.adminAuditLog).values({id:A.default.randomUUID(),adminId:e,action:t,resourceType:i.resourceType||null,resourceId:i.resourceId||null,previousState:i.previousState||null,newState:i.newState||null,metadata:i.metadata||null,ipAddress:i.ipAddress||null,userAgent:i.userAgent||null,createdAt:new Date})}catch(e){console.error("Error logging admin action:",e)}}async function f(e){let[t]=await o.drizzleDb.select().from(s.ipWhitelist).where((0,a.and)((0,a.eq)(s.ipWhitelist.ipAddress,e),(0,a.eq)(s.ipWhitelist.isActive,!0),(0,a.or)((0,a.isNull)(s.ipWhitelist.expiresAt),(0,a.gt)(s.ipWhitelist.expiresAt,new Date)))).limit(1);return!!t}function D(e){let t=e.headers.get("x-forwarded-for"),i=e.headers.get("x-real-ip");return t?t.split(",")[0].trim():i||"unknown"}e.s(["ADMIN_TOKEN_EXPIRY",0,28800,"ADMIN_TOKEN_NAME",0,h,"clearAdminCookie",()=>m,"createAdminSession",()=>p,"getAdminSession",()=>y,"getClientIp",()=>D,"hashPassword",()=>u,"isIpWhitelisted",()=>f,"logAdminAction",()=>I,"requireAdmin",()=>_,"verifyPassword",()=>R]),i()}catch(e){i(e)}},!1)];

//# debugId=1957c0e2-2217-1220-6c47-00366b81d271
//# sourceMappingURL=ADK_WORKSPACE_TutorMekimi_tutorme-app_911c91e1._.js.map