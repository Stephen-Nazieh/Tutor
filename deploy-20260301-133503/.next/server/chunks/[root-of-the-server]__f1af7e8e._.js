;!function(){try { var e="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof global?global:"undefined"!=typeof window?window:"undefined"!=typeof self?self:{},n=(new e.Error).stack;n&&((e._debugIds|| (e._debugIds={}))[n]="f535f24a-08b4-7270-5e7c-cd0cb7a1fbdf")}catch(e){}}();
module.exports=[908286,e=>{"use strict";async function t(e,t){var r=e instanceof Promise?await e:e;if(!r||"object"!=typeof r)return;let a=r[t];return null!=a?Array.isArray(a)?a[0]:a:void 0}e.s(["getParamAsync",()=>t])},891820,e=>e.a(async(t,r)=>{try{var a=e.i(909105),n=e.i(997103),s=e.i(320947),i=e.i(738597);e.i(688768);var o=e.i(257357),l=t([i]);async function c(e,t){let r=await i.drizzleDb.select().from(o.taskSubmission).where((0,a.eq)(o.taskSubmission.studentId,e));if(0===r.length)return{averageScore:0,completionRate:0,engagementScore:0,attendanceRate:0,participationRate:0};let n=r.reduce((e,t)=>e+(Number(t.score)||0),0)/r.length,l=r.filter(e=>"graded"===e.status).length/r.length*100,c=r.reduce((e,t)=>e+(t.timeSpent||0),0)/r.length,u=r.reduce((e,t)=>e+(t.attempts||1),0)/r.length,d=Math.min(100,c/300*50+1/u*50),m=await i.drizzleDb.select({sessionId:o.sessionParticipant.sessionId,joinedAt:o.sessionParticipant.joinedAt}).from(o.sessionParticipant).where((0,a.eq)(o.sessionParticipant.studentId,e)),p=new Set(m.map(e=>e.sessionId)),f=new Set(m.filter(e=>null!=e.joinedAt).map(e=>e.sessionId)),g=p.size,h=f.size,[w]=await i.drizzleDb.select({count:s.sql`count(*)::int`}).from(o.message).where((0,a.eq)(o.message.userId,e)),S=w?.count??0,v=Math.min(100,5*S);return{averageScore:Math.round(10*n)/10,completionRate:Math.round(10*l)/10,engagementScore:Math.round(10*d)/10,attendanceRate:Math.round(10*(g>0?h/g*100:0))/10,participationRate:Math.round(10*v)/10}}async function u(e){let t={},r=await i.drizzleDb.select().from(o.taskSubmission).where((0,a.eq)(o.taskSubmission.studentId,e));for(let e of r){let r=e.answers;for(let a of r?.subjects||r?.topics||["general"])t[a]||(t[a]=[]),t[a].push(e.score||0)}let n={};for(let e of r){let t=e.questionResults;if(Array.isArray(t))for(let e of t){let t=e.questionId??"unknown";n[t]||(n[t]={correct:0,total:0}),n[t].total++,e.correct&&n[t].correct++}}for(let t of(await i.drizzleDb.select().from(o.quizAttempt).where((0,a.and)((0,a.eq)(o.quizAttempt.studentId,e),(0,a.isNotNull)(o.quizAttempt.questionResults))).limit(50))){let e=t.questionResults;if(Array.isArray(e))for(let t of e){let e=t.questionId??"unknown";n[e]||(n[e]={correct:0,total:0}),n[e].total++,t.correct&&n[e].correct++}}for(let[e,r]of Object.entries(n)){if(0===r.total)continue;let a=r.correct/r.total*100,n=`Q:${e}`;a>=80?(t[n]||(t[n]=[]),t[n].push(a)):a<50&&(t[n]||(t[n]=[]),t[n].push(a))}let s=[],l=[];for(let[e,r]of Object.entries(t)){let t=r.reduce((e,t)=>e+t,0)/r.length;t>=80?s.push(e):t<60&&l.push(e)}return{strengths:s,weaknesses:l}}async function d(e){let t=await i.drizzleDb.select().from(o.taskSubmission).where((0,a.eq)(o.taskSubmission.studentId,e)).orderBy((0,n.desc)(o.taskSubmission.submittedAt)).limit(50),r={},s=(e,t)=>{r[e]||(r[e]={count:0,lastAt:t}),r[e].count++,t>r[e].lastAt&&(r[e].lastAt=t)};for(let e of t){let t=e.answers;if(t?.mistakes)for(let r of t.mistakes)s(r.type||"general",e.submittedAt)}for(let e of t){let t=e.questionResults;if(Array.isArray(t))for(let r of t){if(r.correct)continue;let t=r.selectedAnswer?`Q:${r.questionId}: chose ${String(r.selectedAnswer).slice(0,40)}`:`Q:${r.questionId}: incorrect`;s(t,e.submittedAt)}}for(let t of(await i.drizzleDb.select().from(o.quizAttempt).where((0,a.and)((0,a.eq)(o.quizAttempt.studentId,e),(0,a.isNotNull)(o.quizAttempt.questionResults))).orderBy((0,n.desc)(o.quizAttempt.completedAt)).limit(50))){let e=t.questionResults;if(Array.isArray(e))for(let r of e){if(r.correct)continue;let e=r.selectedAnswer?`Q:${r.questionId}: chose ${String(r.selectedAnswer).slice(0,40)}`:`Q:${r.questionId}: incorrect`;s(e,t.completedAt)}}return Object.entries(r).map(([e,t])=>({type:e,frequency:t.count,lastOccurred:t.lastAt})).sort((e,t)=>t.frequency-e.frequency).slice(0,10)}async function m(e){let t=[],r=[],s=0,l=0;for(let c of(await i.drizzleDb.select().from(o.quizAttempt).where((0,a.and)((0,a.eq)(o.quizAttempt.studentId,e),(0,a.isNotNull)(o.quizAttempt.questionResults))).orderBy((0,n.desc)(o.quizAttempt.completedAt)).limit(50))){let e=c.questionResults;if(!Array.isArray(e)||0===e.length)continue;let a=e.map(e=>({sourceType:"quiz",sourceId:c.quizId,questionId:e.questionId,correct:e.correct??(void 0!==e.pointsEarned&&void 0!==e.pointsMax&&e.pointsEarned>=.7*e.pointsMax),pointsEarned:e.pointsEarned??0,pointsMax:e.pointsMax??100,selectedAnswer:e.selectedAnswer,completedAt:c.completedAt}));for(let e of a)l++,e.correct?s++:r.push(e.questionId);t.push({sourceType:"quiz",sourceId:c.quizId,completedAt:c.completedAt,questions:a})}for(let c of(await i.drizzleDb.select().from(o.taskSubmission).where((0,a.and)((0,a.eq)(o.taskSubmission.studentId,e),(0,a.isNotNull)(o.taskSubmission.questionResults))).orderBy((0,n.desc)(o.taskSubmission.submittedAt)).limit(50))){let e=c.questionResults;if(!Array.isArray(e)||0===e.length)continue;let a=e.map(e=>({sourceType:"task",sourceId:c.taskId,questionId:e.questionId,correct:e.correct??(void 0!==e.pointsEarned&&void 0!==e.pointsMax&&e.pointsEarned>=.7*e.pointsMax),pointsEarned:e.pointsEarned??0,pointsMax:e.pointsMax??100,selectedAnswer:e.selectedAnswer,completedAt:c.submittedAt}));for(let e of a)l++,e.correct?s++:r.push(e.questionId);t.push({sourceType:"task",sourceId:c.taskId,completedAt:c.submittedAt,questions:a})}return{bySource:t,weakQuestionIds:[...new Set(r)],totalCorrect:s,totalQuestions:l}}async function p(e,t){let r,s=await c(e,t),{strengths:l,weaknesses:m}=await u(e);if(t){let s=await i.drizzleDb.select({id:o.courseBatch.id}).from(o.courseBatch).where((0,a.eq)(o.courseBatch.curriculumId,t)),l=s.length>0?(await i.drizzleDb.select({id:o.generatedTask.id}).from(o.generatedTask).where((0,a.inArray)(o.generatedTask.batchId,s.map(e=>e.id)))).map(e=>e.id):[];r=l.length>0?await i.drizzleDb.select().from(o.taskSubmission).where((0,a.and)((0,a.eq)(o.taskSubmission.studentId,e),(0,a.inArray)(o.taskSubmission.taskId,l))).orderBy((0,n.desc)(o.taskSubmission.submittedAt)).limit(20):await i.drizzleDb.select().from(o.taskSubmission).where((0,a.eq)(o.taskSubmission.studentId,e)).orderBy((0,n.desc)(o.taskSubmission.submittedAt)).limit(20)}else r=await i.drizzleDb.select().from(o.taskSubmission).where((0,a.eq)(o.taskSubmission.studentId,e)).orderBy((0,n.desc)(o.taskSubmission.submittedAt)).limit(20);let p=r.map(e=>{let t=e.answers;return{taskId:e.taskId,score:e.score||0,timeSpent:e.timeSpent||0,attempts:e.attempts||1,completedAt:e.submittedAt,strengths:t?.strengthsDemonstrated||[],weaknesses:t?.areasForImprovement||[]}}),f=await d(e),g=function(e){if(e.length<3)return"normal";let t=e.reduce((e,t)=>e+t.timeSpent,0)/e.length,r=e.reduce((e,t)=>e+t.attempts,0)/e.length;return t<180&&r<1.5?"fast":t>600||r>2.5?"slow":"normal"}(p),h=s.averageScore>=80&&s.completionRate>=80&&s.engagementScore>=70?"advanced":s.averageScore<60||s.completionRate<50||s.engagementScore<40?"struggling":"intermediate",w=r.filter(e=>{let t=e.answers;return t?.taskType==="visual"}).length>r.length/2?"visual":"mixed";return{studentId:e,overallMetrics:s,subjectStrengths:l,subjectWeaknesses:m,learningStyle:w,pace:g,taskHistory:p,commonMistakes:f,performanceCluster:h}}async function f(e){let t=await i.drizzleDb.select({studentId:o.curriculumEnrollment.studentId}).from(o.curriculumEnrollment).where((0,a.eq)(o.curriculumEnrollment.curriculumId,e)),r=await Promise.all(t.map(async t=>{let[r]=await i.drizzleDb.select({name:o.profile.name}).from(o.profile).where((0,a.eq)(o.profile.userId,t.studentId)).limit(1);return{id:t.studentId,name:r?.name??"Unknown",performance:await p(t.studentId,e)}})),n={advanced:0,intermediate:0,struggling:0},s=0,l=[];for(let e of r)n[e.performance.performanceCluster]++,s+=e.performance.overallMetrics.averageScore,"struggling"===e.performance.performanceCluster&&l.push({id:e.id,name:e.name,reason:`Low performance: ${e.performance.overallMetrics.averageScore.toFixed(0)}% avg`});let c=r.sort((e,t)=>t.performance.overallMetrics.averageScore-e.performance.overallMetrics.averageScore).slice(0,5).map(e=>({id:e.id,name:e.name,score:e.performance.overallMetrics.averageScore}));return{totalStudents:t.length,averageScore:t.length>0?s/t.length:0,clusterDistribution:n,topStudents:c,studentsNeedingAttention:l}}async function g(e,t){let r=await p(e,t),[n]=await i.drizzleDb.select().from(o.studentPerformance).where((0,a.eq)(o.studentPerformance.studentId,e)).limit(1),s={studentId:e,cluster:r.performanceCluster,strengths:r.subjectStrengths,weaknesses:r.subjectWeaknesses,commonMistakes:r.commonMistakes.map(e=>({type:e.type,frequency:e.frequency})),learningStyle:r.learningStyle??"mixed",averageScore:r.overallMetrics.averageScore,completionRate:r.overallMetrics.completionRate,engagementScore:r.overallMetrics.engagementScore,attendanceRate:r.overallMetrics.attendanceRate,participationRate:r.overallMetrics.participationRate,pace:r.pace};n?await i.drizzleDb.update(o.studentPerformance).set({cluster:s.cluster,strengths:s.strengths,weaknesses:s.weaknesses,commonMistakes:s.commonMistakes,learningStyle:s.learningStyle,averageScore:s.averageScore,completionRate:s.completionRate,engagementScore:s.engagementScore,attendanceRate:s.attendanceRate,participationRate:s.participationRate,pace:s.pace,curriculumId:t??null}).where((0,a.eq)(o.studentPerformance.id,n.id)):await i.drizzleDb.insert(o.studentPerformance).values({id:crypto.randomUUID(),studentId:s.studentId,curriculumId:t??null,cluster:s.cluster,strengths:s.strengths,weaknesses:s.weaknesses,commonMistakes:s.commonMistakes,learningStyle:s.learningStyle,averageScore:s.averageScore,completionRate:s.completionRate,engagementScore:s.engagementScore,attendanceRate:s.attendanceRate,participationRate:s.participationRate,pace:s.pace,taskHistory:[],skillBreakdown:{},recommendedPeers:[],updatedAt:new Date})}[i]=l.then?(await l)():l,e.s(["getClassPerformanceSummary",()=>f,"getQuestionLevelBreakdown",()=>m,"getStudentPerformance",()=>p,"updateStudentPerformanceRecord",()=>g]),r()}catch(e){r(e)}},!1),849234,e=>e.a(async(t,r)=>{try{var a=e.i(620971),n=e.i(384030),s=e.i(908286),i=e.i(891820),o=t([n,i]);[n,i]=o.then?(await o)():o;let l=(0,n.withAuth)(async(e,t,r)=>{let n=await (0,s.getParamAsync)(r?.params,"classId");if(!n)return a.NextResponse.json({error:"Class ID required"},{status:400});let o=await (0,i.getClassPerformanceSummary)(n),l=o.totalStudents;o.averageScore;let c=[{range:"0-59",count:Math.round(.1*l)},{range:"60-69",count:Math.round(.15*l)},{range:"70-79",count:Math.round(.3*l)},{range:"80-89",count:Math.round(.3*l)},{range:"90-100",count:Math.round(.15*l)}],u=[{name:"优秀",count:o.clusterDistribution.advanced,color:"#22c55e"},{name:"中等",count:o.clusterDistribution.intermediate,color:"#eab308"},{name:"需帮助",count:o.clusterDistribution.struggling,color:"#ef4444"}];return a.NextResponse.json({success:!0,data:{classInfo:{id:n,totalStudents:o.totalStudents,averageScore:o.averageScore},charts:{scoreDistribution:c,clusterDistribution:u},topStudents:o.topStudents,studentsNeedingAttention:o.studentsNeedingAttention,summary:{totalStudents:o.totalStudents,averageScore:o.averageScore,advancedCount:o.clusterDistribution.advanced,intermediateCount:o.clusterDistribution.intermediate,strugglingCount:o.clusterDistribution.struggling}}})},{role:"TUTOR"});e.s(["GET",0,l]),r()}catch(e){r(e)}},!1),945765,e=>e.a(async(t,r)=>{try{var a=e.i(78315),n=e.i(586961),s=e.i(196657),i=e.i(899733),o=e.i(233979),l=e.i(631683),c=e.i(840960),u=e.i(711373),d=e.i(699699),m=e.i(521140),p=e.i(205260),f=e.i(500249),g=e.i(431740),h=e.i(82608),w=e.i(635207),S=e.i(193695);e.i(708038);var v=e.i(447430),A=e.i(849234),R=t([A]);[A]=R.then?(await R)():R;let I=new a.AppRouteRouteModule({definition:{kind:n.RouteKind.APP_ROUTE,page:"/api/reports/class/[classId]/route",pathname:"/api/reports/class/[classId]",filename:"route",bundlePath:""},distDir:".next",relativeProjectDir:"",resolvedPagePath:"[project]/ADK_WORKSPACE/TutorMekimi/tutorme-app/src/app/api/reports/class/[classId]/route.ts",nextConfigOutput:"",userland:A}),{workAsyncStorage:q,workUnitAsyncStorage:k,serverHooks:z}=I;function y(){return(0,s.patchFetch)({workAsyncStorage:q,workUnitAsyncStorage:k})}async function b(e,t,r){I.isDev&&(0,i.addRequestMeta)(e,"devRequestTimingInternalsEnd",process.hrtime.bigint());let a="/api/reports/class/[classId]/route";a=a.replace(/\/index$/,"")||"/";let s=await I.prepare(e,t,{srcPage:a,multiZoneDraftMode:!1});if(!s)return t.statusCode=400,t.end("Bad Request"),null==r.waitUntil||r.waitUntil.call(r,Promise.resolve()),null;let{buildId:A,params:R,nextConfig:y,parsedUrl:b,isDraftMode:q,prerenderManifest:k,routerServerContext:z,isOnDemandRevalidate:E,revalidateOnlyGenerated:M,resolvedPathname:C,clientReferenceManifest:P,serverActionsManifest:x}=s,D=(0,c.normalizeAppPath)(a),_=!!(k.dynamicRoutes[D]||k.routes[C]),T=async()=>((null==z?void 0:z.render404)?await z.render404(e,t,b,!1):t.end("This page could not be found"),null);if(_&&!q){let e=!!k.routes[C],t=k.dynamicRoutes[D];if(t&&!1===t.fallback&&!e){if(y.experimental.adapterPath)return await T();throw new S.NoFallbackError}}let N=null;!_||I.isDev||q||(N=C,N="/index"===N?"/":N);let O=!0===I.isDev||!_,j=_&&!O;x&&P&&(0,l.setManifestsSingleton)({page:a,clientReferenceManifest:P,serverActionsManifest:x});let U=e.method||"GET",H=(0,o.getTracer)(),B=H.getActiveScopeSpan(),$={params:R,prerenderManifest:k,renderOpts:{experimental:{authInterrupts:!!y.experimental.authInterrupts},cacheComponents:!!y.cacheComponents,supportsDynamicResponse:O,incrementalCache:(0,i.getRequestMeta)(e,"incrementalCache"),cacheLifeProfiles:y.cacheLife,waitUntil:r.waitUntil,onClose:e=>{t.on("close",e)},onAfterTaskError:void 0,onInstrumentationRequestError:(t,r,a,n)=>I.onRequestError(e,t,a,n,z)},sharedContext:{buildId:A}},K=new u.NodeNextRequest(e),F=new u.NodeNextResponse(t),L=d.NextRequestAdapter.fromNodeNextRequest(K,(0,d.signalFromNodeResponse)(t));try{let s=async e=>I.handle(L,$).finally(()=>{if(!e)return;e.setAttributes({"http.status_code":t.statusCode,"next.rsc":!1});let r=H.getRootSpanAttributes();if(!r)return;if(r.get("next.span_type")!==m.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${r.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let n=r.get("next.route");if(n){let t=`${U} ${n}`;e.setAttributes({"next.route":n,"http.route":n,"next.span_name":t}),e.updateName(t)}else e.updateName(`${U} ${a}`)}),l=!!(0,i.getRequestMeta)(e,"minimalMode"),c=async i=>{var o,c;let u=async({previousCacheEntry:n})=>{try{if(!l&&E&&M&&!n)return t.statusCode=404,t.setHeader("x-nextjs-cache","REVALIDATED"),t.end("This page could not be found"),null;let a=await s(i);e.fetchMetrics=$.renderOpts.fetchMetrics;let o=$.renderOpts.pendingWaitUntil;o&&r.waitUntil&&(r.waitUntil(o),o=void 0);let c=$.renderOpts.collectedTags;if(!_)return await (0,f.sendResponse)(K,F,a,$.renderOpts.pendingWaitUntil),null;{let e=await a.blob(),t=(0,g.toNodeOutgoingHttpHeaders)(a.headers);c&&(t[w.NEXT_CACHE_TAGS_HEADER]=c),!t["content-type"]&&e.type&&(t["content-type"]=e.type);let r=void 0!==$.renderOpts.collectedRevalidate&&!($.renderOpts.collectedRevalidate>=w.INFINITE_CACHE)&&$.renderOpts.collectedRevalidate,n=void 0===$.renderOpts.collectedExpire||$.renderOpts.collectedExpire>=w.INFINITE_CACHE?void 0:$.renderOpts.collectedExpire;return{value:{kind:v.CachedRouteKind.APP_ROUTE,status:a.status,body:Buffer.from(await e.arrayBuffer()),headers:t},cacheControl:{revalidate:r,expire:n}}}}catch(t){throw(null==n?void 0:n.isStale)&&await I.onRequestError(e,t,{routerKind:"App Router",routePath:a,routeType:"route",revalidateReason:(0,p.getRevalidateReason)({isStaticGeneration:j,isOnDemandRevalidate:E})},!1,z),t}},d=await I.handleResponse({req:e,nextConfig:y,cacheKey:N,routeKind:n.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:k,isRoutePPREnabled:!1,isOnDemandRevalidate:E,revalidateOnlyGenerated:M,responseGenerator:u,waitUntil:r.waitUntil,isMinimalMode:l});if(!_)return null;if((null==d||null==(o=d.value)?void 0:o.kind)!==v.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==d||null==(c=d.value)?void 0:c.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});l||t.setHeader("x-nextjs-cache",E?"REVALIDATED":d.isMiss?"MISS":d.isStale?"STALE":"HIT"),q&&t.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let m=(0,g.fromNodeOutgoingHttpHeaders)(d.value.headers);return l&&_||m.delete(w.NEXT_CACHE_TAGS_HEADER),!d.cacheControl||t.getHeader("Cache-Control")||m.get("Cache-Control")||m.set("Cache-Control",(0,h.getCacheControlHeader)(d.cacheControl)),await (0,f.sendResponse)(K,F,new Response(d.value.body,{headers:m,status:d.value.status||200})),null};B?await c(B):await H.withPropagatedContext(e.headers,()=>H.trace(m.BaseServerSpan.handleRequest,{spanName:`${U} ${a}`,kind:o.SpanKind.SERVER,attributes:{"http.method":U,"http.target":e.url}},c))}catch(t){if(t instanceof S.NoFallbackError||await I.onRequestError(e,t,{routerKind:"App Router",routePath:D,routeType:"route",revalidateReason:(0,p.getRevalidateReason)({isStaticGeneration:j,isOnDemandRevalidate:E})},!1,z),_)throw t;return await (0,f.sendResponse)(K,F,new Response(null,{status:500})),null}}e.s(["handler",()=>b,"patchFetch",()=>y,"routeModule",()=>I,"serverHooks",()=>z,"workAsyncStorage",()=>q,"workUnitAsyncStorage",()=>k]),r()}catch(e){r(e)}},!1),412171,e=>{e.v(t=>Promise.all(["server/chunks/b1c00_TutorMekimi_tutorme-app_src_lib_security_suspicious-activity_ts_7865686f._.js"].map(t=>e.l(t))).then(()=>t(145830)))},443460,e=>{e.v(t=>Promise.all(["server/chunks/[externals]_ioredis_c74819ca._.js"].map(t=>e.l(t))).then(()=>t(693545)))},571363,e=>{e.v(t=>Promise.all(["server/chunks/ADK_WORKSPACE_TutorMekimi_tutorme-app_src_lib_security_api-key_ts_45091e81._.js"].map(t=>e.l(t))).then(()=>t(175922)))}];

//# debugId=f535f24a-08b4-7270-5e7c-cd0cb7a1fbdf
//# sourceMappingURL=%5Broot-of-the-server%5D__f1af7e8e._.js.map