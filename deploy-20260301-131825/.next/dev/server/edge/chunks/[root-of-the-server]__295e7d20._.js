(globalThis.TURBOPACK || (globalThis.TURBOPACK = [])).push(["chunks/[root-of-the-server]__295e7d20._.js",
"[externals]/node:buffer [external] (node:buffer, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("node:buffer", () => require("node:buffer"));

module.exports = mod;
}),
"[externals]/node:async_hooks [external] (node:async_hooks, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("node:async_hooks", () => require("node:async_hooks"));

module.exports = mod;
}),
"[project]/ADK_WORKSPACE/TutorMekimi/tutorme-app/messages/en.json (json)", ((__turbopack_context__) => {

__turbopack_context__.v({"errors":{"authentication_failed":"Authentication failed. Please check your credentials and try again.","user_not_found":"User not found. Please verify your email address.","insufficient_permissions":"You don't have permission to access this resource.","server_error":"An unexpected server error occurred. Please try again later.","validation_error":"Please check your input and try again.","rate_limit_exceeded":"Too many requests. Please wait and try again.","csrf_validation_failed":"Security validation failed. Please refresh the page and try again.","payment_failed":"Payment processing failed. Please try a different payment method.","invalid_course_format":"Invalid course format. Please contact support.","class_full":"This class is currently full. Please join the waitlist or try a different time.","parent_not_linked":"You need to be linked to a parent account to access this feature.","tutor_unavailable":"This tutor is currently unavailable. Please try a different time."},"forms":{"submit":"Submit","cancel":"Cancel","save":"Save Changes","edit":"Edit","delete":"Delete","confirm":"Confirm","back":"Back","next":"Next","create":"Create","update":"Update","required_field":"This field is required","invalid_email":"Please enter a valid email address","password_weak":"Password must be at least 8 characters with at least one uppercase letter, one lowercase letter, one number, and one special character","password_mismatch":"Passwords do not match","phone_invalid":"Please enter a valid phone number","age_verification":"I confirm I am 13 years or older","privacy_policy":"I agree to the Privacy Policy and Terms of Service"},"navigation":{"home":"Home","courses":"Courses","dashboard":"Dashboard","profile":"My Profile","settings":"Settings","parent_portal":"Parent Portal","ai_tutor":"AI Tutor","live_class":"Live Classes","study_groups":"Study Groups","gamification":"My Achievements","messages":"Messages","notifications":"Notifications","help":"Help & Support","logout":"Sign Out"},"pwa":{"install_title":"Install TutorMe","install_description":"Add TutorMe to your home screen for quick access and offline learning.","ios_install_description":"Install TutorMe on your device for the best experience.","install_button":"Install","install_dismiss":"Not now","install_got_it":"Got it","ios_how_to_install":"How to install","ios_step_1":"Tap the share button","ios_step_2":"Scroll and tap \"Add to Home Screen\"","ios_step_3":"Tap \"Add\" in the top right"},"accessibility":{"skip_to_main_content":"Skip to main content","skip_to_navigation":"Skip to navigation","open_in_new_tab":"Opens in new tab","external_link":"External link","loading":"Loading...","aria_label_navigation":"Primary navigation","aria_label_main":"Main content","aria_label_sidebar":"Sidebar navigation","aria_label_footer":"Footer navigation","aria_label_search":"Search courses and content","aria_label_profile_menu":"Profile menu","aria_label_notifications":"Notifications","screen_reader_focus_trap":"Dialog open, press Escape to close"}});}),
"[project]/ADK_WORKSPACE/TutorMekimi/tutorme-app/messages/zh-CN.json (json)", ((__turbopack_context__) => {

__turbopack_context__.v({"errors":{"authentication_failed":"Authentication failed. Please check your credentials and try again.","user_not_found":"User not found. Please verify your email address.","insufficient_permissions":"You don't have permission to access this resource.","server_error":"An unexpected server error occurred. Please try again later.","validation_error":"Please check your input and try again.","rate_limit_exceeded":"Too many requests. Please wait and try again.","csrf_validation_failed":"Security validation failed. Please refresh the page and try again.","payment_failed":"Payment processing failed. Please try a different payment method.","invalid_course_format":"Invalid course format. Please contact support.","class_full":"This class is currently full. Please join the waitlist or try a different time.","parent_not_linked":"You need to be linked to a parent account to access this feature.","tutor_unavailable":"This tutor is currently unavailable. Please try a different time."},"forms":{"submit":"Submit","cancel":"Cancel","save":"Save Changes","edit":"Edit","delete":"Delete","confirm":"Confirm","back":"Back","next":"Next","create":"Create","update":"Update","required_field":"This field is required","invalid_email":"Please enter a valid email address","password_weak":"Password must be at least 8 characters with at least one uppercase letter, one lowercase letter, one number, and one special character","password_mismatch":"Passwords do not match","phone_invalid":"Please enter a valid phone number","age_verification":"I confirm I am 13 years or older","privacy_policy":"I agree to the Privacy Policy and Terms of Service"},"navigation":{"home":"Home","courses":"Courses","dashboard":"Dashboard","profile":"My Profile","settings":"Settings","parent_portal":"Parent Portal","ai_tutor":"AI Tutor","live_class":"Live Classes","study_groups":"Study Groups","gamification":"My Achievements","messages":"Messages","notifications":"Notifications","help":"Help & Support","logout":"Sign Out"},"pwa":{"install_title":"安装 TutorMe","install_description":"将 TutorMe 添加到主屏幕，离线也能学习。","ios_install_description":"在您的设备上安装 TutorMe 以获得最佳体验。","install_button":"安装","install_dismiss":"暂不","install_got_it":"知道了","ios_how_to_install":"如何安装","ios_step_1":"点击分享按钮","ios_step_2":"向下滚动并点击「添加到主屏幕」","ios_step_3":"点击右上角「添加」"},"accessibility":{"skip_to_main_content":"Skip to main content","skip_to_navigation":"Skip to navigation","open_in_new_tab":"Opens in new tab","external_link":"External link","loading":"Loading...","aria_label_navigation":"Primary navigation","aria_label_main":"Main content","aria_label_sidebar":"Sidebar navigation","aria_label_footer":"Footer navigation","aria_label_search":"Search courses and content","aria_label_profile_menu":"Profile menu","aria_label_notifications":"Notifications","screen_reader_focus_trap":"Dialog open, press Escape to close"}});}),
"[project]/ADK_WORKSPACE/TutorMekimi/tutorme-app/src/i18n/request.ts [middleware-edge] (ecmascript)", ((__turbopack_context__) => {
"use strict";

__turbopack_context__.s([
    "default",
    ()=>__TURBOPACK__default__export__
]);
var __TURBOPACK__imported__module__$5b$project$5d2f$ADK_WORKSPACE$2f$TutorMekimi$2f$tutorme$2d$app$2f$node_modules$2f$next$2d$intl$2f$dist$2f$esm$2f$development$2f$server$2f$react$2d$server$2f$getRequestConfig$2e$js__$5b$middleware$2d$edge$5d$__$28$ecmascript$29$__$3c$export__default__as__getRequestConfig$3e$__ = __turbopack_context__.i("[project]/ADK_WORKSPACE/TutorMekimi/tutorme-app/node_modules/next-intl/dist/esm/development/server/react-server/getRequestConfig.js [middleware-edge] (ecmascript) <export default as getRequestConfig>");
var __TURBOPACK__imported__module__$5b$project$5d2f$ADK_WORKSPACE$2f$TutorMekimi$2f$tutorme$2d$app$2f$node_modules$2f$use$2d$intl$2f$dist$2f$esm$2f$development$2f$core$2e$js__$5b$middleware$2d$edge$5d$__$28$ecmascript$29$__$3c$locals$3e$__ = __turbopack_context__.i("[project]/ADK_WORKSPACE/TutorMekimi/tutorme-app/node_modules/use-intl/dist/esm/development/core.js [middleware-edge] (ecmascript) <locals>");
var __TURBOPACK__imported__module__$5b$project$5d2f$ADK_WORKSPACE$2f$TutorMekimi$2f$tutorme$2d$app$2f$src$2f$lib$2f$i18n$2f$config$2e$ts__$5b$middleware$2d$edge$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/ADK_WORKSPACE/TutorMekimi/tutorme-app/src/lib/i18n/config.ts [middleware-edge] (ecmascript)");
;
;
;
const __TURBOPACK__default__export__ = (0, __TURBOPACK__imported__module__$5b$project$5d2f$ADK_WORKSPACE$2f$TutorMekimi$2f$tutorme$2d$app$2f$node_modules$2f$next$2d$intl$2f$dist$2f$esm$2f$development$2f$server$2f$react$2d$server$2f$getRequestConfig$2e$js__$5b$middleware$2d$edge$5d$__$28$ecmascript$29$__$3c$export__default__as__getRequestConfig$3e$__["getRequestConfig"])(async ({ requestLocale })=>{
    // Typically corresponds to the `[locale]` segment
    const requested = await requestLocale;
    const locale = (0, __TURBOPACK__imported__module__$5b$project$5d2f$ADK_WORKSPACE$2f$TutorMekimi$2f$tutorme$2d$app$2f$node_modules$2f$use$2d$intl$2f$dist$2f$esm$2f$development$2f$core$2e$js__$5b$middleware$2d$edge$5d$__$28$ecmascript$29$__$3c$locals$3e$__["hasLocale"])(__TURBOPACK__imported__module__$5b$project$5d2f$ADK_WORKSPACE$2f$TutorMekimi$2f$tutorme$2d$app$2f$src$2f$lib$2f$i18n$2f$config$2e$ts__$5b$middleware$2d$edge$5d$__$28$ecmascript$29$__["routing"].locales, requested) ? requested : __TURBOPACK__imported__module__$5b$project$5d2f$ADK_WORKSPACE$2f$TutorMekimi$2f$tutorme$2d$app$2f$src$2f$lib$2f$i18n$2f$config$2e$ts__$5b$middleware$2d$edge$5d$__$28$ecmascript$29$__["routing"].defaultLocale;
    return {
        locale,
        messages: (await __turbopack_context__.f({
            "../../messages/en.json": {
                id: ()=>"[project]/ADK_WORKSPACE/TutorMekimi/tutorme-app/messages/en.json (json)",
                module: ()=>Promise.resolve().then(()=>__turbopack_context__.i("[project]/ADK_WORKSPACE/TutorMekimi/tutorme-app/messages/en.json (json)"))
            },
            "../../messages/zh-CN.json": {
                id: ()=>"[project]/ADK_WORKSPACE/TutorMekimi/tutorme-app/messages/zh-CN.json (json)",
                module: ()=>Promise.resolve().then(()=>__turbopack_context__.i("[project]/ADK_WORKSPACE/TutorMekimi/tutorme-app/messages/zh-CN.json (json)"))
            }
        }).import(`../../messages/${locale}.json`)).default
    };
});
}),
"[project]/ADK_WORKSPACE/TutorMekimi/tutorme-app/src/lib/i18n/config.ts [middleware-edge] (ecmascript)", ((__turbopack_context__) => {
"use strict";

__turbopack_context__.s([
    "DEFAULT_LOCALE",
    ()=>DEFAULT_LOCALE,
    "IntlLink",
    ()=>IntlLink,
    "LOCALES",
    ()=>LOCALES,
    "NAMESPACES",
    ()=>NAMESPACES,
    "detectLocale",
    ()=>detectLocale,
    "getLocaleInfo",
    ()=>getLocaleInfo,
    "getPathname",
    ()=>getPathname,
    "intlRedirect",
    ()=>intlRedirect,
    "routing",
    ()=>routing,
    "useIntlPathname",
    ()=>useIntlPathname,
    "useIntlRouter",
    ()=>useIntlRouter
]);
// Enterprise-grade internationalization with next-intl
var __TURBOPACK__imported__module__$5b$project$5d2f$ADK_WORKSPACE$2f$TutorMekimi$2f$tutorme$2d$app$2f$node_modules$2f$next$2d$intl$2f$dist$2f$esm$2f$development$2f$routing$2f$defineRouting$2e$js__$5b$middleware$2d$edge$5d$__$28$ecmascript$29$__$3c$export__default__as__defineRouting$3e$__ = __turbopack_context__.i("[project]/ADK_WORKSPACE/TutorMekimi/tutorme-app/node_modules/next-intl/dist/esm/development/routing/defineRouting.js [middleware-edge] (ecmascript) <export default as defineRouting>");
var __TURBOPACK__imported__module__$5b$project$5d2f$ADK_WORKSPACE$2f$TutorMekimi$2f$tutorme$2d$app$2f$node_modules$2f$next$2d$intl$2f$dist$2f$esm$2f$development$2f$navigation$2f$react$2d$server$2f$createNavigation$2e$js__$5b$middleware$2d$edge$5d$__$28$ecmascript$29$__$3c$export__default__as__createNavigation$3e$__ = __turbopack_context__.i("[project]/ADK_WORKSPACE/TutorMekimi/tutorme-app/node_modules/next-intl/dist/esm/development/navigation/react-server/createNavigation.js [middleware-edge] (ecmascript) <export default as createNavigation>");
;
;
const LOCALES = [
    "en",
    "zh-CN",
    "es",
    "fr",
    "de",
    "ja",
    "ko",
    "pt",
    "ru",
    "ar"
];
const DEFAULT_LOCALE = "en";
const routing = (0, __TURBOPACK__imported__module__$5b$project$5d2f$ADK_WORKSPACE$2f$TutorMekimi$2f$tutorme$2d$app$2f$node_modules$2f$next$2d$intl$2f$dist$2f$esm$2f$development$2f$routing$2f$defineRouting$2e$js__$5b$middleware$2d$edge$5d$__$28$ecmascript$29$__$3c$export__default__as__defineRouting$3e$__["defineRouting"])({
    locales: [
        ...LOCALES
    ],
    defaultLocale: DEFAULT_LOCALE,
    localePrefix: "as-needed",
    pathnames: {
        "/": "/",
        "/courses": "/courses",
        "/dashboard": "/dashboard",
        "/parent": "/parent",
        "/tutor": "/tutor",
        "/login": "/login",
        "/register": "/register",
        "/ai-tutor": "/ai-tutor",
        "/live-class": "/live-class"
    }
});
const { Link: IntlLink, redirect: intlRedirect, usePathname: useIntlPathname, useRouter: useIntlRouter, getPathname } = (0, __TURBOPACK__imported__module__$5b$project$5d2f$ADK_WORKSPACE$2f$TutorMekimi$2f$tutorme$2d$app$2f$node_modules$2f$next$2d$intl$2f$dist$2f$esm$2f$development$2f$navigation$2f$react$2d$server$2f$createNavigation$2e$js__$5b$middleware$2d$edge$5d$__$28$ecmascript$29$__$3c$export__default__as__createNavigation$3e$__["createNavigation"])(routing);
function detectLocale(requestHeaders) {
    const acceptLanguage = requestHeaders.get("accept-language");
    // Parse Accept-Language header
    if (acceptLanguage) {
        const preferredLanguages = acceptLanguage.split(",").map((lang)=>lang.trim().split(";")[0]).filter(Boolean);
        // Find best match for user's preferred language
        for (const language of preferredLanguages){
            const baseLanguage = language.split("-")[0];
            // Direct match
            const directMatch = LOCALES.find((locale)=>locale === language);
            if (directMatch) return directMatch;
            // Base language match
            const baseMatch = LOCALES.find((locale)=>locale === baseLanguage);
            if (baseMatch) return baseMatch;
        }
    }
    // Return default if no match found
    return DEFAULT_LOCALE;
}
const NAMESPACES = [
    "common",
    "navigation",
    "auth",
    "courses",
    "dashboard",
    "classroom",
    "parent",
    "tutor",
    "ai-tutor",
    "gamification",
    "payments",
    "notifications",
    "errors",
    "validation",
    "forms",
    "time",
    "accessibility"
];
function getLocaleInfo(locale) {
    const localeConfigs = {
        en: {
            direction: "ltr",
            language: "en",
            region: "en-US",
            currency: "USD",
            timezone: "America/New_York",
            dateFormat: "MM/DD/YYYY",
            numberFormat: "1,000.00",
            name: "English"
        },
        "zh-CN": {
            direction: "ltr",
            language: "zh",
            region: "zh-CN",
            currency: "CNY",
            timezone: "Asia/Shanghai",
            dateFormat: "YYYY/MM/DD",
            numberFormat: "1,0000.00",
            name: "中文 (简体)"
        },
        es: {
            direction: "ltr",
            language: "es",
            region: "es-ES",
            currency: "EUR",
            timezone: "Europe/Madrid",
            dateFormat: "DD/MM/YYYY",
            numberFormat: "1.000,00",
            name: "Español"
        },
        fr: {
            direction: "ltr",
            language: "fr",
            region: "fr-FR",
            currency: "EUR",
            timezone: "Europe/Paris",
            dateFormat: "DD/MM/YYYY",
            numberFormat: "1 000,00",
            name: "Français"
        },
        de: {
            direction: "ltr",
            language: "de",
            region: "de-DE",
            currency: "EUR",
            timezone: "Europe/Berlin",
            dateFormat: "DD.MM.YYYY",
            numberFormat: "1.000,00",
            name: "Deutsch"
        },
        ja: {
            direction: "ltr",
            language: "ja",
            region: "ja-JP",
            currency: "JPY",
            timezone: "Asia/Tokyo",
            dateFormat: "YYYY/MM/DD",
            numberFormat: "1,000",
            name: "日本語"
        },
        ko: {
            direction: "ltr",
            language: "ko",
            region: "ko-KR",
            currency: "KRW",
            timezone: "Asia/Seoul",
            dateFormat: "YYYY/MM/DD",
            numberFormat: "1,000",
            name: "한국어"
        },
        pt: {
            direction: "ltr",
            language: "pt",
            region: "pt-BR",
            currency: "BRL",
            timezone: "America/Sao_Paulo",
            dateFormat: "DD/MM/YYYY",
            numberFormat: "1.000,00",
            name: "Português"
        },
        ru: {
            direction: "ltr",
            language: "ru",
            region: "ru-RU",
            currency: "RUB",
            timezone: "Europe/Moscow",
            dateFormat: "DD.MM.YYYY",
            numberFormat: "1 000,00",
            name: "Русский"
        },
        ar: {
            direction: "rtl",
            language: "ar",
            region: "ar-SA",
            currency: "SAR",
            timezone: "Asia/Riyadh",
            dateFormat: "DD/MM/YYYY",
            numberFormat: "1,000.00",
            name: "العربية"
        }
    };
    return localeConfigs[locale] ?? localeConfigs[DEFAULT_LOCALE];
}
}),
"[project]/ADK_WORKSPACE/TutorMekimi/tutorme-app/src/i18n/routing.ts [middleware-edge] (ecmascript) <locals>", ((__turbopack_context__) => {
"use strict";

__turbopack_context__.s([]);
// Re-export routing config for next-intl middleware
var __TURBOPACK__imported__module__$5b$project$5d2f$ADK_WORKSPACE$2f$TutorMekimi$2f$tutorme$2d$app$2f$src$2f$lib$2f$i18n$2f$config$2e$ts__$5b$middleware$2d$edge$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/ADK_WORKSPACE/TutorMekimi/tutorme-app/src/lib/i18n/config.ts [middleware-edge] (ecmascript)");
;
}),
"[externals]/node:events [external] (node:events, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("node:events", () => require("node:events"));

module.exports = mod;
}),
"[externals]/node:assert [external] (node:assert, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("node:assert", () => require("node:assert"));

module.exports = mod;
}),
"[externals]/node:util [external] (node:util, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("node:util", () => require("node:util"));

module.exports = mod;
}),
"[project]/ [middleware-edge] (unsupported edge import 'fs', ecmascript)", ((__turbopack_context__, module, exports) => {

__turbopack_context__.n(__import_unsupported(`fs`));
}),
"[project]/ [middleware-edge] (unsupported edge import 'path', ecmascript)", ((__turbopack_context__, module, exports) => {

__turbopack_context__.n(__import_unsupported(`path`));
}),
"[project]/ [middleware-edge] (unsupported edge import 'stream', ecmascript)", ((__turbopack_context__, module, exports) => {

__turbopack_context__.n(__import_unsupported(`stream`));
}),
"[project]/ [middleware-edge] (unsupported edge import 'crypto', ecmascript)", ((__turbopack_context__, module, exports) => {

__turbopack_context__.n(__import_unsupported(`crypto`));
}),
"[project]/ [middleware-edge] (unsupported edge import 'dns', ecmascript)", ((__turbopack_context__, module, exports) => {

__turbopack_context__.n(__import_unsupported(`dns`));
}),
"[project]/ [middleware-edge] (unsupported edge import 'net', ecmascript)", ((__turbopack_context__, module, exports) => {

__turbopack_context__.n(__import_unsupported(`net`));
}),
"[project]/ [middleware-edge] (unsupported edge import 'tls', ecmascript)", ((__turbopack_context__, module, exports) => {

__turbopack_context__.n(__import_unsupported(`tls`));
}),
"[project]/ [middleware-edge] (unsupported edge import 'string_decoder', ecmascript)", ((__turbopack_context__, module, exports) => {

__turbopack_context__.n(__import_unsupported(`string_decoder`));
}),
"[project]/ADK_WORKSPACE/TutorMekimi/tutorme-app/src/lib/security/rate-limit.ts [middleware-edge] (ecmascript)", ((__turbopack_context__) => {
"use strict";

__turbopack_context__.s([
    "RATE_LIMIT_PRESETS",
    ()=>RATE_LIMIT_PRESETS,
    "checkRateLimit",
    ()=>checkRateLimit,
    "checkRateLimitPreset",
    ()=>checkRateLimitPreset,
    "getClientIdentifier",
    ()=>getClientIdentifier
]);
/**
 * Rate limiting for API routes.
 * Uses Redis when REDIS_URL is set (shared across instances); otherwise in-memory store.
 */ const DEFAULT_WINDOW_MS = 60 * 1000 // 1 minute
;
const DEFAULT_MAX = 100 // requests per window per key
;
const REDIS_PREFIX = 'ratelimit:';
const memoryStore = new Map();
function prune() {
    const now = Date.now();
    for (const [key, entry] of memoryStore.entries()){
        if (entry.resetAt < now) memoryStore.delete(key);
    }
}
function checkRateLimitMemory(key, options) {
    const windowMs = options.windowMs ?? DEFAULT_WINDOW_MS;
    const { max } = options;
    const now = Date.now();
    if (memoryStore.size > 10000) prune();
    let entry = memoryStore.get(key);
    if (!entry || entry.resetAt < now) {
        entry = {
            count: 0,
            resetAt: now + windowMs
        };
        memoryStore.set(key, entry);
    }
    entry.count += 1;
    const allowed = entry.count <= max;
    const remaining = Math.max(0, max - entry.count);
    return {
        allowed,
        remaining,
        resetAt: entry.resetAt
    };
}
let redisClient = null;
let redisInitPromise = null;
async function getRedisClient() {
    if (redisClient) return redisClient;
    if ("TURBOPACK compile-time falsy", 0) //TURBOPACK unreachable
    ;
     // browser
    const url = process.env.REDIS_URL;
    if (!url) return null;
    if (!redisInitPromise) {
        redisInitPromise = (async ()=>{
            try {
                const { Redis } = await Promise.resolve().then(()=>__turbopack_context__.i("[project]/ADK_WORKSPACE/TutorMekimi/tutorme-app/node_modules/ioredis/built/index.js [middleware-edge] (ecmascript)"));
                const client = new Redis(url, {
                    retryStrategy: (times)=>Math.min(times * 50, 2000),
                    maxRetriesPerRequest: 3
                });
                client.on('error', ()=>{});
                redisClient = client;
                return client;
            } catch  {
                return null;
            }
        })();
    }
    return redisInitPromise;
}
async function checkRateLimitRedis(key, options) {
    const redis = await getRedisClient();
    if (!redis) return checkRateLimitMemory(key, options);
    const windowMs = options.windowMs ?? DEFAULT_WINDOW_MS;
    const { max } = options;
    const now = Date.now();
    const fullKey = REDIS_PREFIX + key;
    const ttlSeconds = Math.ceil(windowMs / 1000);
    try {
        // Atomic Lua: INCR + EXPIRE (when count=1) in single round-trip - no race conditions
        const result = await redis.eval(`local c=redis.call('INCR',KEYS[1]) if c==1 then redis.call('EXPIRE',KEYS[1],ARGV[1]) end return {c,redis.call('PTTL',KEYS[1])}`, 1, fullKey, ttlSeconds);
        const [newCount, pttl] = result;
        const resetAt = pttl > 0 ? now + pttl : now + windowMs;
        const allowed = newCount <= max;
        const remaining = Math.max(0, max - newCount);
        return {
            allowed,
            remaining,
            resetAt
        };
    } catch  {
        return checkRateLimitMemory(key, options);
    }
}
async function checkRateLimit(key, maxOrOptions = DEFAULT_MAX) {
    const options = typeof maxOrOptions === 'number' ? {
        max: maxOrOptions,
        windowMs: DEFAULT_WINDOW_MS
    } : {
        windowMs: DEFAULT_WINDOW_MS,
        ...maxOrOptions
    };
    if (process.env.REDIS_URL) {
        return checkRateLimitRedis(key, options);
    }
    return checkRateLimitMemory(key, options);
}
const RATE_LIMIT_PRESETS = {
    /** Login: 10 attempts per 15 minutes per IP */ login: {
        max: 10,
        windowMs: 15 * 60 * 1000
    },
    /** Signup/register: allow multi-step retries and multi-role onboarding in the same browser */ register: {
        max: 12,
        windowMs: 15 * 60 * 1000
    },
    /** Payment create: 20 per minute per IP */ paymentCreate: {
        max: 20,
        windowMs: 60 * 1000
    },
    /** Enroll (subject or curriculum): 30 per minute per IP */ enroll: {
        max: 30,
        windowMs: 60 * 1000
    },
    /** Class booking: 20 per minute per IP */ booking: {
        max: 20,
        windowMs: 60 * 1000
    },
    /** AI generation/chat: 12 per minute per client identifier */ aiGenerate: {
        max: 12,
        windowMs: 60 * 1000
    }
};
async function checkRateLimitPreset(req, preset) {
    const ip = getClientIdentifier(req);
    const key = `${preset}:${ip}`;
    const options = RATE_LIMIT_PRESETS[preset];
    return checkRateLimit(key, options);
}
function getClientIdentifier(req) {
    const trustProxy = process.env.TRUST_PROXY === 'true';
    const forwarded = req.headers.get('x-forwarded-for');
    const realIp = req.headers.get('x-real-ip');
    const cfIp = req.headers.get('cf-connecting-ip');
    const firstForwarded = forwarded?.split(',')[0]?.trim();
    const candidate = trustProxy ? firstForwarded || realIp || cfIp : realIp || cfIp;
    const ip = normalizeIp(candidate);
    if (ip !== 'unknown') return ip;
    // Fallback identifier when no reliable IP is available (prevents all unknown clients sharing one bucket).
    const ua = req.headers.get('user-agent') || 'unknown';
    const lang = req.headers.get('accept-language') || 'unknown';
    const fingerprint = simpleHash(`${ua}|${lang}`);
    return `unknown:${fingerprint}`;
}
function normalizeIp(ip) {
    if (!ip) return 'unknown';
    const trimmed = ip.trim();
    if (!trimmed) return 'unknown';
    if (trimmed === '::1') return '127.0.0.1';
    return trimmed;
}
function simpleHash(input) {
    let hash = 2166136261;
    for(let i = 0; i < input.length; i += 1){
        hash ^= input.charCodeAt(i);
        hash = Math.imul(hash, 16777619);
    }
    return (hash >>> 0).toString(16).padStart(8, '0');
}
}),
"[project]/ADK_WORKSPACE/TutorMekimi/tutorme-app/src/middleware.ts [middleware-edge] (ecmascript)", ((__turbopack_context__) => {
"use strict";

__turbopack_context__.s([
    "config",
    ()=>config,
    "default",
    ()=>__TURBOPACK__default__export__
]);
/**
 * Next.js Middleware
 * i18n: locale routing via next-intl. Security: rate limiting, headers. Auth: protects routes.
 */ var __TURBOPACK__imported__module__$5b$project$5d2f$ADK_WORKSPACE$2f$TutorMekimi$2f$tutorme$2d$app$2f$node_modules$2f$next$2d$intl$2f$dist$2f$esm$2f$development$2f$middleware$2f$middleware$2e$js__$5b$middleware$2d$edge$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/ADK_WORKSPACE/TutorMekimi/tutorme-app/node_modules/next-intl/dist/esm/development/middleware/middleware.js [middleware-edge] (ecmascript)");
var __TURBOPACK__imported__module__$5b$project$5d2f$ADK_WORKSPACE$2f$TutorMekimi$2f$tutorme$2d$app$2f$node_modules$2f$next$2d$auth$2f$middleware$2e$js__$5b$middleware$2d$edge$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/ADK_WORKSPACE/TutorMekimi/tutorme-app/node_modules/next-auth/middleware.js [middleware-edge] (ecmascript)");
var __TURBOPACK__imported__module__$5b$project$5d2f$ADK_WORKSPACE$2f$TutorMekimi$2f$tutorme$2d$app$2f$node_modules$2f$next$2f$dist$2f$esm$2f$api$2f$server$2e$js__$5b$middleware$2d$edge$5d$__$28$ecmascript$29$__$3c$locals$3e$__ = __turbopack_context__.i("[project]/ADK_WORKSPACE/TutorMekimi/tutorme-app/node_modules/next/dist/esm/api/server.js [middleware-edge] (ecmascript) <locals>");
var __TURBOPACK__imported__module__$5b$project$5d2f$ADK_WORKSPACE$2f$TutorMekimi$2f$tutorme$2d$app$2f$node_modules$2f$next$2f$dist$2f$esm$2f$server$2f$web$2f$exports$2f$index$2e$js__$5b$middleware$2d$edge$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/ADK_WORKSPACE/TutorMekimi/tutorme-app/node_modules/next/dist/esm/server/web/exports/index.js [middleware-edge] (ecmascript)");
var __TURBOPACK__imported__module__$5b$project$5d2f$ADK_WORKSPACE$2f$TutorMekimi$2f$tutorme$2d$app$2f$src$2f$i18n$2f$routing$2e$ts__$5b$middleware$2d$edge$5d$__$28$ecmascript$29$__$3c$locals$3e$__ = __turbopack_context__.i("[project]/ADK_WORKSPACE/TutorMekimi/tutorme-app/src/i18n/routing.ts [middleware-edge] (ecmascript) <locals>");
var __TURBOPACK__imported__module__$5b$project$5d2f$ADK_WORKSPACE$2f$TutorMekimi$2f$tutorme$2d$app$2f$src$2f$lib$2f$i18n$2f$config$2e$ts__$5b$middleware$2d$edge$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/ADK_WORKSPACE/TutorMekimi/tutorme-app/src/lib/i18n/config.ts [middleware-edge] (ecmascript)");
var __TURBOPACK__imported__module__$5b$project$5d2f$ADK_WORKSPACE$2f$TutorMekimi$2f$tutorme$2d$app$2f$src$2f$lib$2f$security$2f$rate$2d$limit$2e$ts__$5b$middleware$2d$edge$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/ADK_WORKSPACE/TutorMekimi/tutorme-app/src/lib/security/rate-limit.ts [middleware-edge] (ecmascript)");
;
;
;
;
;
const intlMiddleware = (0, __TURBOPACK__imported__module__$5b$project$5d2f$ADK_WORKSPACE$2f$TutorMekimi$2f$tutorme$2d$app$2f$node_modules$2f$next$2d$intl$2f$dist$2f$esm$2f$development$2f$middleware$2f$middleware$2e$js__$5b$middleware$2d$edge$5d$__$28$ecmascript$29$__["default"])(__TURBOPACK__imported__module__$5b$project$5d2f$ADK_WORKSPACE$2f$TutorMekimi$2f$tutorme$2d$app$2f$src$2f$lib$2f$i18n$2f$config$2e$ts__$5b$middleware$2d$edge$5d$__$28$ecmascript$29$__["routing"]);
const API_RATE_LIMIT_MAX = 100 // per minute per IP
;
const RATE_LIMIT_SKIP = [
    '/api/auth',
    '/api/health',
    '/api/payments/webhooks'
];
/**
 * Build a strict Content-Security-Policy.
 * Next.js requires 'unsafe-inline' and 'unsafe-eval' for script in dev/prod with current setup;
 * use nonces in future for stricter script-src.
 * @see docs/CSP_HARDENING.md for hardening steps and nonce/hash migration plan.
 */ function getCspHeader() {
    const directives = [
        "default-src 'self'",
        "script-src 'self' 'unsafe-inline' 'unsafe-eval'",
        "style-src 'self' 'unsafe-inline'",
        "img-src 'self' data: blob: https:",
        "font-src 'self' data:",
        "connect-src 'self' https: wss:",
        "frame-src 'self'",
        "frame-ancestors 'self'",
        "base-uri 'self'",
        "form-action 'self'",
        "object-src 'none'"
    ];
    if ("TURBOPACK compile-time falsy", 0) //TURBOPACK unreachable
    ;
    return directives.join('; ');
}
function addSecurityHeaders(res) {
    res.headers.set('X-Content-Type-Options', 'nosniff');
    res.headers.set('X-Frame-Options', 'SAMEORIGIN');
    res.headers.set('Referrer-Policy', 'strict-origin-when-cross-origin');
    res.headers.set('Content-Security-Policy', getCspHeader());
    return res;
}
function stripLocalePrefix(pathname) {
    const segments = pathname.split('/').filter(Boolean);
    const locale = segments[0];
    if (locale && __TURBOPACK__imported__module__$5b$project$5d2f$ADK_WORKSPACE$2f$TutorMekimi$2f$tutorme$2d$app$2f$src$2f$lib$2f$i18n$2f$config$2e$ts__$5b$middleware$2d$edge$5d$__$28$ecmascript$29$__["routing"].locales.includes(locale)) {
        if (segments.length === 1) return '/';
        return `/${segments.slice(1).join('/')}`;
    }
    return pathname;
}
const __TURBOPACK__default__export__ = (0, __TURBOPACK__imported__module__$5b$project$5d2f$ADK_WORKSPACE$2f$TutorMekimi$2f$tutorme$2d$app$2f$node_modules$2f$next$2d$auth$2f$middleware$2e$js__$5b$middleware$2d$edge$5d$__$28$ecmascript$29$__["withAuth"])(async function middleware(req) {
    const path = req.nextUrl.pathname;
    const normalizedPath = path.startsWith('/api') ? path : stripLocalePrefix(path);
    const token = req.nextauth.token;
    const method = req.method ?? 'GET';
    const handleMatch = normalizedPath.match(/^\/@([a-zA-Z0-9._]{3,30})$/);
    if (handleMatch) {
        const username = handleMatch[1].toLowerCase();
        return __TURBOPACK__imported__module__$5b$project$5d2f$ADK_WORKSPACE$2f$TutorMekimi$2f$tutorme$2d$app$2f$node_modules$2f$next$2f$dist$2f$esm$2f$server$2f$web$2f$exports$2f$index$2e$js__$5b$middleware$2d$edge$5d$__$28$ecmascript$29$__["NextResponse"].redirect(new URL(`/${__TURBOPACK__imported__module__$5b$project$5d2f$ADK_WORKSPACE$2f$TutorMekimi$2f$tutorme$2d$app$2f$src$2f$lib$2f$i18n$2f$config$2e$ts__$5b$middleware$2d$edge$5d$__$28$ecmascript$29$__["routing"].defaultLocale}/u/${username}`, req.url));
    }
    // Stricter rate limit for login (POST to signin; NextAuth uses signin/credentials)
    const isSignin = (path === '/api/auth/signin' || path === '/api/auth/signin/credentials') && method === 'POST';
    if (isSignin) {
        try {
            const { allowed, resetAt } = await (0, __TURBOPACK__imported__module__$5b$project$5d2f$ADK_WORKSPACE$2f$TutorMekimi$2f$tutorme$2d$app$2f$src$2f$lib$2f$security$2f$rate$2d$limit$2e$ts__$5b$middleware$2d$edge$5d$__$28$ecmascript$29$__["checkRateLimitPreset"])(req, 'login');
            if (!allowed) {
                const retryAfter = Math.ceil((resetAt - Date.now()) / 1000);
                const res = new __TURBOPACK__imported__module__$5b$project$5d2f$ADK_WORKSPACE$2f$TutorMekimi$2f$tutorme$2d$app$2f$node_modules$2f$next$2f$dist$2f$esm$2f$server$2f$web$2f$exports$2f$index$2e$js__$5b$middleware$2d$edge$5d$__$28$ecmascript$29$__["NextResponse"](JSON.stringify({
                    error: 'Too many login attempts. Please try again later.'
                }), {
                    status: 429,
                    headers: {
                        'Content-Type': 'application/json',
                        'Retry-After': String(Math.max(1, retryAfter))
                    }
                });
                addSecurityHeaders(res);
                return res;
            }
        } catch (error) {
            console.error('[Middleware] Login rate-limit check failed:', error);
        }
    }
    // Rate limit API (except auth, health, webhooks)
    if (path.startsWith('/api') && !RATE_LIMIT_SKIP.some((p)=>path.startsWith(p))) {
        try {
            const key = (0, __TURBOPACK__imported__module__$5b$project$5d2f$ADK_WORKSPACE$2f$TutorMekimi$2f$tutorme$2d$app$2f$src$2f$lib$2f$security$2f$rate$2d$limit$2e$ts__$5b$middleware$2d$edge$5d$__$28$ecmascript$29$__["getClientIdentifier"])(req);
            const { allowed } = await (0, __TURBOPACK__imported__module__$5b$project$5d2f$ADK_WORKSPACE$2f$TutorMekimi$2f$tutorme$2d$app$2f$src$2f$lib$2f$security$2f$rate$2d$limit$2e$ts__$5b$middleware$2d$edge$5d$__$28$ecmascript$29$__["checkRateLimit"])(key, API_RATE_LIMIT_MAX);
            if (!allowed) {
                const res = new __TURBOPACK__imported__module__$5b$project$5d2f$ADK_WORKSPACE$2f$TutorMekimi$2f$tutorme$2d$app$2f$node_modules$2f$next$2f$dist$2f$esm$2f$server$2f$web$2f$exports$2f$index$2e$js__$5b$middleware$2d$edge$5d$__$28$ecmascript$29$__["NextResponse"](JSON.stringify({
                    error: 'Too many requests'
                }), {
                    status: 429,
                    headers: {
                        'Content-Type': 'application/json',
                        'Retry-After': '60'
                    }
                });
                addSecurityHeaders(res);
                return res;
            }
        } catch (error) {
            console.error('[Middleware] API rate-limit check failed:', error);
        }
    }
    // Allow access to onboarding pages
    if (normalizedPath.startsWith('/onboarding')) {
        const res = __TURBOPACK__imported__module__$5b$project$5d2f$ADK_WORKSPACE$2f$TutorMekimi$2f$tutorme$2d$app$2f$node_modules$2f$next$2f$dist$2f$esm$2f$server$2f$web$2f$exports$2f$index$2e$js__$5b$middleware$2d$edge$5d$__$28$ecmascript$29$__["NextResponse"].next();
        addSecurityHeaders(res);
        return res;
    }
    // Protect student routes
    if (normalizedPath.startsWith('/student') && token?.role !== 'STUDENT' && token?.role !== 'ADMIN') {
        return __TURBOPACK__imported__module__$5b$project$5d2f$ADK_WORKSPACE$2f$TutorMekimi$2f$tutorme$2d$app$2f$node_modules$2f$next$2f$dist$2f$esm$2f$server$2f$web$2f$exports$2f$index$2e$js__$5b$middleware$2d$edge$5d$__$28$ecmascript$29$__["NextResponse"].redirect(new URL('/login', req.url));
    }
    // Protect tutor routes
    if (normalizedPath.startsWith('/tutor') && token?.role !== 'TUTOR' && token?.role !== 'ADMIN') {
        return __TURBOPACK__imported__module__$5b$project$5d2f$ADK_WORKSPACE$2f$TutorMekimi$2f$tutorme$2d$app$2f$node_modules$2f$next$2f$dist$2f$esm$2f$server$2f$web$2f$exports$2f$index$2e$js__$5b$middleware$2d$edge$5d$__$28$ecmascript$29$__["NextResponse"].redirect(new URL('/login', req.url));
    }
    // Protect parent routes - only PARENT and ADMIN roles allowed
    if (normalizedPath.startsWith('/parent')) {
        const allowedRoles = [
            'PARENT',
            'ADMIN'
        ];
        if (!token?.role || !allowedRoles.includes(token.role)) {
            // Redirect to role-appropriate dashboard or login
            const redirectUrl = token?.role === 'STUDENT' ? new URL('/student', req.url) : token?.role === 'TUTOR' ? new URL('/tutor', req.url) : new URL('/login', req.url);
            return __TURBOPACK__imported__module__$5b$project$5d2f$ADK_WORKSPACE$2f$TutorMekimi$2f$tutorme$2d$app$2f$node_modules$2f$next$2f$dist$2f$esm$2f$server$2f$web$2f$exports$2f$index$2e$js__$5b$middleware$2d$edge$5d$__$28$ecmascript$29$__["NextResponse"].redirect(redirectUrl);
        }
    }
    // Enforce TOS acceptance
    if (token && !token.tosAccepted && !normalizedPath.startsWith('/student/agreement') && !path.startsWith('/api')) {
        return __TURBOPACK__imported__module__$5b$project$5d2f$ADK_WORKSPACE$2f$TutorMekimi$2f$tutorme$2d$app$2f$node_modules$2f$next$2f$dist$2f$esm$2f$server$2f$web$2f$exports$2f$index$2e$js__$5b$middleware$2d$edge$5d$__$28$ecmascript$29$__["NextResponse"].redirect(new URL('/student/agreement', req.url));
    }
    // Never run i18n middleware for API routes.
    if (path.startsWith('/api')) {
        const res = __TURBOPACK__imported__module__$5b$project$5d2f$ADK_WORKSPACE$2f$TutorMekimi$2f$tutorme$2d$app$2f$node_modules$2f$next$2f$dist$2f$esm$2f$server$2f$web$2f$exports$2f$index$2e$js__$5b$middleware$2d$edge$5d$__$28$ecmascript$29$__["NextResponse"].next();
        addSecurityHeaders(res);
        return res;
    }
    const res = intlMiddleware(req);
    addSecurityHeaders(res);
    return res;
}, {
    callbacks: {
        authorized ({ req, token }) {
            const pathname = req.nextUrl.pathname;
            const normalizedPath = pathname.startsWith('/api') ? pathname : stripLocalePrefix(pathname);
            const publicExactPaths = [
                '/login',
                '/register',
                '/'
            ];
            const publicPrefixPaths = [
                '/api/auth',
                '/api/health',
                '/api/csrf',
                '/api/public',
                '/onboarding',
                '/u/',
                '/admin',
                '/api/admin/',
                '/api/admin/auth'
            ];
            const isPublicExact = publicExactPaths.includes(normalizedPath);
            const isPublicPrefix = publicPrefixPaths.some((p)=>{
                if (p.endsWith('/')) return normalizedPath.startsWith(p);
                return normalizedPath === p || normalizedPath.startsWith(`${p}/`);
            });
            const isPublicPath = isPublicExact || isPublicPrefix;
            if (isPublicPath) return true;
            return token !== null;
        }
    }
});
const config = {
    matcher: [
        // Match all pathnames except api, _next, _vercel, static files (for next-intl)
        '/((?!api|_next|_vercel|.*\\..*).*)',
        // Explicit locale-prefixed paths
        '/(en|zh-CN|es|fr|de|ja|ko|pt|ru|ar)/:path*',
        // Root
        '/',
        // Auth and API (for rate limiting)
        '/api/auth/signin',
        '/api/auth/signin/credentials',
        '/api/((?!auth|health).*)'
    ]
};
}),
]);

//# sourceMappingURL=%5Broot-of-the-server%5D__295e7d20._.js.map