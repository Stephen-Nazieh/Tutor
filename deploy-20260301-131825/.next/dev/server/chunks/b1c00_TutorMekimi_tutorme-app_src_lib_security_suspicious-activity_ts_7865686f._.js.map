{
  "version": 3,
  "sources": [],
  "debugId": "471041c9-d70e-9972-35f0-55b71c1329d2",
  "sections": [
    {"offset": {"line": 7, "column": 0}, "map": {"version":3,"sources":["file:///Users/nazy/ADK_WORKSPACE/TutorMekimi/tutorme-app/src/lib/security/suspicious-activity.ts"],"sourcesContent":["/**\n * Suspicious activity: log failed logins and optionally alert when threshold exceeded.\n * Drizzle ORM.\n */\n\nimport { eq, and, gte, sql } from 'drizzle-orm'\nimport { drizzleDb } from '@/lib/db/drizzle'\nimport { securityEvent } from '@/lib/db/schema'\nimport crypto from 'crypto'\n\nconst FAILED_LOGIN_THRESHOLD = 5\nconst FAILED_LOGIN_WINDOW_MS = 15 * 60 * 1000 // 15 minutes\n\nexport async function logFailedLogin(ip: string | null, identifier?: string): Promise<void> {\n  try {\n    await drizzleDb.insert(securityEvent).values({\n      id: crypto.randomUUID(),\n      eventType: 'auth_failed',\n      ip: ip ?? undefined,\n      metadata: identifier ? { identifierHash: hashForLog(identifier) } : {},\n    })\n  } catch (e) {\n    console.error('Failed to log security event:', e)\n  }\n}\n\nfunction hashForLog(s: string): string {\n  return crypto.createHash('sha256').update(s).digest('hex').slice(0, 16)\n}\n\n/**\n * Returns true if the IP has exceeded failed login threshold (possible brute force).\n */\nexport async function isSuspiciousIp(ip: string): Promise<boolean> {\n  const since = new Date(Date.now() - FAILED_LOGIN_WINDOW_MS)\n  const [row] = await drizzleDb\n    .select({ count: sql<number>`count(*)::int` })\n    .from(securityEvent)\n    .where(\n      and(\n        eq(securityEvent.eventType, 'auth_failed'),\n        eq(securityEvent.ip, ip),\n        gte(securityEvent.createdAt, since)\n      )\n    )\n  return (row?.count ?? 0) >= FAILED_LOGIN_THRESHOLD\n}\n"],"names":[],"mappings":";;;;;;AAAA;;;CAGC,GAED;AAAA;AACA;AACA;AAAA;AACA;;;;;;;;;AAEA,MAAM,yBAAyB;AAC/B,MAAM,yBAAyB,KAAK,KAAK,KAAK,aAAa;;AAEpD,eAAe,eAAe,EAAiB,EAAE,UAAmB;IACzE,IAAI;QACF,MAAM,4LAAS,CAAC,MAAM,CAAC,yMAAa,EAAE,MAAM,CAAC;YAC3C,IAAI,gHAAM,CAAC,UAAU;YACrB,WAAW;YACX,IAAI,MAAM;YACV,UAAU,aAAa;gBAAE,gBAAgB,WAAW;YAAY,IAAI,CAAC;QACvE;IACF,EAAE,OAAO,GAAG;QACV,QAAQ,KAAK,CAAC,iCAAiC;IACjD;AACF;AAEA,SAAS,WAAW,CAAS;IAC3B,OAAO,gHAAM,CAAC,UAAU,CAAC,UAAU,MAAM,CAAC,GAAG,MAAM,CAAC,OAAO,KAAK,CAAC,GAAG;AACtE;AAKO,eAAe,eAAe,EAAU;IAC7C,MAAM,QAAQ,IAAI,KAAK,KAAK,GAAG,KAAK;IACpC,MAAM,CAAC,IAAI,GAAG,MAAM,4LAAS,CAC1B,MAAM,CAAC;QAAE,OAAO,uMAAG,AAAQ,CAAC,aAAa,CAAC;IAAC,GAC3C,IAAI,CAAC,yMAAa,EAClB,KAAK,CACJ,IAAA,6NAAG,EACD,IAAA,4NAAE,EAAC,yMAAa,CAAC,SAAS,EAAE,gBAC5B,IAAA,4NAAE,EAAC,yMAAa,CAAC,EAAE,EAAE,KACrB,IAAA,6NAAG,EAAC,yMAAa,CAAC,SAAS,EAAE;IAGnC,OAAO,CAAC,KAAK,SAAS,CAAC,KAAK;AAC9B"}}]
}