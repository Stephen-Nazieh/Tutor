{
  "version": 3,
  "sources": [],
  "debugId": "2d5f3348-e99e-7620-94d9-3bec2c49107d",
  "sections": [
    {"offset": {"line": 7, "column": 0}, "map": {"version":3,"sources":["file:///Users/nazy/ADK_WORKSPACE/TutorMekimi/tutorme-app/src/lib/security/api-key.ts"],"sourcesContent":["/**\n * API key management: create, verify, revoke.\n * Keys are hashed (SHA-256) before storage; plain key is returned only on create.\n * (Drizzle ORM)\n */\n\nimport crypto from 'crypto'\nimport { desc, eq } from 'drizzle-orm'\nimport { drizzleDb } from '@/lib/db/drizzle'\nimport { apiKey } from '@/lib/db/schema'\n\nconst HASH_ALGO = 'sha256'\nconst KEY_PREFIX = 'tm_'\nconst KEY_BYTES = 32\n\nfunction hashKey(plain: string): string {\n  return crypto.createHash(HASH_ALGO).update(plain).digest('hex')\n}\n\n/**\n * Generate a new API key. Returns { id, name, key } - store `key` securely; it cannot be retrieved again.\n */\nexport async function createApiKey(\n  name: string,\n  createdById?: string\n): Promise<{ id: string; name: string; key: string }> {\n  const raw = crypto.randomBytes(KEY_BYTES).toString('base64url')\n  const key = KEY_PREFIX + raw\n  const keyHash = hashKey(key)\n  const [record] = await drizzleDb\n    .insert(apiKey)\n    .values({ id: crypto.randomUUID(), name, keyHash, createdById })\n    .returning()\n  if (!record) throw new Error('Failed to create API key')\n  return { id: record.id, name: record.name, key }\n}\n\n/**\n * Verify Bearer token and return key record id if valid. Updates lastUsedAt.\n */\nexport async function verifyApiKey(bearerToken: string): Promise<{ id: string } | null> {\n  if (!bearerToken.startsWith(KEY_PREFIX)) return null\n  const keyHash = hashKey(bearerToken)\n  const [record] = await drizzleDb\n    .select()\n    .from(apiKey)\n    .where(eq(apiKey.keyHash, keyHash))\n    .limit(1)\n  if (!record) return null\n  await drizzleDb\n    .update(apiKey)\n    .set({ lastUsedAt: new Date() })\n    .where(eq(apiKey.id, record.id))\n  return { id: record.id }\n}\n\n/**\n * Revoke (delete) an API key by id.\n */\nexport async function revokeApiKey(id: string): Promise<boolean> {\n  const deleted = await drizzleDb\n    .delete(apiKey)\n    .where(eq(apiKey.id, id))\n    .returning({ id: apiKey.id })\n  return deleted.length > 0\n}\n\n/**\n * List API keys (without secret). Optional filter by createdById.\n */\nexport async function listApiKeys(createdById?: string) {\n  const base = drizzleDb\n    .select({\n      id: apiKey.id,\n      name: apiKey.name,\n      createdAt: apiKey.createdAt,\n      lastUsedAt: apiKey.lastUsedAt,\n    })\n    .from(apiKey)\n    .orderBy(desc(apiKey.createdAt))\n  return createdById\n    ? base.where(eq(apiKey.createdById, createdById))\n    : base\n}\n"],"names":[],"mappings":";;;;;;;;;;AAAA;;;;CAIC,GAED;AACA;AAAA;AACA;AACA;AAAA;;;;;;;;;AAEA,MAAM,YAAY;AAClB,MAAM,aAAa;AACnB,MAAM,YAAY;AAElB,SAAS,QAAQ,KAAa;IAC5B,OAAO,gHAAM,CAAC,UAAU,CAAC,WAAW,MAAM,CAAC,OAAO,MAAM,CAAC;AAC3D;AAKO,eAAe,aACpB,IAAY,EACZ,WAAoB;IAEpB,MAAM,MAAM,gHAAM,CAAC,WAAW,CAAC,WAAW,QAAQ,CAAC;IACnD,MAAM,MAAM,aAAa;IACzB,MAAM,UAAU,QAAQ;IACxB,MAAM,CAAC,OAAO,GAAG,MAAM,4LAAS,CAC7B,MAAM,CAAC,kMAAM,EACb,MAAM,CAAC;QAAE,IAAI,gHAAM,CAAC,UAAU;QAAI;QAAM;QAAS;IAAY,GAC7D,SAAS;IACZ,IAAI,CAAC,QAAQ,MAAM,IAAI,MAAM;IAC7B,OAAO;QAAE,IAAI,OAAO,EAAE;QAAE,MAAM,OAAO,IAAI;QAAE;IAAI;AACjD;AAKO,eAAe,aAAa,WAAmB;IACpD,IAAI,CAAC,YAAY,UAAU,CAAC,aAAa,OAAO;IAChD,MAAM,UAAU,QAAQ;IACxB,MAAM,CAAC,OAAO,GAAG,MAAM,4LAAS,CAC7B,MAAM,GACN,IAAI,CAAC,kMAAM,EACX,KAAK,CAAC,IAAA,4NAAE,EAAC,kMAAM,CAAC,OAAO,EAAE,UACzB,KAAK,CAAC;IACT,IAAI,CAAC,QAAQ,OAAO;IACpB,MAAM,4LAAS,CACZ,MAAM,CAAC,kMAAM,EACb,GAAG,CAAC;QAAE,YAAY,IAAI;IAAO,GAC7B,KAAK,CAAC,IAAA,4NAAE,EAAC,kMAAM,CAAC,EAAE,EAAE,OAAO,EAAE;IAChC,OAAO;QAAE,IAAI,OAAO,EAAE;IAAC;AACzB;AAKO,eAAe,aAAa,EAAU;IAC3C,MAAM,UAAU,MAAM,4LAAS,CAC5B,MAAM,CAAC,kMAAM,EACb,KAAK,CAAC,IAAA,4NAAE,EAAC,kMAAM,CAAC,EAAE,EAAE,KACpB,SAAS,CAAC;QAAE,IAAI,kMAAM,CAAC,EAAE;IAAC;IAC7B,OAAO,QAAQ,MAAM,GAAG;AAC1B;AAKO,eAAe,YAAY,WAAoB;IACpD,MAAM,OAAO,4LAAS,CACnB,MAAM,CAAC;QACN,IAAI,kMAAM,CAAC,EAAE;QACb,MAAM,kMAAM,CAAC,IAAI;QACjB,WAAW,kMAAM,CAAC,SAAS;QAC3B,YAAY,kMAAM,CAAC,UAAU;IAC/B,GACC,IAAI,CAAC,kMAAM,EACX,OAAO,CAAC,IAAA,0NAAI,EAAC,kMAAM,CAAC,SAAS;IAChC,OAAO,cACH,KAAK,KAAK,CAAC,IAAA,4NAAE,EAAC,kMAAM,CAAC,WAAW,EAAE,gBAClC;AACN"}}]
}