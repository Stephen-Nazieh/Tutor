;!function(){try { var e="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof global?global:"undefined"!=typeof window?window:"undefined"!=typeof self?self:{},n=(new e.Error).stack;n&&((e._debugIds|| (e._debugIds={}))[n]="87d92a37-bd86-ff9f-2cdd-75124ede980e")}catch(e){}}();
module.exports=[329308,e=>e.a(async(t,i)=>{try{var s=e.i(254799),r=e.i(738597);e.i(688768);var a=e.i(257357),n=t([r]);async function o(e,t,i){try{await r.drizzleDb.insert(a.userActivityLog).values({id:s.default.randomUUID(),userId:e,action:t,metadata:i??{}})}catch(e){console.error("Failed to log activity:",e)}}[r]=n.then?(await n)():n,e.s(["logActivity",()=>o]),i()}catch(e){i(e)}},!1),505589,e=>{"use strict";e.s(["XP_LEVELS",0,{1:0,2:200,3:500,4:1e3,5:1800,6:3e3,7:4600,8:6600,9:9100,10:12100,11:15600,12:19600,13:24100,14:29100,15:34600,16:40600,17:47100,18:54100,19:61600,20:69600},"XP_REWARDS",0,{COMPLETE_MISSION:50,PERFECT_QUIZ:20,DAILY_LOGIN:10,STREAK_3_DAYS:50,STREAK_7_DAYS:150,STREAK_30_DAYS:500,SPEAKING_PRACTICE:30,AI_CONVERSATION:40,COMPLETE_LESSON:40,FIRST_MISSION:100}])},977762,e=>e.a(async(t,i)=>{try{var s=e.i(254799),r=e.i(909105),a=e.i(738597);e.i(688768);var n=e.i(257357),o=e.i(329308),l=e.i(505589),u=t([a,o]);async function d(e){let[t]=await a.drizzleDb.select().from(n.userGamification).where((0,r.eq)(n.userGamification.userId,e)).limit(1);if(t)return t;let[i]=await a.drizzleDb.insert(n.userGamification).values({id:s.default.randomUUID(),userId:e,level:1,xp:0,streakDays:0,longestStreak:0,totalStudyMinutes:0,grammarScore:0,vocabularyScore:0,speakingScore:0,listeningScore:0,confidenceScore:0,fluencyScore:0,unlockedWorlds:[]}).returning();if(!i)throw Error("Failed to create user gamification");return i}async function c(e,t,i,s){let u=await d(e),c=u.xp+t,m=function(e){let t=1;for(let i=1;i<=20;i++)if(e>=l.XP_LEVELS[i])t=i;else break;return t}(c),p=m>u.level,[y]=await a.drizzleDb.update(n.userGamification).set({xp:c,level:m}).where((0,r.eq)(n.userGamification.userId,e)).returning();if(!y)throw Error("Failed to update gamification");return await (0,o.logActivity)(e,"XP_EARNED",{amount:t,source:i,newTotal:c,leveledUp:p,...s}),{...y,xpEarned:t,leveledUp:p,previousLevel:u.level}}async function m(e){let t=await d(e),i=new Date;i.setHours(0,0,0,0);let s=t.lastActiveDate?new Date(t.lastActiveDate):null,u=t.streakDays,c=0,m=!1,p=!1;if(s){s.setHours(0,0,0,0);let e=Math.floor((i.getTime()-s.getTime())/864e5);1===e?(u+=1,m=!0,3===u?c=l.XP_REWARDS.STREAK_3_DAYS:7===u?c=l.XP_REWARDS.STREAK_7_DAYS:30===u&&(c=l.XP_REWARDS.STREAK_30_DAYS)):0===e?m=!0:(p=!0,u=1)}else u=1;let y=Math.max(t.longestStreak,u),[f]=await a.drizzleDb.update(n.userGamification).set({streakDays:u,longestStreak:y,lastActiveDate:i}).where((0,r.eq)(n.userGamification.userId,e)).returning();if(!f)throw Error("Failed to update streak");return await (0,o.logActivity)(e,p?"STREAK_BROKEN":"STREAK_UPDATED",{streakDays:u,previousStreak:t.streakDays,streakBroken:p,streakContinued:m}),{...f,streakBonus:c,streakContinued:m,streakBroken:p}}async function p(e){let t=await d(e),i=new Date;i.setHours(0,0,0,0);let s=t.lastActiveDate?new Date(t.lastActiveDate):null;if(!s||s.getTime()!==i.getTime()){let t=await m(e),i=await c(e,l.XP_REWARDS.DAILY_LOGIN,"daily_login");return{firstLoginToday:!0,xpEarned:i.xpEarned+t.streakBonus,streakBonus:t.streakBonus,streakDays:t.streakDays,leveledUp:i.leveledUp}}return{firstLoginToday:!1,streakDays:t.streakDays}}async function y(e,t){let i=await d(e),s=(e,t)=>void 0===t?e:Math.round(.7*e+.3*t),[l]=await a.drizzleDb.update(n.userGamification).set({grammarScore:s(i.grammarScore,t.grammar),vocabularyScore:s(i.vocabularyScore,t.vocabulary),speakingScore:s(i.speakingScore,t.speaking),listeningScore:s(i.listeningScore,t.listening),confidenceScore:s(i.confidenceScore,t.confidence),fluencyScore:s(i.fluencyScore,t.fluency)}).where((0,r.eq)(n.userGamification.userId,e)).returning();if(!l)throw Error("Failed to update skill scores");return t.confidence&&t.confidence>i.confidenceScore+5&&await (0,o.logActivity)(e,"CONFIDENCE_MILESTONE",{previousScore:i.confidenceScore,newScore:l.confidenceScore,delta:l.confidenceScore-i.confidenceScore}),l}async function f(e){var t,i,s;let r,a,n=await d(e),o=(t=n.level,l.XP_LEVELS[t+1]||2*l.XP_LEVELS[20]),u=l.XP_LEVELS[n.level],c=(i=n.xp,s=n.level,r=l.XP_LEVELS[s],a=l.XP_LEVELS[s+1]||2*l.XP_LEVELS[20],Math.min(100,Math.round((i-r)/(a-r)*100)));return{level:n.level,xp:n.xp,nextLevelXp:o,currentLevelXp:u,progress:c,xpToNextLevel:o-n.xp,streakDays:n.streakDays,longestStreak:n.longestStreak,skills:{grammar:n.grammarScore,vocabulary:n.vocabularyScore,speaking:n.speakingScore,listening:n.listeningScore,confidence:n.confidenceScore,fluency:n.fluencyScore},unlockedWorlds:n.unlockedWorlds}}async function D(e,t){return(await d(e)).level>=t}[a,o]=u.then?(await u)():u,e.s(["awardXp",()=>c,"canAccessWorld",()=>D,"checkDailyLogin",()=>p,"getGamificationSummary",()=>f,"getOrCreateGamification",()=>d,"updateSkillScores",()=>y]),i()}catch(e){i(e)}},!1),933388,e=>e.a(async(t,i)=>{try{var s=e.i(254799),r=e.i(909105),a=e.i(738597);e.i(688768);var n=e.i(257357),o=e.i(977762),l=e.i(329308),u=t([a,o,l]);[a,o,l]=u.then?(await u)():u;function d(e){let t=new Date(e);return t.setHours(0,0,0,0),t}function c(e){let t=new Date(e);return t.setHours(23,59,59,999),t}async function m(e){let t=d(new Date),i=await a.drizzleDb.select({id:n.userDailyQuest.id,userId:n.userDailyQuest.userId,missionId:n.userDailyQuest.missionId,date:n.userDailyQuest.date,completed:n.userDailyQuest.completed,mId:n.mission.id,mTitle:n.mission.title,mDescription:n.mission.description,mType:n.mission.type,mXpReward:n.mission.xpReward,mRequirement:n.mission.requirement,mIsActive:n.mission.isActive}).from(n.userDailyQuest).innerJoin(n.mission,(0,r.eq)(n.mission.id,n.userDailyQuest.missionId)).where((0,r.and)((0,r.eq)(n.userDailyQuest.userId,e),(0,r.gte)(n.userDailyQuest.date,t),(0,r.lte)(n.userDailyQuest.date,c(t))));if(i.length>0)return i.map(e=>({id:e.id,userId:e.userId,missionId:e.missionId,date:e.date,completed:e.completed,mission:{id:e.mId,title:e.mTitle,description:e.mDescription,type:e.mType,xpReward:e.mXpReward,requirement:e.mRequirement,isActive:e.mIsActive}}));let o=await a.drizzleDb.select().from(n.mission).where((0,r.and)((0,r.eq)(n.mission.type,"daily"),(0,r.eq)(n.mission.isActive,!0)));if(0===o.length)return[];let l=[...o].sort(()=>.5-Math.random()).slice(0,3),u=[];for(let i of l){let[r]=await a.drizzleDb.insert(n.userDailyQuest).values({id:s.default.randomUUID(),userId:e,missionId:i.id,date:t,completed:!1}).returning();r&&u.push({...r,mission:i})}return u}async function p(e){let t=d(new Date),i=await a.drizzleDb.select({id:n.userDailyQuest.id,userId:n.userDailyQuest.userId,missionId:n.userDailyQuest.missionId,date:n.userDailyQuest.date,completed:n.userDailyQuest.completed,mId:n.mission.id,mTitle:n.mission.title,mDescription:n.mission.description,mType:n.mission.type,mXpReward:n.mission.xpReward,mRequirement:n.mission.requirement,mIsActive:n.mission.isActive}).from(n.userDailyQuest).innerJoin(n.mission,(0,r.eq)(n.mission.id,n.userDailyQuest.missionId)).where((0,r.and)((0,r.eq)(n.userDailyQuest.userId,e),(0,r.gte)(n.userDailyQuest.date,t),(0,r.lte)(n.userDailyQuest.date,c(t))));return 0===i.length?m(e):i.map(e=>({id:e.id,userId:e.userId,missionId:e.missionId,date:e.date,completed:e.completed,mission:{id:e.mId,title:e.mTitle,description:e.mDescription,type:e.mType,xpReward:e.mXpReward,requirement:e.mRequirement,isActive:e.mIsActive}}))}async function y(e,t,i=1){let s=d(new Date),u=(await a.drizzleDb.select({id:n.userDailyQuest.id,completed:n.userDailyQuest.completed,mId:n.mission.id,mTitle:n.mission.title,mXpReward:n.mission.xpReward,mRequirement:n.mission.requirement}).from(n.userDailyQuest).innerJoin(n.mission,(0,r.eq)(n.mission.id,n.userDailyQuest.missionId)).where((0,r.and)((0,r.eq)(n.userDailyQuest.userId,e),(0,r.gte)(n.userDailyQuest.date,s),(0,r.lte)(n.userDailyQuest.date,c(s)),(0,r.eq)(n.userDailyQuest.completed,!1)))).find(e=>{var i;return((i=e.mRequirement)&&"object"==typeof i&&"questType"in i?i.questType:null)===t});if(!u)return null;let[m]=await a.drizzleDb.update(n.userDailyQuest).set({completed:!0}).where((0,r.eq)(n.userDailyQuest.id,u.id)).returning();return m?(await (0,o.awardXp)(e,u.mXpReward,"quest_complete",{questId:u.mId,questTitle:u.mTitle}),await (0,l.logActivity)(e,"QUEST_COMPLETE",{questId:u.mId,questTitle:u.mTitle,xpEarned:u.mXpReward}),{...m,mission:{id:u.mId,title:u.mTitle,xpReward:u.mXpReward,requirement:u.mRequirement}}):null}async function f(e){let t=d(new Date),i=await a.drizzleDb.select({id:n.userDailyQuest.id,userId:n.userDailyQuest.userId,missionId:n.userDailyQuest.missionId,date:n.userDailyQuest.date,completed:n.userDailyQuest.completed,mId:n.mission.id,mTitle:n.mission.title,mDescription:n.mission.description,mType:n.mission.type,mXpReward:n.mission.xpReward,mRequirement:n.mission.requirement,mIsActive:n.mission.isActive}).from(n.userDailyQuest).innerJoin(n.mission,(0,r.eq)(n.mission.id,n.userDailyQuest.missionId)).where((0,r.and)((0,r.eq)(n.userDailyQuest.userId,e),(0,r.gte)(n.userDailyQuest.date,t),(0,r.lte)(n.userDailyQuest.date,c(t)))),s=i.filter(e=>e.completed).length,o=i.length,l=i.filter(e=>e.completed).reduce((e,t)=>e+t.mXpReward,0),u=i.map(e=>({id:e.id,userId:e.userId,missionId:e.missionId,date:e.date,completed:e.completed,mission:{id:e.mId,title:e.mTitle,description:e.mDescription,type:e.mType,xpReward:e.mXpReward,requirement:e.mRequirement,isActive:e.mIsActive}}));return{completed:s,total:o,totalXp:l,allCompleted:o>0&&s===o,quests:u}}e.s(["getQuestSummary",()=>f,"getTodayQuests",()=>p,"updateQuestProgress",()=>y]),i()}catch(e){i(e)}},!1),691026,e=>e.a(async(t,i)=>{try{var s=e.i(620971),r=e.i(384030),a=e.i(933388),n=t([r,a]);[r,a]=n.then?(await n)():n;let o=(0,r.withAuth)(async(e,t)=>{let{searchParams:i}=new URL(e.url),r=i.get("type");if("summary"===r){let e=await (0,a.getQuestSummary)(t.user.id),i=e.quests.map(e=>({...e,quest:e.mission}));return s.NextResponse.json({success:!0,data:{...e,quests:i}})}let n=(await (0,a.getTodayQuests)(t.user.id)).map(e=>({...e,quest:e.mission,progress:+!!e.completed}));return s.NextResponse.json({success:!0,data:{quests:n}})},{role:"STUDENT"}),l=(0,r.withCsrf)((0,r.withAuth)(async(e,t)=>{let{questType:i,progress:r}=await e.json();if(!i)return s.NextResponse.json({error:"Missing questType"},{status:400});let n=await (0,a.updateQuestProgress)(t.user.id,i,r||1);return s.NextResponse.json({success:!0,data:n})},{role:"STUDENT"}));e.s(["GET",0,o,"POST",0,l]),i()}catch(e){i(e)}},!1),969462,e=>e.a(async(t,i)=>{try{var s=e.i(78315),r=e.i(586961),a=e.i(196657),n=e.i(899733),o=e.i(233979),l=e.i(631683),u=e.i(840960),d=e.i(711373),c=e.i(699699),m=e.i(521140),p=e.i(205260),y=e.i(500249),f=e.i(431740),D=e.i(82608),w=e.i(635207),R=e.i(193695);e.i(708038);var h=e.i(447430),v=e.i(691026),g=t([v]);[v]=g.then?(await g)():g;let I=new s.AppRouteRouteModule({definition:{kind:r.RouteKind.APP_ROUTE,page:"/api/gamification/quests/route",pathname:"/api/gamification/quests",filename:"route",bundlePath:""},distDir:".next",relativeProjectDir:"",resolvedPagePath:"[project]/ADK_WORKSPACE/TutorMekimi/tutorme-app/src/app/api/gamification/quests/route.ts",nextConfigOutput:"",userland:v}),{workAsyncStorage:A,workUnitAsyncStorage:_,serverHooks:T}=I;function E(){return(0,a.patchFetch)({workAsyncStorage:A,workUnitAsyncStorage:_})}async function S(e,t,i){I.isDev&&(0,n.addRequestMeta)(e,"devRequestTimingInternalsEnd",process.hrtime.bigint());let s="/api/gamification/quests/route";s=s.replace(/\/index$/,"")||"/";let a=await I.prepare(e,t,{srcPage:s,multiZoneDraftMode:!1});if(!a)return t.statusCode=400,t.end("Bad Request"),null==i.waitUntil||i.waitUntil.call(i,Promise.resolve()),null;let{buildId:v,params:g,nextConfig:E,parsedUrl:S,isDraftMode:A,prerenderManifest:_,routerServerContext:T,isOnDemandRevalidate:q,revalidateOnlyGenerated:x,resolvedPathname:k,clientReferenceManifest:P,serverActionsManifest:C}=a,Q=(0,u.normalizeAppPath)(s),b=!!(_.dynamicRoutes[Q]||_.routes[k]),N=async()=>((null==T?void 0:T.render404)?await T.render404(e,t,S,!1):t.end("This page could not be found"),null);if(b&&!A){let e=!!_.routes[k],t=_.dynamicRoutes[Q];if(t&&!1===t.fallback&&!e){if(E.experimental.adapterPath)return await N();throw new R.NoFallbackError}}let O=null;!b||I.isDev||A||(O=k,O="/index"===O?"/":O);let L=!0===I.isDev||!b,U=b&&!L;C&&P&&(0,l.setManifestsSingleton)({page:s,clientReferenceManifest:P,serverActionsManifest:C});let X=e.method||"GET",M=(0,o.getTracer)(),z=M.getActiveScopeSpan(),H={params:g,prerenderManifest:_,renderOpts:{experimental:{authInterrupts:!!E.experimental.authInterrupts},cacheComponents:!!E.cacheComponents,supportsDynamicResponse:L,incrementalCache:(0,n.getRequestMeta)(e,"incrementalCache"),cacheLifeProfiles:E.cacheLife,waitUntil:i.waitUntil,onClose:e=>{t.on("close",e)},onAfterTaskError:void 0,onInstrumentationRequestError:(t,i,s,r)=>I.onRequestError(e,t,s,r,T)},sharedContext:{buildId:v}},K=new d.NodeNextRequest(e),G=new d.NodeNextResponse(t),j=c.NextRequestAdapter.fromNodeNextRequest(K,(0,c.signalFromNodeResponse)(t));try{let a=async e=>I.handle(j,H).finally(()=>{if(!e)return;e.setAttributes({"http.status_code":t.statusCode,"next.rsc":!1});let i=M.getRootSpanAttributes();if(!i)return;if(i.get("next.span_type")!==m.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${i.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let r=i.get("next.route");if(r){let t=`${X} ${r}`;e.setAttributes({"next.route":r,"http.route":r,"next.span_name":t}),e.updateName(t)}else e.updateName(`${X} ${s}`)}),l=!!(0,n.getRequestMeta)(e,"minimalMode"),u=async n=>{var o,u;let d=async({previousCacheEntry:r})=>{try{if(!l&&q&&x&&!r)return t.statusCode=404,t.setHeader("x-nextjs-cache","REVALIDATED"),t.end("This page could not be found"),null;let s=await a(n);e.fetchMetrics=H.renderOpts.fetchMetrics;let o=H.renderOpts.pendingWaitUntil;o&&i.waitUntil&&(i.waitUntil(o),o=void 0);let u=H.renderOpts.collectedTags;if(!b)return await (0,y.sendResponse)(K,G,s,H.renderOpts.pendingWaitUntil),null;{let e=await s.blob(),t=(0,f.toNodeOutgoingHttpHeaders)(s.headers);u&&(t[w.NEXT_CACHE_TAGS_HEADER]=u),!t["content-type"]&&e.type&&(t["content-type"]=e.type);let i=void 0!==H.renderOpts.collectedRevalidate&&!(H.renderOpts.collectedRevalidate>=w.INFINITE_CACHE)&&H.renderOpts.collectedRevalidate,r=void 0===H.renderOpts.collectedExpire||H.renderOpts.collectedExpire>=w.INFINITE_CACHE?void 0:H.renderOpts.collectedExpire;return{value:{kind:h.CachedRouteKind.APP_ROUTE,status:s.status,body:Buffer.from(await e.arrayBuffer()),headers:t},cacheControl:{revalidate:i,expire:r}}}}catch(t){throw(null==r?void 0:r.isStale)&&await I.onRequestError(e,t,{routerKind:"App Router",routePath:s,routeType:"route",revalidateReason:(0,p.getRevalidateReason)({isStaticGeneration:U,isOnDemandRevalidate:q})},!1,T),t}},c=await I.handleResponse({req:e,nextConfig:E,cacheKey:O,routeKind:r.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:_,isRoutePPREnabled:!1,isOnDemandRevalidate:q,revalidateOnlyGenerated:x,responseGenerator:d,waitUntil:i.waitUntil,isMinimalMode:l});if(!b)return null;if((null==c||null==(o=c.value)?void 0:o.kind)!==h.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==c||null==(u=c.value)?void 0:u.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});l||t.setHeader("x-nextjs-cache",q?"REVALIDATED":c.isMiss?"MISS":c.isStale?"STALE":"HIT"),A&&t.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let m=(0,f.fromNodeOutgoingHttpHeaders)(c.value.headers);return l&&b||m.delete(w.NEXT_CACHE_TAGS_HEADER),!c.cacheControl||t.getHeader("Cache-Control")||m.get("Cache-Control")||m.set("Cache-Control",(0,D.getCacheControlHeader)(c.cacheControl)),await (0,y.sendResponse)(K,G,new Response(c.value.body,{headers:m,status:c.value.status||200})),null};z?await u(z):await M.withPropagatedContext(e.headers,()=>M.trace(m.BaseServerSpan.handleRequest,{spanName:`${X} ${s}`,kind:o.SpanKind.SERVER,attributes:{"http.method":X,"http.target":e.url}},u))}catch(t){if(t instanceof R.NoFallbackError||await I.onRequestError(e,t,{routerKind:"App Router",routePath:Q,routeType:"route",revalidateReason:(0,p.getRevalidateReason)({isStaticGeneration:U,isOnDemandRevalidate:q})},!1,T),b)throw t;return await (0,y.sendResponse)(K,G,new Response(null,{status:500})),null}}e.s(["handler",()=>S,"patchFetch",()=>E,"routeModule",()=>I,"serverHooks",()=>T,"workAsyncStorage",()=>A,"workUnitAsyncStorage",()=>_]),i()}catch(e){i(e)}},!1),412171,e=>{e.v(t=>Promise.all(["server/chunks/b1c00_TutorMekimi_tutorme-app_src_lib_security_suspicious-activity_ts_7865686f._.js"].map(t=>e.l(t))).then(()=>t(145830)))},443460,e=>{e.v(t=>Promise.all(["server/chunks/[externals]_ioredis_c74819ca._.js"].map(t=>e.l(t))).then(()=>t(693545)))},571363,e=>{e.v(t=>Promise.all(["server/chunks/ADK_WORKSPACE_TutorMekimi_tutorme-app_src_lib_security_api-key_ts_45091e81._.js"].map(t=>e.l(t))).then(()=>t(175922)))}];

//# debugId=87d92a37-bd86-ff9f-2cdd-75124ede980e
//# sourceMappingURL=%5Broot-of-the-server%5D__fe6d165a._.js.map