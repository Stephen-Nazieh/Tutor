;!function(){try { var e="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof global?global:"undefined"!=typeof window?window:"undefined"!=typeof self?self:{},n=(new e.Error).stack;n&&((e._debugIds|| (e._debugIds={}))[n]="c1829949-7b1f-f7db-3b92-50ea76579375")}catch(e){}}();
module.exports=[902157,(e,t,r)=>{t.exports=e.x("node:fs",()=>require("node:fs"))},750227,(e,t,r)=>{t.exports=e.x("node:path",()=>require("node:path"))},450869,e=>{"use strict";let t="tutorme:query:",r=null,a=null,n=!1,s=!(void 0!==globalThis.EdgeRuntime||"u">typeof process&&0);function i(){return s?(a||(a=new Map),a):null}async function o(){if(!s)return null;if(n)return r;try{let t=process.env.REDIS_URL;if(!t)return console.log("[DB] Redis URL not configured, using in-memory cache"),n=!0,null;let{Redis:a}=await e.A(443460);return(r=new a(t,{retryStrategy:e=>Math.min(50*e,2e3),maxRetriesPerRequest:3})).on("error",e=>{console.error("[Redis] Connection error:",e),r=null}),console.log("[DB] Redis cache initialized"),n=!0,r}catch(e){return console.warn("[DB] Failed to initialize Redis, using in-memory cache"),n=!0,null}}if(s)try{let{drizzleDb:t}=e.r(738597);console.log("[DB] Drizzle client (default db) initialized")}catch(e){console.error("[DB] Failed to initialize Drizzle:",e)}e.s(["cache",0,{ensureRedis:async()=>s?(n||await o(),r):null,async get(e){if(!s)return null;let r=t+e,a=await this.ensureRedis();if(a)try{let e=await a.get(r);if(e)return JSON.parse(e)}catch(e){console.error("[Cache] Redis get error:",e)}let n=i();if(!n)return null;let o=n.get(r);return o&&o.expires>Date.now()?o.data:(n.delete(r),null)},async set(e,r,a=60){if(!s)return;let n=t+e,o=await this.ensureRedis();if(o)try{await o.setex(n,a,JSON.stringify(r));return}catch(e){console.error("[Cache] Redis set error:",e)}let l=i();l&&l.set(n,{data:r,expires:Date.now()+1e3*a})},async delete(e){if(!s)return;let r=t+e,a=await this.ensureRedis();if(a)try{await a.del(r)}catch(e){console.error("[Cache] Redis del error:",e)}let n=i();n&&n.delete(r)},async clear(){if(!s)return;let e=await this.ensureRedis();if(e)try{let r=await e.keys(t+"*");r.length>0&&await e.del(...r)}catch(e){console.error("[Cache] Redis clear error:",e)}let r=i();r&&r.clear()},async getOrSet(e,t,r=60){let a=await this.get(e);if(null!==a)return a;let n=await t();return await this.set(e,n,r),n},async invalidatePattern(e){if(!s)return;let r=await this.ensureRedis();if(r)try{let a=await r.keys(t+e);a.length>0&&await r.del(...a)}catch(e){console.error("[Cache] Pattern invalidation error:",e)}let a=i();if(a){let r=new RegExp(t+e.replace("*",".*"));for(let e of a.keys())r.test(e)&&a.delete(e)}}}])},828734,(e,t,r)=>{t.exports=e.x("@prisma/client-38ad48cf7901491a",()=>require("@prisma/client-38ad48cf7901491a"))},184714,e=>{"use strict";let t;if(void 0===globalThis.EdgeRuntime)try{let{PrismaClient:r}=e.r(828734),a=globalThis;t=a.__prismaLegacy?a.__prismaLegacy:new r({log:["error"]})}catch{t=null}else t=null;let r=t;e.s(["prismaLegacyClient",0,r])},621557,e=>e.a(async(t,r)=>{try{var a=e.i(909105),n=e.i(738597),s=e.i(184714);e.i(688768);var i=e.i(257357),o=e.i(748846),l=t([n]);function u(e,t){let r=`作为一位专业的教育AI助手，请为${e.subject}科目生成${e.count}道练习题。

主题：${e.topics.join("、")}
难度级别：${e.difficulty}
题型：${e.taskTypes.join("、")}

要求：
1. 每道题都应该有明确的学习目标
2. 包含详细的题目描述
3. 提供正确答案和详细解析
4. 标注每道题的难度系数（1-10）
5. 相关知识点
6. 提供解题提示（可选）
7. 对于主观题，提供评分标准（rubric）

请以下面JSON格式返回（只返回JSON，不要有其他内容）：
{
  "tasks": [
    {
      "id": "task_1",
      "type": "multiple_choice",
      "question": "题目内容",
      "options": ["选项A", "选项B", "选项C", "选项D"],
      "correctAnswer": "选项A",
      "explanation": "详细解析...",
      "difficulty": 5,
      "topics": ["知识点1"],
      "hints": ["提示1", "提示2"],
      "rubric": [
        {"criteria": "标准1", "points": 5}
      ]
    }
  ]
}`;return t?`${r}

针对该学生的个性化要求：
- 当前水平：${t.currentLevel}
- 优势领域：${t.strengths.join("、")||"暂无"}
- 薄弱领域：${t.weaknesses.join("、")||"暂无"}
- 学习风格：${t.learningStyle||"综合"}

请根据学生的水平调整题目难度，针对薄弱领域加强练习，在优势领域提供挑战性题目。`:r}function c(e){try{let t=e.match(/\{[\s\S]*\}/);if(!t)throw Error("No JSON found in response");return JSON.parse(t[0]).tasks||[]}catch(e){return console.error("Failed to parse task response:",e),[{id:"fallback_1",type:"short_answer",question:"请描述你对这个知识点的理解",difficulty:5,topics:["general"],explanation:"这是一个默认题目，请重新生成任务。"}]}}async function d(e){let t=u(e),r=await (0,o.generateWithFallback)(t,{temperature:.7});return c(r.content)}async function p(e,t){let r=u(e,t),a=await (0,o.generateWithFallback)(r,{temperature:.7});return c(a.content)}async function f(e,t){return await Promise.all(e.map(async e=>{let t=(await n.drizzleDb.select().from(i.studentPerformance).where((0,a.eq)(i.studentPerformance.studentId,e)).limit(1))[0];return t?{id:e,currentLevel:function(e){switch(e){case"advanced":return"advanced";case"struggling":return"beginner";default:return"intermediate"}}(t.cluster),strengths:t.strengths||[],weaknesses:t.weaknesses||[],cluster:t.cluster,learningStyle:t.learningStyle}:{id:e,currentLevel:"intermediate",strengths:[],weaknesses:[],cluster:"intermediate"}}))}async function h(e,t,r){let a=await f(t,r),n=new Map,s={advanced:[],intermediate:[],struggling:[]};for(let[t,r]of(a.forEach(e=>{s[e.cluster||"intermediate"].push(e)}),Object.entries(s))){if(0===r.length)continue;let a={...e,difficulty:"advanced"===t?"advanced":"struggling"===t?"beginner":"intermediate"},s=u(a),i=await (0,o.generateWithFallback)(s,{temperature:.7}),l=c(i.content);for(let e of r)n.set(e.id,l)}return n}async function g(e,t,r){let a=await f(t,r),n=new Map,s=a.map(e=>e.currentLevel).reduce((e,t)=>(e[t]=(e[t]||0)+1,e),{}),i=Object.entries(s).sort((e,t)=>t[1]-e[1])[0]?.[0]||"intermediate",l={...e,difficulty:i},d=`${u(l)}

特别注意：这些题目将用于混合能力小组学习。请确保：
1. 题目有多个层次的理解深度
2. 初学者可以通过基础方法解答
3. 高水平学生可以展示更深入的理解
4. 鼓励小组讨论和互助学习`,p=await (0,o.generateWithFallback)(d,{temperature:.7}),h=c(p.content);return t.forEach(e=>{n.set(e,h)}),n}async function m(e,t,r){try{let a=new Map;switch(e){case"uniform":{let e=await d(t);(r.targetStudentId?[r.targetStudentId]:r.studentIds||[]).forEach(t=>a.set(t,e));break}case"personalized":if(!r.targetStudentId&&!r.studentIds?.length)return{success:!1,error:"需要指定学生ID"};for(let e of r.targetStudentId?[r.targetStudentId]:r.studentIds){let n=await f([e],r.curriculumId),s=await p(t,n[0]);a.set(e,s)}break;case"clustered":if(!r.studentIds?.length)return{success:!1,error:"需要指定学生列表"};a=await h(t,r.studentIds,r.curriculumId);break;case"peer_group":if(!r.studentIds?.length)return{success:!1,error:"需要指定学生列表"};a=await g(t,r.studentIds,r.curriculumId);break;default:return{success:!1,error:"未知的分发模式"}}return{success:!0,tasks:a}}catch(e){return console.error("Task generation failed:",e),{success:!1,error:e instanceof Error?e.message:"任务生成失败"}}}async function y(e,t){try{let r=[];for(let[a,n]of e.entries()){let e={};e[a]=n.map(e=>({taskId:e.id,question:e.question,type:e.type,difficulty:e.difficulty,hints:e.hints,rubric:e.rubric}));let i=await s.prismaLegacyClient.generatedTask.create({data:{tutorId:t.tutorId,roomId:t.roomId,title:t.title,description:t.description||`${t.title} - 共${n.length}道题目`,type:t.type||"assignment",difficulty:n[0]?.difficulty<=3?"easy":n[0]?.difficulty<=7?"medium":"hard",questions:n.map(e=>({id:e.id,question:e.question,type:e.type,options:e.options,correctAnswer:e.correctAnswer,explanation:e.explanation,difficulty:e.difficulty,topics:e.topics,hints:e.hints})),distributionMode:t.distributionMode,assignments:e,status:"draft"}});r.push(i.id)}return{success:!0,taskIds:r}}catch(e){return console.error("Failed to save tasks:",e),{success:!1,error:e instanceof Error?e.message:"保存任务失败"}}}[n]=l.then?(await l)():l,e.s(["generateAndDistributeTasks",()=>m,"generateUniformTasks",()=>d,"saveGeneratedTasks",()=>y]),r()}catch(e){r(e)}},!1),648312,e=>e.a(async(t,r)=>{try{var a=e.i(620971),n=e.i(909105),s=e.i(8235),i=e.i(621557),o=e.i(738597);e.i(688768);var l=e.i(257357),u=e.i(384030),c=e.i(841195),d=t([s,i,o,u]);[s,i,o,u]=d.then?(await d)():d;let f=c.z.object({mode:c.z.string().min(1).max(32),config:c.z.record(c.z.string(),c.z.unknown()),targetStudentIds:c.z.array(c.z.string().min(1).max(128)).max(100).optional(),roomId:c.z.string().min(1).max(128),title:c.z.string().min(1).max(200),description:c.z.string().max(2e3).optional(),type:c.z.string().max(50).default("assignment")});async function p(e){try{let{response:t}=await (0,u.withRateLimitPreset)(e,"aiGenerate");if(t)return t;let r=await (0,s.getServerSession)(s.authOptions,e);if(!r?.user)return a.NextResponse.json({error:"未授权"},{status:401});if("TUTOR"!==r.user.role&&"ADMIN"!==r.user.role)return a.NextResponse.json({error:"无权生成任务"},{status:403});let c=await e.json().catch(()=>null),d=f.safeParse(c);if(!d.success)return a.NextResponse.json({error:"请求参数无效"},{status:400});let{mode:p,config:h,targetStudentIds:g,roomId:m,title:y,description:w,type:R}=d.data;if(!p||!h||!m)return a.NextResponse.json({error:"缺少必要参数: mode, config, roomId"},{status:400});let[v]=await o.drizzleDb.select().from(l.liveSession).where((0,n.and)((0,n.eq)(l.liveSession.id,m),(0,n.eq)(l.liveSession.tutorId,r.user.id))).limit(1);if(!v)return a.NextResponse.json({error:"无权访问该教室"},{status:403});let x=await (0,i.generateAndDistributeTasks)(p,h,{studentIds:g,targetStudentId:g?.[0]});if(!x.success||!x.tasks)return a.NextResponse.json({error:x.error||"任务生成失败"},{status:500});let k=await (0,i.saveGeneratedTasks)(x.tasks,{roomId:m,tutorId:r.user.id,distributionMode:p,title:y,description:w,type:R});if(!k.success)return a.NextResponse.json({error:k.error||"保存任务失败"},{status:500});return a.NextResponse.json({success:!0,data:{taskIds:k.taskIds,studentCount:x.tasks.size,mode:p}})}catch(e){return console.error("Failed to generate tasks:",e),a.NextResponse.json({error:"生成任务失败"},{status:500})}}e.s(["POST",()=>p]),r()}catch(e){r(e)}},!1),899619,e=>e.a(async(t,r)=>{try{var a=e.i(78315),n=e.i(586961),s=e.i(196657),i=e.i(899733),o=e.i(233979),l=e.i(631683),u=e.i(840960),c=e.i(711373),d=e.i(699699),p=e.i(521140),f=e.i(205260),h=e.i(500249),g=e.i(431740),m=e.i(82608),y=e.i(635207),w=e.i(193695);e.i(708038);var R=e.i(447430),v=e.i(648312),x=t([v]);[v]=x.then?(await x)():x;let E=new a.AppRouteRouteModule({definition:{kind:n.RouteKind.APP_ROUTE,page:"/api/tasks/generate/route",pathname:"/api/tasks/generate",filename:"route",bundlePath:""},distDir:".next",relativeProjectDir:"",resolvedPagePath:"[project]/ADK_WORKSPACE/TutorMekimi/tutorme-app/src/app/api/tasks/generate/route.ts",nextConfigOutput:"",userland:v}),{workAsyncStorage:_,workUnitAsyncStorage:I,serverHooks:C}=E;function k(){return(0,s.patchFetch)({workAsyncStorage:_,workUnitAsyncStorage:I})}async function b(e,t,r){E.isDev&&(0,i.addRequestMeta)(e,"devRequestTimingInternalsEnd",process.hrtime.bigint());let a="/api/tasks/generate/route";a=a.replace(/\/index$/,"")||"/";let s=await E.prepare(e,t,{srcPage:a,multiZoneDraftMode:!1});if(!s)return t.statusCode=400,t.end("Bad Request"),null==r.waitUntil||r.waitUntil.call(r,Promise.resolve()),null;let{buildId:v,params:x,nextConfig:k,parsedUrl:b,isDraftMode:_,prerenderManifest:I,routerServerContext:C,isOnDemandRevalidate:S,revalidateOnlyGenerated:A,resolvedPathname:T,clientReferenceManifest:N,serverActionsManifest:P}=s,O=(0,u.normalizeAppPath)(a),D=!!(I.dynamicRoutes[O]||I.routes[T]),q=async()=>((null==C?void 0:C.render404)?await C.render404(e,t,b,!1):t.end("This page could not be found"),null);if(D&&!_){let e=!!I.routes[T],t=I.dynamicRoutes[O];if(t&&!1===t.fallback&&!e){if(k.experimental.adapterPath)return await q();throw new w.NoFallbackError}}let j=null;!D||E.isDev||_||(j=T,j="/index"===j?"/":j);let z=!0===E.isDev||!D,M=D&&!z;P&&N&&(0,l.setManifestsSingleton)({page:a,clientReferenceManifest:N,serverActionsManifest:P});let $=e.method||"GET",U=(0,o.getTracer)(),F=U.getActiveScopeSpan(),H={params:x,prerenderManifest:I,renderOpts:{experimental:{authInterrupts:!!k.experimental.authInterrupts},cacheComponents:!!k.cacheComponents,supportsDynamicResponse:z,incrementalCache:(0,i.getRequestMeta)(e,"incrementalCache"),cacheLifeProfiles:k.cacheLife,waitUntil:r.waitUntil,onClose:e=>{t.on("close",e)},onAfterTaskError:void 0,onInstrumentationRequestError:(t,r,a,n)=>E.onRequestError(e,t,a,n,C)},sharedContext:{buildId:v}},L=new c.NodeNextRequest(e),K=new c.NodeNextResponse(t),B=d.NextRequestAdapter.fromNodeNextRequest(L,(0,d.signalFromNodeResponse)(t));try{let s=async e=>E.handle(B,H).finally(()=>{if(!e)return;e.setAttributes({"http.status_code":t.statusCode,"next.rsc":!1});let r=U.getRootSpanAttributes();if(!r)return;if(r.get("next.span_type")!==p.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${r.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let n=r.get("next.route");if(n){let t=`${$} ${n}`;e.setAttributes({"next.route":n,"http.route":n,"next.span_name":t}),e.updateName(t)}else e.updateName(`${$} ${a}`)}),l=!!(0,i.getRequestMeta)(e,"minimalMode"),u=async i=>{var o,u;let c=async({previousCacheEntry:n})=>{try{if(!l&&S&&A&&!n)return t.statusCode=404,t.setHeader("x-nextjs-cache","REVALIDATED"),t.end("This page could not be found"),null;let a=await s(i);e.fetchMetrics=H.renderOpts.fetchMetrics;let o=H.renderOpts.pendingWaitUntil;o&&r.waitUntil&&(r.waitUntil(o),o=void 0);let u=H.renderOpts.collectedTags;if(!D)return await (0,h.sendResponse)(L,K,a,H.renderOpts.pendingWaitUntil),null;{let e=await a.blob(),t=(0,g.toNodeOutgoingHttpHeaders)(a.headers);u&&(t[y.NEXT_CACHE_TAGS_HEADER]=u),!t["content-type"]&&e.type&&(t["content-type"]=e.type);let r=void 0!==H.renderOpts.collectedRevalidate&&!(H.renderOpts.collectedRevalidate>=y.INFINITE_CACHE)&&H.renderOpts.collectedRevalidate,n=void 0===H.renderOpts.collectedExpire||H.renderOpts.collectedExpire>=y.INFINITE_CACHE?void 0:H.renderOpts.collectedExpire;return{value:{kind:R.CachedRouteKind.APP_ROUTE,status:a.status,body:Buffer.from(await e.arrayBuffer()),headers:t},cacheControl:{revalidate:r,expire:n}}}}catch(t){throw(null==n?void 0:n.isStale)&&await E.onRequestError(e,t,{routerKind:"App Router",routePath:a,routeType:"route",revalidateReason:(0,f.getRevalidateReason)({isStaticGeneration:M,isOnDemandRevalidate:S})},!1,C),t}},d=await E.handleResponse({req:e,nextConfig:k,cacheKey:j,routeKind:n.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:I,isRoutePPREnabled:!1,isOnDemandRevalidate:S,revalidateOnlyGenerated:A,responseGenerator:c,waitUntil:r.waitUntil,isMinimalMode:l});if(!D)return null;if((null==d||null==(o=d.value)?void 0:o.kind)!==R.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==d||null==(u=d.value)?void 0:u.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});l||t.setHeader("x-nextjs-cache",S?"REVALIDATED":d.isMiss?"MISS":d.isStale?"STALE":"HIT"),_&&t.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let p=(0,g.fromNodeOutgoingHttpHeaders)(d.value.headers);return l&&D||p.delete(y.NEXT_CACHE_TAGS_HEADER),!d.cacheControl||t.getHeader("Cache-Control")||p.get("Cache-Control")||p.set("Cache-Control",(0,m.getCacheControlHeader)(d.cacheControl)),await (0,h.sendResponse)(L,K,new Response(d.value.body,{headers:p,status:d.value.status||200})),null};F?await u(F):await U.withPropagatedContext(e.headers,()=>U.trace(p.BaseServerSpan.handleRequest,{spanName:`${$} ${a}`,kind:o.SpanKind.SERVER,attributes:{"http.method":$,"http.target":e.url}},u))}catch(t){if(t instanceof w.NoFallbackError||await E.onRequestError(e,t,{routerKind:"App Router",routePath:O,routeType:"route",revalidateReason:(0,f.getRevalidateReason)({isStaticGeneration:M,isOnDemandRevalidate:S})},!1,C),D)throw t;return await (0,h.sendResponse)(L,K,new Response(null,{status:500})),null}}e.s(["handler",()=>b,"patchFetch",()=>k,"routeModule",()=>E,"serverHooks",()=>C,"workAsyncStorage",()=>_,"workUnitAsyncStorage",()=>I]),r()}catch(e){r(e)}},!1),412171,e=>{e.v(t=>Promise.all(["server/chunks/b1c00_TutorMekimi_tutorme-app_src_lib_security_suspicious-activity_ts_7865686f._.js"].map(t=>e.l(t))).then(()=>t(145830)))},443460,e=>{e.v(t=>Promise.all(["server/chunks/[externals]_ioredis_c74819ca._.js"].map(t=>e.l(t))).then(()=>t(693545)))},571363,e=>{e.v(t=>Promise.all(["server/chunks/ADK_WORKSPACE_TutorMekimi_tutorme-app_src_lib_security_api-key_ts_45091e81._.js"].map(t=>e.l(t))).then(()=>t(175922)))}];

//# debugId=c1829949-7b1f-f7db-3b92-50ea76579375
//# sourceMappingURL=%5Broot-of-the-server%5D__ff654c1e._.js.map