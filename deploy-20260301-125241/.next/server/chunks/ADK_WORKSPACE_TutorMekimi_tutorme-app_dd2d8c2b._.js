;!function(){try { var e="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof global?global:"undefined"!=typeof window?window:"undefined"!=typeof self?self:{},n=(new e.Error).stack;n&&((e._debugIds|| (e._debugIds={}))[n]="a5ccb9ad-15bb-d9df-4226-d3a90e64e6f6")}catch(e){}}();
module.exports=[300807,e=>e.a(async(t,i)=>{try{var n=e.i(620971),r=e.i(384030),a=e.i(738597);e.i(688768);var o=e.i(257357),l=e.i(909105),s=e.i(997103),c=e.i(320947);e.i(160373);var u=e.i(819316),d=e.i(254799),p=t([r,a]);async function m(e,t){try{let{searchParams:i}=new URL(e.url),r="true"===i.get("myBookings"),u=parseInt(i.get("limit")||"10"),d=i.get("subject")?.trim()||null,p=t.user.id;if(r){let e=d?(0,l.and)((0,l.eq)(o.clinicBooking.studentId,p),(0,l.ilike)(o.clinic.subject,d)):(0,l.eq)(o.clinicBooking.studentId,p),t=await a.drizzleDb.select({bookingId:o.clinicBooking.id,clinicId:o.clinicBooking.clinicId,studentId:o.clinicBooking.studentId,bookedAt:o.clinicBooking.bookedAt,attended:o.clinicBooking.attended,requiresPayment:o.clinicBooking.requiresPayment,clinicTitle:o.clinic.title,clinicSubject:o.clinic.subject,clinicDescription:o.clinic.description,tutorId:o.clinic.tutorId,startTime:o.clinic.startTime,duration:o.clinic.duration,maxStudents:o.clinic.maxStudents,status:o.clinic.status,roomUrl:o.clinic.roomUrl,roomId:o.clinic.roomId,clinicRequiresPayment:o.clinic.requiresPayment,paymentId:o.payment.id,paymentStatus:o.payment.status,gatewayCheckoutUrl:o.payment.gatewayCheckoutUrl,tutorName:o.profile.name,avatarUrl:o.profile.avatarUrl,hourlyRate:o.profile.hourlyRate}).from(o.clinicBooking).innerJoin(o.clinic,(0,l.eq)(o.clinicBooking.clinicId,o.clinic.id)).leftJoin(o.payment,(0,l.eq)(o.payment.bookingId,o.clinicBooking.id)).leftJoin(o.user,(0,l.eq)(o.clinic.tutorId,o.user.id)).leftJoin(o.profile,(0,l.eq)(o.profile.userId,o.user.id)).where(e).orderBy((0,s.asc)(o.clinic.startTime)).limit(u),i=[...new Set(t.map(e=>e.clinicId))],r=i.length>0?await Promise.all(i.map(async e=>{let[t]=await a.drizzleDb.select({count:c.sql`count(*)::int`}).from(o.clinicBooking).where((0,l.eq)(o.clinicBooking.clinicId,e));return{clinicId:e,count:t?.count??0}})):[],m=new Map(r.map(e=>[e.clinicId,e.count])),h=t.map(e=>{let t=e.hourlyRate??0,i=e.clinicRequiresPayment&&t>0?Math.round(t*(e.duration/60)*100)/100:null;return{id:e.clinicId,title:e.clinicTitle,subject:e.clinicSubject,description:e.clinicDescription,tutorId:e.tutorId,startTime:e.startTime,duration:e.duration,maxStudents:e.maxStudents,status:e.status,roomUrl:e.roomUrl,roomId:e.roomId,requiresPayment:e.clinicRequiresPayment??!1,isBooked:!0,bookingId:e.bookingId,currentBookings:m.get(e.clinicId)??0,price:i,paymentStatus:e.paymentStatus??null,paymentCheckoutUrl:e.gatewayCheckoutUrl??null,tutor:{id:e.tutorId,profile:{name:e.tutorName,avatarUrl:e.avatarUrl,hourlyRate:e.hourlyRate}}}});return n.NextResponse.json({classes:h})}let m=new Date,h=d?(0,l.and)((0,l.gte)(o.clinic.startTime,m),(0,l.inArray)(o.clinic.status,["scheduled","live"]),(0,l.ilike)(o.clinic.subject,d)):(0,l.and)((0,l.gte)(o.clinic.startTime,m),(0,l.inArray)(o.clinic.status,["scheduled","live"])),g=await a.drizzleDb.select({id:o.clinic.id,title:o.clinic.title,subject:o.clinic.subject,description:o.clinic.description,tutorId:o.clinic.tutorId,startTime:o.clinic.startTime,duration:o.clinic.duration,maxStudents:o.clinic.maxStudents,status:o.clinic.status,roomUrl:o.clinic.roomUrl,roomId:o.clinic.roomId,requiresPayment:o.clinic.requiresPayment,tutorName:o.profile.name,avatarUrl:o.profile.avatarUrl,hourlyRate:o.profile.hourlyRate}).from(o.clinic).leftJoin(o.user,(0,l.eq)(o.clinic.tutorId,o.user.id)).leftJoin(o.profile,(0,l.eq)(o.profile.userId,o.user.id)).where(h).orderBy((0,s.asc)(o.clinic.startTime)).limit(u),f=g.map(e=>e.id),y=f.length>0?await Promise.all(f.map(async e=>{let[t]=await a.drizzleDb.select({count:c.sql`count(*)::int`}).from(o.clinicBooking).where((0,l.eq)(o.clinicBooking.clinicId,e));return{clinicId:e,count:t?.count??0}})):[],w=new Map(y.map(e=>[e.clinicId,e.count])),R=f.length>0?(await a.drizzleDb.select({clinicId:o.clinicBooking.clinicId}).from(o.clinicBooking).where((0,l.and)((0,l.eq)(o.clinicBooking.studentId,p),(0,l.inArray)(o.clinicBooking.clinicId,f)))).map(e=>e.clinicId):[],I=new Set(R),k=g.map(e=>{let t=e.hourlyRate??0,i=e.requiresPayment&&t>0?Math.round(t*(e.duration/60)*100)/100:null;return{...e,isBooked:I.has(e.id),currentBookings:w.get(e.id)??0,price:i,tutor:{id:e.tutorId,profile:{name:e.tutorName,avatarUrl:e.avatarUrl,hourlyRate:e.hourlyRate}}}});return n.NextResponse.json({classes:k})}catch(e){return console.error("Failed to fetch classes:",e),n.NextResponse.json({error:"Failed to fetch classes"},{status:500})}}async function h(e,t){let i=await (0,r.requireCsrf)(e);if(i)return i;let{response:s}=await (0,r.withRateLimitPreset)(e,"booking");if(s)return s;try{let i=await e.json().catch(()=>({})),r="string"==typeof i.classId?i.classId.trim():"";if(!r)return n.NextResponse.json({error:"Class ID required"},{status:400});let[s]=await a.drizzleDb.select().from(o.clinic).where((0,l.eq)(o.clinic.id,r)).limit(1);if(!s)return n.NextResponse.json({error:"Class not found"},{status:404});let[p]=await a.drizzleDb.select({count:c.sql`count(*)::int`}).from(o.clinicBooking).where((0,l.eq)(o.clinicBooking.clinicId,r)),m=p?.count??0;if("scheduled"!==s.status)return n.NextResponse.json({error:"Class is not open for booking"},{status:400});if(m>=s.maxStudents)return n.NextResponse.json({error:"Class is full"},{status:400});let[h]=await a.drizzleDb.select().from(o.clinicBooking).where((0,l.and)((0,l.eq)(o.clinicBooking.clinicId,r),(0,l.eq)(o.clinicBooking.studentId,t.user.id))).limit(1);if(h)return n.NextResponse.json({error:"Already booked this class"},{status:400});let[g]=await a.drizzleDb.select().from(o.profile).where((0,l.eq)(o.profile.userId,s.tutorId)).limit(1),f=!!s.requiresPayment,y=d.default.randomUUID();await a.drizzleDb.insert(o.clinicBooking).values({id:y,clinicId:r,studentId:t.user.id,attended:!1,requiresPayment:f});let w={id:y,clinicId:r,studentId:t.user.id,requiresPayment:f,clinic:{...s,tutor:{profile:g??null}}};if(!f)return n.NextResponse.json({success:!0,booking:w,message:`Booked ${s.title} with ${g?.name??"Tutor"}`});let R=g?.hourlyRate??0;if(R<=0)return await a.drizzleDb.update(o.clinicBooking).set({requiresPayment:!1}).where((0,l.eq)(o.clinicBooking.id,y)),n.NextResponse.json({success:!0,booking:w,message:`Booked ${s.title} with ${g?.name??"Tutor"}`});let I=s.duration/60,k=Math.round(R*I*100)/100,b=g?.currency??"SGD",v=g?.paymentGatewayPreference,q="AIRWALLEX"===v||"HITPAY"===v?v:process.env.PAYMENT_DEFAULT_GATEWAY||"HITPAY",x=(0,u.getPaymentGateway)(q),B=t.user.email??"",E=await x.createPayment({amount:k,currency:b,bookingId:y,studentEmail:B||"",description:`${s.title} - ${s.subject}`,metadata:{clinicId:s.id,clinicTitle:s.title}}),T=d.default.randomUUID();return await a.drizzleDb.insert(o.payment).values({id:T,bookingId:y,amount:k,currency:b,status:"PENDING",gateway:q,gatewayPaymentId:E.paymentId,gatewayCheckoutUrl:E.checkoutUrl}),n.NextResponse.json({success:!0,requiresPayment:!0,booking:w,checkoutUrl:E.checkoutUrl,message:"Booking created. Complete payment to confirm your spot."})}catch(e){return console.error("Failed to book class:",e),n.NextResponse.json({error:"Failed to book class"},{status:500})}}async function g(e,t){let i=await (0,r.requireCsrf)(e);if(i)return i;try{let i=await e.json().catch(()=>({})),r="string"==typeof i.bookingId?i.bookingId.trim():"";if(!r)return n.NextResponse.json({error:"Booking ID required"},{status:400});let[s]=await a.drizzleDb.select({bookingId:o.clinicBooking.id,clinicId:o.clinic.id,startTime:o.clinic.startTime}).from(o.clinicBooking).innerJoin(o.clinic,(0,l.eq)(o.clinicBooking.clinicId,o.clinic.id)).where((0,l.and)((0,l.eq)(o.clinicBooking.id,r),(0,l.eq)(o.clinicBooking.studentId,t.user.id))).limit(1);if(!s)return n.NextResponse.json({error:"Booking not found"},{status:404});if(new Date(s.startTime)<new Date)return n.NextResponse.json({error:"Cannot cancel past class"},{status:400});return await a.drizzleDb.delete(o.clinicBooking).where((0,l.eq)(o.clinicBooking.id,r)),n.NextResponse.json({success:!0,message:"Booking cancelled"})}catch(e){return console.error("Failed to cancel booking:",e),n.NextResponse.json({error:"Failed to cancel booking"},{status:500})}}[r,a]=p.then?(await p)():p;let f=(0,r.withAuth)(m),y=(0,r.withAuth)(h),w=(0,r.withAuth)(g);e.s(["DELETE",0,w,"GET",0,f,"POST",0,y]),i()}catch(e){i(e)}},!1),16418,e=>e.a(async(t,i)=>{try{var n=e.i(78315),r=e.i(586961),a=e.i(196657),o=e.i(899733),l=e.i(233979),s=e.i(631683),c=e.i(840960),u=e.i(711373),d=e.i(699699),p=e.i(521140),m=e.i(205260),h=e.i(500249),g=e.i(431740),f=e.i(82608),y=e.i(635207),w=e.i(193695);e.i(708038);var R=e.i(447430),I=e.i(300807),k=t([I]);[I]=k.then?(await k)():k;let q=new n.AppRouteRouteModule({definition:{kind:r.RouteKind.APP_ROUTE,page:"/api/classes/route",pathname:"/api/classes",filename:"route",bundlePath:""},distDir:".next",relativeProjectDir:"",resolvedPagePath:"[project]/ADK_WORKSPACE/TutorMekimi/tutorme-app/src/app/api/classes/route.ts",nextConfigOutput:"",userland:I}),{workAsyncStorage:x,workUnitAsyncStorage:B,serverHooks:E}=q;function b(){return(0,a.patchFetch)({workAsyncStorage:x,workUnitAsyncStorage:B})}async function v(e,t,i){q.isDev&&(0,o.addRequestMeta)(e,"devRequestTimingInternalsEnd",process.hrtime.bigint());let n="/api/classes/route";n=n.replace(/\/index$/,"")||"/";let a=await q.prepare(e,t,{srcPage:n,multiZoneDraftMode:!1});if(!a)return t.statusCode=400,t.end("Bad Request"),null==i.waitUntil||i.waitUntil.call(i,Promise.resolve()),null;let{buildId:I,params:k,nextConfig:b,parsedUrl:v,isDraftMode:x,prerenderManifest:B,routerServerContext:E,isOnDemandRevalidate:T,revalidateOnlyGenerated:C,resolvedPathname:P,clientReferenceManifest:A,serverActionsManifest:N}=a,U=(0,c.normalizeAppPath)(n),D=!!(B.dynamicRoutes[U]||B.routes[P]),j=async()=>((null==E?void 0:E.render404)?await E.render404(e,t,v,!1):t.end("This page could not be found"),null);if(D&&!x){let e=!!B.routes[P],t=B.dynamicRoutes[U];if(t&&!1===t.fallback&&!e){if(b.experimental.adapterPath)return await j();throw new w.NoFallbackError}}let S=null;!D||q.isDev||x||(S=P,S="/index"===S?"/":S);let z=!0===q.isDev||!D,O=D&&!z;N&&A&&(0,s.setManifestsSingleton)({page:n,clientReferenceManifest:A,serverActionsManifest:N});let _=e.method||"GET",H=(0,l.getTracer)(),M=H.getActiveScopeSpan(),F={params:k,prerenderManifest:B,renderOpts:{experimental:{authInterrupts:!!b.experimental.authInterrupts},cacheComponents:!!b.cacheComponents,supportsDynamicResponse:z,incrementalCache:(0,o.getRequestMeta)(e,"incrementalCache"),cacheLifeProfiles:b.cacheLife,waitUntil:i.waitUntil,onClose:e=>{t.on("close",e)},onAfterTaskError:void 0,onInstrumentationRequestError:(t,i,n,r)=>q.onRequestError(e,t,n,r,E)},sharedContext:{buildId:I}},$=new u.NodeNextRequest(e),L=new u.NodeNextResponse(t),K=d.NextRequestAdapter.fromNodeNextRequest($,(0,d.signalFromNodeResponse)(t));try{let a=async e=>q.handle(K,F).finally(()=>{if(!e)return;e.setAttributes({"http.status_code":t.statusCode,"next.rsc":!1});let i=H.getRootSpanAttributes();if(!i)return;if(i.get("next.span_type")!==p.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${i.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let r=i.get("next.route");if(r){let t=`${_} ${r}`;e.setAttributes({"next.route":r,"http.route":r,"next.span_name":t}),e.updateName(t)}else e.updateName(`${_} ${n}`)}),s=!!(0,o.getRequestMeta)(e,"minimalMode"),c=async o=>{var l,c;let u=async({previousCacheEntry:r})=>{try{if(!s&&T&&C&&!r)return t.statusCode=404,t.setHeader("x-nextjs-cache","REVALIDATED"),t.end("This page could not be found"),null;let n=await a(o);e.fetchMetrics=F.renderOpts.fetchMetrics;let l=F.renderOpts.pendingWaitUntil;l&&i.waitUntil&&(i.waitUntil(l),l=void 0);let c=F.renderOpts.collectedTags;if(!D)return await (0,h.sendResponse)($,L,n,F.renderOpts.pendingWaitUntil),null;{let e=await n.blob(),t=(0,g.toNodeOutgoingHttpHeaders)(n.headers);c&&(t[y.NEXT_CACHE_TAGS_HEADER]=c),!t["content-type"]&&e.type&&(t["content-type"]=e.type);let i=void 0!==F.renderOpts.collectedRevalidate&&!(F.renderOpts.collectedRevalidate>=y.INFINITE_CACHE)&&F.renderOpts.collectedRevalidate,r=void 0===F.renderOpts.collectedExpire||F.renderOpts.collectedExpire>=y.INFINITE_CACHE?void 0:F.renderOpts.collectedExpire;return{value:{kind:R.CachedRouteKind.APP_ROUTE,status:n.status,body:Buffer.from(await e.arrayBuffer()),headers:t},cacheControl:{revalidate:i,expire:r}}}}catch(t){throw(null==r?void 0:r.isStale)&&await q.onRequestError(e,t,{routerKind:"App Router",routePath:n,routeType:"route",revalidateReason:(0,m.getRevalidateReason)({isStaticGeneration:O,isOnDemandRevalidate:T})},!1,E),t}},d=await q.handleResponse({req:e,nextConfig:b,cacheKey:S,routeKind:r.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:B,isRoutePPREnabled:!1,isOnDemandRevalidate:T,revalidateOnlyGenerated:C,responseGenerator:u,waitUntil:i.waitUntil,isMinimalMode:s});if(!D)return null;if((null==d||null==(l=d.value)?void 0:l.kind)!==R.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==d||null==(c=d.value)?void 0:c.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});s||t.setHeader("x-nextjs-cache",T?"REVALIDATED":d.isMiss?"MISS":d.isStale?"STALE":"HIT"),x&&t.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let p=(0,g.fromNodeOutgoingHttpHeaders)(d.value.headers);return s&&D||p.delete(y.NEXT_CACHE_TAGS_HEADER),!d.cacheControl||t.getHeader("Cache-Control")||p.get("Cache-Control")||p.set("Cache-Control",(0,f.getCacheControlHeader)(d.cacheControl)),await (0,h.sendResponse)($,L,new Response(d.value.body,{headers:p,status:d.value.status||200})),null};M?await c(M):await H.withPropagatedContext(e.headers,()=>H.trace(p.BaseServerSpan.handleRequest,{spanName:`${_} ${n}`,kind:l.SpanKind.SERVER,attributes:{"http.method":_,"http.target":e.url}},c))}catch(t){if(t instanceof w.NoFallbackError||await q.onRequestError(e,t,{routerKind:"App Router",routePath:U,routeType:"route",revalidateReason:(0,m.getRevalidateReason)({isStaticGeneration:O,isOnDemandRevalidate:T})},!1,E),D)throw t;return await (0,h.sendResponse)($,L,new Response(null,{status:500})),null}}e.s(["handler",()=>v,"patchFetch",()=>b,"routeModule",()=>q,"serverHooks",()=>E,"workAsyncStorage",()=>x,"workUnitAsyncStorage",()=>B]),i()}catch(e){i(e)}},!1)];

//# debugId=a5ccb9ad-15bb-d9df-4226-d3a90e64e6f6
//# sourceMappingURL=ADK_WORKSPACE_TutorMekimi_tutorme-app_dd2d8c2b._.js.map