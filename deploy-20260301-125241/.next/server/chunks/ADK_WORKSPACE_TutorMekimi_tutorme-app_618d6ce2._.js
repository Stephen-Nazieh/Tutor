;!function(){try { var e="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof global?global:"undefined"!=typeof window?window:"undefined"!=typeof self?self:{},n=(new e.Error).stack;n&&((e._debugIds|| (e._debugIds={}))[n]="319d2e78-550d-7b6a-d7bf-c1c90c360f75")}catch(e){}}();
module.exports=[294645,e=>e.a(async(t,a)=>{try{var n=e.i(620971),r=e.i(384030),i=e.i(738597);e.i(688768);var l=e.i(257357),o=e.i(909105),s=e.i(841195),d=t([r,i]);[r,i]=d.then?(await d)():d;let u=s.z.object({tutorId:s.z.string(),startTime:s.z.string().datetime(),endTime:s.z.string().datetime(),excludeEventId:s.z.string().optional()}),p=(0,r.withAuth)(async(e,t)=>{let a=t.user.id,r=t.user.role;try{let t=await e.json(),s=u.safeParse(t);if(!s.success)return n.NextResponse.json({error:"Invalid request",details:s.error.format()},{status:400});let{tutorId:d,startTime:p,endTime:m,excludeEventId:h}=s.data;if("TUTOR"===r&&d!==a)return n.NextResponse.json({error:"Can only check your own availability"},{status:403});let v=new Date(p),T=new Date(m);if(T<=v)return n.NextResponse.json({error:"End time must be after start time"},{status:400});let E=[(0,o.eq)(l.calendarEvent.tutorId,d),(0,o.isNull)(l.calendarEvent.deletedAt),(0,o.eq)(l.calendarEvent.isCancelled,!1),(0,o.lt)(l.calendarEvent.startTime,T),(0,o.gt)(l.calendarEvent.endTime,v)];h&&E.push((0,o.ne)(l.calendarEvent.id,h));let g=await i.drizzleDb.select({id:l.calendarEvent.id,title:l.calendarEvent.title,startTime:l.calendarEvent.startTime,endTime:l.calendarEvent.endTime,type:l.calendarEvent.type}).from(l.calendarEvent).where((0,o.and)(...E)),w=v.getDay(),f=v.toISOString().split("T")[0],R=v.toTimeString().slice(0,5),y=await i.drizzleDb.select().from(l.calendarAvailability).where((0,o.and)((0,o.eq)(l.calendarAvailability.tutorId,d),(0,o.eq)(l.calendarAvailability.dayOfWeek,w),(0,o.eq)(l.calendarAvailability.isAvailable,!0),(0,o.or)((0,o.isNull)(l.calendarAvailability.validUntil),(0,o.gte)(l.calendarAvailability.validUntil,v)))),x=(0,o.and)((0,o.eq)(l.calendarException.tutorId,d),(0,o.eq)(l.calendarException.date,new Date(f)),(0,o.or)((0,o.and)((0,o.isNull)(l.calendarException.startTime),(0,o.isNull)(l.calendarException.endTime)),(0,o.and)((0,o.not)((0,o.isNull)(l.calendarException.startTime)),(0,o.not)((0,o.isNull)(l.calendarException.endTime)),(0,o.lte)(l.calendarException.startTime,R),(0,o.gte)(l.calendarException.endTime,R)))),[b]=await i.drizzleDb.select().from(l.calendarException).where(x).limit(1),A=y.length>0&&!b&&0===g.length,C=await c(d,v,T);return n.NextResponse.json({available:A,conflicts:g.map(e=>({id:e.id,title:e.title,startTime:e.startTime,endTime:e.endTime,type:e.type})),exception:b?{isAvailable:b.isAvailable,reason:b.reason}:null,suggestedTimes:C,tutorTimezone:y[0]?.timezone||"Asia/Shanghai"})}catch(e){return console.error("Check availability error:",e),n.NextResponse.json({error:"Failed to check availability"},{status:500})}});async function c(e,t,a,n=3){let r=[],s=a.getTime()-t.getTime();for(let a=0;a<7&&r.length<n;a++){let d=new Date(t);d.setDate(d.getDate()+a);let c=d.getDay(),u=d.toISOString().split("T")[0],p=new Date(u),m=new Date(p.getTime()+864e5),h=await i.drizzleDb.select().from(l.calendarAvailability).where((0,o.and)((0,o.eq)(l.calendarAvailability.tutorId,e),(0,o.eq)(l.calendarAvailability.dayOfWeek,c),(0,o.eq)(l.calendarAvailability.isAvailable,!0))),v=await i.drizzleDb.select().from(l.calendarException).where((0,o.and)((0,o.eq)(l.calendarException.tutorId,e),(0,o.eq)(l.calendarException.date,p),(0,o.eq)(l.calendarException.isAvailable,!1))),T=await i.drizzleDb.select().from(l.calendarEvent).where((0,o.and)((0,o.eq)(l.calendarEvent.tutorId,e),(0,o.isNull)(l.calendarEvent.deletedAt),(0,o.eq)(l.calendarEvent.isCancelled,!1),(0,o.gte)(l.calendarEvent.startTime,p),(0,o.lt)(l.calendarEvent.startTime,m)));for(let e of h){if(r.length>=n)break;let t=new Date(`${u}T${e.startTime}`),a=new Date(`${u}T${e.endTime}`);if(v.some(e=>{if(!e.startTime||!e.endTime)return!0;let n=new Date(`${u}T${e.startTime}`),r=new Date(`${u}T${e.endTime}`);return t<r&&a>n}))continue;let i=T.filter(e=>e.startTime.toISOString().split("T")[0]===u).sort((e,t)=>e.startTime.getTime()-t.startTime.getTime()),l=new Date(t);for(let e of i){if(l.getTime()+s<=e.startTime.getTime()&&(r.push({startTime:new Date(l),endTime:new Date(l.getTime()+s)}),r.length>=n))break;l=new Date(Math.max(l.getTime(),e.endTime.getTime()))}r.length<n&&l.getTime()+s<=a.getTime()&&r.push({startTime:new Date(l),endTime:new Date(l.getTime()+s)})}}return r}e.s(["POST",0,p]),a()}catch(e){a(e)}},!1),774956,e=>e.a(async(t,a)=>{try{var n=e.i(78315),r=e.i(586961),i=e.i(196657),l=e.i(899733),o=e.i(233979),s=e.i(631683),d=e.i(840960),c=e.i(711373),u=e.i(699699),p=e.i(521140),m=e.i(205260),h=e.i(500249),v=e.i(431740),T=e.i(82608),E=e.i(635207),g=e.i(193695);e.i(708038);var w=e.i(447430),f=e.i(294645),R=t([f]);[f]=R.then?(await R)():R;let b=new n.AppRouteRouteModule({definition:{kind:r.RouteKind.APP_ROUTE,page:"/api/tutor/calendar/check/route",pathname:"/api/tutor/calendar/check",filename:"route",bundlePath:""},distDir:".next",relativeProjectDir:"",resolvedPagePath:"[project]/ADK_WORKSPACE/TutorMekimi/tutorme-app/src/app/api/tutor/calendar/check/route.ts",nextConfigOutput:"",userland:f}),{workAsyncStorage:A,workUnitAsyncStorage:C,serverHooks:D}=b;function y(){return(0,i.patchFetch)({workAsyncStorage:A,workUnitAsyncStorage:C})}async function x(e,t,a){b.isDev&&(0,l.addRequestMeta)(e,"devRequestTimingInternalsEnd",process.hrtime.bigint());let n="/api/tutor/calendar/check/route";n=n.replace(/\/index$/,"")||"/";let i=await b.prepare(e,t,{srcPage:n,multiZoneDraftMode:!1});if(!i)return t.statusCode=400,t.end("Bad Request"),null==a.waitUntil||a.waitUntil.call(a,Promise.resolve()),null;let{buildId:f,params:R,nextConfig:y,parsedUrl:x,isDraftMode:A,prerenderManifest:C,routerServerContext:D,isOnDemandRevalidate:N,revalidateOnlyGenerated:q,resolvedPathname:O,clientReferenceManifest:S,serverActionsManifest:I}=i,P=(0,d.normalizeAppPath)(n),k=!!(C.dynamicRoutes[P]||C.routes[O]),_=async()=>((null==D?void 0:D.render404)?await D.render404(e,t,x,!1):t.end("This page could not be found"),null);if(k&&!A){let e=!!C.routes[O],t=C.dynamicRoutes[P];if(t&&!1===t.fallback&&!e){if(y.experimental.adapterPath)return await _();throw new g.NoFallbackError}}let z=null;!k||b.isDev||A||(z=O,z="/index"===z?"/":z);let U=!0===b.isDev||!k,H=k&&!U;I&&S&&(0,s.setManifestsSingleton)({page:n,clientReferenceManifest:S,serverActionsManifest:I});let $=e.method||"GET",j=(0,o.getTracer)(),M=j.getActiveScopeSpan(),K={params:R,prerenderManifest:C,renderOpts:{experimental:{authInterrupts:!!y.experimental.authInterrupts},cacheComponents:!!y.cacheComponents,supportsDynamicResponse:U,incrementalCache:(0,l.getRequestMeta)(e,"incrementalCache"),cacheLifeProfiles:y.cacheLife,waitUntil:a.waitUntil,onClose:e=>{t.on("close",e)},onAfterTaskError:void 0,onInstrumentationRequestError:(t,a,n,r)=>b.onRequestError(e,t,n,r,D)},sharedContext:{buildId:f}},F=new c.NodeNextRequest(e),B=new c.NodeNextResponse(t),L=u.NextRequestAdapter.fromNodeNextRequest(F,(0,u.signalFromNodeResponse)(t));try{let i=async e=>b.handle(L,K).finally(()=>{if(!e)return;e.setAttributes({"http.status_code":t.statusCode,"next.rsc":!1});let a=j.getRootSpanAttributes();if(!a)return;if(a.get("next.span_type")!==p.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${a.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let r=a.get("next.route");if(r){let t=`${$} ${r}`;e.setAttributes({"next.route":r,"http.route":r,"next.span_name":t}),e.updateName(t)}else e.updateName(`${$} ${n}`)}),s=!!(0,l.getRequestMeta)(e,"minimalMode"),d=async l=>{var o,d;let c=async({previousCacheEntry:r})=>{try{if(!s&&N&&q&&!r)return t.statusCode=404,t.setHeader("x-nextjs-cache","REVALIDATED"),t.end("This page could not be found"),null;let n=await i(l);e.fetchMetrics=K.renderOpts.fetchMetrics;let o=K.renderOpts.pendingWaitUntil;o&&a.waitUntil&&(a.waitUntil(o),o=void 0);let d=K.renderOpts.collectedTags;if(!k)return await (0,h.sendResponse)(F,B,n,K.renderOpts.pendingWaitUntil),null;{let e=await n.blob(),t=(0,v.toNodeOutgoingHttpHeaders)(n.headers);d&&(t[E.NEXT_CACHE_TAGS_HEADER]=d),!t["content-type"]&&e.type&&(t["content-type"]=e.type);let a=void 0!==K.renderOpts.collectedRevalidate&&!(K.renderOpts.collectedRevalidate>=E.INFINITE_CACHE)&&K.renderOpts.collectedRevalidate,r=void 0===K.renderOpts.collectedExpire||K.renderOpts.collectedExpire>=E.INFINITE_CACHE?void 0:K.renderOpts.collectedExpire;return{value:{kind:w.CachedRouteKind.APP_ROUTE,status:n.status,body:Buffer.from(await e.arrayBuffer()),headers:t},cacheControl:{revalidate:a,expire:r}}}}catch(t){throw(null==r?void 0:r.isStale)&&await b.onRequestError(e,t,{routerKind:"App Router",routePath:n,routeType:"route",revalidateReason:(0,m.getRevalidateReason)({isStaticGeneration:H,isOnDemandRevalidate:N})},!1,D),t}},u=await b.handleResponse({req:e,nextConfig:y,cacheKey:z,routeKind:r.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:C,isRoutePPREnabled:!1,isOnDemandRevalidate:N,revalidateOnlyGenerated:q,responseGenerator:c,waitUntil:a.waitUntil,isMinimalMode:s});if(!k)return null;if((null==u||null==(o=u.value)?void 0:o.kind)!==w.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==u||null==(d=u.value)?void 0:d.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});s||t.setHeader("x-nextjs-cache",N?"REVALIDATED":u.isMiss?"MISS":u.isStale?"STALE":"HIT"),A&&t.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let p=(0,v.fromNodeOutgoingHttpHeaders)(u.value.headers);return s&&k||p.delete(E.NEXT_CACHE_TAGS_HEADER),!u.cacheControl||t.getHeader("Cache-Control")||p.get("Cache-Control")||p.set("Cache-Control",(0,T.getCacheControlHeader)(u.cacheControl)),await (0,h.sendResponse)(F,B,new Response(u.value.body,{headers:p,status:u.value.status||200})),null};M?await d(M):await j.withPropagatedContext(e.headers,()=>j.trace(p.BaseServerSpan.handleRequest,{spanName:`${$} ${n}`,kind:o.SpanKind.SERVER,attributes:{"http.method":$,"http.target":e.url}},d))}catch(t){if(t instanceof g.NoFallbackError||await b.onRequestError(e,t,{routerKind:"App Router",routePath:P,routeType:"route",revalidateReason:(0,m.getRevalidateReason)({isStaticGeneration:H,isOnDemandRevalidate:N})},!1,D),k)throw t;return await (0,h.sendResponse)(F,B,new Response(null,{status:500})),null}}e.s(["handler",()=>x,"patchFetch",()=>y,"routeModule",()=>b,"serverHooks",()=>D,"workAsyncStorage",()=>A,"workUnitAsyncStorage",()=>C]),a()}catch(e){a(e)}},!1)];

//# debugId=319d2e78-550d-7b6a-d7bf-c1c90c360f75
//# sourceMappingURL=ADK_WORKSPACE_TutorMekimi_tutorme-app_618d6ce2._.js.map