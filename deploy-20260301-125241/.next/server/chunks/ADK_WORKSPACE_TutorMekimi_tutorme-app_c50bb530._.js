;!function(){try { var e="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof global?global:"undefined"!=typeof window?window:"undefined"!=typeof self?self:{},n=(new e.Error).stack;n&&((e._debugIds|| (e._debugIds={}))[n]="cf0cdce6-87e4-5edf-4260-1597bd209de0")}catch(e){}}();
module.exports=[310616,e=>e.a(async(t,n)=>{try{var r=e.i(620971),a=e.i(384030),i=e.i(738597);e.i(688768);var o=e.i(257357),s=e.i(909105),l=e.i(997103),d=e.i(320947),c=e.i(841195),u=e.i(75835),p=t([a,i]);[a,i]=p.then?(await p)():p;let v=c.z.object({provider:c.z.enum(["google","outlook","apple"]).optional(),direction:c.z.enum(["to_external","from_external","bidirectional"]).default("bidirectional"),dateRange:c.z.object({start:c.z.string().datetime(),end:c.z.string().datetime()}).optional()}),m=(0,a.withAuth)(async(e,t)=>{let n=t.user.id;try{let e=await i.drizzleDb.select().from(o.calendarConnection).where((0,s.eq)(o.calendarConnection.userId,n)).orderBy((0,l.asc)(o.calendarConnection.provider)),t=await i.drizzleDb.select({createdBy:o.calendarEvent.createdBy,count:d.sql`count(*)::int`}).from(o.calendarEvent).where((0,s.and)((0,s.eq)(o.calendarEvent.tutorId,n),(0,s.isNull)(o.calendarEvent.deletedAt))).groupBy(o.calendarEvent.createdBy),a={manual:t.find(e=>"manual"===e.createdBy)?.count??0,sync:t.find(e=>"sync"===e.createdBy)?.count??0,system:t.find(e=>"system"===e.createdBy)?.count??0};return r.NextResponse.json({connections:e.map(e=>({provider:e.provider,syncEnabled:e.syncEnabled,syncDirection:e.syncDirection,lastSyncedAt:e.lastSyncedAt,expiresAt:e.expiresAt})),stats:a})}catch(e){return console.error("Fetch sync status error:",e),r.NextResponse.json({error:"Failed to fetch sync status"},{status:500})}},{role:"TUTOR"}),w=(0,a.withAuth)(async(e,t)=>{let n=t.user.id;try{let t=await e.json(),a=v.safeParse(t);if(!a.success)return r.NextResponse.json({error:"Invalid request",details:a.error.format()},{status:400});let{provider:l,direction:d,dateRange:c}=a.data,u=[(0,s.eq)(o.calendarConnection.userId,n),(0,s.eq)(o.calendarConnection.syncEnabled,!0)];l&&u.push((0,s.eq)(o.calendarConnection.provider,l));let p=await i.drizzleDb.select().from(o.calendarConnection).where((0,s.and)(...u));if(0===p.length)return r.NextResponse.json({error:"No calendar connections found. Please connect a calendar first."},{status:404});let y=[],m={start:new Date(Date.now()-2592e6),end:new Date(Date.now()+7776e6)},w=c?{start:new Date(c.start),end:new Date(c.end)}:m;for(let e of p){if(e.expiresAt&&e.expiresAt<new Date){y.push({provider:e.provider,status:"error",message:"Token expired, please reconnect"});continue}try{let t=await h(e,d,w,n);await i.drizzleDb.update(o.calendarConnection).set({lastSyncedAt:new Date}).where((0,s.eq)(o.calendarConnection.id,e.id)),y.push({provider:e.provider,status:"success",...t})}catch(t){y.push({provider:e.provider,status:"error",message:t instanceof Error?t.message:"Unknown error"})}}return r.NextResponse.json({syncResults:y,timestamp:new Date().toISOString()})}catch(e){return console.error("Calendar sync error:",e),r.NextResponse.json({error:"Failed to sync calendar"},{status:500})}},{role:"TUTOR"});async function h(e,t,n,r){let a={};if("from_external"===t||"bidirectional"===t){let t=await y(e,n);for(let e of t){let[t]=await i.drizzleDb.select().from(o.calendarEvent).where((0,s.eq)(o.calendarEvent.externalId,e.id)).limit(1);t?await i.drizzleDb.update(o.calendarEvent).set({title:e.title,description:e.description,startTime:e.startTime,endTime:e.endTime,location:e.location}).where((0,s.eq)(o.calendarEvent.id,t.id)):await i.drizzleDb.insert(o.calendarEvent).values({id:(0,u.nanoid)(),tutorId:r,externalId:e.id,title:e.title,description:e.description,startTime:e.startTime,endTime:e.endTime,location:e.location,type:"PERSONAL",createdBy:"sync",status:"CONFIRMED",timezone:"Asia/Shanghai",isAllDay:!1,isRecurring:!1,maxAttendees:1,isVirtual:!1,isCancelled:!1})}a.imported=t.length}return("to_external"===t||"bidirectional"===t)&&(a.exported=(await i.drizzleDb.select().from(o.calendarEvent).where((0,s.and)((0,s.eq)(o.calendarEvent.tutorId,r),(0,s.isNull)(o.calendarEvent.deletedAt),(0,s.eq)(o.calendarEvent.isCancelled,!1),(0,s.gte)(o.calendarEvent.startTime,n.start),(0,s.lte)(o.calendarEvent.startTime,n.end),(0,s.isNull)(o.calendarEvent.externalId)))).length),a}async function y(e,t){return e.provider,[]}let R=(0,a.withAuth)(async(e,t)=>{let n=t.user.id;try{let{provider:t,authCode:a}=await e.json();if(!t||!a)return r.NextResponse.json({error:"Provider and auth code are required"},{status:400});let[l]=await i.drizzleDb.select().from(o.calendarConnection).where((0,s.and)((0,s.eq)(o.calendarConnection.userId,n),(0,s.eq)(o.calendarConnection.provider,t))).limit(1),d=new Date;if(l){let[e]=await i.drizzleDb.update(o.calendarConnection).set({syncEnabled:!0,lastSyncedAt:d}).where((0,s.eq)(o.calendarConnection.id,l.id)).returning();return r.NextResponse.json({connection:{provider:e.provider,syncEnabled:e.syncEnabled,syncDirection:e.syncDirection},message:"Calendar connected successfully"})}let[c]=await i.drizzleDb.insert(o.calendarConnection).values({id:(0,u.nanoid)(),userId:n,provider:t,syncEnabled:!0,syncDirection:"bidirectional"}).returning();return r.NextResponse.json({connection:{provider:c.provider,syncEnabled:c.syncEnabled,syncDirection:c.syncDirection},message:"Calendar connected successfully"})}catch(e){return console.error("Connect calendar error:",e),r.NextResponse.json({error:"Failed to connect calendar"},{status:500})}},{role:"TUTOR"});e.s(["GET",0,m,"POST",0,w,"PUT",0,R]),n()}catch(e){n(e)}},!1),174378,e=>e.a(async(t,n)=>{try{var r=e.i(78315),a=e.i(586961),i=e.i(196657),o=e.i(899733),s=e.i(233979),l=e.i(631683),d=e.i(840960),c=e.i(711373),u=e.i(699699),p=e.i(521140),h=e.i(205260),y=e.i(500249),v=e.i(431740),m=e.i(82608),w=e.i(635207),R=e.i(193695);e.i(708038);var f=e.i(447430),E=e.i(310616),C=t([E]);[E]=C.then?(await C)():C;let b=new r.AppRouteRouteModule({definition:{kind:a.RouteKind.APP_ROUTE,page:"/api/tutor/calendar/sync/route",pathname:"/api/tutor/calendar/sync",filename:"route",bundlePath:""},distDir:".next",relativeProjectDir:"",resolvedPagePath:"[project]/ADK_WORKSPACE/TutorMekimi/tutorme-app/src/app/api/tutor/calendar/sync/route.ts",nextConfigOutput:"",userland:E}),{workAsyncStorage:A,workUnitAsyncStorage:T,serverHooks:D}=b;function g(){return(0,i.patchFetch)({workAsyncStorage:A,workUnitAsyncStorage:T})}async function x(e,t,n){b.isDev&&(0,o.addRequestMeta)(e,"devRequestTimingInternalsEnd",process.hrtime.bigint());let r="/api/tutor/calendar/sync/route";r=r.replace(/\/index$/,"")||"/";let i=await b.prepare(e,t,{srcPage:r,multiZoneDraftMode:!1});if(!i)return t.statusCode=400,t.end("Bad Request"),null==n.waitUntil||n.waitUntil.call(n,Promise.resolve()),null;let{buildId:E,params:C,nextConfig:g,parsedUrl:x,isDraftMode:A,prerenderManifest:T,routerServerContext:D,isOnDemandRevalidate:N,revalidateOnlyGenerated:q,resolvedPathname:z,clientReferenceManifest:P,serverActionsManifest:O}=i,S=(0,d.normalizeAppPath)(r),I=!!(T.dynamicRoutes[S]||T.routes[z]),_=async()=>((null==D?void 0:D.render404)?await D.render404(e,t,x,!1):t.end("This page could not be found"),null);if(I&&!A){let e=!!T.routes[z],t=T.dynamicRoutes[S];if(t&&!1===t.fallback&&!e){if(g.experimental.adapterPath)return await _();throw new R.NoFallbackError}}let j=null;!I||b.isDev||A||(j=z,j="/index"===j?"/":j);let U=!0===b.isDev||!I,k=I&&!U;O&&P&&(0,l.setManifestsSingleton)({page:r,clientReferenceManifest:P,serverActionsManifest:O});let H=e.method||"GET",B=(0,s.getTracer)(),M=B.getActiveScopeSpan(),F={params:C,prerenderManifest:T,renderOpts:{experimental:{authInterrupts:!!g.experimental.authInterrupts},cacheComponents:!!g.cacheComponents,supportsDynamicResponse:U,incrementalCache:(0,o.getRequestMeta)(e,"incrementalCache"),cacheLifeProfiles:g.cacheLife,waitUntil:n.waitUntil,onClose:e=>{t.on("close",e)},onAfterTaskError:void 0,onInstrumentationRequestError:(t,n,r,a)=>b.onRequestError(e,t,r,a,D)},sharedContext:{buildId:E}},K=new c.NodeNextRequest(e),$=new c.NodeNextResponse(t),L=u.NextRequestAdapter.fromNodeNextRequest(K,(0,u.signalFromNodeResponse)(t));try{let i=async e=>b.handle(L,F).finally(()=>{if(!e)return;e.setAttributes({"http.status_code":t.statusCode,"next.rsc":!1});let n=B.getRootSpanAttributes();if(!n)return;if(n.get("next.span_type")!==p.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${n.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let a=n.get("next.route");if(a){let t=`${H} ${a}`;e.setAttributes({"next.route":a,"http.route":a,"next.span_name":t}),e.updateName(t)}else e.updateName(`${H} ${r}`)}),l=!!(0,o.getRequestMeta)(e,"minimalMode"),d=async o=>{var s,d;let c=async({previousCacheEntry:a})=>{try{if(!l&&N&&q&&!a)return t.statusCode=404,t.setHeader("x-nextjs-cache","REVALIDATED"),t.end("This page could not be found"),null;let r=await i(o);e.fetchMetrics=F.renderOpts.fetchMetrics;let s=F.renderOpts.pendingWaitUntil;s&&n.waitUntil&&(n.waitUntil(s),s=void 0);let d=F.renderOpts.collectedTags;if(!I)return await (0,y.sendResponse)(K,$,r,F.renderOpts.pendingWaitUntil),null;{let e=await r.blob(),t=(0,v.toNodeOutgoingHttpHeaders)(r.headers);d&&(t[w.NEXT_CACHE_TAGS_HEADER]=d),!t["content-type"]&&e.type&&(t["content-type"]=e.type);let n=void 0!==F.renderOpts.collectedRevalidate&&!(F.renderOpts.collectedRevalidate>=w.INFINITE_CACHE)&&F.renderOpts.collectedRevalidate,a=void 0===F.renderOpts.collectedExpire||F.renderOpts.collectedExpire>=w.INFINITE_CACHE?void 0:F.renderOpts.collectedExpire;return{value:{kind:f.CachedRouteKind.APP_ROUTE,status:r.status,body:Buffer.from(await e.arrayBuffer()),headers:t},cacheControl:{revalidate:n,expire:a}}}}catch(t){throw(null==a?void 0:a.isStale)&&await b.onRequestError(e,t,{routerKind:"App Router",routePath:r,routeType:"route",revalidateReason:(0,h.getRevalidateReason)({isStaticGeneration:k,isOnDemandRevalidate:N})},!1,D),t}},u=await b.handleResponse({req:e,nextConfig:g,cacheKey:j,routeKind:a.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:T,isRoutePPREnabled:!1,isOnDemandRevalidate:N,revalidateOnlyGenerated:q,responseGenerator:c,waitUntil:n.waitUntil,isMinimalMode:l});if(!I)return null;if((null==u||null==(s=u.value)?void 0:s.kind)!==f.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==u||null==(d=u.value)?void 0:d.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});l||t.setHeader("x-nextjs-cache",N?"REVALIDATED":u.isMiss?"MISS":u.isStale?"STALE":"HIT"),A&&t.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let p=(0,v.fromNodeOutgoingHttpHeaders)(u.value.headers);return l&&I||p.delete(w.NEXT_CACHE_TAGS_HEADER),!u.cacheControl||t.getHeader("Cache-Control")||p.get("Cache-Control")||p.set("Cache-Control",(0,m.getCacheControlHeader)(u.cacheControl)),await (0,y.sendResponse)(K,$,new Response(u.value.body,{headers:p,status:u.value.status||200})),null};M?await d(M):await B.withPropagatedContext(e.headers,()=>B.trace(p.BaseServerSpan.handleRequest,{spanName:`${H} ${r}`,kind:s.SpanKind.SERVER,attributes:{"http.method":H,"http.target":e.url}},d))}catch(t){if(t instanceof R.NoFallbackError||await b.onRequestError(e,t,{routerKind:"App Router",routePath:S,routeType:"route",revalidateReason:(0,h.getRevalidateReason)({isStaticGeneration:k,isOnDemandRevalidate:N})},!1,D),I)throw t;return await (0,y.sendResponse)(K,$,new Response(null,{status:500})),null}}e.s(["handler",()=>x,"patchFetch",()=>g,"routeModule",()=>b,"serverHooks",()=>D,"workAsyncStorage",()=>A,"workUnitAsyncStorage",()=>T]),n()}catch(e){n(e)}},!1)];

//# debugId=cf0cdce6-87e4-5edf-4260-1597bd209de0
//# sourceMappingURL=ADK_WORKSPACE_TutorMekimi_tutorme-app_c50bb530._.js.map