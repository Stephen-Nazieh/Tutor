;!function(){try { var e="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof global?global:"undefined"!=typeof window?window:"undefined"!=typeof self?self:{},n=(new e.Error).stack;n&&((e._debugIds|| (e._debugIds={}))[n]="07d5b5e2-0fcc-9866-4b16-c8c3729f6ca8")}catch(e){}}();
module.exports=[343260,e=>e.a(async(t,r)=>{try{var s=e.i(620971),n=e.i(738597);e.i(688768);var i=e.i(257357),a=e.i(909105),o=e.i(997103),u=e.i(320947),l=e.i(569773),d=e.i(979651),c=t([n,l]);async function p(e){let{session:t,response:r}=await (0,l.requireAdmin)(e,d.Permissions.ANALYTICS_READ);if(!t)return r;try{let{searchParams:t}=new URL(e.url),r=parseInt(t.get("days")||"7"),l=new Date;l.setDate(l.getDate()-r);let[d,c,p,h,g,m,A,f,v,y,w,R,E,b,S,z,C,I,D,P]=await Promise.all([n.drizzleDb.select({count:u.sql`count(*)::int`}).from(i.user),n.drizzleDb.select({count:u.sql`count(*)::int`}).from(i.user).where((0,a.gte)(i.user.createdAt,l)),n.drizzleDb.select({userId:i.userActivityLog.userId}).from(i.userActivityLog).where((0,a.gte)(i.userActivityLog.createdAt,l)).groupBy(i.userActivityLog.userId),n.drizzleDb.select({count:u.sql`count(*)::int`}).from(i.liveSession),n.drizzleDb.select({count:u.sql`count(*)::int`}).from(i.contentItem),n.drizzleDb.select({count:u.sql`count(*)::int`}).from(i.curriculumEnrollment),n.drizzleDb.select({count:u.sql`count(*)::int`}).from(i.userActivityLog).where((0,a.and)((0,a.eq)(i.userActivityLog.action,"login"),(0,a.gte)(i.userActivityLog.createdAt,l))),n.drizzleDb.select({role:i.user.role,count:u.sql`count(*)::int`}).from(i.user).groupBy(i.user.role),n.drizzleDb.select({userId:i.userActivityLog.userId,action:i.userActivityLog.action,createdAt:i.userActivityLog.createdAt}).from(i.userActivityLog).where((0,a.gte)(i.userActivityLog.createdAt,l)).orderBy((0,o.desc)(i.userActivityLog.createdAt)).limit(2e4),n.drizzleDb.select({id:i.securityEvent.id,eventType:i.securityEvent.eventType,ip:i.securityEvent.ip,severity:i.securityEvent.severity,createdAt:i.securityEvent.createdAt,action:i.securityEvent.action}).from(i.securityEvent).where((0,a.gte)(i.securityEvent.createdAt,l)).orderBy((0,o.desc)(i.securityEvent.createdAt)).limit(5e3),n.drizzleDb.select({id:i.payment.id,status:i.payment.status,amount:i.payment.amount,createdAt:i.payment.createdAt,paidAt:i.payment.paidAt}).from(i.payment).where((0,a.gte)(i.payment.createdAt,l)),n.drizzleDb.select({id:i.refund.id,status:i.refund.status,amount:i.refund.amount,createdAt:i.refund.createdAt}).from(i.refund).where((0,a.gte)(i.refund.createdAt,l)),n.drizzleDb.select({id:i.liveSession.id,status:i.liveSession.status,startedAt:i.liveSession.startedAt,endedAt:i.liveSession.endedAt}).from(i.liveSession).where((0,a.gte)(i.liveSession.startedAt,l)),n.drizzleDb.select({sessionId:i.sessionParticipant.sessionId,studentId:i.sessionParticipant.studentId,joinedAt:i.sessionParticipant.joinedAt}).from(i.sessionParticipant).where((0,a.gte)(i.sessionParticipant.joinedAt,l)),n.drizzleDb.select({id:i.taskSubmission.id,studentId:i.taskSubmission.studentId,submittedAt:i.taskSubmission.submittedAt,score:i.taskSubmission.score}).from(i.taskSubmission).where((0,a.gte)(i.taskSubmission.submittedAt,l)),n.drizzleDb.select({id:i.quizAttempt.id,studentId:i.quizAttempt.studentId,startedAt:i.quizAttempt.startedAt,score:i.quizAttempt.score}).from(i.quizAttempt).where((0,a.gte)(i.quizAttempt.startedAt,l)),n.drizzleDb.select({id:i.videoWatchEvent.id,studentId:i.videoWatchEvent.studentId,createdAt:i.videoWatchEvent.createdAt}).from(i.videoWatchEvent).where((0,a.gte)(i.videoWatchEvent.createdAt,l)),n.drizzleDb.select({id:i.curriculumLessonProgress.id,studentId:i.curriculumLessonProgress.studentId,updatedAt:i.curriculumLessonProgress.updatedAt,status:i.curriculumLessonProgress.status}).from(i.curriculumLessonProgress).where((0,a.gte)(i.curriculumLessonProgress.updatedAt,l)),n.drizzleDb.select({id:i.poll.id,status:i.poll.status,createdAt:i.poll.createdAt,totalResponses:i.poll.totalResponses}).from(i.poll).where((0,a.gte)(i.poll.createdAt,l)),n.drizzleDb.select({id:i.whiteboardSession.id,roomId:i.whiteboardSession.roomId,startedAt:i.whiteboardSession.startedAt}).from(i.whiteboardSession).where((0,a.gte)(i.whiteboardSession.startedAt,l))]),L=d[0]?.count??0,x=c[0]?.count??0,T=p.length,q=h[0]?.count??0,N=g[0]?.count??0,O=m[0]?.count??0,_=A[0]?.count??0,M=new Date(l);M.setDate(M.getDate()-r);let[U]=await n.drizzleDb.select({count:u.sql`count(*)::int`}).from(i.user).where((0,a.and)((0,a.gte)(i.user.createdAt,M),(0,a.lt)(i.user.createdAt,l))),k=U?.count??0,H=k>0?(x-k)/k*100:0,j=Array.from({length:r},(e,t)=>{let s=new Date;return s.setHours(0,0,0,0),s.setDate(s.getDate()-(r-1-t)),s}),B=e=>{let t=new Date(e);return t.setHours(0,0,0,0),t.toISOString().slice(0,10)},F=new Map;for(let e of j)F.set(e.toISOString().slice(0,10),new Set);for(let e of v){let t=B(e.createdAt),r=F.get(t);r&&r.add(e.userId)}let K=j.map(e=>{let t=e.toISOString().slice(0,10);return{date:t,activeUsers:F.get(t)?.size??0}}),W=new Map;for(let e of v)W.set(e.action,(W.get(e.action)||0)+1);let $=Array.from(W.entries()).sort((e,t)=>t[1]-e[1]).slice(0,10).map(([e,t])=>({action:e,count:t})),G=w.filter(e=>"COMPLETED"===e.status),V=w.filter(e=>"PENDING"===e.status||"PROCESSING"===e.status),X=w.filter(e=>"REFUNDED"===e.status),Q=w.reduce((e,t)=>e+(t.amount||0),0),Y=w.length>0?G.length/w.length*100:0,Z=w.length>0?X.length/w.length*100:0,J=y.filter(e=>e.eventType?.toLowerCase().includes("auth_failed")||e.action?.toLowerCase().includes("login_failed")),ee=y.filter(e=>"critical"===(e.severity||"").toLowerCase()),et=new Set(J.map(e=>e.ip).filter(e=>!!e)),er=new Map;for(let e of b)er.has(e.sessionId)||er.set(e.sessionId,new Set),er.get(e.sessionId)?.add(e.studentId);let es=E.length>0?E.reduce((e,t)=>e+(er.get(t.id)?.size||0),0)/E.length:0,en=new Set;for(let e of S)en.add(e.studentId);for(let e of z)en.add(e.studentId);for(let e of C)en.add(e.studentId);for(let e of I)en.add(e.studentId);let ei=[{feature:"Live Sessions",usageCount:E.length},{feature:"Polls",usageCount:D.length},{feature:"Whiteboard Sessions",usageCount:P.length},{feature:"Task Submissions",usageCount:S.length},{feature:"Quiz Attempts",usageCount:z.length},{feature:"Video Learning",usageCount:C.length},{feature:"Lesson Progress Updates",usageCount:I.length},{feature:"Payments Initiated",usageCount:w.length},{feature:"Refund Requests",usageCount:R.length}],ea=new Set(G.map(e=>{let t=v.find(t=>t.createdAt<=(e.createdAt??new Date(0)));return t?.userId}).filter(e=>!!e)).size,eo={registrations:x,activeUsers:T,learningActiveUsers:en.size,payingUsers:ea},eu={featureUsage:ei,userAnalytics:{dauTrend:K,topActions:$,averageActionsPerActiveUser:T>0?Math.round(v.length/T*100)/100:0},paymentAnalytics:{totalPayments:w.length,paymentVolume:Math.round(100*Q)/100,paymentSuccessRate:Math.round(100*Y)/100,refundRate:Math.round(100*Z)/100,pendingPayments:V.length},liveClassAnalytics:{sessionsCreated:E.length,avgParticipantsPerSession:Math.round(100*es)/100,pollResponses:D.reduce((e,t)=>e+(t.totalResponses||0),0),whiteboardSessions:P.length},securityAnalytics:{failedLogins:J.length,criticalEvents:ee.length,suspiciousIpCount:et.size},funnel:eo};return s.NextResponse.json({summary:{totalUsers:L,newUsers:x,activeUsers:T,userGrowthRate:Math.round(100*H)/100,totalSessions:q,totalContentItems:N,totalEnrollments:O,recentLogins:_},usersByRole:f.map(e=>({role:e.role,count:e.count})),enterprise:eu})}catch(e){return console.error("Error fetching analytics:",e),s.NextResponse.json({error:"Failed to fetch analytics"},{status:500})}}[n,l]=c.then?(await c)():c,e.s(["GET",()=>p]),r()}catch(e){r(e)}},!1),914808,e=>e.a(async(t,r)=>{try{var s=e.i(78315),n=e.i(586961),i=e.i(196657),a=e.i(899733),o=e.i(233979),u=e.i(631683),l=e.i(840960),d=e.i(711373),c=e.i(699699),p=e.i(521140),h=e.i(205260),g=e.i(500249),m=e.i(431740),A=e.i(82608),f=e.i(635207),v=e.i(193695);e.i(708038);var y=e.i(447430),w=e.i(343260),R=t([w]);[w]=R.then?(await R)():R;let S=new s.AppRouteRouteModule({definition:{kind:n.RouteKind.APP_ROUTE,page:"/api/admin/analytics/overview/route",pathname:"/api/admin/analytics/overview",filename:"route",bundlePath:""},distDir:".next",relativeProjectDir:"",resolvedPagePath:"[project]/ADK_WORKSPACE/TutorMekimi/tutorme-app/src/app/api/admin/analytics/overview/route.ts",nextConfigOutput:"",userland:w}),{workAsyncStorage:z,workUnitAsyncStorage:C,serverHooks:I}=S;function E(){return(0,i.patchFetch)({workAsyncStorage:z,workUnitAsyncStorage:C})}async function b(e,t,r){S.isDev&&(0,a.addRequestMeta)(e,"devRequestTimingInternalsEnd",process.hrtime.bigint());let s="/api/admin/analytics/overview/route";s=s.replace(/\/index$/,"")||"/";let i=await S.prepare(e,t,{srcPage:s,multiZoneDraftMode:!1});if(!i)return t.statusCode=400,t.end("Bad Request"),null==r.waitUntil||r.waitUntil.call(r,Promise.resolve()),null;let{buildId:w,params:R,nextConfig:E,parsedUrl:b,isDraftMode:z,prerenderManifest:C,routerServerContext:I,isOnDemandRevalidate:D,revalidateOnlyGenerated:P,resolvedPathname:L,clientReferenceManifest:x,serverActionsManifest:T}=i,q=(0,l.normalizeAppPath)(s),N=!!(C.dynamicRoutes[q]||C.routes[L]),O=async()=>((null==I?void 0:I.render404)?await I.render404(e,t,b,!1):t.end("This page could not be found"),null);if(N&&!z){let e=!!C.routes[L],t=C.dynamicRoutes[q];if(t&&!1===t.fallback&&!e){if(E.experimental.adapterPath)return await O();throw new v.NoFallbackError}}let _=null;!N||S.isDev||z||(_=L,_="/index"===_?"/":_);let M=!0===S.isDev||!N,U=N&&!M;T&&x&&(0,u.setManifestsSingleton)({page:s,clientReferenceManifest:x,serverActionsManifest:T});let k=e.method||"GET",H=(0,o.getTracer)(),j=H.getActiveScopeSpan(),B={params:R,prerenderManifest:C,renderOpts:{experimental:{authInterrupts:!!E.experimental.authInterrupts},cacheComponents:!!E.cacheComponents,supportsDynamicResponse:M,incrementalCache:(0,a.getRequestMeta)(e,"incrementalCache"),cacheLifeProfiles:E.cacheLife,waitUntil:r.waitUntil,onClose:e=>{t.on("close",e)},onAfterTaskError:void 0,onInstrumentationRequestError:(t,r,s,n)=>S.onRequestError(e,t,s,n,I)},sharedContext:{buildId:w}},F=new d.NodeNextRequest(e),K=new d.NodeNextResponse(t),W=c.NextRequestAdapter.fromNodeNextRequest(F,(0,c.signalFromNodeResponse)(t));try{let i=async e=>S.handle(W,B).finally(()=>{if(!e)return;e.setAttributes({"http.status_code":t.statusCode,"next.rsc":!1});let r=H.getRootSpanAttributes();if(!r)return;if(r.get("next.span_type")!==p.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${r.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let n=r.get("next.route");if(n){let t=`${k} ${n}`;e.setAttributes({"next.route":n,"http.route":n,"next.span_name":t}),e.updateName(t)}else e.updateName(`${k} ${s}`)}),u=!!(0,a.getRequestMeta)(e,"minimalMode"),l=async a=>{var o,l;let d=async({previousCacheEntry:n})=>{try{if(!u&&D&&P&&!n)return t.statusCode=404,t.setHeader("x-nextjs-cache","REVALIDATED"),t.end("This page could not be found"),null;let s=await i(a);e.fetchMetrics=B.renderOpts.fetchMetrics;let o=B.renderOpts.pendingWaitUntil;o&&r.waitUntil&&(r.waitUntil(o),o=void 0);let l=B.renderOpts.collectedTags;if(!N)return await (0,g.sendResponse)(F,K,s,B.renderOpts.pendingWaitUntil),null;{let e=await s.blob(),t=(0,m.toNodeOutgoingHttpHeaders)(s.headers);l&&(t[f.NEXT_CACHE_TAGS_HEADER]=l),!t["content-type"]&&e.type&&(t["content-type"]=e.type);let r=void 0!==B.renderOpts.collectedRevalidate&&!(B.renderOpts.collectedRevalidate>=f.INFINITE_CACHE)&&B.renderOpts.collectedRevalidate,n=void 0===B.renderOpts.collectedExpire||B.renderOpts.collectedExpire>=f.INFINITE_CACHE?void 0:B.renderOpts.collectedExpire;return{value:{kind:y.CachedRouteKind.APP_ROUTE,status:s.status,body:Buffer.from(await e.arrayBuffer()),headers:t},cacheControl:{revalidate:r,expire:n}}}}catch(t){throw(null==n?void 0:n.isStale)&&await S.onRequestError(e,t,{routerKind:"App Router",routePath:s,routeType:"route",revalidateReason:(0,h.getRevalidateReason)({isStaticGeneration:U,isOnDemandRevalidate:D})},!1,I),t}},c=await S.handleResponse({req:e,nextConfig:E,cacheKey:_,routeKind:n.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:C,isRoutePPREnabled:!1,isOnDemandRevalidate:D,revalidateOnlyGenerated:P,responseGenerator:d,waitUntil:r.waitUntil,isMinimalMode:u});if(!N)return null;if((null==c||null==(o=c.value)?void 0:o.kind)!==y.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==c||null==(l=c.value)?void 0:l.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});u||t.setHeader("x-nextjs-cache",D?"REVALIDATED":c.isMiss?"MISS":c.isStale?"STALE":"HIT"),z&&t.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let p=(0,m.fromNodeOutgoingHttpHeaders)(c.value.headers);return u&&N||p.delete(f.NEXT_CACHE_TAGS_HEADER),!c.cacheControl||t.getHeader("Cache-Control")||p.get("Cache-Control")||p.set("Cache-Control",(0,A.getCacheControlHeader)(c.cacheControl)),await (0,g.sendResponse)(F,K,new Response(c.value.body,{headers:p,status:c.value.status||200})),null};j?await l(j):await H.withPropagatedContext(e.headers,()=>H.trace(p.BaseServerSpan.handleRequest,{spanName:`${k} ${s}`,kind:o.SpanKind.SERVER,attributes:{"http.method":k,"http.target":e.url}},l))}catch(t){if(t instanceof v.NoFallbackError||await S.onRequestError(e,t,{routerKind:"App Router",routePath:q,routeType:"route",revalidateReason:(0,h.getRevalidateReason)({isStaticGeneration:U,isOnDemandRevalidate:D})},!1,I),N)throw t;return await (0,g.sendResponse)(F,K,new Response(null,{status:500})),null}}e.s(["handler",()=>b,"patchFetch",()=>E,"routeModule",()=>S,"serverHooks",()=>I,"workAsyncStorage",()=>z,"workUnitAsyncStorage",()=>C]),r()}catch(e){r(e)}},!1)];

//# debugId=07d5b5e2-0fcc-9866-4b16-c8c3729f6ca8
//# sourceMappingURL=ADK_WORKSPACE_TutorMekimi_tutorme-app_4088972f._.js.map