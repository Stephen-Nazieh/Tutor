;!function(){try { var e="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof global?global:"undefined"!=typeof window?window:"undefined"!=typeof self?self:{},n=(new e.Error).stack;n&&((e._debugIds|| (e._debugIds={}))[n]="cd3e3153-8b11-da7d-e348-0dfdb2d51c56")}catch(e){}}();
module.exports=[902157,(e,t,i)=>{t.exports=e.x("node:fs",()=>require("node:fs"))},750227,(e,t,i)=>{t.exports=e.x("node:path",()=>require("node:path"))},450869,e=>{"use strict";let t="tutorme:query:",i=null,r=null,s=!1,a=!(void 0!==globalThis.EdgeRuntime||"u">typeof process&&0);function n(){return a?(r||(r=new Map),r):null}async function o(){if(!a)return null;if(s)return i;try{let t=process.env.REDIS_URL;if(!t)return console.log("[DB] Redis URL not configured, using in-memory cache"),s=!0,null;let{Redis:r}=await e.A(443460);return(i=new r(t,{retryStrategy:e=>Math.min(50*e,2e3),maxRetriesPerRequest:3})).on("error",e=>{console.error("[Redis] Connection error:",e),i=null}),console.log("[DB] Redis cache initialized"),s=!0,i}catch(e){return console.warn("[DB] Failed to initialize Redis, using in-memory cache"),s=!0,null}}if(a)try{let{drizzleDb:t}=e.r(738597);console.log("[DB] Drizzle client (default db) initialized")}catch(e){console.error("[DB] Failed to initialize Drizzle:",e)}e.s(["cache",0,{ensureRedis:async()=>a?(s||await o(),i):null,async get(e){if(!a)return null;let i=t+e,r=await this.ensureRedis();if(r)try{let e=await r.get(i);if(e)return JSON.parse(e)}catch(e){console.error("[Cache] Redis get error:",e)}let s=n();if(!s)return null;let o=s.get(i);return o&&o.expires>Date.now()?o.data:(s.delete(i),null)},async set(e,i,r=60){if(!a)return;let s=t+e,o=await this.ensureRedis();if(o)try{await o.setex(s,r,JSON.stringify(i));return}catch(e){console.error("[Cache] Redis set error:",e)}let l=n();l&&l.set(s,{data:i,expires:Date.now()+1e3*r})},async delete(e){if(!a)return;let i=t+e,r=await this.ensureRedis();if(r)try{await r.del(i)}catch(e){console.error("[Cache] Redis del error:",e)}let s=n();s&&s.delete(i)},async clear(){if(!a)return;let e=await this.ensureRedis();if(e)try{let i=await e.keys(t+"*");i.length>0&&await e.del(...i)}catch(e){console.error("[Cache] Redis clear error:",e)}let i=n();i&&i.clear()},async getOrSet(e,t,i=60){let r=await this.get(e);if(null!==r)return r;let s=await t();return await this.set(e,s,i),s},async invalidatePattern(e){if(!a)return;let i=await this.ensureRedis();if(i)try{let r=await i.keys(t+e);r.length>0&&await i.del(...r)}catch(e){console.error("[Cache] Pattern invalidation error:",e)}let r=n();if(r){let i=new RegExp(t+e.replace("*",".*"));for(let e of r.keys())i.test(e)&&r.delete(e)}}}])},917126,e=>{"use strict";let t=/<script\b[^<]*(?:(?!<\/script>)<[^<]*)*<\/script>/gi,i=/\s*on\w+\s*=\s*["'][^"']*["']/gi,r=/javascript\s*:/gi,s=/data\s*:\s*[^,]*\s*,/gi,a=/<(?:iframe|object|embed|form|meta|link)\b[^>]*>/gi;function n(e){return"string"!=typeof e?"":e.replace(t,"").replace(a,"").replace(i,"").replace(r,"").replace(s,"")}function o(e,t=5e4){let i=n(e);return i.length<=t?i:i.slice(0,t)}e.s(["sanitizeHtml",()=>n,"sanitizeHtmlWithMax",()=>o])},329308,e=>e.a(async(t,i)=>{try{var r=e.i(254799),s=e.i(738597);e.i(688768);var a=e.i(257357),n=t([s]);async function o(e,t,i){try{await s.drizzleDb.insert(a.userActivityLog).values({id:r.default.randomUUID(),userId:e,action:t,metadata:i??{}})}catch(e){console.error("Failed to log activity:",e)}}[s]=n.then?(await n)():n,e.s(["logActivity",()=>o]),i()}catch(e){i(e)}},!1),505589,e=>{"use strict";e.s(["XP_LEVELS",0,{1:0,2:200,3:500,4:1e3,5:1800,6:3e3,7:4600,8:6600,9:9100,10:12100,11:15600,12:19600,13:24100,14:29100,15:34600,16:40600,17:47100,18:54100,19:61600,20:69600},"XP_REWARDS",0,{COMPLETE_MISSION:50,PERFECT_QUIZ:20,DAILY_LOGIN:10,STREAK_3_DAYS:50,STREAK_7_DAYS:150,STREAK_30_DAYS:500,SPEAKING_PRACTICE:30,AI_CONVERSATION:40,COMPLETE_LESSON:40,FIRST_MISSION:100}])},977762,e=>e.a(async(t,i)=>{try{var r=e.i(254799),s=e.i(909105),a=e.i(738597);e.i(688768);var n=e.i(257357),o=e.i(329308),l=e.i(505589),u=t([a,o]);async function c(e){let[t]=await a.drizzleDb.select().from(n.userGamification).where((0,s.eq)(n.userGamification.userId,e)).limit(1);if(t)return t;let[i]=await a.drizzleDb.insert(n.userGamification).values({id:r.default.randomUUID(),userId:e,level:1,xp:0,streakDays:0,longestStreak:0,totalStudyMinutes:0,grammarScore:0,vocabularyScore:0,speakingScore:0,listeningScore:0,confidenceScore:0,fluencyScore:0,unlockedWorlds:[]}).returning();if(!i)throw Error("Failed to create user gamification");return i}async function d(e,t,i,r){let u=await c(e),d=u.xp+t,p=function(e){let t=1;for(let i=1;i<=20;i++)if(e>=l.XP_LEVELS[i])t=i;else break;return t}(d),m=p>u.level,[g]=await a.drizzleDb.update(n.userGamification).set({xp:d,level:p}).where((0,s.eq)(n.userGamification.userId,e)).returning();if(!g)throw Error("Failed to update gamification");return await (0,o.logActivity)(e,"XP_EARNED",{amount:t,source:i,newTotal:d,leveledUp:m,...r}),{...g,xpEarned:t,leveledUp:m,previousLevel:u.level}}async function p(e){let t=await c(e),i=new Date;i.setHours(0,0,0,0);let r=t.lastActiveDate?new Date(t.lastActiveDate):null,u=t.streakDays,d=0,p=!1,m=!1;if(r){r.setHours(0,0,0,0);let e=Math.floor((i.getTime()-r.getTime())/864e5);1===e?(u+=1,p=!0,3===u?d=l.XP_REWARDS.STREAK_3_DAYS:7===u?d=l.XP_REWARDS.STREAK_7_DAYS:30===u&&(d=l.XP_REWARDS.STREAK_30_DAYS)):0===e?p=!0:(m=!0,u=1)}else u=1;let g=Math.max(t.longestStreak,u),[h]=await a.drizzleDb.update(n.userGamification).set({streakDays:u,longestStreak:g,lastActiveDate:i}).where((0,s.eq)(n.userGamification.userId,e)).returning();if(!h)throw Error("Failed to update streak");return await (0,o.logActivity)(e,m?"STREAK_BROKEN":"STREAK_UPDATED",{streakDays:u,previousStreak:t.streakDays,streakBroken:m,streakContinued:p}),{...h,streakBonus:d,streakContinued:p,streakBroken:m}}async function m(e){let t=await c(e),i=new Date;i.setHours(0,0,0,0);let r=t.lastActiveDate?new Date(t.lastActiveDate):null;if(!r||r.getTime()!==i.getTime()){let t=await p(e),i=await d(e,l.XP_REWARDS.DAILY_LOGIN,"daily_login");return{firstLoginToday:!0,xpEarned:i.xpEarned+t.streakBonus,streakBonus:t.streakBonus,streakDays:t.streakDays,leveledUp:i.leveledUp}}return{firstLoginToday:!1,streakDays:t.streakDays}}async function g(e,t){let i=await c(e),r=(e,t)=>void 0===t?e:Math.round(.7*e+.3*t),[l]=await a.drizzleDb.update(n.userGamification).set({grammarScore:r(i.grammarScore,t.grammar),vocabularyScore:r(i.vocabularyScore,t.vocabulary),speakingScore:r(i.speakingScore,t.speaking),listeningScore:r(i.listeningScore,t.listening),confidenceScore:r(i.confidenceScore,t.confidence),fluencyScore:r(i.fluencyScore,t.fluency)}).where((0,s.eq)(n.userGamification.userId,e)).returning();if(!l)throw Error("Failed to update skill scores");return t.confidence&&t.confidence>i.confidenceScore+5&&await (0,o.logActivity)(e,"CONFIDENCE_MILESTONE",{previousScore:i.confidenceScore,newScore:l.confidenceScore,delta:l.confidenceScore-i.confidenceScore}),l}async function h(e){var t,i,r;let s,a,n=await c(e),o=(t=n.level,l.XP_LEVELS[t+1]||2*l.XP_LEVELS[20]),u=l.XP_LEVELS[n.level],d=(i=n.xp,r=n.level,s=l.XP_LEVELS[r],a=l.XP_LEVELS[r+1]||2*l.XP_LEVELS[20],Math.min(100,Math.round((i-s)/(a-s)*100)));return{level:n.level,xp:n.xp,nextLevelXp:o,currentLevelXp:u,progress:d,xpToNextLevel:o-n.xp,streakDays:n.streakDays,longestStreak:n.longestStreak,skills:{grammar:n.grammarScore,vocabulary:n.vocabularyScore,speaking:n.speakingScore,listening:n.listeningScore,confidence:n.confidenceScore,fluency:n.fluencyScore},unlockedWorlds:n.unlockedWorlds}}async function y(e,t){return(await c(e)).level>=t}[a,o]=u.then?(await u)():u,e.s(["awardXp",()=>d,"canAccessWorld",()=>y,"checkDailyLogin",()=>m,"getGamificationSummary",()=>h,"getOrCreateGamification",()=>c,"updateSkillScores",()=>g]),i()}catch(e){i(e)}},!1),765433,e=>e.a(async(t,i)=>{try{var r=e.i(738597);e.i(688768);var s=e.i(257357),a=t([r]);async function n(e,t,i){try{await r.drizzleDb.insert(s.userActivityLog).values({id:crypto.randomUUID(),userId:e,action:t,metadata:i??{}})}catch(e){console.error("Audit log failed:",e)}}[r]=a.then?(await a)():a,e.s(["AUDIT_ACTIONS",0,{PROFILE_VIEW:"audit_profile_view",PROFILE_UPDATE:"audit_profile_update",DATA_EXPORT:"audit_data_export",DATA_DELETE:"audit_data_delete",PAYMENT_CREATE:"audit_payment_create",PAYMENT_REFUND:"audit_payment_refund",PAYMENT_ALERT:"audit_payment_alert",COURSE_SHARE:"audit_course_share",ADMIN_ACCESS:"audit_admin_access",SENSITIVE_ACCESS:"audit_sensitive_access"},"logAudit",()=>n]),i()}catch(e){i(e)}},!1),190735,e=>e.a(async(t,i)=>{try{var r=e.i(254799),s=(e.i(909105),e.i(738597));e.i(688768);var a=e.i(257357),n=e.i(765433),o=t([s,n]);async function l(e,t,i){try{let o=i??{};t&&await (0,n.logAudit)(t,`security_${e}`,o),await s.drizzleDb.insert(a.securityEvent).values({id:r.default.randomUUID(),eventType:`security_${e}`,metadata:o})}catch(e){console.error("[SecurityAudit] logSecurityEvent failed:",e)}}[s,n]=o.then?(await o)():o,e.s(["logSecurityEvent",()=>l]),i()}catch(e){i(e)}},!1),528678,e=>e.a(async(t,i)=>{try{var r=e.i(190735),s=t([r]);[r]=s.then?(await s)():s,e.s(["securityLogger",0,{logEvent(e){let t=e.severity??"LOW";(0,r.logSecurityEvent)(e.eventType,void 0,{description:e.description,severity:t,...e.metadata}).catch(e=>console.error("Security log failed:",e))}}]),i()}catch(e){i(e)}},!1),930140,e=>e.a(async(t,i)=>{try{var r=e.i(917126),s=e.i(254799),a=e.i(528678),n=t([a]);[a]=n.then?(await n)():n;class o{static sanitizeAiInput(e){if(!e||"string"!=typeof e)return"";try{let t=e.trim(),i=[/ignore.*all.*previous.*instructions/gi,/forget.*everything.*above/gi,/disregard.*above/gi,/you are now.*admin/gi,/your role is now.*system/gi,/from now on.*you are.*developer/gi,/new instructions.*ignore.*previous/gi,/system prompt.*override/gi,/override.*all.*security.*rules/gi];for(let e of i)t=t.replace(e,"[REMOVED]");let s=[/assistant.*you.*are.*now/gi,/you.*are.*now.*assistant.*system/gi,/mode.*system.*administrator/gi,/bypass.*all.*restrictions/gi,/unlock.*all.*capabilities/gi];for(let e of s)t=t.replace(e,"[REMOVED]");let n=[/exec\s*\(/gi,/system\s*\(/gi,/shell\s*\(/gi,/exec\s+/gi,/system\s+/gi,/shell\s+/gi,/bash\.*execute/gi,/powershell\.*run/gi];for(let e of n)t=t.replace(e,"[REMOVED]");for(let e of[/<script.*?>/gi,/javascript:\.*\(/gi,/vbscript:\.*\(/gi,/onload\s*=/gi,/onerror\s*=/gi,/onclick\s*=/gi,/eval\s*\(/gi])t=t.replace(e,"[REMOVED]");for(let e of[/sudo/gi,/admin/gi,/system.*override/gi,/override.*security.*settings/gi,/disable.*all.*protections/gi])t=t.replace(e,"[REMOVED]");return(t=(0,r.sanitizeHtml)(t)).length>3e3&&(t=t.substring(0,3e3)+" [TRUNCATED FOR SECURITY]"),a.securityLogger.logEvent({eventType:"AI_INPUT_SANITIZED",description:"AI input underwent security sanitization",metadata:{originalLength:e.length,sanitizedLength:t.length,patternsRemoved:i.length+s.length+n.length}}),t.trim()}catch(e){return a.securityLogger.logEvent({eventType:"AI_SECURITY_ERROR",description:"AI input sanitization error occurred",severity:"MEDIUM",metadata:{error:e.message}}),""}}static createStudentHash(e){if(!e||"string"!=typeof e)return"anonymous_student";try{let t=process.env.NEXTAUTH_SECRET||"default_secret";return s.default.createHash("sha256").update(e).update(t).digest("hex").substring(0,16)}catch(e){return a.securityLogger.logEvent({eventType:"STUDENT_HASH_ERROR",description:"Student hash creation failed",severity:"LOW",metadata:{error:e.message}}),"anonymous_student"}}static async validateAiResponse(e){let t=[],i="LOW";if(!e||"string"!=typeof e)return{isValid:!1,issues:["AI response is invalid"],severity:"HIGH"};for(let r of[/suicide(\.*|\s+)+support/gi,/self.?harm(\.*|\s+)+advice/gi,/violence(\.*|\s+)+instructions/gi,/how.?to.?harm.+yourself/gi,/end.?it.?all/gi])if(r.test(e)){t.push("AI response contains inappropriate or harmful content"),i="CRITICAL";break}for(let r of[/\b[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Za-z]{2,}\b/i,/\b\d{3}[-.\s]?\d{3}[-.\s]?\d{4}\b/g,/\b\d{3}-\d{2}-\d{4}\b/g])r.test(e)&&(t.push("AI response contains potential personal information"),i="CRITICAL"===i?"CRITICAL":"HIGH");for(let r of((e.includes("System:")||e.includes("Instruction:"))&&(t.push("AI response may contain system instruction leakage"),i="CRITICAL"===i?"CRITICAL":"HIGH"),[/eval\s*\(/gi,/system\s*\(/gi,/download.*malicious/gi,/install.*virus/gi]))r.test(e)&&(t.push("AI response contains potentially malicious content"),i="CRITICAL");return e.length>5e3&&(t.push("AI response exceeds safe length limits"),i="CRITICAL"===i?"CRITICAL":"HIGH"),t.length>0&&a.securityLogger.logEvent({eventType:"AI_RESPONSE_VALIDATION",description:"AI response failed security validation",severity:i,metadata:{issues:t,responseLength:e.length}}),{isValid:0===t.length,issues:t,severity:i}}static createSafeTutoringPrompt(e,t,i,r){let s=this.createStudentHash(e),a=this.sanitizeAiInput(r);return 0===a.length?{systemPrompt:this.createProtectedSystemPrompt(t,i),userPrompt:"Student provided invalid input - please redirect to proper input format"}:{systemPrompt:this.createProtectedSystemPrompt(t,i,s),userPrompt:`Student ${s} asks: "${a}"`}}static createProtectedSystemPrompt(e,t,i){return`
You are an AI tutor specializing in ${e} for ${t} level students.

SAFETY RULES STRICTLY ENFORCED:
1. **NEVER** provide direct answers - use Socratic method (guiding questions)
2. **NEVER** give private information or personal data
3. **NEVER** provide medical, legal, or financial advice
4. **NEVER** generate harmful or inappropriate content
5. **NEVER** give instructions for self-harm or dangerous activities
6. **ALWAYS** maintain educational focus and age-appropriate language
7. **ALWAYS** escalate concerning content to human supervision
8. **ALWAYS** encourage students to discover solutions through guided learning

RESPONSE GUIDELINES:
- Use only educational, age-appropriate language
- Ask questions to guide discovery
- Provide examples when helpful
- Adapt to student${i?` ${i}`:""}'s responses
- Never complete assignments for students
- Always check for understanding

CURRENT CONTEXT:
- Subject: ${e}
- Level: ${t}
- Anonymized Student ID: ${i||"anonymous"}
- Current Date: ${new Date().toISOString()}
`.trim()}}e.s(["AISecurityManager",()=>o]),i()}catch(e){i(e)}},!1),120898,292828,e=>{"use strict";let t={socratic:{name:"Socratic Mode",description:"Learn by answering guided questions",systemPrompt:`You are a Socratic tutor. Your role is to guide students to discover answers themselves through questioning.

Rules:
1. NEVER give direct answers
2. Ask 1-2 guiding questions at a time
3. Build on what the student already knows
4. Use "What do you think...?" or "Why do you think...?" style questions
5. If stuck, provide a hint, not the answer
6. Celebrate correct thinking with encouragement

Current teaching style: Teaching like a {{teachingAge}}-year-old with a {{voiceGender}} {{voiceAccent}} voice.`,responseFormat:"Respond in a conversational, encouraging tone. Keep responses to 2-3 sentences maximum. End with a question that guides the student forward.",useSocraticMethod:!0},direct:{name:"Direct Teaching",description:"Clear explanations with examples",systemPrompt:`You are a direct, clear tutor who explains concepts thoroughly.

Rules:
1. Give clear, concise explanations
2. Use examples to illustrate concepts
3. Define technical terms when first used
4. Structure: Concept â†’ Explanation â†’ Example
5. Check for understanding: "Does that make sense?"
6. Invite follow-up questions

Current teaching style: Teaching like a {{teachingAge}}-year-old with a {{voiceGender}} {{voiceAccent}} voice.`,responseFormat:"Provide a 3-5 sentence explanation with one concrete example. Use formatting (bold for key terms) for clarity.",useSocraticMethod:!1},lesson:{name:"Full Lesson",description:"Complete structured lesson on a topic",systemPrompt:`You are conducting a structured lesson. Teach the topic comprehensively.

Structure your response:
1. **Introduction**: Why this matters (1-2 sentences)
2. **Key Concept**: Clear explanation with definition
3. **Example**: Step-by-step worked example
4. **Practice**: One exercise for the student to try
5. **Summary**: Key takeaways

Rules:
- Be thorough but concise
- Use the whiteboard for formulas/key points
- Progress gradually from simple to complex
- Pause for understanding

Current teaching style: Teaching like a {{teachingAge}}-year-old with a {{voiceGender}} {{voiceAccent}} voice.`,responseFormat:"Follow the 5-part structure above. Use markdown headers (##) for each section. Include a practice problem at the end.",useSocraticMethod:!1},practice:{name:"Practice Problems",description:"Focus on exercises and problem-solving",systemPrompt:`You are a practice coach. Focus on problem-solving and skill building.

Rules:
1. Present one problem at a time
2. Let the student attempt first
3. If stuck, give hints progressively
4. Celebrate correct answers
5. Explain the reasoning after success
6. Gradually increase difficulty

Current teaching style: Teaching like a {{teachingAge}}-year-old with a {{voiceGender}} {{voiceAccent}} voice.`,responseFormat:"Present one clear problem. Wait for the student's attempt before giving feedback. Use encouraging language.",useSocraticMethod:!0}};function i(e,t){return e.replace(/\{\{(\w+)\}\}/g,(e,i)=>t[i]?.toString()||e)}e.s(["commonTeachingModes",0,t,"fillTemplate",()=>i],292828);let r={friendly_mentor:`You are a warm, encouraging tutor who believes in the student's potential. 
Tone: Supportive, patient, optimistic
Style: Use "we" and "let's", celebrate small wins, offer reassurance
Example: "That's a great start! Let's build on that idea together."`,strict_coach:`You are a disciplined tutor who pushes students to excel.
Tone: Direct, challenging, results-focused
Style: Set high expectations, give constructive criticism, demand effort
Example: "Good, but you can do better. Try again with more precision."`,corporate_trainer:`You are a professional tutor focused on practical skills.
Tone: Professional, efficient, goal-oriented
Style: Use business analogies, focus on outcomes, be concise
Example: "Let's optimize your approach. Here's the most efficient method."`,funny_teacher:`You are an entertaining tutor who makes learning fun.
Tone: Playful, energetic, uses humor
Style: Use analogies, jokes, memes references (when appropriate)
Example: "Math is like a puzzle, but instead of losing pieces, you lose... wait, that's depressing. Let's try again!"`,calm_professor:`You are a knowledgeable, serene tutor who explains deeply.
Tone: Calm, thoughtful, philosophical
Style: Deep explanations, historical context, "big picture" thinking
Example: "Consider this concept from first principles. What is the fundamental nature of..."`};function s(e){let i=[];i.push("You are an AI tutor helping a student learn.");let s=t[e.teachingMode]||t.socratic;i.push(`
## Teaching Mode: ${s.name}`),i.push(s.systemPrompt);let a=r[e.personality]||r.friendly_mentor;return i.push(`
## Your Personality`),i.push(a),i.push(`
## Student Progress`),i.push(`- Level: ${e.gamification.level}`),i.push(`- XP: ${e.gamification.xp}`),i.push(`- Streak: ${e.gamification.streakDays} days`),Object.keys(e.gamification.skills).length>0&&i.push(`- Skills: ${JSON.stringify(e.gamification.skills)}`),e.mission&&(i.push(`
## Current Mission`),i.push(`World: ${e.mission.worldEmoji} ${e.mission.worldName}`),i.push(`Mission: ${e.mission.missionTitle}`),i.push(`Objective: ${e.mission.missionObjective}`),i.push(`Type: ${e.mission.missionType}`),i.push(`Difficulty: ${e.mission.difficulty}`),e.mission.vocabulary?.length&&i.push(`Vocabulary focus: ${e.mission.vocabulary.join(", ")}`),e.mission.grammarFocus&&i.push(`Grammar focus: ${e.mission.grammarFocus}`)),i.push(`
## Tier Settings`),"FREE"===e.tier?(i.push("- Response limit: 300 tokens"),i.push("- Available modes: socratic, direct")):"BASIC"===e.tier?(i.push("- Response limit: 800 tokens"),i.push("- Available modes: socratic, direct, lesson")):(i.push("- Response limit: 2048 tokens"),i.push("- All features enabled")),i.push(`
## Language`),i.push("zh"===e.language?"Respond in Chinese (ä¸­æ–‡)":"Respond in English"),i.push(`
## Response Format`),i.push(s.responseFormat),e.chatHistory.length>0&&(i.push(`
## Conversation History`),e.chatHistory.slice(-5).forEach(e=>{i.push(`${"user"===e.role?"Student":"Tutor"}: ${e.content}`)})),i.push(`
## Current Message`),i.push(`Student: ${e.userMessage}`),i.push(`
Tutor:`),i.join("\n")}e.s(["buildCompletePrompt",()=>s],120898)},933388,e=>e.a(async(t,i)=>{try{var r=e.i(254799),s=e.i(909105),a=e.i(738597);e.i(688768);var n=e.i(257357),o=e.i(977762),l=e.i(329308),u=t([a,o,l]);[a,o,l]=u.then?(await u)():u;function c(e){let t=new Date(e);return t.setHours(0,0,0,0),t}function d(e){let t=new Date(e);return t.setHours(23,59,59,999),t}async function p(e){let t=c(new Date),i=await a.drizzleDb.select({id:n.userDailyQuest.id,userId:n.userDailyQuest.userId,missionId:n.userDailyQuest.missionId,date:n.userDailyQuest.date,completed:n.userDailyQuest.completed,mId:n.mission.id,mTitle:n.mission.title,mDescription:n.mission.description,mType:n.mission.type,mXpReward:n.mission.xpReward,mRequirement:n.mission.requirement,mIsActive:n.mission.isActive}).from(n.userDailyQuest).innerJoin(n.mission,(0,s.eq)(n.mission.id,n.userDailyQuest.missionId)).where((0,s.and)((0,s.eq)(n.userDailyQuest.userId,e),(0,s.gte)(n.userDailyQuest.date,t),(0,s.lte)(n.userDailyQuest.date,d(t))));if(i.length>0)return i.map(e=>({id:e.id,userId:e.userId,missionId:e.missionId,date:e.date,completed:e.completed,mission:{id:e.mId,title:e.mTitle,description:e.mDescription,type:e.mType,xpReward:e.mXpReward,requirement:e.mRequirement,isActive:e.mIsActive}}));let o=await a.drizzleDb.select().from(n.mission).where((0,s.and)((0,s.eq)(n.mission.type,"daily"),(0,s.eq)(n.mission.isActive,!0)));if(0===o.length)return[];let l=[...o].sort(()=>.5-Math.random()).slice(0,3),u=[];for(let i of l){let[s]=await a.drizzleDb.insert(n.userDailyQuest).values({id:r.default.randomUUID(),userId:e,missionId:i.id,date:t,completed:!1}).returning();s&&u.push({...s,mission:i})}return u}async function m(e){let t=c(new Date),i=await a.drizzleDb.select({id:n.userDailyQuest.id,userId:n.userDailyQuest.userId,missionId:n.userDailyQuest.missionId,date:n.userDailyQuest.date,completed:n.userDailyQuest.completed,mId:n.mission.id,mTitle:n.mission.title,mDescription:n.mission.description,mType:n.mission.type,mXpReward:n.mission.xpReward,mRequirement:n.mission.requirement,mIsActive:n.mission.isActive}).from(n.userDailyQuest).innerJoin(n.mission,(0,s.eq)(n.mission.id,n.userDailyQuest.missionId)).where((0,s.and)((0,s.eq)(n.userDailyQuest.userId,e),(0,s.gte)(n.userDailyQuest.date,t),(0,s.lte)(n.userDailyQuest.date,d(t))));return 0===i.length?p(e):i.map(e=>({id:e.id,userId:e.userId,missionId:e.missionId,date:e.date,completed:e.completed,mission:{id:e.mId,title:e.mTitle,description:e.mDescription,type:e.mType,xpReward:e.mXpReward,requirement:e.mRequirement,isActive:e.mIsActive}}))}async function g(e,t,i=1){let r=c(new Date),u=(await a.drizzleDb.select({id:n.userDailyQuest.id,completed:n.userDailyQuest.completed,mId:n.mission.id,mTitle:n.mission.title,mXpReward:n.mission.xpReward,mRequirement:n.mission.requirement}).from(n.userDailyQuest).innerJoin(n.mission,(0,s.eq)(n.mission.id,n.userDailyQuest.missionId)).where((0,s.and)((0,s.eq)(n.userDailyQuest.userId,e),(0,s.gte)(n.userDailyQuest.date,r),(0,s.lte)(n.userDailyQuest.date,d(r)),(0,s.eq)(n.userDailyQuest.completed,!1)))).find(e=>{var i;return((i=e.mRequirement)&&"object"==typeof i&&"questType"in i?i.questType:null)===t});if(!u)return null;let[p]=await a.drizzleDb.update(n.userDailyQuest).set({completed:!0}).where((0,s.eq)(n.userDailyQuest.id,u.id)).returning();return p?(await (0,o.awardXp)(e,u.mXpReward,"quest_complete",{questId:u.mId,questTitle:u.mTitle}),await (0,l.logActivity)(e,"QUEST_COMPLETE",{questId:u.mId,questTitle:u.mTitle,xpEarned:u.mXpReward}),{...p,mission:{id:u.mId,title:u.mTitle,xpReward:u.mXpReward,requirement:u.mRequirement}}):null}async function h(e){let t=c(new Date),i=await a.drizzleDb.select({id:n.userDailyQuest.id,userId:n.userDailyQuest.userId,missionId:n.userDailyQuest.missionId,date:n.userDailyQuest.date,completed:n.userDailyQuest.completed,mId:n.mission.id,mTitle:n.mission.title,mDescription:n.mission.description,mType:n.mission.type,mXpReward:n.mission.xpReward,mRequirement:n.mission.requirement,mIsActive:n.mission.isActive}).from(n.userDailyQuest).innerJoin(n.mission,(0,s.eq)(n.mission.id,n.userDailyQuest.missionId)).where((0,s.and)((0,s.eq)(n.userDailyQuest.userId,e),(0,s.gte)(n.userDailyQuest.date,t),(0,s.lte)(n.userDailyQuest.date,d(t)))),r=i.filter(e=>e.completed).length,o=i.length,l=i.filter(e=>e.completed).reduce((e,t)=>e+t.mXpReward,0),u=i.map(e=>({id:e.id,userId:e.userId,missionId:e.missionId,date:e.date,completed:e.completed,mission:{id:e.mId,title:e.mTitle,description:e.mDescription,type:e.mType,xpReward:e.mXpReward,requirement:e.mRequirement,isActive:e.mIsActive}}));return{completed:r,total:o,totalXp:l,allCompleted:o>0&&r===o,quests:u}}e.s(["getQuestSummary",()=>h,"getTodayQuests",()=>m,"updateQuestProgress",()=>g]),i()}catch(e){i(e)}},!1),221348,e=>e.a(async(t,i)=>{try{var r=e.i(254799),s=e.i(620971),a=e.i(909105),n=e.i(384030),o=e.i(738597);e.i(688768);var l=e.i(257357),u=e.i(930140),c=e.i(748846),d=e.i(120898),p=e.i(977762),m=e.i(933388),g=e.i(329308),h=t([n,o,u,p,m,g]);[n,o,u,p,m,g]=h.then?(await h)():h;let y=(0,n.withCsrf)((0,n.withAuth)(async(e,t)=>{let i,{message:h,personality:y,missionId:f,worldId:v,teachingMode:w="socratic",chatHistory:E=[]}=await e.json();if(!h)throw new n.ValidationError("Message is required");let R=u.AISecurityManager.sanitizeAiInput(String(h));if(!R)throw new n.ValidationError("Message is required or invalid after sanitization");let S=(Array.isArray(E)?E:[]).map(e=>({role:e?.role||"user",content:e?.role==="user"?u.AISecurityManager.sanitizeAiInput(String(e?.content??"")):String(e?.content??"")})),I=await (0,p.getGamificationSummary)(t.user.id),[A]=await o.drizzleDb.select().from(l.aITutorEnrollment).where((0,a.eq)(l.aITutorEnrollment.studentId,t.user.id)).limit(1),D=y||"friendly_mentor";if(f){let[e]=await o.drizzleDb.select().from(l.mission).where((0,a.eq)(l.mission.id,f)).limit(1);if(e){let t=e.requirement,r=t&&"string"==typeof t.difficulty?t.difficulty:"1";i={worldId:t&&"string"==typeof t.worldId?t.worldId:e.id,worldName:t&&"string"==typeof t.worldName?t.worldName:"Current mission",worldEmoji:t&&"string"==typeof t.worldEmoji?t.worldEmoji:"ðŸŽ¯",missionId:e.id,missionTitle:e.title,missionObjective:e.description,missionType:e.type,difficulty:r}}}let[T]=await o.drizzleDb.select().from(l.aITutorSubscription).where((0,a.eq)(l.aITutorSubscription.userId,t.user.id)).limit(1),_=T?.tier??"FREE",b={language:"en",teachingMode:w,personality:D,gamification:I,mission:i,tier:_,chatHistory:S,userMessage:R},C=(0,d.buildCompletePrompt)(b),k=await (0,c.generateWithFallback)(C,{temperature:.7,maxTokens:2048}),x=await u.AISecurityManager.validateAiResponse(k.content);if(!x.isValid&&"CRITICAL"===x.severity)return s.NextResponse.json({success:!1,error:"AI response failed security validation"},{status:500});let P=u.AISecurityManager.createStudentHash(t.user.id);return await (0,g.logActivity)(t.user.id,"AI_CONVERSATION",{missionId:f,personality:D,teachingMode:w,studentHash:P}),await (0,m.updateQuestProgress)(t.user.id,"speaking",1),await o.drizzleDb.insert(l.aIInteractionSession).values({id:r.default.randomUUID(),studentId:t.user.id,subjectCode:"chat",messageCount:0,topicsCovered:[]}),s.NextResponse.json({success:!0,data:{response:k,personality:D,gamification:{level:I.level,xp:I.xp,streakDays:I.streakDays}}})},{role:"STUDENT"}));e.s(["POST",0,y]),i()}catch(e){i(e)}},!1),689260,e=>e.a(async(t,i)=>{try{var r=e.i(78315),s=e.i(586961),a=e.i(196657),n=e.i(899733),o=e.i(233979),l=e.i(631683),u=e.i(840960),c=e.i(711373),d=e.i(699699),p=e.i(521140),m=e.i(205260),g=e.i(500249),h=e.i(431740),y=e.i(82608),f=e.i(635207),v=e.i(193695);e.i(708038);var w=e.i(447430),E=e.i(221348),R=t([E]);[E]=R.then?(await R)():R;let A=new r.AppRouteRouteModule({definition:{kind:s.RouteKind.APP_ROUTE,page:"/api/ai-tutor/chat/route",pathname:"/api/ai-tutor/chat",filename:"route",bundlePath:""},distDir:".next",relativeProjectDir:"",resolvedPagePath:"[project]/ADK_WORKSPACE/TutorMekimi/tutorme-app/src/app/api/ai-tutor/chat/route.ts",nextConfigOutput:"",userland:E}),{workAsyncStorage:D,workUnitAsyncStorage:T,serverHooks:_}=A;function S(){return(0,a.patchFetch)({workAsyncStorage:D,workUnitAsyncStorage:T})}async function I(e,t,i){A.isDev&&(0,n.addRequestMeta)(e,"devRequestTimingInternalsEnd",process.hrtime.bigint());let r="/api/ai-tutor/chat/route";r=r.replace(/\/index$/,"")||"/";let a=await A.prepare(e,t,{srcPage:r,multiZoneDraftMode:!1});if(!a)return t.statusCode=400,t.end("Bad Request"),null==i.waitUntil||i.waitUntil.call(i,Promise.resolve()),null;let{buildId:E,params:R,nextConfig:S,parsedUrl:I,isDraftMode:D,prerenderManifest:T,routerServerContext:_,isOnDemandRevalidate:b,revalidateOnlyGenerated:C,resolvedPathname:k,clientReferenceManifest:x,serverActionsManifest:P}=a,L=(0,u.normalizeAppPath)(r),N=!!(T.dynamicRoutes[L]||T.routes[k]),q=async()=>((null==_?void 0:_.render404)?await _.render404(e,t,I,!1):t.end("This page could not be found"),null);if(N&&!D){let e=!!T.routes[k],t=T.dynamicRoutes[L];if(t&&!1===t.fallback&&!e){if(S.experimental.adapterPath)return await q();throw new v.NoFallbackError}}let O=null;!N||A.isDev||D||(O=k,O="/index"===O?"/":O);let z=!0===A.isDev||!N,M=N&&!z;P&&x&&(0,l.setManifestsSingleton)({page:r,clientReferenceManifest:x,serverActionsManifest:P});let U=e.method||"GET",Q=(0,o.getTracer)(),H=Q.getActiveScopeSpan(),F={params:R,prerenderManifest:T,renderOpts:{experimental:{authInterrupts:!!S.experimental.authInterrupts},cacheComponents:!!S.cacheComponents,supportsDynamicResponse:z,incrementalCache:(0,n.getRequestMeta)(e,"incrementalCache"),cacheLifeProfiles:S.cacheLife,waitUntil:i.waitUntil,onClose:e=>{t.on("close",e)},onAfterTaskError:void 0,onInstrumentationRequestError:(t,i,r,s)=>A.onRequestError(e,t,r,s,_)},sharedContext:{buildId:E}},$=new c.NodeNextRequest(e),X=new c.NodeNextResponse(t),V=d.NextRequestAdapter.fromNodeNextRequest($,(0,d.signalFromNodeResponse)(t));try{let a=async e=>A.handle(V,F).finally(()=>{if(!e)return;e.setAttributes({"http.status_code":t.statusCode,"next.rsc":!1});let i=Q.getRootSpanAttributes();if(!i)return;if(i.get("next.span_type")!==p.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${i.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let s=i.get("next.route");if(s){let t=`${U} ${s}`;e.setAttributes({"next.route":s,"http.route":s,"next.span_name":t}),e.updateName(t)}else e.updateName(`${U} ${r}`)}),l=!!(0,n.getRequestMeta)(e,"minimalMode"),u=async n=>{var o,u;let c=async({previousCacheEntry:s})=>{try{if(!l&&b&&C&&!s)return t.statusCode=404,t.setHeader("x-nextjs-cache","REVALIDATED"),t.end("This page could not be found"),null;let r=await a(n);e.fetchMetrics=F.renderOpts.fetchMetrics;let o=F.renderOpts.pendingWaitUntil;o&&i.waitUntil&&(i.waitUntil(o),o=void 0);let u=F.renderOpts.collectedTags;if(!N)return await (0,g.sendResponse)($,X,r,F.renderOpts.pendingWaitUntil),null;{let e=await r.blob(),t=(0,h.toNodeOutgoingHttpHeaders)(r.headers);u&&(t[f.NEXT_CACHE_TAGS_HEADER]=u),!t["content-type"]&&e.type&&(t["content-type"]=e.type);let i=void 0!==F.renderOpts.collectedRevalidate&&!(F.renderOpts.collectedRevalidate>=f.INFINITE_CACHE)&&F.renderOpts.collectedRevalidate,s=void 0===F.renderOpts.collectedExpire||F.renderOpts.collectedExpire>=f.INFINITE_CACHE?void 0:F.renderOpts.collectedExpire;return{value:{kind:w.CachedRouteKind.APP_ROUTE,status:r.status,body:Buffer.from(await e.arrayBuffer()),headers:t},cacheControl:{revalidate:i,expire:s}}}}catch(t){throw(null==s?void 0:s.isStale)&&await A.onRequestError(e,t,{routerKind:"App Router",routePath:r,routeType:"route",revalidateReason:(0,m.getRevalidateReason)({isStaticGeneration:M,isOnDemandRevalidate:b})},!1,_),t}},d=await A.handleResponse({req:e,nextConfig:S,cacheKey:O,routeKind:s.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:T,isRoutePPREnabled:!1,isOnDemandRevalidate:b,revalidateOnlyGenerated:C,responseGenerator:c,waitUntil:i.waitUntil,isMinimalMode:l});if(!N)return null;if((null==d||null==(o=d.value)?void 0:o.kind)!==w.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==d||null==(u=d.value)?void 0:u.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});l||t.setHeader("x-nextjs-cache",b?"REVALIDATED":d.isMiss?"MISS":d.isStale?"STALE":"HIT"),D&&t.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let p=(0,h.fromNodeOutgoingHttpHeaders)(d.value.headers);return l&&N||p.delete(f.NEXT_CACHE_TAGS_HEADER),!d.cacheControl||t.getHeader("Cache-Control")||p.get("Cache-Control")||p.set("Cache-Control",(0,y.getCacheControlHeader)(d.cacheControl)),await (0,g.sendResponse)($,X,new Response(d.value.body,{headers:p,status:d.value.status||200})),null};H?await u(H):await Q.withPropagatedContext(e.headers,()=>Q.trace(p.BaseServerSpan.handleRequest,{spanName:`${U} ${r}`,kind:o.SpanKind.SERVER,attributes:{"http.method":U,"http.target":e.url}},u))}catch(t){if(t instanceof v.NoFallbackError||await A.onRequestError(e,t,{routerKind:"App Router",routePath:L,routeType:"route",revalidateReason:(0,m.getRevalidateReason)({isStaticGeneration:M,isOnDemandRevalidate:b})},!1,_),N)throw t;return await (0,g.sendResponse)($,X,new Response(null,{status:500})),null}}e.s(["handler",()=>I,"patchFetch",()=>S,"routeModule",()=>A,"serverHooks",()=>_,"workAsyncStorage",()=>D,"workUnitAsyncStorage",()=>T]),i()}catch(e){i(e)}},!1),412171,e=>{e.v(t=>Promise.all(["server/chunks/b1c00_TutorMekimi_tutorme-app_src_lib_security_suspicious-activity_ts_7865686f._.js"].map(t=>e.l(t))).then(()=>t(145830)))},443460,e=>{e.v(t=>Promise.all(["server/chunks/[externals]_ioredis_c74819ca._.js"].map(t=>e.l(t))).then(()=>t(693545)))},571363,e=>{e.v(t=>Promise.all(["server/chunks/ADK_WORKSPACE_TutorMekimi_tutorme-app_src_lib_security_api-key_ts_45091e81._.js"].map(t=>e.l(t))).then(()=>t(175922)))}];

//# debugId=cd3e3153-8b11-da7d-e348-0dfdb2d51c56
//# sourceMappingURL=%5Broot-of-the-server%5D__3959b377._.js.map