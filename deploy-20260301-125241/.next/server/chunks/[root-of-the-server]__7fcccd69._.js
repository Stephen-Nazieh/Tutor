;!function(){try { var e="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof global?global:"undefined"!=typeof window?window:"undefined"!=typeof self?self:{},n=(new e.Error).stack;n&&((e._debugIds|| (e._debugIds={}))[n]="f2212fee-2dac-3938-9517-6e02cf8f15d9")}catch(e){}}();
module.exports=[908286,e=>{"use strict";async function t(e,t){var r=e instanceof Promise?await e:e;if(!r||"object"!=typeof r)return;let a=r[t];return null!=a?Array.isArray(a)?a[0]:a:void 0}e.s(["getParamAsync",()=>t])},902157,(e,t,r)=>{t.exports=e.x("node:fs",()=>require("node:fs"))},750227,(e,t,r)=>{t.exports=e.x("node:path",()=>require("node:path"))},450869,e=>{"use strict";let t="tutorme:query:",r=null,a=null,o=!1,i=!(void 0!==globalThis.EdgeRuntime||"u">typeof process&&0);function n(){return i?(a||(a=new Map),a):null}async function s(){if(!i)return null;if(o)return r;try{let t=process.env.REDIS_URL;if(!t)return console.log("[DB] Redis URL not configured, using in-memory cache"),o=!0,null;let{Redis:a}=await e.A(443460);return(r=new a(t,{retryStrategy:e=>Math.min(50*e,2e3),maxRetriesPerRequest:3})).on("error",e=>{console.error("[Redis] Connection error:",e),r=null}),console.log("[DB] Redis cache initialized"),o=!0,r}catch(e){return console.warn("[DB] Failed to initialize Redis, using in-memory cache"),o=!0,null}}if(i)try{let{drizzleDb:t}=e.r(738597);console.log("[DB] Drizzle client (default db) initialized")}catch(e){console.error("[DB] Failed to initialize Drizzle:",e)}e.s(["cache",0,{ensureRedis:async()=>i?(o||await s(),r):null,async get(e){if(!i)return null;let r=t+e,a=await this.ensureRedis();if(a)try{let e=await a.get(r);if(e)return JSON.parse(e)}catch(e){console.error("[Cache] Redis get error:",e)}let o=n();if(!o)return null;let s=o.get(r);return s&&s.expires>Date.now()?s.data:(o.delete(r),null)},async set(e,r,a=60){if(!i)return;let o=t+e,s=await this.ensureRedis();if(s)try{await s.setex(o,a,JSON.stringify(r));return}catch(e){console.error("[Cache] Redis set error:",e)}let l=n();l&&l.set(o,{data:r,expires:Date.now()+1e3*a})},async delete(e){if(!i)return;let r=t+e,a=await this.ensureRedis();if(a)try{await a.del(r)}catch(e){console.error("[Cache] Redis del error:",e)}let o=n();o&&o.delete(r)},async clear(){if(!i)return;let e=await this.ensureRedis();if(e)try{let r=await e.keys(t+"*");r.length>0&&await e.del(...r)}catch(e){console.error("[Cache] Redis clear error:",e)}let r=n();r&&r.clear()},async getOrSet(e,t,r=60){let a=await this.get(e);if(null!==a)return a;let o=await t();return await this.set(e,o,r),o},async invalidatePattern(e){if(!i)return;let r=await this.ensureRedis();if(r)try{let a=await r.keys(t+e);a.length>0&&await r.del(...a)}catch(e){console.error("[Cache] Pattern invalidation error:",e)}let a=n();if(a){let r=new RegExp(t+e.replace("*",".*"));for(let e of a.keys())r.test(e)&&a.delete(e)}}}])},240531,e=>e.a(async(t,r)=>{try{var a=e.i(909105),o=e.i(997103),i=e.i(738597);e.i(688768);var n=e.i(257357);e.i(748846);var s=t([i]);async function l(e,t){let r=(0,a.inArray)(n.feedbackWorkflow.status,["ai_generated","tutor_modified"]),[s,l]=await Promise.all([i.drizzleDb.select({id:n.feedbackWorkflow.id,studentId:n.feedbackWorkflow.studentId,submissionId:n.feedbackWorkflow.submissionId,aiScore:n.feedbackWorkflow.aiScore,aiComments:n.feedbackWorkflow.aiComments,aiStrengths:n.feedbackWorkflow.aiStrengths,aiImprovements:n.feedbackWorkflow.aiImprovements,aiResources:n.feedbackWorkflow.aiResources,autoApproved:n.feedbackWorkflow.autoApproved,createdAt:n.feedbackWorkflow.createdAt,studentName:n.profile.name}).from(n.feedbackWorkflow).leftJoin(n.user,(0,a.eq)(n.feedbackWorkflow.studentId,n.user.id)).leftJoin(n.profile,(0,a.eq)(n.user.id,n.profile.userId)).where(r).orderBy((0,o.asc)(n.feedbackWorkflow.createdAt)).limit(t?.limit??20).offset(t?.offset??0),i.drizzleDb.select({id:n.feedbackWorkflow.id}).from(n.feedbackWorkflow).where(r)]),d=l.length;return{items:s.map(e=>({id:e.id,studentId:e.studentId,submissionId:e.submissionId,type:"task_feedback",priority:"medium",aiContent:{content:e.aiComments??"",score:e.aiScore??void 0,tone:"neutral",strengths:e.aiStrengths??[],improvements:e.aiImprovements??[],resources:e.aiResources??[],aiConfidence:e.autoApproved?.9:.7},createdAt:e.createdAt,studentName:e.studentName??void 0})),total:d}}async function d(e,t,r,o){try{let[s]=await i.drizzleDb.select().from(n.feedbackWorkflow).where((0,a.eq)(n.feedbackWorkflow.id,e)).limit(1);if(!s)return{success:!1,error:"反馈记录不存在"};if("sent_to_student"===s.status||"rejected"===s.status)return{success:!1,error:"该反馈已被处理"};let l="approve"===t||"modify"===t,d="modify"===t&&o?{status:"tutor_modified",approvedAt:new Date,approvedBy:r,modifiedScore:o.modifiedScore??void 0,modifiedComments:o.modifiedComments??void 0,addedNotes:o.addedNotes??void 0}:{status:l?"approved":"rejected",approvedAt:new Date,approvedBy:r};return await i.drizzleDb.update(n.feedbackWorkflow).set(d).where((0,a.eq)(n.feedbackWorkflow.id,e)),l&&await i.drizzleDb.update(n.feedbackWorkflow).set({status:"sent_to_student"}).where((0,a.eq)(n.feedbackWorkflow.id,e)),{success:!0}}catch(e){return console.error("Feedback review failed:",e),{success:!1,error:e instanceof Error?e.message:"审核反馈失败"}}}async function c(e){let t=new Date;t.setHours(0,0,0,0);let[r,o,s,l]=await Promise.all([i.drizzleDb.select({id:n.feedbackWorkflow.id}).from(n.feedbackWorkflow).where((0,a.inArray)(n.feedbackWorkflow.status,["ai_generated","tutor_modified"])),i.drizzleDb.select({id:n.feedbackWorkflow.id}).from(n.feedbackWorkflow).where((0,a.and)((0,a.inArray)(n.feedbackWorkflow.status,["approved","sent_to_student"]),(0,a.gte)(n.feedbackWorkflow.approvedAt,t))),i.drizzleDb.select({id:n.feedbackWorkflow.id}).from(n.feedbackWorkflow).where((0,a.and)((0,a.eq)(n.feedbackWorkflow.status,"rejected"),(0,a.gte)(n.feedbackWorkflow.approvedAt,t))),i.drizzleDb.select({autoApproved:n.feedbackWorkflow.autoApproved}).from(n.feedbackWorkflow)]),d=r.length,c=o.length,u=s.length,f=l.length,p=l.filter(e=>e.autoApproved).length;return{pendingCount:d,approvedToday:c,rejectedToday:u,averageConfidence:.75*(f>0),autoApprovedRate:f>0?p/f:0}}async function u(e,t){let r=0,a=0;for(let o of e)(await d(o,"approve",t)).success?r++:a++;return{success:0===a,approved:r,failed:a}}[i]=s.then?(await s)():s,e.s(["batchApproveFeedback",()=>u,"getFeedbackStats",()=>c,"getPendingFeedback",()=>l,"reviewFeedback",()=>d]),r()}catch(e){r(e)}},!1),838277,e=>e.a(async(t,r)=>{try{var a=e.i(620971),o=e.i(384030),i=e.i(908286),n=e.i(240531),s=t([o,n]);async function l(e,t,r){let s=await (0,o.requireCsrf)(e);if(s)return s;try{if("TUTOR"!==t.user.role&&"ADMIN"!==t.user.role)return a.NextResponse.json({error:"无权审核反馈"},{status:403});let o=await (0,i.getParamAsync)(r?.params,"id");if(!o)return a.NextResponse.json({error:"反馈ID不能为空"},{status:400});let{decision:s,modifications:l}=await e.json().catch(()=>({}));if(!s||!["approve","reject","modify"].includes(s))return a.NextResponse.json({error:"无效的审核决定"},{status:400});let d=await (0,n.reviewFeedback)(o,s,t.user.id,l);if(!d.success)return a.NextResponse.json({error:d.error||"审核失败"},{status:400});return a.NextResponse.json({success:!0,message:"approve"===s?"已通过":"reject"===s?"已拒绝":"已修改"})}catch(e){return console.error("Failed to review feedback:",e),a.NextResponse.json({error:"审核反馈失败"},{status:500})}}[o,n]=s.then?(await s)():s;let d=(0,o.withAuth)(l);e.s(["POST",0,d]),r()}catch(e){r(e)}},!1),717723,e=>e.a(async(t,r)=>{try{var a=e.i(78315),o=e.i(586961),i=e.i(196657),n=e.i(899733),s=e.i(233979),l=e.i(631683),d=e.i(840960),c=e.i(711373),u=e.i(699699),f=e.i(521140),p=e.i(205260),h=e.i(500249),w=e.i(431740),m=e.i(82608),k=e.i(635207),v=e.i(193695);e.i(708038);var R=e.i(447430),b=e.i(838277),y=t([b]);[b]=y.then?(await y)():y;let _=new a.AppRouteRouteModule({definition:{kind:o.RouteKind.APP_ROUTE,page:"/api/feedback/[id]/review/route",pathname:"/api/feedback/[id]/review",filename:"route",bundlePath:""},distDir:".next",relativeProjectDir:"",resolvedPagePath:"[project]/ADK_WORKSPACE/TutorMekimi/tutorme-app/src/app/api/feedback/[id]/review/route.ts",nextConfigOutput:"",userland:b}),{workAsyncStorage:C,workUnitAsyncStorage:x,serverHooks:E}=_;function g(){return(0,i.patchFetch)({workAsyncStorage:C,workUnitAsyncStorage:x})}async function A(e,t,r){_.isDev&&(0,n.addRequestMeta)(e,"devRequestTimingInternalsEnd",process.hrtime.bigint());let a="/api/feedback/[id]/review/route";a=a.replace(/\/index$/,"")||"/";let i=await _.prepare(e,t,{srcPage:a,multiZoneDraftMode:!1});if(!i)return t.statusCode=400,t.end("Bad Request"),null==r.waitUntil||r.waitUntil.call(r,Promise.resolve()),null;let{buildId:b,params:y,nextConfig:g,parsedUrl:A,isDraftMode:C,prerenderManifest:x,routerServerContext:E,isOnDemandRevalidate:D,revalidateOnlyGenerated:W,resolvedPathname:P,clientReferenceManifest:N,serverActionsManifest:S}=i,I=(0,d.normalizeAppPath)(a),T=!!(x.dynamicRoutes[I]||x.routes[P]),O=async()=>((null==E?void 0:E.render404)?await E.render404(e,t,A,!1):t.end("This page could not be found"),null);if(T&&!C){let e=!!x.routes[P],t=x.dynamicRoutes[I];if(t&&!1===t.fallback&&!e){if(g.experimental.adapterPath)return await O();throw new v.NoFallbackError}}let z=null;!T||_.isDev||C||(z=P,z="/index"===z?"/":z);let q=!0===_.isDev||!T,j=T&&!q;S&&N&&(0,l.setManifestsSingleton)({page:a,clientReferenceManifest:N,serverActionsManifest:S});let U=e.method||"GET",H=(0,s.getTracer)(),M=H.getActiveScopeSpan(),F={params:y,prerenderManifest:x,renderOpts:{experimental:{authInterrupts:!!g.experimental.authInterrupts},cacheComponents:!!g.cacheComponents,supportsDynamicResponse:q,incrementalCache:(0,n.getRequestMeta)(e,"incrementalCache"),cacheLifeProfiles:g.cacheLife,waitUntil:r.waitUntil,onClose:e=>{t.on("close",e)},onAfterTaskError:void 0,onInstrumentationRequestError:(t,r,a,o)=>_.onRequestError(e,t,a,o,E)},sharedContext:{buildId:b}},B=new c.NodeNextRequest(e),K=new c.NodeNextResponse(t),$=u.NextRequestAdapter.fromNodeNextRequest(B,(0,u.signalFromNodeResponse)(t));try{let i=async e=>_.handle($,F).finally(()=>{if(!e)return;e.setAttributes({"http.status_code":t.statusCode,"next.rsc":!1});let r=H.getRootSpanAttributes();if(!r)return;if(r.get("next.span_type")!==f.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${r.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let o=r.get("next.route");if(o){let t=`${U} ${o}`;e.setAttributes({"next.route":o,"http.route":o,"next.span_name":t}),e.updateName(t)}else e.updateName(`${U} ${a}`)}),l=!!(0,n.getRequestMeta)(e,"minimalMode"),d=async n=>{var s,d;let c=async({previousCacheEntry:o})=>{try{if(!l&&D&&W&&!o)return t.statusCode=404,t.setHeader("x-nextjs-cache","REVALIDATED"),t.end("This page could not be found"),null;let a=await i(n);e.fetchMetrics=F.renderOpts.fetchMetrics;let s=F.renderOpts.pendingWaitUntil;s&&r.waitUntil&&(r.waitUntil(s),s=void 0);let d=F.renderOpts.collectedTags;if(!T)return await (0,h.sendResponse)(B,K,a,F.renderOpts.pendingWaitUntil),null;{let e=await a.blob(),t=(0,w.toNodeOutgoingHttpHeaders)(a.headers);d&&(t[k.NEXT_CACHE_TAGS_HEADER]=d),!t["content-type"]&&e.type&&(t["content-type"]=e.type);let r=void 0!==F.renderOpts.collectedRevalidate&&!(F.renderOpts.collectedRevalidate>=k.INFINITE_CACHE)&&F.renderOpts.collectedRevalidate,o=void 0===F.renderOpts.collectedExpire||F.renderOpts.collectedExpire>=k.INFINITE_CACHE?void 0:F.renderOpts.collectedExpire;return{value:{kind:R.CachedRouteKind.APP_ROUTE,status:a.status,body:Buffer.from(await e.arrayBuffer()),headers:t},cacheControl:{revalidate:r,expire:o}}}}catch(t){throw(null==o?void 0:o.isStale)&&await _.onRequestError(e,t,{routerKind:"App Router",routePath:a,routeType:"route",revalidateReason:(0,p.getRevalidateReason)({isStaticGeneration:j,isOnDemandRevalidate:D})},!1,E),t}},u=await _.handleResponse({req:e,nextConfig:g,cacheKey:z,routeKind:o.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:x,isRoutePPREnabled:!1,isOnDemandRevalidate:D,revalidateOnlyGenerated:W,responseGenerator:c,waitUntil:r.waitUntil,isMinimalMode:l});if(!T)return null;if((null==u||null==(s=u.value)?void 0:s.kind)!==R.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==u||null==(d=u.value)?void 0:d.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});l||t.setHeader("x-nextjs-cache",D?"REVALIDATED":u.isMiss?"MISS":u.isStale?"STALE":"HIT"),C&&t.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let f=(0,w.fromNodeOutgoingHttpHeaders)(u.value.headers);return l&&T||f.delete(k.NEXT_CACHE_TAGS_HEADER),!u.cacheControl||t.getHeader("Cache-Control")||f.get("Cache-Control")||f.set("Cache-Control",(0,m.getCacheControlHeader)(u.cacheControl)),await (0,h.sendResponse)(B,K,new Response(u.value.body,{headers:f,status:u.value.status||200})),null};M?await d(M):await H.withPropagatedContext(e.headers,()=>H.trace(f.BaseServerSpan.handleRequest,{spanName:`${U} ${a}`,kind:s.SpanKind.SERVER,attributes:{"http.method":U,"http.target":e.url}},d))}catch(t){if(t instanceof v.NoFallbackError||await _.onRequestError(e,t,{routerKind:"App Router",routePath:I,routeType:"route",revalidateReason:(0,p.getRevalidateReason)({isStaticGeneration:j,isOnDemandRevalidate:D})},!1,E),T)throw t;return await (0,h.sendResponse)(B,K,new Response(null,{status:500})),null}}e.s(["handler",()=>A,"patchFetch",()=>g,"routeModule",()=>_,"serverHooks",()=>E,"workAsyncStorage",()=>C,"workUnitAsyncStorage",()=>x]),r()}catch(e){r(e)}},!1),412171,e=>{e.v(t=>Promise.all(["server/chunks/b1c00_TutorMekimi_tutorme-app_src_lib_security_suspicious-activity_ts_7865686f._.js"].map(t=>e.l(t))).then(()=>t(145830)))},443460,e=>{e.v(t=>Promise.all(["server/chunks/[externals]_ioredis_c74819ca._.js"].map(t=>e.l(t))).then(()=>t(693545)))},571363,e=>{e.v(t=>Promise.all(["server/chunks/ADK_WORKSPACE_TutorMekimi_tutorme-app_src_lib_security_api-key_ts_45091e81._.js"].map(t=>e.l(t))).then(()=>t(175922)))}];

//# debugId=f2212fee-2dac-3938-9517-6e02cf8f15d9
//# sourceMappingURL=%5Broot-of-the-server%5D__7fcccd69._.js.map