;!function(){try { var e="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof global?global:"undefined"!=typeof window?window:"undefined"!=typeof self?self:{},n=(new e.Error).stack;n&&((e._debugIds|| (e._debugIds={}))[n]="310b59a5-5e3a-0660-d25e-6e7421529aa7")}catch(e){}}();
module.exports=[908286,e=>{"use strict";async function t(e,t){var a=e instanceof Promise?await e:e;if(!a||"object"!=typeof a)return;let n=a[t];return null!=n?Array.isArray(n)?n[0]:n:void 0}e.s(["getParamAsync",()=>t])},684644,e=>e.a(async(t,a)=>{try{var n=e.i(620971),r=e.i(384030),o=e.i(908286),i=e.i(738597);e.i(688768);var s=e.i(257357),l=e.i(909105),d=e.i(997103),u=t([r,i]);[r,i]=u.then?(await u)():u;let c=(0,r.withAuth)(async(e,t,a)=>{let r=await (0,o.getParamAsync)(a?.params,"contentId");if(!r)return n.NextResponse.json({error:"Content ID required"},{status:400});let{searchParams:u}=new URL(e.url),c=u.get("studentId")||t.user.id,p="ADMIN"===t.user.role;if(c!==t.user.id&&!p)return n.NextResponse.json({error:"Forbidden"},{status:403});let[h]=await i.drizzleDb.select({id:s.contentItem.id,duration:s.contentItem.duration}).from(s.contentItem).where((0,l.eq)(s.contentItem.id,r)).limit(1);if(!h)return n.NextResponse.json({error:"Content not found"},{status:404});let m=(h.duration??0)||1,v=await i.drizzleDb.select().from(s.videoWatchEvent).where((0,l.and)((0,l.eq)(s.videoWatchEvent.contentId,r),(0,l.eq)(s.videoWatchEvent.studentId,c))).orderBy((0,d.asc)(s.videoWatchEvent.createdAt)),R=0,f=0,y=!1,E={};for(let e of v){let t=e.videoSeconds,a=10*Math.floor(t/10);if(E[a]=(E[a]??0)+1,"play"===e.eventType)f=t,y=!0;else if("pause"===e.eventType&&y)R+=Math.max(0,t-f),y=!1;else if("seek"===e.eventType&&e.metadata&&"object"==typeof e.metadata){let t=e.metadata;"number"==typeof t.fromTime&&"number"==typeof t.toTime&&(R+=Math.abs(t.toTime-t.fromTime))}else"complete"===e.eventType&&(R+=Math.max(0,m-f),y=!1)}y&&(R+=Math.max(0,m-f));let w=m>0?Math.min(100,Math.round(R/m*100)):0,g=v.length?Math.max(...v.map(e=>e.videoSeconds)):0,_=m>0?Math.round(g/m*100):0,A=Array.from({length:Math.ceil(m/10)},(e,t)=>{let a=10*t;return{segmentStart:a,count:E[a]??0}});return n.NextResponse.json({contentId:r,durationSeconds:m,totalWatchSeconds:R,completionPercent:w,lastPositionSeconds:g,dropOffPercent:_,eventCount:v.length,heatmap:A})},{role:"STUDENT"});e.s(["GET",0,c]),a()}catch(e){a(e)}},!1),591350,e=>e.a(async(t,a)=>{try{var n=e.i(78315),r=e.i(586961),o=e.i(196657),i=e.i(899733),s=e.i(233979),l=e.i(631683),d=e.i(840960),u=e.i(711373),c=e.i(699699),p=e.i(521140),h=e.i(205260),m=e.i(500249),v=e.i(431740),R=e.i(82608),f=e.i(635207),y=e.i(193695);e.i(708038);var E=e.i(447430),w=e.i(684644),g=t([w]);[w]=g.then?(await g)():g;let x=new n.AppRouteRouteModule({definition:{kind:r.RouteKind.APP_ROUTE,page:"/api/content/[contentId]/analytics/route",pathname:"/api/content/[contentId]/analytics",filename:"route",bundlePath:""},distDir:".next",relativeProjectDir:"",resolvedPagePath:"[project]/ADK_WORKSPACE/TutorMekimi/tutorme-app/src/app/api/content/[contentId]/analytics/route.ts",nextConfigOutput:"",userland:w}),{workAsyncStorage:C,workUnitAsyncStorage:T,serverHooks:b}=x;function _(){return(0,o.patchFetch)({workAsyncStorage:C,workUnitAsyncStorage:T})}async function A(e,t,a){x.isDev&&(0,i.addRequestMeta)(e,"devRequestTimingInternalsEnd",process.hrtime.bigint());let n="/api/content/[contentId]/analytics/route";n=n.replace(/\/index$/,"")||"/";let o=await x.prepare(e,t,{srcPage:n,multiZoneDraftMode:!1});if(!o)return t.statusCode=400,t.end("Bad Request"),null==a.waitUntil||a.waitUntil.call(a,Promise.resolve()),null;let{buildId:w,params:g,nextConfig:_,parsedUrl:A,isDraftMode:C,prerenderManifest:T,routerServerContext:b,isOnDemandRevalidate:P,revalidateOnlyGenerated:I,resolvedPathname:N,clientReferenceManifest:S,serverActionsManifest:M}=o,O=(0,d.normalizeAppPath)(n),k=!!(T.dynamicRoutes[O]||T.routes[N]),D=async()=>((null==b?void 0:b.render404)?await b.render404(e,t,A,!1):t.end("This page could not be found"),null);if(k&&!C){let e=!!T.routes[N],t=T.dynamicRoutes[O];if(t&&!1===t.fallback&&!e){if(_.experimental.adapterPath)return await D();throw new y.NoFallbackError}}let q=null;!k||x.isDev||C||(q=N,q="/index"===q?"/":q);let U=!0===x.isDev||!k,H=k&&!U;M&&S&&(0,l.setManifestsSingleton)({page:n,clientReferenceManifest:S,serverActionsManifest:M});let j=e.method||"GET",K=(0,s.getTracer)(),F=K.getActiveScopeSpan(),$={params:g,prerenderManifest:T,renderOpts:{experimental:{authInterrupts:!!_.experimental.authInterrupts},cacheComponents:!!_.cacheComponents,supportsDynamicResponse:U,incrementalCache:(0,i.getRequestMeta)(e,"incrementalCache"),cacheLifeProfiles:_.cacheLife,waitUntil:a.waitUntil,onClose:e=>{t.on("close",e)},onAfterTaskError:void 0,onInstrumentationRequestError:(t,a,n,r)=>x.onRequestError(e,t,n,r,b)},sharedContext:{buildId:w}},W=new u.NodeNextRequest(e),B=new u.NodeNextResponse(t),L=c.NextRequestAdapter.fromNodeNextRequest(W,(0,c.signalFromNodeResponse)(t));try{let o=async e=>x.handle(L,$).finally(()=>{if(!e)return;e.setAttributes({"http.status_code":t.statusCode,"next.rsc":!1});let a=K.getRootSpanAttributes();if(!a)return;if(a.get("next.span_type")!==p.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${a.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let r=a.get("next.route");if(r){let t=`${j} ${r}`;e.setAttributes({"next.route":r,"http.route":r,"next.span_name":t}),e.updateName(t)}else e.updateName(`${j} ${n}`)}),l=!!(0,i.getRequestMeta)(e,"minimalMode"),d=async i=>{var s,d;let u=async({previousCacheEntry:r})=>{try{if(!l&&P&&I&&!r)return t.statusCode=404,t.setHeader("x-nextjs-cache","REVALIDATED"),t.end("This page could not be found"),null;let n=await o(i);e.fetchMetrics=$.renderOpts.fetchMetrics;let s=$.renderOpts.pendingWaitUntil;s&&a.waitUntil&&(a.waitUntil(s),s=void 0);let d=$.renderOpts.collectedTags;if(!k)return await (0,m.sendResponse)(W,B,n,$.renderOpts.pendingWaitUntil),null;{let e=await n.blob(),t=(0,v.toNodeOutgoingHttpHeaders)(n.headers);d&&(t[f.NEXT_CACHE_TAGS_HEADER]=d),!t["content-type"]&&e.type&&(t["content-type"]=e.type);let a=void 0!==$.renderOpts.collectedRevalidate&&!($.renderOpts.collectedRevalidate>=f.INFINITE_CACHE)&&$.renderOpts.collectedRevalidate,r=void 0===$.renderOpts.collectedExpire||$.renderOpts.collectedExpire>=f.INFINITE_CACHE?void 0:$.renderOpts.collectedExpire;return{value:{kind:E.CachedRouteKind.APP_ROUTE,status:n.status,body:Buffer.from(await e.arrayBuffer()),headers:t},cacheControl:{revalidate:a,expire:r}}}}catch(t){throw(null==r?void 0:r.isStale)&&await x.onRequestError(e,t,{routerKind:"App Router",routePath:n,routeType:"route",revalidateReason:(0,h.getRevalidateReason)({isStaticGeneration:H,isOnDemandRevalidate:P})},!1,b),t}},c=await x.handleResponse({req:e,nextConfig:_,cacheKey:q,routeKind:r.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:T,isRoutePPREnabled:!1,isOnDemandRevalidate:P,revalidateOnlyGenerated:I,responseGenerator:u,waitUntil:a.waitUntil,isMinimalMode:l});if(!k)return null;if((null==c||null==(s=c.value)?void 0:s.kind)!==E.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==c||null==(d=c.value)?void 0:d.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});l||t.setHeader("x-nextjs-cache",P?"REVALIDATED":c.isMiss?"MISS":c.isStale?"STALE":"HIT"),C&&t.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let p=(0,v.fromNodeOutgoingHttpHeaders)(c.value.headers);return l&&k||p.delete(f.NEXT_CACHE_TAGS_HEADER),!c.cacheControl||t.getHeader("Cache-Control")||p.get("Cache-Control")||p.set("Cache-Control",(0,R.getCacheControlHeader)(c.cacheControl)),await (0,m.sendResponse)(W,B,new Response(c.value.body,{headers:p,status:c.value.status||200})),null};F?await d(F):await K.withPropagatedContext(e.headers,()=>K.trace(p.BaseServerSpan.handleRequest,{spanName:`${j} ${n}`,kind:s.SpanKind.SERVER,attributes:{"http.method":j,"http.target":e.url}},d))}catch(t){if(t instanceof y.NoFallbackError||await x.onRequestError(e,t,{routerKind:"App Router",routePath:O,routeType:"route",revalidateReason:(0,h.getRevalidateReason)({isStaticGeneration:H,isOnDemandRevalidate:P})},!1,b),k)throw t;return await (0,m.sendResponse)(W,B,new Response(null,{status:500})),null}}e.s(["handler",()=>A,"patchFetch",()=>_,"routeModule",()=>x,"serverHooks",()=>b,"workAsyncStorage",()=>C,"workUnitAsyncStorage",()=>T]),a()}catch(e){a(e)}},!1),412171,e=>{e.v(t=>Promise.all(["server/chunks/b1c00_TutorMekimi_tutorme-app_src_lib_security_suspicious-activity_ts_7865686f._.js"].map(t=>e.l(t))).then(()=>t(145830)))},443460,e=>{e.v(t=>Promise.all(["server/chunks/[externals]_ioredis_c74819ca._.js"].map(t=>e.l(t))).then(()=>t(693545)))},571363,e=>{e.v(t=>Promise.all(["server/chunks/ADK_WORKSPACE_TutorMekimi_tutorme-app_src_lib_security_api-key_ts_45091e81._.js"].map(t=>e.l(t))).then(()=>t(175922)))}];

//# debugId=310b59a5-5e3a-0660-d25e-6e7421529aa7
//# sourceMappingURL=%5Broot-of-the-server%5D__d7c1ddcf._.js.map