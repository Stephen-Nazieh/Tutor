;!function(){try { var e="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof global?global:"undefined"!=typeof window?window:"undefined"!=typeof self?self:{},n=(new e.Error).stack;n&&((e._debugIds|| (e._debugIds={}))[n]="4df61ebb-efca-3070-8a50-76f404063176")}catch(e){}}();
module.exports=[231414,e=>e.a(async(a,r)=>{try{var t=e.i(254799),d=e.i(909105),n=e.i(997103),l=e.i(320947),o=e.i(738597);e.i(688768);var i=e.i(257357),s=a([o]);async function u(e){if(0===e.length)return[];let a=[...new Set(e.map(e=>e.userId))],[r,t,n]=await Promise.all([o.drizzleDb.select().from(i.profile).where((0,d.inArray)(i.profile.userId,a)),o.drizzleDb.select().from(i.userGamification).where((0,d.inArray)(i.userGamification.userId,a)),o.drizzleDb.select({userId:i.userBadge.userId,count:l.sql`count(*)::int`}).from(i.userBadge).where((0,d.inArray)(i.userBadge.userId,a)).groupBy(i.userBadge.userId)]),s=new Map(r.map(e=>[e.userId,e])),u=new Map(t.map(e=>[e.userId,e])),c=new Map(n.map(e=>[e.userId,e.count]));return e.map((e,a)=>{let r=s.get(e.userId),t=u.get(e.userId),d=c.get(e.userId)??0;return{rank:a+1,userId:e.userId,name:r?.name??`Student ${e.userId.slice(-6)}`,avatar:r?.avatarUrl??void 0,level:t?.level??1,xp:t?.xp??0,score:e.score,streakDays:t?.streakDays??0,badges:d}})}async function c(e,a,r,n,s){let u=[(0,d.eq)(i.leaderboardEntry.userId,e),(0,d.eq)(i.leaderboardEntry.type,a)];n&&u.push((0,d.eq)(i.leaderboardEntry.periodStart,n));let[c]=await o.drizzleDb.select().from(i.leaderboardEntry).where((0,d.and)(...u)).limit(1);if(c){let[e]=await o.drizzleDb.update(i.leaderboardEntry).set({score:l.sql`${i.leaderboardEntry.score} + ${r}`}).where((0,d.eq)(i.leaderboardEntry.id,c.id)).returning();return e??c}let[y]=await o.drizzleDb.insert(i.leaderboardEntry).values({id:t.default.randomUUID(),userId:e,type:a,score:r,periodStart:n??null,periodEnd:s??null}).returning();if(!y)throw Error("Failed to create leaderboard entry");return y}async function y(e,a=100,r){let t,s,c,w=new Date;if("weekly"===e){let e=w.getDay();(t=new Date(w)).setDate(w.getDate()-e),t.setHours(0,0,0,0),(s=new Date(t)).setDate(s.getDate()+6),s.setHours(23,59,59,999)}else"monthly"===e&&(t=new Date(w.getFullYear(),w.getMonth(),1),s=new Date(w.getFullYear(),w.getMonth()+1,0,23,59,59,999));let b=[(0,d.eq)(i.leaderboardEntry.type,e)];t&&b.push((0,d.gte)(i.leaderboardEntry.periodStart,t));let E=await o.drizzleDb.select().from(i.leaderboardEntry).where((0,d.and)(...b)).orderBy((0,n.desc)(i.leaderboardEntry.score)).limit(a),g=await u(E);if(r){let a=g.find(e=>e.userId===r);c=a||await p(r,e,t)}let[m]=await o.drizzleDb.select({count:l.sql`count(*)::int`}).from(i.leaderboardEntry).where((0,d.and)(...b));return{type:e,periodStart:t,periodEnd:s,entries:g,userRank:c,totalParticipants:m?.count??0}}async function p(e,a,r){let t=[(0,d.eq)(i.leaderboardEntry.type,a),(0,d.eq)(i.leaderboardEntry.userId,e)];r&&t.push((0,d.gte)(i.leaderboardEntry.periodStart,r));let[n]=await o.drizzleDb.select().from(i.leaderboardEntry).where((0,d.and)(...t)).limit(1);if(!n)return;let s=[(0,d.eq)(i.leaderboardEntry.type,a),(0,d.gt)(i.leaderboardEntry.score,n.score)];r&&s.push((0,d.gte)(i.leaderboardEntry.periodStart,r));let[c]=await o.drizzleDb.select({count:l.sql`count(*)::int`}).from(i.leaderboardEntry).where((0,d.and)(...s)),y=(c?.count??0)+1,p=await u([n]);if(0!==p.length)return{...p[0],rank:y}}async function w(e,a,r=5){let t,s=new Date;if("weekly"===a){let e=s.getDay();(t=new Date(s)).setDate(s.getDate()-e),t.setHours(0,0,0,0)}else"monthly"===a&&(t=new Date(s.getFullYear(),s.getMonth(),1));let c=[(0,d.eq)(i.leaderboardEntry.type,a),(0,d.eq)(i.leaderboardEntry.userId,e)];t&&c.push((0,d.gte)(i.leaderboardEntry.periodStart,t));let[p]=await o.drizzleDb.select().from(i.leaderboardEntry).where((0,d.and)(...c)).limit(1);if(!p)return(await y(a,2*r+1,e)).entries;let b=[(0,d.eq)(i.leaderboardEntry.type,a)];t&&b.push((0,d.gte)(i.leaderboardEntry.periodStart,t));let[E,g,m]=await Promise.all([o.drizzleDb.select().from(i.leaderboardEntry).where((0,d.and)(...b,(0,d.gte)(i.leaderboardEntry.score,p.score),(0,d.ne)(i.leaderboardEntry.userId,e))).orderBy((0,n.asc)(i.leaderboardEntry.score)).limit(r),o.drizzleDb.select().from(i.leaderboardEntry).where((0,d.and)(...b,(0,d.lt)(i.leaderboardEntry.score,p.score))).orderBy((0,n.desc)(i.leaderboardEntry.score)).limit(r),o.drizzleDb.select({count:l.sql`count(*)::int`}).from(i.leaderboardEntry).where((0,d.and)(...b,(0,d.gt)(i.leaderboardEntry.score,p.score)))]),f=(m[0]?.count??0)+1,h=[...E].reverse(),D=[...h,p,...g];return(await u(D)).map((e,a)=>({...e,rank:f-h.length+a+1}))}async function b(e){let[a,r,t]=await Promise.all([o.drizzleDb.select().from(i.leaderboardEntry).where((0,d.and)((0,d.eq)(i.leaderboardEntry.userId,e),(0,d.eq)(i.leaderboardEntry.type,"global"))).limit(1),o.drizzleDb.select().from(i.leaderboardEntry).where((0,d.and)((0,d.eq)(i.leaderboardEntry.userId,e),(0,d.eq)(i.leaderboardEntry.type,"weekly"))).limit(1),o.drizzleDb.select().from(i.leaderboardEntry).where((0,d.and)((0,d.eq)(i.leaderboardEntry.userId,e),(0,d.eq)(i.leaderboardEntry.type,"monthly"))).limit(1)]),n=async(e,a)=>{let[r]=await o.drizzleDb.select({count:l.sql`count(*)::int`}).from(i.leaderboardEntry).where((0,d.and)((0,d.eq)(i.leaderboardEntry.type,e),(0,d.gt)(i.leaderboardEntry.score,a)));return(r?.count??0)+1};return{global:{rank:a[0]?await n("global",a[0].score):null,score:a[0]?.score??0},weekly:{rank:r[0]?await n("weekly",r[0].score):null,score:r[0]?.score??0},monthly:{rank:t[0]?await n("monthly",t[0].score):null,score:t[0]?.score??0}}}[o]=s.then?(await s)():s,e.s(["getLeaderboard",()=>y,"getLeaderboardAroundUser",()=>w,"getUserLeaderboardStats",()=>b,"updateLeaderboardEntry",()=>c]),r()}catch(e){r(e)}},!1),433122,e=>e.a(async(a,r)=>{try{var t=e.i(909105),d=e.i(320947),n=e.i(738597);e.i(688768);var l=e.i(257357),o=e.i(977762),i=e.i(505589),s=e.i(239713),u=e.i(231414),c=a([n,o,s,u]);async function y(e){let[a]=await n.drizzleDb.select({count:d.sql`count(*)::int`}).from(l.taskSubmission).where((0,t.eq)(l.taskSubmission.studentId,e));return a?.count??0}async function p(e){let[a]=await n.drizzleDb.select({count:d.sql`count(*)::int`}).from(l.quizAttempt).where((0,t.eq)(l.quizAttempt.studentId,e));return a?.count??0}async function w(e){let[a]=await n.drizzleDb.select({count:d.sql`count(*)::int`}).from(l.quizAttempt).where((0,t.and)((0,t.eq)(l.quizAttempt.studentId,e),(0,t.eq)(l.quizAttempt.score,100)));return a?.count??0}async function b(e){let[a]=await n.drizzleDb.select({avg:d.sql`coalesce(avg(${l.quizAttempt.score})::double precision, 0)`}).from(l.quizAttempt).where((0,t.eq)(l.quizAttempt.studentId,e));return Number(a?.avg??0)}async function E(e){let[a]=await n.drizzleDb.select({count:d.sql`count(*)::int`}).from(l.sessionParticipant).where((0,t.eq)(l.sessionParticipant.studentId,e));return a?.count??0}async function g(e){let[a]=await n.drizzleDb.select({count:d.sql`count(*)::int`}).from(l.message).where((0,t.eq)(l.message.userId,e));return a?.count??0}async function m(e,a){let r={xpEarned:0,badgesEarned:[],leveledUp:!1},t=await (0,o.awardXp)(e,i.XP_REWARDS.COMPLETE_LESSON,"lesson_complete",{lessonId:a});r.xpEarned=t.xpEarned,r.leveledUp=t.leveledUp,r.newLevel=t.level,await (0,u.updateLeaderboardEntry)(e,"global",t.xpEarned),await (0,u.updateLeaderboardEntry)(e,"weekly",t.xpEarned),await (0,u.updateLeaderboardEntry)(e,"monthly",t.xpEarned);let d=await (0,o.getOrCreateGamification)(e),n=await y(e);return r.badgesEarned=await (0,s.checkAndAwardBadges)(e,{lessonsCompleted:n,streakDays:d.streakDays,currentLevel:d.level,totalXp:d.xp}),r}async function f(e,a,r,t){let d={xpEarned:0,badgesEarned:[],leveledUp:!1},n=t?i.XP_REWARDS.PERFECT_QUIZ:Math.round(i.XP_REWARDS.PERFECT_QUIZ*(r/100)),l=await (0,o.awardXp)(e,n,"quiz_complete",{quizId:a,score:r,isPerfect:t});d.xpEarned=l.xpEarned,d.leveledUp=l.leveledUp,d.newLevel=l.level,await (0,u.updateLeaderboardEntry)(e,"global",l.xpEarned),await (0,u.updateLeaderboardEntry)(e,"weekly",l.xpEarned),await (0,u.updateLeaderboardEntry)(e,"monthly",l.xpEarned);let c=await (0,o.getOrCreateGamification)(e),y=await p(e),E=await w(e),g=await b(e);if(d.badgesEarned=await (0,s.checkAndAwardBadges)(e,{quizzesCompleted:y,perfectQuizzes:E,quizAverage:g,streakDays:c.streakDays,currentLevel:c.level,totalXp:c.xp}),t){let a=await (0,s.awardBadge)(e,"perfect_score");a.awarded&&a.badge&&d.badgesEarned.push({badgeKey:"perfect_score",badgeName:a.badge.name,xpBonus:a.xpBonus})}return d}async function h(e){let a={xpEarned:0,badgesEarned:[],streakBonus:0,leveledUp:!1,firstLoginToday:!1},r=await (0,o.checkDailyLogin)(e);if(a.firstLoginToday=r.firstLoginToday,a.xpEarned=r.xpEarned??0,a.streakBonus=r.streakBonus??0,a.streakDays=r.streakDays,a.leveledUp=r.leveledUp??!1,r.firstLoginToday){await (0,u.updateLeaderboardEntry)(e,"global",r.xpEarned??0),await (0,u.updateLeaderboardEntry)(e,"weekly",r.xpEarned??0),await (0,u.updateLeaderboardEntry)(e,"monthly",r.xpEarned??0);let t=await (0,o.getOrCreateGamification)(e);a.badgesEarned=await (0,s.checkAndAwardBadges)(e,{streakDays:t.streakDays,currentLevel:t.level,totalXp:t.xp})}return a}async function D(e,a){let r={badgesEarned:[]},t=await (0,o.getOrCreateGamification)(e),d=await E(e);return r.badgesEarned=await (0,s.checkAndAwardBadges)(e,{sessionsJoined:d,streakDays:t.streakDays,currentLevel:t.level,totalXp:t.xp}),r}async function z(e,a){let r={badgesEarned:[]},t=await (0,o.getOrCreateGamification)(e),d=await g(e);return r.badgesEarned=await (0,s.checkAndAwardBadges)(e,{messagesSent:d,streakDays:t.streakDays,currentLevel:t.level,totalXp:t.xp}),r}async function v(e,a){let r={badgesEarned:[]},t=await (0,o.getOrCreateGamification)(e);return r.badgesEarned=await (0,s.checkAndAwardBadges)(e,{currentLevel:a,streakDays:t.streakDays,totalXp:t.xp}),r}async function q(e,a,r){let t={xpEarned:r,badgesEarned:[],leveledUp:!1},d=await (0,o.awardXp)(e,r,"mission_complete",{missionId:a});return t.leveledUp=d.leveledUp,t.newLevel=d.level,await (0,u.updateLeaderboardEntry)(e,"global",r),await (0,u.updateLeaderboardEntry)(e,"weekly",r),await (0,u.updateLeaderboardEntry)(e,"monthly",r),t}async function k(e,a,r){let t={xpEarned:0,badgesEarned:[],leveledUp:!1},d=Math.max(10,Math.round(a/60)),n=await (0,o.awardXp)(e,d,"speaking_practice",{duration:a,score:r});return t.xpEarned=n.xpEarned,t.leveledUp=n.leveledUp,await (0,u.updateLeaderboardEntry)(e,"global",n.xpEarned),await (0,u.updateLeaderboardEntry)(e,"weekly",n.xpEarned),await (0,u.updateLeaderboardEntry)(e,"monthly",n.xpEarned),t}async function x(e,a){let r={xpEarned:0,badgesEarned:[],leveledUp:!1},t=await (0,o.awardXp)(e,i.XP_REWARDS.AI_CONVERSATION,"ai_conversation",{messageCount:a});return r.xpEarned=t.xpEarned,r.leveledUp=t.leveledUp,await (0,u.updateLeaderboardEntry)(e,"global",t.xpEarned),await (0,u.updateLeaderboardEntry)(e,"weekly",t.xpEarned),await (0,u.updateLeaderboardEntry)(e,"monthly",t.xpEarned),r}async function L(e){let a=new Date().getHours(),r={badgesEarned:[]};if(a>=0&&a<5){let a=await (0,s.awardBadge)(e,"night_owl");a.awarded&&a.badge&&r.badgesEarned.push({badgeKey:"night_owl",badgeName:a.badge.name,xpBonus:a.xpBonus})}if(a>=5&&a<7){let a=await (0,s.awardBadge)(e,"early_bird");a.awarded&&a.badge&&r.badgesEarned.push({badgeKey:"early_bird",badgeName:a.badge.name,xpBonus:a.xpBonus})}return r}[n,o,s,u]=c.then?(await c)():c,e.s(["checkTimeBasedBadges",()=>L,"onAIConversation",()=>x,"onLessonComplete",()=>m,"onLevelUp",()=>v,"onMessageSend",()=>z,"onMissionComplete",()=>q,"onQuizComplete",()=>f,"onSessionJoin",()=>D,"onSpeakingPractice",()=>k,"onUserLogin",()=>h]),r()}catch(e){r(e)}},!1)];

//# debugId=4df61ebb-efca-3070-8a50-76f404063176
//# sourceMappingURL=ADK_WORKSPACE_TutorMekimi_tutorme-app_src_lib_gamification_fb57774d._.js.map