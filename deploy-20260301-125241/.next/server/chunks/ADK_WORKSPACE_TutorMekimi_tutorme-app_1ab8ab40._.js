;!function(){try { var e="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof global?global:"undefined"!=typeof window?window:"undefined"!=typeof self?self:{},n=(new e.Error).stack;n&&((e._debugIds|| (e._debugIds={}))[n]="2e17fe16-61f1-c735-f7c9-abb6258ba037")}catch(e){}}();
module.exports=[778587,e=>e.a(async(t,r)=>{try{var s=e.i(254799),n=e.i(620971),i=e.i(909105),a=e.i(320947),o=e.i(384030),l=e.i(116192),u=e.i(738597);e.i(688768);var c=e.i(257357),d=e.i(748846),p=t([o,l,u]);[o,l,u]=p.then?(await p)():p;let m=["introduction","concept","example","practice","review"],h=(0,o.withCsrf)((0,o.withAuth)(async(e,t,r)=>{let p,h=await r?.params,{lessonId:w}=await h,{message:f,sessionId:g,currentSection:R}=await e.json();if(!f)throw new o.ValidationError("Message is required");let[S]=await u.drizzleDb.select().from(c.curriculumLesson).where((0,i.eq)(c.curriculumLesson.id,w)).limit(1);if(!S)throw new o.NotFoundError("Lesson not found");let[v]=await u.drizzleDb.select().from(c.curriculumModule).where((0,i.eq)(c.curriculumModule.id,S.moduleId)).limit(1),E={...S,module:v?{curriculumId:v.curriculumId,title:v.title}:{curriculumId:"",title:""}},C=null;if(g){let[e]=await u.drizzleDb.select().from(c.lessonSession).where((0,i.eq)(c.lessonSession.id,g)).limit(1);e&&(C=e)}if(!C){let[e]=await u.drizzleDb.select().from(c.lessonSession).where((0,i.and)((0,i.eq)(c.lessonSession.studentId,t.user.id),(0,i.eq)(c.lessonSession.lessonId,w))).limit(1);C=e||await (0,l.startLesson)(t.user.id,w)}let I=C;if(!I)throw Error("Failed to create lesson session");let x=(0,l.buildCurriculumPrompt)(I,E,f),b=I.sessionContext||{},y=b.messages||[];y.push({role:"user",content:f,timestamp:new Date().toISOString()});let A=(await (0,d.generateWithFallback)(x,{temperature:.7,maxTokens:2e3})).content,D=A,P=[],T=0,q=I.currentSection;try{let e=A.match(/\{[\s\S]*\}$/);if(e){let t=JSON.parse(e[0]);P=t.whiteboardItems||[],T=t.understandingLevel||0,q=t.nextSection||I.currentSection,D=A.replace(e[0],"").trim()}}catch(e){}y.push({role:"assistant",content:D,timestamp:new Date().toISOString()}),y.length>50&&y.splice(0,y.length-50);let N=I.conceptMastery||{};if(T>0){let e=E.teachingPoints?.[0]||"general";N[e]=Math.max(N[e]||0,T)}let M=m.indexOf(I.currentSection),O=m.indexOf(q),z={...b,messages:y,lastMessage:f,lastResponse:D},_=P.length>0?[...I.whiteboardItems||[],...P]:I.whiteboardItems;if(O>M||T>=80){let e=await (0,l.advanceLesson)(I,f),[t]=await u.drizzleDb.update(c.lessonSession).set({currentSection:e.newSection,conceptMastery:N,sessionContext:z,whiteboardItems:_}).where((0,i.eq)(c.lessonSession.id,I.id)).returning();p=t??I}else{let[e]=await u.drizzleDb.update(c.lessonSession).set({conceptMastery:N,sessionContext:z,whiteboardItems:_}).where((0,i.eq)(c.lessonSession.id,I.id)).returning();p=e??I}let U="review"===p.currentSection&&T>=80;if(U){await u.drizzleDb.update(c.lessonSession).set({status:"completed",completedAt:new Date}).where((0,i.eq)(c.lessonSession.id,I.id));let e=E.module?.curriculumId??v?.curriculumId;if(e){let[{count:r}]=await u.drizzleDb.select({count:a.sql`count(*)::int`}).from(c.curriculumLesson).innerJoin(c.curriculumModule,(0,i.eq)(c.curriculumModule.id,c.curriculumLesson.moduleId)).where((0,i.eq)(c.curriculumModule.curriculumId,e)),[n]=await u.drizzleDb.select().from(c.curriculumProgress).where((0,i.and)((0,i.eq)(c.curriculumProgress.studentId,t.user.id),(0,i.eq)(c.curriculumProgress.curriculumId,e))).limit(1);n?await u.drizzleDb.update(c.curriculumProgress).set({lessonsCompleted:n.lessonsCompleted+1,currentLessonId:w,averageScore:T}).where((0,i.eq)(c.curriculumProgress.id,n.id)):await u.drizzleDb.insert(c.curriculumProgress).values({id:s.default.randomUUID(),studentId:t.user.id,curriculumId:e,lessonsCompleted:1,totalLessons:r??0,currentLessonId:w,averageScore:T,isCompleted:!1,startedAt:new Date})}}return n.NextResponse.json({success:!0,response:D,whiteboardItems:P,understandingLevel:T,currentSection:p.currentSection,conceptMastery:p.conceptMastery,isComplete:U,sessionId:I.id})},{role:"STUDENT"})),w=(0,o.withAuth)(async(e,t,r)=>{let s=await r?.params,{lessonId:a}=await s,[o]=await u.drizzleDb.select().from(c.lessonSession).where((0,i.and)((0,i.eq)(c.lessonSession.studentId,t.user.id),(0,i.eq)(c.lessonSession.lessonId,a))).limit(1);if(!o)return n.NextResponse.json({session:null});let l=o.sessionContext||{};return n.NextResponse.json({session:{id:o.id,currentSection:o.currentSection,conceptMastery:o.conceptMastery,status:o.status,messages:l.messages||[]}})},{role:"STUDENT"});e.s(["GET",0,w,"POST",0,h]),r()}catch(e){r(e)}},!1),117862,e=>e.a(async(t,r)=>{try{var s=e.i(78315),n=e.i(586961),i=e.i(196657),a=e.i(899733),o=e.i(233979),l=e.i(631683),u=e.i(840960),c=e.i(711373),d=e.i(699699),p=e.i(521140),m=e.i(205260),h=e.i(500249),w=e.i(431740),f=e.i(82608),g=e.i(635207),R=e.i(193695);e.i(708038);var S=e.i(447430),v=e.i(778587),E=t([v]);[v]=E.then?(await E)():E;let x=new s.AppRouteRouteModule({definition:{kind:n.RouteKind.APP_ROUTE,page:"/api/curriculum/lessons/[lessonId]/chat/route",pathname:"/api/curriculum/lessons/[lessonId]/chat",filename:"route",bundlePath:""},distDir:".next",relativeProjectDir:"",resolvedPagePath:"[project]/ADK_WORKSPACE/TutorMekimi/tutorme-app/src/app/api/curriculum/lessons/[lessonId]/chat/route.ts",nextConfigOutput:"",userland:v}),{workAsyncStorage:b,workUnitAsyncStorage:y,serverHooks:A}=x;function C(){return(0,i.patchFetch)({workAsyncStorage:b,workUnitAsyncStorage:y})}async function I(e,t,r){x.isDev&&(0,a.addRequestMeta)(e,"devRequestTimingInternalsEnd",process.hrtime.bigint());let s="/api/curriculum/lessons/[lessonId]/chat/route";s=s.replace(/\/index$/,"")||"/";let i=await x.prepare(e,t,{srcPage:s,multiZoneDraftMode:!1});if(!i)return t.statusCode=400,t.end("Bad Request"),null==r.waitUntil||r.waitUntil.call(r,Promise.resolve()),null;let{buildId:v,params:E,nextConfig:C,parsedUrl:I,isDraftMode:b,prerenderManifest:y,routerServerContext:A,isOnDemandRevalidate:D,revalidateOnlyGenerated:P,resolvedPathname:T,clientReferenceManifest:q,serverActionsManifest:N}=i,M=(0,u.normalizeAppPath)(s),O=!!(y.dynamicRoutes[M]||y.routes[T]),z=async()=>((null==A?void 0:A.render404)?await A.render404(e,t,I,!1):t.end("This page could not be found"),null);if(O&&!b){let e=!!y.routes[T],t=y.dynamicRoutes[M];if(t&&!1===t.fallback&&!e){if(C.experimental.adapterPath)return await z();throw new R.NoFallbackError}}let _=null;!O||x.isDev||b||(_=T,_="/index"===_?"/":_);let U=!0===x.isDev||!O,H=O&&!U;N&&q&&(0,l.setManifestsSingleton)({page:s,clientReferenceManifest:q,serverActionsManifest:N});let k=e.method||"GET",L=(0,o.getTracer)(),j=L.getActiveScopeSpan(),F={params:E,prerenderManifest:y,renderOpts:{experimental:{authInterrupts:!!C.experimental.authInterrupts},cacheComponents:!!C.cacheComponents,supportsDynamicResponse:U,incrementalCache:(0,a.getRequestMeta)(e,"incrementalCache"),cacheLifeProfiles:C.cacheLife,waitUntil:r.waitUntil,onClose:e=>{t.on("close",e)},onAfterTaskError:void 0,onInstrumentationRequestError:(t,r,s,n)=>x.onRequestError(e,t,s,n,A)},sharedContext:{buildId:v}},K=new c.NodeNextRequest(e),$=new c.NodeNextResponse(t),B=d.NextRequestAdapter.fromNodeNextRequest(K,(0,d.signalFromNodeResponse)(t));try{let i=async e=>x.handle(B,F).finally(()=>{if(!e)return;e.setAttributes({"http.status_code":t.statusCode,"next.rsc":!1});let r=L.getRootSpanAttributes();if(!r)return;if(r.get("next.span_type")!==p.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${r.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let n=r.get("next.route");if(n){let t=`${k} ${n}`;e.setAttributes({"next.route":n,"http.route":n,"next.span_name":t}),e.updateName(t)}else e.updateName(`${k} ${s}`)}),l=!!(0,a.getRequestMeta)(e,"minimalMode"),u=async a=>{var o,u;let c=async({previousCacheEntry:n})=>{try{if(!l&&D&&P&&!n)return t.statusCode=404,t.setHeader("x-nextjs-cache","REVALIDATED"),t.end("This page could not be found"),null;let s=await i(a);e.fetchMetrics=F.renderOpts.fetchMetrics;let o=F.renderOpts.pendingWaitUntil;o&&r.waitUntil&&(r.waitUntil(o),o=void 0);let u=F.renderOpts.collectedTags;if(!O)return await (0,h.sendResponse)(K,$,s,F.renderOpts.pendingWaitUntil),null;{let e=await s.blob(),t=(0,w.toNodeOutgoingHttpHeaders)(s.headers);u&&(t[g.NEXT_CACHE_TAGS_HEADER]=u),!t["content-type"]&&e.type&&(t["content-type"]=e.type);let r=void 0!==F.renderOpts.collectedRevalidate&&!(F.renderOpts.collectedRevalidate>=g.INFINITE_CACHE)&&F.renderOpts.collectedRevalidate,n=void 0===F.renderOpts.collectedExpire||F.renderOpts.collectedExpire>=g.INFINITE_CACHE?void 0:F.renderOpts.collectedExpire;return{value:{kind:S.CachedRouteKind.APP_ROUTE,status:s.status,body:Buffer.from(await e.arrayBuffer()),headers:t},cacheControl:{revalidate:r,expire:n}}}}catch(t){throw(null==n?void 0:n.isStale)&&await x.onRequestError(e,t,{routerKind:"App Router",routePath:s,routeType:"route",revalidateReason:(0,m.getRevalidateReason)({isStaticGeneration:H,isOnDemandRevalidate:D})},!1,A),t}},d=await x.handleResponse({req:e,nextConfig:C,cacheKey:_,routeKind:n.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:y,isRoutePPREnabled:!1,isOnDemandRevalidate:D,revalidateOnlyGenerated:P,responseGenerator:c,waitUntil:r.waitUntil,isMinimalMode:l});if(!O)return null;if((null==d||null==(o=d.value)?void 0:o.kind)!==S.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==d||null==(u=d.value)?void 0:u.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});l||t.setHeader("x-nextjs-cache",D?"REVALIDATED":d.isMiss?"MISS":d.isStale?"STALE":"HIT"),b&&t.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let p=(0,w.fromNodeOutgoingHttpHeaders)(d.value.headers);return l&&O||p.delete(g.NEXT_CACHE_TAGS_HEADER),!d.cacheControl||t.getHeader("Cache-Control")||p.get("Cache-Control")||p.set("Cache-Control",(0,f.getCacheControlHeader)(d.cacheControl)),await (0,h.sendResponse)(K,$,new Response(d.value.body,{headers:p,status:d.value.status||200})),null};j?await u(j):await L.withPropagatedContext(e.headers,()=>L.trace(p.BaseServerSpan.handleRequest,{spanName:`${k} ${s}`,kind:o.SpanKind.SERVER,attributes:{"http.method":k,"http.target":e.url}},u))}catch(t){if(t instanceof R.NoFallbackError||await x.onRequestError(e,t,{routerKind:"App Router",routePath:M,routeType:"route",revalidateReason:(0,m.getRevalidateReason)({isStaticGeneration:H,isOnDemandRevalidate:D})},!1,A),O)throw t;return await (0,h.sendResponse)(K,$,new Response(null,{status:500})),null}}e.s(["handler",()=>I,"patchFetch",()=>C,"routeModule",()=>x,"serverHooks",()=>A,"workAsyncStorage",()=>b,"workUnitAsyncStorage",()=>y]),r()}catch(e){r(e)}},!1)];

//# debugId=2e17fe16-61f1-c735-f7c9-abb6258ba037
//# sourceMappingURL=ADK_WORKSPACE_TutorMekimi_tutorme-app_1ab8ab40._.js.map