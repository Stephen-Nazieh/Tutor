;!function(){try { var e="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof global?global:"undefined"!=typeof window?window:"undefined"!=typeof self?self:{},n=(new e.Error).stack;n&&((e._debugIds|| (e._debugIds={}))[n]="cd4da2a7-5c5e-5a08-f047-ce1737ec0e22")}catch(e){}}();
module.exports=[235311,e=>e.a(async(t,i)=>{try{var n=e.i(620971),r=e.i(909105),a=e.i(997103),s=e.i(384030),l=e.i(6286),o=e.i(738597);e.i(688768);var d=e.i(257357),c=e.i(491405),u=t([s,l,o]);[s,l,o]=u.then?(await u)():u;let p=parseInt(process.env.CACHE_TTL_PARENT_DASHBOARD||"300",10),h=(0,s.withAuth)(async(e,t)=>{let i=Date.now(),s=await (0,l.getFamilyAccountForParent)(t);if(!s)return n.NextResponse.json({error:"未找到家庭账户，请先完成家长注册"},{status:404});let u=`parent:dashboard:${s.id}:${t.user.id}`,h=await c.default.getOrSet(u,async()=>{let{studentIds:e}=s,i=new Date,n=new Date(i.getFullYear(),i.getMonth(),1),[l,c,u,p,h,y,g,f,A,w,v,R]=await Promise.all([e.length>0?o.drizzleDb.query.curriculumEnrollment.findMany({where:(0,r.inArray)(d.curriculumEnrollment.studentId,e),with:{curriculum:{columns:{id:!0,name:!0}}}}):Promise.resolve([]),e.length>0?o.drizzleDb.query.curriculumLessonProgress.findMany({where:(0,r.inArray)(d.curriculumLessonProgress.studentId,e),columns:{studentId:!0,status:!0,completedAt:!0}}):Promise.resolve([]),e.length>0?o.drizzleDb.query.userGamification.findMany({where:(0,r.inArray)(d.userGamification.userId,e),columns:{userId:!0,lastLogin:!0}}):Promise.resolve([]),e.length>0?o.drizzleDb.query.achievement.findMany({where:(0,r.inArray)(d.achievement.userId,e),orderBy:[(0,a.desc)(d.achievement.unlockedAt)],limit:10,columns:{id:!0,userId:!0,title:!0,description:!0,unlockedAt:!0}}):Promise.resolve([]),e.length>0?o.drizzleDb.query.taskSubmission.findMany({where:(0,r.inArray)(d.taskSubmission.studentId,e),columns:{id:!0,taskId:!0,studentId:!0,submittedAt:!0}}):Promise.resolve([]),e.length>0?o.drizzleDb.query.generatedTask.findMany({where:(0,r.inArray)(d.generatedTask.status,["assigned","completed"]),orderBy:[(0,a.desc)(d.generatedTask.createdAt)],limit:200,columns:{id:!0,dueDate:!0,assignments:!0}}):Promise.resolve([]),e.length>0?o.drizzleDb.query.clinicBooking.findMany({where:(0,r.inArray)(d.clinicBooking.studentId,e),with:{clinic:{columns:{title:!0,startTime:!0}}}}):Promise.resolve([]),o.drizzleDb.query.familyPayment.findMany({where:(0,r.and)((0,r.eq)(d.familyPayment.parentId,s.id),(0,r.gte)(d.familyPayment.createdAt,n)),orderBy:[(0,a.desc)(d.familyPayment.createdAt)],limit:100,columns:{id:!0,amount:!0,status:!0,createdAt:!0}}),e.length>0?o.drizzleDb.select({id:d.payment.id,amount:d.payment.amount}).from(d.payment).leftJoin(d.clinicBooking,(0,r.eq)(d.payment.bookingId,d.clinicBooking.id)).leftJoin(d.curriculumEnrollment,(0,r.eq)(d.payment.enrollmentId,d.curriculumEnrollment.id)).where((0,r.and)((0,r.eq)(d.payment.status,"COMPLETED"),(0,r.gte)(d.payment.createdAt,n),(0,r.or)((0,r.inArray)(d.clinicBooking.studentId,e),(0,r.inArray)(d.curriculumEnrollment.studentId,e)))):Promise.resolve([]),e.length>0?o.drizzleDb.select({id:d.payment.id,amount:d.payment.amount,createdAt:d.payment.createdAt,clinicTitle:d.clinic.title,clinicStartTime:d.clinic.startTime,curriculumName:d.curriculum.name}).from(d.payment).leftJoin(d.clinicBooking,(0,r.eq)(d.payment.bookingId,d.clinicBooking.id)).leftJoin(d.curriculumEnrollment,(0,r.eq)(d.payment.enrollmentId,d.curriculumEnrollment.id)).leftJoin(d.clinic,(0,r.eq)(d.clinicBooking.clinicId,d.clinic.id)).leftJoin(d.curriculum,(0,r.eq)(d.curriculumEnrollment.curriculumId,d.curriculum.id)).where((0,r.and)((0,r.inArray)(d.payment.status,["PENDING","PROCESSING"]),(0,r.or)((0,r.inArray)(d.clinicBooking.studentId,e),(0,r.inArray)(d.curriculumEnrollment.studentId,e)))).orderBy((0,a.desc)(d.payment.createdAt)).limit(20):Promise.resolve([]),o.drizzleDb.query.familyNotification.findMany({where:(0,r.eq)(d.familyNotification.parentId,s.id),orderBy:[(0,a.desc)(d.familyNotification.createdAt)],limit:10,columns:{id:!0,message:!0,isRead:!0,createdAt:!0}}),o.drizzleDb.query.parentActivityLog.findMany({where:(0,r.eq)(d.parentActivityLog.parentId,s.id),orderBy:[(0,a.desc)(d.parentActivityLog.createdAt)],limit:10,columns:{id:!0,action:!0,details:!0,createdAt:!0}})]),E=g.filter(e=>e.clinic&&new Date(e.clinic.startTime)>=i),I=new Set(h.map(e=>`${e.studentId}:${e.taskId}`)),P=new Map;for(let t of e)P.set(t,0);for(let t of y){let i=t.assignments||{};for(let n of e)Object.prototype.hasOwnProperty.call(i,n)&&(I.has(`${n}:${t.id}`)||P.set(n,(P.get(n)??0)+1))}let T=s.members.filter(e=>["child","children"].includes(e.relation.toLowerCase())).map(e=>{let t=e.userId,i=l.filter(e=>e.studentId===t),n=c.filter(e=>e.studentId===t),r=n.filter(e=>"COMPLETED"===e.status).length,a=n.length,s=u.find(e=>e.userId===t),o=p.find(e=>e.userId===t),d=E.filter(e=>e.studentId===t).length,h=t?P.get(t)??0:0;return{id:t||e.id,name:e.user?.profile?.name||e.name,grade:e.user?.profile?.gradeLevel||"Not set",avatar:(e.name||"?").slice(0,2).toUpperCase(),upcomingClasses:d,assignmentsDue:h,progress:a>0?Math.round(r/a*100):0,lastActive:s?.lastLogin?m(s.lastLogin):"—",subjects:[...new Set(i.map(e=>e.curriculum?.name).filter(Boolean))],recentAchievement:o?.title||null}}),C=f.filter(e=>"completed"===e.status||"paid"===e.status).reduce((e,t)=>e+t.amount,0),b=(Array.isArray(A)?A:[]).reduce((e,t)=>e+(t.amount??0),0),D=[...R.slice(0,5).map(e=>({id:e.id,type:"activity",description:e.action+(e.details?`: ${e.details}`:""),time:m(e.createdAt),_ts:e.createdAt.getTime()})),...p.slice(0,3).map(e=>({id:e.id,type:"achievement_earned",description:`${e.title} - ${e.description}`,time:m(e.unlockedAt),_ts:new Date(e.unlockedAt).getTime()}))].sort((e,t)=>t._ts-e._ts).slice(0,10).map(({_ts:e,...t})=>t);return{parentName:t.user?.name||s.familyName,children:T,financialSummary:{monthlyBudget:s.monthlyBudget,spentThisMonth:C+b,upcomingPayments:(Array.isArray(w)?w:[]).slice(0,5).map(e=>({id:e.id,description:e.clinicTitle??e.curriculumName??"Pending payment",amount:e.amount,dueDate:(e.clinicStartTime??e.createdAt)instanceof Date?(e.clinicStartTime??e.createdAt).toISOString().slice(0,10):String(e.clinicStartTime??e.createdAt).slice(0,10)}))},recentActivity:D,notifications:v.map(e=>({id:e.id,type:"info",message:e.message,read:e.isRead})),stats:{totalChildren:T.length,upcomingClasses:T.reduce((e,t)=>e+t.upcomingClasses,0),assignmentsDue:T.reduce((e,t)=>e+t.assignmentsDue,0),unreadNotifications:v.filter(e=>!e.isRead).length}}},{ttl:p,tags:[`family:${s.id}`,`parent:${t.user.id}`,"dashboard"]}),y=n.NextResponse.json({success:!0,data:h});return y.headers.set("X-Response-Time",`${Date.now()-i}ms`),y},{role:"PARENT"});function m(e){let t=Date.now()-new Date(e).getTime(),i=Math.floor(t/6e4),n=Math.floor(t/36e5),r=Math.floor(t/864e5);return i<1?"刚刚":i<60?`${i}分钟前`:n<24?`${n}小时前`:r<7?`${r}天前`:new Date(e).toLocaleDateString("zh-CN")}e.s(["GET",0,h]),i()}catch(e){i(e)}},!1),265301,e=>e.a(async(t,i)=>{try{var n=e.i(78315),r=e.i(586961),a=e.i(196657),s=e.i(899733),l=e.i(233979),o=e.i(631683),d=e.i(840960),c=e.i(711373),u=e.i(699699),m=e.i(521140),p=e.i(205260),h=e.i(500249),y=e.i(431740),g=e.i(82608),f=e.i(635207),A=e.i(193695);e.i(708038);var w=e.i(447430),v=e.i(235311),R=t([v]);[v]=R.then?(await R)():R;let P=new n.AppRouteRouteModule({definition:{kind:r.RouteKind.APP_ROUTE,page:"/api/parent/dashboard/route",pathname:"/api/parent/dashboard",filename:"route",bundlePath:""},distDir:".next",relativeProjectDir:"",resolvedPagePath:"[project]/ADK_WORKSPACE/TutorMekimi/tutorme-app/src/app/api/parent/dashboard/route.ts",nextConfigOutput:"",userland:v}),{workAsyncStorage:T,workUnitAsyncStorage:C,serverHooks:b}=P;function E(){return(0,a.patchFetch)({workAsyncStorage:T,workUnitAsyncStorage:C})}async function I(e,t,i){P.isDev&&(0,s.addRequestMeta)(e,"devRequestTimingInternalsEnd",process.hrtime.bigint());let n="/api/parent/dashboard/route";n=n.replace(/\/index$/,"")||"/";let a=await P.prepare(e,t,{srcPage:n,multiZoneDraftMode:!1});if(!a)return t.statusCode=400,t.end("Bad Request"),null==i.waitUntil||i.waitUntil.call(i,Promise.resolve()),null;let{buildId:v,params:R,nextConfig:E,parsedUrl:I,isDraftMode:T,prerenderManifest:C,routerServerContext:b,isOnDemandRevalidate:D,revalidateOnlyGenerated:N,resolvedPathname:S,clientReferenceManifest:k,serverActionsManifest:q}=a,x=(0,d.normalizeAppPath)(n),M=!!(C.dynamicRoutes[x]||C.routes[S]),O=async()=>((null==b?void 0:b.render404)?await b.render404(e,t,I,!1):t.end("This page could not be found"),null);if(M&&!T){let e=!!C.routes[S],t=C.dynamicRoutes[x];if(t&&!1===t.fallback&&!e){if(E.experimental.adapterPath)return await O();throw new A.NoFallbackError}}let _=null;!M||P.isDev||T||(_=S,_="/index"===_?"/":_);let z=!0===P.isDev||!M,B=M&&!z;q&&k&&(0,o.setManifestsSingleton)({page:n,clientReferenceManifest:k,serverActionsManifest:q});let $=e.method||"GET",H=(0,l.getTracer)(),L=H.getActiveScopeSpan(),U={params:R,prerenderManifest:C,renderOpts:{experimental:{authInterrupts:!!E.experimental.authInterrupts},cacheComponents:!!E.cacheComponents,supportsDynamicResponse:z,incrementalCache:(0,s.getRequestMeta)(e,"incrementalCache"),cacheLifeProfiles:E.cacheLife,waitUntil:i.waitUntil,onClose:e=>{t.on("close",e)},onAfterTaskError:void 0,onInstrumentationRequestError:(t,i,n,r)=>P.onRequestError(e,t,n,r,b)},sharedContext:{buildId:v}},j=new c.NodeNextRequest(e),F=new c.NodeNextResponse(t),K=u.NextRequestAdapter.fromNodeNextRequest(j,(0,u.signalFromNodeResponse)(t));try{let a=async e=>P.handle(K,U).finally(()=>{if(!e)return;e.setAttributes({"http.status_code":t.statusCode,"next.rsc":!1});let i=H.getRootSpanAttributes();if(!i)return;if(i.get("next.span_type")!==m.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${i.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let r=i.get("next.route");if(r){let t=`${$} ${r}`;e.setAttributes({"next.route":r,"http.route":r,"next.span_name":t}),e.updateName(t)}else e.updateName(`${$} ${n}`)}),o=!!(0,s.getRequestMeta)(e,"minimalMode"),d=async s=>{var l,d;let c=async({previousCacheEntry:r})=>{try{if(!o&&D&&N&&!r)return t.statusCode=404,t.setHeader("x-nextjs-cache","REVALIDATED"),t.end("This page could not be found"),null;let n=await a(s);e.fetchMetrics=U.renderOpts.fetchMetrics;let l=U.renderOpts.pendingWaitUntil;l&&i.waitUntil&&(i.waitUntil(l),l=void 0);let d=U.renderOpts.collectedTags;if(!M)return await (0,h.sendResponse)(j,F,n,U.renderOpts.pendingWaitUntil),null;{let e=await n.blob(),t=(0,y.toNodeOutgoingHttpHeaders)(n.headers);d&&(t[f.NEXT_CACHE_TAGS_HEADER]=d),!t["content-type"]&&e.type&&(t["content-type"]=e.type);let i=void 0!==U.renderOpts.collectedRevalidate&&!(U.renderOpts.collectedRevalidate>=f.INFINITE_CACHE)&&U.renderOpts.collectedRevalidate,r=void 0===U.renderOpts.collectedExpire||U.renderOpts.collectedExpire>=f.INFINITE_CACHE?void 0:U.renderOpts.collectedExpire;return{value:{kind:w.CachedRouteKind.APP_ROUTE,status:n.status,body:Buffer.from(await e.arrayBuffer()),headers:t},cacheControl:{revalidate:i,expire:r}}}}catch(t){throw(null==r?void 0:r.isStale)&&await P.onRequestError(e,t,{routerKind:"App Router",routePath:n,routeType:"route",revalidateReason:(0,p.getRevalidateReason)({isStaticGeneration:B,isOnDemandRevalidate:D})},!1,b),t}},u=await P.handleResponse({req:e,nextConfig:E,cacheKey:_,routeKind:r.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:C,isRoutePPREnabled:!1,isOnDemandRevalidate:D,revalidateOnlyGenerated:N,responseGenerator:c,waitUntil:i.waitUntil,isMinimalMode:o});if(!M)return null;if((null==u||null==(l=u.value)?void 0:l.kind)!==w.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==u||null==(d=u.value)?void 0:d.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});o||t.setHeader("x-nextjs-cache",D?"REVALIDATED":u.isMiss?"MISS":u.isStale?"STALE":"HIT"),T&&t.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let m=(0,y.fromNodeOutgoingHttpHeaders)(u.value.headers);return o&&M||m.delete(f.NEXT_CACHE_TAGS_HEADER),!u.cacheControl||t.getHeader("Cache-Control")||m.get("Cache-Control")||m.set("Cache-Control",(0,g.getCacheControlHeader)(u.cacheControl)),await (0,h.sendResponse)(j,F,new Response(u.value.body,{headers:m,status:u.value.status||200})),null};L?await d(L):await H.withPropagatedContext(e.headers,()=>H.trace(m.BaseServerSpan.handleRequest,{spanName:`${$} ${n}`,kind:l.SpanKind.SERVER,attributes:{"http.method":$,"http.target":e.url}},d))}catch(t){if(t instanceof A.NoFallbackError||await P.onRequestError(e,t,{routerKind:"App Router",routePath:x,routeType:"route",revalidateReason:(0,p.getRevalidateReason)({isStaticGeneration:B,isOnDemandRevalidate:D})},!1,b),M)throw t;return await (0,h.sendResponse)(j,F,new Response(null,{status:500})),null}}e.s(["handler",()=>I,"patchFetch",()=>E,"routeModule",()=>P,"serverHooks",()=>b,"workAsyncStorage",()=>T,"workUnitAsyncStorage",()=>C]),i()}catch(e){i(e)}},!1)];

//# debugId=cd4da2a7-5c5e-5a08-f047-ce1737ec0e22
//# sourceMappingURL=ADK_WORKSPACE_TutorMekimi_tutorme-app_3c2940f3._.js.map