{
  "version": 3,
  "sources": [],
  "debugId": "c26b6240-6426-7cc6-1579-e2e3f800578a",
  "sections": [
    {"offset": {"line": 1, "column": 0}, "map": {"version":3,"sources":["../../../../../../ADK_WORKSPACE/TutorMekimi/tutorme-app/src/lib/security/suspicious-activity.ts"],"sourcesContent":["/**\n * Suspicious activity: log failed logins and optionally alert when threshold exceeded.\n * Drizzle ORM.\n */\n\nimport { eq, and, gte, sql } from 'drizzle-orm'\nimport { drizzleDb } from '@/lib/db/drizzle'\nimport { securityEvent } from '@/lib/db/schema'\nimport crypto from 'crypto'\n\nconst FAILED_LOGIN_THRESHOLD = 5\nconst FAILED_LOGIN_WINDOW_MS = 15 * 60 * 1000 // 15 minutes\n\nexport async function logFailedLogin(ip: string | null, identifier?: string): Promise<void> {\n  try {\n    await drizzleDb.insert(securityEvent).values({\n      id: crypto.randomUUID(),\n      eventType: 'auth_failed',\n      ip: ip ?? undefined,\n      metadata: identifier ? { identifierHash: hashForLog(identifier) } : {},\n    })\n  } catch (e) {\n    console.error('Failed to log security event:', e)\n  }\n}\n\nfunction hashForLog(s: string): string {\n  return crypto.createHash('sha256').update(s).digest('hex').slice(0, 16)\n}\n\n/**\n * Returns true if the IP has exceeded failed login threshold (possible brute force).\n */\nexport async function isSuspiciousIp(ip: string): Promise<boolean> {\n  const since = new Date(Date.now() - FAILED_LOGIN_WINDOW_MS)\n  const [row] = await drizzleDb\n    .select({ count: sql<number>`count(*)::int` })\n    .from(securityEvent)\n    .where(\n      and(\n        eq(securityEvent.eventType, 'auth_failed'),\n        eq(securityEvent.ip, ip),\n        gte(securityEvent.createdAt, since)\n      )\n    )\n  return (row?.count ?? 0) >= FAILED_LOGIN_THRESHOLD\n}\n"],"names":[],"mappings":"+CAKA,IAAA,EAAA,EAAA,CAAA,CAAA,QAAA,EAAA,EAAA,CAAA,CAAA,QACA,EAAA,EAAA,CAAA,CAAA,QACA,EAAA,CAAA,CAAA,QAAA,IAAA,EAAA,EAAA,CAAA,CAAA,QACA,EAAA,EAAA,CAAA,CAAA,iBAKO,eAAe,EAAe,CAAiB,CAAE,CAAmB,EACzE,GAAI,MACF,OAAM,EAAA,SAAS,CAAC,MAAM,CAAC,EAAA,aAAa,EAAE,MAAM,CAAC,CAC3C,GAAI,EAAA,OAAM,CAAC,UAAU,GACrB,UAAW,cACX,GAAI,QAAM,EACV,SAAU,EAAa,CAAE,cAAA,EAAgB,AAO3B,CAAS,CAP6B,EAQjD,EAAA,OAAM,CAAC,UAAU,CAAC,UAAU,MAAM,CAAC,GAAG,MAAM,CAAC,OAAO,KAAK,CAAC,EAAG,IARA,EAAI,CAAC,CACvE,EACF,CAAE,MAAO,EAAG,CACV,QAAQ,KAAK,CAAC,gCAAiC,EACjD,CACF,CASO,eAAe,EAAe,CAAU,EAC7C,IAAM,EAAQ,IAAI,KAAK,KAAK,GAAG,GAvBF,EAuBO,GAvBF,AAwB5B,CAAC,EAAI,CAAG,CAxByB,KAAK,AAwBxB,EAAA,SAAS,CAC1B,CAzBsD,KAyBhD,CAAC,CAAE,MAAO,EAAA,GAAW,CAAC,aAAa,CAAC,AAAC,GAC3C,IAAI,CAAC,EAAA,aAAa,EAClB,KAAK,CACJ,CAAA,EAAA,EAAA,GAAA,AAAG,EACD,CAAA,EAAA,EAAA,EAAA,AAAE,EAAC,EAAA,aAAa,CAAC,SAAS,CAAE,eAC5B,CAAA,EAAA,EAAA,EAAA,AAAE,EAAC,EAAA,aAAa,CAAC,EAAE,CAAE,GACrB,CAAA,EAAA,EAAA,GAAA,AAAG,EAAC,EAAA,aAAa,CAAC,SAAS,CAAE,KAGnC,MAAO,CAAC,GAAK,QAAS,CAAC,EAnCM,CAoC/B,EAD8B"}}]
}