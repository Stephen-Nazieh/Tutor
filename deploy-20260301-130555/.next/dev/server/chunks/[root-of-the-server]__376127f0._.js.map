{
  "version": 3,
  "sources": [],
  "debugId": "7db32e8c-cbe1-182d-11f3-cc2bfa637e2c",
  "sections": [
    {"offset": {"line": 53, "column": 0}, "map": {"version":3,"sources":["file:///Users/nazy/ADK_WORKSPACE/TutorMekimi/tutorme-app/src/lib/db/index.ts"],"sourcesContent":["/* eslint-disable @typescript-eslint/no-explicit-any */\n/* eslint-disable @typescript-eslint/no-require-imports */\n\n/**\n * Database Client with Connection Pooling\n * \n * Features:\n * - Connection pooling for high concurrency (100+ users)\n * - Query caching with Redis\n * - Read replica support for scaling\n * - N+1 query prevention with dataloaders\n * \n * Note: Redis is lazily initialized to avoid bundling issues\n */\n\n// Connection pool configuration\nconst POOL_CONFIG = {\n  // Connection pool settings for 100+ concurrent users\n  min: 5,                    // Minimum connections\n  max: 50,                   // Maximum connections (supports 100+ concurrent users)\n  idleTimeoutMillis: 30000,  // Close idle connections after 30s\n  connectionTimeoutMillis: 5000, // Connection timeout\n  allowExitOnIdle: false,    // Keep pool alive\n}\n\n// Query cache configuration\nconst CACHE_CONFIG = {\n  ttl: 60,                   // Default cache TTL in seconds\n  staleWhileRevalidate: 30,  // Serve stale data while refreshing\n  prefix: 'tutorme:query:',  // Cache key prefix\n}\n\nlet db: any\nlet redis: any | null = null\nlet queryCache: Map<string, { data: any; expires: number }> | null = null\nlet redisInitialized = false\n\n// Safe check for server-side environment (not Edge Runtime)\n// Edge Runtime (used by Next.js middleware) doesn't support Prisma Client\nconst isEdgeRuntime = typeof (globalThis as any).EdgeRuntime !== 'undefined' || \n  (typeof process !== 'undefined' && process.env.NEXT_RUNTIME === 'edge')\nconst isServer = typeof window === 'undefined' && !isEdgeRuntime\n\n// Initialize in-memory cache only on server\nfunction getQueryCache() {\n  if (!isServer) return null\n  if (!queryCache) {\n    queryCache = new Map()\n  }\n  return queryCache\n}\n\n// Initialize Redis client if available (server-side only)\nasync function initRedis() {\n  if (!isServer) return null\n  if (redisInitialized) return redis\n  \n  try {\n    const redisUrl = process.env.REDIS_URL\n    if (!redisUrl) {\n      console.log('[DB] Redis URL not configured, using in-memory cache')\n      redisInitialized = true\n      return null\n    }\n    \n    // Dynamic import to avoid bundling issues\n    const { Redis } = await import('ioredis')\n    redis = new Redis(redisUrl, {\n      retryStrategy: (times) => Math.min(times * 50, 2000),\n      maxRetriesPerRequest: 3,\n    })\n    \n    redis.on('error', (err: any) => {\n      console.error('[Redis] Connection error:', err)\n      redis = null\n    })\n    \n    console.log('[DB] Redis cache initialized')\n    redisInitialized = true\n    return redis\n  } catch (e) {\n    console.warn('[DB] Failed to initialize Redis, using in-memory cache')\n    redisInitialized = true\n    return null\n  }\n}\n\n// Initialize Prisma Client with connection pooling (server-side only)\nif (isServer) {\n  try {\n    const { PrismaClient } = require('@prisma/client')\n    \n    const globalForPrisma = globalThis as unknown as {\n      prisma: typeof PrismaClient | undefined\n      redis: any | null\n      redisInitialized: boolean\n    }\n    \n    // Initialize Redis on first use (lazy initialization)\n    if (globalForPrisma.redisInitialized) {\n      redis = globalForPrisma.redis\n      redisInitialized = true\n    }\n    \n    if (process.env.NODE_ENV !== 'production') {\n      globalForPrisma.redis = redis\n      globalForPrisma.redisInitialized = redisInitialized\n    }\n    \n    // Initialize Prisma with connection pooling\n    if (globalForPrisma.prisma) {\n      db = globalForPrisma.prisma\n    } else {\n      db = new PrismaClient({\n        log: process.env.NODE_ENV === 'development' \n          ? ['query', 'error', 'warn'] \n          : ['error'],\n        \n        // Connection pooling configuration\n        datasources: {\n          db: {\n            url: process.env.DATABASE_URL,\n          },\n        },\n      })\n      \n      // Add connection pool monitoring\n      db.$on('query', (e: any) => {\n        if (process.env.NODE_ENV === 'development') {\n          console.log('[Prisma Query]', e.query, `${e.duration}ms`)\n        }\n      })\n      \n      if (process.env.NODE_ENV !== 'production') {\n        globalForPrisma.prisma = db\n      }\n    }\n    \n    console.log('[DB] Prisma Client initialized with connection pooling')\n  } catch (e) {\n    console.error('[DB] Failed to initialize Prisma:', e)\n    // Fallback for build time\n    db = {\n      $connect: async () => {},\n      $disconnect: async () => {},\n    }\n  }\n} else {\n  // Client-side mock\n  db = {\n    $connect: async () => {},\n    $disconnect: async () => {},\n  }\n}\n\n/**\n * Cache utilities\n */\nexport const cache = {\n  /**\n   * Ensure Redis is initialized\n   */\n  async ensureRedis() {\n    if (!isServer) return null\n    if (!redisInitialized) {\n      await initRedis()\n    }\n    return redis\n  },\n\n  /**\n   * Get cached value\n   */\n  async get<T>(key: string): Promise<T | null> {\n    if (!isServer) return null\n    \n    const fullKey = CACHE_CONFIG.prefix + key\n    \n    // Try Redis first\n    const client = await this.ensureRedis()\n    if (client) {\n      try {\n        const value = await client.get(fullKey)\n        if (value) return JSON.parse(value)\n      } catch (e) {\n        console.error('[Cache] Redis get error:', e)\n      }\n    }\n    \n    // Fallback to in-memory cache\n    const cache = getQueryCache()\n    if (!cache) return null\n    \n    const cached = cache.get(fullKey)\n    if (cached && cached.expires > Date.now()) {\n      return cached.data\n    }\n    \n    cache.delete(fullKey)\n    return null\n  },\n  \n  /**\n   * Set cached value\n   */\n  async set<T>(key: string, value: T, ttlSeconds = CACHE_CONFIG.ttl): Promise<void> {\n    if (!isServer) return\n    \n    const fullKey = CACHE_CONFIG.prefix + key\n    \n    // Try Redis first\n    const client = await this.ensureRedis()\n    if (client) {\n      try {\n        await client.setex(fullKey, ttlSeconds, JSON.stringify(value))\n        return\n      } catch (e) {\n        console.error('[Cache] Redis set error:', e)\n      }\n    }\n    \n    // Fallback to in-memory cache\n    const cache = getQueryCache()\n    if (cache) {\n      cache.set(fullKey, {\n        data: value,\n        expires: Date.now() + ttlSeconds * 1000\n      })\n    }\n  },\n  \n  /**\n   * Delete cached value\n   */\n  async delete(key: string): Promise<void> {\n    if (!isServer) return\n    \n    const fullKey = CACHE_CONFIG.prefix + key\n    \n    const client = await this.ensureRedis()\n    if (client) {\n      try {\n        await client.del(fullKey)\n      } catch (e) {\n        console.error('[Cache] Redis del error:', e)\n      }\n    }\n    \n    const cache = getQueryCache()\n    if (cache) cache.delete(fullKey)\n  },\n  \n  /**\n   * Clear all cached values\n   */\n  async clear(): Promise<void> {\n    if (!isServer) return\n    \n    const client = await this.ensureRedis()\n    if (client) {\n      try {\n        const keys = await client.keys(CACHE_CONFIG.prefix + '*')\n        if (keys.length > 0) {\n          await client.del(...keys)\n        }\n      } catch (e) {\n        console.error('[Cache] Redis clear error:', e)\n      }\n    }\n    \n    const cache = getQueryCache()\n    if (cache) cache.clear()\n  },\n  \n  /**\n   * Get or set cached value\n   */\n  async getOrSet<T>(\n    key: string,\n    factory: () => Promise<T>,\n    ttlSeconds = CACHE_CONFIG.ttl\n  ): Promise<T> {\n    const cached = await this.get<T>(key)\n    if (cached !== null) return cached\n    \n    const value = await factory()\n    await this.set(key, value, ttlSeconds)\n    return value\n  },\n\n  /**\n   * Invalidate cache for a pattern\n   */\n  async invalidatePattern(pattern: string): Promise<void> {\n    if (!isServer) return\n    \n    const client = await this.ensureRedis()\n    if (client) {\n      try {\n        const keys = await client.keys(CACHE_CONFIG.prefix + pattern)\n        if (keys.length > 0) {\n          await client.del(...keys)\n        }\n      } catch (e) {\n        console.error('[Cache] Pattern invalidation error:', e)\n      }\n    }\n    \n    // Clear in-memory cache matching pattern\n    const cache = getQueryCache()\n    if (cache) {\n      const regex = new RegExp(CACHE_CONFIG.prefix + pattern.replace('*', '.*'))\n      for (const key of cache.keys()) {\n        if (regex.test(key)) cache.delete(key)\n      }\n    }\n  }\n}\n\n/**\n * Query optimization utilities\n */\nexport const queryOptimizer = {\n  /**\n   * Batch load function for N+1 prevention\n   */\n  async batchLoad<T>(\n    ids: string[],\n    fetchFn: (ids: string[]) => Promise<T[]>,\n    getId: (item: T) => string\n  ): Promise<(T | null)[]> {\n    if (!isServer) return ids.map(() => null)\n    if (ids.length === 0) return []\n    \n    // Deduplicate IDs\n    const uniqueIds = [...new Set(ids)]\n    \n    // Fetch all items in one query\n    const items = await fetchFn(uniqueIds)\n    \n    // Create lookup map\n    const itemMap = new Map(items.map(item => [getId(item), item]))\n    \n    // Return items in original order\n    return ids.map(id => itemMap.get(id) || null)\n  },\n  \n  /**\n   * Wrap a query with caching\n   */\n  async cachedQuery<T>(\n    cacheKey: string,\n    queryFn: () => Promise<T>,\n    ttlSeconds = CACHE_CONFIG.ttl\n  ): Promise<T> {\n    return cache.getOrSet(cacheKey, queryFn, ttlSeconds)\n  }\n}\n\n/**\n * Read replica support (for future scaling)\n */\nexport const readReplica = {\n  /**\n   * Check if read replicas are configured\n   */\n  isConfigured(): boolean {\n    return isServer && !!process.env.DATABASE_READ_REPLICA_URL\n  },\n  \n  /**\n   * Get read-only database client\n   * Falls back to primary if replicas not configured\n   */\n  getClient() {\n    // For now, return the same client\n    // In production, this would return a connection to the read replica\n    return db\n  }\n}\n\nexport { db }\n/** Alias for code that imports prisma from @/lib/db */\nexport const prisma = db\n\n// Re-export Prisma types (will be empty on client)\nexport * from '@prisma/client'\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 424, "column": 0}, "map": {"version":3,"sources":["file:///Users/nazy/ADK_WORKSPACE/TutorMekimi/tutorme-app/src/lib/auth.ts"],"sourcesContent":["/**\n * NextAuth Configuration\n * Handles authentication for students, tutors, and admins\n */\n\nimport { NextAuthOptions } from 'next-auth'\nimport CredentialsProvider from 'next-auth/providers/credentials'\nimport { PrismaAdapter } from '@next-auth/prisma-adapter'\nimport { db } from '@/lib/db'\nimport bcrypt from 'bcryptjs'\n\nexport const authOptions: NextAuthOptions = {\n  adapter: PrismaAdapter(db),\n\n  providers: [\n    // Email/Password Login\n    CredentialsProvider({\n      name: 'credentials',\n      credentials: {\n        email: { label: 'Email', type: 'email' },\n        password: { label: 'Password', type: 'password' }\n      },\n      async authorize(credentials) {\n        if (!credentials?.email || !credentials?.password) {\n          return null\n        }\n\n        const normalizedEmail = credentials.email.trim().toLowerCase()\n\n        // Find user by email\n        const user = await db.user.findFirst({\n          where: { email: { equals: normalizedEmail, mode: 'insensitive' } },\n          include: { profile: true }\n        })\n\n        if (!user || !user.password) {\n          return null\n        }\n\n        // Verify password\n        const isValid = await bcrypt.compare(credentials.password, user.password)\n\n        if (!isValid) {\n          const { logFailedLogin } = await import('@/lib/security/suspicious-activity')\n          await logFailedLogin(null, normalizedEmail)\n          return null\n        }\n\n\n        // Check if onboarding is complete\n        const onboardingComplete = checkOnboardingComplete(user)\n        const tosAccepted = user.profile?.tosAccepted || false\n\n        return {\n          id: user.id,\n          email: user.email,\n          name: user.profile?.name || user.email,\n          role: user.role,\n          image: user.profile?.avatarUrl,\n          onboardingComplete,\n          tosAccepted\n        }\n      }\n    })\n  ],\n\n  // WeChat OAuth - To be added later\n  // WeChatProvider({\n  //   clientId: process.env.WECHAT_APP_ID!,\n  //   clientSecret: process.env.WECHAT_APP_SECRET!,\n  // })\n  // ], // This was an extra closing bracket for providers array, removed it.\n\n  callbacks: {\n    async jwt({ token, user, trigger, session }) {\n      if (user) {\n        token.role = user.role\n        token.id = user.id\n        token.onboardingComplete = user.onboardingComplete\n        token.tosAccepted = user.tosAccepted\n      }\n\n      // Handle session update (e.g., after onboarding completes)\n      if (trigger === 'update' && session) {\n        token.onboardingComplete = true\n      }\n\n      return token\n    },\n\n    async session({ session, token }) {\n      if (session.user) {\n        session.user.role = token.role as string\n        session.user.id = token.id as string\n        session.user.onboardingComplete = token.onboardingComplete as boolean\n        session.user.tosAccepted = token.tosAccepted as boolean\n      }\n      return session\n    }\n  },\n\n  pages: {\n    signIn: '/login',\n    error: '/login'\n  },\n\n  session: {\n    strategy: 'jwt',\n    maxAge: 30 * 24 * 60 * 60 // 30 days\n  },\n\n  secret: process.env.NEXTAUTH_SECRET\n}\n\n// Helper function to check if onboarding is complete\nfunction checkOnboardingComplete(user: { profile?: { isOnboarded?: boolean | null } | null }): boolean {\n  // Check if user profile exists and has completed onboarding\n  if (!user?.profile) {\n    return false\n  }\n  \n  // Profile exists but isOnboarded field is not set (null/undefined) - consider not onboarded\n  if (user.profile.isOnboarded === null || user.profile.isOnboarded === undefined) {\n    return false\n  }\n  \n  // Return the actual onboarding status\n  return user.profile.isOnboarded\n}\n\n// Helper function to hash passwords\nexport async function hashPassword(password: string): Promise<string> {\n  return bcrypt.hash(password, 12)\n}\n\n// Helper function to check if user is authorized\nexport function isAuthorized(userRole: string, allowedRoles: string[]): boolean {\n  return allowedRoles.includes(userRole)\n}\n"],"names":[],"mappings":"AAAA;;;CAGC;;;;;;;;AAGD;AACA;AACA;AACA;;;;;AAEO,MAAM,cAA+B;IAC1C,SAAS,IAAA,yOAAa,EAAC,mMAAE;IAEzB,WAAW;QACT,uBAAuB;QACvB,IAAA,uNAAmB,EAAC;YAClB,MAAM;YACN,aAAa;gBACX,OAAO;oBAAE,OAAO;oBAAS,MAAM;gBAAQ;gBACvC,UAAU;oBAAE,OAAO;oBAAY,MAAM;gBAAW;YAClD;YACA,MAAM,WAAU,WAAW;gBACzB,IAAI,CAAC,aAAa,SAAS,CAAC,aAAa,UAAU;oBACjD,OAAO;gBACT;gBAEA,MAAM,kBAAkB,YAAY,KAAK,CAAC,IAAI,GAAG,WAAW;gBAE5D,qBAAqB;gBACrB,MAAM,OAAO,MAAM,mMAAE,CAAC,IAAI,CAAC,SAAS,CAAC;oBACnC,OAAO;wBAAE,OAAO;4BAAE,QAAQ;4BAAiB,MAAM;wBAAc;oBAAE;oBACjE,SAAS;wBAAE,SAAS;oBAAK;gBAC3B;gBAEA,IAAI,CAAC,QAAQ,CAAC,KAAK,QAAQ,EAAE;oBAC3B,OAAO;gBACT;gBAEA,kBAAkB;gBAClB,MAAM,UAAU,MAAM,gMAAM,CAAC,OAAO,CAAC,YAAY,QAAQ,EAAE,KAAK,QAAQ;gBAExE,IAAI,CAAC,SAAS;oBACZ,MAAM,EAAE,cAAc,EAAE,GAAG;oBAC3B,MAAM,eAAe,MAAM;oBAC3B,OAAO;gBACT;gBAGA,kCAAkC;gBAClC,MAAM,qBAAqB,wBAAwB;gBACnD,MAAM,cAAc,KAAK,OAAO,EAAE,eAAe;gBAEjD,OAAO;oBACL,IAAI,KAAK,EAAE;oBACX,OAAO,KAAK,KAAK;oBACjB,MAAM,KAAK,OAAO,EAAE,QAAQ,KAAK,KAAK;oBACtC,MAAM,KAAK,IAAI;oBACf,OAAO,KAAK,OAAO,EAAE;oBACrB;oBACA;gBACF;YACF;QACF;KACD;IAED,mCAAmC;IACnC,mBAAmB;IACnB,0CAA0C;IAC1C,kDAAkD;IAClD,KAAK;IACL,2EAA2E;IAE3E,WAAW;QACT,MAAM,KAAI,EAAE,KAAK,EAAE,IAAI,EAAE,OAAO,EAAE,OAAO,EAAE;YACzC,IAAI,MAAM;gBACR,MAAM,IAAI,GAAG,KAAK,IAAI;gBACtB,MAAM,EAAE,GAAG,KAAK,EAAE;gBAClB,MAAM,kBAAkB,GAAG,KAAK,kBAAkB;gBAClD,MAAM,WAAW,GAAG,KAAK,WAAW;YACtC;YAEA,2DAA2D;YAC3D,IAAI,YAAY,YAAY,SAAS;gBACnC,MAAM,kBAAkB,GAAG;YAC7B;YAEA,OAAO;QACT;QAEA,MAAM,SAAQ,EAAE,OAAO,EAAE,KAAK,EAAE;YAC9B,IAAI,QAAQ,IAAI,EAAE;gBAChB,QAAQ,IAAI,CAAC,IAAI,GAAG,MAAM,IAAI;gBAC9B,QAAQ,IAAI,CAAC,EAAE,GAAG,MAAM,EAAE;gBAC1B,QAAQ,IAAI,CAAC,kBAAkB,GAAG,MAAM,kBAAkB;gBAC1D,QAAQ,IAAI,CAAC,WAAW,GAAG,MAAM,WAAW;YAC9C;YACA,OAAO;QACT;IACF;IAEA,OAAO;QACL,QAAQ;QACR,OAAO;IACT;IAEA,SAAS;QACP,UAAU;QACV,QAAQ,KAAK,KAAK,KAAK,GAAG,UAAU;IACtC;IAEA,QAAQ,QAAQ,GAAG,CAAC,eAAe;AACrC;AAEA,qDAAqD;AACrD,SAAS,wBAAwB,IAA2D;IAC1F,4DAA4D;IAC5D,IAAI,CAAC,MAAM,SAAS;QAClB,OAAO;IACT;IAEA,4FAA4F;IAC5F,IAAI,KAAK,OAAO,CAAC,WAAW,KAAK,QAAQ,KAAK,OAAO,CAAC,WAAW,KAAK,WAAW;QAC/E,OAAO;IACT;IAEA,sCAAsC;IACtC,OAAO,KAAK,OAAO,CAAC,WAAW;AACjC;AAGO,eAAe,aAAa,QAAgB;IACjD,OAAO,gMAAM,CAAC,IAAI,CAAC,UAAU;AAC/B;AAGO,SAAS,aAAa,QAAgB,EAAE,YAAsB;IACnE,OAAO,aAAa,QAAQ,CAAC;AAC/B"}},
    {"offset": {"line": 564, "column": 0}, "map": {"version":3,"sources":["file:///Users/nazy/ADK_WORKSPACE/TutorMekimi/tutorme-app/src/lib/security/csrf.ts"],"sourcesContent":["/**\n * CSRF protection for state-changing API requests.\n * Uses a double-submit cookie pattern: cookie set on session, validated on POST/PUT/DELETE/PATCH.\n */\n\nimport { cookies } from 'next/headers'\nimport crypto from 'crypto'\n\nconst CSRF_COOKIE_NAME = 'tutorme_csrf'\nconst CSRF_HEADER_NAME = 'x-csrf-token'\nconst SECRET = process.env.NEXTAUTH_SECRET || process.env.CSRF_SECRET || 'csrf-secret-change-in-production'\n\nfunction hash(value: string): string {\n  return crypto.createHmac('sha256', SECRET).update(value).digest('hex')\n}\n\n/**\n * Generate a CSRF token for the current request. Call from a route or pass to client.\n */\nexport async function getCsrfToken(): Promise<string> {\n  const value = crypto.randomBytes(24).toString('hex')\n  const token = `${value}.${hash(value)}`\n  const cookieStore = await cookies()\n  cookieStore.set(CSRF_COOKIE_NAME, token, {\n    httpOnly: true,\n    secure: process.env.NODE_ENV === 'production',\n    sameSite: 'lax',\n    maxAge: 60 * 60 * 24, // 24h\n    path: '/'\n  })\n  return token\n}\n\n/**\n * Verify CSRF token from request header against cookie. Returns true if valid.\n */\nexport async function verifyCsrfToken(req: Request): Promise<boolean> {\n  try {\n    const headerToken = req.headers.get(CSRF_HEADER_NAME)\n    const cookieStore = await cookies()\n    const cookieToken = cookieStore.get(CSRF_COOKIE_NAME)?.value\n    if (!headerToken || !cookieToken) return false\n    if (headerToken !== cookieToken) return false\n\n    const [value] = headerToken.split('.')\n    if (!value) return false\n\n    const expected = `${value}.${hash(value)}`\n    const headerBuffer = Buffer.from(headerToken)\n    const expectedBuffer = Buffer.from(expected)\n    if (headerBuffer.length !== expectedBuffer.length) return false\n\n    return crypto.timingSafeEqual(headerBuffer, expectedBuffer)\n  } catch {\n    return false\n  }\n}\n\nexport { CSRF_HEADER_NAME }\n"],"names":[],"mappings":";;;;;;;;AAAA;;;CAGC,GAED;AACA;;;AAEA,MAAM,mBAAmB;AACzB,MAAM,mBAAmB;AACzB,MAAM,SAAS,QAAQ,GAAG,CAAC,eAAe,IAAI,QAAQ,GAAG,CAAC,WAAW,IAAI;AAEzE,SAAS,KAAK,KAAa;IACzB,OAAO,gHAAM,CAAC,UAAU,CAAC,UAAU,QAAQ,MAAM,CAAC,OAAO,MAAM,CAAC;AAClE;AAKO,eAAe;IACpB,MAAM,QAAQ,gHAAM,CAAC,WAAW,CAAC,IAAI,QAAQ,CAAC;IAC9C,MAAM,QAAQ,GAAG,MAAM,CAAC,EAAE,KAAK,QAAQ;IACvC,MAAM,cAAc,MAAM,IAAA,8LAAO;IACjC,YAAY,GAAG,CAAC,kBAAkB,OAAO;QACvC,UAAU;QACV,QAAQ,oDAAyB;QACjC,UAAU;QACV,QAAQ,KAAK,KAAK;QAClB,MAAM;IACR;IACA,OAAO;AACT;AAKO,eAAe,gBAAgB,GAAY;IAChD,IAAI;QACF,MAAM,cAAc,IAAI,OAAO,CAAC,GAAG,CAAC;QACpC,MAAM,cAAc,MAAM,IAAA,8LAAO;QACjC,MAAM,cAAc,YAAY,GAAG,CAAC,mBAAmB;QACvD,IAAI,CAAC,eAAe,CAAC,aAAa,OAAO;QACzC,IAAI,gBAAgB,aAAa,OAAO;QAExC,MAAM,CAAC,MAAM,GAAG,YAAY,KAAK,CAAC;QAClC,IAAI,CAAC,OAAO,OAAO;QAEnB,MAAM,WAAW,GAAG,MAAM,CAAC,EAAE,KAAK,QAAQ;QAC1C,MAAM,eAAe,OAAO,IAAI,CAAC;QACjC,MAAM,iBAAiB,OAAO,IAAI,CAAC;QACnC,IAAI,aAAa,MAAM,KAAK,eAAe,MAAM,EAAE,OAAO;QAE1D,OAAO,gHAAM,CAAC,eAAe,CAAC,cAAc;IAC9C,EAAE,OAAM;QACN,OAAO;IACT;AACF"}},
    {"offset": {"line": 621, "column": 0}, "map": {"version":3,"sources":["file:///Users/nazy/ADK_WORKSPACE/TutorMekimi/tutorme-app/src/lib/security/rate-limit.ts"],"sourcesContent":["/**\n * Rate limiting for API routes.\n * Uses Redis when REDIS_URL is set (shared across instances); otherwise in-memory store.\n */\nconst DEFAULT_WINDOW_MS = 60 * 1000 // 1 minute\nconst DEFAULT_MAX = 100 // requests per window per key\nconst REDIS_PREFIX = 'ratelimit:'\n\ninterface Entry {\n  count: number\n  resetAt: number\n}\n\ninterface RateLimitOptions {\n  max: number\n  windowMs?: number\n}\n\ninterface RateLimitResult {\n  allowed: boolean\n  remaining: number\n  resetAt: number\n}\n\nconst memoryStore = new Map<string, Entry>()\n\nfunction prune(): void {\n  const now = Date.now()\n  for (const [key, entry] of memoryStore.entries()) {\n    if (entry.resetAt < now) memoryStore.delete(key)\n  }\n}\n\nfunction checkRateLimitMemory(\n  key: string,\n  options: RateLimitOptions\n): RateLimitResult {\n  const { windowMs, max } = options\n  const now = Date.now()\n  if (memoryStore.size > 10000) prune()\n  let entry = memoryStore.get(key)\n  if (!entry || entry.resetAt < now) {\n    entry = { count: 0, resetAt: now + windowMs }\n    memoryStore.set(key, entry)\n  }\n  entry.count += 1\n  const allowed = entry.count <= max\n  const remaining = Math.max(0, max - entry.count)\n  return { allowed, remaining, resetAt: entry.resetAt }\n}\n\nlet redisClient: import('ioredis').Redis | null = null\nlet redisInitPromise: Promise<import('ioredis').Redis | null> | null = null\n\nasync function getRedisClient(): Promise<import('ioredis').Redis | null> {\n  if (redisClient) return redisClient\n  if (typeof window !== 'undefined') return null // browser\n  const url = process.env.REDIS_URL\n  if (!url) return null\n  if (!redisInitPromise) {\n    redisInitPromise = (async () => {\n      try {\n        const { Redis } = await import('ioredis')\n        const client = new Redis(url, {\n          retryStrategy: (times) => Math.min(times * 50, 2000),\n          maxRetriesPerRequest: 3,\n        })\n        client.on('error', () => {})\n        redisClient = client\n        return client\n      } catch {\n        return null\n      }\n    })()\n  }\n  return redisInitPromise\n}\n\nasync function checkRateLimitRedis(\n  key: string,\n  options: RateLimitOptions\n): Promise<RateLimitResult> {\n  const redis = await getRedisClient()\n  if (!redis) return checkRateLimitMemory(key, options)\n\n  const { windowMs, max } = options\n  const now = Date.now()\n  const fullKey = REDIS_PREFIX + key\n  const ttlSeconds = Math.ceil(windowMs / 1000)\n\n  try {\n    // Atomic Lua: INCR + EXPIRE (when count=1) in single round-trip - no race conditions\n    const result = (await redis.eval(\n      `local c=redis.call('INCR',KEYS[1]) if c==1 then redis.call('EXPIRE',KEYS[1],ARGV[1]) end return {c,redis.call('PTTL',KEYS[1])}`,\n      1,\n      fullKey,\n      ttlSeconds\n    )) as [number, number]\n    const [newCount, pttl] = result\n    const resetAt = pttl > 0 ? now + pttl : now + windowMs\n\n    const allowed = newCount <= max\n    const remaining = Math.max(0, max - newCount)\n    return { allowed, remaining, resetAt }\n  } catch {\n    return checkRateLimitMemory(key, options)\n  }\n}\n\n/**\n * Check rate limit. Returns { allowed, remaining, resetAt }.\n * Uses Redis when REDIS_URL is set; otherwise in-memory (per instance).\n * key: typically prefix + IP (e.g. \"login:\" + getClientIdentifier(req))\n */\nexport async function checkRateLimit(\n  key: string,\n  maxOrOptions: number | RateLimitOptions = DEFAULT_MAX\n): Promise<RateLimitResult> {\n  const options: RateLimitOptions =\n    typeof maxOrOptions === 'number'\n      ? { max: maxOrOptions, windowMs: DEFAULT_WINDOW_MS }\n      : { windowMs: DEFAULT_WINDOW_MS, ...maxOrOptions }\n\n  if (process.env.REDIS_URL) {\n    return checkRateLimitRedis(key, options)\n  }\n  return checkRateLimitMemory(key, options)\n}\n\n/** Presets for sensitive routes (stricter limits) */\nexport const RATE_LIMIT_PRESETS = {\n  /** Login: 10 attempts per 15 minutes per IP */\n  login: { max: 10, windowMs: 15 * 60 * 1000 },\n  /** Signup/register: allow multi-step retries and multi-role onboarding in the same browser */\n  register: { max: 12, windowMs: 15 * 60 * 1000 },\n  /** Payment create: 20 per minute per IP */\n  paymentCreate: { max: 20, windowMs: 60 * 1000 },\n  /** Enroll (subject or curriculum): 30 per minute per IP */\n  enroll: { max: 30, windowMs: 60 * 1000 },\n  /** Class booking: 20 per minute per IP */\n  booking: { max: 20, windowMs: 60 * 1000 },\n  /** AI generation/chat: 12 per minute per client identifier */\n  aiGenerate: { max: 12, windowMs: 60 * 1000 },\n} as const\n\n/**\n * Check rate limit using a named preset. Key will be prefixed with the preset name.\n */\nexport async function checkRateLimitPreset(\n  req: Request,\n  preset: keyof typeof RATE_LIMIT_PRESETS\n): Promise<RateLimitResult> {\n  const ip = getClientIdentifier(req)\n  const key = `${preset}:${ip}`\n  const options = RATE_LIMIT_PRESETS[preset]\n  return checkRateLimit(key, options)\n}\n\n/**\n * Get client identifier for rate limiting (IP or x-forwarded-for).\n */\nexport function getClientIdentifier(req: Request): string {\n  const trustProxy = process.env.TRUST_PROXY === 'true'\n  const forwarded = req.headers.get('x-forwarded-for')\n  const realIp = req.headers.get('x-real-ip')\n  const cfIp = req.headers.get('cf-connecting-ip')\n\n  const firstForwarded = forwarded?.split(',')[0]?.trim()\n  const candidate = trustProxy ? (firstForwarded || realIp || cfIp) : (realIp || cfIp)\n  const ip = normalizeIp(candidate)\n  if (ip !== 'unknown') return ip\n\n  // Fallback identifier when no reliable IP is available (prevents all unknown clients sharing one bucket).\n  const ua = req.headers.get('user-agent') || 'unknown'\n  const lang = req.headers.get('accept-language') || 'unknown'\n  const fingerprint = simpleHash(`${ua}|${lang}`)\n  return `unknown:${fingerprint}`\n}\n\nfunction normalizeIp(ip: string | null | undefined): string {\n  if (!ip) return 'unknown'\n  const trimmed = ip.trim()\n  if (!trimmed) return 'unknown'\n  if (trimmed === '::1') return '127.0.0.1'\n  return trimmed\n}\n\nfunction simpleHash(input: string): string {\n  let hash = 2166136261\n  for (let i = 0; i < input.length; i += 1) {\n    hash ^= input.charCodeAt(i)\n    hash = Math.imul(hash, 16777619)\n  }\n  return (hash >>> 0).toString(16).padStart(8, '0')\n}\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 796, "column": 0}, "map": {"version":3,"sources":["file:///Users/nazy/ADK_WORKSPACE/TutorMekimi/tutorme-app/src/lib/security/rbac.ts"],"sourcesContent":["/**\n * Role-based access control: granular permissions per role.\n * Use requirePermission() in admin/sensitive routes.\n */\n\nimport type { Role } from '@prisma/client'\n\nexport const PERMISSIONS = {\n  // Admin\n  ADMIN_VIEW_PAYMENTS: 'admin:payments:read',\n  ADMIN_VIEW_WEBHOOKS: 'admin:webhooks:read',\n  ADMIN_MANAGE_API_KEYS: 'admin:api_keys',\n  ADMIN_VIEW_USERS: 'admin:users:read',\n  // Tutor\n  TUTOR_MANAGE_CLINICS: 'tutor:clinics',\n  TUTOR_VIEW_REPORTS: 'tutor:reports:read',\n  // Student\n  STUDENT_VIEW_OWN: 'student:own:read',\n  STUDENT_BOOK_CLASS: 'student:book'\n} as const\n\nexport type Permission = (typeof PERMISSIONS)[keyof typeof PERMISSIONS]\n\nconst ROLE_PERMISSIONS: Record<Role, Permission[]> = {\n  ADMIN: [\n    PERMISSIONS.ADMIN_VIEW_PAYMENTS,\n    PERMISSIONS.ADMIN_VIEW_WEBHOOKS,\n    PERMISSIONS.ADMIN_MANAGE_API_KEYS,\n    PERMISSIONS.ADMIN_VIEW_USERS,\n    PERMISSIONS.TUTOR_MANAGE_CLINICS,\n    PERMISSIONS.TUTOR_VIEW_REPORTS,\n    PERMISSIONS.STUDENT_VIEW_OWN,\n    PERMISSIONS.STUDENT_BOOK_CLASS\n  ],\n  TUTOR: [\n    PERMISSIONS.TUTOR_MANAGE_CLINICS,\n    PERMISSIONS.TUTOR_VIEW_REPORTS,\n    PERMISSIONS.STUDENT_VIEW_OWN,\n    PERMISSIONS.STUDENT_BOOK_CLASS\n  ],\n  STUDENT: [PERMISSIONS.STUDENT_VIEW_OWN, PERMISSIONS.STUDENT_BOOK_CLASS]\n}\n\nexport function hasPermission(role: Role, permission: Permission): boolean {\n  return ROLE_PERMISSIONS[role]?.includes(permission) ?? false\n}\n\nexport function getPermissionsForRole(role: Role): Permission[] {\n  return ROLE_PERMISSIONS[role] ?? []\n}\n"],"names":[],"mappings":"AAAA;;;CAGC;;;;;;;;AAIM,MAAM,cAAc;IACzB,QAAQ;IACR,qBAAqB;IACrB,qBAAqB;IACrB,uBAAuB;IACvB,kBAAkB;IAClB,QAAQ;IACR,sBAAsB;IACtB,oBAAoB;IACpB,UAAU;IACV,kBAAkB;IAClB,oBAAoB;AACtB;AAIA,MAAM,mBAA+C;IACnD,OAAO;QACL,YAAY,mBAAmB;QAC/B,YAAY,mBAAmB;QAC/B,YAAY,qBAAqB;QACjC,YAAY,gBAAgB;QAC5B,YAAY,oBAAoB;QAChC,YAAY,kBAAkB;QAC9B,YAAY,gBAAgB;QAC5B,YAAY,kBAAkB;KAC/B;IACD,OAAO;QACL,YAAY,oBAAoB;QAChC,YAAY,kBAAkB;QAC9B,YAAY,gBAAgB;QAC5B,YAAY,kBAAkB;KAC/B;IACD,SAAS;QAAC,YAAY,gBAAgB;QAAE,YAAY,kBAAkB;KAAC;AACzE;AAEO,SAAS,cAAc,IAAU,EAAE,UAAsB;IAC9D,OAAO,gBAAgB,CAAC,KAAK,EAAE,SAAS,eAAe;AACzD;AAEO,SAAS,sBAAsB,IAAU;IAC9C,OAAO,gBAAgB,CAAC,KAAK,IAAI,EAAE;AACrC"}},
    {"offset": {"line": 852, "column": 0}, "map": {"version":3,"sources":["file:///Users/nazy/ADK_WORKSPACE/TutorMekimi/tutorme-app/src/lib/security/admin-ip.ts"],"sourcesContent":["/**\n * Admin panel IP whitelist. When set, only listed IPs can access /admin and admin API routes.\n * Env: ADMIN_IP_WHITELIST (comma-separated IPs or CIDRs, e.g. \"1.2.3.4,10.0.0.0/8\")\n */\n\nfunction parseWhitelist(): string[] {\n  const raw = process.env.ADMIN_IP_WHITELIST\n  if (!raw?.trim()) return []\n  return raw.split(',').map((s) => s.trim()).filter(Boolean)\n}\n\nfunction ipToNum(ip: string): number {\n  const parts = ip.split('.').map(Number)\n  if (parts.length !== 4) return 0\n  return (parts[0]! << 24) | (parts[1]! << 16) | (parts[2]! << 8) | parts[3]!\n}\n\nfunction matchCidr(ip: string, cidr: string): boolean {\n  if (!cidr.includes('/')) return ip === cidr\n  const [net, bits] = cidr.split('/')\n  if (!net || bits === undefined) return false\n  const mask = ~((1 << (32 - parseInt(bits, 10))) - 1) >>> 0\n  return (ipToNum(ip) & mask) === (ipToNum(net) & mask)\n}\n\n/**\n * Returns true if admin access is allowed from this IP.\n * If whitelist is empty, all IPs are allowed.\n */\nexport function isAdminIpAllowed(clientIp: string): boolean {\n  const whitelist = parseWhitelist()\n  if (whitelist.length === 0) return true\n  return whitelist.some((entry) => matchCidr(clientIp, entry) || clientIp === entry)\n}\n\nexport function getClientIp(req: Request): string {\n  const forwarded = req.headers.get('x-forwarded-for')\n  const ip = forwarded ? forwarded.split(',')[0]?.trim() : null\n  return ip ?? req.headers.get('x-real-ip') ?? 'unknown'\n}\n"],"names":[],"mappings":";;;;;;AAAA;;;CAGC,GAED,SAAS;IACP,MAAM,MAAM,QAAQ,GAAG,CAAC,kBAAkB;IAC1C,IAAI,CAAC,KAAK,QAAQ,OAAO,EAAE;IAC3B,OAAO,IAAI,KAAK,CAAC,KAAK,GAAG,CAAC,CAAC,IAAM,EAAE,IAAI,IAAI,MAAM,CAAC;AACpD;AAEA,SAAS,QAAQ,EAAU;IACzB,MAAM,QAAQ,GAAG,KAAK,CAAC,KAAK,GAAG,CAAC;IAChC,IAAI,MAAM,MAAM,KAAK,GAAG,OAAO;IAC/B,OAAO,AAAC,KAAK,CAAC,EAAE,IAAK,KAAO,KAAK,CAAC,EAAE,IAAK,KAAO,KAAK,CAAC,EAAE,IAAK,IAAK,KAAK,CAAC,EAAE;AAC5E;AAEA,SAAS,UAAU,EAAU,EAAE,IAAY;IACzC,IAAI,CAAC,KAAK,QAAQ,CAAC,MAAM,OAAO,OAAO;IACvC,MAAM,CAAC,KAAK,KAAK,GAAG,KAAK,KAAK,CAAC;IAC/B,IAAI,CAAC,OAAO,SAAS,WAAW,OAAO;IACvC,MAAM,OAAO,CAAC,CAAC,CAAC,KAAM,KAAK,SAAS,MAAM,GAAI,IAAI,CAAC,MAAM;IACzD,OAAO,CAAC,QAAQ,MAAM,IAAI,MAAM,CAAC,QAAQ,OAAO,IAAI;AACtD;AAMO,SAAS,iBAAiB,QAAgB;IAC/C,MAAM,YAAY;IAClB,IAAI,UAAU,MAAM,KAAK,GAAG,OAAO;IACnC,OAAO,UAAU,IAAI,CAAC,CAAC,QAAU,UAAU,UAAU,UAAU,aAAa;AAC9E;AAEO,SAAS,YAAY,GAAY;IACtC,MAAM,YAAY,IAAI,OAAO,CAAC,GAAG,CAAC;IAClC,MAAM,KAAK,YAAY,UAAU,KAAK,CAAC,IAAI,CAAC,EAAE,EAAE,SAAS;IACzD,OAAO,MAAM,IAAI,OAAO,CAAC,GAAG,CAAC,gBAAgB;AAC/C"}},
    {"offset": {"line": 892, "column": 0}, "map": {"version":3,"sources":["file:///Users/nazy/ADK_WORKSPACE/TutorMekimi/tutorme-app/src/lib/api/middleware.ts"],"sourcesContent":["/**\n * API Route Middleware Utilities\n * Provides authentication, authorization, CSRF, rate limiting, and error handling for API routes\n */\n\nimport { NextRequest, NextResponse } from 'next/server'\nimport { getServerSession } from 'next-auth'\nimport { authOptions } from '@/lib/auth'\nimport type { Session } from 'next-auth'\nimport { verifyCsrfToken } from '@/lib/security/csrf'\nimport { checkRateLimit, checkRateLimitPreset, getClientIdentifier } from '@/lib/security/rate-limit'\nimport { hasPermission, type Permission } from '@/lib/security/rbac'\nimport { isAdminIpAllowed, getClientIp } from '@/lib/security/admin-ip'\n\n// Custom error classes\nexport class UnauthorizedError extends Error {\n    constructor(message = 'Unauthorized - Please log in') {\n        super(message)\n        this.name = 'UnauthorizedError'\n    }\n}\n\nexport class ForbiddenError extends Error {\n    constructor(message = 'Forbidden - Insufficient permissions') {\n        super(message)\n        this.name = 'ForbiddenError'\n    }\n}\n\nexport class ValidationError extends Error {\n    constructor(message: string) {\n        super(message)\n        this.name = 'ValidationError'\n    }\n}\n\nexport class NotFoundError extends Error {\n    constructor(message = 'Resource not found') {\n        super(message)\n        this.name = 'NotFoundError'\n    }\n}\n\n/**\n * Centralised API error logging and 500 response.\n * Use in route catch blocks for consistent logging and response shape.\n */\nexport function handleApiError(\n    error: unknown,\n    defaultMessage: string = 'Internal server error',\n    logLabel: string = 'API Error'\n): NextResponse {\n    console.error(`[${logLabel}]`, error)\n    const message = error instanceof Error ? error.message : defaultMessage\n    const isDev = process.env.NODE_ENV === 'development'\n    return NextResponse.json(\n        { error: isDev ? message : defaultMessage },\n        { status: 500 }\n    )\n}\n\n// Handler type (context is optional route params, e.g. { params: { id: string } })\ntype Handler = (\n    req: NextRequest,\n    session: Session,\n    context?: { params?: Promise<Record<string, string | string[]>> | Record<string, string | string[]> }\n) => Promise<Response> | Response\n\n// Middleware options\ninterface WithAuthOptions {\n    role?: 'TUTOR' | 'STUDENT' | 'ADMIN' | 'PARENT'\n    optional?: boolean\n}\n\nfunction normalizeRole(role: unknown): string {\n    if (typeof role !== 'string') return ''\n    return role.trim().toUpperCase()\n}\n\n/**\n * Authentication middleware wrapper\n * Automatically handles session validation, role checking, and error responses\n * \n * @example\n * export const GET = withAuth(async (req, session) => {\n *   // session is guaranteed to exist\n *   return NextResponse.json({ userId: session.user.id })\n * })\n * \n * @example with role requirement\n * export const POST = withAuth(async (req, session) => {\n *   // session.user.role === 'TUTOR' is guaranteed\n *   return NextResponse.json({})\n * }, { role: 'TUTOR' })\n */\nexport function withAuth(\n    handler: Handler,\n    options?: WithAuthOptions\n) {\n    return async (req: NextRequest, context?: { params?: Promise<Record<string, string | string[]>> | Record<string, string | string[]> }) => {\n        try {\n            const session = await getServerSession(authOptions)\n\n            // Check if user is authenticated\n            if (!session?.user?.id) {\n                if (options?.optional) {\n                    // Allow unauthenticated access\n                    return handler(req, session as Session, context)\n                }\n                throw new UnauthorizedError()\n            }\n\n            // Check role requirements\n            if (options?.role && normalizeRole(session.user.role) !== normalizeRole(options.role)) {\n                // Fallback: session role can be stale after account updates or seed resets.\n                const { db } = await import('@/lib/db')\n                const freshUser = await db.user.findUnique({\n                    where: { id: session.user.id },\n                    select: { role: true },\n                })\n                if (normalizeRole(freshUser?.role) !== normalizeRole(options.role)) {\n                    throw new ForbiddenError(`This endpoint requires ${options.role} role`)\n                }\n            }\n\n            // Call the actual handler\n            return await handler(req, session, context)\n\n        } catch (error) {\n            // Handle known error types\n            if (error instanceof UnauthorizedError) {\n                return NextResponse.json(\n                    { error: error.message },\n                    { status: 401 }\n                )\n            }\n\n            if (error instanceof ForbiddenError) {\n                return NextResponse.json(\n                    { error: error.message },\n                    { status: 403 }\n                )\n            }\n\n            if (error instanceof ValidationError) {\n                return NextResponse.json(\n                    { error: error.message },\n                    { status: 400 }\n                )\n            }\n\n            if (error instanceof NotFoundError) {\n                return NextResponse.json(\n                    { error: error.message },\n                    { status: 404 }\n                )\n            }\n\n            // Handle unknown errors\n            console.error('API Error:', error)\n\n            // Don't expose internal errors in production\n            const isDev = process.env.NODE_ENV === 'development'\n            return NextResponse.json(\n                {\n                    error: isDev\n                        ? (error instanceof Error ? error.message : 'Unknown error')\n                        : 'Internal server error'\n                },\n                { status: 500 }\n            )\n        }\n    }\n}\n\n/**\n * Get the current user session without throwing errors\n * Useful for optional authentication scenarios\n */\nexport async function getCurrentSession(): Promise<Session | null> {\n    try {\n        return await getServerSession(authOptions)\n    } catch (error) {\n        console.error('Error getting session:', error)\n        return null\n    }\n}\n\n/**\n * Require authentication - throws if not authenticated\n * Useful when you need the session inside a try/catch block\n */\nexport async function requireAuth(): Promise<Session> {\n    const session = await getServerSession(authOptions)\n    if (!session?.user?.id) {\n        throw new UnauthorizedError()\n    }\n    return session\n}\n\n/**\n * Require specific role - throws if wrong role\n */\nexport async function requireRole(role: 'TUTOR' | 'STUDENT' | 'ADMIN'): Promise<Session> {\n    const session = await requireAuth()\n    if (normalizeRole(session.user.role) !== normalizeRole(role)) {\n        throw new ForbiddenError(`This action requires ${role} role`)\n    }\n    return session\n}\n\n/** State-changing methods that require CSRF */\nconst CSRF_METHODS = new Set(['POST', 'PUT', 'PATCH', 'DELETE'])\n\n/** API path prefixes that skip CSRF (webhooks, auth, public) */\nconst CSRF_SKIP_PATHS = ['/api/auth', '/api/payments/webhooks', '/api/csrf', '/api/health']\n\n/**\n * Verify CSRF for state-changing requests. Call at the start of POST/PUT/PATCH/DELETE handlers\n * that are not webhooks or auth. Returns 403 response if invalid; otherwise returns null.\n */\nexport async function requireCsrf(req: NextRequest): Promise<NextResponse | null> {\n    if (!CSRF_METHODS.has(req.method)) return null\n    const path = req.nextUrl?.pathname ?? ''\n    if (CSRF_SKIP_PATHS.some((p) => path.startsWith(p))) return null\n    const valid = await verifyCsrfToken(req)\n    if (!valid) {\n        return NextResponse.json({ error: 'Invalid or missing CSRF token' }, { status: 403 })\n    }\n    return null\n}\n\ntype AnyHandler = (req: NextRequest, ...args: unknown[]) => Promise<Response> | Response\n\n/**\n * Wraps a state-changing handler to require a valid CSRF token (POST/PUT/PATCH/DELETE).\n * Use with withAuth: export const POST = withCsrf(withAuth(async (req, session) => ...))\n */\nexport function withCsrf(handler: AnyHandler): AnyHandler {\n    return async (req: NextRequest, ...args: unknown[]) => {\n        const csrfError = await requireCsrf(req)\n        if (csrfError) return csrfError\n        return handler(req, ...args)\n    }\n}\n\n/**\n * Apply rate limit by client IP (and optionally by userId when session exists).\n * Returns 429 response if over limit; otherwise returns null.\n */\nexport async function withRateLimit(\n    req: NextRequest,\n    max: number = 100\n): Promise<{ response: NextResponse | null; remaining: number }> {\n    const key = getClientIdentifier(req)\n    const { allowed, remaining } = await checkRateLimit(key, max)\n    if (!allowed) {\n        const res = NextResponse.json(\n            { error: 'Too many requests' },\n            { status: 429, headers: { 'Retry-After': '60' } }\n        )\n        return { response: res, remaining: 0 }\n    }\n    return { response: null, remaining }\n}\n\ntype RateLimitPreset = 'login' | 'register' | 'paymentCreate' | 'enroll' | 'booking' | 'aiGenerate'\n\n/**\n * Apply rate limit using a named preset (stricter limits for sensitive routes).\n * Returns 429 response if over limit; otherwise returns null.\n */\nexport async function withRateLimitPreset(\n    req: NextRequest,\n    preset: RateLimitPreset\n): Promise<{ response: NextResponse | null; remaining: number }> {\n    const { allowed, remaining, resetAt } = await checkRateLimitPreset(req as unknown as Request, preset)\n    if (!allowed) {\n        const retryAfter = Math.ceil((resetAt - Date.now()) / 1000)\n        const res = NextResponse.json(\n            { error: 'Too many requests. Please try again later.' },\n            { status: 429, headers: { 'Retry-After': String(Math.max(1, retryAfter)) } }\n        )\n        return { response: res, remaining: 0 }\n    }\n    return { response: null, remaining }\n}\n\n/**\n * Require a specific permission (RBAC). Call after withAuth.\n * Returns 403 if user's role does not have the permission.\n */\nexport function requirePermission(session: Session, permission: Permission): NextResponse | null {\n    const role = session?.user?.role as 'ADMIN' | 'TUTOR' | 'STUDENT' | undefined\n    if (!role || !hasPermission(role, permission)) {\n        return NextResponse.json({ error: 'Forbidden - Insufficient permissions' }, { status: 403 })\n    }\n    return null\n}\n\n/**\n * Require admin IP whitelist. When ADMIN_IP_WHITELIST is set, only listed IPs can access.\n * Returns 403 if client IP is not allowed.\n */\nexport function requireAdminIp(req: NextRequest): NextResponse | null {\n    const ip = getClientIp(req as unknown as Request)\n    if (!isAdminIpAllowed(ip)) {\n        return NextResponse.json({ error: 'Forbidden - Admin access not allowed from this IP' }, { status: 403 })\n    }\n    return null\n}\n\n/**\n * Get auth from session or API key (Bearer). Use for admin routes that support both browser and server-to-server.\n * Returns session if logged in, or { apiKey: keyId } if valid Bearer key, else null.\n */\nexport async function getSessionOrApiKey(req: NextRequest): Promise<\n    | { type: 'session'; session: Session }\n    | { type: 'apiKey'; keyId: string }\n    | null\n> {\n    const authHeader = req.headers.get('authorization')\n    if (authHeader?.startsWith('Bearer ')) {\n        const token = authHeader.slice(7)\n        if (token.startsWith('tm_')) {\n            const { verifyApiKey } = await import('@/lib/security/api-key')\n            const key = await verifyApiKey(token)\n            if (key) return { type: 'apiKey', keyId: key.id }\n        }\n    }\n    const session = await getServerSession(authOptions)\n    if (session?.user?.id) return { type: 'session', session }\n    return null\n}\n\n/**\n * Parse and clamp numeric query/body values to safe bounds.\n */\nexport function parseBoundedInt(\n    raw: string | null | undefined,\n    defaultValue: number,\n    options: { min?: number; max: number }\n): number {\n    const min = options.min ?? 0\n    const parsed = Number.parseInt(raw ?? '', 10)\n    if (!Number.isFinite(parsed)) return defaultValue\n    if (parsed < min) return min\n    if (parsed > options.max) return options.max\n    return parsed\n}\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 1208, "column": 0}, "map": {"version":3,"sources":["file:///Users/nazy/ADK_WORKSPACE/TutorMekimi/tutorme-app/src/lib/validation/parent-child-security.ts"],"sourcesContent":["/**\n * Parent-Child Security Validation Schemas\n * Global security schema for parent-child linking with verification requirements\n */\n\nimport { z } from 'zod'\n\n/**\n * Student linking schema - requires either child email or unique ID for security verification.\n * Prevents unauthorized parent-child associations.\n */\nexport const studentLinkingSchema = z\n  .object({\n    childEmail: z.string().email().optional(),\n    childUniqueId: z.string().min(8, 'Unique ID must be at least 8 characters').optional(),\n    verificationMethod: z.enum(['email', 'id', 'both']).optional(),\n    // Optional display name for UI (not used for verification)\n    name: z.string().min(1).max(100).optional(),\n    grade: z.string().optional(),\n    subjects: z.array(z.string()).optional(),\n  })\n  .refine(\n    (data) => !!data.childEmail || !!data.childUniqueId,\n    {\n      message:\n        'For security, you must provide either child email or unique ID to link students properly',\n      code: 'INSUFFICIENT_STUDENT_VERIFICATION',\n    }\n  )\n\nexport type StudentLinkingInput = z.infer<typeof studentLinkingSchema>\n\n/**\n * Parent registration security schema - enforces child verification before family creation.\n */\nexport const parentRegistrationSecuritySchema = z.object({\n  children: z\n    .array(studentLinkingSchema)\n    .min(1, 'You must link at least one child for parent registration'),\n  parentEmail: z.string().email('Valid parent email is required'),\n  tosAccepted: z.literal(true, {\n    errorMap: () => ({ message: 'You must accept the Terms of Service' }),\n  }),\n})\n\nexport type ParentRegistrationSecurityInput = z.infer<\n  typeof parentRegistrationSecuritySchema\n>\n"],"names":[],"mappings":";;;;;;AAAA;;;CAGC,GAED;;AAMO,MAAM,uBAAuB,sOAAC,CAClC,MAAM,CAAC;IACN,YAAY,sOAAC,CAAC,MAAM,GAAG,KAAK,GAAG,QAAQ;IACvC,eAAe,sOAAC,CAAC,MAAM,GAAG,GAAG,CAAC,GAAG,2CAA2C,QAAQ;IACpF,oBAAoB,sOAAC,CAAC,IAAI,CAAC;QAAC;QAAS;QAAM;KAAO,EAAE,QAAQ;IAC5D,2DAA2D;IAC3D,MAAM,sOAAC,CAAC,MAAM,GAAG,GAAG,CAAC,GAAG,GAAG,CAAC,KAAK,QAAQ;IACzC,OAAO,sOAAC,CAAC,MAAM,GAAG,QAAQ;IAC1B,UAAU,sOAAC,CAAC,KAAK,CAAC,sOAAC,CAAC,MAAM,IAAI,QAAQ;AACxC,GACC,MAAM,CACL,CAAC,OAAS,CAAC,CAAC,KAAK,UAAU,IAAI,CAAC,CAAC,KAAK,aAAa,EACnD;IACE,SACE;IACF,MAAM;AACR;AAQG,MAAM,mCAAmC,sOAAC,CAAC,MAAM,CAAC;IACvD,UAAU,sOAAC,CACR,KAAK,CAAC,sBACN,GAAG,CAAC,GAAG;IACV,aAAa,sOAAC,CAAC,MAAM,GAAG,KAAK,CAAC;IAC9B,aAAa,sOAAC,CAAC,OAAO,CAAC,MAAM;QAC3B,UAAU,IAAM,CAAC;gBAAE,SAAS;YAAuC,CAAC;IACtE;AACF"}},
    {"offset": {"line": 1248, "column": 0}, "map": {"version":3,"sources":["file:///Users/nazy/ADK_WORKSPACE/TutorMekimi/tutorme-app/src/lib/validation/user-registration.ts"],"sourcesContent":["/**\n * User Registration Validation Schemas\n * Parent-specific, Tutor-specific and shared registration validation\n */\n\nimport { z } from 'zod'\nimport { studentLinkingSchema } from './parent-child-security'\n\n// ============================================\n// Tutor Registration Schemas\n// ============================================\n\nexport const tutorAdditionalDataSchema = z.object({\n  education: z.string().max(500, 'Education must be less than 500 characters').optional(),\n  experience: z.string().max(50, 'Experience must be less than 50 characters').optional(),\n  subjects: z.array(z.string()).min(1, 'Please select at least one subject'),\n  gradeLevels: z.array(z.string()).optional(),\n  hourlyRate: z.number().min(0).max(10000).optional(),\n})\n\nexport const tutorProfileDataSchema = z.object({\n  phoneNumber: z.string().regex(/^\\+?[\\d\\s\\-\\(\\)]{10,}$/, 'Valid phone number required').optional(),\n  bio: z.string().max(2000, 'Bio must be less than 2000 characters').optional(),\n  timezone: z.string().default('Asia/Shanghai'),\n  preferredLanguage: z.enum(['zh-CN', 'en']).default('zh-CN'),\n})\n\n// Legacy student schema (for backward compatibility in non-parent flows)\nexport const studentSchema = z.object({\n  name: z.string().min(1, 'Child name is required'),\n  email: z.union([z.string().email(), z.literal('')]).optional(),\n  grade: z.string().optional(),\n  subjects: z.array(z.string()).optional(),\n})\n\n// Security-enforced student linking for parent registration (requires childEmail or childUniqueId)\nexport const parentStudentLinkingSchema = studentLinkingSchema\n\nexport const emergencyContactSchema = z.object({\n  name: z.string().min(1, 'Contact name is required'),\n  relationship: z.string().min(1, 'Relationship is required'),\n  phone: z.string().regex(/^\\+?[\\d\\s\\-\\(\\)]{10,}$/, 'Valid phone number required'),\n})\n\nexport const notificationSchema = z.object({\n  email: z.boolean().optional(),\n  sms: z.boolean().optional(),\n  app: z.boolean().optional(),\n  weeklyReports: z.boolean().optional(),\n  paymentNotifications: z.boolean().optional(),\n  emergencyContacts: z.boolean().optional(),\n})\n\nexport const parentProfileDataSchema = z.object({\n  phoneNumber: z.string().regex(/^\\+?[\\d\\s\\-\\(\\)]{10,}$/, 'Valid phone number required'),\n  relationship: z.enum(['parent', 'guardian', 'step-parent', 'grandparent', 'other']),\n  timezone: z.string().default('Asia/Shanghai'),\n  preferredLanguage: z.enum(['zh-CN', 'en']).default('zh-CN'),\n})\n\n// Lenient emergency contact for API - allows empty placeholder entries (filtered in API)\nconst emergencyContactInputSchema = z.object({\n  name: z.string(),\n  relationship: z.string(),\n  phone: z.string(),\n})\n\nexport const parentAdditionalDataSchema = z.object({\n  students: z.array(parentStudentLinkingSchema).optional().default([]),\n  emergencyContacts: z.array(emergencyContactInputSchema).max(3).optional(),\n  notificationPreferences: notificationSchema.optional(),\n})\n\n// ============================================\n// Admin Registration Schemas\n// ============================================\n\nexport const ADMIN_PERMISSION_GROUPS = [\n  'user_management',\n  'content_management',\n  'financial_access',\n  'system_settings',\n  'analytics',\n] as const\n\nexport type AdminPermissionGroup = (typeof ADMIN_PERMISSION_GROUPS)[number]\n\nexport const adminPermissionGroupsSchema = z.array(\n  z.enum(ADMIN_PERMISSION_GROUPS)\n)\n\nexport const adminProfileDataSchema = z.object({\n  phoneNumber: z.string().regex(/^\\+?[\\d\\s\\-\\(\\)]{10,}$/, 'Valid phone number required'),\n  organizationName: z.string().min(2, 'Organization name must be at least 2 characters').max(200),\n  organizationSlug: z.string().regex(/^[a-z0-9\\-]+$/, 'Slug: lowercase letters, numbers, hyphens only').optional(),\n  adminLevel: z.enum(['super', 'standard', 'limited']),\n  jobTitle: z.string().max(100).optional(),\n  department: z.string().max(100).optional(),\n})\n\nexport const adminAdditionalDataSchema = z.object({\n  permissions: adminPermissionGroupsSchema.min(1, 'Select at least one permission group'),\n  mfaEnabled: z.boolean().default(true),\n  ipWhitelist: z.array(z.string().regex(/^(?:[0-9]{1,3}\\.){3}[0-9]{1,3}$/, 'Invalid IP address')).optional(),\n  timezone: z.string().default('Asia/Shanghai'),\n  preferredLanguage: z.enum(['zh-CN', 'en']).default('zh-CN'),\n})\n\nexport const adminRegistrationSchema = z\n  .object({\n    email: z.string().email('Please enter a valid email address'),\n    password: z\n      .string()\n      .min(8, 'Password must be at least 8 characters')\n      .max(128, 'Password too long')\n      .regex(\n        /^(?=.*[a-z])(?=.*[A-Z])(?=.*\\d)/,\n        'Password must contain at least one uppercase letter, one lowercase letter, and one number'\n      ),\n    confirmPassword: z.string(),\n    firstName: z.string().min(1, 'First name is required').max(50),\n    lastName: z.string().min(1, 'Last name is required').max(50),\n    phoneNumber: z.string().regex(/^\\+?[\\d\\s\\-\\(\\)]{10,}$/, 'Valid phone number required'),\n    organizationName: z.string().min(2, 'Organization name is required').max(200),\n    organizationSlug: z.string().max(100).optional(),\n    adminLevel: z.enum(['super', 'standard', 'limited']),\n    jobTitle: z.string().max(100).optional(),\n    department: z.string().max(100).optional(),\n    permissions: adminPermissionGroupsSchema.min(1, 'Select at least one permission group'),\n    mfaEnabled: z.boolean().default(true),\n    tosAccepted: z.boolean().refine((val) => val === true, {\n      message: 'You must accept the Terms of Service',\n    }),\n  })\n  .refine((data) => data.password === data.confirmPassword, {\n    message: \"Passwords don't match\",\n    path: ['confirmPassword'],\n  })\n\nexport type AdminRegistrationInput = z.infer<typeof adminRegistrationSchema>\n\n// ============================================\n// Parent Registration Schema\n// ============================================\n\nexport const parentRegistrationSchema = z\n  .object({\n    email: z.string().email('Please enter a valid email address'),\n    password: z\n      .string()\n      .min(8, 'Password must be at least 8 characters')\n      .regex(\n        /^(?=.*[a-z])(?=.*[A-Z])(?=.*\\d)/,\n        'Password must contain at least one uppercase letter, one lowercase letter, and one number'\n      ),\n    confirmPassword: z.string(),\n    phoneNumber: z.string().regex(/^\\+?[\\d\\s\\-\\(\\)]{10,}$/, 'Valid phone number required'),\n    relationship: z.enum(['parent', 'guardian', 'step-parent', 'grandparent', 'other']),\n    timezone: z.string().default('Asia/Shanghai'),\n    preferredLanguage: z.enum(['zh-CN', 'en']).default('zh-CN'),\n    students: z.array(parentStudentLinkingSchema).optional().default([]),\n    emergencyContacts: z.array(emergencyContactSchema).max(3).optional().default([]),\n    notificationPreferences: notificationSchema.optional().default({}),\n    tosAccepted: z.boolean().refine((val) => val === true, {\n      message: 'You must accept the Terms of Service',\n    }),\n  })\n  .refine((data) => data.password === data.confirmPassword, {\n    message: \"Passwords don't match\",\n    path: ['confirmPassword'],\n  })\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 1440, "column": 0}, "map": {"version":3,"sources":["file:///Users/nazy/ADK_WORKSPACE/TutorMekimi/tutorme-app/src/lib/validation/schemas.ts"],"sourcesContent":["/**\n * Validation Schemas\n * Zod schemas for API request validation\n */\n\nimport { z } from 'zod'\nimport { NextRequest } from 'next/server'\nimport { ValidationError } from '@/lib/api/middleware'\nimport {\n  parentAdditionalDataSchema,\n  tutorAdditionalDataSchema,\n} from '@/lib/validation/user-registration'\n\n// ============================================\n// User & Authentication Schemas\n// ============================================\n\nconst baseRegisterSchema = z.object({\n  email: z.string().email('Invalid email address'),\n  password: z\n    .string()\n    .min(8, 'Password must be at least 8 characters')\n    .max(128, 'Password too long')\n    .regex(\n      /^(?=.*[a-z])(?=.*[A-Z])(?=.*\\d)/,\n      'Password must contain at least one uppercase letter, one lowercase letter, and one number'\n    ),\n  name: z.string().min(2, 'Name must be at least 2 characters').max(100),\n  role: z.enum(['STUDENT', 'TUTOR', 'ADMIN', 'PARENT']),\n  tosAccepted: z.boolean().optional().default(true),\n  profileData: z.record(z.string(), z.unknown()).optional(),\n  additionalData: z.record(z.string(), z.unknown()).optional(),\n})\n\nexport const RegisterUserSchema = baseRegisterSchema.superRefine((data, ctx) => {\n  // Validate tutor-specific fields for TUTOR role\n  if (data.role === 'TUTOR') {\n    if (!data.additionalData) {\n      ctx.addIssue({\n        code: z.ZodIssueCode.custom,\n        message: 'additionalData is required for tutor registration',\n        path: ['additionalData'],\n      })\n    } else {\n      const result = tutorAdditionalDataSchema.safeParse(data.additionalData)\n      if (!result.success) {\n        result.error.issues.forEach((issue) => {\n          ctx.addIssue({\n            code: z.ZodIssueCode.custom,\n            message: issue.message,\n            path: issue.path,\n          })\n        })\n      }\n    }\n  }\n\n  // Only validate parent-specific fields for PARENT role\n  if (data.role === 'PARENT') {\n    if (!data.profileData) {\n      ctx.addIssue({\n        code: z.ZodIssueCode.custom,\n        message: 'profileData is required for parent registration',\n        path: ['profileData'],\n      })\n    }\n    if (!data.additionalData) {\n      ctx.addIssue({\n        code: z.ZodIssueCode.custom,\n        message: 'additionalData is required for parent registration',\n        path: ['additionalData'],\n      })\n    } else if (data.additionalData) {\n      const result = parentAdditionalDataSchema.safeParse(data.additionalData)\n      if (!result.success) {\n        result.error.issues.forEach((issue) => {\n          ctx.addIssue({\n            code: z.ZodIssueCode.custom,\n            message: issue.message,\n            path: issue.path,\n          })\n        })\n      }\n    }\n  }\n})\n\nexport const LoginSchema = z.object({\n    email: z.string().email('Invalid email address'),\n    password: z.string().min(1, 'Password is required')\n})\n\nexport const UpdateProfileSchema = z.object({\n    name: z.string().min(2).max(100).optional(),\n    bio: z.string().max(1000).optional(),\n    avatarUrl: z.string().url().optional(),\n    gradeLevel: z.string().optional(),\n    hourlyRate: z.number().min(0).max(10000).optional(),\n    subjects: z.array(z.string()).optional()\n})\n\n// ============================================\n// Class & Live Session Schemas\n// ============================================\n\nexport const CreateRoomSchema = z.object({\n    title: z.string().min(3, 'Title must be at least 3 characters').max(100).optional(),\n    subject: z.string().min(2, 'Subject must be at least 2 characters').max(50),\n    description: z.string().max(1000).optional(),\n    gradeLevel: z.string().optional(),\n    curriculumId: z.string().cuid('Invalid curriculum ID').optional(),\n    scheduledAt: z.string().datetime('Invalid scheduled date/time').optional(),\n    maxStudents: z.number().int().min(1).max(500).default(50),\n    durationMinutes: z.number().int().min(15).max(480).default(120),\n    enableRecording: z.boolean().default(true)\n})\n\nexport const JoinRoomSchema = z.object({\n    sessionId: z.string().cuid('Invalid session ID'),\n    userId: z.string().cuid('Invalid user ID')\n})\n\nexport const CreateBreakoutSchema = z.object({\n    parentSessionId: z.string().cuid('Invalid session ID'),\n    studentIds: z.array(z.string().cuid()).min(1, 'At least one student required'),\n    durationMinutes: z.number().int().min(5).max(120).default(30),\n    topic: z.string().max(200).optional()\n})\n\nexport const SendMessageSchema = z.object({\n    sessionId: z.string().cuid('Invalid session ID'),\n    content: z.string().min(1, 'Message cannot be empty').max(5000),\n    type: z.enum(['text', 'system', 'hint']).default('text')\n})\n\n// ============================================\n// Task & Assignment Schemas\n// ============================================\n\nexport const GenerateTaskSchema = z.object({\n    subject: z.string().min(1, 'Subject is required'),\n    topics: z.array(z.string()).min(1, 'At least one topic required'),\n    difficulty: z.enum(['beginner', 'intermediate', 'advanced']),\n    count: z.number().int().min(1).max(20).default(5),\n    taskTypes: z.array(\n        z.enum(['multiple_choice', 'short_answer', 'long_answer', 'coding', 'diagram'])\n    ).min(1),\n    distributionMode: z.enum(['uniform', 'personalized', 'clustered', 'peer_group']).default('uniform'),\n    studentIds: z.array(z.string().cuid()).optional(),\n    roomId: z.string().optional()\n})\n\nexport const SubmitTaskSchema = z.object({\n    taskId: z.string().cuid('Invalid task ID'),\n    studentId: z.string().cuid('Invalid student ID'),\n    answers: z.record(z.string(), z.unknown()),\n    timeSpent: z.number().int().min(0),\n    questionIndex: z.number().int().min(0).optional()\n})\n\n// ============================================\n// Curriculum & Learning Schemas\n// ============================================\n\nexport const CreateCurriculumSchema = z.object({\n    title: z.string().min(1).max(200),\n    description: z.string().max(2000).optional(),\n    subject: z.string().min(1).optional(),\n    gradeLevel: z.string().max(50).optional(),\n    difficulty: z.enum(['beginner', 'intermediate', 'advanced']).optional(),\n    estimatedHours: z.number().min(0).max(1000).optional(),\n    isLiveOnline: z.boolean().optional()\n})\n\nexport const EnrollCurriculumSchema = z.object({\n    curriculumId: z.string().cuid('Invalid curriculum ID'),\n    studentId: z.string().cuid('Invalid student ID')\n})\n\n// Tutor course settings (curriculum page)\nconst ScheduleItemSchema = z.object({\n    dayOfWeek: z.string().min(1),\n    startTime: z.string().regex(/^\\d{1,2}:\\d{2}$/, 'Use HH:MM format'),\n    durationMinutes: z.number().int().min(5).max(480)\n})\n\nexport const UpdateCourseSettingsSchema = z.object({\n    name: z.string().min(1).max(200).optional().nullable(),\n    description: z.string().max(2000).optional().nullable(),\n    gradeLevel: z.string().max(50).optional().nullable(),\n    difficulty: z.enum(['beginner', 'intermediate', 'advanced']).optional().nullable(),\n    languageOfInstruction: z.string().min(1).max(20).optional().nullable(),\n    price: z.number().min(0).optional().nullable(),\n    currency: z.string().length(3).optional().nullable(),\n    curriculumSource: z.enum(['PLATFORM', 'UPLOADED']).optional().nullable(),\n    outlineSource: z.enum(['SELF', 'AI']).optional().nullable(),\n    schedule: z.array(ScheduleItemSchema).optional().nullable(),\n    isLiveOnline: z.boolean().optional().nullable(),\n    isPublished: z.boolean().optional().nullable()\n})\n\nexport const UpdateProgressSchema = z.object({\n    lessonId: z.string().cuid('Invalid lesson ID'),\n    studentId: z.string().cuid('Invalid student ID'),\n    progressPercentage: z.number().min(0).max(100),\n    completed: z.boolean().default(false)\n})\n\n// ============================================\n// AI Tutor Schemas\n// ============================================\n\nexport const AITutorEnrollSchema = z.object({\n    studentId: z.string().cuid('Invalid student ID'),\n    subjectCode: z.string().min(1, 'Subject code required'),\n    gradeLevel: z.string().optional()\n})\n\nexport const AITutorQuerySchema = z.object({\n    studentId: z.string().cuid('Invalid student ID'),\n    query: z.string().min(1, 'Query cannot be empty').max(2000),\n    context: z.object({\n        lessonId: z.string().cuid().optional(),\n        currentTopic: z.string().optional(),\n        previousMessages: z.array(z.unknown()).optional()\n    }).optional()\n})\n\n// ============================================\n// Feedback & Review Schemas\n// ============================================\n\nexport const GenerateFeedbackSchema = z.object({\n    studentId: z.string().cuid('Invalid student ID'),\n    submissionId: z.string().cuid('Invalid submission ID'),\n    type: z.enum(['task_feedback', 'progress_report', 'encouragement', 'correction']),\n    priority: z.enum(['low', 'medium', 'high']).default('medium'),\n    context: z.object({\n        taskId: z.string().cuid().optional(),\n        subject: z.string().optional(),\n        recentPerformance: z.number().min(0).max(100).optional(),\n        strengths: z.array(z.string()).optional(),\n        weaknesses: z.array(z.string()).optional(),\n        specificIssue: z.string().optional()\n    }).optional()\n})\n\nexport const ReviewFeedbackSchema = z.object({\n    workflowId: z.string().cuid('Invalid workflow ID'),\n    decision: z.enum(['approve', 'reject', 'modify']),\n    modifications: z.object({\n        modifiedScore: z.number().min(0).max(100).optional(),\n        modifiedComments: z.string().max(2000).optional(),\n        addedNotes: z.string().max(1000).optional()\n    }).optional()\n})\n\n// ============================================\n// Analytics & Reporting Schemas\n// ============================================\n\nexport const AnalyticsQuerySchema = z.object({\n    studentId: z.string().cuid('Invalid student ID').optional(),\n    classId: z.string().cuid('Invalid class ID').optional(),\n    startDate: z.coerce.date().optional(),\n    endDate: z.coerce.date().optional(),\n    metrics: z.array(\n        z.enum(['completion', 'performance', 'engagement', 'attendance'])\n    ).optional()\n})\n\n// ============================================\n// Pagination & Filtering Schemas\n// ============================================\n\nexport const PaginationSchema = z.object({\n    page: z.coerce.number().int().min(1).default(1),\n    limit: z.coerce.number().int().min(1).max(100).default(20),\n    sortBy: z.string().optional(),\n    sortOrder: z.enum(['asc', 'desc']).default('desc')\n})\n\nexport const FilterSchema = z.object({\n    search: z.string().max(200).optional(),\n    status: z.string().optional(),\n    subject: z.string().optional(),\n    gradeLevel: z.string().optional(),\n    dateFrom: z.coerce.date().optional(),\n    dateTo: z.coerce.date().optional()\n})\n\n// Helper function to validate request body\n\n/**\n * Validate request body against a Zod schema\n * Throws ValidationError if validation fails\n */\nexport async function validateRequest<T extends z.ZodType>(\n    req: NextRequest,\n    schema: T\n): Promise<z.infer<T>> {\n    try {\n        const body = await req.json()\n        return schema.parse(body)\n    } catch (error) {\n        if (error instanceof z.ZodError) {\n            const messages = error.issues\n                .map((issue) => `${issue.path.join('.')}: ${issue.message}`)\n                .join(', ')\n            throw new ValidationError(messages)\n        }\n        throw error\n    }\n}\n\n/**\n * Validate query parameters against a Zod schema\n */\nexport function validateQuery<T extends z.ZodType>(\n    req: NextRequest,\n    schema: T\n): z.infer<T> {\n    try {\n        const params = Object.fromEntries(req.nextUrl.searchParams.entries())\n        return schema.parse(params)\n    } catch (error) {\n        if (error instanceof z.ZodError) {\n            const messages = error.issues\n                .map((issue) => `${issue.path.join('.')}: ${issue.message}`)\n                .join(', ')\n            throw new ValidationError(messages)\n        }\n        throw error\n    }\n}\n\n// ============================================\n// Type exports for use in API routes\n// ============================================\n\nexport type RegisterUserInput = z.infer<typeof RegisterUserSchema>\nexport type CreateRoomInput = z.infer<typeof CreateRoomSchema>\nexport type GenerateTaskInput = z.infer<typeof GenerateTaskSchema>\nexport type AITutorQueryInput = z.infer<typeof AITutorQuerySchema>\nexport type AnalyticsQueryInput = z.infer<typeof AnalyticsQuerySchema>\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 1803, "column": 0}, "map": {"version":3,"sources":["file:///Users/nazy/ADK_WORKSPACE/TutorMekimi/tutorme-app/src/lib/security/sanitize.ts"],"sourcesContent":["/**\n * XSS prevention: sanitize user input before rendering or storing.\n * Use for display and for any user-generated content that may be shown as HTML.\n */\n\nconst SCRIPT_REGEX = /<script\\b[^<]*(?:(?!<\\/script>)<[^<]*)*<\\/script>/gi\nconst ON_EVENT_REGEX = /\\s*on\\w+\\s*=\\s*[\"'][^\"']*[\"']/gi\nconst JAVASCRIPT_URL_REGEX = /javascript\\s*:/gi\nconst DATA_URL_REGEX = /data\\s*:\\s*[^,]*\\s*,/gi\n// Strip dangerous tags (iframe, object, embed, form, meta with refresh, link with import)\nconst DANGEROUS_TAGS_REGEX = /<(?:iframe|object|embed|form|meta|link)\\b[^>]*>/gi\n\n/**\n * Strip script tags, event handlers, javascript: URLs, data: URLs, and dangerous tags.\n * Safe for inserting into text content or plain HTML contexts.\n */\nexport function sanitizeHtml(input: string): string {\n  if (typeof input !== 'string') return ''\n  return input\n    .replace(SCRIPT_REGEX, '')\n    .replace(DANGEROUS_TAGS_REGEX, '')\n    .replace(ON_EVENT_REGEX, '')\n    .replace(JAVASCRIPT_URL_REGEX, '')\n    .replace(DATA_URL_REGEX, '')\n}\n\n/**\n * Sanitize and optionally truncate to a max length (for DB/store).\n */\nexport function sanitizeHtmlWithMax(input: string, maxLength: number = 50_000): string {\n  const s = sanitizeHtml(input)\n  if (s.length <= maxLength) return s\n  return s.slice(0, maxLength)\n}\n\n/**\n * Escape HTML entities so the string is safe for use in text nodes or attributes.\n */\nexport function escapeHtml(input: string): string {\n  if (typeof input !== 'string') return ''\n  const map: Record<string, string> = {\n    '&': '&amp;',\n    '<': '&lt;',\n    '>': '&gt;',\n    '\"': '&quot;',\n    \"'\": '&#39;',\n    '/': '&#x2F;'\n  }\n  return input.replace(/[&<>\"'/]/g, (c) => map[c] ?? c)\n}\n\n/**\n * Sanitize for display in a context where only safe text is allowed (e.g. profile name, bio).\n * Prefer escapeHtml when rendering in React (React escapes by default); use this for legacy or raw HTML.\n */\nexport function sanitizeForDisplay(input: string): string {\n  return escapeHtml(sanitizeHtml(input))\n}\n"],"names":[],"mappings":";;;;;;;;;;AAAA;;;CAGC,GAED,MAAM,eAAe;AACrB,MAAM,iBAAiB;AACvB,MAAM,uBAAuB;AAC7B,MAAM,iBAAiB;AACvB,0FAA0F;AAC1F,MAAM,uBAAuB;AAMtB,SAAS,aAAa,KAAa;IACxC,IAAI,OAAO,UAAU,UAAU,OAAO;IACtC,OAAO,MACJ,OAAO,CAAC,cAAc,IACtB,OAAO,CAAC,sBAAsB,IAC9B,OAAO,CAAC,gBAAgB,IACxB,OAAO,CAAC,sBAAsB,IAC9B,OAAO,CAAC,gBAAgB;AAC7B;AAKO,SAAS,oBAAoB,KAAa,EAAE,YAAoB,MAAM;IAC3E,MAAM,IAAI,aAAa;IACvB,IAAI,EAAE,MAAM,IAAI,WAAW,OAAO;IAClC,OAAO,EAAE,KAAK,CAAC,GAAG;AACpB;AAKO,SAAS,WAAW,KAAa;IACtC,IAAI,OAAO,UAAU,UAAU,OAAO;IACtC,MAAM,MAA8B;QAClC,KAAK;QACL,KAAK;QACL,KAAK;QACL,KAAK;QACL,KAAK;QACL,KAAK;IACP;IACA,OAAO,MAAM,OAAO,CAAC,aAAa,CAAC,IAAM,GAAG,CAAC,EAAE,IAAI;AACrD;AAMO,SAAS,mBAAmB,KAAa;IAC9C,OAAO,WAAW,aAAa;AACjC"}},
    {"offset": {"line": 1850, "column": 0}, "map": {"version":3,"sources":["file:///Users/nazy/ADK_WORKSPACE/TutorMekimi/tutorme-app/src/lib/security/parent-child-queries.ts"],"sourcesContent":["/**\n * Parent-Child Security Database Queries\n * Student existence verification and FamilyMember linking with RBAC\n */\n\nimport { db } from '@/lib/db'\nimport type { StudentLinkingInput } from '@/lib/validation/parent-child-security'\n\nexport interface VerifiedStudent {\n  userId: string\n  email: string\n  name: string | null\n  studentUniqueId: string | null\n}\n\n/**\n * Verify student exists by email or unique ID.\n * Returns the student User if found, null otherwise.\n * Optimized for <200ms response time.\n */\nexport async function verifyStudentExists(\n  input: StudentLinkingInput\n): Promise<VerifiedStudent | null> {\n  if (input.childEmail) {\n    const byEmail = await db.user.findFirst({\n      where: {\n        email: input.childEmail.toLowerCase(),\n        role: 'STUDENT',\n      },\n      select: {\n        id: true,\n        email: true,\n        profile: { select: { name: true, studentUniqueId: true } },\n      },\n    })\n    if (byEmail) {\n      return {\n        userId: byEmail.id,\n        email: byEmail.email,\n        name: byEmail.profile?.name ?? null,\n        studentUniqueId: byEmail.profile?.studentUniqueId ?? null,\n      }\n    }\n  }\n\n  if (input.childUniqueId && input.childUniqueId.length >= 8) {\n    const byUniqueId = await db.profile.findFirst({\n      where: {\n        studentUniqueId: input.childUniqueId,\n        user: { role: 'STUDENT' },\n      },\n      select: {\n        userId: true,\n        user: { select: { email: true } },\n        name: true,\n        studentUniqueId: true,\n      },\n    })\n    if (byUniqueId) {\n      return {\n        userId: byUniqueId.userId,\n        email: byUniqueId.user.email,\n        name: byUniqueId.name,\n        studentUniqueId: byUniqueId.studentUniqueId,\n      }\n    }\n  }\n\n  return null\n}\n\n/**\n * Verify all children exist before parent registration.\n * Returns map of index -> VerifiedStudent or error message.\n */\nexport async function verifyAllChildren(\n  children: StudentLinkingInput[]\n): Promise<{\n  verified: Map<number, VerifiedStudent>\n  errors: Array<{ index: number; message: string }>\n}> {\n  const verified = new Map<number, VerifiedStudent>()\n  const errors: Array<{ index: number; message: string }> = []\n\n  const results = await Promise.all(\n    children.map((child, index) => verifyStudentExists(child))\n  )\n\n  results.forEach((result, index) => {\n    if (result) {\n      verified.set(index, result)\n    } else {\n      const child = children[index]\n      const identifier = child.childEmail || child.childUniqueId || 'provided'\n      errors.push({\n        index,\n        message: `Child verification failed: No student found with ${identifier}. The child must register first at /register/student.`,\n      })\n    }\n  })\n\n  return { verified, errors }\n}\n\n/**\n * Check if student is already linked to another family account.\n */\nexport async function isStudentAlreadyLinked(userId: string): Promise<boolean> {\n  const existing = await db.familyMember.findFirst({\n    where: {\n      userId,\n      relation: { in: ['child', 'children'] },\n    },\n  })\n  return !!existing\n}\n"],"names":[],"mappings":";;;;;;;;AAAA;;;CAGC,GAED;;AAeO,eAAe,oBACpB,KAA0B;IAE1B,IAAI,MAAM,UAAU,EAAE;QACpB,MAAM,UAAU,MAAM,mMAAE,CAAC,IAAI,CAAC,SAAS,CAAC;YACtC,OAAO;gBACL,OAAO,MAAM,UAAU,CAAC,WAAW;gBACnC,MAAM;YACR;YACA,QAAQ;gBACN,IAAI;gBACJ,OAAO;gBACP,SAAS;oBAAE,QAAQ;wBAAE,MAAM;wBAAM,iBAAiB;oBAAK;gBAAE;YAC3D;QACF;QACA,IAAI,SAAS;YACX,OAAO;gBACL,QAAQ,QAAQ,EAAE;gBAClB,OAAO,QAAQ,KAAK;gBACpB,MAAM,QAAQ,OAAO,EAAE,QAAQ;gBAC/B,iBAAiB,QAAQ,OAAO,EAAE,mBAAmB;YACvD;QACF;IACF;IAEA,IAAI,MAAM,aAAa,IAAI,MAAM,aAAa,CAAC,MAAM,IAAI,GAAG;QAC1D,MAAM,aAAa,MAAM,mMAAE,CAAC,OAAO,CAAC,SAAS,CAAC;YAC5C,OAAO;gBACL,iBAAiB,MAAM,aAAa;gBACpC,MAAM;oBAAE,MAAM;gBAAU;YAC1B;YACA,QAAQ;gBACN,QAAQ;gBACR,MAAM;oBAAE,QAAQ;wBAAE,OAAO;oBAAK;gBAAE;gBAChC,MAAM;gBACN,iBAAiB;YACnB;QACF;QACA,IAAI,YAAY;YACd,OAAO;gBACL,QAAQ,WAAW,MAAM;gBACzB,OAAO,WAAW,IAAI,CAAC,KAAK;gBAC5B,MAAM,WAAW,IAAI;gBACrB,iBAAiB,WAAW,eAAe;YAC7C;QACF;IACF;IAEA,OAAO;AACT;AAMO,eAAe,kBACpB,QAA+B;IAK/B,MAAM,WAAW,IAAI;IACrB,MAAM,SAAoD,EAAE;IAE5D,MAAM,UAAU,MAAM,QAAQ,GAAG,CAC/B,SAAS,GAAG,CAAC,CAAC,OAAO,QAAU,oBAAoB;IAGrD,QAAQ,OAAO,CAAC,CAAC,QAAQ;QACvB,IAAI,QAAQ;YACV,SAAS,GAAG,CAAC,OAAO;QACtB,OAAO;YACL,MAAM,QAAQ,QAAQ,CAAC,MAAM;YAC7B,MAAM,aAAa,MAAM,UAAU,IAAI,MAAM,aAAa,IAAI;YAC9D,OAAO,IAAI,CAAC;gBACV;gBACA,SAAS,CAAC,iDAAiD,EAAE,WAAW,qDAAqD,CAAC;YAChI;QACF;IACF;IAEA,OAAO;QAAE;QAAU;IAAO;AAC5B;AAKO,eAAe,uBAAuB,MAAc;IACzD,MAAM,WAAW,MAAM,mMAAE,CAAC,YAAY,CAAC,SAAS,CAAC;QAC/C,OAAO;YACL;YACA,UAAU;gBAAE,IAAI;oBAAC;oBAAS;iBAAW;YAAC;QACxC;IACF;IACA,OAAO,CAAC,CAAC;AACX"}},
    {"offset": {"line": 1959, "column": 0}, "map": {"version":3,"sources":["file:///Users/nazy/ADK_WORKSPACE/TutorMekimi/tutorme-app/src/app/api/auth/register/route.ts"],"sourcesContent":["/**\n * POST /api/auth/register\n * Register a new user account\n */\n\nimport { NextRequest, NextResponse } from 'next/server'\nimport { Prisma } from '@prisma/client'\nimport bcrypt from 'bcryptjs'\nimport { nanoid } from 'nanoid'\nimport { db } from '@/lib/db'\nimport { RegisterUserSchema } from '@/lib/validation/schemas'\nimport { ValidationError } from '@/lib/api/middleware'\nimport { sanitizeHtml } from '@/lib/security/sanitize'\nimport { checkRateLimit, getClientIdentifier, RATE_LIMIT_PRESETS } from '@/lib/security/rate-limit'\nimport {\n  verifyAllChildren,\n  isStudentAlreadyLinked,\n} from '@/lib/security/parent-child-queries'\n\nfunction normalizeUsernameSeed(seed: string): string {\n  const cleaned = seed\n    .toLowerCase()\n    .replace(/[^a-z0-9._]/g, '')\n    .replace(/\\.+/g, '.')\n    .replace(/^\\.|\\.$/g, '')\n  if (cleaned.length >= 3) return cleaned.slice(0, 24)\n  return `user${nanoid(6).toLowerCase()}`\n}\n\nasync function generateUniqueUsername(tx: Prisma.TransactionClient, preferred: string): Promise<string> {\n  const base = normalizeUsernameSeed(preferred)\n  for (let attempt = 0; attempt < 20; attempt += 1) {\n    const suffix = attempt === 0 ? '' : String(Math.floor(Math.random() * 9000) + 1000)\n    const candidate = `${base}${suffix}`.slice(0, 30)\n    const exists = await tx.profile.findUnique({\n      where: { username: candidate },\n      select: { id: true },\n    })\n    if (!exists) return candidate\n  }\n  return `tutor${nanoid(8).toLowerCase()}`\n}\n\nexport async function POST(request: NextRequest) {\n  try {\n    // Parse request body first to catch JSON parsing errors\n    let body\n    try {\n      body = await request.json()\n    } catch {\n      return NextResponse.json({ error: 'Invalid JSON in request body' }, { status: 400 })\n    }\n\n    // Validate request body with Zod\n    const parsed = RegisterUserSchema.safeParse(body)\n    if (!parsed.success) {\n      const messages = parsed.error.issues\n        .map((issue) => `${issue.path.join('.')}: ${issue.message}`)\n        .join(', ')\n      return NextResponse.json({ error: messages }, { status: 400 })\n    }\n\n    const { email, password, role } = parsed.data\n    const name = sanitizeHtml(parsed.data.name).trim().slice(0, 100) || 'User'\n\n    // Role/email scoped rate limit prevents cross-tab role registrations from tripping each other.\n    const clientId = getClientIdentifier(request)\n    const registerOptions = RATE_LIMIT_PRESETS.register\n    const scopedRateLimit = await checkRateLimit(\n      `register:${clientId}:${String(role).toUpperCase()}:${String(email).toLowerCase()}`,\n      registerOptions\n    )\n    if (!scopedRateLimit.allowed) {\n      return NextResponse.json(\n        { error: 'Too many requests. Please try again later.' },\n        {\n          status: 429,\n          headers: {\n            'X-RateLimit-Remaining': String(scopedRateLimit.remaining),\n            'X-RateLimit-Reset': String(Math.ceil(scopedRateLimit.resetAt / 1000)),\n          },\n        }\n      )\n    }\n\n    let verifiedStudents: Map<number, import('@/lib/security/parent-child-queries').VerifiedStudent> | undefined\n\n    // Check if email already exists\n    const existingUser = await db.user.findUnique({\n      where: { email: email.toLowerCase() }\n    })\n\n    if (existingUser) {\n      throw new ValidationError('Email already registered')\n    }\n\n    // PARENT: Verify all children exist before creating family (security requirement)\n    if (role === 'PARENT' && body.additionalData?.students) {\n      const { verified, errors } = await verifyAllChildren(body.additionalData.students)\n      if (errors.length > 0) {\n        const msg = errors.map((e) => `Child ${e.index + 1}: ${e.message}`).join('; ')\n        return NextResponse.json({ error: msg }, { status: 400 })\n      }\n      // Check no student is already linked to another family\n      verifiedStudents = verified\n      for (const [, student] of verified) {\n        if (await isStudentAlreadyLinked(student.userId)) {\n          return NextResponse.json(\n            {\n              error: `Student ${student.email} is already linked to another parent account.`,\n            },\n            { status: 400 }\n          )\n        }\n      }\n    }\n\n    // Hash password\n    const hashedPassword = await bcrypt.hash(password, 10)\n\n    // Create user with profile in a transaction\n    const user = await db.$transaction(async (tx: Prisma.TransactionClient) => {\n      // Create the user\n      const newUser = await tx.user.create({\n        data: {\n          email: email.toLowerCase(),\n          password: hashedPassword,\n          role,\n        },\n        select: {\n          id: true,\n          email: true,\n          role: true,\n          createdAt: true,\n        }\n      })\n\n      const defaultUsername =\n        role === 'TUTOR'\n          ? await generateUniqueUsername(tx, name || email.split('@')[0] || 'tutor')\n          : null\n\n      // Create the profile (with studentUniqueId for STUDENT role - used for parent linking)\n      await tx.profile.create({\n        data: {\n          userId: newUser.id,\n          name,\n          ...(defaultUsername ? { username: defaultUsername } : {}),\n          tosAccepted: true,\n          tosAcceptedAt: new Date(),\n          ...(role === 'STUDENT' && {\n            studentUniqueId: `STU-${nanoid(12)}`,\n          }),\n        },\n      })\n\n      // If TUTOR role, update profile with tutor-specific data\n      if (role === 'TUTOR' && body.additionalData) {\n        const { education, experience, subjects, gradeLevels, hourlyRate } = body.additionalData\n        \n        await tx.profile.update({\n          where: { userId: newUser.id },\n          data: {\n            // Map education to credentials, experience to bio\n            credentials: education ? sanitizeHtml(education).trim().slice(0, 2000) : null,\n            // Combine experience with bio if provided\n            bio: experience ? `Experience: ${experience} years` : null,\n            // Map subjects to specialties\n            specialties: Array.isArray(subjects) ? subjects : [],\n            // Store hourly rate\n            hourlyRate: typeof hourlyRate === 'number' ? hourlyRate : null,\n            // Tutor starts as not onboarded - needs admin approval\n            isOnboarded: false,\n          },\n        })\n      }\n\n      // If PARENT role, create family account and related data\n      if (role === 'PARENT' && body.additionalData) {\n        const { students, emergencyContacts, notificationPreferences } = body.additionalData\n        \n        // Create FamilyAccount\n        const familyAccount = await tx.familyAccount.create({\n          data: {\n            familyName: name,\n            primaryEmail: email.toLowerCase(),\n            phoneNumber: body.profileData?.phoneNumber,\n            timezone: body.profileData?.timezone || 'Asia/Shanghai',\n            defaultCurrency: 'CNY',\n          }\n        })\n\n        // Link parent user to family account\n        await tx.familyMember.create({\n          data: {\n            familyAccountId: familyAccount.id,\n            userId: newUser.id,\n            name,\n            relation: 'parent',\n            email: email.toLowerCase(),\n          }\n        })\n\n        // Create emergency contacts (filter out empty placeholder entries)\n        const validContacts = (emergencyContacts || []).filter(\n          (c: { name?: string; phone?: string }) => c.name && c.phone\n        )\n        if (validContacts.length > 0) {\n          await tx.emergencyContact.createMany({\n            data: validContacts.map((contact: { name: string; relationship: string; phone: string }) => ({\n              parentId: familyAccount.id,\n              name: contact.name,\n              relation: contact.relationship,\n              phone: contact.phone,\n              isPrimary: false,\n            }))\n          })\n        }\n\n        // Create family member records for verified students (with userId for proper linking)\n        if (students && students.length > 0 && verifiedStudents) {\n          for (let i = 0; i < students.length; i++) {\n            const v = verifiedStudents.get(i)\n            if (v) {\n              await tx.familyMember.create({\n                data: {\n                  familyAccountId: familyAccount.id,\n                  userId: v.userId,\n                  name: v.name || students[i].name || v.email,\n                  relation: 'child',\n                  email: v.email,\n                },\n              })\n            }\n          }\n        }\n      }\n\n      return newUser\n    })\n\n    // For STUDENT: fetch studentUniqueId to return (for parent linking)\n    let studentUniqueId: string | undefined\n    if (role === 'STUDENT') {\n      const profile = await db.profile.findUnique({\n        where: { userId: user.id },\n        select: { studentUniqueId: true },\n      })\n      studentUniqueId = profile?.studentUniqueId ?? undefined\n    }\n\n    return NextResponse.json({\n      success: true,\n      message: 'User registered successfully',\n      user: {\n        id: user.id,\n        name,\n        email: user.email,\n        role: user.role,\n        tosAccepted: true,\n        ...(studentUniqueId && { studentUniqueId }),\n      },\n    }, { status: 201 })\n\n  } catch (error) {\n    console.error('Registration error:', error)\n\n    // Handle Zod validation errors\n    if (error && typeof error === 'object' && 'issues' in error) {\n      const zodError = error as { issues: Array<{ message: string }> }\n      const message = zodError.issues.map(i => i.message).join(', ')\n      return NextResponse.json({ error: message }, { status: 400 })\n    }\n\n    // Handle ValidationError\n    if (error instanceof ValidationError || (error as Error)?.name === 'ValidationError') {\n      const message = (error as Error).message || 'Validation error'\n      return NextResponse.json({ error: message }, { status: 400 })\n    }\n\n    // Handle Prisma errors\n    if (error && typeof error === 'object' && 'code' in error) {\n      const prismaError = error as { code: string; message?: string }\n      if (prismaError.code === 'P2002') {\n        return NextResponse.json({ error: 'Email already registered' }, { status: 400 })\n      }\n    }\n\n    return NextResponse.json(\n      { error: 'Internal server error. Please try again.' },\n      { status: 500 }\n    )\n  }\n}\n"],"names":[],"mappings":"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"}}]
}