;!function(){try { var e="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof global?global:"undefined"!=typeof window?window:"undefined"!=typeof self?self:{},n=(new e.Error).stack;n&&((e._debugIds|| (e._debugIds={}))[n]="32e74a9f-cbbc-55e0-a4da-8b0794a5bc0a")}catch(e){}}();
module.exports=[902157,(e,t,r)=>{t.exports=e.x("node:fs",()=>require("node:fs"))},750227,(e,t,r)=>{t.exports=e.x("node:path",()=>require("node:path"))},450869,e=>{"use strict";let t="tutorme:query:",r=null,n=null,a=!1,i=!(void 0!==globalThis.EdgeRuntime||"u">typeof process&&0);function s(){return i?(n||(n=new Map),n):null}async function o(){if(!i)return null;if(a)return r;try{let t=process.env.REDIS_URL;if(!t)return console.log("[DB] Redis URL not configured, using in-memory cache"),a=!0,null;let{Redis:n}=await e.A(443460);return(r=new n(t,{retryStrategy:e=>Math.min(50*e,2e3),maxRetriesPerRequest:3})).on("error",e=>{console.error("[Redis] Connection error:",e),r=null}),console.log("[DB] Redis cache initialized"),a=!0,r}catch(e){return console.warn("[DB] Failed to initialize Redis, using in-memory cache"),a=!0,null}}if(i)try{let{drizzleDb:t}=e.r(738597);console.log("[DB] Drizzle client (default db) initialized")}catch(e){console.error("[DB] Failed to initialize Drizzle:",e)}e.s(["cache",0,{ensureRedis:async()=>i?(a||await o(),r):null,async get(e){if(!i)return null;let r=t+e,n=await this.ensureRedis();if(n)try{let e=await n.get(r);if(e)return JSON.parse(e)}catch(e){console.error("[Cache] Redis get error:",e)}let a=s();if(!a)return null;let o=a.get(r);return o&&o.expires>Date.now()?o.data:(a.delete(r),null)},async set(e,r,n=60){if(!i)return;let a=t+e,o=await this.ensureRedis();if(o)try{await o.setex(a,n,JSON.stringify(r));return}catch(e){console.error("[Cache] Redis set error:",e)}let l=s();l&&l.set(a,{data:r,expires:Date.now()+1e3*n})},async delete(e){if(!i)return;let r=t+e,n=await this.ensureRedis();if(n)try{await n.del(r)}catch(e){console.error("[Cache] Redis del error:",e)}let a=s();a&&a.delete(r)},async clear(){if(!i)return;let e=await this.ensureRedis();if(e)try{let r=await e.keys(t+"*");r.length>0&&await e.del(...r)}catch(e){console.error("[Cache] Redis clear error:",e)}let r=s();r&&r.clear()},async getOrSet(e,t,r=60){let n=await this.get(e);if(null!==n)return n;let a=await t();return await this.set(e,a,r),a},async invalidatePattern(e){if(!i)return;let r=await this.ensureRedis();if(r)try{let n=await r.keys(t+e);n.length>0&&await r.del(...n)}catch(e){console.error("[Cache] Pattern invalidation error:",e)}let n=s();if(n){let r=new RegExp(t+e.replace("*",".*"));for(let e of n.keys())r.test(e)&&n.delete(e)}}}])},828734,(e,t,r)=>{t.exports=e.x("@prisma/client-38ad48cf7901491a",()=>require("@prisma/client-38ad48cf7901491a"))},184714,e=>{"use strict";let t;if(void 0===globalThis.EdgeRuntime)try{let{PrismaClient:r}=e.r(828734),n=globalThis;t=n.__prismaLegacy?n.__prismaLegacy:new r({log:["error"]})}catch{t=null}else t=null;let r=t;e.s(["prismaLegacyClient",0,r])},621557,e=>e.a(async(t,r)=>{try{var n=e.i(909105),a=e.i(738597),i=e.i(184714);e.i(688768);var s=e.i(257357),o=e.i(748846),l=t([a]);function u(e,t){let r=`作为一位专业的教育AI助手，请为${e.subject}科目生成${e.count}道练习题。

主题：${e.topics.join("、")}
难度级别：${e.difficulty}
题型：${e.taskTypes.join("、")}

要求：
1. 每道题都应该有明确的学习目标
2. 包含详细的题目描述
3. 提供正确答案和详细解析
4. 标注每道题的难度系数（1-10）
5. 相关知识点
6. 提供解题提示（可选）
7. 对于主观题，提供评分标准（rubric）

请以下面JSON格式返回（只返回JSON，不要有其他内容）：
{
  "tasks": [
    {
      "id": "task_1",
      "type": "multiple_choice",
      "question": "题目内容",
      "options": ["选项A", "选项B", "选项C", "选项D"],
      "correctAnswer": "选项A",
      "explanation": "详细解析...",
      "difficulty": 5,
      "topics": ["知识点1"],
      "hints": ["提示1", "提示2"],
      "rubric": [
        {"criteria": "标准1", "points": 5}
      ]
    }
  ]
}`;return t?`${r}

针对该学生的个性化要求：
- 当前水平：${t.currentLevel}
- 优势领域：${t.strengths.join("、")||"暂无"}
- 薄弱领域：${t.weaknesses.join("、")||"暂无"}
- 学习风格：${t.learningStyle||"综合"}

请根据学生的水平调整题目难度，针对薄弱领域加强练习，在优势领域提供挑战性题目。`:r}function c(e){try{let t=e.match(/\{[\s\S]*\}/);if(!t)throw Error("No JSON found in response");return JSON.parse(t[0]).tasks||[]}catch(e){return console.error("Failed to parse task response:",e),[{id:"fallback_1",type:"short_answer",question:"请描述你对这个知识点的理解",difficulty:5,topics:["general"],explanation:"这是一个默认题目，请重新生成任务。"}]}}async function d(e){let t=u(e),r=await (0,o.generateWithFallback)(t,{temperature:.7});return c(r.content)}async function p(e,t){let r=u(e,t),n=await (0,o.generateWithFallback)(r,{temperature:.7});return c(n.content)}async function h(e,t){return await Promise.all(e.map(async e=>{let t=(await a.drizzleDb.select().from(s.studentPerformance).where((0,n.eq)(s.studentPerformance.studentId,e)).limit(1))[0];return t?{id:e,currentLevel:function(e){switch(e){case"advanced":return"advanced";case"struggling":return"beginner";default:return"intermediate"}}(t.cluster),strengths:t.strengths||[],weaknesses:t.weaknesses||[],cluster:t.cluster,learningStyle:t.learningStyle}:{id:e,currentLevel:"intermediate",strengths:[],weaknesses:[],cluster:"intermediate"}}))}async function f(e,t,r){let n=await h(t,r),a=new Map,i={advanced:[],intermediate:[],struggling:[]};for(let[t,r]of(n.forEach(e=>{i[e.cluster||"intermediate"].push(e)}),Object.entries(i))){if(0===r.length)continue;let n={...e,difficulty:"advanced"===t?"advanced":"struggling"===t?"beginner":"intermediate"},i=u(n),s=await (0,o.generateWithFallback)(i,{temperature:.7}),l=c(s.content);for(let e of r)a.set(e.id,l)}return a}async function g(e,t,r){let n=await h(t,r),a=new Map,i=n.map(e=>e.currentLevel).reduce((e,t)=>(e[t]=(e[t]||0)+1,e),{}),s=Object.entries(i).sort((e,t)=>t[1]-e[1])[0]?.[0]||"intermediate",l={...e,difficulty:s},d=`${u(l)}

特别注意：这些题目将用于混合能力小组学习。请确保：
1. 题目有多个层次的理解深度
2. 初学者可以通过基础方法解答
3. 高水平学生可以展示更深入的理解
4. 鼓励小组讨论和互助学习`,p=await (0,o.generateWithFallback)(d,{temperature:.7}),f=c(p.content);return t.forEach(e=>{a.set(e,f)}),a}async function m(e,t,r){try{let n=new Map;switch(e){case"uniform":{let e=await d(t);(r.targetStudentId?[r.targetStudentId]:r.studentIds||[]).forEach(t=>n.set(t,e));break}case"personalized":if(!r.targetStudentId&&!r.studentIds?.length)return{success:!1,error:"需要指定学生ID"};for(let e of r.targetStudentId?[r.targetStudentId]:r.studentIds){let a=await h([e],r.curriculumId),i=await p(t,a[0]);n.set(e,i)}break;case"clustered":if(!r.studentIds?.length)return{success:!1,error:"需要指定学生列表"};n=await f(t,r.studentIds,r.curriculumId);break;case"peer_group":if(!r.studentIds?.length)return{success:!1,error:"需要指定学生列表"};n=await g(t,r.studentIds,r.curriculumId);break;default:return{success:!1,error:"未知的分发模式"}}return{success:!0,tasks:n}}catch(e){return console.error("Task generation failed:",e),{success:!1,error:e instanceof Error?e.message:"任务生成失败"}}}async function y(e,t){try{let r=[];for(let[n,a]of e.entries()){let e={};e[n]=a.map(e=>({taskId:e.id,question:e.question,type:e.type,difficulty:e.difficulty,hints:e.hints,rubric:e.rubric}));let s=await i.prismaLegacyClient.generatedTask.create({data:{tutorId:t.tutorId,roomId:t.roomId,title:t.title,description:t.description||`${t.title} - 共${a.length}道题目`,type:t.type||"assignment",difficulty:a[0]?.difficulty<=3?"easy":a[0]?.difficulty<=7?"medium":"hard",questions:a.map(e=>({id:e.id,question:e.question,type:e.type,options:e.options,correctAnswer:e.correctAnswer,explanation:e.explanation,difficulty:e.difficulty,topics:e.topics,hints:e.hints})),distributionMode:t.distributionMode,assignments:e,status:"draft"}});r.push(s.id)}return{success:!0,taskIds:r}}catch(e){return console.error("Failed to save tasks:",e),{success:!1,error:e instanceof Error?e.message:"保存任务失败"}}}[a]=l.then?(await l)():l,e.s(["generateAndDistributeTasks",()=>m,"generateUniformTasks",()=>d,"saveGeneratedTasks",()=>y]),r()}catch(e){r(e)}},!1),31606,e=>e.a(async(t,r)=>{try{var n=e.i(620971),a=e.i(8235),i=e.i(621557),s=e.i(384030),o=e.i(841195),l=t([a,i,s]);[a,i,s]=l.then?(await l)():l;let c=o.z.object({topic:o.z.string().min(1).max(200),count:o.z.number().int().min(1).max(20).default(5),difficulty:o.z.enum(["beginner","intermediate","advanced"]).default("intermediate"),types:o.z.array(o.z.enum(["multiple_choice","short_answer"])).min(1).max(2).default(["multiple_choice","short_answer"])});async function u(e){let{response:t}=await (0,s.withRateLimitPreset)(e,"aiGenerate");if(t)return t;let r=await (0,a.getServerSession)(a.authOptions,e);if(!r?.user)return n.NextResponse.json({error:"Unauthorized"},{status:401});if("TUTOR"!==r.user.role&&"ADMIN"!==r.user.role)return n.NextResponse.json({error:"Forbidden"},{status:403});let o=await e.json().catch(()=>null),l=c.safeParse(o);if(!l.success)return n.NextResponse.json({error:"Invalid request body"},{status:400});let{topic:u,count:d,difficulty:p,types:h}=l.data;try{let e=(await (0,i.generateUniformTasks)({subject:u,topics:[u],difficulty:p,taskTypes:h,count:Math.min(d,20)})).map((e,t)=>({id:`ai-${Date.now()}-${t}`,type:"multiple_choice"===e.type?"mcq":"short_answer"===e.type?"shortanswer":"long_answer"===e.type?"essay":"mcq",question:e.question||"",options:e.options||void 0,correctAnswer:e.correctAnswer||"",points:e.rubric?.[0]?.points??1,explanation:e.explanation||""}));return n.NextResponse.json({success:!0,questions:e,count:e.length})}catch(e){return console.error("AI question generation failed:",e),n.NextResponse.json({error:"Failed to generate questions"},{status:500})}}e.s(["POST",()=>u]),r()}catch(e){r(e)}},!1),700601,e=>e.a(async(t,r)=>{try{var n=e.i(78315),a=e.i(586961),i=e.i(196657),s=e.i(899733),o=e.i(233979),l=e.i(631683),u=e.i(840960),c=e.i(711373),d=e.i(699699),p=e.i(521140),h=e.i(205260),f=e.i(500249),g=e.i(431740),m=e.i(82608),y=e.i(635207),w=e.i(193695);e.i(708038);var R=e.i(447430),v=e.i(31606),_=t([v]);[v]=_.then?(await _)():_;let E=new n.AppRouteRouteModule({definition:{kind:a.RouteKind.APP_ROUTE,page:"/api/tutor/questions/generate/route",pathname:"/api/tutor/questions/generate",filename:"route",bundlePath:""},distDir:".next",relativeProjectDir:"",resolvedPagePath:"[project]/ADK_WORKSPACE/TutorMekimi/tutorme-app/src/app/api/tutor/questions/generate/route.ts",nextConfigOutput:"",userland:v}),{workAsyncStorage:k,workUnitAsyncStorage:C,serverHooks:A}=E;function b(){return(0,i.patchFetch)({workAsyncStorage:k,workUnitAsyncStorage:C})}async function x(e,t,r){E.isDev&&(0,s.addRequestMeta)(e,"devRequestTimingInternalsEnd",process.hrtime.bigint());let n="/api/tutor/questions/generate/route";n=n.replace(/\/index$/,"")||"/";let i=await E.prepare(e,t,{srcPage:n,multiZoneDraftMode:!1});if(!i)return t.statusCode=400,t.end("Bad Request"),null==r.waitUntil||r.waitUntil.call(r,Promise.resolve()),null;let{buildId:v,params:_,nextConfig:b,parsedUrl:x,isDraftMode:k,prerenderManifest:C,routerServerContext:A,isOnDemandRevalidate:I,revalidateOnlyGenerated:S,resolvedPathname:T,clientReferenceManifest:q,serverActionsManifest:P}=i,N=(0,u.normalizeAppPath)(n),O=!!(C.dynamicRoutes[N]||C.routes[T]),D=async()=>((null==A?void 0:A.render404)?await A.render404(e,t,x,!1):t.end("This page could not be found"),null);if(O&&!k){let e=!!C.routes[T],t=C.dynamicRoutes[N];if(t&&!1===t.fallback&&!e){if(b.experimental.adapterPath)return await D();throw new w.NoFallbackError}}let j=null;!O||E.isDev||k||(j=T,j="/index"===j?"/":j);let M=!0===E.isDev||!O,$=O&&!M;P&&q&&(0,l.setManifestsSingleton)({page:n,clientReferenceManifest:q,serverActionsManifest:P});let U=e.method||"GET",z=(0,o.getTracer)(),F=z.getActiveScopeSpan(),H={params:_,prerenderManifest:C,renderOpts:{experimental:{authInterrupts:!!b.experimental.authInterrupts},cacheComponents:!!b.cacheComponents,supportsDynamicResponse:M,incrementalCache:(0,s.getRequestMeta)(e,"incrementalCache"),cacheLifeProfiles:b.cacheLife,waitUntil:r.waitUntil,onClose:e=>{t.on("close",e)},onAfterTaskError:void 0,onInstrumentationRequestError:(t,r,n,a)=>E.onRequestError(e,t,n,a,A)},sharedContext:{buildId:v}},L=new c.NodeNextRequest(e),K=new c.NodeNextResponse(t),B=d.NextRequestAdapter.fromNodeNextRequest(L,(0,d.signalFromNodeResponse)(t));try{let i=async e=>E.handle(B,H).finally(()=>{if(!e)return;e.setAttributes({"http.status_code":t.statusCode,"next.rsc":!1});let r=z.getRootSpanAttributes();if(!r)return;if(r.get("next.span_type")!==p.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${r.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let a=r.get("next.route");if(a){let t=`${U} ${a}`;e.setAttributes({"next.route":a,"http.route":a,"next.span_name":t}),e.updateName(t)}else e.updateName(`${U} ${n}`)}),l=!!(0,s.getRequestMeta)(e,"minimalMode"),u=async s=>{var o,u;let c=async({previousCacheEntry:a})=>{try{if(!l&&I&&S&&!a)return t.statusCode=404,t.setHeader("x-nextjs-cache","REVALIDATED"),t.end("This page could not be found"),null;let n=await i(s);e.fetchMetrics=H.renderOpts.fetchMetrics;let o=H.renderOpts.pendingWaitUntil;o&&r.waitUntil&&(r.waitUntil(o),o=void 0);let u=H.renderOpts.collectedTags;if(!O)return await (0,f.sendResponse)(L,K,n,H.renderOpts.pendingWaitUntil),null;{let e=await n.blob(),t=(0,g.toNodeOutgoingHttpHeaders)(n.headers);u&&(t[y.NEXT_CACHE_TAGS_HEADER]=u),!t["content-type"]&&e.type&&(t["content-type"]=e.type);let r=void 0!==H.renderOpts.collectedRevalidate&&!(H.renderOpts.collectedRevalidate>=y.INFINITE_CACHE)&&H.renderOpts.collectedRevalidate,a=void 0===H.renderOpts.collectedExpire||H.renderOpts.collectedExpire>=y.INFINITE_CACHE?void 0:H.renderOpts.collectedExpire;return{value:{kind:R.CachedRouteKind.APP_ROUTE,status:n.status,body:Buffer.from(await e.arrayBuffer()),headers:t},cacheControl:{revalidate:r,expire:a}}}}catch(t){throw(null==a?void 0:a.isStale)&&await E.onRequestError(e,t,{routerKind:"App Router",routePath:n,routeType:"route",revalidateReason:(0,h.getRevalidateReason)({isStaticGeneration:$,isOnDemandRevalidate:I})},!1,A),t}},d=await E.handleResponse({req:e,nextConfig:b,cacheKey:j,routeKind:a.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:C,isRoutePPREnabled:!1,isOnDemandRevalidate:I,revalidateOnlyGenerated:S,responseGenerator:c,waitUntil:r.waitUntil,isMinimalMode:l});if(!O)return null;if((null==d||null==(o=d.value)?void 0:o.kind)!==R.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==d||null==(u=d.value)?void 0:u.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});l||t.setHeader("x-nextjs-cache",I?"REVALIDATED":d.isMiss?"MISS":d.isStale?"STALE":"HIT"),k&&t.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let p=(0,g.fromNodeOutgoingHttpHeaders)(d.value.headers);return l&&O||p.delete(y.NEXT_CACHE_TAGS_HEADER),!d.cacheControl||t.getHeader("Cache-Control")||p.get("Cache-Control")||p.set("Cache-Control",(0,m.getCacheControlHeader)(d.cacheControl)),await (0,f.sendResponse)(L,K,new Response(d.value.body,{headers:p,status:d.value.status||200})),null};F?await u(F):await z.withPropagatedContext(e.headers,()=>z.trace(p.BaseServerSpan.handleRequest,{spanName:`${U} ${n}`,kind:o.SpanKind.SERVER,attributes:{"http.method":U,"http.target":e.url}},u))}catch(t){if(t instanceof w.NoFallbackError||await E.onRequestError(e,t,{routerKind:"App Router",routePath:N,routeType:"route",revalidateReason:(0,h.getRevalidateReason)({isStaticGeneration:$,isOnDemandRevalidate:I})},!1,A),O)throw t;return await (0,f.sendResponse)(L,K,new Response(null,{status:500})),null}}e.s(["handler",()=>x,"patchFetch",()=>b,"routeModule",()=>E,"serverHooks",()=>A,"workAsyncStorage",()=>k,"workUnitAsyncStorage",()=>C]),r()}catch(e){r(e)}},!1),412171,e=>{e.v(t=>Promise.all(["server/chunks/b1c00_TutorMekimi_tutorme-app_src_lib_security_suspicious-activity_ts_7865686f._.js"].map(t=>e.l(t))).then(()=>t(145830)))},443460,e=>{e.v(t=>Promise.all(["server/chunks/[externals]_ioredis_c74819ca._.js"].map(t=>e.l(t))).then(()=>t(693545)))},571363,e=>{e.v(t=>Promise.all(["server/chunks/ADK_WORKSPACE_TutorMekimi_tutorme-app_src_lib_security_api-key_ts_45091e81._.js"].map(t=>e.l(t))).then(()=>t(175922)))}];

//# debugId=32e74a9f-cbbc-55e0-a4da-8b0794a5bc0a
//# sourceMappingURL=%5Broot-of-the-server%5D__b70fdd93._.js.map