;!function(){try { var e="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof global?global:"undefined"!=typeof window?window:"undefined"!=typeof self?self:{},n=(new e.Error).stack;n&&((e._debugIds|| (e._debugIds={}))[n]="5cbb55a6-99a5-2718-8263-c0f7d4c560e2")}catch(e){}}();
module.exports=[491405,e=>{"use strict";let t;var r=e.i(841195),i=e.i(254799),a=e.i(406461),s=e.i(224361);let l=(0,s.promisify)(a.gzip),n=(0,s.promisify)(a.gunzip),c={PREFIX:"tutorme:cache:",TAG_PREFIX:"tutorme:tags:",METRIC_PREFIX:"tutorme:metrics:",COMPRESS_THRESHOLD:1024,ENCRYPTION_ALGORITHM:"aes-256-gcm",ENCRYPTION_KEY_LENGTH:32,CONNECTION_TIMEOUT:2e3,COMMAND_TIMEOUT:3e3,KEEP_ALIVE:3e4,MAX_RETRIES:5,RETRY_DELAY_BASE:100,HEALTH_CHECK_INTERVAL:3e4,MEMORY_CACHE_MAX_SIZE:1e3,MEMORY_CACHE_TTL:60,TTL_DEFAULT:parseInt(process.env.CACHE_TTL_DEFAULT||"60",10),TTL_USER:parseInt(process.env.CACHE_TTL_USER||"300",10),TTL_LEADERBOARD:parseInt(process.env.CACHE_TTL_LEADERBOARD||"300",10),TTL_CONTENT:parseInt(process.env.CACHE_TTL_CONTENT||"600",10)};r.z.object({value:r.z.unknown(),compressed:r.z.boolean().default(!1),encrypted:r.z.boolean().default(!1),tags:r.z.array(r.z.string()).default([]),createdAt:r.z.number(),ttl:r.z.number()});let o=r.z.object({hits:r.z.number().default(0),misses:r.z.number().default(0),sets:r.z.number().default(0),deletes:r.z.number().default(0),errors:r.z.number().default(0),totalLatencyMs:r.z.number().default(0),compressionRatio:r.z.number().default(0),memoryCacheHits:r.z.number().default(0),redisCacheHits:r.z.number().default(0)});class h{key;constructor(){const e=process.env.CACHE_ENCRYPTION_KEY;if(e){if(this.key=Buffer.from(e,"hex"),this.key.length!==c.ENCRYPTION_KEY_LENGTH)throw Error("CACHE_ENCRYPTION_KEY must be 64 hex characters (32 bytes)")}else{const e=process.env.NEXTAUTH_SECRET||"dev-secret-change-in-production";this.key=i.createHash("sha256").update(e).digest()}}encrypt(e){let t=i.randomBytes(16),r=i.createCipheriv(c.ENCRYPTION_ALGORITHM,this.key,t),a=r.update(e,"utf8","hex");a+=r.final("hex");let s=r.getAuthTag();return`${t.toString("hex")}:${s.toString("hex")}:${a}`}decrypt(e){let[t,r,a]=e.split(":");if(!t||!r||!a)throw Error("Invalid encrypted data format");let s=Buffer.from(t,"hex"),l=Buffer.from(r,"hex"),n=i.createDecipheriv(c.ENCRYPTION_ALGORITHM,this.key,s);n.setAuthTag(l);let o=n.update(a,"hex","utf8");return o+n.final("utf8")}}class d{cache;maxSize;constructor(e=c.MEMORY_CACHE_MAX_SIZE){this.cache=new Map,this.maxSize=e}get(e){let t=this.cache.get(e);return t?t.expires<Date.now()?(this.cache.delete(e),null):t.data.value:null}set(e,t,r){if(this.cache.size>=this.maxSize&&!this.cache.has(e)){let e=this.cache.keys().next().value;e&&this.cache.delete(e)}this.cache.set(e,{data:t,expires:Date.now()+1e3*r})}delete(e){this.cache.delete(e)}clear(){this.cache.clear()}size(){return this.cache.size}cleanup(){let e=Date.now(),t=0;for(let[r,i]of Array.from(this.cache.entries()))i.expires<e&&(this.cache.delete(r),t++);return t}}let m=globalThis;m.cacheManager||(m.cacheManager=new class{redis=null;memoryCache;encryption;metrics;performanceHook=null;healthCheckInterval=null;isHealthy=!1;initializationPromise=null;constructor(){this.memoryCache=new d,this.encryption=new h,this.metrics=o.parse({}),setInterval(()=>{this.memoryCache.cleanup()},6e4)}async initialize(){return this.initializationPromise||(this.initializationPromise=this._initialize()),this.initializationPromise}async _initialize(){let t=process.env.REDIS_URL;if(!t)return void console.warn("[CacheManager] REDIS_URL not configured, using in-memory cache only");try{let{Redis:r}=await e.A(443460);this.redis=new r(t,{connectTimeout:c.CONNECTION_TIMEOUT,commandTimeout:c.COMMAND_TIMEOUT,keepAlive:c.KEEP_ALIVE,lazyConnect:!1,retryStrategy:e=>{if(e>c.MAX_RETRIES)return console.error("[CacheManager] Max retries reached, giving up"),null;let t=Math.min(c.RETRY_DELAY_BASE*Math.pow(2,e-1),2e3);return console.warn(`[CacheManager] Retry attempt ${e} after ${t}ms`),t},maxRetriesPerRequest:3,enableReadyCheck:!0,enableOfflineQueue:!0,showFriendlyErrorStack:!1}),this.redis.on("connect",()=>{console.log("[CacheManager] Redis connected"),this.isHealthy=!0}),this.redis.on("ready",()=>{console.log("[CacheManager] Redis ready"),this.isHealthy=!0}),this.redis.on("error",e=>{console.error("[CacheManager] Redis error:",e.message),this.isHealthy=!1,this.metrics.errors++}),this.redis.on("close",()=>{console.warn("[CacheManager] Redis connection closed"),this.isHealthy=!1}),this.redis.on("reconnecting",e=>{console.log(`[CacheManager] Redis reconnecting in ${e}ms`)}),await this.redis.ping(),console.log("[CacheManager] Redis initialized successfully"),this.startHealthCheck()}catch(e){console.error("[CacheManager] Failed to initialize Redis:",e),this.redis=null,this.isHealthy=!1}}startHealthCheck(){this.healthCheckInterval||(this.healthCheckInterval=setInterval(async()=>{if(!this.redis){this.isHealthy=!1;return}try{await Promise.race([this.redis.ping(),new Promise((e,t)=>setTimeout(()=>t(Error("Health check timeout")),1e3))]),this.isHealthy=!0}catch(e){console.warn("[CacheManager] Health check failed:",e),this.isHealthy=!1}},c.HEALTH_CHECK_INTERVAL))}isCacheHealthy(){return this.isHealthy||null===this.redis}getRedisClient(){return this.redis}setPerformanceHook(e){this.performanceHook=e}recordMetrics(e,t,r,i="none"){r?"get"===e?(this.metrics.hits++,"memory"===i&&this.metrics.memoryCacheHits++,"redis"===i&&this.metrics.redisCacheHits++):"set"===e?this.metrics.sets++:"delete"===e&&this.metrics.deletes++:(this.metrics.misses++,"get"!==e&&this.metrics.errors++),this.metrics.totalLatencyMs+=t,this.performanceHook&&this.performanceHook(e,t,r)}getMetrics(){let e=this.metrics.hits+this.metrics.misses>0?this.metrics.hits/(this.metrics.hits+this.metrics.misses):0,t=this.metrics.hits+this.metrics.misses>0?this.metrics.totalLatencyMs/(this.metrics.hits+this.metrics.misses):0;return{...this.metrics,hitRate:e,avgLatencyMs:t}}resetMetrics(){this.metrics=o.parse({})}async get(e,t={}){let r=Date.now(),i=c.PREFIX+e;try{await this.initialize();let a=this.memoryCache.get(i);if(null!==a)return this.recordMetrics("get",Date.now()-r,!0,"memory"),a;if(this.redis&&this.isHealthy)try{let a=await this.redis.get(i);if(a){let s=await this.deserializeEntry(a),l=(Date.now()-s.createdAt)/1e3;if(l>=s.ttl)return await this.delete(e),this.recordMetrics("get",Date.now()-r,!1),null;if(this.memoryCache.set(i,s,s.ttl-l),t.schema){let e=t.schema.parse(s.value);return this.recordMetrics("get",Date.now()-r,!0,"redis"),e}return this.recordMetrics("get",Date.now()-r,!0,"redis"),s.value}}catch(e){console.error("[CacheManager] Redis get error:",e),this.isHealthy=!1}return this.recordMetrics("get",Date.now()-r,!1),null}catch(e){return console.error("[CacheManager] Get error:",e),this.recordMetrics("get",Date.now()-r,!1),null}}async set(e,t,r={}){let i=Date.now(),a=c.PREFIX+e,s=r.ttl||c.TTL_DEFAULT;try{await this.initialize();let e=t;r.schema&&(e=r.schema.parse(t));let l={value:e,compressed:!1,encrypted:!1,tags:r.tags||[],createdAt:Date.now(),ttl:s},n=await this.serializeEntry(l,r);if(this.memoryCache.set(a,l,s),this.redis&&this.isHealthy)try{return await this.redis.setex(a,s,n),l.tags.length>0&&await this.addTagsToKey(a,l.tags),this.recordMetrics("set",Date.now()-i,!0),!0}catch(e){return console.error("[CacheManager] Redis set error:",e),this.isHealthy=!1,this.recordMetrics("set",Date.now()-i,!0),!0}return this.recordMetrics("set",Date.now()-i,!0),!0}catch(e){return console.error("[CacheManager] Set error:",e),this.recordMetrics("set",Date.now()-i,!1),!1}}async delete(e){let t=Date.now(),r=c.PREFIX+e;try{if(this.memoryCache.delete(r),this.redis&&this.isHealthy)try{return await this.redis.del(r),await this.removeTagsFromKey(r),this.recordMetrics("delete",Date.now()-t,!0),!0}catch(e){return console.error("[CacheManager] Redis delete error:",e),this.isHealthy=!1,this.recordMetrics("delete",Date.now()-t,!0),!0}return this.recordMetrics("delete",Date.now()-t,!0),!0}catch(e){return console.error("[CacheManager] Delete error:",e),this.recordMetrics("delete",Date.now()-t,!1),!1}}async getOrSet(e,t,r={}){let i=await this.get(e,r);if(null!==i)return i;let a=await t();return await this.set(e,a,r),a}async clear(){let e=Date.now();try{if(this.memoryCache.clear(),this.redis&&this.isHealthy)try{let t=await this.redis.keys(c.PREFIX+"*");t.length>0&&await this.redis.del(...t);let r=await this.redis.keys(c.TAG_PREFIX+"*");return r.length>0&&await this.redis.del(...r),this.recordMetrics("delete",Date.now()-e,!0),!0}catch(t){return console.error("[CacheManager] Redis clear error:",t),this.isHealthy=!1,this.recordMetrics("delete",Date.now()-e,!0),!0}return this.recordMetrics("delete",Date.now()-e,!0),!0}catch(t){return console.error("[CacheManager] Clear error:",t),this.recordMetrics("delete",Date.now()-e,!1),!1}}async invalidateTag(e){let t=Date.now(),r=c.TAG_PREFIX+e;try{if(!this.redis||!this.isHealthy)return console.warn("[CacheManager] Tag invalidation requires Redis"),0;let e=await this.redis.smembers(r);if(0===e.length)return 0;let i=e.map(e=>c.PREFIX+e.replace(c.PREFIX,""));return i.forEach(e=>this.memoryCache.delete(e)),await this.redis.del(...i),await this.redis.del(r),this.recordMetrics("delete",Date.now()-t,!0),e.length}catch(e){return console.error("[CacheManager] Tag invalidation error:",e),this.recordMetrics("delete",Date.now()-t,!1),0}}async invalidateTags(e){let t=0;for(let r of e)t+=await this.invalidateTag(r);return t}async addTagsToKey(e,t){if(this.redis&&this.isHealthy&&0!==t.length)try{let r=this.redis.pipeline();for(let i of t){let t=c.TAG_PREFIX+i;r.sadd(t,e),r.expire(t,2*c.TTL_DEFAULT)}await r.exec()}catch(e){console.error("[CacheManager] Add tags error:",e)}}async removeTagsFromKey(e){if(this.redis&&this.isHealthy)try{let t=await this.redis.keys(c.TAG_PREFIX+"*");if(0===t.length)return;let r=this.redis.pipeline();for(let i of t)r.srem(i,e);await r.exec()}catch(e){console.error("[CacheManager] Remove tags error:",e)}}async serializeEntry(e,t){let r=JSON.stringify(e);return(void 0!==t.compress?t.compress:Buffer.byteLength(r,"utf8")>c.COMPRESS_THRESHOLD)&&(r=(await l(Buffer.from(r,"utf8"))).toString("base64"),e.compressed=!0),t.encrypt&&(r=this.encryption.encrypt(r),e.encrypted=!0),JSON.stringify({compressed:e.compressed,encrypted:e.encrypted,tags:e.tags,createdAt:e.createdAt,ttl:e.ttl,data:r})}async deserializeEntry(e){let t=JSON.parse(e),r=t.data;t.encrypted&&(r=this.encryption.decrypt(r)),t.compressed&&(r=(await n(Buffer.from(r,"base64"))).toString("utf8"));let i=JSON.parse(r);return i.compressed=t.compressed,i.encrypted=t.encrypted,i.tags=t.tags,i.createdAt=t.createdAt,i.ttl=t.ttl,i}async disconnect(){this.healthCheckInterval&&(clearInterval(this.healthCheckInterval),this.healthCheckInterval=null),this.redis&&(await this.redis.quit(),this.redis=null,this.isHealthy=!1),this.memoryCache.clear(),console.log("[CacheManager] Disconnected")}}),t=m.cacheManager,e.s(["default",0,t])},6286,e=>e.a(async(t,r)=>{try{var i=e.i(909105),a=e.i(738597);e.i(688768);var s=e.i(257357),l=e.i(491405),n=t([a]);[a]=n.then?(await n)():n;let o={DASHBOARD:parseInt(process.env.CACHE_TTL_PARENT_DASHBOARD||"180",10),STUDENT_ANALYTICS:parseInt(process.env.CACHE_TTL_STUDENT_ANALYTICS||"45",10),FINANCIAL:parseInt(process.env.CACHE_TTL_PARENT_FINANCIAL||"120",10),FAMILY:parseInt(process.env.CACHE_TTL_PARENT_FAMILY||"300",10)}.FAMILY;async function c(e,t=!0){let r=e?.user?.email;if(!r)return null;let n="parent:family:"+e.user.id;if(t){let e=await l.default.get(n);if(e)return e}let[h]=await a.drizzleDb.select().from(s.familyMember).where((0,i.and)((0,i.eq)(s.familyMember.userId,e.user.id),(0,i.inArray)(s.familyMember.relation,["parent","PARENT","guardian"]))).limit(1);if(h){let[t]=await a.drizzleDb.select().from(s.familyAccount).where((0,i.eq)(s.familyAccount.id,h.familyAccountId)).limit(1);if(t){let r=await a.drizzleDb.select().from(s.familyMember).where((0,i.eq)(s.familyMember.familyAccountId,t.id)),c=r.map(e=>e.userId).filter(Boolean),h=c.length>0?await a.drizzleDb.select({id:s.user.id,email:s.user.email}).from(s.user).where((0,i.inArray)(s.user.id,c)):[],d=c.length>0?await a.drizzleDb.select({userId:s.profile.userId,name:s.profile.name,gradeLevel:s.profile.gradeLevel,avatarUrl:s.profile.avatarUrl}).from(s.profile).where((0,i.inArray)(s.profile.userId,c)):[],m=Object.fromEntries(h.map(e=>[e.id,e])),u=Object.fromEntries(d.map(e=>[e.userId,e])),y=r.filter(e=>e.userId&&["child","children"].includes(e.relation.toLowerCase())).map(e=>e.userId).filter(Boolean),f={id:t.id,familyName:t.familyName,primaryEmail:t.primaryEmail,defaultCurrency:t.defaultCurrency,monthlyBudget:t.monthlyBudget,enableBudget:t.enableBudget,members:r.map(e=>{let t=e.userId?m[e.userId]:void 0,r=e.userId?u[e.userId]:void 0;return{id:e.id,name:e.name,relation:e.relation,email:e.email,userId:e.userId,user:t?{id:t.id,email:t.email??"",profile:r?{name:r.name,gradeLevel:r.gradeLevel,avatarUrl:r.avatarUrl}:null}:null}}),studentIds:y};return await l.default.set(n,f,{ttl:o,tags:["parent","parent:"+e.user.id,"family:"+t.id]}),f}}let[d]=await a.drizzleDb.select().from(s.familyAccount).where((0,i.and)((0,i.eq)(s.familyAccount.primaryEmail,r.toLowerCase()),(0,i.eq)(s.familyAccount.isActive,!0))).limit(1);if(!d)return null;let m=await a.drizzleDb.select().from(s.familyMember).where((0,i.eq)(s.familyMember.familyAccountId,d.id)),u=m.map(e=>e.userId).filter(Boolean),y=u.length>0?await a.drizzleDb.select({id:s.user.id,email:s.user.email}).from(s.user).where((0,i.inArray)(s.user.id,u)):[],f=u.length>0?await a.drizzleDb.select({userId:s.profile.userId,name:s.profile.name,gradeLevel:s.profile.gradeLevel,avatarUrl:s.profile.avatarUrl}).from(s.profile).where((0,i.inArray)(s.profile.userId,u)):[],g=Object.fromEntries(y.map(e=>[e.id,e])),p=Object.fromEntries(f.map(e=>[e.userId,e])),E=m.filter(e=>e.userId&&["child","children"].includes(e.relation.toLowerCase())).map(e=>e.userId).filter(Boolean),C={id:d.id,familyName:d.familyName,primaryEmail:d.primaryEmail,defaultCurrency:d.defaultCurrency,monthlyBudget:d.monthlyBudget,enableBudget:d.enableBudget,members:m.map(e=>{let t=e.userId?g[e.userId]:void 0,r=e.userId?p[e.userId]:void 0;return{id:e.id,name:e.name,relation:e.relation,email:e.email,userId:e.userId,user:t?{id:t.id,email:t.email??"",profile:r?{name:r.name,gradeLevel:r.gradeLevel,avatarUrl:r.avatarUrl}:null}:null}}),studentIds:E};return await l.default.set(n,C,{ttl:o,tags:["parent","parent:"+e.user.id,"family:"+d.id]}),C}e.s(["getFamilyAccountForParent",()=>c]),r()}catch(e){r(e)}},!1)];

//# debugId=5cbb55a6-99a5-2718-8263-c0f7d4c560e2
//# sourceMappingURL=ADK_WORKSPACE_TutorMekimi_tutorme-app_src_lib_824e0b25._.js.map