;!function(){try { var e="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof global?global:"undefined"!=typeof window?window:"undefined"!=typeof self?self:{},n=(new e.Error).stack;n&&((e._debugIds|| (e._debugIds={}))[n]="8845e792-3e0e-dae7-c309-990c7621e1d6")}catch(e){}}();
module.exports=[508544,682412,a=>{"use strict";var b=a.i(260576),c=a.i(741510),d=a.i(326684),e=a.i(88684),f=a.i(333340),g=a.i(868606),h=a.i(981354),i=a.i(19926),j=a.i(178499),k=a.i(230381),l=a.i(450331),m=a.i(591137);function n(b,d={}){let e=(0,c.useRef)(null),[f,g]=(0,c.useState)(null),[h,i]=(0,c.useState)(!1);return(0,c.useEffect)(()=>{if(b)return(async()=>{let c=await a.A(443374).then(a=>a.getSocketToken());if(!c)return;let f=(0,m.io)({path:"/api/socket",transports:["websocket","polling"],timeout:2e4,reconnection:!0,reconnectionAttempts:10,reconnectionDelay:500,auth:{token:c}});e.current=f,f.on("connect",()=>{i(!0),g(f),b&&d.userId&&d.role&&f.emit("join_class",{roomId:b,userId:d.userId,name:d.name||d.role,role:d.role})}),f.on("disconnect",()=>{i(!1),g(null)}),f.on("connect_error",a=>{console.warn("Socket connection error:",a?.message||a),i(!1)})})(),()=>{e.current?.disconnect(),e.current=null}},[b,d.name,d.role,d.userId]),{socket:f,isConnected:h}}function o(a,b){return Number.isFinite(a)&&Number.isFinite(b)&&!(b<=0)?Math.max(0,Math.min(100,a/b*100)):0}function p(a,b){return Number.isFinite(a)&&Number.isFinite(b)&&!(b<=0)?a/100*b:0}async function q(a){try{let b=Function("name","return import(name)");return await b(a)}catch{return null}}function r({roomId:m,role:r="tutor",initialPdfUrl:s,forceLocked:t,showLockControl:u,showCollabStatus:v=!0,showAiActions:w=!0,capabilities:x}){let{data:y}=(0,d.useSession)(),z=(0,c.useRef)(null),A=(0,c.useRef)(null),B=(0,c.useRef)(null),C=(0,c.useRef)(null),D=(0,c.useRef)(0),E=(0,c.useRef)(!1),[F,G]=(0,c.useState)("original"),[H,I]=(0,c.useState)(null),[J,K]=(0,c.useState)(null),[L,M]=(0,c.useState)(1),[N,O]=(0,c.useState)(1),[P,Q]=(0,c.useState)(""),[R,S]=(0,c.useState)(""),[T,U]=(0,c.useState)(!1),[V,W]=(0,c.useState)("draw"),[X,Y]=(0,c.useState)("#ef4444"),[Z,$]=(0,c.useState)(2),_=y?.user?.id,aa=y?.user?.name||"Tutor",ab=(0,c.useMemo)(()=>({draw:x?.draw??!0,erase:x?.erase??!0,select:x?.select??!0,text:x?.text??!0,shapes:x?.shapes??!0,clear:x?.clear??!0,flatten:x?.flatten??!0}),[x]),ac=(0,c.useCallback)((a,b,c)=>{let d={...a,..."number"==typeof a.left?{left:p(a.left,b)}:{},..."number"==typeof a.top?{top:p(a.top,c)}:{},..."number"==typeof a.width?{width:p(a.width,b)}:{},..."number"==typeof a.height?{height:p(a.height,c)}:{},..."number"==typeof a.radius?{radius:p(a.radius,Math.min(b,c))}:{},..."number"==typeof a.strokeWidth?{strokeWidth:p(a.strokeWidth,Math.min(b,c))}:{},..."number"==typeof a.fontSize?{fontSize:p(a.fontSize,c)}:{}};return Array.isArray(d.points)&&(d.points=d.points.map(a=>({x:p(a.x,b),y:p(a.y,c)}))),Array.isArray(d.path)&&(d.path=d.path.map(a=>{if(!Array.isArray(a)||a.length<3)return a;let[d,...e]=a,f=[String(d)];for(let a=0;a<e.length;a+=2){let d=Number(e[a]),g=Number(e[a+1]);f.push(p(d,b),p(g,c))}return f})),d},[]),ad=(0,c.useCallback)((a,b,c)=>{let d=a.toObject(["id","type","left","top","width","height","radius","scaleX","scaleY","strokeWidth","fontSize","angle","fill","stroke","text","path","points"]),e={...d,id:d.id||`${Date.now()}-${Math.random().toString(16).slice(2)}`,..."number"==typeof d.left?{left:o(d.left,b)}:{},..."number"==typeof d.top?{top:o(d.top,c)}:{},..."number"==typeof d.width?{width:o(d.width,b)}:{},..."number"==typeof d.height?{height:o(d.height,c)}:{},..."number"==typeof d.radius?{radius:o(d.radius,Math.min(b,c))}:{},..."number"==typeof d.strokeWidth?{strokeWidth:o(d.strokeWidth,Math.min(b,c))}:{},..."number"==typeof d.fontSize?{fontSize:o(d.fontSize,c)}:{}};return Array.isArray(e.points)&&(e.points=e.points.map(a=>({x:o(a.x,b),y:o(a.y,c)}))),Array.isArray(e.path)&&(e.path=e.path.map(a=>{if(!Array.isArray(a)||a.length<3)return a;let[d,...e]=a,f=[String(d)];for(let a=0;a<e.length;a+=2){let d=Number(e[a]),g=Number(e[a+1]);f.push(o(d,b),o(g,c))}return f})),e},[]),ae=(0,c.useCallback)(async a=>{if(a.page!==L)return;let b=B.current;if(b&&a.actorId!==_){E.current=!0;try{if("removed"===a.action&&a.objectId){let c=b.getObjects().find(b=>b.id===a.objectId);c&&(b.remove(c),b.renderAll());return}if(!a.object)return;let c=b.getWidth(),d=b.getHeight(),e=ac(a.object,c,d);if(!e.id)return;let f=b.getObjects().find(a=>a.id===e.id);if(f){f.set(e),f.setCoords(),b.renderAll();return}let g=await q("fabric"),h=g?.fabric||g,i=h?.util?.enlivenObjects;"function"==typeof i&&i([e],a=>{a?.[0]&&(b.add(a[0]),b.renderAll())})}finally{setTimeout(()=>{E.current=!1},16)}}},[ac,L,_]),{isConnected:af,isLocked:ag,latencyMs:ah,participants:ai,emitCanvasEvent:aj,setLock:ak}=function({roomId:a,userId:b,name:d,role:e="tutor",onCanvasEvent:f,onCanvasState:g,onPresenceState:h}){let{socket:i,isConnected:j}=n(a,{userId:b,name:d,role:e}),[k,l]=(0,c.useState)(!1),[m,o]=(0,c.useState)(null),[p,q]=(0,c.useState)([]);(0,c.useEffect)(()=>{if(!i||!a)return;i.emit("pdf_join_room",{roomId:a,userId:b,name:d,role:e});let c=a=>{"number"==typeof a.sentAt&&o(Math.max(0,Date.now()-a.sentAt)),f?.(a)},j=b=>{b.roomId===a&&l(b.locked)},k=b=>{b.roomId===a&&g?.(b)},m=b=>{b.roomId===a&&(q(b.participants||[]),h?.(b))};return i.on("pdf_canvas_event",c),i.on("pdf_lock_state",j),i.on("pdf_canvas_state",k),i.on("pdf_presence_state",m),i.emit("pdf_request_state",{roomId:a}),()=>{i.off("pdf_canvas_event",c),i.off("pdf_lock_state",j),i.off("pdf_canvas_state",k),i.off("pdf_presence_state",m)}},[i,a,b,d,e,f,g,h]);let r=(0,c.useCallback)(c=>{i&&a&&i.emit("pdf_canvas_event",{roomId:a,actorId:b,sentAt:Date.now(),...c})},[i,a,b]),s=(0,c.useCallback)(b=>{i&&a&&i.emit("pdf_lock_toggle",{roomId:a,locked:b})},[i,a]);return(0,c.useMemo)(()=>({socket:i,isConnected:j,isLocked:k,latencyMs:m,participants:p,emitCanvasEvent:r,setLock:s}),[i,j,k,m,p,r,s])}({roomId:m,userId:_,name:aa,role:r,onCanvasEvent:ae,onCanvasState:(0,c.useCallback)(async a=>{let b=B.current;if(!b)return;let c=new Map;for(let b of a.events)if(b.page===L&&b.objectId){if("removed"===b.action){c.delete(b.objectId);continue}c.set(b.objectId,b)}E.current=!0;try{b.clear();let a=b.getWidth(),d=b.getHeight(),e=await q("fabric"),f=e?.fabric||e,g=f?.util?.enlivenObjects;if("function"!=typeof g)return;let h=Array.from(c.values()).map(a=>a.object).filter(a=>!!a).map(b=>ac(b,a,d));g(h,a=>{a.forEach(a=>b.add(a)),b.renderAll()})}finally{setTimeout(()=>{E.current=!1},16)}},[ac,L])}),al="boolean"==typeof t?t:ag,am=ab.draw&&!al,an=ab.erase&&!al,ao=ab.select&&!al;(0,c.useEffect)(()=>{"draw"!==V||ab.draw?"erase"!==V||ab.erase?"select"!==V||ab.select||W(ab.draw?"draw":"erase"):W(ab.draw?"draw":"select"):W(ab.erase?"erase":"select")},[ab.draw,ab.erase,ab.select,V]);let ap=(0,c.useCallback)(async(a,b)=>{let c=z.current;if(!c||!a)return;let d=++D.current;if(C.current){try{C.current.cancel?.()}catch{}C.current=null}let e=await a.getPage(b),f=e.getViewport({scale:1.35});c.width=f.width,c.height=f.height;let g=c.getContext("2d");if(!g)return;let h=e.render({canvasContext:g,viewport:f});C.current=h;try{await h.promise}catch(a){if(a?.name==="RenderingCancelledException")return;throw a}finally{C.current===h&&(C.current=null)}if(D.current!==d)return;let i=A.current;i&&(i.width=f.width,i.height=f.height,i.style.width=`${f.width}px`,i.style.height=`${f.height}px`),B.current&&(B.current.setDimensions({width:f.width,height:f.height}),B.current.renderAll())},[]),aq=(0,c.useCallback)(async()=>{if(A.current&&!B.current)try{let a=await q("fabric"),b=a?.fabric||a;if(!b?.Canvas){console.error("[PDFCollaborativeViewer] fabric library not found. Please run: npm install fabric"),U(!1);return}let c=new b.Canvas(A.current,{isDrawingMode:!0,selection:!0});c.freeDrawingBrush.width=2,c.freeDrawingBrush.color="#ef4444",B.current=c,U(!0);let d=(a,b)=>{if(!b||E.current)return;let d=c.getWidth(),e=c.getHeight(),f=ad(b,d,e);b.id=f.id,aj({page:L,action:a,object:f,objectId:f.id})};return c.on("path:created",a=>{a?.path&&d("created",a.path)}),c.on("object:modified",a=>d("modified",a?.target)),c.on("object:removed",a=>d("removed",a?.target)),()=>{c.dispose(),B.current=null,U(!1)}}catch(a){console.error("[PDFCollaborativeViewer] Error initializing fabric:",a),U(!1)}},[aj,L,ad]);(0,c.useEffect)(()=>{let a;return aq().then(b=>{"function"==typeof b&&(a=b)}).catch(()=>{U(!1)}),()=>{if(C.current){try{C.current.cancel?.()}catch{}C.current=null}a?.()}},[aq]),(0,c.useEffect)(()=>{if(B.current){let a="draw"===V&&am||"erase"===V&&an;B.current.isDrawingMode=a,B.current.selection=ao,B.current.freeDrawingBrush&&(B.current.freeDrawingBrush.width=Z,B.current.freeDrawingBrush.color="erase"===V?"#ffffff":X)}},[am,an,ao,X,Z,V]),(0,c.useEffect)(()=>{J&&ap(J,L)},[J,L,ap]);let ar=async b=>{let c=b.target.files?.[0];if(!c)return;let d=await c.arrayBuffer();I(d);let e=await a.A(623823),f=e.GlobalWorkerOptions;f&&!f.workerSrc&&(f.workerSrc="/pdf.worker.min.mjs");let g=await e.getDocument({data:d}).promise;K(g),O(g.numPages),M(1),await ap(g,1)};(0,c.useEffect)(()=>{if(!s)return;let b=!1;return(async()=>{try{let c=await fetch(s,{credentials:"include"});if(!c.ok)return;let d=await c.arrayBuffer();if(b)return;I(d);let e=await a.A(623823),f=e.GlobalWorkerOptions;f&&!f.workerSrc&&(f.workerSrc="/pdf.worker.min.mjs");let g=await e.getDocument({data:d}).promise;if(b)return;K(g),O(g.numPages),M(1),await ap(g,1)}catch{}})(),()=>{b=!0}},[s,ap]);let as=async()=>{let a=z.current?.toDataURL("image/png");if(!a)return;let b=await fetch("/api/pdf-tutoring/read",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({imageDataUrl:a})}),c=await b.json();Q(c.markdown||c.content||""),G("cleaned")},at=async()=>{let a=z.current?.toDataURL("image/png");if(!a)return;let b=await fetch("/api/pdf-tutoring/mark",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({imageDataUrl:a,rubric:"Award partial credit for correct setup and intermediate algebraic transformations."})}),c=await b.json();S(JSON.stringify(c.result||c,null,2)),G("marked")},au=async()=>{let a=B.current;if(!a||!R)return;let b=null;try{b=JSON.parse(R)}catch{return}let c=Array.isArray(b?.mistakeLocations)?b.mistakeLocations:[];if(0===c.length)return;let d=await q("fabric"),e=d?.fabric||d;if(!e?.Circle)return;let f=a.getWidth(),g=a.getHeight();c.forEach((b,c)=>{let d="number"==typeof b?.x?b.x:40+30*c,h="number"==typeof b?.y?b.y:40+22*c,i=d<=100?p(d,f):d,j=h<=100?p(h,g):h,k=new e.Circle({id:`ai-mistake-${Date.now()}-${c}`,left:Math.max(8,i-18),top:Math.max(8,j-18),radius:18,fill:"rgba(239,68,68,0.06)",stroke:"#ef4444",strokeWidth:2,selectable:!0});a.add(k)}),a.renderAll()},av=async()=>{if(!H||!B.current)return;let a=new Uint8Array(H),b="";for(let c=0;c<a.length;c++)b+=String.fromCharCode(a[c]);let c=btoa(b),d=B.current,e={originalPdfBase64:c,fabric:{page:L,width:d.getWidth(),height:d.getHeight(),objects:d.getObjects().map(a=>ad(a,d.getWidth(),d.getHeight()))}},f=await fetch("/api/pdf-tutoring/flatten",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)});if(!f.ok)return;let g=await f.blob(),h=URL.createObjectURL(g);window.open(h,"_blank","noopener,noreferrer")},aw=async()=>{let a=B.current;if(!a||al||!ab.text)return;let b=await q("fabric"),c=b?.fabric||b;if(!c?.IText)return;let d=new c.IText("Type here",{id:`text-${Date.now()}`,left:48,top:48,fill:"#ef4444",fontSize:20,editable:!0});a.add(d),a.setActiveObject(d),d.enterEditing?.(),a.renderAll()},ax=async()=>{let a=B.current;if(!a||al||!ab.shapes)return;let b=await q("fabric"),c=b?.fabric||b;if(!c?.Rect)return;let d=new c.Rect({id:`rect-${Date.now()}`,left:48,top:48,width:140,height:90,fill:"transparent",stroke:X,strokeWidth:Z});a.add(d),a.setActiveObject(d),a.renderAll()},ay=async()=>{let a=B.current;if(!a||al||!ab.shapes)return;let b=await q("fabric"),c=b?.fabric||b;if(!c?.Circle)return;let d=new c.Circle({id:`circle-${Date.now()}`,left:48,top:48,radius:55,fill:"transparent",stroke:X,strokeWidth:Z});a.add(d),a.setActiveObject(d),a.renderAll()},az=(0,c.useCallback)(async()=>{let a=B.current;a&&await fetch("/api/pdf-tutoring/snapshots",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({roomId:m,page:L,width:a.getWidth(),height:a.getHeight(),objects:a.getObjects().map(b=>ad(b,a.getWidth(),a.getHeight()))})})},[m,L,ad]);(0,c.useEffect)(()=>{if("tutor"!==r)return;let a=setInterval(()=>{let a=B.current;a&&0!==(a.getObjects?.()||[]).length&&az()},6e4);return()=>clearInterval(a)},[r,az]);let aA=async()=>{let a=B.current;if(!a)return;let b=await fetch(`/api/pdf-tutoring/snapshots?roomId=${encodeURIComponent(m)}&limit=1`,{credentials:"include"});if(!b.ok)return;let c=await b.json(),d=c?.snapshots?.[0],e=d?.pages?.[0];if(!e?.objects||!Array.isArray(e.objects))return;a.clear();let f=a.getWidth(),g=a.getHeight(),h=await q("fabric"),i=h?.fabric||h,j=i?.util?.enlivenObjects;"function"!=typeof j||j(e.objects.map(a=>ac(a,f,g)),b=>{b.forEach(b=>a.add(b)),a.renderAll()})},aB=(0,c.useMemo)(()=>af?null!==ah&&ah>50?(0,b.jsxs)(f.Badge,{variant:"secondary",children:["Sync ",ah,"ms"]}):(0,b.jsx)(f.Badge,{variant:"default",children:"Sync <50ms"}):(0,b.jsx)(f.Badge,{variant:"destructive",children:"Offline"}),[af,ah]),aC=(0,c.useMemo)(()=>{let a=ai.length,b=ai.filter(a=>"tutor"===a.role).length;return{total:a,tutors:b,students:a-b}},[ai]);return(0,b.jsxs)("div",{className:"space-y-4",children:[(0,b.jsxs)("div",{className:"flex flex-wrap items-center gap-2",children:[(0,b.jsx)(h.Input,{type:"file",accept:"application/pdf",onChange:ar,className:"max-w-sm"}),v&&aB,v&&(0,b.jsxs)(f.Badge,{variant:"outline",children:["Live: ",aC.total," (",aC.tutors," tutor, ",aC.students," students)"]}),v&&(0,b.jsx)(f.Badge,{variant:ag?"destructive":"secondary",children:al?"Canvas Locked":"Canvas Unlocked"}),(u??"tutor"===r)&&(0,b.jsxs)(e.Button,{variant:"outline",size:"sm",onClick:()=>ak(!al),children:[al?(0,b.jsx)(j.Unlock,{className:"w-4 h-4 mr-2"}):(0,b.jsx)(i.Lock,{className:"w-4 h-4 mr-2"}),al?"Unlock Canvas":"Lock Canvas"]}),w&&(0,b.jsxs)(e.Button,{variant:"outline",size:"sm",onClick:as,children:[(0,b.jsx)(l.RefreshCw,{className:"w-4 h-4 mr-2"}),"AI Cleaned Text"]}),w&&(0,b.jsx)(e.Button,{variant:"outline",size:"sm",onClick:at,children:"Run AI Marking"}),w&&(0,b.jsx)(e.Button,{variant:"outline",size:"sm",onClick:au,children:"Apply AI Error Circles"}),ab.text&&(0,b.jsx)(e.Button,{variant:"outline",size:"sm",onClick:aw,disabled:al,children:"Add Text"}),ab.shapes&&(0,b.jsxs)(b.Fragment,{children:[(0,b.jsx)(e.Button,{variant:"outline",size:"sm",onClick:ax,disabled:al,children:"Rectangle"}),(0,b.jsx)(e.Button,{variant:"outline",size:"sm",onClick:ay,disabled:al,children:"Circle"})]}),(0,b.jsx)(e.Button,{variant:"draw"===V?"default":"outline",size:"sm",onClick:()=>W("draw"),disabled:!am,children:"Draw"}),(0,b.jsx)(e.Button,{variant:"erase"===V?"default":"outline",size:"sm",onClick:()=>W("erase"),disabled:!an,children:"Erase"}),(0,b.jsx)(e.Button,{variant:"select"===V?"default":"outline",size:"sm",onClick:()=>W("select"),disabled:!ao,children:"Select"}),(0,b.jsxs)("label",{className:"flex items-center gap-1 text-xs",children:["Color",(0,b.jsx)("input",{type:"color",value:X,onChange:a=>Y(a.target.value),disabled:al||!am&&!an,className:"h-7 w-10 rounded border"})]}),(0,b.jsxs)("label",{className:"flex items-center gap-1 text-xs",children:["Width",(0,b.jsx)("input",{type:"range",min:1,max:10,step:1,value:Z,onChange:a=>$(Number(a.target.value)),disabled:al||!am&&!an}),(0,b.jsx)("span",{children:Z})]}),ab.clear&&(0,b.jsx)(e.Button,{variant:"outline",size:"sm",onClick:()=>{let a=B.current;a&&!al&&ab.clear&&(a.clear(),a.renderAll())},disabled:al,children:"Clear"}),"tutor"===r&&(0,b.jsxs)(b.Fragment,{children:[(0,b.jsx)(e.Button,{variant:"outline",size:"sm",onClick:az,children:"Save Snapshot"}),(0,b.jsx)(e.Button,{variant:"outline",size:"sm",onClick:aA,children:"Load Latest Snapshot"})]}),ab.flatten&&(0,b.jsx)(e.Button,{size:"sm",onClick:av,children:"Flatten PDF"})]}),(0,b.jsx)(g.Tabs,{value:F,onValueChange:a=>G(a),children:(0,b.jsxs)(g.TabsList,{children:[(0,b.jsx)(g.TabsTrigger,{value:"original",children:"Original View"}),w&&(0,b.jsx)(g.TabsTrigger,{value:"cleaned",children:"AI Cleaned Text"}),(0,b.jsx)(g.TabsTrigger,{value:"marked",children:"Marked Feedback"})]})}),(0,b.jsxs)("div",{className:"flex items-center gap-2",children:[(0,b.jsx)(e.Button,{variant:"outline",size:"sm",disabled:L<=1,onClick:()=>M(a=>a-1),children:"Prev"}),(0,b.jsxs)("span",{className:"text-sm",children:["Page ",L," / ",N]}),(0,b.jsx)(e.Button,{variant:"outline",size:"sm",disabled:L>=N,onClick:()=>M(a=>a+1),children:"Next"}),!T&&(0,b.jsx)(f.Badge,{variant:"secondary",children:"Install `fabric` package to enable drawing sync"})]}),"original"===F&&(0,b.jsxs)("div",{className:"relative inline-block border rounded-md overflow-hidden bg-white",children:[(0,b.jsx)("canvas",{ref:z,className:"block"}),(0,b.jsx)("canvas",{ref:A,className:"absolute inset-0"})]}),"cleaned"===F&&w&&(0,b.jsx)("pre",{className:"rounded-md border bg-muted p-4 text-xs whitespace-pre-wrap",children:P||"No cleaned text generated yet."}),"marked"===F&&(0,b.jsx)("pre",{className:"rounded-md border bg-muted p-4 text-xs whitespace-pre-wrap",children:R||"No marking feedback generated yet."}),(0,b.jsxs)("div",{className:"text-xs text-muted-foreground flex items-center gap-2",children:[(0,b.jsx)(k.Upload,{className:"w-3.5 h-3.5"}),"Coordinates are normalized as 0-100 percentages before sync for cross-device consistency."]})]})}a.s(["useSimpleSocket",()=>n],682412),a.s(["PDFCollaborativeViewer",()=>r],508544)}];

//# debugId=8845e792-3e0e-dae7-c309-990c7621e1d6
//# sourceMappingURL=286d7_tutorme-app_src_components_pdf-tutoring_PDFCollaborativeViewer_tsx_c60cff54._.js.map