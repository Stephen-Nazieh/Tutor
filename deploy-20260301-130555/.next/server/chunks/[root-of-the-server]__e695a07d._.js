;!function(){try { var e="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof global?global:"undefined"!=typeof window?window:"undefined"!=typeof self?self:{},n=(new e.Error).stack;n&&((e._debugIds|| (e._debugIds={}))[n]="3f4bdf99-013c-152c-b6a7-9a6d04fff7bc")}catch(e){}}();
module.exports=[902157,(e,t,a)=>{t.exports=e.x("node:fs",()=>require("node:fs"))},750227,(e,t,a)=>{t.exports=e.x("node:path",()=>require("node:path"))},450869,e=>{"use strict";let t="tutorme:query:",a=null,r=null,i=!1,n=!(void 0!==globalThis.EdgeRuntime||"u">typeof process&&0);function s(){return n?(r||(r=new Map),r):null}async function o(){if(!n)return null;if(i)return a;try{let t=process.env.REDIS_URL;if(!t)return console.log("[DB] Redis URL not configured, using in-memory cache"),i=!0,null;let{Redis:r}=await e.A(443460);return(a=new r(t,{retryStrategy:e=>Math.min(50*e,2e3),maxRetriesPerRequest:3})).on("error",e=>{console.error("[Redis] Connection error:",e),a=null}),console.log("[DB] Redis cache initialized"),i=!0,a}catch(e){return console.warn("[DB] Failed to initialize Redis, using in-memory cache"),i=!0,null}}if(n)try{let{drizzleDb:t}=e.r(738597);console.log("[DB] Drizzle client (default db) initialized")}catch(e){console.error("[DB] Failed to initialize Drizzle:",e)}e.s(["cache",0,{ensureRedis:async()=>n?(i||await o(),a):null,async get(e){if(!n)return null;let a=t+e,r=await this.ensureRedis();if(r)try{let e=await r.get(a);if(e)return JSON.parse(e)}catch(e){console.error("[Cache] Redis get error:",e)}let i=s();if(!i)return null;let o=i.get(a);return o&&o.expires>Date.now()?o.data:(i.delete(a),null)},async set(e,a,r=60){if(!n)return;let i=t+e,o=await this.ensureRedis();if(o)try{await o.setex(i,r,JSON.stringify(a));return}catch(e){console.error("[Cache] Redis set error:",e)}let l=s();l&&l.set(i,{data:a,expires:Date.now()+1e3*r})},async delete(e){if(!n)return;let a=t+e,r=await this.ensureRedis();if(r)try{await r.del(a)}catch(e){console.error("[Cache] Redis del error:",e)}let i=s();i&&i.delete(a)},async clear(){if(!n)return;let e=await this.ensureRedis();if(e)try{let a=await e.keys(t+"*");a.length>0&&await e.del(...a)}catch(e){console.error("[Cache] Redis clear error:",e)}let a=s();a&&a.clear()},async getOrSet(e,t,a=60){let r=await this.get(e);if(null!==r)return r;let i=await t();return await this.set(e,i,a),i},async invalidatePattern(e){if(!n)return;let a=await this.ensureRedis();if(a)try{let r=await a.keys(t+e);r.length>0&&await a.del(...r)}catch(e){console.error("[Cache] Pattern invalidation error:",e)}let r=s();if(r){let a=new RegExp(t+e.replace("*",".*"));for(let e of r.keys())a.test(e)&&r.delete(e)}}}])},9390,e=>e.a(async(t,a)=>{try{var r=e.i(620971),i=e.i(384030),n=e.i(738597);e.i(688768);var s=e.i(257357),o=e.i(748846),l=e.i(841195),c=e.i(254799),d=t([i,n]);[i,n]=d.then?(await d)():d;let u=l.z.object({type:l.z.enum(["explanation","example","analogy","simplification","activity","assessment"]),topic:l.z.string().min(1),subject:l.z.string().min(1),gradeLevel:l.z.string().optional(),context:l.z.string().optional(),difficulty:l.z.enum(["beginner","intermediate","advanced"]).default("intermediate"),format:l.z.enum(["plain","markdown","structured","bullet_points"]).default("markdown"),length:l.z.enum(["brief","medium","detailed"]).default("medium"),language:l.z.enum(["zh","en","both"]).default("zh")}),p=(0,i.withAuth)(async(e,t)=>{t.user.id;try{var a;let t,l,d,p,{response:h}=await (0,i.withRateLimitPreset)(e,"aiGenerate");if(h)return h;let f=await e.json(),g=u.safeParse(f);if(!g.success)return r.NextResponse.json({error:"Invalid request",details:g.error.format()},{status:400});let m=g.data,y=(t={brief:"Keep it concise (150-250 words).",medium:"Provide moderate detail (300-500 words).",detailed:"Be comprehensive (600-1000 words)."},l={plain:"Use plain text without formatting.",markdown:"Use Markdown formatting with headers, lists, and emphasis.",structured:"Use clear sections with headings and subheadings.",bullet_points:"Present key points as bullet lists."},d=({explanation:`
Create a clear, comprehensive explanation of "${m.topic}" for ${m.subject}.
The explanation should:
- Start with a brief overview/definition
- Break down the concept into digestible parts
- Explain the "why" and "how", not just the "what"
- Use clear, precise language appropriate for ${m.difficulty} level
${m.gradeLevel?`- Be appropriate for ${m.gradeLevel} students`:""}
${t[m.length]}
${l[m.format]}`,example:`
Create worked examples for "${m.topic}" in ${m.subject}.
Include:
- 2-3 diverse examples showing different aspects/applications
- Step-by-step solutions with clear reasoning
- Common pitfalls to avoid
- Variations that students might encounter
${m.gradeLevel?`- Difficulty appropriate for ${m.gradeLevel}`:""}
${t[m.length]}
${l[m.format]}`,analogy:`
Create analogies and metaphors to explain "${m.topic}" for ${m.subject}.
Provide:
- 3 different analogies from various domains
- For each: the analogy itself, why it works, and its limitations
- Visual descriptions where helpful
Make analogies relatable and appropriate for ${m.difficulty} level students.`,simplification:`
Create a simplified explanation of "${m.topic}" for ${m.subject}.
- Use simple, everyday language
- Avoid jargon (or explain it immediately)
- Connect to something students already know
Make it accessible without being condescending.`,activity:`
Design a classroom activity for teaching "${m.topic}" in ${m.subject}.
Include:
- Activity name and objective
- Materials needed
- Step-by-step procedure
- Grouping strategy
- Estimated time
- Assessment checkpoints
${m.gradeLevel?`- Designed for ${m.gradeLevel} students`:""}
Make it interactive and engaging.`,assessment:`
Create an assessment rubric for "${m.topic}" in ${m.subject}.
Include:
- Learning objectives being assessed
- Performance criteria (3-4 levels)
- Clear descriptors for each level
- Point values or grading scale
${m.gradeLevel?`- Appropriate for ${m.gradeLevel}`:""}
Focus on measuring understanding, not just memorization.`})[m.type],m.context&&(d+=`

ADDITIONAL CONTEXT: ${m.context}`),"zh"===m.language?d+="\n\n请用中文回答。":"both"===m.language&&(d+="\n\nProvide the response in both English and Chinese (bilingual format)."),d),v=await (0,o.generateWithFallback)(y,{temperature:.7,maxTokens:2500}),w=(a=v.content,p=a.split("\n").filter(e=>e.trim()),{title:(p[0]?.replace(/^#+\s*/,"").slice(0,100)||`${m.topic} - ${m.type}`).replace(/\*\*/g,"").trim(),content:a,type:m.type,metadata:{topic:m.topic,subject:m.subject,difficulty:m.difficulty,estimatedTime:"activity"===m.type?"15-30 minutes":void 0,prerequisites:[],relatedTopics:[]}});try{await n.drizzleDb.insert(s.aIAssistantInsight).values({id:(0,c.randomUUID)(),sessionId:f.sessionId||"temp",type:"content_suggestion",title:`Generated ${m.type}: ${w.title}`,content:w.content.slice(0,200)+"...",relatedData:{generationType:m.type,topic:m.topic,subject:m.subject,difficulty:m.difficulty},applied:!1})}catch{}return r.NextResponse.json({content:w,saved:!1,metadata:{provider:v.provider,latencyMs:v.latencyMs,generatedAt:new Date().toISOString()}})}catch(e){return console.error("Content generation error:",e),r.NextResponse.json({error:"Failed to generate content"},{status:500})}},{role:"TUTOR"}),h=(0,i.withAuth)(async(e,t)=>r.NextResponse.json({materials:[]}),{role:"TUTOR"});e.s(["GET",0,h,"POST",0,p]),a()}catch(e){a(e)}},!1),174951,e=>e.a(async(t,a)=>{try{var r=e.i(78315),i=e.i(586961),n=e.i(196657),s=e.i(899733),o=e.i(233979),l=e.i(631683),c=e.i(840960),d=e.i(711373),u=e.i(699699),p=e.i(521140),h=e.i(205260),f=e.i(500249),g=e.i(431740),m=e.i(82608),y=e.i(635207),v=e.i(193695);e.i(708038);var w=e.i(447430),R=e.i(9390),b=t([R]);[R]=b.then?(await b)():b;let E=new r.AppRouteRouteModule({definition:{kind:i.RouteKind.APP_ROUTE,page:"/api/tutor/ai-assistant/generate/route",pathname:"/api/tutor/ai-assistant/generate",filename:"route",bundlePath:""},distDir:".next",relativeProjectDir:"",resolvedPagePath:"[project]/ADK_WORKSPACE/TutorMekimi/tutorme-app/src/app/api/tutor/ai-assistant/generate/route.ts",nextConfigOutput:"",userland:R}),{workAsyncStorage:_,workUnitAsyncStorage:A,serverHooks:T}=E;function x(){return(0,n.patchFetch)({workAsyncStorage:_,workUnitAsyncStorage:A})}async function C(e,t,a){E.isDev&&(0,s.addRequestMeta)(e,"devRequestTimingInternalsEnd",process.hrtime.bigint());let r="/api/tutor/ai-assistant/generate/route";r=r.replace(/\/index$/,"")||"/";let n=await E.prepare(e,t,{srcPage:r,multiZoneDraftMode:!1});if(!n)return t.statusCode=400,t.end("Bad Request"),null==a.waitUntil||a.waitUntil.call(a,Promise.resolve()),null;let{buildId:R,params:b,nextConfig:x,parsedUrl:C,isDraftMode:_,prerenderManifest:A,routerServerContext:T,isOnDemandRevalidate:P,revalidateOnlyGenerated:$,resolvedPathname:k,clientReferenceManifest:D,serverActionsManifest:j}=n,O=(0,c.normalizeAppPath)(r),S=!!(A.dynamicRoutes[O]||A.routes[k]),N=async()=>((null==T?void 0:T.render404)?await T.render404(e,t,C,!1):t.end("This page could not be found"),null);if(S&&!_){let e=!!A.routes[k],t=A.dynamicRoutes[O];if(t&&!1===t.fallback&&!e){if(x.experimental.adapterPath)return await N();throw new v.NoFallbackError}}let I=null;!S||E.isDev||_||(I=k,I="/index"===I?"/":I);let U=!0===E.isDev||!S,z=S&&!U;j&&D&&(0,l.setManifestsSingleton)({page:r,clientReferenceManifest:D,serverActionsManifest:j});let M=e.method||"GET",q=(0,o.getTracer)(),L=q.getActiveScopeSpan(),H={params:b,prerenderManifest:A,renderOpts:{experimental:{authInterrupts:!!x.experimental.authInterrupts},cacheComponents:!!x.cacheComponents,supportsDynamicResponse:U,incrementalCache:(0,s.getRequestMeta)(e,"incrementalCache"),cacheLifeProfiles:x.cacheLife,waitUntil:a.waitUntil,onClose:e=>{t.on("close",e)},onAfterTaskError:void 0,onInstrumentationRequestError:(t,a,r,i)=>E.onRequestError(e,t,r,i,T)},sharedContext:{buildId:R}},F=new d.NodeNextRequest(e),B=new d.NodeNextResponse(t),K=u.NextRequestAdapter.fromNodeNextRequest(F,(0,u.signalFromNodeResponse)(t));try{let n=async e=>E.handle(K,H).finally(()=>{if(!e)return;e.setAttributes({"http.status_code":t.statusCode,"next.rsc":!1});let a=q.getRootSpanAttributes();if(!a)return;if(a.get("next.span_type")!==p.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${a.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let i=a.get("next.route");if(i){let t=`${M} ${i}`;e.setAttributes({"next.route":i,"http.route":i,"next.span_name":t}),e.updateName(t)}else e.updateName(`${M} ${r}`)}),l=!!(0,s.getRequestMeta)(e,"minimalMode"),c=async s=>{var o,c;let d=async({previousCacheEntry:i})=>{try{if(!l&&P&&$&&!i)return t.statusCode=404,t.setHeader("x-nextjs-cache","REVALIDATED"),t.end("This page could not be found"),null;let r=await n(s);e.fetchMetrics=H.renderOpts.fetchMetrics;let o=H.renderOpts.pendingWaitUntil;o&&a.waitUntil&&(a.waitUntil(o),o=void 0);let c=H.renderOpts.collectedTags;if(!S)return await (0,f.sendResponse)(F,B,r,H.renderOpts.pendingWaitUntil),null;{let e=await r.blob(),t=(0,g.toNodeOutgoingHttpHeaders)(r.headers);c&&(t[y.NEXT_CACHE_TAGS_HEADER]=c),!t["content-type"]&&e.type&&(t["content-type"]=e.type);let a=void 0!==H.renderOpts.collectedRevalidate&&!(H.renderOpts.collectedRevalidate>=y.INFINITE_CACHE)&&H.renderOpts.collectedRevalidate,i=void 0===H.renderOpts.collectedExpire||H.renderOpts.collectedExpire>=y.INFINITE_CACHE?void 0:H.renderOpts.collectedExpire;return{value:{kind:w.CachedRouteKind.APP_ROUTE,status:r.status,body:Buffer.from(await e.arrayBuffer()),headers:t},cacheControl:{revalidate:a,expire:i}}}}catch(t){throw(null==i?void 0:i.isStale)&&await E.onRequestError(e,t,{routerKind:"App Router",routePath:r,routeType:"route",revalidateReason:(0,h.getRevalidateReason)({isStaticGeneration:z,isOnDemandRevalidate:P})},!1,T),t}},u=await E.handleResponse({req:e,nextConfig:x,cacheKey:I,routeKind:i.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:A,isRoutePPREnabled:!1,isOnDemandRevalidate:P,revalidateOnlyGenerated:$,responseGenerator:d,waitUntil:a.waitUntil,isMinimalMode:l});if(!S)return null;if((null==u||null==(o=u.value)?void 0:o.kind)!==w.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==u||null==(c=u.value)?void 0:c.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});l||t.setHeader("x-nextjs-cache",P?"REVALIDATED":u.isMiss?"MISS":u.isStale?"STALE":"HIT"),_&&t.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let p=(0,g.fromNodeOutgoingHttpHeaders)(u.value.headers);return l&&S||p.delete(y.NEXT_CACHE_TAGS_HEADER),!u.cacheControl||t.getHeader("Cache-Control")||p.get("Cache-Control")||p.set("Cache-Control",(0,m.getCacheControlHeader)(u.cacheControl)),await (0,f.sendResponse)(F,B,new Response(u.value.body,{headers:p,status:u.value.status||200})),null};L?await c(L):await q.withPropagatedContext(e.headers,()=>q.trace(p.BaseServerSpan.handleRequest,{spanName:`${M} ${r}`,kind:o.SpanKind.SERVER,attributes:{"http.method":M,"http.target":e.url}},c))}catch(t){if(t instanceof v.NoFallbackError||await E.onRequestError(e,t,{routerKind:"App Router",routePath:O,routeType:"route",revalidateReason:(0,h.getRevalidateReason)({isStaticGeneration:z,isOnDemandRevalidate:P})},!1,T),S)throw t;return await (0,f.sendResponse)(F,B,new Response(null,{status:500})),null}}e.s(["handler",()=>C,"patchFetch",()=>x,"routeModule",()=>E,"serverHooks",()=>T,"workAsyncStorage",()=>_,"workUnitAsyncStorage",()=>A]),a()}catch(e){a(e)}},!1),412171,e=>{e.v(t=>Promise.all(["server/chunks/b1c00_TutorMekimi_tutorme-app_src_lib_security_suspicious-activity_ts_7865686f._.js"].map(t=>e.l(t))).then(()=>t(145830)))},443460,e=>{e.v(t=>Promise.all(["server/chunks/[externals]_ioredis_c74819ca._.js"].map(t=>e.l(t))).then(()=>t(693545)))},571363,e=>{e.v(t=>Promise.all(["server/chunks/ADK_WORKSPACE_TutorMekimi_tutorme-app_src_lib_security_api-key_ts_45091e81._.js"].map(t=>e.l(t))).then(()=>t(175922)))}];

//# debugId=3f4bdf99-013c-152c-b6a7-9a6d04fff7bc
//# sourceMappingURL=%5Broot-of-the-server%5D__e695a07d._.js.map