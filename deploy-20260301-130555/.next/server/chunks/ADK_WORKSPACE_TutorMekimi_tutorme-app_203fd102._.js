;!function(){try { var e="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof global?global:"undefined"!=typeof window?window:"undefined"!=typeof self?self:{},n=(new e.Error).stack;n&&((e._debugIds|| (e._debugIds={}))[n]="bebbe83d-7f01-1d33-5274-25c6f239eafd")}catch(e){}}();
module.exports=[305460,e=>e.a(async(t,r)=>{try{var s=e.i(620971),a=e.i(8235),i=e.i(908286),n=e.i(738597);e.i(688768);var o=e.i(257357),u=e.i(909105),l=e.i(997103),d=e.i(891820),c=e.i(254799),m=t([a,n,d]);async function p(e,t){try{var r,m,p;let h,f,w,R=await (0,a.getServerSession)(a.authOptions,e);if(!R?.user)return s.NextResponse.json({error:"Unauthorized"},{status:401});let g=R.user.id,x=await (0,i.getParamAsync)(t?.params,"taskId"),{answers:b,timeSpent:S,startedAt:v}=await e.json();if(!x)return s.NextResponse.json({error:"Task ID required"},{status:400});let[A]=await n.drizzleDb.select().from(o.generatedTask).where((0,u.eq)(o.generatedTask.id,x)).limit(1);if(!A)return s.NextResponse.json({error:"Task not found"},{status:404});if(A.enforceDueDate&&A.dueDate&&new Date>A.dueDate)return s.NextResponse.json({error:"Submission rejected: past due date",code:"PAST_DUE"},{status:403});if(A.enforceTimeLimit&&A.timeLimitMinutes&&v){let e=new Date(v),t=(Date.now()-e.getTime())/1e3/60,r=1.05*A.timeLimitMinutes;if(t>r)return s.NextResponse.json({error:`Submission rejected: time limit of ${A.timeLimitMinutes} minutes exceeded`,code:"TIME_LIMIT_EXCEEDED",elapsed:Math.round(t),allowed:A.timeLimitMinutes},{status:403})}let E=await n.drizzleDb.select().from(o.taskSubmission).where((0,u.and)((0,u.eq)(o.taskSubmission.taskId,x),(0,u.eq)(o.taskSubmission.studentId,g))).orderBy((0,l.desc)(o.taskSubmission.submittedAt)),I=E.length+1;if(I>A.maxAttempts)return s.NextResponse.json({error:`Maximum attempts (${A.maxAttempts}) reached`,code:"MAX_ATTEMPTS",maxAttempts:A.maxAttempts,currentAttempts:E.length},{status:403});let D=Array.isArray(A.questions)?A.questions:[],y=[],C=0,T=0;for(let e of D){let t=e.id,r=b[t],s=e.points??1;T+=s;let a=e.type?.toLowerCase(),i=!1,n=0;if("multiple_choice"===a||"mcq"===a)n=(i=r===e.correctAnswer)?s:0;else if("true_false"===a||"truefalse"===a)n=(i=String(r).toLowerCase()===String(e.correctAnswer).toLowerCase())?s:0;else if("short_answer"===a||"shortanswer"===a){let t=String(r||"").trim().toLowerCase(),a=String(e.correctAnswer||"").trim().toLowerCase();n=(i=t===a)?s:0}else n=0,i=!1;C+=n,y.push({questionId:t,correct:i,pointsEarned:n,pointsMax:s,selectedAnswer:r})}let P=T>0?C/T*100:0,k=Math.round(100*P)/100,M=A.maxScore||T;if(E.length>0&&A.maxAttempts>1){let e=E[0];await n.drizzleDb.update(o.taskSubmission).set({answers:b,questionResults:y,timeSpent:S||0,score:k,maxScore:M,status:"submitted",attempts:I,submittedAt:new Date}).where((0,u.eq)(o.taskSubmission.id,e.id)),f={id:e.id,score:k,maxScore:M,status:"submitted",attempts:I}}else{let e=c.default.randomUUID();await n.drizzleDb.insert(o.taskSubmission).values({id:e,taskId:x,studentId:g,answers:b,questionResults:y,timeSpent:S||0,score:k,maxScore:M,status:"submitted",attempts:I,tutorApproved:!1}),f={id:e,score:k,maxScore:M,status:"submitted",attempts:I}}if(A.lessonId){let[e]=await n.drizzleDb.select({moduleId:o.curriculumLesson.moduleId}).from(o.curriculumLesson).where((0,u.eq)(o.curriculumLesson.id,A.lessonId)).limit(1);if(e){let[t]=await n.drizzleDb.select({curriculumId:o.curriculumModule.curriculumId}).from(o.curriculumModule).where((0,u.eq)(o.curriculumModule.id,e.moduleId)).limit(1);w=t?.curriculumId;let[r]=await n.drizzleDb.select().from(o.curriculumLessonProgress).where((0,u.and)((0,u.eq)(o.curriculumLessonProgress.lessonId,A.lessonId),(0,u.eq)(o.curriculumLessonProgress.studentId,g))).limit(1),s=P>=70?"COMPLETED":"IN_PROGRESS",a=Math.round(P),i=P>=70?new Date:null;try{if(r)await n.drizzleDb.update(o.curriculumLessonProgress).set({status:s,score:a,completedAt:i}).where((0,u.eq)(o.curriculumLessonProgress.id,r.id));else{let e=c.default.randomUUID();await n.drizzleDb.insert(o.curriculumLessonProgress).values({id:e,lessonId:A.lessonId,studentId:g,status:s,currentSection:"",score:a,completedAt:i})}}catch(e){console.error("Failed to update lesson progress:",e)}}}let q=(r=P,m=D.length,p=A.difficulty,h=10*Math.max(m,1),Math.round(h*(r>=90?1.5:r>=70?1.2:r>=50?1:.5)*("hard"===p?1.5:"medium"===p?1.2:1)));try{let[e]=await n.drizzleDb.select().from(o.userGamification).where((0,u.eq)(o.userGamification.userId,g)).limit(1);if(e){let t=e.xp+q,r=Math.floor(t/1e3)+1;await n.drizzleDb.update(o.userGamification).set({xp:t,level:r>e.level?r:e.level}).where((0,u.eq)(o.userGamification.userId,g))}else{let e=c.default.randomUUID();await n.drizzleDb.insert(o.userGamification).values({id:e,userId:g,level:1,xp:q,streakDays:0,longestStreak:0,totalStudyMinutes:0,grammarScore:0,vocabularyScore:0,speakingScore:0,listeningScore:0,confidenceScore:0,fluencyScore:0,unlockedWorlds:[]})}}catch(e){console.error("Failed to update gamification:",e)}if(!w&&A.batchId){let[e]=await n.drizzleDb.select({curriculumId:o.courseBatch.curriculumId}).from(o.courseBatch).where((0,u.eq)(o.courseBatch.id,A.batchId)).limit(1);w=e?.curriculumId}return w&&(0,d.updateStudentPerformanceRecord)(g,w).catch(e=>console.error("Failed to update performance:",e)),s.NextResponse.json({success:!0,submission:{id:f.id,score:f.score,maxScore:f.maxScore,attempt:I,maxAttempts:A.maxAttempts,attemptsRemaining:A.maxAttempts-I,questionResults:y,xpEarned:q}})}catch(e){return console.error("Failed to submit task:",e),s.NextResponse.json({error:"Failed to submit"},{status:500})}}[a,n,d]=m.then?(await m)():m,e.s(["POST",()=>p]),r()}catch(e){r(e)}},!1),471929,e=>e.a(async(t,r)=>{try{var s=e.i(78315),a=e.i(586961),i=e.i(196657),n=e.i(899733),o=e.i(233979),u=e.i(631683),l=e.i(840960),d=e.i(711373),c=e.i(699699),m=e.i(521140),p=e.i(205260),h=e.i(500249),f=e.i(431740),w=e.i(82608),R=e.i(635207),g=e.i(193695);e.i(708038);var x=e.i(447430),b=e.i(305460),S=t([b]);[b]=S.then?(await S)():S;let E=new s.AppRouteRouteModule({definition:{kind:a.RouteKind.APP_ROUTE,page:"/api/student/assignments/[taskId]/submit/route",pathname:"/api/student/assignments/[taskId]/submit",filename:"route",bundlePath:""},distDir:".next",relativeProjectDir:"",resolvedPagePath:"[project]/ADK_WORKSPACE/TutorMekimi/tutorme-app/src/app/api/student/assignments/[taskId]/submit/route.ts",nextConfigOutput:"",userland:b}),{workAsyncStorage:I,workUnitAsyncStorage:D,serverHooks:y}=E;function v(){return(0,i.patchFetch)({workAsyncStorage:I,workUnitAsyncStorage:D})}async function A(e,t,r){E.isDev&&(0,n.addRequestMeta)(e,"devRequestTimingInternalsEnd",process.hrtime.bigint());let s="/api/student/assignments/[taskId]/submit/route";s=s.replace(/\/index$/,"")||"/";let i=await E.prepare(e,t,{srcPage:s,multiZoneDraftMode:!1});if(!i)return t.statusCode=400,t.end("Bad Request"),null==r.waitUntil||r.waitUntil.call(r,Promise.resolve()),null;let{buildId:b,params:S,nextConfig:v,parsedUrl:A,isDraftMode:I,prerenderManifest:D,routerServerContext:y,isOnDemandRevalidate:C,revalidateOnlyGenerated:T,resolvedPathname:P,clientReferenceManifest:k,serverActionsManifest:M}=i,q=(0,l.normalizeAppPath)(s),N=!!(D.dynamicRoutes[q]||D.routes[P]),_=async()=>((null==y?void 0:y.render404)?await y.render404(e,t,A,!1):t.end("This page could not be found"),null);if(N&&!I){let e=!!D.routes[P],t=D.dynamicRoutes[q];if(t&&!1===t.fallback&&!e){if(v.experimental.adapterPath)return await _();throw new g.NoFallbackError}}let z=null;!N||E.isDev||I||(z=P,z="/index"===z?"/":z);let L=!0===E.isDev||!N,O=N&&!L;M&&k&&(0,u.setManifestsSingleton)({page:s,clientReferenceManifest:k,serverActionsManifest:M});let U=e.method||"GET",j=(0,o.getTracer)(),H=j.getActiveScopeSpan(),F={params:S,prerenderManifest:D,renderOpts:{experimental:{authInterrupts:!!v.experimental.authInterrupts},cacheComponents:!!v.cacheComponents,supportsDynamicResponse:L,incrementalCache:(0,n.getRequestMeta)(e,"incrementalCache"),cacheLifeProfiles:v.cacheLife,waitUntil:r.waitUntil,onClose:e=>{t.on("close",e)},onAfterTaskError:void 0,onInstrumentationRequestError:(t,r,s,a)=>E.onRequestError(e,t,s,a,y)},sharedContext:{buildId:b}},$=new d.NodeNextRequest(e),K=new d.NodeNextResponse(t),B=c.NextRequestAdapter.fromNodeNextRequest($,(0,c.signalFromNodeResponse)(t));try{let i=async e=>E.handle(B,F).finally(()=>{if(!e)return;e.setAttributes({"http.status_code":t.statusCode,"next.rsc":!1});let r=j.getRootSpanAttributes();if(!r)return;if(r.get("next.span_type")!==m.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${r.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let a=r.get("next.route");if(a){let t=`${U} ${a}`;e.setAttributes({"next.route":a,"http.route":a,"next.span_name":t}),e.updateName(t)}else e.updateName(`${U} ${s}`)}),u=!!(0,n.getRequestMeta)(e,"minimalMode"),l=async n=>{var o,l;let d=async({previousCacheEntry:a})=>{try{if(!u&&C&&T&&!a)return t.statusCode=404,t.setHeader("x-nextjs-cache","REVALIDATED"),t.end("This page could not be found"),null;let s=await i(n);e.fetchMetrics=F.renderOpts.fetchMetrics;let o=F.renderOpts.pendingWaitUntil;o&&r.waitUntil&&(r.waitUntil(o),o=void 0);let l=F.renderOpts.collectedTags;if(!N)return await (0,h.sendResponse)($,K,s,F.renderOpts.pendingWaitUntil),null;{let e=await s.blob(),t=(0,f.toNodeOutgoingHttpHeaders)(s.headers);l&&(t[R.NEXT_CACHE_TAGS_HEADER]=l),!t["content-type"]&&e.type&&(t["content-type"]=e.type);let r=void 0!==F.renderOpts.collectedRevalidate&&!(F.renderOpts.collectedRevalidate>=R.INFINITE_CACHE)&&F.renderOpts.collectedRevalidate,a=void 0===F.renderOpts.collectedExpire||F.renderOpts.collectedExpire>=R.INFINITE_CACHE?void 0:F.renderOpts.collectedExpire;return{value:{kind:x.CachedRouteKind.APP_ROUTE,status:s.status,body:Buffer.from(await e.arrayBuffer()),headers:t},cacheControl:{revalidate:r,expire:a}}}}catch(t){throw(null==a?void 0:a.isStale)&&await E.onRequestError(e,t,{routerKind:"App Router",routePath:s,routeType:"route",revalidateReason:(0,p.getRevalidateReason)({isStaticGeneration:O,isOnDemandRevalidate:C})},!1,y),t}},c=await E.handleResponse({req:e,nextConfig:v,cacheKey:z,routeKind:a.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:D,isRoutePPREnabled:!1,isOnDemandRevalidate:C,revalidateOnlyGenerated:T,responseGenerator:d,waitUntil:r.waitUntil,isMinimalMode:u});if(!N)return null;if((null==c||null==(o=c.value)?void 0:o.kind)!==x.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==c||null==(l=c.value)?void 0:l.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});u||t.setHeader("x-nextjs-cache",C?"REVALIDATED":c.isMiss?"MISS":c.isStale?"STALE":"HIT"),I&&t.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let m=(0,f.fromNodeOutgoingHttpHeaders)(c.value.headers);return u&&N||m.delete(R.NEXT_CACHE_TAGS_HEADER),!c.cacheControl||t.getHeader("Cache-Control")||m.get("Cache-Control")||m.set("Cache-Control",(0,w.getCacheControlHeader)(c.cacheControl)),await (0,h.sendResponse)($,K,new Response(c.value.body,{headers:m,status:c.value.status||200})),null};H?await l(H):await j.withPropagatedContext(e.headers,()=>j.trace(m.BaseServerSpan.handleRequest,{spanName:`${U} ${s}`,kind:o.SpanKind.SERVER,attributes:{"http.method":U,"http.target":e.url}},l))}catch(t){if(t instanceof g.NoFallbackError||await E.onRequestError(e,t,{routerKind:"App Router",routePath:q,routeType:"route",revalidateReason:(0,p.getRevalidateReason)({isStaticGeneration:O,isOnDemandRevalidate:C})},!1,y),N)throw t;return await (0,h.sendResponse)($,K,new Response(null,{status:500})),null}}e.s(["handler",()=>A,"patchFetch",()=>v,"routeModule",()=>E,"serverHooks",()=>y,"workAsyncStorage",()=>I,"workUnitAsyncStorage",()=>D]),r()}catch(e){r(e)}},!1)];

//# debugId=bebbe83d-7f01-1d33-5274-25c6f239eafd
//# sourceMappingURL=ADK_WORKSPACE_TutorMekimi_tutorme-app_203fd102._.js.map