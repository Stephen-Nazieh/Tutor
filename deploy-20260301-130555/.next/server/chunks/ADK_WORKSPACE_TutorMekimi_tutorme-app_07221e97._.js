;!function(){try { var e="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof global?global:"undefined"!=typeof window?window:"undefined"!=typeof self?self:{},n=(new e.Error).stack;n&&((e._debugIds|| (e._debugIds={}))[n]="c7105365-cea7-25ba-34a2-506b65ab0ea8")}catch(e){}}();
module.exports=[164211,e=>e.a(async(t,n)=>{try{var r=e.i(620971),i=e.i(909105),a=e.i(997103),o=e.i(384030),l=e.i(738597);e.i(688768);var u=e.i(257357),c=t([o,l]);[o,l]=c.then?(await c)():c;let s=(0,o.withAuth)(async(e,t)=>{let n=t.user.id,{searchParams:o}=new URL(e.url),c=o.get("period")||"30d",s="7d"===c?7:"90d"===c?90:"1y"===c?365:30,d=new Date,m=new Date;m.setDate(m.getDate()-s);let[p]=await l.drizzleDb.select({currency:u.profile.currency}).from(u.profile).where((0,i.eq)(u.profile.userId,n)).limit(1),h=p?.currency||"SGD",[g,y,w,E,f,R]=await Promise.all([l.drizzleDb.query.payment.findMany({where:(0,i.and)((0,i.eq)(u.payment.status,"COMPLETED"),(0,i.exists)(l.drizzleDb.select().from(u.clinicBooking).innerJoin(u.clinic,(0,i.eq)(u.clinic.id,u.clinicBooking.clinicId)).where((0,i.and)((0,i.eq)(u.clinicBooking.id,u.payment.bookingId),(0,i.eq)(u.clinic.tutorId,n)))),(0,i.gte)(u.payment.createdAt,m),(0,i.lte)(u.payment.createdAt,d)),with:{booking:{with:{clinic:{columns:{id:!0,title:!0,subject:!0,startTime:!0}},student:{with:{profile:{columns:{name:!0}}},columns:{id:!0,email:!0}}}}},orderBy:[(0,a.desc)(u.payment.createdAt)]}),l.drizzleDb.query.payment.findMany({where:(0,i.and)((0,i.eq)(u.payment.status,"COMPLETED"),(0,i.or)((0,i.eq)(u.payment.tutorId,n),(0,i.exists)(l.drizzleDb.select().from(u.curriculumEnrollment).innerJoin(u.curriculum,(0,i.eq)(u.curriculum.id,u.curriculumEnrollment.curriculumId)).where((0,i.and)((0,i.eq)(u.curriculumEnrollment.id,u.payment.enrollmentId),(0,i.eq)(u.curriculum.creatorId,n))))),(0,i.gte)(u.payment.createdAt,m),(0,i.lte)(u.payment.createdAt,d)),orderBy:[(0,a.desc)(u.payment.createdAt)]}),l.drizzleDb.query.payment.findMany({where:(0,i.and)((0,i.eq)(u.payment.status,"COMPLETED"),(0,i.or)((0,i.eq)(u.payment.tutorId,n),(0,i.exists)(l.drizzleDb.select().from(u.clinicBooking).innerJoin(u.clinic,(0,i.eq)(u.clinic.id,u.clinicBooking.clinicId)).where((0,i.and)((0,i.eq)(u.clinicBooking.id,u.payment.bookingId),(0,i.eq)(u.clinic.tutorId,n)))),(0,i.exists)(l.drizzleDb.select().from(u.curriculumEnrollment).innerJoin(u.curriculum,(0,i.eq)(u.curriculum.id,u.curriculumEnrollment.curriculumId)).where((0,i.and)((0,i.eq)(u.curriculumEnrollment.id,u.payment.enrollmentId),(0,i.eq)(u.curriculum.creatorId,n)))))),columns:{amount:!0,currency:!0,createdAt:!0,paidAt:!0}}),l.drizzleDb.query.clinic.findMany({where:(0,i.and)((0,i.eq)(u.clinic.tutorId,n),(0,i.gte)(u.clinic.startTime,m),(0,i.lte)(u.clinic.startTime,d)),with:{bookings:{columns:{id:!0}}}}),l.drizzleDb.query.curriculum.findMany({where:(0,i.eq)(u.curriculum.creatorId,n),with:{enrollments:{where:(0,i.and)((0,i.gte)(u.curriculumEnrollment.enrolledAt,m),(0,i.lte)(u.curriculumEnrollment.enrolledAt,d))}}}),l.drizzleDb.select({amount:u.payout.amount,status:u.payout.status}).from(u.payout).where((0,i.eq)(u.payout.tutorId,n))]),v=e=>e.reduce((e,t)=>e+(t.amount??0),0),b=v(g)+v(y),q=v(w),D=R.filter(e=>"COMPLETED"===e.status).reduce((e,t)=>e+(t.amount||0),0),I=R.filter(e=>"PENDING"===e.status||"PROCESSING"===e.status).reduce((e,t)=>e+(t.amount||0),0),A=Math.max(0,q-D-I),C=new Date(m);C.setDate(C.getDate()-s);let k=await l.drizzleDb.query.payment.findMany({where:(0,i.and)((0,i.eq)(u.payment.status,"COMPLETED"),(0,i.or)((0,i.eq)(u.payment.tutorId,n),(0,i.exists)(l.drizzleDb.select().from(u.clinicBooking).innerJoin(u.clinic,(0,i.eq)(u.clinic.id,u.clinicBooking.clinicId)).where((0,i.and)((0,i.eq)(u.clinicBooking.id,u.payment.bookingId),(0,i.eq)(u.clinic.tutorId,n)))),(0,i.exists)(l.drizzleDb.select().from(u.curriculumEnrollment).innerJoin(u.curriculum,(0,i.eq)(u.curriculum.id,u.curriculumEnrollment.curriculumId)).where((0,i.and)((0,i.eq)(u.curriculumEnrollment.id,u.payment.enrollmentId),(0,i.eq)(u.curriculum.creatorId,n))))),(0,i.gte)(u.payment.createdAt,C),(0,i.lt)(u.payment.createdAt,m)),columns:{amount:!0}}),x=v(k),T=(await l.drizzleDb.query.payment.findMany({where:(0,i.and)((0,i.inArray)(u.payment.status,["PENDING","PROCESSING"]),(0,i.or)((0,i.eq)(u.payment.tutorId,n),(0,i.exists)(l.drizzleDb.select().from(u.clinicBooking).innerJoin(u.clinic,(0,i.eq)(u.clinic.id,u.clinicBooking.clinicId)).where((0,i.and)((0,i.eq)(u.clinicBooking.id,u.payment.bookingId),(0,i.eq)(u.clinic.tutorId,n)))))),columns:{amount:!0}})).reduce((e,t)=>e+(t.amount||0),0),M=[...g.map(e=>({id:e.id,date:e.createdAt.toISOString(),description:e.booking?.clinic?.title||"Clinic Session",amount:e.amount,currency:e.currency,type:"class",status:"completed",studentName:e.booking?.student?.profile?.name||e.booking?.student?.email?.split("@")[0]||"Unknown",clinicId:e.booking?.clinic?.id})),...y.map(e=>{let t=e.metadata||{};return{id:e.id,date:e.createdAt.toISOString(),description:`${t.curriculumName||"Course"} Enrollment`,amount:e.amount,currency:e.currency,type:"course",status:"completed",studentId:t.studentId}})].sort((e,t)=>new Date(t.date).getTime()-new Date(e.date).getTime()),P=f.map(e=>{let t=e.enrollments.length;return{id:e.id,name:e.name,enrollments:t,periodEnrollments:e.enrollments.length,estimatedRevenue:t*(e.price||0),currency:e.currency||h,conversionRate:t>0?Math.min(15,2.5*t):0,rating:t>0?Math.min(5,3.8+.05*Math.min(t,24)):null}}).sort((e,t)=>t.estimatedRevenue-e.estimatedRevenue),z=new Map;E.forEach(e=>{let t=new Date(e.startTime).getHours(),n=`${t}:00-${t+1}:00`,r=z.get(n)||{bookings:0,revenue:0};r.bookings+=e.bookings.length,r.revenue+=50*e.bookings.length,z.set(n,r)});let N=Array.from(z.entries()).map(([e,t])=>({slot:e,...t})).sort((e,t)=>t.bookings-e.bookings).slice(0,5),O=[];for(let e=6;e>=0;e--){let t=new Date(d.getFullYear(),d.getMonth()-e,1),n=new Date(d.getFullYear(),d.getMonth()-e+1,0,23,59,59),r=w.filter(e=>{let r=new Date(e.paidAt||e.createdAt||Date.now());return r>=t&&r<=n}),i=v(r);O.push({month:t.toLocaleDateString("en-US",{month:"short"}),revenue:i})}return r.NextResponse.json({summary:{availableBalance:Math.round(100*A)/100,periodEarnings:Math.round(100*b)/100,periodChange:Math.round(10*(x>0?(b-x)/x*100:0))/10,totalBookings:g.length,avgBookingValue:g.length>0?Math.round(b/g.length*100)/100:0,pendingAmount:Math.round(100*T)/100,currency:h},transactions:M,courses:P,timeSlots:N,monthlyTrend:O})},{role:"TUTOR"});e.s(["GET",0,s]),n()}catch(e){n(e)}},!1),669887,e=>e.a(async(t,n)=>{try{var r=e.i(78315),i=e.i(586961),a=e.i(196657),o=e.i(899733),l=e.i(233979),u=e.i(631683),c=e.i(840960),s=e.i(711373),d=e.i(699699),m=e.i(521140),p=e.i(205260),h=e.i(500249),g=e.i(431740),y=e.i(82608),w=e.i(635207),E=e.i(193695);e.i(708038);var f=e.i(447430),R=e.i(164211),v=t([R]);[R]=v.then?(await v)():v;let D=new r.AppRouteRouteModule({definition:{kind:i.RouteKind.APP_ROUTE,page:"/api/tutor/revenue/route",pathname:"/api/tutor/revenue",filename:"route",bundlePath:""},distDir:".next",relativeProjectDir:"",resolvedPagePath:"[project]/ADK_WORKSPACE/TutorMekimi/tutorme-app/src/app/api/tutor/revenue/route.ts",nextConfigOutput:"",userland:R}),{workAsyncStorage:I,workUnitAsyncStorage:A,serverHooks:C}=D;function b(){return(0,a.patchFetch)({workAsyncStorage:I,workUnitAsyncStorage:A})}async function q(e,t,n){D.isDev&&(0,o.addRequestMeta)(e,"devRequestTimingInternalsEnd",process.hrtime.bigint());let r="/api/tutor/revenue/route";r=r.replace(/\/index$/,"")||"/";let a=await D.prepare(e,t,{srcPage:r,multiZoneDraftMode:!1});if(!a)return t.statusCode=400,t.end("Bad Request"),null==n.waitUntil||n.waitUntil.call(n,Promise.resolve()),null;let{buildId:R,params:v,nextConfig:b,parsedUrl:q,isDraftMode:I,prerenderManifest:A,routerServerContext:C,isOnDemandRevalidate:k,revalidateOnlyGenerated:x,resolvedPathname:T,clientReferenceManifest:M,serverActionsManifest:P}=a,z=(0,c.normalizeAppPath)(r),N=!!(A.dynamicRoutes[z]||A.routes[T]),O=async()=>((null==C?void 0:C.render404)?await C.render404(e,t,q,!1):t.end("This page could not be found"),null);if(N&&!I){let e=!!A.routes[T],t=A.dynamicRoutes[z];if(t&&!1===t.fallback&&!e){if(b.experimental.adapterPath)return await O();throw new E.NoFallbackError}}let S=null;!N||D.isDev||I||(S=T,S="/index"===S?"/":S);let B=!0===D.isDev||!N,_=N&&!B;P&&M&&(0,u.setManifestsSingleton)({page:r,clientReferenceManifest:M,serverActionsManifest:P});let U=e.method||"GET",H=(0,l.getTracer)(),L=H.getActiveScopeSpan(),$={params:v,prerenderManifest:A,renderOpts:{experimental:{authInterrupts:!!b.experimental.authInterrupts},cacheComponents:!!b.cacheComponents,supportsDynamicResponse:B,incrementalCache:(0,o.getRequestMeta)(e,"incrementalCache"),cacheLifeProfiles:b.cacheLife,waitUntil:n.waitUntil,onClose:e=>{t.on("close",e)},onAfterTaskError:void 0,onInstrumentationRequestError:(t,n,r,i)=>D.onRequestError(e,t,r,i,C)},sharedContext:{buildId:R}},F=new s.NodeNextRequest(e),K=new s.NodeNextResponse(t),j=d.NextRequestAdapter.fromNodeNextRequest(F,(0,d.signalFromNodeResponse)(t));try{let a=async e=>D.handle(j,$).finally(()=>{if(!e)return;e.setAttributes({"http.status_code":t.statusCode,"next.rsc":!1});let n=H.getRootSpanAttributes();if(!n)return;if(n.get("next.span_type")!==m.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${n.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let i=n.get("next.route");if(i){let t=`${U} ${i}`;e.setAttributes({"next.route":i,"http.route":i,"next.span_name":t}),e.updateName(t)}else e.updateName(`${U} ${r}`)}),u=!!(0,o.getRequestMeta)(e,"minimalMode"),c=async o=>{var l,c;let s=async({previousCacheEntry:i})=>{try{if(!u&&k&&x&&!i)return t.statusCode=404,t.setHeader("x-nextjs-cache","REVALIDATED"),t.end("This page could not be found"),null;let r=await a(o);e.fetchMetrics=$.renderOpts.fetchMetrics;let l=$.renderOpts.pendingWaitUntil;l&&n.waitUntil&&(n.waitUntil(l),l=void 0);let c=$.renderOpts.collectedTags;if(!N)return await (0,h.sendResponse)(F,K,r,$.renderOpts.pendingWaitUntil),null;{let e=await r.blob(),t=(0,g.toNodeOutgoingHttpHeaders)(r.headers);c&&(t[w.NEXT_CACHE_TAGS_HEADER]=c),!t["content-type"]&&e.type&&(t["content-type"]=e.type);let n=void 0!==$.renderOpts.collectedRevalidate&&!($.renderOpts.collectedRevalidate>=w.INFINITE_CACHE)&&$.renderOpts.collectedRevalidate,i=void 0===$.renderOpts.collectedExpire||$.renderOpts.collectedExpire>=w.INFINITE_CACHE?void 0:$.renderOpts.collectedExpire;return{value:{kind:f.CachedRouteKind.APP_ROUTE,status:r.status,body:Buffer.from(await e.arrayBuffer()),headers:t},cacheControl:{revalidate:n,expire:i}}}}catch(t){throw(null==i?void 0:i.isStale)&&await D.onRequestError(e,t,{routerKind:"App Router",routePath:r,routeType:"route",revalidateReason:(0,p.getRevalidateReason)({isStaticGeneration:_,isOnDemandRevalidate:k})},!1,C),t}},d=await D.handleResponse({req:e,nextConfig:b,cacheKey:S,routeKind:i.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:A,isRoutePPREnabled:!1,isOnDemandRevalidate:k,revalidateOnlyGenerated:x,responseGenerator:s,waitUntil:n.waitUntil,isMinimalMode:u});if(!N)return null;if((null==d||null==(l=d.value)?void 0:l.kind)!==f.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==d||null==(c=d.value)?void 0:c.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});u||t.setHeader("x-nextjs-cache",k?"REVALIDATED":d.isMiss?"MISS":d.isStale?"STALE":"HIT"),I&&t.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let m=(0,g.fromNodeOutgoingHttpHeaders)(d.value.headers);return u&&N||m.delete(w.NEXT_CACHE_TAGS_HEADER),!d.cacheControl||t.getHeader("Cache-Control")||m.get("Cache-Control")||m.set("Cache-Control",(0,y.getCacheControlHeader)(d.cacheControl)),await (0,h.sendResponse)(F,K,new Response(d.value.body,{headers:m,status:d.value.status||200})),null};L?await c(L):await H.withPropagatedContext(e.headers,()=>H.trace(m.BaseServerSpan.handleRequest,{spanName:`${U} ${r}`,kind:l.SpanKind.SERVER,attributes:{"http.method":U,"http.target":e.url}},c))}catch(t){if(t instanceof E.NoFallbackError||await D.onRequestError(e,t,{routerKind:"App Router",routePath:z,routeType:"route",revalidateReason:(0,p.getRevalidateReason)({isStaticGeneration:_,isOnDemandRevalidate:k})},!1,C),N)throw t;return await (0,h.sendResponse)(F,K,new Response(null,{status:500})),null}}e.s(["handler",()=>q,"patchFetch",()=>b,"routeModule",()=>D,"serverHooks",()=>C,"workAsyncStorage",()=>I,"workUnitAsyncStorage",()=>A]),n()}catch(e){n(e)}},!1)];

//# debugId=c7105365-cea7-25ba-34a2-506b65ab0ea8
//# sourceMappingURL=ADK_WORKSPACE_TutorMekimi_tutorme-app_07221e97._.js.map