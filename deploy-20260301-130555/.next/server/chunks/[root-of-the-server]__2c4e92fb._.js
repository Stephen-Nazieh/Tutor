;!function(){try { var e="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof global?global:"undefined"!=typeof window?window:"undefined"!=typeof self?self:{},n=(new e.Error).stack;n&&((e._debugIds|| (e._debugIds={}))[n]="0e85c787-fc45-9fd7-3c3a-fedb11e18489")}catch(e){}}();
module.exports=[604824,e=>e.a(async(t,a)=>{try{var i=e.i(620971),r=e.i(909105),n=e.i(997103),s=e.i(384030),o=e.i(6286),l=e.i(738597);e.i(688768);var u=e.i(257357),d=e.i(491405),c=e.i(841195),p=t([s,o,l]);[s,o,l]=p.then?(await p)():p;let h=c.z.object({ids:c.z.array(c.z.string()).optional(),all:c.z.boolean().optional()}),f=(0,s.withAuth)(async(e,t)=>{let a=await (0,o.getFamilyAccountForParent)(t);if(!a)return i.NextResponse.json({error:"未找到家庭账户"},{status:404});let s=`parent:notifications:${a.id}`,c=await d.default.get(s);if(c)return i.NextResponse.json({success:!0,data:c});let p=await l.drizzleDb.query.familyNotification.findMany({where:(0,r.eq)(u.familyNotification.parentId,a.id),orderBy:[(0,n.desc)(u.familyNotification.createdAt)],limit:50}),h={notifications:p.map(e=>({id:e.id,title:e.title,message:e.message,isRead:e.isRead,createdAt:e.createdAt})),unreadCount:p.filter(e=>!e.isRead).length};return await d.default.set(s,h,{ttl:60,tags:[`family:${a.id}`]}),i.NextResponse.json({success:!0,data:h})},{role:"PARENT"}),R=(0,s.withAuth)(async(e,t)=>{let a,n=await (0,o.getFamilyAccountForParent)(t);if(!n)return i.NextResponse.json({error:"未找到家庭账户"},{status:404});try{a=h.parse(await e.json().catch(()=>({})))}catch{return i.NextResponse.json({error:"无效请求"},{status:400})}let s=[(0,r.eq)(u.familyNotification.parentId,n.id)];if(!0===a.all)s.push((0,r.eq)(u.familyNotification.isRead,!1));else{if(!a.ids?.length)return i.NextResponse.json({error:"请提供 ids 或 all"},{status:400});s.push((0,r.inArray)(u.familyNotification.id,a.ids))}return await l.drizzleDb.update(u.familyNotification).set({isRead:!0}).where((0,r.and)(...s)),await d.default.invalidateTag(`family:${n.id}`),i.NextResponse.json({success:!0})},{role:"PARENT"});e.s(["GET",0,f,"PATCH",0,R]),a()}catch(e){a(e)}},!1),324629,e=>e.a(async(t,a)=>{try{var i=e.i(78315),r=e.i(586961),n=e.i(196657),s=e.i(899733),o=e.i(233979),l=e.i(631683),u=e.i(840960),d=e.i(711373),c=e.i(699699),p=e.i(521140),h=e.i(205260),f=e.i(500249),R=e.i(431740),m=e.i(82608),v=e.i(635207),y=e.i(193695);e.i(708038);var w=e.i(447430),g=e.i(604824),E=t([g]);[g]=E.then?(await E)():E;let x=new i.AppRouteRouteModule({definition:{kind:r.RouteKind.APP_ROUTE,page:"/api/parent/notifications/route",pathname:"/api/parent/notifications",filename:"route",bundlePath:""},distDir:".next",relativeProjectDir:"",resolvedPagePath:"[project]/ADK_WORKSPACE/TutorMekimi/tutorme-app/src/app/api/parent/notifications/route.ts",nextConfigOutput:"",userland:g}),{workAsyncStorage:C,workUnitAsyncStorage:N,serverHooks:P}=x;function A(){return(0,n.patchFetch)({workAsyncStorage:C,workUnitAsyncStorage:N})}async function _(e,t,a){x.isDev&&(0,s.addRequestMeta)(e,"devRequestTimingInternalsEnd",process.hrtime.bigint());let i="/api/parent/notifications/route";i=i.replace(/\/index$/,"")||"/";let n=await x.prepare(e,t,{srcPage:i,multiZoneDraftMode:!1});if(!n)return t.statusCode=400,t.end("Bad Request"),null==a.waitUntil||a.waitUntil.call(a,Promise.resolve()),null;let{buildId:g,params:E,nextConfig:A,parsedUrl:_,isDraftMode:C,prerenderManifest:N,routerServerContext:P,isOnDemandRevalidate:T,revalidateOnlyGenerated:b,resolvedPathname:O,clientReferenceManifest:S,serverActionsManifest:k}=n,j=(0,u.normalizeAppPath)(i),q=!!(N.dynamicRoutes[j]||N.routes[O]),H=async()=>((null==P?void 0:P.render404)?await P.render404(e,t,_,!1):t.end("This page could not be found"),null);if(q&&!C){let e=!!N.routes[O],t=N.dynamicRoutes[j];if(t&&!1===t.fallback&&!e){if(A.experimental.adapterPath)return await H();throw new y.NoFallbackError}}let D=null;!q||x.isDev||C||(D=O,D="/index"===D?"/":D);let I=!0===x.isDev||!q,M=q&&!I;k&&S&&(0,l.setManifestsSingleton)({page:i,clientReferenceManifest:S,serverActionsManifest:k});let U=e.method||"GET",F=(0,o.getTracer)(),K=F.getActiveScopeSpan(),$={params:E,prerenderManifest:N,renderOpts:{experimental:{authInterrupts:!!A.experimental.authInterrupts},cacheComponents:!!A.cacheComponents,supportsDynamicResponse:I,incrementalCache:(0,s.getRequestMeta)(e,"incrementalCache"),cacheLifeProfiles:A.cacheLife,waitUntil:a.waitUntil,onClose:e=>{t.on("close",e)},onAfterTaskError:void 0,onInstrumentationRequestError:(t,a,i,r)=>x.onRequestError(e,t,i,r,P)},sharedContext:{buildId:g}},z=new d.NodeNextRequest(e),B=new d.NodeNextResponse(t),L=c.NextRequestAdapter.fromNodeNextRequest(z,(0,c.signalFromNodeResponse)(t));try{let n=async e=>x.handle(L,$).finally(()=>{if(!e)return;e.setAttributes({"http.status_code":t.statusCode,"next.rsc":!1});let a=F.getRootSpanAttributes();if(!a)return;if(a.get("next.span_type")!==p.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${a.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let r=a.get("next.route");if(r){let t=`${U} ${r}`;e.setAttributes({"next.route":r,"http.route":r,"next.span_name":t}),e.updateName(t)}else e.updateName(`${U} ${i}`)}),l=!!(0,s.getRequestMeta)(e,"minimalMode"),u=async s=>{var o,u;let d=async({previousCacheEntry:r})=>{try{if(!l&&T&&b&&!r)return t.statusCode=404,t.setHeader("x-nextjs-cache","REVALIDATED"),t.end("This page could not be found"),null;let i=await n(s);e.fetchMetrics=$.renderOpts.fetchMetrics;let o=$.renderOpts.pendingWaitUntil;o&&a.waitUntil&&(a.waitUntil(o),o=void 0);let u=$.renderOpts.collectedTags;if(!q)return await (0,f.sendResponse)(z,B,i,$.renderOpts.pendingWaitUntil),null;{let e=await i.blob(),t=(0,R.toNodeOutgoingHttpHeaders)(i.headers);u&&(t[v.NEXT_CACHE_TAGS_HEADER]=u),!t["content-type"]&&e.type&&(t["content-type"]=e.type);let a=void 0!==$.renderOpts.collectedRevalidate&&!($.renderOpts.collectedRevalidate>=v.INFINITE_CACHE)&&$.renderOpts.collectedRevalidate,r=void 0===$.renderOpts.collectedExpire||$.renderOpts.collectedExpire>=v.INFINITE_CACHE?void 0:$.renderOpts.collectedExpire;return{value:{kind:w.CachedRouteKind.APP_ROUTE,status:i.status,body:Buffer.from(await e.arrayBuffer()),headers:t},cacheControl:{revalidate:a,expire:r}}}}catch(t){throw(null==r?void 0:r.isStale)&&await x.onRequestError(e,t,{routerKind:"App Router",routePath:i,routeType:"route",revalidateReason:(0,h.getRevalidateReason)({isStaticGeneration:M,isOnDemandRevalidate:T})},!1,P),t}},c=await x.handleResponse({req:e,nextConfig:A,cacheKey:D,routeKind:r.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:N,isRoutePPREnabled:!1,isOnDemandRevalidate:T,revalidateOnlyGenerated:b,responseGenerator:d,waitUntil:a.waitUntil,isMinimalMode:l});if(!q)return null;if((null==c||null==(o=c.value)?void 0:o.kind)!==w.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==c||null==(u=c.value)?void 0:u.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});l||t.setHeader("x-nextjs-cache",T?"REVALIDATED":c.isMiss?"MISS":c.isStale?"STALE":"HIT"),C&&t.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let p=(0,R.fromNodeOutgoingHttpHeaders)(c.value.headers);return l&&q||p.delete(v.NEXT_CACHE_TAGS_HEADER),!c.cacheControl||t.getHeader("Cache-Control")||p.get("Cache-Control")||p.set("Cache-Control",(0,m.getCacheControlHeader)(c.cacheControl)),await (0,f.sendResponse)(z,B,new Response(c.value.body,{headers:p,status:c.value.status||200})),null};K?await u(K):await F.withPropagatedContext(e.headers,()=>F.trace(p.BaseServerSpan.handleRequest,{spanName:`${U} ${i}`,kind:o.SpanKind.SERVER,attributes:{"http.method":U,"http.target":e.url}},u))}catch(t){if(t instanceof y.NoFallbackError||await x.onRequestError(e,t,{routerKind:"App Router",routePath:j,routeType:"route",revalidateReason:(0,h.getRevalidateReason)({isStaticGeneration:M,isOnDemandRevalidate:T})},!1,P),q)throw t;return await (0,f.sendResponse)(z,B,new Response(null,{status:500})),null}}e.s(["handler",()=>_,"patchFetch",()=>A,"routeModule",()=>x,"serverHooks",()=>P,"workAsyncStorage",()=>C,"workUnitAsyncStorage",()=>N]),a()}catch(e){a(e)}},!1),412171,e=>{e.v(t=>Promise.all(["server/chunks/b1c00_TutorMekimi_tutorme-app_src_lib_security_suspicious-activity_ts_7865686f._.js"].map(t=>e.l(t))).then(()=>t(145830)))},443460,e=>{e.v(t=>Promise.all(["server/chunks/[externals]_ioredis_c74819ca._.js"].map(t=>e.l(t))).then(()=>t(693545)))},571363,e=>{e.v(t=>Promise.all(["server/chunks/ADK_WORKSPACE_TutorMekimi_tutorme-app_src_lib_security_api-key_ts_45091e81._.js"].map(t=>e.l(t))).then(()=>t(175922)))}];

//# debugId=0e85c787-fc45-9fd7-3c3a-fedb11e18489
//# sourceMappingURL=%5Broot-of-the-server%5D__2c4e92fb._.js.map