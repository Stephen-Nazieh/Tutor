;!function(){try { var e="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof global?global:"undefined"!=typeof window?window:"undefined"!=typeof self?self:{},n=(new e.Error).stack;n&&((e._debugIds|| (e._debugIds={}))[n]="919fb3f1-2038-fa4f-1531-b8a8eb9844c0")}catch(e){}}();
module.exports=[666680,(e,t,r)=>{t.exports=e.x("node:crypto",()=>require("node:crypto"))},75835,e=>{"use strict";let t,r;var a=e.i(666680);function i(e=21){var n;n=e|=0,!t||t.length<n?(t=Buffer.allocUnsafe(128*n),a.webcrypto.getRandomValues(t),r=0):r+n>t.length&&(a.webcrypto.getRandomValues(t),r=0),r+=n;let s="";for(let a=r-e;a<r;a++)s+="useandom-26T198340PX75pxJACKVERYMINDBUSHWOLF_GQZbfghjklqvwyzrict"[63&t[a]];return s}e.s(["nanoid",()=>i],75835)},917126,e=>{"use strict";let t=/<script\b[^<]*(?:(?!<\/script>)<[^<]*)*<\/script>/gi,r=/\s*on\w+\s*=\s*["'][^"']*["']/gi,a=/javascript\s*:/gi,i=/data\s*:\s*[^,]*\s*,/gi,n=/<(?:iframe|object|embed|form|meta|link)\b[^>]*>/gi;function s(e){return"string"!=typeof e?"":e.replace(t,"").replace(n,"").replace(r,"").replace(a,"").replace(i,"")}function l(e,t=5e4){let r=s(e);return r.length<=t?r:r.slice(0,t)}e.s(["sanitizeHtml",()=>s,"sanitizeHtmlWithMax",()=>l])},26233,e=>e.a(async(t,r)=>{try{var a=e.i(909105),i=e.i(738597);e.i(688768);var n=e.i(257357),s=t([i]);async function l(e){if(e.childEmail){let t=e.childEmail.toLowerCase(),r=(await i.drizzleDb.select({userId:n.user.id,email:n.user.email,name:n.profile.name,studentUniqueId:n.profile.studentUniqueId}).from(n.user).innerJoin(n.profile,(0,a.eq)(n.profile.userId,n.user.id)).where((0,a.and)((0,a.eq)(n.user.email,t),(0,a.eq)(n.user.role,"STUDENT"))).limit(1))[0];if(r)return{userId:r.userId,email:r.email,name:r.name??null,studentUniqueId:r.studentUniqueId??null}}if(e.childUniqueId&&e.childUniqueId.length>=8){let t=(await i.drizzleDb.select({userId:n.profile.userId,email:n.user.email,name:n.profile.name,studentUniqueId:n.profile.studentUniqueId}).from(n.profile).innerJoin(n.user,(0,a.eq)(n.user.id,n.profile.userId)).where((0,a.and)((0,a.eq)(n.profile.studentUniqueId,e.childUniqueId),(0,a.eq)(n.user.role,"STUDENT"))).limit(1))[0];if(t)return{userId:t.userId,email:t.email,name:t.name??null,studentUniqueId:t.studentUniqueId??null}}return null}async function o(e){let t=new Map,r=[];return(await Promise.all(e.map((e,t)=>l(e)))).forEach((a,i)=>{if(a)t.set(i,a);else{let t=e[i],a=t.childEmail||t.childUniqueId||"provided";r.push({index:i,message:`Child verification failed: No student found with ${a}. The child must register first at /register/student.`})}}),{verified:t,errors:r}}async function u(e){return(await i.drizzleDb.select({id:n.familyMember.id}).from(n.familyMember).where((0,a.and)((0,a.eq)(n.familyMember.userId,e),(0,a.inArray)(n.familyMember.relation,["child","children"]))).limit(1)).length>0}[i]=s.then?(await s)():s,e.s(["isStudentAlreadyLinked",()=>u,"verifyAllChildren",()=>o]),r()}catch(e){r(e)}},!1),138256,e=>e.a(async(t,r)=>{try{var a=e.i(254799),i=e.i(620971),n=e.i(323214),s=e.i(75835),l=e.i(909105),o=e.i(738597);e.i(688768);var u=e.i(257357),d=e.i(994780),c=e.i(384030),p=e.i(917126),m=e.i(554593),f=e.i(26233),h=t([o,d,c,f]);async function g(e,t){let r,a=(r=t.toLowerCase().replace(/[^a-z0-9._]/g,"").replace(/\.+/g,".").replace(/^\.|\.$/g,"")).length>=3?r.slice(0,24):`user${(0,s.nanoid)(6).toLowerCase()}`;for(let t=0;t<20;t+=1){let r=0===t?"":String(Math.floor(9e3*Math.random())+1e3),i=`${a}${r}`.slice(0,30);if(!await e(i))return i}return`tutor${(0,s.nanoid)(8).toLowerCase()}`}async function y(e){try{let t,r,h;try{t=await e.json()}catch{return i.NextResponse.json({error:"Invalid JSON in request body"},{status:400})}let y=d.RegisterUserSchema.safeParse(t);if(!y.success){let e=y.error.issues.map(e=>`${e.path.join(".")}: ${e.message}`).join(", ");return i.NextResponse.json({error:e},{status:400})}let{email:R,password:w,role:v}=y.data,E=(0,p.sanitizeHtml)(y.data.name).trim().slice(0,100)||"User",I=R.toLowerCase(),b=(0,m.getClientIdentifier)(e),U=m.RATE_LIMIT_PRESETS.register,A=await (0,m.checkRateLimit)(`register:${b}:${String(v).toUpperCase()}:${I}`,U);if(!A.allowed)return i.NextResponse.json({error:"Too many requests. Please try again later."},{status:429,headers:{"X-RateLimit-Remaining":String(A.remaining),"X-RateLimit-Reset":String(Math.ceil(A.resetAt/1e3))}});let[T]=await o.drizzleDb.select().from(u.user).where((0,l.eq)(u.user.email,I)).limit(1);if(T)throw new c.ValidationError("Email already registered");if("PARENT"===v&&t&&"object"==typeof t&&"additionalData"in t){let e=t.additionalData;if(e?.students?.length){let{verified:t,errors:a}=await (0,f.verifyAllChildren)(e.students);if(a.length>0){let e=a.map(e=>`Child ${e.index+1}: ${e.message}`).join("; ");return i.NextResponse.json({error:e},{status:400})}for(let[,e]of(r=t,t))if(await (0,f.isStudentAlreadyLinked)(e.userId))return i.NextResponse.json({error:`Student ${e.email} is already linked to another parent account.`},{status:400})}}let C=await n.default.hash(w,10),x=await o.drizzleDb.transaction(async e=>{let i=a.default.randomUUID();await e.insert(u.user).values({id:i,email:I,password:C,role:v});let n=async t=>{let[r]=await e.select().from(u.profile).where((0,l.eq)(u.profile.username,t)).limit(1);return!!r},o="TUTOR"===v?await g(n,E||R.split("@")[0]||"tutor"):null;if(await e.insert(u.profile).values({id:a.default.randomUUID(),userId:i,name:E,username:o??void 0,tosAccepted:!0,tosAcceptedAt:new Date,timezone:"Asia/Shanghai",emailNotifications:!0,smsNotifications:!1,subjectsOfInterest:[],preferredLanguages:[],learningGoals:[],isOnboarded:"TUTOR"!==v,specialties:[],paidClassesEnabled:!1,..."STUDENT"===v&&{studentUniqueId:`STU-${(0,s.nanoid)(12)}`}}),"TUTOR"===v&&t&&"object"==typeof t&&"additionalData"in t){let r=t.additionalData;r&&await e.update(u.profile).set({credentials:r.education?(0,p.sanitizeHtml)(r.education).trim().slice(0,2e3):null,bio:r.experience?`Experience: ${r.experience} years`:null,specialties:Array.isArray(r.subjects)?r.subjects:[],hourlyRate:"number"==typeof r.hourlyRate?r.hourlyRate:null,isOnboarded:!1}).where((0,l.eq)(u.profile.userId,i))}if("PARENT"===v&&t&&"object"==typeof t&&"additionalData"in t){let n=t.additionalData,s=t.profileData,l=a.default.randomUUID();for(let t of(await e.insert(u.familyAccount).values({id:l,familyName:E,familyType:"PARENT_STUDENT",primaryEmail:I,phoneNumber:s?.phoneNumber??null,timezone:s?.timezone??"Asia/Shanghai",defaultCurrency:"CNY",monthlyBudget:0,enableBudget:!1,allowAdults:!1,isActive:!0,isVerified:!1}),await e.insert(u.familyMember).values({id:a.default.randomUUID(),familyAccountId:l,userId:i,name:E,relation:"parent",email:I}),(n?.emergencyContacts||[]).filter(e=>e.name&&e.phone)))await e.insert(u.emergencyContact).values({id:a.default.randomUUID(),parentId:l,name:t.name,relation:t.relationship,phone:t.phone,isPrimary:!1});let o=n?.students;if(o?.length&&r)for(let t=0;t<o.length;t++){let i=r.get(t);if(i){let r=o[t]?.name||i.name||i.email;await e.insert(u.familyMember).values({id:a.default.randomUUID(),familyAccountId:l,userId:i.userId,name:r,relation:"child",email:i.email})}}}return{id:i,email:I,role:v,createdAt:new Date}});if("STUDENT"===v){let[e]=await o.drizzleDb.select({studentUniqueId:u.profile.studentUniqueId}).from(u.profile).where((0,l.eq)(u.profile.userId,x.id)).limit(1);h=e?.studentUniqueId??void 0}return i.NextResponse.json({success:!0,message:"User registered successfully",user:{id:x.id,name:E,email:x.email,role:x.role,tosAccepted:!0,...h&&{studentUniqueId:h}}},{status:201})}catch(t){let e=t instanceof Error?t:Error(String(t));if(console.error("Registration error:",e.message,e.stack),t&&"object"==typeof t&&"issues"in t)return i.NextResponse.json({error:t.issues.map(e=>e.message).join(", ")},{status:400});if(t instanceof c.ValidationError||t?.name==="ValidationError")return i.NextResponse.json({error:t.message||"Validation error"},{status:400});if(t&&"object"==typeof t&&"code"in t&&"23505"===t.code)return i.NextResponse.json({error:"Email already registered"},{status:400});return i.NextResponse.json({error:"Internal server error. Please try again."},{status:500})}}[o,d,c,f]=h.then?(await h)():h,e.s(["POST",()=>y]),r()}catch(e){r(e)}},!1),314170,e=>e.a(async(t,r)=>{try{var a=e.i(78315),i=e.i(586961),n=e.i(196657),s=e.i(899733),l=e.i(233979),o=e.i(631683),u=e.i(840960),d=e.i(711373),c=e.i(699699),p=e.i(521140),m=e.i(205260),f=e.i(500249),h=e.i(431740),g=e.i(82608),y=e.i(635207),R=e.i(193695);e.i(708038);var w=e.i(447430),v=e.i(138256),E=t([v]);[v]=E.then?(await E)():E;let U=new a.AppRouteRouteModule({definition:{kind:i.RouteKind.APP_ROUTE,page:"/api/auth/register/route",pathname:"/api/auth/register",filename:"route",bundlePath:""},distDir:".next",relativeProjectDir:"",resolvedPagePath:"[project]/ADK_WORKSPACE/TutorMekimi/tutorme-app/src/app/api/auth/register/route.ts",nextConfigOutput:"",userland:v}),{workAsyncStorage:A,workUnitAsyncStorage:T,serverHooks:C}=U;function I(){return(0,n.patchFetch)({workAsyncStorage:A,workUnitAsyncStorage:T})}async function b(e,t,r){U.isDev&&(0,s.addRequestMeta)(e,"devRequestTimingInternalsEnd",process.hrtime.bigint());let a="/api/auth/register/route";a=a.replace(/\/index$/,"")||"/";let n=await U.prepare(e,t,{srcPage:a,multiZoneDraftMode:!1});if(!n)return t.statusCode=400,t.end("Bad Request"),null==r.waitUntil||r.waitUntil.call(r,Promise.resolve()),null;let{buildId:v,params:E,nextConfig:I,parsedUrl:b,isDraftMode:A,prerenderManifest:T,routerServerContext:C,isOnDemandRevalidate:x,revalidateOnlyGenerated:N,resolvedPathname:_,clientReferenceManifest:q,serverActionsManifest:S}=n,D=(0,u.normalizeAppPath)(a),P=!!(T.dynamicRoutes[D]||T.routes[_]),j=async()=>((null==C?void 0:C.render404)?await C.render404(e,t,b,!1):t.end("This page could not be found"),null);if(P&&!A){let e=!!T.routes[_],t=T.dynamicRoutes[D];if(t&&!1===t.fallback&&!e){if(I.experimental.adapterPath)return await j();throw new R.NoFallbackError}}let O=null;!P||U.isDev||A||(O=_,O="/index"===O?"/":O);let M=!0===U.isDev||!P,k=P&&!M;S&&q&&(0,o.setManifestsSingleton)({page:a,clientReferenceManifest:q,serverActionsManifest:S});let $=e.method||"GET",z=(0,l.getTracer)(),H=z.getActiveScopeSpan(),L={params:E,prerenderManifest:T,renderOpts:{experimental:{authInterrupts:!!I.experimental.authInterrupts},cacheComponents:!!I.cacheComponents,supportsDynamicResponse:M,incrementalCache:(0,s.getRequestMeta)(e,"incrementalCache"),cacheLifeProfiles:I.cacheLife,waitUntil:r.waitUntil,onClose:e=>{t.on("close",e)},onAfterTaskError:void 0,onInstrumentationRequestError:(t,r,a,i)=>U.onRequestError(e,t,a,i,C)},sharedContext:{buildId:v}},K=new d.NodeNextRequest(e),V=new d.NodeNextResponse(t),B=c.NextRequestAdapter.fromNodeNextRequest(K,(0,c.signalFromNodeResponse)(t));try{let n=async e=>U.handle(B,L).finally(()=>{if(!e)return;e.setAttributes({"http.status_code":t.statusCode,"next.rsc":!1});let r=z.getRootSpanAttributes();if(!r)return;if(r.get("next.span_type")!==p.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${r.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let i=r.get("next.route");if(i){let t=`${$} ${i}`;e.setAttributes({"next.route":i,"http.route":i,"next.span_name":t}),e.updateName(t)}else e.updateName(`${$} ${a}`)}),o=!!(0,s.getRequestMeta)(e,"minimalMode"),u=async s=>{var l,u;let d=async({previousCacheEntry:i})=>{try{if(!o&&x&&N&&!i)return t.statusCode=404,t.setHeader("x-nextjs-cache","REVALIDATED"),t.end("This page could not be found"),null;let a=await n(s);e.fetchMetrics=L.renderOpts.fetchMetrics;let l=L.renderOpts.pendingWaitUntil;l&&r.waitUntil&&(r.waitUntil(l),l=void 0);let u=L.renderOpts.collectedTags;if(!P)return await (0,f.sendResponse)(K,V,a,L.renderOpts.pendingWaitUntil),null;{let e=await a.blob(),t=(0,h.toNodeOutgoingHttpHeaders)(a.headers);u&&(t[y.NEXT_CACHE_TAGS_HEADER]=u),!t["content-type"]&&e.type&&(t["content-type"]=e.type);let r=void 0!==L.renderOpts.collectedRevalidate&&!(L.renderOpts.collectedRevalidate>=y.INFINITE_CACHE)&&L.renderOpts.collectedRevalidate,i=void 0===L.renderOpts.collectedExpire||L.renderOpts.collectedExpire>=y.INFINITE_CACHE?void 0:L.renderOpts.collectedExpire;return{value:{kind:w.CachedRouteKind.APP_ROUTE,status:a.status,body:Buffer.from(await e.arrayBuffer()),headers:t},cacheControl:{revalidate:r,expire:i}}}}catch(t){throw(null==i?void 0:i.isStale)&&await U.onRequestError(e,t,{routerKind:"App Router",routePath:a,routeType:"route",revalidateReason:(0,m.getRevalidateReason)({isStaticGeneration:k,isOnDemandRevalidate:x})},!1,C),t}},c=await U.handleResponse({req:e,nextConfig:I,cacheKey:O,routeKind:i.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:T,isRoutePPREnabled:!1,isOnDemandRevalidate:x,revalidateOnlyGenerated:N,responseGenerator:d,waitUntil:r.waitUntil,isMinimalMode:o});if(!P)return null;if((null==c||null==(l=c.value)?void 0:l.kind)!==w.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==c||null==(u=c.value)?void 0:u.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});o||t.setHeader("x-nextjs-cache",x?"REVALIDATED":c.isMiss?"MISS":c.isStale?"STALE":"HIT"),A&&t.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let p=(0,h.fromNodeOutgoingHttpHeaders)(c.value.headers);return o&&P||p.delete(y.NEXT_CACHE_TAGS_HEADER),!c.cacheControl||t.getHeader("Cache-Control")||p.get("Cache-Control")||p.set("Cache-Control",(0,g.getCacheControlHeader)(c.cacheControl)),await (0,f.sendResponse)(K,V,new Response(c.value.body,{headers:p,status:c.value.status||200})),null};H?await u(H):await z.withPropagatedContext(e.headers,()=>z.trace(p.BaseServerSpan.handleRequest,{spanName:`${$} ${a}`,kind:l.SpanKind.SERVER,attributes:{"http.method":$,"http.target":e.url}},u))}catch(t){if(t instanceof R.NoFallbackError||await U.onRequestError(e,t,{routerKind:"App Router",routePath:D,routeType:"route",revalidateReason:(0,m.getRevalidateReason)({isStaticGeneration:k,isOnDemandRevalidate:x})},!1,C),P)throw t;return await (0,f.sendResponse)(K,V,new Response(null,{status:500})),null}}e.s(["handler",()=>b,"patchFetch",()=>I,"routeModule",()=>U,"serverHooks",()=>C,"workAsyncStorage",()=>A,"workUnitAsyncStorage",()=>T]),r()}catch(e){r(e)}},!1),412171,e=>{e.v(t=>Promise.all(["server/chunks/b1c00_TutorMekimi_tutorme-app_src_lib_security_suspicious-activity_ts_7865686f._.js"].map(t=>e.l(t))).then(()=>t(145830)))},443460,e=>{e.v(t=>Promise.all(["server/chunks/[externals]_ioredis_c74819ca._.js"].map(t=>e.l(t))).then(()=>t(693545)))},571363,e=>{e.v(t=>Promise.all(["server/chunks/ADK_WORKSPACE_TutorMekimi_tutorme-app_src_lib_security_api-key_ts_45091e81._.js"].map(t=>e.l(t))).then(()=>t(175922)))}];

//# debugId=919fb3f1-2038-fa4f-1531-b8a8eb9844c0
//# sourceMappingURL=%5Broot-of-the-server%5D__662f6715._.js.map